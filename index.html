<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#06060E">
<meta name="format-detection" content="telephone=no">
<title>Markaziy Bank â€” Toshkent viloyati</title>
<!-- 4 ta unikal shrift â€” har bir tema uchun boshqa -->
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Syne:wght@400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700;800;900&family=Zen+Kaku+Gothic+New:wght@300;400;500;700;900&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEW ERA BANKING DASHBOARD â€” 4 DUNYONING 4 TEMASI
   Har bir tema = boshqa galaktika
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@property --bdr{syntax:'<angle>';initial-value:0deg;inherits:false}
@property --hue{syntax:'<number>';initial-value:0;inherits:true}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth;-webkit-font-smoothing:antialiased}
body{font-family:var(--ff);background:var(--bg);color:var(--t1);line-height:1.6;min-height:100vh;overflow-x:hidden;transition:background .7s cubic-bezier(.4,0,.2,1),color .5s,font-family .3s}
h1,h2,h3,h4{font-family:var(--ffd);color:var(--t0);font-weight:var(--fw-h,800)}
::selection{background:var(--ac);color:#fff}
button{cursor:pointer;border:none;background:none;font-family:var(--ff)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEMA 1 â€” NEON CYBER
   Cyberpunk qorong'u, neon pushti/cyan yorug'lik,
   geometrik pattern, Outfit + Syne shriftlari
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
[data-theme="cyber"]{
  --ff:'Outfit',system-ui,sans-serif;--ffd:'Syne',system-ui,sans-serif;--fw-h:800;
  --bg:#06060E;--bg2:#0D0D1A;--bg3:#14142B;
  --card:rgba(13,13,26,.65);--card-h:rgba(20,20,43,.8);--card-s:#0D0D1A;
  --t0:#F0F0FF;--t1:rgba(240,240,255,.78);--t2:rgba(240,240,255,.52);--t3:rgba(240,240,255,.38);
  --ac:#FF2E97;--ac2:#00F0FF;--ac-g:rgba(255,46,151,.2);--ac-bg:rgba(255,46,151,.06);
  --ok:#00F0FF;--err:#FF2E97;--warn:#FFE156;
  --brd:rgba(255,46,151,.12);--brd2:rgba(255,46,151,.06);
  --g1:linear-gradient(135deg,#FF2E97,#FF6AC1);--g2:linear-gradient(135deg,#00F0FF,#00B4D8);
  --g3:linear-gradient(135deg,#A855F7,#7C3AED);--g4:linear-gradient(135deg,#FFE156,#F59E0B);
  --grad-h:linear-gradient(135deg,#FF2E97,#00F0FF);
  --pill-bg:rgba(255,46,151,.05);--pill-brd:rgba(255,46,151,.1);
  --shadow:0 4px 24px rgba(255,46,151,.08),0 1px 3px rgba(0,0,0,.3);
  --shadow-h:0 0 30px rgba(255,46,151,.15),0 0 60px rgba(0,240,255,.08),0 8px 32px rgba(0,0,0,.4);
  --top-bg:rgba(6,6,14,.7);--radius:16px;--radius-lg:22px;
  /* Scrollbar */
  --sb-thumb:rgba(255,46,151,.3);--sb-hover:rgba(255,46,151,.5);
  /* Unique: scanline + grid */
  --pattern:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' stroke='%23FF2E97' stroke-width='.3' opacity='.12'%3E%3Cpath d='M0 0h60v60H0z'/%3E%3Cpath d='M30 0v60M0 30h60'/%3E%3C/g%3E%3C/svg%3E");
  --pattern-size:60px;
  --scanline:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(255,46,151,.015) 2px,rgba(255,46,151,.015) 4px);
  --glow-1:#FF2E97;--glow-2:#00F0FF;--glow-3:#A855F7;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEMA 2 â€” AURORA
   Kunduzgi, shimoliy yorug'lik gradientlari, organik,
   DM Sans + Outfit shriftlari, yumshoq radiuslar
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
[data-theme="aurora"]{
  --ff:'DM Sans',system-ui,sans-serif;--ffd:'Outfit',system-ui,sans-serif;--fw-h:700;
  --bg:#F4F7FE;--bg2:#FFFFFF;--bg3:#EBF0FC;
  --card:rgba(255,255,255,.7);--card-h:rgba(255,255,255,.92);--card-s:#FFFFFF;
  --t0:#0F172A;--t1:rgba(15,23,42,.72);--t2:rgba(15,23,42,.50);--t3:rgba(15,23,42,.35);
  --ac:#6366F1;--ac2:#06B6D4;--ac-g:rgba(99,102,241,.12);--ac-bg:rgba(99,102,241,.04);
  --ok:#10B981;--err:#F43F5E;--warn:#F59E0B;
  --brd:rgba(99,102,241,.1);--brd2:rgba(99,102,241,.05);
  --g1:linear-gradient(135deg,#6366F1,#8B5CF6);--g2:linear-gradient(135deg,#06B6D4,#22D3EE);
  --g3:linear-gradient(135deg,#F43F5E,#FB7185);--g4:linear-gradient(135deg,#F59E0B,#FBBF24);
  --grad-h:linear-gradient(135deg,#6366F1,#06B6D4,#10B981);
  --pill-bg:rgba(99,102,241,.04);--pill-brd:rgba(99,102,241,.08);
  --shadow:0 1px 3px rgba(15,23,42,.04),0 4px 12px rgba(99,102,241,.04);
  --shadow-h:0 8px 30px rgba(99,102,241,.1),0 1px 3px rgba(15,23,42,.04);
  --top-bg:rgba(255,255,255,.72);--radius:20px;--radius-lg:28px;
  --sb-thumb:rgba(99,102,241,.15);--sb-hover:rgba(99,102,241,.3);
  /* Unique: soft blobs */
  --pattern:none;--pattern-size:0;
  --scanline:none;
  --glow-1:#6366F1;--glow-2:#06B6D4;--glow-3:#F43F5E;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEMA 3 â€” TEAL NEON
   Quyuq ko'k-teal fon, yorqin cyan neon accent,
   glassmorphism kartochkalar, Outfit + Syne shriftlari
   Yagona Boshqaruv Paneli uslubida
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
[data-theme="teal"]{
  --ff:'Outfit',system-ui,sans-serif;--ffd:'Syne',system-ui,sans-serif;--fw-h:800;
  --bg:#0B1929;--bg2:#0E2236;--bg3:#122A42;
  --card:rgba(14,34,54,.55);--card-h:rgba(18,42,66,.72);--card-s:#0E2236;
  --t0:#E8F4F8;--t1:rgba(232,244,248,.76);--t2:rgba(232,244,248,.50);--t3:rgba(232,244,248,.36);
  --ac:#00E5FF;--ac2:#00BCD4;--ac-g:rgba(0,229,255,.18);--ac-bg:rgba(0,229,255,.06);
  --ok:#00E5FF;--err:#FF5C8A;--warn:#FFD93D;
  --brd:rgba(0,229,255,.14);--brd2:rgba(0,229,255,.06);
  --g1:linear-gradient(135deg,#00BCD4,#00E5FF);--g2:linear-gradient(135deg,#0D8B9F,#26C6DA);
  --g3:linear-gradient(135deg,#7C4DFF,#B388FF);--g4:linear-gradient(135deg,#00E676,#69F0AE);
  --grad-h:linear-gradient(135deg,#00BCD4,#00E5FF,#80F0FF);
  --pill-bg:rgba(0,229,255,.05);--pill-brd:rgba(0,229,255,.12);
  --shadow:0 2px 8px rgba(0,0,0,.25),0 4px 20px rgba(0,229,255,.04);
  --shadow-h:0 0 35px rgba(0,229,255,.12),0 0 60px rgba(0,188,212,.06),0 8px 32px rgba(0,0,0,.35);
  --top-bg:rgba(11,25,41,.78);--radius:16px;--radius-lg:20px;
  --sb-thumb:rgba(0,229,255,.2);--sb-hover:rgba(0,229,255,.4);
  /* Unique: subtle cross grid like screenshot */
  --pattern:url("data:image/svg+xml,%3Csvg width='50' height='50' viewBox='0 0 50 50' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M25 0v50M0 25h50' stroke='%2300E5FF' stroke-width='.3' opacity='.04'/%3E%3C/svg%3E");
  --pattern-size:50px;
  --scanline:none;
  --glow-1:#00E5FF;--glow-2:#00BCD4;--glow-3:#7C4DFF;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEMA 4 â€” SAKURA
   Yapon zen uslubi, pushti sakura, Zen Kaku Gothic,
   yumshoq soyalar, organik shakllar, tinch estetika
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
[data-theme="sakura"]{
  --ff:'Zen Kaku Gothic New',system-ui,sans-serif;--ffd:'Zen Kaku Gothic New',system-ui,sans-serif;--fw-h:900;
  --bg:#1C1520;--bg2:#241D28;--bg3:#2E2533;
  --card:rgba(36,29,40,.65);--card-h:rgba(46,37,51,.8);--card-s:#241D28;
  --t0:#FDF2F8;--t1:rgba(253,242,248,.75);--t2:rgba(253,242,248,.50);--t3:rgba(253,242,248,.36);
  --ac:#F472B6;--ac2:#FB7185;--ac-g:rgba(244,114,182,.15);--ac-bg:rgba(244,114,182,.05);
  --ok:#86EFAC;--err:#FB7185;--warn:#FDE68A;
  --brd:rgba(244,114,182,.1);--brd2:rgba(244,114,182,.05);
  --g1:linear-gradient(135deg,#F472B6,#FB7185);--g2:linear-gradient(135deg,#E879F9,#C084FC);
  --g3:linear-gradient(135deg,#38BDF8,#22D3EE);--g4:linear-gradient(135deg,#FBBF24,#F59E0B);
  --grad-h:linear-gradient(135deg,#F472B6,#E879F9,#C084FC);
  --pill-bg:rgba(244,114,182,.04);--pill-brd:rgba(244,114,182,.08);
  --shadow:0 2px 8px rgba(244,114,182,.04),0 4px 16px rgba(0,0,0,.2);
  --shadow-h:0 0 30px rgba(244,114,182,.1),0 0 50px rgba(232,121,249,.06),0 8px 28px rgba(0,0,0,.3);
  --top-bg:rgba(28,21,32,.75);--radius:24px;--radius-lg:32px;
  --sb-thumb:rgba(244,114,182,.2);--sb-hover:rgba(244,114,182,.4);
  /* Unique: sakura petals dots */
  --pattern:url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='40' cy='40' r='1.5' fill='%23F472B6' opacity='.08'/%3E%3Ccircle cx='10' cy='10' r='1' fill='%23E879F9' opacity='.06'/%3E%3Ccircle cx='70' cy='20' r='.8' fill='%23F472B6' opacity='.05'/%3E%3C/svg%3E");
  --pattern-size:80px;
  --scanline:none;
  --glow-1:#F472B6;--glow-2:#E879F9;--glow-3:#C084FC;
}

/* â•â•â• SCROLLBAR â€” temaga qarab â•â•â• */
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--sb-thumb);border-radius:9px}
::-webkit-scrollbar-thumb:hover{background:var(--sb-hover)}

/* â•â•â• BACKGROUND LAYERS â•â•â• */
.bg-mesh{position:fixed;inset:0;z-index:0;pointer-events:none}
.bg-mesh svg{width:100%;height:100%}
.bg-pattern{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:var(--pattern);background-size:var(--pattern-size)}
.bg-scan{position:fixed;inset:0;z-index:0;pointer-events:none;background:var(--scanline)}
.bg-noise{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.015;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.65' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E") repeat;background-size:150px}
.bg-pts{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.pt{position:absolute;border-radius:50%;background:radial-gradient(circle,var(--glow-1),transparent 70%);opacity:0;animation:ptFloat linear infinite}
@keyframes ptFloat{0%{transform:translateY(100vh) scale(.4);opacity:0}12%{opacity:.3}88%{opacity:.3}100%{transform:translateY(-8vh) scale(1);opacity:0}}

/* â•â•â• ANIMATED GRADIENT BORDER â•â•â• */
@keyframes rotB{to{--bdr:360deg}}
@keyframes hueShift{0%{--hue:0}100%{--hue:360}}

/* â•â•â• SHELL + TOPBAR â•â•â• */
.shell{position:relative;z-index:1;min-height:100vh;display:flex;flex-direction:column}
.topbar{
  position:sticky;top:0;z-index:100;height:62px;
  display:flex;align-items:center;gap:16px;padding:0 26px;
  background:var(--top-bg);
  backdrop-filter:blur(28px) saturate(1.6);-webkit-backdrop-filter:blur(28px) saturate(1.6);
  border-bottom:1px solid var(--brd2);
  animation:slideD .5s ease;
}
@keyframes slideD{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:none}}
.brand{display:flex;align-items:center;gap:11px;cursor:pointer;flex-shrink:0}
.brand:hover .bico{transform:rotate(-6deg) scale(1.08)}
.bico{
  width:42px;height:42px;border-radius:var(--radius);
  background:var(--g1);display:flex;align-items:center;justify-content:center;
  box-shadow:0 3px 14px var(--ac-g);
  transition:transform .5s cubic-bezier(.34,1.56,.64,1);
}
.bico svg{color:#fff;width:20px;height:20px;stroke-width:1.8}
.bt1{font-family:var(--ffd);font-size:17px;font-weight:var(--fw-h);color:var(--t0)}
.bt1 span{background:var(--grad-h);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.bt2{font-size:7.5px;font-weight:700;color:var(--t2);letter-spacing:.18em;text-transform:uppercase}

/* Nav */
.nav{display:flex;gap:3px;margin:0 auto;padding:3px;background:var(--pill-bg);border-radius:var(--radius);border:1px solid var(--pill-brd)}
.ni{display:flex;align-items:center;gap:5px;padding:7px 18px;border-radius:calc(var(--radius) - 4px);font-size:12px;font-weight:700;color:var(--t1);transition:all .3s cubic-bezier(.4,0,.2,1);white-space:nowrap}
.ni:hover{color:var(--t0);background:var(--pill-bg)}
.ni.on{color:#fff;background:var(--g1);box-shadow:0 2px 12px var(--ac-g)}
.ni svg{width:14px;height:14px}

/* Clock */
.clk{display:flex;align-items:center;gap:7px;padding:6px 14px;border-radius:var(--radius);background:var(--pill-bg);border:1px solid var(--pill-brd);flex-shrink:0;font-size:13px;font-weight:800;color:var(--ac);letter-spacing:.04em}
.clk-dot{width:6px;height:6px;border-radius:50%;background:var(--ok);box-shadow:0 0 8px var(--ok);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* Theme switch */
.tr{display:flex;align-items:center;gap:5px;flex-shrink:0}
.tsw{display:flex;gap:3px;padding:4px;background:var(--pill-bg);border-radius:var(--radius);border:1px solid var(--pill-brd)}
.tp{width:24px;height:24px;border-radius:calc(var(--radius) - 6px);border:2px solid transparent;transition:all .4s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden}
.tp:hover{transform:scale(1.2)}
.tp.on{border-color:var(--ac);box-shadow:0 0 8px var(--ac-g)}
/* Har tema tugmasi unikal ko'rinishda */
.tp[data-t="cyber"]{background:linear-gradient(135deg,#06060E,#FF2E97,#00F0FF)}
.tp[data-t="aurora"]{background:linear-gradient(135deg,#F4F7FE,#6366F1,#06B6D4)}
.tp[data-t="teal"]{background:linear-gradient(135deg,#0B1929,#00E5FF,#00BCD4)}
.tp[data-t="sakura"]{background:linear-gradient(135deg,#1C1520,#F472B6,#E879F9)}
.ib{width:36px;height:36px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;color:var(--t2);border:1px solid var(--pill-brd);transition:all .25s;position:relative}
.ib:hover{color:var(--ac);background:var(--ac-bg);border-color:var(--brd);box-shadow:0 0 12px var(--ac-g)}
.ib svg{width:15px;height:15px}.ib .dot{position:absolute;top:6px;right:6px;width:5px;height:5px;border-radius:50%;background:var(--err)}

/* Breadcrumbs */
.crumbs{display:flex;align-items:center;gap:4px;padding:9px 26px;font-size:12px;font-weight:600;color:var(--t2);border-bottom:1px solid var(--brd2)}
.crumb{display:flex;align-items:center;gap:3px;cursor:pointer;padding:3px 8px;border-radius:calc(var(--radius) - 8px);transition:all .2s}
.crumb:hover{color:var(--ac);background:var(--ac-bg)}.crumb-sep{color:var(--t3);font-size:8px}.crumb-cur{color:var(--t0);font-weight:800}

/* Main container */
.main{flex:1;padding:0 26px 26px;max-width:1480px;margin:0 auto;width:100%}
.view{display:none}.view.on{display:block;animation:vIn .5s cubic-bezier(.16,1,.3,1)}
@keyframes vIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:none}}

/* â•â•â• SECTION HEADER â•â•â• */
.sh{display:flex;align-items:center;justify-content:space-between;margin:24px 0 18px;padding-bottom:14px;border-bottom:1px solid var(--brd2)}
.sh-l{display:flex;align-items:center;gap:14px}
.sh-ico{
  width:52px;height:52px;border-radius:var(--radius);
  background:var(--ac-bg);border:1.5px solid var(--brd);
  display:flex;align-items:center;justify-content:center;color:var(--ac);
  transition:all .4s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden;
}
.sh-ico::after{content:'';position:absolute;inset:0;background:var(--grad-h);opacity:0;transition:opacity .3s}
.sh-ico:hover{transform:scale(1.1) rotate(-5deg);box-shadow:0 0 20px var(--ac-g)}
.sh-ico:hover::after{opacity:.12}
.sh-ico svg{width:24px;height:24px;stroke-width:1.8;position:relative;z-index:1}
.sh-tit{font-size:clamp(22px,3.5vw,32px);margin:0;letter-spacing:-.03em}
.sh-sub{font-size:11px;color:var(--t2);font-weight:600;margin-top:1px}
.sh-act{
  display:flex;align-items:center;gap:6px;padding:10px 24px;border-radius:var(--radius-lg);
  font-size:12px;font-weight:800;color:#fff;background:var(--g1);
  box-shadow:0 3px 14px var(--ac-g);transition:all .3s cubic-bezier(.34,1.56,.64,1);
}
.sh-act:hover{transform:translateY(-3px) scale(1.04);box-shadow:0 6px 22px var(--ac-g)}
.sh-act svg{width:14px;height:14px}

/* â•â•â• LEADER CARDS â€” PREMIUM GLASSMORPHISM â•â•â• */
.leaders{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
.lc{
  position:relative;cursor:pointer;overflow:hidden;
  background:var(--card);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:1px solid var(--brd);border-radius:var(--radius-lg);
  box-shadow:var(--shadow);
  transition:all .45s cubic-bezier(.25,.8,.25,1);
  animation:cardUp .6s cubic-bezier(.16,1,.3,1) both;
  animation-delay:calc(var(--i,0)*120ms + 200ms);
}
@keyframes cardUp{from{opacity:0;transform:translateY(30px) scale(.96)}to{opacity:1;transform:none}}
.lc:hover{transform:translateY(-7px);background:var(--card-h);box-shadow:var(--shadow-h)}
/* Animated neon border on hover â€” unikal har temaga */
.lc::before{
  content:'';position:absolute;inset:-1px;border-radius:calc(var(--radius-lg) + 1px);padding:1.5px;
  background:conic-gradient(from var(--bdr),transparent 8%,var(--glow-1) 22%,transparent 36%,var(--glow-2) 52%,transparent 66%,var(--glow-3) 80%,transparent 94%);
  -webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;
  opacity:0;transition:opacity .4s;animation:rotB 4s linear infinite;pointer-events:none;
}
.lc:hover::before{opacity:1}
/* Top gradient bar */
.lc-bar{height:3px;opacity:.6}
.lc-body{padding:20px 22px 18px;position:relative;z-index:1}
.lc-head{display:flex;align-items:center;gap:14px;margin-bottom:14px}
.lc-ava{
  width:58px;height:58px;border-radius:var(--radius);
  display:flex;align-items:center;justify-content:center;
  font-family:var(--ffd);font-weight:900;font-size:21px;color:#fff;font-style:italic;
  flex-shrink:0;position:relative;overflow:hidden;
  box-shadow:0 4px 16px rgba(0,0,0,.25);transition:all .4s cubic-bezier(.34,1.56,.64,1);
}
.lc:hover .lc-ava{transform:scale(1.08) rotate(-3deg)}
.lc-ava::after{content:'';position:absolute;inset:0;background:linear-gradient(130deg,transparent 20%,rgba(255,255,255,.2) 50%,transparent 80%);background-size:300% 300%;animation:shimmer 3.5s ease infinite}
@keyframes shimmer{0%{background-position:200% 200%}100%{background-position:-200% -200%}}
.lc-name{font-family:var(--ffd);font-size:19px;font-weight:var(--fw-h);color:var(--t0);line-height:1.15}
.lc-role{font-size:9px;font-weight:800;background:var(--grad-h);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:.1em;text-transform:uppercase;margin-top:3px}

/* Stats */
.lc-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding-top:13px;border-top:1px solid var(--brd2);margin-bottom:10px}
.st{text-align:center;padding:10px 4px;background:var(--pill-bg);border:1px solid var(--pill-brd);border-radius:var(--radius);transition:all .3s}
.lc:hover .st{background:var(--ac-bg);border-color:var(--brd)}
.st-n{font-family:var(--ffd);font-size:26px;font-weight:900;background:var(--grad-h);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1}
.st-l{font-size:9px;font-weight:800;color:var(--t2);text-transform:uppercase;letter-spacing:.08em;margin-top:2px}

/* Tags */
.lc-tags{display:flex;flex-wrap:wrap;gap:4px}
.ltag{display:flex;align-items:center;gap:4px;padding:2px 9px;border-radius:var(--radius-lg);font-size:9px;font-weight:700;color:var(--t2);background:var(--pill-bg);border:1px solid var(--pill-brd)}
.ltag::before{content:'';width:4px;height:4px;border-radius:50%;background:var(--ac)}
.lc:hover .ltag{color:var(--ac);border-color:var(--brd)}

/* â•â•â• WIDGETS â•â•â• */
.widgets{display:grid;grid-template-columns:380px 1fr;gap:16px;margin-top:18px;animation:cardUp .5s cubic-bezier(.16,1,.3,1) .9s both}
.wgt{background:var(--card);backdrop-filter:blur(14px);border:1px solid var(--brd2);border-radius:var(--radius);padding:18px;transition:all .3s}
.wgt:hover{border-color:var(--brd);background:var(--card-h)}
.wgt-t{font-size:8px;font-weight:900;text-transform:uppercase;letter-spacing:.14em;color:var(--t3);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.wgt-t svg{color:var(--ac)!important;width:12px;height:12px}
.wgt-t::after{content:'';flex:1;height:1px;background:var(--brd2)}
.w-row{display:flex;align-items:center;gap:16px}
.w-ico{font-size:44px;animation:wFloat 5s ease-in-out infinite}
@keyframes wFloat{0%,100%{transform:translateY(0) rotate(0)}50%{transform:translateY(-6px) rotate(3deg)}}
.w-temp{font-family:var(--ffd);font-size:46px;font-weight:900;background:var(--grad-h);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1}
.w-det{font-size:12px;color:var(--t2);line-height:1.8}
.n-list{display:flex;flex-direction:column;max-height:220px;overflow-y:auto}
.n-item{display:flex;gap:9px;padding:8px 0;border-bottom:1px solid var(--brd2);font-size:12px;transition:all .2s}
.n-item:hover{padding-left:5px;background:var(--ac-bg);border-radius:var(--radius)}.n-item:last-child{border-bottom:none}
.n-time{color:var(--ac);font-weight:800;font-size:9px;padding:3px 9px;border-radius:var(--radius-lg);background:var(--pill-bg);border:1px solid var(--pill-brd);white-space:nowrap;align-self:flex-start}
.n-txt{color:var(--t1);line-height:1.4}

/* â•â•â• MEETINGS â•â•â• */
.meetings{margin-top:18px;animation:cardUp .5s cubic-bezier(.16,1,.3,1) 1s both}
.mgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.mc{background:var(--card);backdrop-filter:blur(14px);border:1px solid var(--brd2);border-radius:var(--radius);padding:15px 17px;display:flex;gap:12px;transition:all .3s}
.mc:hover{border-color:var(--brd);transform:translateY(-3px);background:var(--card-h);box-shadow:var(--shadow-h)}
.mc-time{display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:50px;padding:8px;border-radius:var(--radius);background:var(--pill-bg);border:1px solid var(--pill-brd)}
.mc-d{font-family:var(--ffd);font-size:22px;font-weight:900;background:var(--grad-h);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1}
.mc-m{font-size:7px;font-weight:800;color:var(--t2);text-transform:uppercase;letter-spacing:.06em;margin-top:2px}
.mc-hr{font-size:9.5px;font-weight:800;color:var(--t1);margin-top:2px}
.mc-info{flex:1;min-width:0}.mc-title{font-family:var(--ffd);font-size:13.5px;font-weight:700;color:var(--t0);line-height:1.3;margin-bottom:3px}
.mc-who{font-size:10px;color:var(--t2);display:flex;align-items:center;gap:4px}.mc-who svg{width:11px;height:11px;color:var(--ac)}
.mbdg{font-size:7px;font-weight:900;padding:2px 8px;border-radius:var(--radius-lg);text-transform:uppercase;letter-spacing:.06em;margin-top:4px;display:inline-block}
.mbdg.urgent{background:rgba(251,113,133,.08);color:var(--err);border:1px solid rgba(251,113,133,.12)}
.mbdg.normal{background:var(--pill-bg);color:var(--ac);border:1px solid var(--pill-brd)}
.mbdg.done{background:rgba(134,239,172,.06);color:var(--ok);border:1px solid rgba(134,239,172,.1)}
/* â”€â”€ UCHRASHUV TAHRIR MODALI â”€â”€ */
.meetModal{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(8px);animation:mIn .25s}
.meetModal-box{background:var(--card-s);border:1px solid var(--brd2);border-radius:var(--radius-lg);padding:24px;width:min(440px,90vw);max-height:85vh;overflow-y:auto;animation:cardUp .35s cubic-bezier(.16,1,.3,1)}
.meetModal h3{font-family:var(--ffd);font-size:16px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.mf-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.mf-full{grid-column:1/-1}
.mf-row label{font-size:10px;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.04em;margin-bottom:3px;display:block}
.mf-row input,.mf-row select,.mf-row textarea{width:100%;padding:8px 12px;border-radius:var(--radius);border:1px solid var(--brd2);background:var(--card);color:var(--t0);font-size:13px;font-family:var(--ff)}
.mf-row textarea{resize:vertical;min-height:50px}
.mf-row select{cursor:pointer}
.mf-acts{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}
.mf-acts button{padding:8px 18px;border-radius:var(--radius);font-weight:700;font-size:12px;cursor:pointer;transition:all .2s}
.mf-acts .mf-save{background:var(--ac);color:#fff;border:none}.mf-acts .mf-save:hover{opacity:.85}
.mf-acts .mf-cancel{background:var(--card);color:var(--t1);border:1px solid var(--brd2)}.mf-acts .mf-cancel:hover{background:var(--bg)}
.mf-tg{background:linear-gradient(135deg,#0088cc,#00aced);color:#fff;border:none;display:flex;align-items:center;gap:5px}.mf-tg:hover{opacity:.85}
/* â”€â”€ KONTAKTLAR PANELI â”€â”€ */
.contacts-panel{margin-top:18px}
.cnt-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px}
.cnt-card{background:var(--card);backdrop-filter:blur(14px);border:1px solid var(--brd2);border-radius:var(--radius);padding:13px 16px;display:flex;align-items:center;gap:12px;transition:all .3s;cursor:pointer}
.cnt-card:hover{border-color:var(--ac);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.08)}
.cnt-ava{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;font-family:var(--ffd);color:#fff;flex-shrink:0}
.cnt-info{flex:1;min-width:0}
.cnt-name{font-family:var(--ffd);font-size:12.5px;font-weight:700;color:var(--t0)}
.cnt-role{font-size:9.5px;color:var(--t2);margin-top:1px}
.cnt-phone{font-size:11px;font-weight:700;color:var(--ac);margin-top:2px}
.cnt-call{width:32px;height:32px;border-radius:50%;background:var(--ok);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.cnt-call:hover{transform:scale(1.1);box-shadow:0 2px 10px rgba(134,239,172,.3)}
.mc-acts{display:flex;gap:3px;margin-top:5px}
.mc-acts button{padding:3px 9px;border-radius:calc(var(--radius) - 4px);font-size:8.5px;font-weight:800;display:flex;align-items:center;gap:3px;transition:all .2s}
.mc-acts svg{width:9px;height:9px}
.mc-acts .me{background:var(--pill-bg);color:var(--ac);border:1px solid var(--pill-brd)}.mc-acts .me:hover{background:var(--ac-bg);border-color:var(--brd)}
.mc-acts .md{background:rgba(251,113,133,.04);color:var(--err);border:1px solid rgba(251,113,133,.06)}.mc-acts .md:hover{background:rgba(251,113,133,.08)}

/* â•â•â• DEPT / DASHBOARD CARDS â•â•â• */
.back{display:inline-flex;align-items:center;gap:5px;padding:8px 16px;font-size:12px;font-weight:700;color:var(--t2);background:var(--card);border:1px solid var(--brd2);border-radius:var(--radius);transition:all .3s}
.back:hover{color:var(--ac);border-color:var(--brd);transform:translateX(-4px);box-shadow:0 0 12px var(--ac-g)}
.back svg{width:13px;height:13px;transition:transform .2s}.back:hover svg{transform:translateX(-3px)}
.sh2{margin-bottom:18px;padding-bottom:12px;border-bottom:1px solid var(--brd2)}
.sh2 h2{font-size:clamp(18px,3vw,28px);margin-top:8px}
.dgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(295px,1fr));gap:13px}
.dc{
  position:relative;cursor:pointer;overflow:hidden;
  background:var(--card);backdrop-filter:blur(14px);border:1px solid var(--brd2);
  border-radius:var(--radius);padding:20px;
  transition:all .4s cubic-bezier(.25,.8,.25,1);
  animation:cardUp .45s cubic-bezier(.16,1,.3,1) both;animation-delay:calc(var(--i,0)*80ms);
}
.dc:hover{transform:translateY(-5px);background:var(--card-h);border-color:color-mix(in srgb,var(--ac) 25%,transparent);box-shadow:var(--shadow-h)}
.dc::after{content:'';position:absolute;inset:0;pointer-events:none;border-radius:inherit;background:radial-gradient(ellipse at 50% -20%,color-mix(in srgb,var(--ac) 5%,transparent),transparent 60%);opacity:0;transition:opacity .3s}.dc:hover::after{opacity:1}
.dc-ico{width:46px;height:46px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;margin-bottom:13px;position:relative;z-index:1;transition:all .4s cubic-bezier(.34,1.56,.64,1)}
.dc:hover .dc-ico{transform:scale(1.1) rotate(-5deg)}
.dc-ico svg{width:22px;height:22px;stroke-width:1.7}
.dc-ico.c1{background:var(--ac-bg);color:var(--ac);border:1.5px solid var(--brd)}
.dc-ico.c2{background:rgba(16,185,129,.05);color:var(--ok);border:1.5px solid rgba(16,185,129,.1)}
.dc-ico.c3{background:rgba(244,114,182,.04);color:#F472B6;border:1.5px solid rgba(244,114,182,.08)}
.dc h4{font-size:15px;color:var(--t0);margin-bottom:8px;line-height:1.3;position:relative;z-index:1;font-weight:700}
.badge{display:inline-flex;align-items:center;gap:3px;padding:3px 11px;border-radius:var(--radius-lg);font-size:9.5px;font-weight:800;position:relative;z-index:1}
.badge-ok{background:var(--ac-bg);color:var(--ac);border:1px solid var(--pill-brd)}
.badge-mt{background:var(--pill-bg);color:var(--t2);border:1px solid var(--pill-brd)}
.badge-xl{background:rgba(16,185,129,.04);color:var(--ok);border:1px solid rgba(16,185,129,.08)}
.badge-html{background:var(--pill-bg);color:var(--ac);border:1px solid var(--pill-brd)}
.meta{display:flex;gap:4px;flex-wrap:wrap}
.empty{text-align:center;padding:50px 26px}.empty-ico{margin-bottom:14px;color:var(--t3)}.empty-ico svg{width:46px;height:46px}
.empty h3{font-size:19px;margin-bottom:5px}.empty p{font-size:13px;max-width:380px;margin:0 auto 18px;color:var(--t2)}

/* â•â•â• VIEWER â•â•â• */
.viewer{background:var(--card-s);border:1px solid var(--brd);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow);animation:vIn .4s ease}
.vtbar{display:flex;align-items:center;justify-content:space-between;padding:11px 18px;border-bottom:1px solid var(--brd2)}
.vtbar-l{display:flex;align-items:center;gap:10px}.vtbar-t{font-family:var(--ffd);font-size:14.5px;font-weight:800;color:var(--t0)}
.vtbar-r{display:flex;gap:5px}
.vb{padding:7px 13px;border-radius:var(--radius);font-size:11px;font-weight:700;color:var(--t2);border:1px solid var(--pill-brd);display:flex;align-items:center;gap:4px;transition:all .2s}
.vb:hover{color:var(--ac);border-color:var(--brd);background:var(--ac-bg)}.vb svg{width:12px;height:12px}
.vb-ac{color:var(--ac)!important;border-color:var(--brd)!important;background:var(--ac-bg)!important}
.vframe{width:100%;height:calc(100vh - 185px);border:none;background:#fff}
.xlv{padding:18px;overflow:auto;max-height:calc(100vh - 185px)}
.xlv table{width:100%;border-collapse:collapse;font-size:12px}
.xlv th{background:var(--bg2);font-weight:700;text-align:left;padding:9px 12px;border:1px solid var(--brd);position:sticky;top:0;z-index:2;color:var(--t0)}
.xlv td{padding:8px 12px;border:1px solid var(--brd2);color:var(--t1);transition:background .15s}.xlv tr:hover td{background:var(--ac-bg)}
.dbe{display:none;padding:16px 18px;border-bottom:1px solid var(--brd2);background:color-mix(in srgb,var(--bg2) 80%,transparent)}
.dbe.on{display:block;animation:vIn .3s ease}
.dbe-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}.dbe-grid .fg{margin-bottom:5px}.dbe-full{grid-column:1/-1}
.dbe-acts{display:flex;gap:5px;margin-top:8px;grid-column:1/-1}
.v-err{padding:40px;text-align:center;color:var(--err);display:none}.v-err h3{margin-bottom:6px}

/* â•â•â• ADMIN MODAL â•â•â• */
.adm-ov{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.4);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center}
.adm-ov.on{display:flex}
.adm-p{background:var(--card-s);border:1px solid var(--brd);border-radius:var(--radius-lg);width:92%;max-width:860px;max-height:82vh;overflow:hidden;box-shadow:0 14px 50px rgba(0,0,0,.4);display:flex;flex-direction:column;animation:mIn .35s cubic-bezier(.16,1,.3,1)}
@keyframes mIn{from{opacity:0;transform:translateY(24px) scale(.96)}to{opacity:1;transform:none}}
.adm-hd{display:flex;align-items:center;justify-content:space-between;padding:16px 22px;border-bottom:1px solid var(--brd2)}
.adm-hd h2{font-family:var(--ffd);font-size:18px;display:flex;align-items:center;gap:8px}
.adm-x{width:32px;height:32px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;color:var(--t2);transition:all .3s}
.adm-x:hover{background:rgba(251,113,133,.08);color:var(--err);transform:rotate(90deg)}.adm-x svg{width:14px;height:14px}
.adm-tabs{display:flex;border-bottom:1px solid var(--brd2);padding:0 22px;overflow-x:auto}
.adm-tab{padding:10px 15px;font-size:11px;font-weight:700;color:var(--t3);border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap}
.adm-tab:hover{color:var(--t1)}.adm-tab.on{color:var(--ac);border-bottom-color:var(--ac)}
.adm-bd{flex:1;overflow-y:auto;padding:20px}
.fg{margin-bottom:12px}.fl{display:block;font-size:9px;font-weight:800;color:var(--t2);margin-bottom:4px;letter-spacing:.06em;text-transform:uppercase}
.fi,.fs{width:100%;padding:10px 14px;font-size:13px;font-family:var(--ff);background:var(--bg);color:var(--t0);border:1px solid var(--brd);border-radius:var(--radius);transition:all .25s}
.fi:focus,.fs:focus{outline:none;border-color:var(--ac);box-shadow:0 0 0 3px var(--ac-bg)}
.btn{display:inline-flex;align-items:center;gap:5px;padding:10px 20px;border-radius:var(--radius);font-size:12px;font-weight:800;font-family:var(--ff);transition:all .25s}.btn:active{transform:scale(.96)}
.btn-p{background:var(--g1);color:#fff;box-shadow:0 2px 12px var(--ac-g)}.btn-p:hover{filter:brightness(1.12);transform:translateY(-1px)}
.btn-s{background:var(--pill-bg);color:var(--t1);border:1px solid var(--pill-brd)}.btn-s:hover{color:var(--ac);border-color:var(--brd)}
.btn-d{background:var(--err);color:#fff}.btn-sm{padding:5px 11px;font-size:10px;border-radius:calc(var(--radius) - 4px)}
.ali{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--pill-bg);gap:8px;border-radius:var(--radius);border:1px solid var(--pill-brd);margin-bottom:5px;transition:all .25s}
.ali:hover{background:var(--ac-bg);border-color:var(--brd);transform:translateX(3px)}
.ali-nm{font-size:13px;font-weight:700;color:var(--t0)}.ali-mt{font-size:9.5px;color:var(--t2);margin-top:1px}.ali-acts{display:flex;gap:3px}
.upzone{border:2px dashed var(--brd);border-radius:var(--radius);padding:30px;text-align:center;cursor:pointer;color:var(--t2);transition:all .3s}
.upzone:hover{border-color:var(--ac);background:var(--ac-bg)}.upzone input{display:none}

/* â•â•â• VOICE FAB â•â•â• */
.vfab{position:fixed;bottom:22px;right:22px;z-index:200;width:52px;height:52px;border-radius:var(--radius);background:var(--g1);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 18px var(--ac-g);transition:all .4s cubic-bezier(.34,1.56,.64,1);animation:fabPop .6s cubic-bezier(.34,1.56,.64,1) 1.2s both}
@keyframes fabPop{from{opacity:0;transform:scale(0) rotate(-30deg)}to{opacity:1;transform:none}}
.vfab:hover{transform:scale(1.1) rotate(-5deg)}.vfab svg{width:20px;height:20px}
.vfab.mic-on{background:var(--g2);animation:micG 1.5s ease-in-out infinite}
@keyframes micG{0%,100%{box-shadow:0 0 0 0 var(--ac-g),0 4px 18px var(--ac-g)}50%{box-shadow:0 0 0 14px transparent,0 4px 18px var(--ac-g)}}
.vpanel{position:fixed;bottom:84px;right:22px;z-index:200;width:360px;display:none;flex-direction:column;background:var(--card-s);border:1px solid var(--brd);border-radius:var(--radius-lg);overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.3);animation:mIn .3s cubic-bezier(.16,1,.3,1)}
.vpanel.on{display:flex}
.vp-hd{padding:13px 17px;background:var(--pill-bg);border-bottom:1px solid var(--brd2);display:flex;align-items:center;justify-content:space-between}
.vp-hd h4{font-family:var(--ff);font-size:13px;font-weight:700;display:flex;align-items:center;gap:5px;color:var(--t0)}
.vp-st{font-size:9px;color:var(--t3);margin-top:1px;font-weight:600}
.vp-bd{padding:13px 17px;max-height:250px;overflow-y:auto}
.vlog{display:flex;flex-direction:column;gap:5px}
.vmsg{padding:8px 13px;border-radius:var(--radius);font-size:12px;max-width:84%;line-height:1.45}
.vmsg.usr{background:var(--g1);color:#fff;align-self:flex-end;border-bottom-right-radius:3px;font-weight:600}
.vmsg.bot{background:var(--pill-bg);color:var(--t1);align-self:flex-start;border-bottom-left-radius:3px;border:1px solid var(--pill-brd)}
.vwave{display:flex;align-items:center;justify-content:center;gap:3px;height:28px;padding:5px 0}
.vwave span{width:3px;border-radius:2px;background:var(--ac);animation:wvB .7s ease-in-out infinite}
.vwave span:nth-child(1){height:8px}.vwave span:nth-child(2){height:14px;animation-delay:.1s}.vwave span:nth-child(3){height:22px;animation-delay:.2s}.vwave span:nth-child(4){height:14px;animation-delay:.3s}.vwave span:nth-child(5){height:8px;animation-delay:.4s}
@keyframes wvB{0%,100%{transform:scaleY(.3)}50%{transform:scaleY(1.5)}}
.v-hints{padding:8px 17px;border-top:1px solid var(--brd2);font-size:9.5px;color:var(--t3);font-weight:600}
.toasts{position:fixed;top:68px;right:22px;z-index:600;display:flex;flex-direction:column;gap:5px}
.toast{padding:11px 15px;border-radius:var(--radius);background:var(--card-s);border:1px solid var(--brd);box-shadow:0 4px 18px rgba(0,0,0,.2);font-size:12px;font-weight:600;color:var(--t1);display:flex;align-items:center;gap:7px;min-width:230px;animation:tIn .3s ease}
.toast.ok{border-left:3px solid var(--ok)}.toast.er{border-left:3px solid var(--err)}.toast.nf{border-left:3px solid var(--ac)}
@keyframes tIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}

@keyframes shake{0%,100%{transform:translateX(0)}15%{transform:translateX(-8px)}30%{transform:translateX(8px)}45%{transform:translateX(-5px)}60%{transform:translateX(5px)}75%{transform:translateX(-2px)}90%{transform:translateX(2px)}}

/* â•â•â• RESPONSIVE â€” TELEFON VA PLANSHET â•â•â• */

/* â”€â”€ TABLET (768px â€” 1024px) â”€â”€ */
@media(max-width:1024px){
  .leaders{grid-template-columns:1fr}
  .nav{gap:1px}
  .ni{padding:6px 12px;font-size:11px}
  .ni span{display:none} /* Faqat iconlar ko'rinadi */
  .mgrid{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
  .widgets{grid-template-columns:1fr 1fr}
  .dgrid{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
  .cnt-grid{grid-template-columns:repeat(auto-fill,minmax(230px,1fr))}
  .w-temp{font-size:36px}
  .w-ico{font-size:36px}
  .topbar{padding:0 16px;gap:10px}
  .brand-txt{font-size:14px}
  .btag{font-size:6px;padding:2px 5px}
}

/* â”€â”€ TELEFON (768px dan kichik) â”€â”€ */
@media(max-width:768px){
  /* Topbar â€” kompakt */
  .topbar{padding:0 10px;height:50px;gap:6px}
  .brand{gap:6px}
  .bico{width:34px;height:34px;border-radius:10px}
  .bico svg{width:16px;height:16px}
  .brand-txt{font-size:12px}
  .btag{display:none}
  
  /* Nav â€” gorizontal scroll */
  .nav{display:flex;gap:1px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;max-width:calc(100vw - 200px);padding:2px}
  .nav::-webkit-scrollbar{display:none}
  .ni{padding:5px 8px;font-size:10px;gap:3px;flex-shrink:0}
  .ni span{display:none} /* Ikonlar qoladi */
  .ni svg{width:13px;height:13px}
  
  /* Soat va tema */
  .clk{padding:4px 8px;font-size:10px;gap:4px}
  .clk-dot{width:5px;height:5px}
  .tsw{gap:2px;padding:2px}
  .tp{width:20px;height:20px}
  .ib{width:30px;height:30px}
  .ib svg{width:13px;height:13px}
  
  /* Main kontent */
  .main{padding:0 10px 10px;max-width:100%}
  .crumbs{padding:6px 10px;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;font-size:10px;gap:3px}
  .crumbs::-webkit-scrollbar{display:none}
  
  /* Section header */
  .sh{flex-direction:column;align-items:flex-start;gap:8px;margin:16px 0 12px;padding-bottom:10px}
  .sh-ico{width:40px;height:40px}
  .sh-ico svg{width:18px;height:18px}
  .sh-tit{font-size:clamp(18px,5vw,24px)}
  .sh-sub{font-size:10px}
  .sh-act{padding:8px 16px;font-size:11px}
  
  /* Rahbarlar kartasi */
  .leaders{grid-template-columns:1fr;gap:10px}
  .lc{padding:14px}
  .lc-head{gap:10px;margin-bottom:10px}
  .lc-ava{width:44px;height:44px;font-size:18px}
  .lc-nm{font-size:15px}
  .lc-role{font-size:9px}
  .lc-stats{grid-template-columns:repeat(3,1fr);gap:4px;padding-top:10px}
  .lc-sn{font-size:16px}
  .lc-sl{font-size:7px}
  .ltag{padding:1px 6px;font-size:8px}
  
  /* Widgetlar â€” bitta ustun */
  .widgets{grid-template-columns:1fr;gap:10px;margin-top:12px}
  .wgt{padding:14px}
  .wgt-t{font-size:7px;margin-bottom:8px}
  
  /* Ob-havo */
  .w-row{gap:10px;flex-wrap:wrap}
  .w-ico{font-size:36px}
  .w-temp{font-size:38px}
  .w-det{font-size:11px}
  .w-forecast{overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .w-forecast::-webkit-scrollbar{display:none}
  
  /* Yangiliklar */
  .n-list{max-height:180px}
  .n-item{padding:6px 0;gap:6px;font-size:11px}
  .n-time{font-size:8px;padding:2px 6px}
  
  /* Uchrashuvlar */
  .mgrid{grid-template-columns:1fr;gap:8px}
  .mc{padding:12px;gap:8px}
  .mc-time{min-width:44px;padding:6px}
  .mc-d{font-size:18px}
  .mc-title{font-size:12px}
  .mc-who{font-size:9px}
  .mc-acts button{padding:4px 8px;font-size:8px}
  
  /* Kontaktlar */
  .cnt-grid{grid-template-columns:1fr;gap:8px}
  .cnt-card{padding:10px 12px;gap:10px}
  .cnt-ava{width:34px;height:34px;font-size:11px}
  .cnt-name{font-size:11.5px}
  .cnt-role{font-size:8.5px}
  .cnt-phone{font-size:10px}
  .cnt-call{width:36px;height:36px} /* Touch-friendly */
  
  /* Bo'limlar va dashboard'lar */
  .dgrid{grid-template-columns:1fr;gap:10px}
  .dc{padding:14px}
  .dc-ico{width:42px;height:42px}
  .dc-nm{font-size:14px}
  .dc-t{font-size:8px}
  .dbe-grid{grid-template-columns:1fr}
  
  /* Dashboard viewer */
  .vframe{height:calc(100vh - 140px)}
  .xlv{padding:10px;max-height:calc(100vh - 140px)}
  .xlv th,.xlv td{padding:6px 8px;font-size:10px}
  .vb{padding:5px 9px;font-size:10px;gap:3px}
  .vb svg{width:10px;height:10px}
  
  /* Admin modal â€” to'liq ekran */
  .adm-ov{align-items:flex-end}
  .adm-p{width:100%;max-width:100%;max-height:92vh;border-radius:var(--radius-lg) var(--radius-lg) 0 0}
  .adm-hd{padding:12px 16px}
  .adm-hd h2{font-size:15px}
  .adm-tabs{padding:0 12px}
  .adm-tab{padding:8px 10px;font-size:10px}
  .adm-bd{padding:14px}
  .fg{margin-bottom:10px}
  .fi,.fs{padding:10px 12px;font-size:14px} /* Touch-uchun kattaroq */
  .btn{padding:10px 18px;font-size:12px}
  .ali{padding:10px 12px;gap:6px}
  .ali-nm{font-size:12px}
  .upzone{padding:20px}
  
  /* Meeting modal */
  .meetModal-box{width:95vw;max-height:90vh;padding:16px}
  .meetModal h3{font-size:14px}
  .mf-row{grid-template-columns:1fr;gap:8px}
  .mf-row input,.mf-row select,.mf-row textarea{font-size:14px;padding:10px 12px} /* Touch */
  
  /* Voice panel â€” pastdan ochiladi */
  .vpanel{width:100%;right:0;bottom:0;left:0;border-radius:var(--radius-lg) var(--radius-lg) 0 0;max-height:70vh}
  .vfab{bottom:12px;right:12px;width:48px;height:48px;border-radius:14px}
  .vfab svg{width:18px;height:18px}
  .vp-bd{max-height:200px}
  .vmsg{font-size:11px;max-width:90%}
  .v-hints{font-size:8.5px;padding:6px 14px}
  
  /* Toastlar */
  .toasts{top:54px;right:10px;left:10px}
  .toast{min-width:auto;width:100%;font-size:11px;padding:9px 12px}
  
  /* ZIP banner */
  #zipBanner{padding:12px 14px;border-radius:12px}
  #zipBanner>div>div:last-child{flex-direction:column;gap:6px;width:100%}
  #zipBanner button{width:100%;text-align:center}
}

/* â”€â”€ JUDA KICHIK TELEFONLAR (480px dan kichik) â”€â”€ */
@media(max-width:480px){
  .topbar{height:46px;padding:0 8px}
  .brand-txt{display:none}
  .nav{max-width:calc(100vw - 140px)}
  .clk{display:none}
  .main{padding:0 8px 8px}
  .sh-tit{font-size:18px}
  .sh-act{padding:7px 12px;font-size:10px}
  .leaders{gap:8px}
  .lc{padding:12px}
  .lc-ava{width:38px;height:38px;font-size:15px}
  .lc-nm{font-size:13px}
  .lc-stats{grid-template-columns:repeat(3,1fr);gap:3px}
  .w-temp{font-size:32px}
  .w-ico{font-size:30px}
  .n-list{max-height:150px}
  .mc{flex-direction:column;gap:6px}
  .mc-time{flex-direction:row;min-width:auto;padding:6px 12px}
  .cnt-grid{gap:6px}
  .adm-p{max-height:95vh}
  .vpanel{max-height:80vh}
  .vp-bd{max-height:180px}
}

/* â”€â”€ TOUCH QURILMALAR UCHUN â”€â”€ */
@media(hover:none) and (pointer:coarse){
  /* Touch targetlar minimum 44px */
  .ni{min-height:36px}
  .ib{min-width:36px;min-height:36px}
  .tp{min-width:24px;min-height:24px}
  .cnt-call{min-width:44px;min-height:44px}
  .btn{min-height:40px}
  .mc-acts button{min-height:32px;padding:6px 12px}
  .fi,.fs,.mf-row input,.mf-row select,.mf-row textarea{font-size:16px!important} /* iOS zoom oldini olish */
  /* Hover effektlarni olib tashlash */
  .lc:hover,.mc:hover,.dc:hover,.cnt-card:hover,.n-item:hover,.wgt:hover,.ali:hover{transform:none}
  /* Active state qo'shish */
  .lc:active,.mc:active,.dc:active,.cnt-card:active{transform:scale(.98);transition:transform .1s}
  .btn:active{transform:scale(.95)}
  .ni:active{background:var(--ac-bg)}
}

/* â”€â”€ LANDSCAPE TELEFON â”€â”€ */
@media(max-height:500px) and (orientation:landscape){
  .topbar{height:42px}
  .main{padding:0 10px 10px}
  .vpanel{max-height:90vh;bottom:0}
  .vfab{bottom:8px;right:8px;width:40px;height:40px}
  .vframe{height:calc(100vh - 100px)}
}

@media print{.topbar,.vfab,.vpanel,.adm-ov,.crumbs,.bg-mesh,.bg-noise,.bg-pattern,.bg-scan,.bg-pts{display:none!important}}
</style>
</head>
<body data-theme="cyber">
<!-- Background layers â€” har tema o'z pattern + mesh + particles -->
<div class="bg-mesh">
  <svg viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid slice">
    <defs><filter id="blur"><feGaussianBlur stdDeviation="100"/></filter></defs>
    <circle id="mb1" cx="180" cy="220" r="360" fill="var(--glow-1)" opacity=".05" filter="url(#blur)">
      <animate attributeName="cx" values="180;420;180" dur="24s" repeatCount="indefinite"/>
      <animate attributeName="cy" values="220;440;220" dur="30s" repeatCount="indefinite"/>
    </circle>
    <circle id="mb2" cx="780" cy="720" r="300" fill="var(--glow-2)" opacity=".04" filter="url(#blur)">
      <animate attributeName="cx" values="780;560;780" dur="27s" repeatCount="indefinite"/>
      <animate attributeName="cy" values="720;510;720" dur="22s" repeatCount="indefinite"/>
    </circle>
    <circle id="mb3" cx="500" cy="400" r="240" fill="var(--glow-3)" opacity=".03" filter="url(#blur)">
      <animate attributeName="cx" values="500;670;330;500" dur="32s" repeatCount="indefinite"/>
      <animate attributeName="cy" values="400;260;540;400" dur="28s" repeatCount="indefinite"/>
    </circle>
  </svg>
</div>
<div class="bg-pattern"></div>
<div class="bg-scan"></div>
<div class="bg-noise"></div>
<div class="bg-pts" id="particles"></div>

<div class="shell">
  <header class="topbar">
    <div class="brand" onclick="go('home')">
      <div class="bico"><i data-lucide="landmark"></i></div>
      <div><div class="bt1">Markaziy<span>.Bank</span></div><div class="bt2">Toshkent viloyati</div></div>
    </div>
    <nav class="nav">
      <button class="ni on" id="navH" onclick="go('home')"><i data-lucide="layout-grid"></i> Bosh sahifa</button>
      <button class="ni" id="navM" onclick="go('meetings')"><i data-lucide="calendar-clock"></i> Uchrashuvlar</button>
      <button class="ni" id="navC" onclick="go('contacts')"><i data-lucide="phone"></i> Kontaktlar</button>
      <button class="ni" onclick="openAdm()"><i data-lucide="sliders-horizontal"></i> Sozlamalar</button>
    </nav>
    <div class="clk"><span class="clk-dot"></span><span id="tcClock">--:--</span><span style="color:var(--t3)">Â·</span><span id="tcDate" style="color:var(--t2);font-weight:600;font-size:10.5px">--</span></div>
    <div class="tr">
      <div class="tsw">
        <button class="tp" data-t="cyber" onclick="setTheme('cyber')" title="Neon Cyber"></button>
        <button class="tp" data-t="aurora" onclick="setTheme('aurora')" title="Aurora (kunduzgi)"></button>
        <button class="tp" data-t="teal" onclick="setTheme('teal')" title="Teal Neon (tungi)"></button>
        <button class="tp" data-t="sakura" onclick="setTheme('sakura')" title="Sakura"></button>
      </div>
      <button class="ib" onclick="toast('Bildirishnomalar','nf')"><i data-lucide="bell"></i><span class="dot"></span></button>
    </div>
  </header>
  <nav class="crumbs" id="crumbs"><span class="crumb crumb-cur">Bosh sahifa</span></nav>
  <main class="main">
    <section class="view on" id="vHome">
      <div id="zipBanner" style="display:none;background:linear-gradient(135deg,var(--ac),var(--ac2));border-radius:var(--radius-lg);padding:16px 22px;margin-bottom:16px;color:#fff;animation:mIn .4s">
        <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap">
          <div style="font-size:32px">ğŸ“¦</div>
          <div style="flex:1;min-width:200px">
            <div style="font-weight:800;font-size:15px;font-family:var(--ffd)">Loyihani yuklash</div>
            <div style="font-size:11px;opacity:.85;margin-top:2px">ZIP faylni yuklang â€” barcha dashboard va Excel fayllar avtomatik ishlaydi</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button onclick="loadProjectZip()" style="background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3);padding:8px 16px;border-radius:20px;font-weight:700;font-size:12px;cursor:pointer;transition:all .2s;backdrop-filter:blur(10px)" onmouseover="this.style.background='rgba(255,255,255,.3)'" onmouseout="this.style.background='rgba(255,255,255,.2)'">ğŸ“¦ ZIP tanlash</button>
            <button onclick="loadProjectFolder()" style="background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);padding:8px 16px;border-radius:20px;font-weight:700;font-size:12px;cursor:pointer;transition:all .2s" onmouseover="this.style.background='rgba(255,255,255,.2)'" onmouseout="this.style.background='rgba(255,255,255,.1)'">ğŸ“ Papka tanlash</button>
          </div>
        </div>
        <div id="zipProgress" style="display:none;margin-top:10px;background:rgba(255,255,255,.15);border-radius:10px;height:6px;overflow:hidden"><div id="zipBar" style="background:#fff;height:100%;width:0;border-radius:10px;transition:width .3s"></div></div>
        <div id="zipStatus" style="font-size:10px;opacity:.7;margin-top:6px;display:none"></div>
      </div>
      <div id="zipLoaded" style="display:none;background:var(--card-s);border:1px solid var(--ok);border-radius:var(--radius-lg);padding:12px 18px;margin-bottom:16px">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span style="font-size:20px">âœ…</span>
          <div style="flex:1"><div style="font-weight:700;font-size:13px;color:var(--ok)" id="zipLoadedMsg">Loyiha yuklandi</div><div style="font-size:10px;color:var(--t2)" id="zipLoadedDet"></div></div>
          <button class="btn btn-sm btn-s" onclick="loadProjectZip()">ğŸ”„ Qayta</button>
        </div>
      </div>
      <div class="sh"><div class="sh-l"><div class="sh-ico"><i data-lucide="users-round"></i></div><div><h2 class="sh-tit">Rahbarlar</h2><div class="sh-sub" id="hSub"></div></div></div><button class="sh-act" onclick="openAdm()"><i data-lucide="plus-circle"></i> Yangi</button></div>
      <div class="leaders" id="leadersGrid"></div>
      <div class="widgets">
        <div class="wgt"><div class="wgt-t"><i data-lucide="cloud-sun"></i> Ob-havo Â· Toshkent</div><div class="w-row"><div class="w-ico" id="wIco">â›…</div><div class="w-temp" id="wTemp">--Â°</div><div class="w-det" id="wDet">...</div></div></div>
        <div class="wgt"><div class="wgt-t" style="display:flex;align-items:center;justify-content:space-between"><span><i data-lucide="newspaper"></i> <span style="color:#e91e63;font-weight:800">bankers.uz</span></span><span style="display:flex;align-items:center;gap:6px"><span id="nTimeB" style="font-size:9px;color:var(--t3);font-weight:400"></span><button onclick="loadNB()" style="background:none;border:none;cursor:pointer;color:var(--t2);padding:2px" title="Yangilash"><i data-lucide="refresh-cw" style="width:13px;height:13px"></i></button></span></div><div class="n-list" id="nListB"></div></div>
        <div class="wgt"><div class="wgt-t" style="display:flex;align-items:center;justify-content:space-between"><span><i data-lucide="newspaper"></i> <span style="color:#2196f3;font-weight:800">kun.uz</span> <span style="font-size:9px;color:var(--t2);font-weight:600">Â· iqtisodiyot</span></span><span style="display:flex;align-items:center;gap:6px"><span id="nTimeK" style="font-size:9px;color:var(--t3);font-weight:400"></span><button onclick="loadNK()" style="background:none;border:none;cursor:pointer;color:var(--t2);padding:2px" title="Yangilash"><i data-lucide="refresh-cw" style="width:13px;height:13px"></i></button></span></div><div class="n-list" id="nListK"></div></div>
      </div>
      <div class="meetings"><div class="sh" style="margin-top:24px"><div class="sh-l"><div class="sh-ico"><i data-lucide="calendar-clock"></i></div><div><h2 class="sh-tit">Uchrashuvlar</h2><div class="sh-sub">Kelgusi uchrashuvlar</div></div></div><button class="sh-act" onclick="addMeet()"><i data-lucide="plus-circle"></i> Yangi</button></div><div class="mgrid" id="meetGrid"></div></div>
    </section>
    <section class="view" id="vMeet"><div class="sh"><div class="sh-l"><div class="sh-ico"><i data-lucide="calendar-clock"></i></div><div><h2 class="sh-tit">Uchrashuvlar</h2><div class="sh-sub">Barcha uchrashuvlar</div></div></div><div style="display:flex;gap:6px"><button class="sh-act" onclick="setTgLink()" style="background:linear-gradient(135deg,#0088cc,#00aced);color:#fff;border:none"><i data-lucide="send" style="width:12px;height:12px"></i> Telegram</button><button class="sh-act" onclick="addMeet()"><i data-lucide="plus-circle"></i> Yangi</button></div></div><div class="mgrid" id="meetGrid2"></div></section>
    <section class="view" id="vContacts"><div class="sh"><div class="sh-l"><div class="sh-ico"><i data-lucide="phone"></i></div><div><h2 class="sh-tit">Kontaktlar</h2><div class="sh-sub">Telefon raqamlar va qo'ng'iroq</div></div></div><button class="sh-act" onclick="addContact()"><i data-lucide="plus-circle"></i> Yangi</button></div><div class="cnt-grid" id="cntGrid"></div></section>
    <section class="view" id="vLeader"><div class="sh2"><button class="back" onclick="go('home')"><i data-lucide="arrow-left"></i> Orqaga</button><h2 id="lTitle"></h2><div class="sh-sub" id="lSub"></div></div><div class="dgrid" id="deptGrid"></div></section>
    <section class="view" id="vDept"><div class="sh2"><button class="back" id="deptBk"><i data-lucide="arrow-left"></i> Orqaga</button><h2 id="dTitle"></h2><div class="sh-sub" id="dSub"></div></div><div class="dgrid" id="dashGrid"></div><div class="empty" id="dEmpty" style="display:none"><div class="empty-ico"><i data-lucide="folder-open"></i></div><h3>Dashboard mavjud emas</h3><p>Admin panelidan dashboard qo'shing</p><button class="btn btn-p" onclick="openAdm()"><i data-lucide="settings"></i> Admin</button></div></section>
    <section class="view" id="vDash">
      <div class="viewer">
        <div class="vtbar"><div class="vtbar-l"><button class="back" id="dashBk" style="margin:0"><i data-lucide="arrow-left"></i></button><span class="vtbar-t" id="dbTit"></span></div><div class="vtbar-r"><div id="dbTabs" style="display:flex;gap:4px"></div><button class="vb vb-ac" onclick="toggleDbEdit()"><i data-lucide="pencil"></i> Tahrirlash</button><button class="vb" onclick="refreshDB()"><i data-lucide="refresh-cw"></i> Yangilash</button><button class="vb" onclick="goFS()"><i data-lucide="maximize-2"></i></button></div></div>
        <div class="dbe" id="dbEdit"><div class="dbe-grid"><div class="fg"><label class="fl">Dashboard nomi</label><input class="fi" id="deNm"></div><div class="fg"><label class="fl">Turi</label><select class="fs" id="deTy"><option value="html">HTML</option><option value="excel">Excel</option><option value="url">URL</option></select></div><div class="fg dbe-full"><label class="fl">HTML / URL yo'li</label><div style="display:flex;gap:6px;align-items:center"><input class="fi" id="dePth" style="flex:1"><button class="btn btn-p btn-sm" onclick="browseFile('html')" title="HTML faylni tanlash">ğŸ“„</button><button class="btn btn-s btn-sm" onclick="browseFolder('html')" title="Papkadan tanlash">ğŸ“</button><button class="btn btn-s btn-sm" onclick="browseZip('html')" title="ZIP ichidan tanlash">ğŸ“¦</button></div></div><div class="fg dbe-full"><label class="fl">Excel fayl yo'li</label><div style="display:flex;gap:6px;align-items:center"><input class="fi" id="deXl" style="flex:1"><button class="btn btn-p btn-sm" onclick="browseFile('excel')" title="Excel faylni tanlash">ğŸ“Š</button><button class="btn btn-s btn-sm" onclick="browseFolder('excel')" title="Papkadan tanlash">ğŸ“</button><button class="btn btn-s btn-sm" onclick="browseZip('excel')" title="ZIP ichidan tanlash">ğŸ“¦</button></div></div><div class="dbe-acts"><button class="btn btn-p btn-sm" onclick="saveDbEdit()"><i data-lucide="check" style="width:11px;height:11px"></i> Saqlash</button><button class="btn btn-s btn-sm" onclick="toggleDbEdit()">Bekor</button><button class="btn btn-d btn-sm" onclick="delCurDb()" style="margin-left:auto"><i data-lucide="trash-2" style="width:11px;height:11px"></i> O'chirish</button></div></div></div>
        <iframe id="dbFrame" class="vframe" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation allow-top-navigation-by-user-activation" loading="lazy"></iframe>
        <div id="xlView" class="xlv" style="display:none"></div>
        <div class="v-err" id="vErr"><h3>âš ï¸ Yuklanmadi</h3><p id="vErrMsg"></p><button class="btn btn-p" onclick="go('home')" style="margin-top:10px">Bosh sahifa</button></div>
      </div>
    </section>
  </main>
</div>
<!-- YANGI DASHBOARD QO'SHISH MODALI -->
<div class="adm-ov" id="addDbOv" style="display:none"><div class="adm-p" style="max-width:540px">
  <div class="adm-hd"><h2>â• Yangi dashboard</h2><button class="adm-x" onclick="closeAddDash()"><i data-lucide="x"></i></button></div>
  <div class="adm-bd" style="padding:22px;overflow-y:auto">
    <div class="fg"><label class="fl">Bo'lim</label><select class="fs" id="adDept"></select></div>
    <div class="fg"><label class="fl">Dashboard nomi</label><input class="fi" id="adName" placeholder="Masalan: Kredit tahlili"></div>
    <div class="fg"><label class="fl">Turi</label><select class="fs" id="adType" onchange="adTypeChg()"><option value="html">HTML</option><option value="excel">Excel</option><option value="url">URL</option></select></div>
    <div id="adUrlFg" class="fg" style="display:none"><label class="fl">URL manzili</label><input class="fi" id="adUrl" placeholder="https://..."></div>
    <div id="adFileFg">
      <div class="fg"><label class="fl">HTML fayl</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input class="fi" id="adPath" style="flex:1" readonly placeholder="Faylni tanlang â†’">
          <button class="btn btn-p btn-sm" onclick="adBrowse('html','file')" title="Fayl tanlash">ğŸ“„</button>
          <button class="btn btn-s btn-sm" onclick="adBrowse('html','folder')" title="Papkadan">ğŸ“</button>
          <button class="btn btn-s btn-sm" onclick="adBrowse('html','zip')" title="ZIP dan">ğŸ“¦</button>
        </div>
      </div>
      <div class="fg"><label class="fl">Excel fayl (ixtiyoriy)</label>
        <div style="display:flex;gap:6px;align-items:center">
          <input class="fi" id="adXl" style="flex:1" readonly placeholder="Ixtiyoriy">
          <button class="btn btn-p btn-sm" onclick="adBrowse('excel','file')" title="Excel tanlash">ğŸ“Š</button>
          <button class="btn btn-s btn-sm" onclick="adBrowse('excel','folder')" title="Papkadan">ğŸ“</button>
          <button class="btn btn-s btn-sm" onclick="adBrowse('excel','zip')" title="ZIP dan">ğŸ“¦</button>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:18px">
      <button class="btn btn-p" onclick="saveAddDash()"><i data-lucide="plus-circle" style="width:14px;height:14px"></i> Qo'shish</button>
      <button class="btn btn-s" onclick="closeAddDash()">Bekor qilish</button>
    </div>
  </div>
</div></div>

<div class="adm-ov" id="admOv"><div class="adm-p"><div class="adm-hd"><h2><i data-lucide="shield-check"></i> Boshqaruv</h2><button class="adm-x" onclick="closeAdm()"><i data-lucide="x"></i></button></div><div class="adm-tabs"><button class="adm-tab on" data-tab="leaders" onclick="admTab('leaders')">Rahbarlar</button><button class="adm-tab" data-tab="transfer" onclick="admTab('transfer')">Ko'chirish</button><button class="adm-tab" data-tab="depts" onclick="admTab('depts')">Bo'limlar</button><button class="adm-tab" data-tab="dashs" onclick="admTab('dashs')">Dashboardlar</button><button class="adm-tab" data-tab="files" onclick="admTab('files')">ğŸ“ Papkalar</button><button class="adm-tab" data-tab="upload" onclick="admTab('upload')">Yuklash</button><button class="adm-tab" data-tab="cfg" onclick="admTab('cfg')">Sozlamalar</button></div><div class="adm-bd" id="admBd"></div></div></div>
<button class="vfab" id="vFab" onclick="toggleVC()"><i data-lucide="mic"></i></button>
<div class="vpanel" id="vPanel"><div class="vp-hd"><div><h4><i data-lucide="mic"></i> Ovozli yordamchi</h4><div class="vp-st" id="vSt">Tayyor</div></div><button class="adm-x" onclick="toggleVC()" style="width:26px;height:26px"><i data-lucide="x" style="width:13px;height:13px"></i></button></div><div class="vp-bd"><div class="vlog" id="vLog"><div class="vmsg bot">Assalomu alaykum!</div></div><div class="vwave" id="vWave" style="display:none"><span></span><span></span><span></span><span></span><span></span></div><button id="vStopBtn" onclick="vUserStop()" style="display:none;width:100%;padding:10px;margin-top:8px;background:linear-gradient(135deg,#ef4444,#f97316);color:#fff;border:none;border-radius:var(--radius);font-weight:800;font-size:13px;cursor:pointer;font-family:var(--ff);transition:all .2s;animation:mIn .2s" onmouseover="this.style.opacity='.85'" onmouseout="this.style.opacity='1'">â¹ To'xtatish</button></div><div class="v-hints">ğŸ™ Azure O'zbekcha Â· "to'xta" yoki â¹ tugma bilan to'xtating</div>
<div class="toasts" id="toasts"></div>
<script>
/* â•â•â• DATA MODEL â€” barcha 14 dashboard, 4 rahbar, 11 bo'lim â•â•â• */
var INIT={leaders:[
{id:"fayzullaxojayev",name:"J.X.Fayzullaxo'jayev",role:"Bosh boshqarma boshlig'i",ini:"JF",ci:0,departments:[
  {id:"d1",name:"Bank xizmatlari iste'molchilarining huquqlarini himoya qilish, moliyaviy savodxonlik va ommaboplikni oshirish shu'basi",boss:"S.T.Abdullayev",bossRole:"Shu'ba boshlig'i",dashboards:[
    {id:"db1",name:"Scoring Banking",type:"html",path:"J.X.Fayzullaxo'jayev yo'nalishi/Bank xizmatlari iste'molchilarining huquqlarini himoya qilish, moliyaviy savodxonlik va ommaboplikni oshirish shu'basi/scoring_banking.html"},
    {id:"db2",name:"Sirli mijoz tahlili",type:"html",path:"J.X.Fayzullaxo'jayev yo'nalishi/Bank xizmatlari iste'molchilarining huquqlarini himoya qilish, moliyaviy savodxonlik va ommaboplikni oshirish shu'basi/sirli_mijoz_final.html"}]},
  {id:"d2",name:"Buxgalteriya hisobi, hisoboti va moliyaviy-iqtisodiy faoliyat boshqarmasi",boss:"D.K.Rahimova",bossRole:"Boshqarma boshlig'i",dashboards:[]},
  {id:"d3",name:"Ijro apparati",boss:"M.N.Toshmatov",bossRole:"Apparati boshlig'i",dashboards:[
    {id:"db3",name:"Ijro nazorati",type:"html",path:"J.X.Fayzullaxo'jayev yo'nalishi/Ijro apparati/index.html",xl:"J.X.Fayzullaxo'jayev yo'nalishi/Ijro apparati/\u043c\u0443\u0440\u043e\u0436\u0430\u0430\u0442\u043b\u0430\u0440 \u0439\u0438\u043b\u043b\u0438\u043a.xlsx"},
    {id:"db4",name:"Murojatlar dashboard",type:"html",path:"J.X.Fayzullaxo'jayev yo'nalishi/Ijro apparati/murojatlar_dashboard.html",xl:"J.X.Fayzullaxo'jayev yo'nalishi/Ijro apparati/\u043c\u0443\u0440\u043e\u0436\u0430\u0430\u0442\u043b\u0430\u0440 \u0439\u0438\u043b\u043b\u0438\u043a.xlsx"}]},
  {id:"d4",name:"Narxlar va iqtisodiy kutilmalarni o'rganish bo'limi",boss:"F.A.Xasanov",bossRole:"Bo'lim boshlig'i",dashboards:[]}]},
{id:"nuraliyev",name:"B.F.Nuraliyev",role:"Bosh boshqarma boshlig'i o'rinbosari",ini:"BN",ci:1,departments:[
  {id:"d5",name:"Kredit tashkilotlarida moliyaviy monitoringni muvofiqlashtirish va valyuta nazorati bo'limi",boss:"R.S.Karimov",bossRole:"Bo'lim boshlig'i",dashboards:[
    {id:"db5",name:"Valyuta monitoringi",type:"html",path:"B.F.Nuraliyev yo'nalishi/Kredit tashkilotlarida moliyaviy monitoringni muvofiqlashtirish va valyuta nazorati bo'limi/index.html"},
    {id:"db6",name:"Eksport-Import valyuta",type:"html",path:"B.F.Nuraliyev yo'nalishi/Kredit tashkilotlarida moliyaviy monitoringni muvofiqlashtirish va valyuta nazorati bo'limi/export import/valyuta_dashboard.html",xl:"B.F.Nuraliyev yo'nalishi/Kredit tashkilotlarida moliyaviy monitoringni muvofiqlashtirish va valyuta nazorati bo'limi/export import/1 \u0441\u043b\u0430\u0439\u0434 \u0443\u0447\u0443\u043d 19.12 (2).xls"},
    {id:"db7",name:"Valyuta XPU",type:"html",path:"B.F.Nuraliyev yo'nalishi/Kredit tashkilotlarida moliyaviy monitoringni muvofiqlashtirish va valyuta nazorati bo'limi/Valyuta XPU/valyuta_hpu.html",xl:"B.F.Nuraliyev yo'nalishi/Kredit tashkilotlarida moliyaviy monitoringni muvofiqlashtirish va valyuta nazorati bo'limi/Valyuta XPU/\u0436\u0430\u043c\u0438 2024-25 \u0438\u0448\u043b\u0430\u0448\u0433\u0430 \u0432\u0430\u0448.xlsx"}]},
  {id:"d6",name:"Kredit tashkilotlarini inspeksiya qilish boshqarmasi",boss:"A.B.Sultonov",bossRole:"Boshqarma boshlig'i",dashboards:[]},
  {id:"d7",name:"Kredit tashkilotlarining muammoli aktivlari bilan ishlash va moliyaviy tahlil qilish bo'limi",boss:"N.O.Mirzayev",bossRole:"Bo'lim boshlig'i",dashboards:[
    {id:"db8",name:"NPL Risk Rating",type:"html",path:"B.F.Nuraliyev yo'nalishi/Kredit tashkilotlarining muammoli aktivlari bilan ishlash va moliyaviy tahlil qilish bo'limi/NPL_Risk_Rating_100.html"},
    {id:"db9",name:"NPL Risk tizimi",type:"html",path:"B.F.Nuraliyev yo'nalishi/Kredit tashkilotlarining muammoli aktivlari bilan ishlash va moliyaviy tahlil qilish bo'limi/npl_risk_system_v11_full_edit.html"},
    {id:"db10",name:"NPL sayt versiya",type:"html",path:"B.F.Nuraliyev yo'nalishi/Kredit tashkilotlarining muammoli aktivlari bilan ishlash va moliyaviy tahlil qilish bo'limi/saytga yuklash/npl_tizimi.html"}]}]},
{id:"irgashev",name:"I.R.Irgashev",role:"Bosh boshqarma boshlig'i o'rinbosari",ini:"II",ci:2,departments:[
  {id:"d8",name:"Hududlarni ijtimoiy-iqtisodiy rivojlantirish borasida tijorat banklari faoliyatini monitoring qilish bo'limi",boss:"L.M.Qodirov",bossRole:"Bo'lim boshlig'i",dashboards:[
    {id:"db11",name:"Parkentsoy tahlili",type:"html",path:"I.R.Irgashev yo'nalishi/Hududlarni ijtimoiy-iqtisodiy rivojlantirish borasida tijorat banklari faoliyatini monitoring qilish bo'limi/parkentsoy/parkentsoy_voice.html"}]},
  {id:"d9",name:"Tadbirkorlikni qo'llab-quvvatlash va aholi bandligini ta'minlash bo'limi",boss:"Sh.U.Nazarov",bossRole:"Bo'lim boshlig'i",dashboards:[
    {id:"db12",name:"Tadbirkorlik monitoringi",type:"html",path:"I.R.Irgashev yo'nalishi/Tadbirkorlikni qo'llab-quvvatlash va aholi bandligini ta'minlash bo'limi/index.html",xl:"I.R.Irgashev yo'nalishi/Tadbirkorlikni qo'llab-quvvatlash va aholi bandligini ta'minlash bo'limi/eng_ohiri_dasturlar_2_lotin.xlsx"},
    {id:"db13",name:"Banklar tahlili",type:"html",path:"I.R.Irgashev yo'nalishi/Tadbirkorlikni qo'llab-quvvatlash va aholi bandligini ta'minlash bo'limi/banklar tahlili/banklar_tahlili.html",xl:"I.R.Irgashev yo'nalishi/Tadbirkorlikni qo'llab-quvvatlash va aholi bandligini ta'minlash bo'limi/banklar tahlili/+++\u0411\u0430\u043d\u043a\u043b\u0430\u0440_2025_\u0439_\u0420\u0435\u0439\u0442\u0438\u043d\u0433_\u0411\u0430\u043d\u043a\u043b\u0430\u0440_\u0443\u0447\u0443\u043d_01122025_\u0439 (3).xlsx"},
    {id:"db14",name:"Mahallalar tahlili",type:"html",path:"I.R.Irgashev yo'nalishi/Tadbirkorlikni qo'llab-quvvatlash va aholi bandligini ta'minlash bo'limi/mahallalar tahlili dastur bo'yicha/kredit_dashboard_v17_mahalla_count.html",xl:"I.R.Irgashev yo'nalishi/Tadbirkorlikni qo'llab-quvvatlash va aholi bandligini ta'minlash bo'limi/mahallalar tahlili dastur bo'yicha/++++\u044d\u043d\u0433 \u043e\u0445\u0438\u0440\u0438 \u0434\u0430\u0441\u0442\u0443\u0440\u043b\u0430\u0440 (2).xlsx"}]}]},
{id:"jurayev",name:"A.A.Jurayev",role:"Bosh boshqarma boshlig'i o'rinbosari",ini:"AJ",ci:3,departments:[
  {id:"d10",name:"Naqd pul muomalasini tashkil etish boshqarmasi",boss:"G.H.Tursunov",bossRole:"Boshqarma boshlig'i",dashboards:[]},
  {id:"d11",name:"To'lov tizimlari infratuzilmalari va axborot texnologiyalari bo'limi",boss:"V.A.Ismoilov",bossRole:"Bo'lim boshlig'i",dashboards:[]}]}],
meetings:[
  {id:"m1",day:3,month:"Fev",time:"10:00",title:"Valyuta nazorati yig'ilishi",who:"B.F.Nuraliyev, Valyuta bo'limi",urgency:"urgent"},
  {id:"m2",day:5,month:"Fev",time:"14:30",title:"NPL monitoring tahlili",who:"Moliyaviy tahlil guruhi",urgency:"normal"},
  {id:"m3",day:7,month:"Fev",time:"09:00",title:"Haftalik operativ yig'ilish",who:"Barcha rahbarlar",urgency:"urgent"},
  {id:"m4",day:10,month:"Fev",time:"11:00",title:"Tadbirkorlik dasturi natijalar",who:"I.R.Irgashev, Bo'lim boshliqlari",urgency:"normal"},
  {id:"m5",day:12,month:"Fev",time:"15:00",title:"Moliyaviy savodxonlik hisoboti",who:"J.X.Fayzullaxo'jayev",urgency:"done"},
  {id:"m6",day:14,month:"Fev",time:"10:30",title:"IT infratuzilma yangilanishi",who:"A.A.Jurayev, IT bo'limi",urgency:"normal"}]};
var D=load(),_curDb={lid:'',did:'',dbid:''};
function $(id){return document.getElementById(id)}
function load(){
  var d;
  try{var s=localStorage.getItem('cbNE');if(s)d=JSON.parse(s)}catch(e){}
  if(!d)d=JSON.parse(JSON.stringify(INIT));
  /* â•â•â• MIGRATSIYA: boss maydonini eski dataga qo'shish â•â•â• */
  if(d.leaders&&INIT.leaders){
    for(var i=0;i<d.leaders.length;i++){
      var dl=d.leaders[i],il=INIT.leaders.find(function(x){return x.id===dl.id});
      if(!il||!dl.departments)continue;
      for(var j=0;j<dl.departments.length;j++){
        var dd=dl.departments[j];
        if(!dd.boss){
          var id2=il.departments.find(function(x){return x.id===dd.id});
          if(id2&&id2.boss)dd.boss=id2.boss;
        }
        if(!dd.bossRole){
          var id3=il.departments.find(function(x){return x.id===dd.id});
          if(id3&&id3.bossRole)dd.bossRole=id3.bossRole;
        }
      }
    }
  }
  /* Kontaktlar migratsiyasi */
  if(!d._contacts)d._contacts=null;
  return d;
}
function save(){D._v=(D._v||0)+1;try{localStorage.setItem('cbNE',JSON.stringify(D))}catch(e){};cloudPush()}

/* â•â•â• BULUT SINXRONIZATSIYA â€” npoint.io â•â•â• */
var CLOUD_URL='https://api.npoint.io/ca86986b2e7c46199e55';
function _getCloudUrl(){return CLOUD_URL||localStorage.getItem('cloudUrl')||''}
/* Bulutdan ma'lumot olish */
async function cloudPull(){
  var url=_getCloudUrl();if(!url)return null;
  try{
    var r=await fetch(url+'?t='+Date.now());
    if(!r.ok)return null;
    var d=await r.json();
    if(d&&d.leaders&&d.leaders.length>0)return d;
  }catch(e){console.warn('Cloud pull:',e)}
  return null;
}
/* Bulutga ma'lumot yuklash */
async function cloudPush(){
  var url=_getCloudUrl();if(!url)return;
  try{
    await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(D)});
    console.log('â˜ Cloud push OK');
  }catch(e){console.warn('Cloud push:',e)}
}
function fL(id){return D.leaders.find(function(l){return l.id===id})}
function fDp(lid,did){var l=fL(lid);return l?l.departments.find(function(d){return d.id===did}):null}
function fDb(lid,did,dbid){var d=fDp(lid,did);return d?d.dashboards.find(function(b){return b.id===dbid}):null}
function cD(l){return l.departments.length}
function cDb(l){return l.departments.reduce(function(s,d){return s+d.dashboards.length},0)}
function cXl(l){return l.departments.reduce(function(s,d){return s+d.dashboards.filter(function(b){return b.xl}).length},0)}

/* â”€â”€ THEME â€” har tema uchun glow ranglari dinamik yangilanadi â”€â”€ */
function setTheme(t){
  document.body.setAttribute('data-theme',t);
  document.querySelectorAll('.tp').forEach(function(p){p.classList.toggle('on',p.dataset.t===t)});
  var colors={cyber:['#FF2E97','#00F0FF','#A855F7'],aurora:['#6366F1','#06B6D4','#F43F5E'],teal:['#00E5FF','#00BCD4','#7C4DFF'],sakura:['#F472B6','#E879F9','#C084FC']};
  var c=colors[t]||colors.cyber;
  ['mb1','mb2','mb3'].forEach(function(id,i){var el=document.getElementById(id);if(el)el.setAttribute('fill',c[i])});
  try{localStorage.setItem('cbNT',t)}catch(e){}}
function makePts(){var c=$('particles');c.innerHTML='';for(var i=0;i<12;i++){var d=document.createElement('div');d.className='pt';d.style.left=Math.random()*100+'%';d.style.width=d.style.height=(1.5+Math.random()*3)+'px';d.style.animationDuration=(20+Math.random()*18)+'s';d.style.animationDelay=(-Math.random()*22)+'s';c.appendChild(d)}}
function animN(el,target){var cur=0,step=Math.max(1,Math.ceil(target/20));var iv=setInterval(function(){cur=Math.min(cur+step,target);el.textContent=cur;if(cur>=target)clearInterval(iv)},30)}

/* â”€â”€ NAVIGATION â”€â”€ */
var _curView='home';
function go(v,p){p=p||{};_curView=v;document.querySelectorAll('.view').forEach(function(x){x.classList.remove('on')});document.querySelectorAll('.ni').forEach(function(n){n.classList.remove('on')});
  if(v==='home'){$('vHome').classList.add('on');$('navH').classList.add('on');renderHome();setCr([{l:'Bosh sahifa',v:'home'}])}
  else if(v==='meetings'){$('vMeet').classList.add('on');$('navM').classList.add('on');renderMeetings2();setCr([{l:'Bosh sahifa',v:'home'},{l:'Uchrashuvlar',cur:1}])}
  else if(v==='contacts'){$('vContacts').classList.add('on');$('navC').classList.add('on');renderContacts();setCr([{l:'Bosh sahifa',v:'home'},{l:'Kontaktlar',cur:1}])}
  else if(v==='leader'){$('vLeader').classList.add('on');renderLeader(p.lid);var le=fL(p.lid);setCr([{l:'Bosh sahifa',v:'home'},{l:le?le.name:'',cur:1}])}
  else if(v==='dept'){$('vDept').classList.add('on');renderDept(p.lid,p.did);var l2=fL(p.lid),dp=fDp(p.lid,p.did);setCr([{l:'Bosh sahifa',v:'home'},{l:l2?l2.name:'',v:'leader',p:{lid:p.lid}},{l:dp?dp.name.slice(0,26)+'â€¦':'',cur:1}])}
  else if(v==='dashboard'){$('vDash').classList.add('on');renderDash(p.lid,p.did,p.dbid);var l3=fL(p.lid),dp3=fDp(p.lid,p.did),db=fDb(p.lid,p.did,p.dbid);setCr([{l:'Bosh sahifa',v:'home'},{l:l3?l3.name:'',v:'leader',p:{lid:p.lid}},{l:dp3?dp3.name.slice(0,18)+'â€¦':'',v:'dept',p:{lid:p.lid,did:p.did}},{l:db?db.name:'',cur:1}])}
  lucide.createIcons()}
function setCr(items){var c=$('crumbs');c.innerHTML=items.map(function(it,i){var sep=i?'<span class="crumb-sep">â€º</span>':'';if(it.cur)return sep+'<span class="crumb crumb-cur">'+it.l+'</span>';return sep+'<span class="crumb" data-ci="'+i+'">'+it.l+'</span>'}).join('');c.querySelectorAll('.crumb:not(.crumb-cur)').forEach(function(el){var i=+el.dataset.ci,it=items[i];if(it)el.onclick=function(){go(it.v,it.p||{})}})}

/* â”€â”€ RENDER HOME â€” gradient ranglarni har temaga moslash â”€â”€ */
function renderHome(){
  var grads=['var(--g1)','var(--g2)','var(--g3)','var(--g4)'];
  $('hSub').textContent=D.leaders.length+' ta rahbar Â· '+D.leaders.reduce(function(s,l){return s+cDb(l)},0)+' dashboard';
  $('leadersGrid').innerHTML=D.leaders.map(function(l,i){
    var tags=l.departments.slice(0,3).map(function(d){return '<span class="ltag">'+d.name.split(/[\s,]+/).slice(0,2).join(' ')+'</span>'}).join('');
    return '<div class="lc" style="--i:'+i+'" onclick="go(\'leader\',{lid:\''+l.id+'\'})"><div class="lc-bar" style="background:'+grads[i%4]+'"></div><div class="lc-body"><div class="lc-head"><div class="lc-ava" style="background:'+grads[i%4]+'">'+l.ini+'</div><div><div class="lc-name">'+l.name+'</div><div class="lc-role">'+l.role+'</div></div></div><div class="lc-stats"><div class="st"><div class="st-n" data-t="'+cD(l)+'">0</div><div class="st-l">Bo\'lim</div></div><div class="st"><div class="st-n" data-t="'+cDb(l)+'">0</div><div class="st-l">Dashboard</div></div><div class="st"><div class="st-n" data-t="'+cXl(l)+'">0</div><div class="st-l">Excel</div></div></div><div class="lc-tags">'+tags+'</div></div></div>'}).join('');
  setTimeout(function(){document.querySelectorAll('.st-n').forEach(function(el){animN(el,+el.dataset.t||0)})},400);
  renderMeetings()}

/* â”€â”€ MEETINGS â€” tahrirlash / o'chirish â”€â”€ */
function meetHTML(m){if(!m||!m.length)return '<div style="text-align:center;padding:22px;color:var(--t2)">Uchrashuvlar yo\'q</div>';return m.map(function(m){return '<div class="mc"><div class="mc-time"><div class="mc-d">'+m.day+'</div><div class="mc-m">'+m.month+'</div><div class="mc-hr">'+m.time+'</div></div><div class="mc-info"><div class="mc-title">'+m.title+'</div><div class="mc-who"><svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>'+m.who+'</div><span class="mbdg '+m.urgency+'">'+(m.urgency==='urgent'?'Muhim':m.urgency==='done'?'Bajarildi':'Oddiy')+'</span>'+(m.location?'<div style="font-size:9px;color:var(--t2);margin-top:2px"><i data-lucide="map-pin" style="width:9px;height:9px;display:inline"></i> '+m.location+'</div>':'')+'<div class="mc-acts"><button class="me" onclick="event.stopPropagation();editMeet(\''+m.id+'\')"><svg xmlns="http://www.w3.org/2000/svg" width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>Tahrir</button><button class="me" style="background:linear-gradient(135deg,#0088cc,#00aced);color:#fff;border-color:#0088cc" onclick="event.stopPropagation();sendTgMeet(\''+m.id+'\')">âœˆ TG</button><button class="md" onclick="event.stopPropagation();delMeet(\''+m.id+'\')"><svg xmlns="http://www.w3.org/2000/svg" width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>O\'ch</button></div></div></div>'}).join('')}
function renderMeetings(){$('meetGrid').innerHTML=meetHTML(D.meetings?D.meetings.slice(0,4):[])}
function renderMeetings2(){$('meetGrid2').innerHTML=meetHTML(D.meetings||[])}
function _refreshMeet(){renderMeetings();if($('vMeet').classList.contains('on'))renderMeetings2();lucide.createIcons()}

/* â•â•â• UCHRASHUV TAHRIR MODALI â•â•â• */
function openMeetModal(m){
  var isNew=!m;
  m=m||{id:'m_'+Date.now(),day:1,month:'Fev',time:'10:00',title:'',who:'',urgency:'normal',location:'',note:''};
  var overlay=document.createElement('div');overlay.className='meetModal';
  overlay.innerHTML='<div class="meetModal-box">'
    +'<h3><i data-lucide="calendar-clock" style="width:18px;height:18px"></i> '+(isNew?'Yangi uchrashuv':'Uchrashuvni tahrirlash')+'</h3>'
    +'<div class="mf-row">'
    +'<div class="mf-full"><label>Uchrashuv nomi</label><input id="mfTitle" value="'+(m.title||'').replace(/"/g,'&quot;')+'"></div>'
    +'</div>'
    +'<div class="mf-row">'
    +'<div><label>Kun</label><input id="mfDay" type="number" min="1" max="31" value="'+(m.day||1)+'"></div>'
    +'<div><label>Oy</label><select id="mfMonth"><option value="Yan"'+(m.month==='Yan'?' selected':'')+'>Yanvar</option><option value="Fev"'+(m.month==='Fev'?' selected':'')+'>Fevral</option><option value="Mar"'+(m.month==='Mar'?' selected':'')+'>Mart</option><option value="Apr"'+(m.month==='Apr'?' selected':'')+'>Aprel</option><option value="May"'+(m.month==='May'?' selected':'')+'>May</option><option value="Iyn"'+(m.month==='Iyn'?' selected':'')+'>Iyun</option><option value="Iyl"'+(m.month==='Iyl'?' selected':'')+'>Iyul</option><option value="Avg"'+(m.month==='Avg'?' selected':'')+'>Avgust</option><option value="Sen"'+(m.month==='Sen'?' selected':'')+'>Sentyabr</option><option value="Okt"'+(m.month==='Okt'?' selected':'')+'>Oktyabr</option><option value="Noy"'+(m.month==='Noy'?' selected':'')+'>Noyabr</option><option value="Dek"'+(m.month==='Dek'?' selected':'')+'>Dekabr</option></select></div>'
    +'</div>'
    +'<div class="mf-row">'
    +'<div><label>Vaqt</label><input id="mfTime" type="time" value="'+(m.time||'10:00')+'"></div>'
    +'<div><label>Holat</label><select id="mfUrg"><option value="normal"'+(m.urgency==='normal'?' selected':'')+'>Oddiy</option><option value="urgent"'+(m.urgency==='urgent'?' selected':'')+'>Muhim</option><option value="done"'+(m.urgency==='done'?' selected':'')+'>Bajarildi</option></select></div>'
    +'</div>'
    +'<div class="mf-row">'
    +'<div class="mf-full"><label>Qatnashchilar</label><input id="mfWho" value="'+(m.who||'').replace(/"/g,'&quot;')+'"></div>'
    +'</div>'
    +'<div class="mf-row">'
    +'<div class="mf-full"><label>Joyi</label><input id="mfLoc" value="'+(m.location||'').replace(/"/g,'&quot;')+'" placeholder="Masalan: 3-qavat, yig\'ilish zali"></div>'
    +'</div>'
    +'<div class="mf-row">'
    +'<div class="mf-full"><label>Izoh</label><textarea id="mfNote" placeholder="Qo\'shimcha ma\'lumot...">'+(m.note||'')+'</textarea></div>'
    +'</div>'
    +'<div class="mf-acts">'
    +'<button class="mf-cancel" onclick="this.closest(\'.meetModal\').remove()">Bekor</button>'
    +'<button class="mf-tg" onclick="sendTgFromModal(\''+m.id+'\')">âœˆ Telegram</button>'
    +'<button class="mf-save" id="mfSaveBtn">'+(isNew?"Qo'shish":'Saqlash')+'</button>'
    +'</div></div>';
  document.body.appendChild(overlay);
  overlay.addEventListener('click',function(e){if(e.target===overlay)overlay.remove()});
  lucide.createIcons();
  /* Saqlash */
  $('mfSaveBtn').onclick=function(){
    var t=$('mfTitle').value.trim();if(!t){toast('Nom kiriting','nf');return}
    m.title=t;m.day=+$('mfDay').value||1;m.month=$('mfMonth').value;
    m.time=$('mfTime').value||'10:00';m.urgency=$('mfUrg').value;
    m.who=$('mfWho').value;m.location=$('mfLoc').value;m.note=$('mfNote').value;
    if(isNew){if(!D.meetings)D.meetings=[];D.meetings.push(m)}
    save();_refreshMeet();overlay.remove();toast(isNew?"Qo'shildi!":'Yangilandi','ok');
  };
}
window.editMeet=function(id){if(!D.meetings)return;var m=D.meetings.find(function(x){return x.id===id});if(m)openMeetModal(m)};
function addMeet(){openMeetModal(null)}
window.delMeet=function(id){if(!confirm("O'chirasizmi?"))return;D.meetings=D.meetings.filter(function(x){return x.id!==id});save();_refreshMeet();toast("O'chirildi",'nf')};

/* â•â•â• TELEGRAM ESLATMA â•â•â• */
window.setTgLink=function(){
  var cur=D._tgLink||'';
  var link=prompt('Telegram guruh havolasini kiriting:\n\nMasalan:\nhttps://t.me/guruh_nomi\nhttps://t.me/+AbCdEf123\n\nBot API uchun:\nhttps://api.telegram.org/botTOKEN/sendMessage?chat_id=CHAT_ID',cur);
  if(link===null)return;D._tgLink=link.trim();save();toast(link?'Telegram havola saqlandi':'Telegram havola o\'chirildi','ok');
};
window.sendTgMeet=function(id){
  if(!D.meetings)return;var m=D.meetings.find(function(x){return x.id===id});if(!m)return;
  var text='ğŸ“… *UCHRASHUV ESLATMASI*\n\n'
    +'ğŸ“Œ *'+m.title+'*\n'
    +'ğŸ—“ '+m.day+' '+m.month+', â° '+m.time+'\n'
    +'ğŸ‘¥ '+m.who+'\n'
    +(m.location?'ğŸ“ '+m.location+'\n':'')
    +(m.note?'ğŸ’¬ '+m.note+'\n':'')
    +'\nâš¡ Holat: '+(m.urgency==='urgent'?'ğŸ”´ Muhim':m.urgency==='done'?'âœ… Bajarildi':'ğŸ”µ Oddiy');
  if(D._tgLink&&D._tgLink.startsWith('https://api.telegram.org')){
    /* Bot API */
    var url=D._tgLink;
    if(url.indexOf('sendMessage')>=0){
      var sep=url.indexOf('?')>=0?'&':'?';
      url+=sep+'text='+encodeURIComponent(text)+'&parse_mode=Markdown';
      fetch(url).then(function(r){return r.json()}).then(function(d){
        if(d.ok)toast('âœˆ Telegram ga yuborildi!','ok');else toast('Xato: '+d.description,'nf');
      }).catch(function(){toast('Tarmoq xatosi','nf')});
      return;
    }
  }
  /* Oddiy Telegram share */
  var shareUrl='https://t.me/share/url?url='+encodeURIComponent(m.title)+'&text='+encodeURIComponent(text);
  window.open(shareUrl,'_blank');
};
window.sendTgFromModal=function(id){
  /* Modal dan saqlash, keyin yuborish */
  var t=$('mfTitle');if(t&&t.value.trim()){
    $('mfSaveBtn').click();
    setTimeout(function(){sendTgMeet(id)},300);
  }else{sendTgMeet(id)}
};

/* â•â•â• KONTAKTLAR PANELI â•â•â• */
var dfltContacts=[
  {id:'c1',name:"J.X.Fayzullaxo'jayev",role:"Bosh boshqarma boshlig'i",phone:'+998901234567',ci:0},
  {id:'c2',name:"B.F.Nuraliyev",role:"O'rinbosar",phone:'+998901234568',ci:1},
  {id:'c3',name:"I.R.Irgashev",role:"O'rinbosar",phone:'+998901234569',ci:2},
  {id:'c4',name:"A.A.Jurayev",role:"O'rinbosar",phone:'+998901234570',ci:3},
  {id:'c5',name:"S.T.Abdullayev",role:"Bank xizmatlari shu'basi boshlig'i",phone:'+998901234571',ci:0},
  {id:'c6',name:"M.N.Toshmatov",role:"Ijro apparati boshlig'i",phone:'+998901234572',ci:1},
  {id:'c7',name:"R.S.Karimov",role:"Valyuta nazorati bo'limi boshlig'i",phone:'+998901234573',ci:2},
  {id:'c8',name:"N.O.Mirzayev",role:"Moliyaviy tahlil bo'limi boshlig'i",phone:'+998901234574',ci:3},
  {id:'c9',name:"L.M.Qodirov",role:"Hududlar monitoringi bo'limi boshlig'i",phone:'+998901234575',ci:0},
  {id:'c10',name:"Sh.U.Nazarov",role:"Tadbirkorlik bo'limi boshlig'i",phone:'+998901234576',ci:1},
  {id:'c11',name:"G.H.Tursunov",role:"Naqd pul boshqarmasi boshlig'i",phone:'+998901234577',ci:2},
  {id:'c12',name:"V.A.Ismoilov",role:"IT bo'limi boshlig'i",phone:'+998901234578',ci:3}
];
function getContacts(){if(!D._contacts||!D._contacts.length)D._contacts=dfltContacts;return D._contacts}
var _cColors=['var(--ac)','#f472b6','#38bdf8','#a78bfa','#fb923c','#34d399'];
function renderContacts(){
  var contacts=getContacts();
  $('cntGrid').innerHTML=contacts.map(function(c){
    var ini=c.name.split(/[\s.]+/).filter(function(w){return w.length>1}).map(function(w){return w[0]}).join('').slice(0,2).toUpperCase();
    var clr=_cColors[c.ci%_cColors.length]||'var(--ac)';
    return '<div class="cnt-card" onclick="callContact(\''+c.id+'\')">'
      +'<div class="cnt-ava" style="background:'+clr+'">'+ini+'</div>'
      +'<div class="cnt-info"><div class="cnt-name">'+c.name+'</div><div class="cnt-role">'+c.role+'</div><div class="cnt-phone">ğŸ“ '+c.phone+'</div></div>'
      +'<button class="cnt-call" onclick="event.stopPropagation();callContact(\''+c.id+'\')" title="Qo\'ng\'iroq"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg></button>'
      +'<button class="cnt-call" style="background:var(--ac);margin-left:-6px" onclick="event.stopPropagation();editContact(\''+c.id+'\')" title="Tahrir"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg></button>'
      +'</div>';
  }).join('');
}
window.callContact=function(id){
  var contacts=getContacts();var c=contacts.find(function(x){return x.id===id});
  if(!c)return;window.open('tel:'+c.phone.replace(/\s/g,''));
};
window.editContact=function(id){
  var contacts=getContacts();var c=contacts.find(function(x){return x.id===id});
  if(!c)return;
  var n=prompt('Ism:',c.name);if(!n||!n.trim())return;
  var r=prompt('Lavozimi:',c.role);
  var p=prompt('Telefon raqami:',c.phone);
  c.name=n.trim();c.role=r||c.role;c.phone=p||c.phone;
  save();renderContacts();toast('Yangilandi','ok');
};
window.addContact=function(){
  var n=prompt('Ism:');if(!n||!n.trim())return;
  var r=prompt('Lavozimi:','');
  var p=prompt('Telefon raqami:','+998');
  var contacts=getContacts();
  contacts.push({id:'c_'+Date.now(),name:n.trim(),role:r||'',phone:p||'',ci:contacts.length%6});
  save();renderContacts();toast("Qo'shildi!",'ok');
};

/* â”€â”€ RENDER LEADER / DEPT / DASHBOARD â”€â”€ */
function renderLeader(lid){var l=fL(lid);if(!l)return;$('lTitle').textContent=l.name;$('lSub').textContent=l.role+' â€” '+cD(l)+' bo\'lim, '+cDb(l)+' dashboard';var ic=['landmark','building-2','briefcase','bar-chart-big','search','file-text','wallet','graduation-cap'],cls=['c1','c2','c3','c1','c2','c3'];$('deptGrid').innerHTML=l.departments.map(function(d,i){var n=d.dashboards.length;var bossHtml=d.boss?'<div style="margin-top:6px;font-size:11px;color:var(--ac);display:flex;align-items:center;gap:4px"><i data-lucide="user-circle" style="width:13px;height:13px"></i> <b>'+d.boss+'</b>'+(d.bossRole?' <span style="color:var(--t2);font-weight:400">â€” '+d.bossRole+'</span>':'')+'</div>':'';return '<div class="dc" style="--i:'+i+'" onclick="go(\'dept\',{lid:\''+lid+'\',did:\''+d.id+'\'})"><div class="dc-ico '+cls[i%cls.length]+'"><i data-lucide="'+ic[i%ic.length]+'"></i></div><h4>'+d.name+'</h4>'+bossHtml+'<div style="margin-top:8px">'+(n?'<span class="badge badge-ok">âœ“ '+n+' dashboard</span>':'<span class="badge badge-mt">Bo\'sh</span>')+'</div></div>'}).join('')}
function renderDept(lid,did){var l=fL(lid),d=fDp(lid,did);if(!l||!d)return;$('dTitle').textContent=d.name;$('dSub').textContent=l.name+(d.boss?' â€¢ '+d.boss+(d.bossRole?' â€” '+d.bossRole:''):'');$('deptBk').onclick=function(){go('leader',{lid:lid})};var gr=$('dashGrid'),em=$('dEmpty');if(!d.dashboards.length){gr.innerHTML='<div class="dc" style="--i:0;border:2px dashed var(--brd2);cursor:pointer;display:flex;align-items:center;justify-content:center;min-height:120px" onclick="openAddDash(\''+lid+'\',\''+did+'\')"><div style="text-align:center;color:var(--t2)"><div style="font-size:28px;margin-bottom:6px">â•</div><div style="font-size:12px;font-weight:600">Yangi dashboard</div></div></div>';em.style.display='none';lucide.createIcons();return}em.style.display='none';gr.innerHTML=d.dashboards.map(function(db,i){var badges=[];if(db.type==='url')badges.push('<span class="badge badge-html">ğŸ”— URL</span>');else if(db.type==='excel')badges.push('<span class="badge badge-xl">ğŸ“Š Excel</span>');else badges.push('<span class="badge badge-html">HTML</span>');if(db.xl)badges.push('<span class="badge badge-xl">+Excel</span>');return '<div class="dc" style="--i:'+i+'" onclick="go(\'dashboard\',{lid:\''+lid+'\',did:\''+did+'\',dbid:\''+db.id+'\'})"><div class="dc-ico '+(db.type==='excel'?'c2':'c1')+'"><i data-lucide="'+(db.type==='excel'?'table':'layout-dashboard')+'"></i></div><h4>'+db.name+'</h4><div class="meta" style="margin-top:8px">'+badges.join('')+'</div></div>'}).join('')+'<div class="dc" style="--i:'+d.dashboards.length+';border:2px dashed var(--brd2);cursor:pointer;display:flex;align-items:center;justify-content:center;min-height:120px" onclick="openAddDash(\''+lid+'\',\''+did+'\')"><div style="text-align:center;color:var(--t2)"><div style="font-size:28px;margin-bottom:6px">â•</div><div style="font-size:12px;font-weight:600">Yangi dashboard</div></div></div>'}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Dashboard YUKLASH TIZIMI v4 â€” MULTI-TRY + SMART ENCODING
   file:// protokolida yo'l nomlari muammo bo'ladi:
   - Apostrof: yo'nalishi â†’ yo%27nalishi
   - Bo'shliq: export import â†’ export%20import  
   - Kirill: Ğ¼ÑƒÑ€Ğ¾Ğ¶Ğ°Ğ°Ñ‚Ğ»Ğ°Ñ€ â†’ %D0%BC%D1%83%D1%80...
   Har bir usul uchun 5 ta yo'l varianti sinab ko'riladi
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Yo'lning 5 xil kodlash variantlarini yaratish */
function pathVariants(origPath){
  if(!origPath)return [];
  /* blob: va http URL lar to'g'ridan-to'g'ri */
  if(origPath.startsWith('http')||origPath.startsWith('blob:')||origPath.startsWith('data:'))return [origPath];
  var variants=[origPath]; /* 1: asl yo'l */
  /* 2: har segment alohida encode */
  var enc2=origPath.split('/').map(function(s){return encodeURIComponent(s)}).join('/');
  if(enc2!==origPath)variants.push(enc2);
  /* 3: faqat bo'shliq â†’ %20 */
  var enc3=origPath.replace(/ /g,'%20');
  if(enc3!==origPath&&variants.indexOf(enc3)<0)variants.push(enc3);
  /* 4: bo'shliq + apostrof */
  var enc4=origPath.replace(/ /g,'%20').replace(/'/g,'%27');
  if(variants.indexOf(enc4)<0)variants.push(enc4);
  /* 5: segment-wise bo'shliq+apostrof+kirill */
  var enc5=origPath.split('/').map(function(s){
    return s.replace(/ /g,'%20').replace(/'/g,'%27').replace(/[^\x00-\x7F]/g,function(c){
      return encodeURIComponent(c);
    });
  }).join('/');
  if(variants.indexOf(enc5)<0)variants.push(enc5);
  return variants;
}

/* XHR o'qish â€” text yoki arraybuffer */
function xhrLoad(path, type){
  return new Promise(function(resolve,reject){
    var xhr=new XMLHttpRequest();
    xhr.open('GET',path,true);
    xhr.responseType=type||'text';
    xhr.timeout=8000;
    xhr.onload=function(){
      if(xhr.status===0||xhr.status===200){
        if(type==='arraybuffer'){
          if(xhr.response&&xhr.response.byteLength>0)resolve(xhr.response);
          else reject(new Error('Bo\'sh arraybuffer'));
        }else{
          resolve(xhr.responseText);
        }
      }else reject(new Error('HTTP '+xhr.status));
    };
    xhr.onerror=function(){reject(new Error('XHR xato'))};
    xhr.ontimeout=function(){reject(new Error('Timeout'))};
    xhr.send();
  });
}

/* 5 ta yo'l variant bilan XHR sinash */
async function smartLoad(origPath, type){
  var paths=pathVariants(origPath);
  for(var i=0;i<paths.length;i++){
    try{
      var result=await xhrLoad(paths[i],type);
      return result;
    }catch(e){/* keyingisini sinash */}
  }
  /* Hammasi ishlamadi â€” fetch sinash */
  for(var j=0;j<paths.length;j++){
    try{
      var r=await fetch(paths[j]);
      if(!r.ok)continue;
      if(type==='arraybuffer')return await r.arrayBuffer();
      return await r.text();
    }catch(e){/* keyingisi */}
  }
  throw new Error('Fayl topilmadi: '+origPath);
}

/* HTML kontentga <base> tag qo'shish */
function addBaseTag(html,filePath){
  var dir=filePath.substring(0,filePath.lastIndexOf('/')+1);
  if(!dir)return html;
  if(html.match(/<head[^>]*>/i)){
    return html.replace(/<head([^>]*)>/i,'<head$1>\n<base href="'+dir+'">');
  }
  if(html.match(/<html[^>]*>/i)){
    return html.replace(/<html([^>]*)>/i,'<html$1>\n<head><base href="'+dir+'"></head>');
  }
  return '<base href="'+dir+'">\n'+html;
}

/* â•â•â• EXCEL â†’ HTML EMBED (v16c) â•â•â•
   Base64 ni TO'G'RIDAN-TO'G'RI HTML ichiga joylaydi.
   postMessage yo'q, cross-origin muammo yo'q, tez ishlaydi.
   
   Uint8Array (838KB) â†’ base64 string (1.1MB) â†’ HTML ichidagi
   <script> blokda o'zgaruvchi sifatida saqlanadi.
   Iframe yuklangach, XLSX kutadi, keyin inject qiladi.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function embedExcelInHtml(html,xlData,xlName){
  if(!xlData||!html)return html;
  if(html.indexOf('__XLEMBED__')>=0)return html;

  /* Uint8Array â†’ base64 (chunked â€” stack overflow oldini olish) */
  var raw='',cs=8192;
  for(var i=0;i<xlData.length;i+=cs){
    var end=Math.min(i+cs,xlData.length);
    var s='';for(var j=i;j<end;j++)s+=String.fromCharCode(xlData[j]);
    raw+=s;
  }
  var b64=btoa(raw);
  var nm=(xlName||'data.xlsx').replace(/\\/g,'\\\\').replace(/'/g,"\\'");

  var sc='\n<scr'+'ipt>\n'
  +'/* __XLEMBED__ */\n'
  +'(function(){\n'
  +'var _D=false,_B="'+b64+'";\n'
  +'var _N="'+nm+'";\n'
  +'function dec(){var r=atob(_B),a=new Uint8Array(r.length);for(var i=0;i<r.length;i++)a[i]=r.charCodeAt(i);return a}\n'
  +'function go(){\n'
  +'  if(_D)return;_D=true;\n'
  +'  var arr=dec();\n'
  +'  var mt=_N.match(/\\.xls$/i)?"application/vnd.ms-excel":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";\n'
  +'  var file;\n'
  +'  try{file=new File([arr],_N,{type:mt})}catch(e){file=new Blob([arr],{type:mt});file.name=_N}\n'
  +'  if(typeof handleFile==="function"){try{handleFile(file);return}catch(e){}}\n'
  +'  if(typeof handleFileUpload==="function"){try{handleFileUpload({target:{files:[file]}});return}catch(e){}}\n'
  +'  if(typeof processExcelFile==="function"&&typeof XLSX!=="undefined"){try{processExcelFile(XLSX.read(arr,{type:"array"}),_N);return}catch(e){}}\n'
  +'  var fi=document.getElementById("fileInput");\n'
  +'  if(fi){try{var dt=new DataTransfer();dt.items.add(file);fi.files=dt.files;fi.dispatchEvent(new Event("change",{bubbles:true}));return}catch(e){}}\n'
  +'  var all=document.querySelectorAll("input[type=file]");\n'
  +'  for(var i=0;i<all.length;i++){try{var d=new DataTransfer();d.items.add(file);all[i].files=d.files;all[i].dispatchEvent(new Event("change",{bubbles:true}));return}catch(e){}}\n'
  +'  _D=false;\n'
  +'}\n'
  +'function wait(){if(typeof XLSX!=="undefined"){go()}else{setTimeout(wait,300)}}\n'
  +'setTimeout(wait,800);\n'
  +'})();\n'
  +'</scr'+'ipt>\n';

  if(html.indexOf('</body>')>=0)return html.replace('</body>',sc+'</body>');
  if(html.indexOf('</html>')>=0)return html.replace('</html>',sc+'</html>');
  return html+sc;
}

async function renderDash(lid,did,dbid){
  var db=fDb(lid,did,dbid);if(!db)return;
  _curDb={lid:lid,did:did,dbid:dbid};
  $('dbTit').textContent=db.name;
  $('dashBk').onclick=function(){go('dept',{lid:lid,did:did})};
  var fr=$('dbFrame'),xv=$('xlView'),ve=$('vErr'),ed=$('dbEdit');
  ve.style.display='none';ed.classList.remove('on');
  fr.style.display='none';xv.style.display='none';
  fr.removeAttribute('srcdoc');fr.removeAttribute('src');
  $('deNm').value=db.name||'';$('deTy').value=db.type||'html';
  $('dePth').value=db.path||'';$('deXl').value=db.xl||'';

  /* Tab tugmalari */
  var tabs=$('dbTabs');
  if(db.xl&&db.type!=='excel'){
    tabs.innerHTML='<button class="vb vb-ac" id="tabHtml" onclick="switchDbTab(\'html\')"><i data-lucide="layout-dashboard" style="width:12px;height:12px"></i> HTML</button><button class="vb" id="tabXl" onclick="switchDbTab(\'excel\')"><i data-lucide="table" style="width:12px;height:12px"></i> Excel</button>';
    tabs.style.display='flex';
  }else{tabs.innerHTML='';tabs.style.display='none'}

  /* â•â•â• 1-QADAM: EXCEL MA'LUMOTLARINI OLDINDAN TAYYORLASH â•â•â• */
  var xlData=null,xlName='data.xlsx';
  var xlPath=db.xl||(db.type==='excel'?db.path:null);
  if(xlPath){
    xlName=xlPath.split('/').pop()||'data.xlsx';
    /* 1a: Sessiya kesh */
    if(db._xlCache){xlData=db._xlCache}
    /* 1b: Global kesh (ZIP/papka) */
    else if(_FCready){
      var xlC=fromCache(xlPath);
      if(xlC&&xlC.type==='binary'){xlData=xlC.data;db._xlCache=xlData}
    }
    /* 1c: SmartLoad (XHR/fetch) */
    if(!xlData){
      try{
        var ab=await smartLoad(xlPath,'arraybuffer');
        xlData=new Uint8Array(ab);db._xlCache=xlData;
      }catch(e){/* keyin fallback */}
    }
  }

  /* â•â•â• 2-QADAM: DASHBOARD TURINI KO'RSATISH â•â•â• */
  if(db.type==='url'){
    fr.style.display='';fr.src=db.path;
  }else if(db.type==='excel'){
    xv.style.display='';
    if(xlData){renderXlData(xlData,xv)}
    else{await loadXl(xlPath,xv)}
  }else{
    /* â•â•â• HTML DASHBOARD â•â•â• */
    fr.style.display='';
    var htmlContent=null;

    /* HTML kontentni olish */
    if(db._htmlCache){
      htmlContent=db._htmlCache;
    }else if(_FCready){
      var cached=fromCache(db.path);
      if(cached&&cached.type==='text')htmlContent=cached.data;
    }
    if(!htmlContent){
      try{htmlContent=await smartLoad(db.path,'text')}catch(e){}
    }

    if(htmlContent&&htmlContent.trim().length>10){
      var finalHtml=addBaseTag(htmlContent,db.path);
      if(xlData)finalHtml=embedExcelInHtml(finalHtml,xlData,xlName);
      fr.srcdoc=finalHtml;
    }else{
      fr.src=db.path;
      fr.onload=function(){
        try{
          var doc=fr.contentDocument;if(!doc||!doc.body)return;
          var pre=doc.querySelector('pre');
          var bt=doc.body.textContent||'';
          if((pre&&pre.textContent.trim().startsWith('<!'))
            ||(bt.trim().startsWith('<!DOCTYPE')||bt.trim().startsWith('<html'))){
            fr.onload=null;
            var rawH=addBaseTag(pre?pre.textContent:bt,db.path);
            if(xlData)rawH=embedExcelInHtml(rawH,xlData,xlName);
            fr.srcdoc=rawH;
          }
        }catch(e){}
      };
    }

    /* â•â•â• PARENT EXCEL TAB â•â•â• */
    if(xlData&&db.xl){
      renderXlData(xlData,xv);
    }else if(db.xl){
      await loadXl(db.xl,xv);
    }
  }
  lucide.createIcons();
}

/* Tab almashish */
window.switchDbTab=function(tab){
  var fr=$('dbFrame'),xv=$('xlView'),th=$('tabHtml'),tx=$('tabXl');
  if(tab==='html'){
    fr.style.display='';xv.style.display='none';
    if(th)th.classList.add('vb-ac');if(tx)tx.classList.remove('vb-ac');
  }else{
    fr.style.display='none';xv.style.display='';
    if(th)th.classList.remove('vb-ac');if(tx)tx.classList.add('vb-ac');
    var db=fDb(_curDb.lid,_curDb.did,_curDb.dbid);
    if(db&&db._xlCache){
      renderXlData(db._xlCache,xv);
    }else if(db&&db.xl&&(!xv.innerHTML||xv.innerHTML.includes('Yuklanmoqda'))){
      loadXl(db.xl,xv);
    }
  }
};

/* â•â•â• EXCEL YUKLASH â€” kesh â†’ smartLoad â†’ fallback â•â•â• */
async function loadXl(path,ct){
  ct.innerHTML='<div style="text-align:center;padding:36px;color:var(--t2)"><div style="font-size:28px;margin-bottom:8px">ğŸ“Š</div>Excel yuklanmoqda...</div>';

  /* 1: GLOBAL KESHDAN (_FC â€” ZIP/papkadan) */
  if(_FCready){
    var cached=fromCache(path);
    if(cached&&cached.type==='binary'){
      renderXlData(cached.data,ct);
      var db=fDb(_curDb.lid,_curDb.did,_curDb.dbid);
      if(db)db._xlCache=cached.data;
      return;
    }
  }

  /* 2: smartLoad â€” XHR + fetch bilan 5x variant */
  try{
    var ab=await smartLoad(path,'arraybuffer');
    var data=new Uint8Array(ab);
    renderXlData(data,ct);
    var db2=fDb(_curDb.lid,_curDb.did,_curDb.dbid);
    if(db2)db2._xlCache=data;
  }catch(e){
    /* 3: Hech narsa ishlamadi â€” fayl tanlash tugmalari */
    ct.innerHTML='<div class="empty" style="padding:30px"><h3>ğŸ“Š Excel faylni yuklang</h3>'
      +'<p style="color:var(--t2);font-size:12px;margin:8px 0">Avtomatik yuklanmadi.</p>'
      +'<p style="color:var(--t2);font-size:11px;margin-bottom:4px">ğŸ’¡ <b>Maslahat:</b> Bosh sahifada "ğŸ“¦ ZIP tanlash" tugmasini bosib, loyiha ZIP faylini yuklang â€” keyin barcha Excel fayllar avtomatik ishlaydi.</p>'
      +'<p style="font-size:10px;color:var(--t3);margin-bottom:16px;word-break:break-all">'+path+'</p>'
      +'<button class="btn btn-p" onclick="pickExcel(this.closest(\'.xlv\'))" style="margin-right:8px">ğŸ“ Excel tanlash</button>'
      +'<button class="btn btn-s" onclick="pickExcelZip(this.closest(\'.xlv\'))">ğŸ“¦ ZIP dan</button></div>';
  }
}
function renderXlData(ab,ct){
  var wb=XLSX.read(ab,{type:'array'});
  var h='<div style="display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap">';
  wb.SheetNames.forEach(function(n,i){h+='<button class="btn btn-sm '+(i?'btn-s':'btn-p')+'" onclick="showSh(this,'+i+')">'+n+'</button>'});
  h+='</div>';
  wb.SheetNames.forEach(function(n,i){h+='<div class="shc" style="'+(i?'display:none':'')+'">'+XLSX.utils.sheet_to_html(wb.Sheets[n])+'</div>'});
  ct.innerHTML=h;
}
/* Excel faylni qo'lda tanlash */
window.pickExcel=function(container){
  var inp=document.createElement('input');inp.type='file';
  inp.accept='.xlsx,.xls';
  inp.onchange=function(){
    if(!inp.files||!inp.files[0])return;
    var reader=new FileReader();
    reader.onload=function(e){
      var data=new Uint8Array(e.target.result);
      renderXlData(data,container);
      /* Keshga saqlash */
      var db=fDb(_curDb.lid,_curDb.did,_curDb.dbid);
      if(db)db._xlCache=data;
      toast(inp.files[0].name+' yuklandi!','ok');
    };
    reader.readAsArrayBuffer(inp.files[0]);
  };
  inp.click();
};
/* ZIP dan Excel tanlash */
window.pickExcelZip=function(container){
  var inp=document.createElement('input');inp.type='file';inp.accept='.zip';
  inp.onchange=async function(){
    if(!inp.files||!inp.files[0])return;
    try{
      var ab=await inp.files[0].arrayBuffer();
      var entries=await readZipEntries(ab);
      var matched=entries.filter(function(e){return e.name.match(/\.(xlsx|xls)$/i)});
      if(!matched.length){toast('ZIP da Excel topilmadi','er');return}
      if(matched.length===1){
        var blob=await matched[0].getData();
        var buf=await blob.arrayBuffer();
        var data=new Uint8Array(buf);
        renderXlData(data,container);
        var db=fDb(_curDb.lid,_curDb.did,_curDb.dbid);if(db)db._xlCache=data;
        toast(matched[0].name.split('/').pop()+' yuklandi!','ok');
        return;
      }
      /* Ko'p fayl â€” tanlash */
      var html='<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:10000;display:flex;align-items:center;justify-content:center" id="xlZpOv">'
        +'<div style="background:var(--card-s);border-radius:var(--radius-lg);padding:20px;max-width:500px;width:90%;max-height:70vh;overflow-y:auto;box-shadow:var(--shadow-h)">'
        +'<div style="font-family:var(--ffd);font-size:16px;font-weight:800;color:var(--t0);margin-bottom:14px">ğŸ“¦ '+matched.length+' ta Excel</div>';
      matched.forEach(function(e,i){
        html+='<div class="ali" style="margin-bottom:4px;cursor:pointer" onclick="xlZpPick('+i+')">'
          +'<div style="display:flex;align-items:center;gap:8px"><span>ğŸ“Š</span><div class="ali-nm" style="font-size:12px">'+e.name.split('/').pop()+'</div></div></div>';
      });
      html+='<button class="btn btn-s btn-sm" onclick="$(\'xlZpOv\').remove()" style="margin-top:10px">Yopish</button></div></div>';
      document.body.insertAdjacentHTML('beforeend',html);
      window._xlZpEntries=matched;window._xlZpContainer=container;
    }catch(e){toast('ZIP xato','er')}
  };
  inp.click();
};
window.xlZpPick=async function(idx){
  var e=window._xlZpEntries[idx];if(!e)return;
  try{
    var blob=await e.getData();
    var buf=await blob.arrayBuffer();
    var data=new Uint8Array(buf);
    renderXlData(data,window._xlZpContainer);
    var db=fDb(_curDb.lid,_curDb.did,_curDb.dbid);if(db)db._xlCache=data;
    toast(e.name.split('/').pop()+' yuklandi!','ok');
  }catch(err){toast('Xato','er')}
  var ov=$('xlZpOv');if(ov)ov.remove();
};
/* HTML faylni qo'lda tanlash */
window.pickHtml=function(){
  var inp=document.createElement('input');inp.type='file';inp.accept='.html,.htm';
  inp.onchange=function(){
    if(!inp.files||!inp.files[0])return;
    var reader=new FileReader();
    reader.onload=function(e){
      var fr=$('dbFrame');fr.removeAttribute('src');
      fr.srcdoc=e.target.result;fr.style.display='';
      $('vErr').style.display='none';
      var db=fDb(_curDb.lid,_curDb.did,_curDb.dbid);
      if(db)db._htmlCache=e.target.result;
      toast(inp.files[0].name+' yuklandi!','ok');
    };
    reader.readAsText(inp.files[0]);
  };
  inp.click();
};

window.showSh=function(b,i){b.closest('.xlv').querySelectorAll('.shc').forEach(function(e,j){e.style.display=j===i?'':'none'});b.parentElement.querySelectorAll('.btn').forEach(function(e,j){e.className='btn btn-sm '+(j===i?'btn-p':'btn-s')})};
/* â”€â”€ FAYL TANLASH FUNKSIYALARI â”€â”€ */
/* Sessiya xotirasi â€” fayllarni vaqtincha saqlash (sahifa ochiq bo'lganda) */
var _sessionFiles={};

/* Faylni sessiyaga saqlash va darhol ko'rsatish */
function storeAndShow(file, type){
  var reader=new FileReader();
  reader.onload=function(e){
    var key='_file_'+Date.now();
    if(type==='excel'){
      /* Excel â€” binary saqlash */
      _sessionFiles[key]={type:'excel',data:new Uint8Array(e.target.result),name:file.name};
      $('deXl').value=file.name;
      $('deXl').dataset.sessionKey=key;
      /* Darhol ko'rsatish */
      var xv=$('xlView');xv.style.display='';
      renderXlData(_sessionFiles[key].data,xv);
      toast(file.name+' yuklandi!','ok');
    }else{
      /* HTML â€” text saqlash va srcdoc bilan ko'rsatish */
      _sessionFiles[key]={type:'html',data:e.target.result,name:file.name};
      $('dePth').value=file.name;
      $('dePth').dataset.sessionKey=key;
      /* Darhol iframe da ko'rsatish */
      var fr=$('dbFrame');
      fr.removeAttribute('src');
      fr.srcdoc=e.target.result;
      fr.style.display='';
      $('vErr').style.display='none';
      toast(file.name+' yuklandi!','ok');
    }
  };
  if(type==='excel')reader.readAsArrayBuffer(file);
  else reader.readAsText(file);
}

/* ğŸ“„ Oddiy fayl tanlash */
window.browseFile=function(type){
  var inp=document.createElement('input');inp.type='file';
  inp.accept=type==='excel'?'.xlsx,.xls':'.html,.htm';
  inp.onchange=function(){
    if(!inp.files||!inp.files[0])return;
    storeAndShow(inp.files[0],type);
  };
  inp.click();
};

/* ğŸ“ Papkadan tanlash â€” webkitdirectory */
window.browseFolder=function(type){
  var inp=document.createElement('input');inp.type='file';
  inp.setAttribute('webkitdirectory','');inp.setAttribute('directory','');
  inp.onchange=function(){
    if(!inp.files||!inp.files.length)return;
    var files=Array.from(inp.files);
    var exts=type==='excel'?['.xlsx','.xls']:['.html','.htm'];
    var matched=files.filter(function(f){return exts.some(function(e){return f.name.toLowerCase().endsWith(e)})});
    if(!matched.length){toast('Mos fayl topilmadi','er');return}
    if(matched.length===1){
      storeAndShow(matched[0],type);
      return;
    }
    /* Ko'p fayl â€” ro'yxatdan tanlash */
    var html='<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:10000;display:flex;align-items:center;justify-content:center" id="fpOv">'
      +'<div style="background:var(--card-s);border-radius:var(--radius-lg);padding:20px;max-width:500px;width:90%;max-height:70vh;overflow-y:auto;box-shadow:var(--shadow-h)">'
      +'<div style="font-family:var(--ffd);font-size:16px;font-weight:800;color:var(--t0);margin-bottom:4px">ğŸ“ Faylni tanlang</div>'
      +'<div style="font-size:11px;color:var(--t2);margin-bottom:14px">'+matched.length+' ta '+type+' fayl topildi</div>';
    matched.forEach(function(f,i){
      html+='<div class="ali" style="margin-bottom:4px;cursor:pointer" onclick="fpSelect('+i+',\''+type+'\')">'
        +'<div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0">'
        +'<span style="font-size:14px">'+(type==='excel'?'ğŸ“Š':'ğŸŒ')+'</span>'
        +'<div style="min-width:0"><div class="ali-nm" style="font-size:12px">'+f.name+'</div>'
        +'<div class="ali-mt" style="font-size:9px">'+f.webkitRelativePath+'</div></div></div></div>';
    });
    html+='<button class="btn btn-s btn-sm" onclick="$(\'fpOv\').remove()" style="margin-top:10px">Yopish</button></div></div>';
    document.body.insertAdjacentHTML('beforeend',html);
    window._fpFiles=matched;
  };
  inp.click();
};
window.fpSelect=function(idx,type){
  var f=window._fpFiles[idx];if(!f)return;
  storeAndShow(f,type);
  var ov=$('fpOv');if(ov)ov.remove();
};

/* ğŸ“¦ ZIP ichidan fayl tanlash */
window.browseZip=function(type){
  var inp=document.createElement('input');inp.type='file';
  inp.accept='.zip';
  inp.onchange=async function(){
    if(!inp.files||!inp.files[0])return;
    toast('ZIP ochilmoqda...','nf');
    try{
      var ab=await inp.files[0].arrayBuffer();
      var entries=await readZipEntries(ab);
      var exts=type==='excel'?['.xlsx','.xls']:['.html','.htm'];
      var matched=entries.filter(function(e){return exts.some(function(x){return e.name.toLowerCase().endsWith(x)})});
      if(!matched.length){toast('ZIP da mos fayl topilmadi','er');return}
      var html='<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:10000;display:flex;align-items:center;justify-content:center" id="zpOv">'
        +'<div style="background:var(--card-s);border-radius:var(--radius-lg);padding:20px;max-width:560px;width:90%;max-height:70vh;overflow-y:auto;box-shadow:var(--shadow-h)">'
        +'<div style="font-family:var(--ffd);font-size:16px;font-weight:800;color:var(--t0);margin-bottom:4px">ğŸ“¦ ZIP: '+inp.files[0].name+'</div>'
        +'<div style="font-size:11px;color:var(--t2);margin-bottom:14px">'+matched.length+' ta '+type+' fayl topildi</div>';
      matched.forEach(function(e,i){
        var nm=e.name.split('/').pop();
        var dir=e.name.substring(0,e.name.lastIndexOf('/'));
        html+='<div class="ali" style="margin-bottom:4px;cursor:pointer" onclick="zpSelect('+i+',\''+type+'\')">'
          +'<div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0">'
          +'<span style="font-size:14px">'+(type==='excel'?'ğŸ“Š':'ğŸŒ')+'</span>'
          +'<div style="min-width:0"><div class="ali-nm" style="font-size:12px">'+nm+'</div>'
          +'<div class="ali-mt" style="font-size:9px;word-break:break-all">'+dir+'</div></div></div></div>';
      });
      html+='<button class="btn btn-s btn-sm" onclick="$(\'zpOv\').remove()" style="margin-top:10px">Yopish</button></div></div>';
      document.body.insertAdjacentHTML('beforeend',html);
      window._zpEntries=matched;
    }catch(e){toast('ZIP xato: '+e.message,'er')}
  };
  inp.click();
};
window.zpSelect=async function(idx,type){
  var e=window._zpEntries[idx];if(!e)return;
  try{
    var blob=await e.getData();
    /* ZIP dan olingan fayl â€” blob ni File ga o'zgartirish */
    var fname=e.name.split('/').pop();
    var file=new File([blob],fname);
    storeAndShow(file,type);
  }catch(err){toast('Xato: '+err.message,'er')}
  var ov=$('zpOv');if(ov)ov.remove();
};

/* ZIP o'qish â€” JSZip ishlatmasdan oddiy unzip */
async function readZipEntries(arrayBuffer){
  var view=new DataView(arrayBuffer);var entries=[];
  /* ZIP End of Central Directory topish */
  var eocdOff=-1;
  for(var i=arrayBuffer.byteLength-22;i>=0;i--){
    if(view.getUint32(i,true)===0x06054b50){eocdOff=i;break}
  }
  if(eocdOff<0)throw new Error('ZIP emas');
  var cdOff=view.getUint32(eocdOff+16,true);
  var cdCount=view.getUint16(eocdOff+8,true);
  var off=cdOff;
  for(var i=0;i<cdCount;i++){
    if(view.getUint32(off,true)!==0x02014b50)break;
    var method=view.getUint16(off+10,true);
    var compSize=view.getUint32(off+20,true);
    var uncompSize=view.getUint32(off+24,true);
    var nameLen=view.getUint16(off+28,true);
    var extraLen=view.getUint16(off+30,true);
    var commentLen=view.getUint16(off+32,true);
    var localOff=view.getUint32(off+42,true);
    var nameBytes=new Uint8Array(arrayBuffer,off+46,nameLen);
    var name=new TextDecoder('utf-8').decode(nameBytes);
    if(!name.endsWith('/')){
      entries.push({name:name,method:method,compSize:compSize,uncompSize:uncompSize,localOff:localOff,
        getData:function(){
          var e=this;
          return new Promise(function(resolve,reject){
            try{
              var lv=new DataView(arrayBuffer);
              var lNameLen=lv.getUint16(e.localOff+26,true);
              var lExtraLen=lv.getUint16(e.localOff+28,true);
              var dataStart=e.localOff+30+lNameLen+lExtraLen;
              var raw=new Uint8Array(arrayBuffer,dataStart,e.compSize);
              if(e.method===0){
                resolve(new Blob([raw]));
              }else if(e.method===8){
                var ds=new DecompressionStream('deflate-raw');
                var writer=ds.writable.getWriter();
                writer.write(raw);writer.close();
                new Response(ds.readable).blob().then(resolve).catch(reject);
              }else{reject(new Error('Unsupported method: '+e.method))}
            }catch(err){reject(err)}
          });
        }.bind({localOff:localOff,compSize:compSize,uncompSize:uncompSize,method:method})
      });
    }
    off+=46+nameLen+extraLen+commentLen;
  }
  return entries;
}

function toggleDbEdit(){$('dbEdit').classList.toggle('on');lucide.createIcons()}
function saveDbEdit(){
  var db=fDb(_curDb.lid,_curDb.did,_curDb.dbid);if(!db){toast('Xato','er');return}
  var nm=$('deNm').value.trim(),ty=$('deTy').value,pth=$('dePth').value.trim(),xl=$('deXl').value.trim();
  if(nm)db.name=nm;db.type=ty;

  /* Sessiyadan yuklangan fayl bormi tekshirish */
  var pthKey=$('dePth').dataset.sessionKey;
  var xlKey=$('deXl').dataset.sessionKey;

  if(pthKey&&_sessionFiles[pthKey]){
    /* HTML fayl sessiyadan â€” kontentni keshga saqlash */
    db._htmlCache=_sessionFiles[pthKey].data;
    db.path=pth; /* Fayl nomini saqlash */
  }else if(pth){
    db.path=pth;
  }

  if(xlKey&&_sessionFiles[xlKey]){
    /* Excel fayl sessiyadan â€” binary keshga */
    db._xlCache=_sessionFiles[xlKey].data;
    db.xl=xl;
  }else if(xl){
    db.xl=xl;
  }else{delete db.xl}

  save();$('dbTit').textContent=db.name;toast('Saqlandi!','ok');
  renderDash(_curDb.lid,_curDb.did,_curDb.dbid);
}
function delCurDb(){if(!confirm("O'chirasizmi?"))return;var dp=fDp(_curDb.lid,_curDb.did);if(!dp)return;dp.dashboards=dp.dashboards.filter(function(b){return b.id!==_curDb.dbid});save();go('dept',{lid:_curDb.lid,did:_curDb.did});toast("O'chirildi",'nf')}
function refreshDB(){renderDash(_curDb.lid,_curDb.did,_curDb.dbid);toast('Yangilandi','ok')}
function goFS(){var v=document.querySelector('.viewer');document.fullscreenElement?document.exitFullscreen():v.requestFullscreen().catch(function(){})}


/* â”€â”€ CLOCK / WEATHER / NEWS â”€â”€ */
function tick(){var n=new Date();$('tcClock').textContent=[n.getHours(),n.getMinutes(),n.getSeconds()].map(function(x){return String(x).padStart(2,'0')}).join(':');var mn=['Yan','Fev','Mar','Apr','May','Iyn','Iyl','Avg','Sen','Okt','Noy','Dek'];$('tcDate').textContent=n.getDate()+' '+mn[n.getMonth()]}
setInterval(tick,1000);tick();
/* â”€â”€ OB-HAVO: Open-Meteo API â€” real vaqtda Toshkent ob-havosi â”€â”€ */
async function loadW(){
  /* Weathercode â†’ emoji + o'zbekcha tavsif */
  var wc={0:['â˜€ï¸','Ochiq osmon'],1:['ğŸŒ¤','Asosan ochiq'],2:['â›…','Qisman bulutli'],3:['â˜ï¸','Bulutli'],
    45:['ğŸŒ«ï¸','Tuman'],48:['ğŸŒ«ï¸','Muzli tuman'],51:['ğŸŒ§ï¸','Engil yomg\'ir'],53:['ğŸŒ§ï¸','Yomg\'ir'],55:['ğŸŒ§ï¸','Kuchli yomg\'ir'],
    61:['ğŸŒ§ï¸','Yomg\'ir'],63:['ğŸŒ§ï¸','O\'rtacha yomg\'ir'],65:['ğŸŒ§ï¸','Kuchli yomg\'ir'],
    71:['â„ï¸','Engil qor'],73:['â„ï¸','Qor'],75:['â„ï¸','Kuchli qor'],77:['â„ï¸','Qor donachalari'],
    80:['ğŸŒ¦ï¸','Yomg\'ir'],81:['ğŸŒ¦ï¸','Yomg\'ir'],82:['ğŸŒ¦ï¸','Kuchli yomg\'ir'],
    85:['ğŸŒ¨ï¸','Qor'],86:['ğŸŒ¨ï¸','Kuchli qor'],95:['â›ˆï¸','Momaqaldiroq'],96:['â›ˆï¸','Do\'l'],99:['â›ˆï¸','Kuchli do\'l']};
  function wInfo(code){return wc[code]||['â›…','Noma\'lum']}
  try{
    /* Open-Meteo: bepul, kalitsiz, CORS yoq â€” Toshkent koordinatalari */
    var url='https://api.open-meteo.com/v1/forecast?latitude=41.31&longitude=69.28&current=temperature_2m,relative_humidity_2m,wind_speed_10m,weather_code&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=Asia%2FTashkent&forecast_days=7';
    var r=await fetch(url);var d=await r.json();
    var cur=d.current, daily=d.daily;
    var w=wInfo(cur.weather_code);
    $('wTemp').textContent=Math.round(cur.temperature_2m)+'Â°C';
    $('wIco').textContent=w[0];
    /* Haftalik prognoz â€” 7 kunlik mini ko'rinish */
    var kunlar=['Yak','Dush','Sesh','Chor','Pay','Jum','Shan'];
    var week='';
    if(daily&&daily.time){
      week='<div class="w-forecast" style="display:flex;gap:6px;margin-top:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding-bottom:2px">';
      for(var i=0;i<Math.min(7,daily.time.length);i++){
        var dt=new Date(daily.time[i]);
        var dw=wInfo(daily.weather_code[i]);
        week+='<div style="text-align:center;padding:3px 5px;background:var(--pill-bg);border-radius:var(--radius);border:1px solid var(--pill-brd);min-width:42px;font-size:9px">'
          +'<div style="font-weight:800;color:var(--t2)">'+kunlar[dt.getDay()]+'</div>'
          +'<div style="font-size:14px">'+dw[0]+'</div>'
          +'<div style="color:var(--t0);font-weight:700">'+Math.round(daily.temperature_2m_max[i])+'Â°</div>'
          +'<div style="color:var(--t3)">'+Math.round(daily.temperature_2m_min[i])+'Â°</div>'
          +'</div>';
      }
      week+='</div>';
    }
    $('wDet').innerHTML='<div>'+w[1]+'</div>'
      +'<div>Namlik: '+cur.relative_humidity_2m+'% Â· Shamol: '+Math.round(cur.wind_speed_10m)+' km/h</div>'
      +week
      +'<div style="margin-top:4px;font-size:9px;color:var(--t3)">Open-Meteo API Â· yangilandi: '+new Date().toLocaleTimeString('uz',{hour:'2-digit',minute:'2-digit'})+'</div>';
  }catch(e){
    /* Fallback â€” agar internet yo'q bo'lsa */
    $('wTemp').textContent='11Â°C';$('wIco').textContent='â›…';
    $('wDet').innerHTML='<div>Qisman bulutli</div><div>Namlik: 52% Â· Shamol: 3 km/h</div><div style="font-size:9px;color:var(--t3)">Oflayn rejim</div>';
  }
}
loadW(); setInterval(loadW,1800000); /* Har 30 daqiqada yangilanadi */

/* â”€â”€ YANGILIKLAR: bankers.uz va kun.uz ALOHIDA widgetlar â”€â”€ */

/* Bitta widget uchun yangilik render qilish */
function renderNewsList(nl,news,timeId){
  if(!news||!news.length){
    nl.innerHTML='<div style="text-align:center;padding:10px;color:var(--t3);font-size:10px">Yangilik topilmadi</div>';
    return;
  }
  nl.innerHTML=news.slice(0,15).map(function(n){
    /* Manbaga qarab URL tuzish */
    var src=n.s||'';
    var url='';
    if(src==='B')url='https://bankers.uz';
    else if(src==='K')url='https://kun.uz/uz/news';
    if(n.href)url=n.href; /* RSS dan kelgan to'g'ridan-to'g'ri havola */
    var clickAttr=url?'ondblclick="window.open(\''+url.replace(/'/g,"\\'")+'\',\'_blank\')" style="cursor:pointer" title="Ikki marta bosib ochish"':'';
    return '<div class="n-item" '+clickAttr+'><span class="n-time">'+(n.t||'\u2022')+'</span><span class="n-txt">'+n.x+'</span></div>';
  }).join('');
  var el=$(timeId);if(el)el.textContent='\u27f3 '+new Date().toLocaleTimeString('uz',{hour:'2-digit',minute:'2-digit'});
}

/* Bitta manbadan RSS/HTML orqali yangilik olish */
async function fetchNewsSrc(rssUrl,fallbackUrl,srcTag,limit){
  var proxyUrls=[
    'https://api.allorigins.win/raw?url='+encodeURIComponent(rssUrl),
    'https://api.codetabs.com/v1/proxy?quest='+encodeURIComponent(rssUrl)
  ];
  var html=null;
  for(var p=0;p<proxyUrls.length;p++){
    try{var r=await fetch(proxyUrls[p],{signal:AbortSignal.timeout(8000)});if(r.ok){html=await r.text();if(html&&html.length>200)break;html=null}}catch(e){continue}
  }
  var news=[];
  if(html&&(html.includes('<item')||html.includes('<entry'))){
    var parser=new DOMParser();var doc=parser.parseFromString(html,'text/xml');
    var items=doc.querySelectorAll('item, entry');
    items.forEach(function(it,i){
      if(i>=limit)return;
      var title=(it.querySelector('title')||{}).textContent||'';
      var pubDate=(it.querySelector('pubDate, published, updated')||{}).textContent||'';
      var link=(it.querySelector('link')||{}).textContent||'';
      if(!link){var linkEl=it.querySelector('link[href]');if(linkEl)link=linkEl.getAttribute('href')||''}
      var dt='';
      if(pubDate){try{var d=new Date(pubDate);dt=String(d.getDate()).padStart(2,'0')+'.'+String(d.getMonth()+1).padStart(2,'0')}catch(e){}}
      if(title.trim())news.push({t:dt,x:title.trim(),s:srcTag,href:link});
    });
    if(news.length>0)return news;
  }
  if((!html||html.length<200)&&fallbackUrl){
    for(var p=0;p<proxyUrls.length;p++){
      try{
        var url2=proxyUrls[p].split('url=')[0]+'url='+encodeURIComponent(fallbackUrl);
        if(proxyUrls[p].includes('codetabs'))url2=proxyUrls[p].split('quest=')[0]+'quest='+encodeURIComponent(fallbackUrl);
        var r2=await fetch(url2,{signal:AbortSignal.timeout(8000)});
        if(r2.ok){html=await r2.text();if(html&&html.length>500)break;html=null}
      }catch(e){continue}
    }
  }
  if(html&&html.length>500){
    var dp=new DOMParser();var dd=dp.parseFromString(html,'text/html');
    var links=dd.querySelectorAll('a[href*="/news/"],a[href*="/post/"]');
    var seen={};
    links.forEach(function(a){
      if(news.length>=limit)return;
      var txt=a.textContent.trim().replace(/\s+/g,' ');
      if(txt.length>15&&txt.length<300&&!seen[txt]){seen[txt]=1;
        var dm='';var pm=a.closest('[class]');
        if(pm){var timeEl=pm.querySelector('time,[datetime]');if(timeEl){try{var td=new Date(timeEl.getAttribute('datetime')||timeEl.textContent);dm=String(td.getDate()).padStart(2,'0')+'.'+String(td.getMonth()+1).padStart(2,'0')}catch(e){}}}
        news.push({t:dm,x:txt,s:srcTag,href:href.startsWith('http')?href:(fallbackUrl||'')+href});
      }
    });
  }
  return news;
}

/* bankers.uz yuklash */
async function loadNB(){
  var nl=$('nListB');
  if(!nl)return;
  nl.innerHTML='<div style="text-align:center;padding:10px;color:var(--t2);font-size:10px">\u23f3 bankers.uz...</div>';
  try{
    var news=await fetchNewsSrc('https://bankers.uz/rss','https://bankers.uz/','B',15);
    if(news&&news.length>0){renderNewsList(nl,news,'nTimeB');return}
    throw new Error('no data');
  }catch(e){
    nl.innerHTML=[
{t:'30.01',x:"Banklarning depozit bazasi 2025-yilda 35,2% ga o\u2018sdi \u2014 417,3 trln so\u2018m"},
{t:'29.01',x:"Sharof Sharipov TBC Digital Bosh moliya direktori etib tayinlandi"},
{t:'28.01',x:"Markaziy bank 2026-yil yakunida inflyatsiya 6,5% prognoz qilmoqda"},
{t:'28.01',x:"Asia Alliance Bank biometrik bankomatlarni ishga tushiradi"},
{t:'27.01',x:"Yangi Bank omonatchilariga BRB orqali kompensatsiya 28-yanvardan"},
{t:'22.01',x:"MB kechiktirilgan kredit to\u2018lovlari uchun penyalarni qayta ko\u2018rib chiqishni taklif qildi"},
{t:'17.01',x:"2026-yilda banklar MHXSga o\u2018tadi, 2027-da Bazel III"},
{t:'15.01',x:"Yangi Bank litsenziyasi chaqirib olindi \u2014 banklar soni 34 taga tushdi"},
{t:'15.01',x:"2025-yilda banklarning sof foydasi 2,2 barobarga ortdi"},
{t:'05.01',x:"Ipak Yo\u2018li Bank Green Generation loyihasini boshladi"},
{t:'03.01',x:"2025-yil yakunida rasmiy inflyatsiya 9,8% \u2014 MB hisoboti"}
].map(function(n){return '<div class="n-item"><span class="n-time">'+n.t+'</span><span class="n-txt">'+n.x+'</span></div>'}).join('');
    nl.innerHTML+='<div style="text-align:center;padding:4px;font-size:8px;color:var(--t3)">\u26a1 Oflayn</div>';
  }
}

/* kun.uz yuklash â€” IQTISODIY YANGILIKLAR FILTRI */
async function loadNK(){
  var nl=$('nListK');
  if(!nl)return;
  nl.innerHTML='<div style="text-align:center;padding:10px;color:var(--t2);font-size:10px">\u23f3 kun.uz iqtisodiyot...</div>';

  /* Iqtisodiy kalit so'zlar â€” yangilik mos kelishi shart */
  var econWords=['bank','kredit','valyuta','dollar','so\'m','inflyatsiya','iqtisod','moliya','soliq','byudjet','investits','eksport','import','savdo','fond','birja','aksiya','obligatsiya','foiz','stavka','pul','depozit','omonat','ipoteka','ssuda','qarz','bozor','narx','bahol','daromad','foyda','zarar','yalpi','GDP','YAIM','IMF','Jahon banki','biznes','tadbirkor','korxona','ishsiz','bandlik','pension','nafaqa','kvota','bojxona','lizing','sug\'urta','audit','kapital','dividend','emissiya','likvidlik','defitsit','profitsit','fiskal','monetar','tijorat','xususiy','davlat','rezident','milliy','xalqaro','tranzaksiya','to\'lov','hisob','tashkilot','muassasa','sektor','sanoat','qishloq','energetik','gaz','neft','elektr','tarif','narxlash','iste\'mol','chakana','ulgurji','fermer','agro','mineral','konchilik'];
  function isEconNews(text){
    var t=text.toLowerCase();
    for(var i=0;i<econWords.length;i++){
      if(t.includes(econWords[i]))return true;
    }
    return false;
  }

  try{
    /* kun.uz uchun iqtisodiy RSS URL'lar â€” avval iqtisod, keyin umumiy */
    var rssUrls=[
      'https://kun.uz/uz/rss/category/iqtisodiyot',
      'https://kun.uz/rss/category/iqtisodiyot',
      'https://kun.uz/uz/rss/category/economy',
      'https://kun.uz/rss/category/economy',
      'https://kun.uz/uz/rss',
      'https://kun.uz/rss',
      'https://kun.uz/uz/rss/news',
      'https://kun.uz/rss/news'
    ];
    var proxyBases=[
      'https://api.allorigins.win/raw?url=',
      'https://api.codetabs.com/v1/proxy?quest='
    ];
    var news=[];

    /* 1-usul: RSS feed orqali */
    for(var r=0;r<rssUrls.length&&news.length<5;r++){
      for(var p=0;p<proxyBases.length&&news.length<5;p++){
        try{
          var resp=await fetch(proxyBases[p]+encodeURIComponent(rssUrls[r]),{signal:AbortSignal.timeout(8000)});
          if(!resp.ok)continue;
          var html=await resp.text();
          if(!html||html.length<200)continue;
          if(html.includes('<item')||html.includes('<entry')){
            var parser=new DOMParser();var doc=parser.parseFromString(html,'text/xml');
            var items=doc.querySelectorAll('item, entry');
            items.forEach(function(it,i){
              if(i>=30)return; /* Ko'proq o'qib, filtrlaymiz */
              var title=(it.querySelector('title')||{}).textContent||'';
              var link=(it.querySelector('link')||{}).textContent||'';
              if(!link){var linkEl=it.querySelector('link[href]');if(linkEl)link=linkEl.getAttribute('href')||''}
              var pubDate=(it.querySelector('pubDate, published, updated')||{}).textContent||'';
              var desc=(it.querySelector('description, summary, content')||{}).textContent||'';
              var dt='';
              if(pubDate){try{var d=new Date(pubDate);dt=String(d.getDate()).padStart(2,'0')+'.'+String(d.getMonth()+1).padStart(2,'0')}catch(e){}}
              /* Kategoriya nomlarini filtrlash â€” haqiqiy yangilik 25+ belgi */
              var t=title.trim();
              if(t.length>25&&(isEconNews(t)||isEconNews(desc))){
                /* Dublikat tekshirish */
                var dup=false;news.forEach(function(n){if(n.x===t)dup=true});
                if(!dup)news.push({t:dt,x:t,s:'K',href:link});
              }
            });
          }
        }catch(e){continue}
      }
    }
    if(news.length>0){renderNewsList(nl,news,'nTimeK');return}

    /* 2-usul: kun.uz iqtisod sahifasini parse qilish */
    var pageUrls=['https://kun.uz/uz/news/category/iqtisodiyot','https://kun.uz/uz/news/list','https://kun.uz/uz'];
    var pageHtml=null;
    for(var u=0;u<pageUrls.length&&!pageHtml;u++){
      for(var p=0;p<proxyBases.length&&!pageHtml;p++){
        try{
          var resp2=await fetch(proxyBases[p]+encodeURIComponent(pageUrls[u]),{signal:AbortSignal.timeout(8000)});
          if(resp2.ok){var h=await resp2.text();if(h&&h.length>1000)pageHtml=h}
        }catch(e){continue}
      }
    }
    if(pageHtml){
      var dp=new DOMParser();var dd=dp.parseFromString(pageHtml,'text/html');
      /* kun.uz yangilik selektorlari â€” turli strukturalar */
      var selectors=[
        'article a','a[href*="/news/"]','a[href*="/uz/"]',
        '.news-list a','h2 a','h3 a','.title a',
        '[class*="news"] a','[class*="article"] a'
      ];
      var seen={},news2=[];
      selectors.forEach(function(sel){
        if(news2.length>=15)return;
        try{
          var els=dd.querySelectorAll(sel);
          els.forEach(function(a){
            if(news2.length>=15)return;
            var txt=a.textContent.trim().replace(/\s+/g,' ');
            var href=a.getAttribute('href')||'';
            /* Filtrlash: 25+ belgi, dublikat emas, kategoriya emas, IQTISODIY */
            var skipWords=['xabarlar','hikoyalar','tanlovi','maqolalar','fotogalereya','video','barcha','barchasi','ko\'proq','batafsil','tag','category'];
            var isCategory=false;
            skipWords.forEach(function(sw){if(txt.toLowerCase().includes(sw)&&txt.length<40)isCategory=true});
            if(txt.length>25&&txt.length<300&&!seen[txt]&&!isCategory&&isEconNews(txt)){
              seen[txt]=1;
              var fullHref=href.startsWith('http')?href:'https://kun.uz'+href;
              var dm='';
              var pm=a.closest('[class]');
              if(pm){var timeEl=pm.querySelector('time,[datetime]');if(timeEl){try{var td=new Date(timeEl.getAttribute('datetime')||timeEl.textContent);dm=String(td.getDate()).padStart(2,'0')+'.'+String(td.getMonth()+1).padStart(2,'0')}catch(e){}}}
              news2.push({t:dm,x:txt,s:'K',href:fullHref});
            }
          });
        }catch(e){}
      });
      if(news2.length>0){renderNewsList(nl,news2,'nTimeK');return}
    }
    throw new Error('no data');
  }catch(e){
    /* Oflayn iqtisodiy yangiliklar */
    nl.innerHTML=[
{t:'01.02',x:"O\u2018zbekiston 2026-yilda YAIMni 6,2 foizga oshirishni rejalashtirmoqda",href:'https://kun.uz/uz/news/category/iqtisodiyot'},
{t:'31.01',x:"Markaziy bank asosiy stavkani 13,5 foizda saqlab qoldi",href:'https://kun.uz/uz/news/category/iqtisodiyot'},
{t:'30.01',x:"Dollar kursi 12 900 so\u2018mga tushdi \u2014 MB valyuta interventsiyasi",href:'https://kun.uz/uz/news/category/iqtisodiyot'},
{t:'28.01',x:"Soliq tushumlari 2025-yilda 28 foizga oshdi \u2014 DXQ hisoboti",href:'https://kun.uz/uz/news/category/iqtisodiyot'},
{t:'27.01',x:"Prezident yangi imtiyozli ipoteka dasturini e\u2018lon qildi",href:'https://kun.uz/uz/news/category/iqtisodiyot'},
{t:'25.01',x:"O\u2018zbekiston Jahon bankidan 500 mln dollar kredit oladi",href:'https://kun.uz/uz/news/category/iqtisodiyot'},
{t:'22.01',x:"O\u2018zbekistonda yangi soliq islohotlari tayyorlanmoqda \u2014 moliya vazirligi",href:'https://kun.uz/uz/news/category/iqtisodiyot'},
{t:'20.01',x:"IT sektori eksporti birinchi marta 1 milliard dollardan oshdi",href:'https://kun.uz/uz/news/category/iqtisodiyot'},
{t:'18.01',x:"2025-yilda xorijiy investitsiyalar 8,3 milliard dollarni tashkil etdi",href:'https://kun.uz/uz/news/category/iqtisodiyot'},
{t:'15.01',x:"2025-yilda aholining real daromadlari 12 foizga o\u2018sdi \u2014 statistika",href:'https://kun.uz/uz/news/category/iqtisodiyot'}
].map(function(n){return '<div class="n-item" ondblclick="window.open(\''+n.href+'\',\'_blank\')" style="cursor:pointer" title="Ikki marta bosib ochish"><span class="n-time">'+n.t+'</span><span class="n-txt">'+n.x+'</span></div>'}).join('');
    nl.innerHTML+='<div style="text-align:center;padding:4px;font-size:8px;color:var(--t3)">\u26a1 Oflayn Â· Iqtisodiy</div>';
  }
}

/* Ikkalasini birga yuklash */
function loadN(){loadNB();loadNK()}
loadN(); setInterval(loadN,600000); /* Har 10 daqiqada yangilanadi */


/* â”€â”€ ADMIN â€” LOGIN HIMOYASI â”€â”€ */
var ADM_LOGIN='MBtoshvil';
var ADM_PASS='CBU_toshvil';
var admAuth=false;

function openAdm(){
  /* Sessiya davomida parol so'ramaslik */
  if(admAuth||sessionStorage.getItem('admAuth')==='1'){
    admAuth=true;
    $('admOv').classList.add('on');admTab('leaders');
    return;
  }
  /* Login modalni ko'rsatish */
  showLoginModal();
}
function showLoginModal(){
  var existing=document.getElementById('loginModal');
  if(existing)existing.remove();
  var m=document.createElement('div');
  m.id='loginModal';
  m.style.cssText='position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);animation:mIn .25s';
  m.innerHTML='<div style="background:var(--card-s);border:1px solid var(--brd);border-radius:var(--radius-lg);padding:28px;width:min(380px,90vw);box-shadow:0 14px 50px rgba(0,0,0,.4);animation:cardUp .35s cubic-bezier(.16,1,.3,1)">'
    +'<div style="text-align:center;margin-bottom:20px">'
    +'<div style="font-size:36px;margin-bottom:8px">ğŸ”</div>'
    +'<h3 style="font-family:var(--ffd);font-size:18px;color:var(--t0);margin:0">Sozlamalar</h3>'
    +'<div style="font-size:11px;color:var(--t2);margin-top:4px">Kirish uchun login va parolni kiriting</div>'
    +'</div>'
    +'<div class="fg"><label class="fl">Login</label><input class="fi" id="admLoginInp" placeholder="Login" autocomplete="username" autofocus></div>'
    +'<div class="fg"><label class="fl">Parol</label><input class="fi" id="admPassInp" type="password" placeholder="Parol" autocomplete="current-password"></div>'
    +'<div id="loginErr" style="display:none;color:var(--err);font-size:11px;font-weight:700;text-align:center;padding:6px;margin-bottom:8px;background:rgba(251,113,133,.06);border-radius:var(--radius)">âŒ Login yoki parol noto\'g\'ri</div>'
    +'<div style="display:flex;gap:8px;margin-top:16px">'
    +'<button class="btn btn-s" onclick="closeLoginModal()" style="flex:1">Bekor qilish</button>'
    +'<button class="btn btn-p" onclick="doAdmLogin()" style="flex:1">Kirish</button>'
    +'</div>'
    +'</div>';
  document.body.appendChild(m);
  /* Enter tugmasi bilan kirish */
  var passInp=document.getElementById('admPassInp');
  var loginInp=document.getElementById('admLoginInp');
  passInp.addEventListener('keydown',function(e){if(e.key==='Enter')doAdmLogin()});
  loginInp.addEventListener('keydown',function(e){if(e.key==='Enter')document.getElementById('admPassInp').focus()});
  loginInp.focus();
}
function closeLoginModal(){
  var m=document.getElementById('loginModal');
  if(m)m.remove();
}
function doAdmLogin(){
  var login=(document.getElementById('admLoginInp')||{}).value||'';
  var pass=(document.getElementById('admPassInp')||{}).value||'';
  if(login===ADM_LOGIN&&pass===ADM_PASS){
    admAuth=true;
    sessionStorage.setItem('admAuth','1');
    closeLoginModal();
    $('admOv').classList.add('on');admTab('leaders');
    showToast('âœ… Tizimga kirdingiz','ok');
  }else{
    var err=document.getElementById('loginErr');
    if(err)err.style.display='block';
    /* Input larni silkitish */
    var box=document.getElementById('loginModal').firstChild;
    box.style.animation='none';
    box.offsetHeight; /* reflow */
    box.style.animation='shake .4s ease';
  }
}
function closeAdm(){$('admOv').classList.remove('on')}
function admTab(tab){document.querySelectorAll('.adm-tab').forEach(function(t){t.classList.toggle('on',t.dataset.tab===tab)});var b=$('admBd');
  if(tab==='leaders')b.innerHTML='<div style="font-family:var(--ffd);font-size:18px;font-weight:800;color:var(--t0);margin-bottom:12px">Rahbarlar</div>'+D.leaders.map(function(l){return '<div class="ali"><div><div class="ali-nm">'+l.name+'</div><div class="ali-mt">'+l.role+'</div></div><div class="ali-acts"><button class="btn btn-sm btn-s" onclick="editLN(\''+l.id+'\')"><i data-lucide="pencil" style="width:11px;height:11px"></i></button></div></div>'}).join('');
  else if(tab==='transfer'){var ad=[];D.leaders.forEach(function(l){l.departments.forEach(function(d){ad.push({lid:l.id,ln:l.name,did:d.id,dn:d.name})})});b.innerHTML='<div class="fg"><label class="fl">Bo\'lim</label><select class="fs" id="trD"><option>Tanlang</option>'+ad.map(function(d){return '<option value="'+d.lid+'__'+d.did+'">'+d.dn+'</option>'}).join('')+'</select></div><div style="text-align:center;font-size:24px;color:var(--ac);margin:8px 0">â†“</div><div class="fg"><label class="fl">Yangi rahbar</label><select class="fs" id="trT">'+D.leaders.map(function(l){return '<option value="'+l.id+'">'+l.name+'</option>'}).join('')+'</select></div><button class="btn btn-p" onclick="doTr()">Ko\'chirish</button>'}
  else if(tab==='depts'){b.innerHTML='<div class="fg"><label class="fl">Rahbar</label><select class="fs" id="ndL">'+D.leaders.map(function(l){return '<option value="'+l.id+'">'+l.name+'</option>'}).join('')+'</select></div><div class="fg"><label class="fl">Nomi</label><input class="fi" id="ndN" placeholder="Bo\'lim nomi"></div><div class="fg"><label class="fl">Bo\'lim boshlig\'i</label><input class="fi" id="ndBoss" placeholder="F.I.Sh"></div><div class="fg"><label class="fl">Lavozimi</label><input class="fi" id="ndBossRole" placeholder="Bo\'lim boshlig\'i"></div><button class="btn btn-p" onclick="addDp()">Qo\'shish</button><hr style="margin:16px 0;border:none;border-top:1px solid var(--brd2)">'+D.leaders.map(function(l){return '<div style="font-family:var(--ffd);font-size:13px;font-weight:800;color:var(--ac);margin:12px 0 6px">'+l.name+'</div>'+l.departments.map(function(d){return '<div class="ali"><div><div class="ali-nm">'+d.name+'</div><div class="ali-mt">'+(d.boss?'<span style="color:var(--ac)">ğŸ‘¤ '+d.boss+(d.bossRole?' â€” '+d.bossRole:'')+'</span>':'<span style="color:var(--t3)">Boshliq tayinlanmagan</span>')+'</div></div><div class="ali-acts"><button class="btn btn-sm btn-s" onclick="editBoss(\''+l.id+'\',\''+d.id+'\')" title="Boshliq"><i data-lucide="user-circle" style="width:11px;height:11px"></i></button><button class="btn btn-sm btn-s" onclick="renDp(\''+l.id+'\',\''+d.id+'\')" title="Nom"><i data-lucide="pencil" style="width:11px;height:11px"></i></button><button class="btn btn-sm btn-d" onclick="delDp(\''+l.id+'\',\''+d.id+'\')"><i data-lucide="trash-2" style="width:11px;height:11px"></i></button></div></div>'}).join('')}).join('')}
  else if(tab==='dashs'){var all=[];D.leaders.forEach(function(l){l.departments.forEach(function(d){d.dashboards.forEach(function(db){all.push({lid:l.id,did:d.id,dn:d.name,db:db})})})});b.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><div style="font-family:var(--ffd);font-size:18px;font-weight:800;color:var(--t0)">Dashboardlar</div><button class="btn btn-p btn-sm" onclick="closeAdm();openAddDash()"><i data-lucide="plus-circle" style="width:12px;height:12px"></i> Yangi</button></div>'+(all.length?all.map(function(it){return '<div class="ali" style="flex-wrap:wrap"><div style="flex:1;min-width:150px"><div class="ali-nm">'+it.db.name+'</div><div class="ali-mt">'+it.dn+'</div></div><div class="ali-acts"><button class="btn btn-sm btn-s" onclick="renDb(\''+it.lid+'\',\''+it.did+'\',\''+it.db.id+'\')">Nom</button><button class="btn btn-sm btn-s" onclick="edPath(\''+it.lid+'\',\''+it.did+'\',\''+it.db.id+'\')">Yo\'l</button><button class="btn btn-sm btn-d" onclick="delDb(\''+it.lid+'\',\''+it.did+'\',\''+it.db.id+'\')"><i data-lucide="trash-2" style="width:11px;height:11px"></i></button></div></div>'}).join(''):'<p style="color:var(--t2)">Yo\'q</p>')}
  else if(tab==='upload'){var ad2=[];D.leaders.forEach(function(l){l.departments.forEach(function(d){ad2.push({lid:l.id,did:d.id,label:l.name+' â†’ '+d.name})})});b.innerHTML='<div class="fg"><label class="fl">Bo\'lim</label><select class="fs" id="uDp">'+ad2.map(function(d){return '<option value="'+d.lid+'__'+d.did+'">'+d.label+'</option>'}).join('')+'</select></div><div class="fg"><label class="fl">Nomi</label><input class="fi" id="uN" placeholder="Dashboard nomi"></div><div class="fg"><label class="fl">Turi</label><select class="fs" id="uTy" onchange="$(\'uUrl\').style.display=this.value===\'url\'?\'\':\'none\';$(\'uFg\').style.display=this.value===\'url\'?\'none\':\'\'"><option value="html">HTML</option><option value="excel">Excel</option><option value="url">URL</option></select></div><div class="fg" id="uUrl" style="display:none"><label class="fl">URL</label><input class="fi" id="uUr" placeholder="https://..."></div><div class="fg" id="uFg"><label class="fl">Fayl</label><div class="upzone" onclick="$(\'uFi\').click()"><input type="file" id="uFi" accept=".html,.xlsx,.xls" onchange="$(\'uFn\').textContent=this.files[0]?\'âœ“ \'+this.files[0].name:\'\'"><div style="font-size:28px;margin-bottom:5px">ğŸ“</div><div>Faylni tanlang</div></div><div id="uFn" style="font-size:10px;color:var(--ac);margin-top:4px"></div></div><div class="fg"><label class="fl">Excel (ixtiyoriy)</label><div class="upzone" onclick="$(\'uXi\').click()" style="padding:16px"><input type="file" id="uXi" accept=".xlsx,.xls" onchange="$(\'uXn\').textContent=this.files[0]?\'âœ“ \'+this.files[0].name:\'\'">ğŸ“Š</div><div id="uXn" style="font-size:10px;color:var(--ok);margin-top:4px"></div></div><button class="btn btn-p" onclick="doUp()">Saqlash</button>'}
  else if(tab==='files'){
    /* PAPKA BRAUZERI â€” fayllarni ko'rish, tanlash, yo'l nusxalash */
    var root=[];
    D.leaders.forEach(function(l){
      var lDir={name:l.name.split('.').pop().split(' ')[0]+" yo'nalishi",type:'dir',lid:l.id,children:[]};
      l.departments.forEach(function(d){
        var dDir={name:d.name,type:'dir',lid:l.id,did:d.id,children:[]};
        d.dashboards.forEach(function(db){
          /* HTML fayl */
          if(db.path)dDir.children.push({name:db.path.split('/').pop(),type:db.type==='excel'?'xlsx':'html',path:db.path,dbName:db.name,dbId:db.id,lid:l.id,did:d.id});
          /* Excel fayl */
          if(db.xl)dDir.children.push({name:db.xl.split('/').pop(),type:'xlsx',path:db.xl,dbName:db.name+' (Excel)',dbId:db.id,lid:l.id,did:d.id});
        });
        lDir.children.push(dDir);
      });
      root.push(lDir);
    });
    function renderBrowser(items,depth){
      return items.map(function(it){
        var pad=depth*18;
        if(it.type==='dir'){
          var cnt=it.children?it.children.reduce(function(s,c){return s+(c.type==='dir'?(c.children?c.children.length:0):1)},0):0;
          return '<div class="fb-dir" style="padding-left:'+pad+'px">'
            +'<div class="ali" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display===\'none\'?\'\':\'none\';this.querySelector(\'.fb-arrow\').classList.toggle(\'fb-open\')" style="cursor:pointer">'
            +'<div style="display:flex;align-items:center;gap:8px"><span class="fb-arrow">â–¶</span><span style="font-size:16px">ğŸ“</span><div><div class="ali-nm">'+it.name+'</div><div class="ali-mt">'+cnt+' fayl</div></div></div></div>'
            +'<div style="display:none">'+renderBrowser(it.children||[],depth+1)+'</div></div>';
        }else{
          var ico=it.type==='xlsx'?'ğŸ“Š':it.type==='html'?'ğŸŒ':'ğŸ“„';
          var sz=it.path?it.path.length+'B':'';
          return '<div class="ali" style="margin-left:'+pad+'px;margin-bottom:3px">'
            +'<div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0"><span style="font-size:14px">'+ico+'</span>'
            +'<div style="min-width:0"><div class="ali-nm" style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+it.name+'</div>'
            +'<div class="ali-mt" style="font-size:9px">'+it.dbName+' Â· <code style="font-size:8px;color:var(--ac);cursor:pointer" onclick="navigator.clipboard.writeText(\''+it.path.replace(/'/g,"\\'")+ '\');toast(\'Nusxalandi!\',\'ok\')" title="Nusxalash">'+it.path.slice(0,50)+(it.path.length>50?'â€¦':'')+'</code></div></div></div>'
            +'<div class="ali-acts"><button class="btn btn-sm btn-p" onclick="closeAdm();go(\'dashboard\',{lid:\''+it.lid+'\',did:\''+it.did+'\',dbid:\''+it.dbId+'\'})">Ochish</button>'
            +'<button class="btn btn-sm btn-s" onclick="edPath(\''+it.lid+'\',\''+it.did+'\',\''+it.dbId+'\')">Yo\'l</button></div></div>';
        }
      }).join('');
    }
    b.innerHTML='<style>.fb-arrow{display:inline-block;transition:transform .2s;font-size:8px;color:var(--t3)}.fb-open{transform:rotate(90deg)}.fb-dir{margin-bottom:2px}</style>'
      +'<div style="font-family:var(--ffd);font-size:18px;font-weight:800;color:var(--t0);margin-bottom:4px">ğŸ“ Papka brauzeri</div>'
      +'<div style="font-size:11px;color:var(--t2);margin-bottom:14px">Barcha fayllar va yo\'llarni ko\'ring. Yo\'lni bosib nusxalang, "Ochish" bilan dashboardni oching.</div>'
      +'<div class="fg"><label class="fl">Fayl qidirish</label><input class="fi" id="fbSearch" placeholder="Fayl nomi..." oninput="fbFilter(this.value)"></div>'
      +'<div id="fbTree">'+renderBrowser(root,0)+'</div>'
      +'<div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--brd2)">'
      +'<div style="font-size:10px;color:var(--t3);margin-bottom:6px">Yangi fayl qo\'shish (drag & drop yoki tanlash):</div>'
      +'<div class="upzone" onclick="$(\'fbFileInput\').click()" style="padding:14px"><input type="file" id="fbFileInput" accept=".html,.xlsx,.xls" multiple onchange="fbAddFiles(this)"><div>ğŸ“ HTML yoki Excel fayllarni tanlang</div></div></div>';
  }
  else if(tab==='cfg'){var cUrl=_getCloudUrl();b.innerHTML='<div style="font-family:var(--ffd);font-size:18px;font-weight:800;color:var(--ac);margin-bottom:4px">â˜ Bulut sinxronizatsiya</div>'
    +'<div style="font-size:11px;color:var(--t2);margin-bottom:10px">Ma\'lumotlar bulutda saqlanadi â€” barcha foydalanuvchilar ko\'radi</div>'
    +'<div id="cloudInd" style="font-size:12px;font-weight:700;margin-bottom:10px;color:'+(cUrl?'#22c55e':'var(--t3)')+'">'+(!cUrl?'âšª Bulut ulanmagan':'â˜ Bulut ulangan')+'</div>'
    +'<div class="fg"><label class="fl">npoint.io URL</label><input class="fi" id="cloudUrlInp" value="'+(cUrl||'')+'" placeholder="https://api.npoint.io/xxxxxxxxx" style="font-size:12px"></div>'
    +'<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">'
    +'<button class="btn btn-p btn-sm" onclick="saveCloudUrl()">ğŸ’¾ Saqlash</button>'
    +'<button class="btn btn-s btn-sm" onclick="testCloud()">ğŸ” Test</button>'
    +'<button class="btn btn-s btn-sm" onclick="pushAllToCloud()">â¬† Hamma ma\'lumotni yuklash</button>'
    +'</div>'
    +'<div style="background:var(--card-s);border:1px solid var(--brd2);border-radius:var(--radius);padding:12px;margin-bottom:14px">'
    +'<div style="font-size:11px;font-weight:700;color:var(--t0);margin-bottom:6px">ğŸ“‹ Sozlash qadamlari:</div>'
    +'<div style="font-size:10px;color:var(--t2);line-height:1.6">'
    +'1. <a href="https://www.npoint.io/" target="_blank" style="color:var(--ac);text-decoration:underline">npoint.io</a> ga o\'ting<br>'
    +'2. "Create JSON Bin" bosing â†’ <code>{}</code> yozing â†’ "Save" bosing<br>'
    +'3. API URL ni nusxalang (masalan: https://api.npoint.io/abc123)<br>'
    +'4. Yuqoridagi maydonga joylang va "Saqlash" bosing<br>'
    +'5. "Hamma ma\'lumotni yuklash" bosing â€” tamom! âœ…'
    +'</div></div>'
    +'<hr style="margin:16px 0;border:none;border-top:1px solid var(--brd2)">'
    +'<div style="font-family:var(--ffd);font-size:18px;font-weight:800;color:var(--ac);margin-bottom:4px">\uD83E\uDD16 Suniy intellekt</div>'
    +'<div style="font-size:11px;color:var(--t2);margin-bottom:10px">Claude AI â€” ovozli assistent uchun aqlli javoblar</div>'
    +'<div class="fg"><label class="fl">Anthropic API kalit</label><input class="fi" id="aiKeyInp" type="password" value="'+(_getAiKey()?'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢':'') +'" placeholder="sk-ant-api03-..." style="font-size:12px"></div>'
    +'<div style="display:flex;gap:6px;margin-bottom:8px">'
    +'<button class="btn btn-p btn-sm" onclick="saveAiKey()">ğŸ’¾ Saqlash</button>'
    +'<button class="btn btn-s btn-sm" onclick="testAi()">ğŸ” Test</button>'
    +'</div>'
    +'<div style="background:var(--card-s);border:1px solid var(--brd2);border-radius:var(--radius);padding:12px;margin-bottom:14px">'
    +'<div style="font-size:11px;font-weight:700;color:var(--t0);margin-bottom:6px">ğŸ“‹ AI sozlash:</div>'
    +'<div style="font-size:10px;color:var(--t2);line-height:1.6">'
    +'1. <a href="https://console.anthropic.com/" target="_blank" style="color:var(--ac);text-decoration:underline">console.anthropic.com</a> da hisob oching<br>'
    +'2. API Keys bo\'limidan kalit yarating<br>'
    +'3. Kalitni yuqoridagi maydonga joylang<br>'
    +'4. Yoki Netlify env: <code>ANTHROPIC_API_KEY</code> qo\'shing (xavfsizroq)'
    +'</div></div>'
    +'<hr style="margin:16px 0;border:none;border-top:1px solid var(--brd2)">'
    +'<div style="font-family:var(--ffd);font-size:15px;font-weight:800;color:var(--ac);margin-bottom:12px">ğŸ™ Azure Speech</div><div class="fg"><label class="fl">Azure Region</label><select class="fs" id="azReg" onchange="localStorage.setItem(\'azRegion\',this.value);AZ_REGION=this.value;azSpeechCfg=null;toast(\'Region yangilandi\',\'ok\')"><option value="eastus"'+(AZ_REGION==='eastus'?' selected':'')+'>East US</option><option value="westus"'+(AZ_REGION==='westus'?' selected':'')+'>West US</option><option value="westeurope"'+(AZ_REGION==='westeurope'?' selected':'')+'>West Europe</option><option value="southeastasia"'+(AZ_REGION==='southeastasia'?' selected':'')+'>Southeast Asia</option><option value="centralindia"'+(AZ_REGION==='centralindia'?' selected':'')+'>Central India</option><option value="eastasia"'+(AZ_REGION==='eastasia'?' selected':'')+'>East Asia</option><option value="northeurope"'+(AZ_REGION==='northeurope'?' selected':'')+'>North Europe</option><option value="uksouth"'+(AZ_REGION==='uksouth'?' selected':'')+'>UK South</option></select></div><div class="fg"><label class="fl">TTS Ovoz</label><select class="fs" id="azVoice" onchange="localStorage.setItem(\'azVoice\',this.value);azSpeechCfg=null;toast(\'Ovoz yangilandi\',\'ok\')"><option value="uz-UZ-MadinaNeural"'+((localStorage.getItem('azVoice')||'uz-UZ-MadinaNeural')==='uz-UZ-MadinaNeural'?' selected':'')+'>Madina (ayol)</option><option value="uz-UZ-SardorNeural"'+((localStorage.getItem('azVoice')||'')==='uz-UZ-SardorNeural'?' selected':'')+'>Sardor (erkak)</option></select></div><div class="fg"><label class="fl">Test</label><button class="btn btn-p btn-sm" onclick="vSpeak(\'Assalomu alaykum! Azure ovozli yordamchi ishlayapti.\')">ğŸ”Š Ovozni sinash</button></div>'
    +'<hr style="margin:16px 0;border:none;border-top:1px solid var(--brd2)"><div class="fg"><label class="fl">Qaytarish</label><button class="btn btn-d" onclick="resetAll()">Asl holatga</button></div><hr style="margin:16px 0;border:none;border-top:1px solid var(--brd2)"><div class="fg"><label class="fl">Eksport</label><button class="btn btn-s" onclick="expJ()">JSON</button></div><div class="fg"><label class="fl">Import</label><input type="file" accept=".json" onchange="impJ(this)" style="font-size:12px;color:var(--t1)"></div>'}
  lucide.createIcons()}
window.editLN=function(id){var l=fL(id);if(!l)return;var n=prompt("Nom:",l.name);if(n&&n.trim()){l.name=n.trim();save();admTab('leaders');toast('OK','ok')}};
window.doTr=function(){var ds=$('trD').value,tid=$('trT').value;if(!ds||!tid||!ds.includes('__')){toast("Tanlang",'er');return}var p=ds.split('__'),fl=p[0],did=p[1];if(fl===tid){toast("Xuddi shu",'er');return}var from=fL(fl),to=fL(tid);var idx=from.departments.findIndex(function(d){return d.id===did});if(idx===-1)return;to.departments.push(from.departments.splice(idx,1)[0]);save();admTab('transfer');toast("OK",'ok')};
window.addDp=function(){var lid=$('ndL').value,n=$('ndN').value.trim(),boss=$('ndBoss')?$('ndBoss').value.trim():'',bossRole=$('ndBossRole')?$('ndBossRole').value.trim():'';if(!n){toast("Nom!",'er');return}fL(lid).departments.push({id:'d_'+Date.now(),name:n,boss:boss||'',bossRole:bossRole||'',dashboards:[]});save();admTab('depts');toast("OK",'ok')};
window.editBoss=function(lid,did){var d=fDp(lid,did);if(!d)return;var n=prompt("Bo'lim boshlig'i (F.I.Sh):",d.boss||'');if(n===null)return;d.boss=n.trim();var r=prompt("Lavozimi:",d.bossRole||'');if(r!==null)d.bossRole=r.trim();save();admTab('depts');renderHome();toast("OK",'ok')};
window.renDp=function(lid,did){var d=fDp(lid,did);if(!d)return;var n=prompt("Nom:",d.name);if(n&&n.trim()){d.name=n.trim();save();admTab('depts');toast("OK",'ok')}};
window.delDp=function(lid,did){if(!confirm("O'chirish?"))return;fL(lid).departments=fL(lid).departments.filter(function(x){return x.id!==did});save();admTab('depts');toast("O'chirildi",'nf')};
window.renDb=function(l,d,db){var x=fDb(l,d,db);if(!x)return;var n=prompt("Nom:",x.name);if(n&&n.trim()){x.name=n.trim();save();admTab('dashs');toast("OK",'ok')}};
window.edPath=function(l,d,db){var x=fDb(l,d,db);if(!x)return;var n=prompt("Yo'l:",x.path||'');if(n!==null){x.path=n.trim();if(n.startsWith('http'))x.type='url';save();admTab('dashs');toast("OK",'ok')}};
window.delDb=function(l,d,db){var dp=fDp(l,d);if(!dp||!confirm("O'chirish?"))return;dp.dashboards=dp.dashboards.filter(function(b){return b.id!==db});save();admTab('dashs');toast("O'chirildi",'nf')};
window.doUp=function(){var ds=$('uDp').value,nm=$('uN').value.trim(),ty=$('uTy').value;if(!nm){toast("Nom!",'er');return}var p=ds.split('__'),dp=fDp(p[0],p[1]);if(!dp)return;var nd={id:'db_'+Date.now(),name:nm,type:ty,path:''};if(ty==='url')nd.path=$('uUr').value.trim();else{var fi=$('uFi');if(fi.files[0])nd.path=URL.createObjectURL(fi.files[0])}var xi=$('uXi');if(xi&&xi.files[0])nd.xl=URL.createObjectURL(xi.files[0]);dp.dashboards.push(nd);save();admTab('upload');toast("Qo'shildi!",'ok')};
window.resetAll=function(){if(!confirm("Davom?"))return;D=JSON.parse(JSON.stringify(INIT));save();go('home');closeAdm();toast("Qaytarildi",'nf')};
window.expJ=function(){var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(D,null,2)]));a.download='mb_data.json';a.click()};
window.impJ=function(inp){var f=inp.files[0];if(!f)return;var r=new FileReader();r.onload=function(e){try{D=JSON.parse(e.target.result);save();go('home');toast("OK",'ok')}catch(e){toast("Xato",'er')}};r.readAsText(f)};

/* â•â•â• BULUT BOSHQARISH â•â•â• */
function saveCloudUrl(){
  var url=($('cloudUrlInp')||{}).value||'';url=url.trim();
  if(url&&!url.startsWith('https://')){toast('URL https:// bilan boshlanishi kerak','er');return}
  localStorage.setItem('cloudUrl',url);CLOUD_URL=url;
  var ind=$('cloudInd');
  if(ind){ind.textContent=url?'â˜ Bulut ulangan':'âšª Bulut ulanmagan';ind.style.color=url?'#22c55e':'var(--t3)'}
  toast(url?'â˜ Bulut URL saqlandi':'âšª Bulut o\'chirildi','ok');
}
async function testCloud(){
  var url=_getCloudUrl();if(!url){toast('Avval URL kiriting','er');return}
  toast('ğŸ” Test...','nf');
  try{var r=await fetch(url+'?t='+Date.now());if(r.ok){var d=await r.json();toast('âœ… Bulut ishlayapti! '+(d.leaders?d.leaders.length+' rahbar':'Bo\'sh'),'ok')}else{toast('âŒ HTTP xato: '+r.status,'er')}}catch(e){toast('âŒ Ulanish xatosi: '+e.message,'er')}
}
async function pushAllToCloud(){
  var url=_getCloudUrl();if(!url){toast('Avval URL kiriting','er');return}
  toast('â¬† Yuklanmoqda...','nf');D._v=(D._v||0)+1;
  try{var r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(D)});
  if(r.ok){toast('âœ… Barcha ma\'lumot bulutga yuklandi (v'+D._v+')','ok');var ind=$('cloudInd');if(ind){ind.textContent='â˜ Sinxronlandi âœ“';ind.style.color='#22c55e'}}
  else{toast('âŒ Yuklash xatosi: '+r.status,'er')}}catch(e){toast('âŒ Xato: '+e.message,'er')}
}

/* â•â•â• AI KALIT BOSHQARISH â•â•â• */
function saveAiKey(){
  var inp=$('aiKeyInp');if(!inp)return;
  var key=inp.value.trim();
  if(key&&key.includes('â€¢â€¢'))return toast('Yangi kalit kiriting','er');
  if(key&&!key.startsWith('sk-')){toast('Kalit sk- bilan boshlanishi kerak','er');return}
  localStorage.setItem('aiApiKey',key);AI_KEY=key;
  toast(key?'ğŸ¤– AI kalit saqlandi':'âšª AI o\'chirildi','ok');
  if(key)inp.value='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
}
async function testAi(){
  var key=_getAiKey();
  if(!key){toast('Avval API kalit kiriting','er');return}
  toast('ğŸ¤– AI test...','nf');
  try{
    var r=await fetch('/api/ai',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({prompt:'Salom, sen kimsanva qisqacha javob ber',context:'Test so\'rov',apiKey:key})});
    if(r.ok){var d=await r.json();toast('âœ… AI ishlayapti: '+(d.text||'').slice(0,60),'ok')}
    else{var e=await r.json().catch(function(){return{}});toast('âŒ Xato: '+(e.error||r.status),'er')}
  }catch(e){toast('âŒ Ulanish xatosi: '+e.message,'er')}
}
/* Papka brauzeri â€” qidirish filtri */
window.fbFilter=function(q){
  q=q.toLowerCase();var tree=$('fbTree');if(!tree)return;
  tree.querySelectorAll('.ali').forEach(function(el){
    var nm=el.querySelector('.ali-nm');
    if(!nm)return;
    var match=!q||nm.textContent.toLowerCase().includes(q);
    el.style.display=match?'':'none';
    /* Agar topilsa â€” barcha parent dirlarni ochish */
    if(match&&q){var p=el.parentElement;while(p&&p!==tree){if(p.style.display==='none')p.style.display='';p=p.parentElement}}
  });
};
/* Papka brauzeri â€” yangi fayl qo'shish */
window.fbAddFiles=function(inp){
  if(!inp.files||!inp.files.length)return;
  /* Bo'limni tanlash uchun dialog */
  var opts=[];D.leaders.forEach(function(l){l.departments.forEach(function(d){opts.push({lid:l.id,did:d.id,label:l.name+' â†’ '+d.name})})});
  var sel=prompt('Qaysi bo\'limga qo\'shilsin?\n'+opts.map(function(o,i){return (i+1)+'. '+o.label}).join('\n'),'1');
  if(!sel)return;var idx=parseInt(sel)-1;if(idx<0||idx>=opts.length){toast("Noto'g'ri",'er');return}
  var target=opts[idx];var dp=fDp(target.lid,target.did);if(!dp)return;
  Array.from(inp.files).forEach(function(f){
    var ext=f.name.split('.').pop().toLowerCase();
    var ty=ext==='xlsx'||ext==='xls'?'excel':'html';
    var blobUrl=URL.createObjectURL(f);
    dp.dashboards.push({id:'db_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),name:f.name.replace(/\.[^.]+$/,''),type:ty,path:blobUrl});
    toast(f.name+' qo\'shildi!','ok');
  });
  save();admTab('files');
};
/* â•â•â• YANGI DASHBOARD QO'SHISH MODALI â•â•â• */
var _adSession={};/* Sessiya xotira: html kontent yoki excel binary */

window.openAddDash=function(lid,did){
  var ov=$('addDbOv');ov.style.display='';
  setTimeout(function(){ov.classList.add('on')},10);
  /* Bo'limlar ro'yxatini to'ldirish */
  var sel=$('adDept');sel.innerHTML='';
  D.leaders.forEach(function(l){l.departments.forEach(function(d){
    var opt=document.createElement('option');
    opt.value=l.id+'__'+d.id;
    opt.textContent=l.name.split(' ').pop()+' â†’ '+d.name;
    if(l.id===lid&&d.id===did)opt.selected=true;
    sel.appendChild(opt);
  })});
  /* Formani tozalash */
  $('adName').value='';$('adType').value='html';
  $('adPath').value='';$('adXl').value='';$('adUrl').value='';
  adTypeChg();_adSession={};
  lucide.createIcons();
};
window.closeAddDash=function(){
  var ov=$('addDbOv');ov.classList.remove('on');
  setTimeout(function(){ov.style.display='none'},300);
};
window.adTypeChg=function(){
  var ty=$('adType').value;
  $('adUrlFg').style.display=ty==='url'?'':'none';
  $('adFileFg').style.display=ty==='url'?'none':'';
};

/* Modal ichida fayl tanlash */
window.adBrowse=function(type,method){
  if(method==='file'){
    var inp=document.createElement('input');inp.type='file';
    inp.accept=type==='excel'?'.xlsx,.xls':'.html,.htm';
    inp.onchange=function(){if(inp.files&&inp.files[0])adStoreFile(inp.files[0],type)};
    inp.click();
  }else if(method==='folder'){
    var inp2=document.createElement('input');inp2.type='file';
    inp2.setAttribute('webkitdirectory','');inp2.setAttribute('directory','');
    inp2.onchange=function(){
      if(!inp2.files||!inp2.files.length)return;
      var exts=type==='excel'?['.xlsx','.xls']:['.html','.htm'];
      var matched=Array.from(inp2.files).filter(function(f){return exts.some(function(e){return f.name.toLowerCase().endsWith(e)})});
      if(!matched.length){toast('Mos fayl topilmadi','er');return}
      if(matched.length===1){adStoreFile(matched[0],type);return}
      /* Tanlash dialogi */
      var html='<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:10001;display:flex;align-items:center;justify-content:center" id="adFpOv">'
        +'<div style="background:var(--card-s);border-radius:var(--radius-lg);padding:20px;max-width:500px;width:90%;max-height:70vh;overflow-y:auto;box-shadow:var(--shadow-h)">'
        +'<div style="font-family:var(--ffd);font-size:16px;font-weight:800;color:var(--t0);margin-bottom:14px">ğŸ“ '+matched.length+' ta fayl topildi</div>';
      matched.forEach(function(f,i){
        html+='<div class="ali" style="margin-bottom:4px;cursor:pointer" onclick="adFpPick('+i+',\''+type+'\')">'
          +'<div style="display:flex;align-items:center;gap:8px"><span>'+(type==='excel'?'ğŸ“Š':'ğŸŒ')+'</span>'
          +'<div><div class="ali-nm" style="font-size:12px">'+f.name+'</div>'
          +'<div class="ali-mt" style="font-size:9px">'+f.webkitRelativePath+'</div></div></div></div>';
      });
      html+='<button class="btn btn-s btn-sm" onclick="$(\'adFpOv\').remove()" style="margin-top:10px">Yopish</button></div></div>';
      document.body.insertAdjacentHTML('beforeend',html);
      window._adFpFiles=matched;
    };
    inp2.click();
  }else if(method==='zip'){
    var inp3=document.createElement('input');inp3.type='file';inp3.accept='.zip';
    inp3.onchange=async function(){
      if(!inp3.files||!inp3.files[0])return;
      toast('ZIP ochilmoqda...','nf');
      try{
        var ab=await inp3.files[0].arrayBuffer();
        var entries=await readZipEntries(ab);
        var exts=type==='excel'?['.xlsx','.xls']:['.html','.htm'];
        var matched=entries.filter(function(e){return exts.some(function(x){return e.name.toLowerCase().endsWith(x)})});
        if(!matched.length){toast('ZIP da mos fayl topilmadi','er');return}
        var html='<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:10001;display:flex;align-items:center;justify-content:center" id="adZpOv">'
          +'<div style="background:var(--card-s);border-radius:var(--radius-lg);padding:20px;max-width:560px;width:90%;max-height:70vh;overflow-y:auto;box-shadow:var(--shadow-h)">'
          +'<div style="font-family:var(--ffd);font-size:16px;font-weight:800;color:var(--t0);margin-bottom:14px">ğŸ“¦ '+matched.length+' ta fayl</div>';
        matched.forEach(function(e,i){
          var nm=e.name.split('/').pop();
          html+='<div class="ali" style="margin-bottom:4px;cursor:pointer" onclick="adZpPick('+i+',\''+type+'\')">'
            +'<div style="display:flex;align-items:center;gap:8px"><span>'+(type==='excel'?'ğŸ“Š':'ğŸŒ')+'</span>'
            +'<div><div class="ali-nm" style="font-size:12px">'+nm+'</div>'
            +'<div class="ali-mt" style="font-size:9px;word-break:break-all">'+e.name+'</div></div></div></div>';
        });
        html+='<button class="btn btn-s btn-sm" onclick="$(\'adZpOv\').remove()" style="margin-top:10px">Yopish</button></div></div>';
        document.body.insertAdjacentHTML('beforeend',html);
        window._adZpEntries=matched;
      }catch(e){toast('ZIP xato: '+e.message,'er')}
    };
    inp3.click();
  }
};
window.adFpPick=function(idx,type){
  var f=window._adFpFiles[idx];if(f)adStoreFile(f,type);
  var ov=$('adFpOv');if(ov)ov.remove();
};
window.adZpPick=async function(idx,type){
  var e=window._adZpEntries[idx];if(!e)return;
  try{
    var blob=await e.getData();
    var f=new File([blob],e.name.split('/').pop());
    adStoreFile(f,type);
  }catch(err){toast('Xato: '+err.message,'er')}
  var ov=$('adZpOv');if(ov)ov.remove();
};

/* Faylni sessiyaga saqlash va input ga nomini yozish */
function adStoreFile(file,type){
  var reader=new FileReader();
  reader.onload=function(e){
    if(type==='excel'){
      _adSession.xlData=new Uint8Array(e.target.result);
      _adSession.xlName=file.name;
      $('adXl').value=file.name;
      /* Agar turi excel bo'lsa, path ga ham yozish */
      if($('adType').value==='excel'){
        _adSession.pathData=_adSession.xlData;
        _adSession.pathName=file.name;
        _adSession.pathType='excel';
        $('adPath').value=file.name;
      }
    }else{
      _adSession.htmlData=e.target.result;
      _adSession.pathName=file.name;
      _adSession.pathType='html';
      $('adPath').value=file.name;
      /* Agar nom hali bo'sh bo'lsa â€” fayl nomidan olish */
      if(!$('adName').value.trim()){
        $('adName').value=file.name.replace(/\.[^.]+$/,'').replace(/[_-]/g,' ');
      }
    }
    toast(file.name+' tanlandi','ok');
  };
  if(type==='excel')reader.readAsArrayBuffer(file);
  else reader.readAsText(file);
}

/* Yangi dashboard saqlash */
window.saveAddDash=function(){
  var nm=$('adName').value.trim();
  if(!nm){toast('Dashboard nomini kiriting!','er');$('adName').focus();return}
  var ty=$('adType').value;
  var deptVal=$('adDept').value;
  var p=deptVal.split('__');
  var dp=fDp(p[0],p[1]);
  if(!dp){toast('Bo\'lim topilmadi','er');return}

  var nd={id:'db_'+Date.now(),name:nm,type:ty,path:''};

  if(ty==='url'){
    nd.path=$('adUrl').value.trim();
    if(!nd.path){toast('URL kiriting!','er');return}
  }else if(ty==='excel'){
    if(_adSession.xlData){
      nd._xlCache=_adSession.xlData;
      nd.path=_adSession.xlName||'excel_file.xlsx';
    }else{toast('Excel faylni tanlang!','er');return}
  }else{
    /* HTML */
    if(_adSession.htmlData){
      nd._htmlCache=_adSession.htmlData;
      nd.path=_adSession.pathName||'dashboard.html';
    }else if($('adPath').value.trim()){
      nd.path=$('adPath').value.trim();
    }else{toast('HTML faylni tanlang!','er');return}
    /* Excel (ixtiyoriy) */
    if(_adSession.xlData){
      nd.xl=_adSession.xlName||'data.xlsx';
      nd._xlCache=_adSession.xlData;
    }
  }

  dp.dashboards.push(nd);save();
  closeAddDash();
  toast(nm+' qo\'shildi!','ok');
  /* Agar hozir bo'lim sahifasida bo'lsa â€” yangilash */
  if(_curView==='dept'){renderDept(p[0],p[1])}
  lucide.createIcons();
};

function toast(msg,t){t=t||'nf';var c=$('toasts'),el=document.createElement('div');el.className='toast '+t;el.innerHTML='<span>'+(t==='ok'?'âœ“':t==='er'?'âœ•':'â„¹')+'</span><span>'+msg+'</span>';c.appendChild(el);setTimeout(function(){el.style.opacity='0';el.style.transform='translateX(16px)';el.style.transition='all .3s';setTimeout(function(){el.remove()},300)},3500)}

/* â”€â”€ VOICE â€” AZURE SPEECH SDK â”€â”€ */
var vAct=false,azRecognizer=null,azSynthesizer=null,azSpeechCfg=null,azAudioCfg=null;
var vMuted=false; /* Ovozni o'chirish holati */
var AZ_KEY='1XBh7tnZOwcd7uI1kGu8at1gkys1aBIIRiYwQ5Dn7dxszAMShYVqJQQJ99CAACYeBjFXJ3w3AAAYACOGcO7v';
var AZ_REGION=localStorage.getItem('azRegion')||'eastus';

function initAzure(){
  if(azSpeechCfg)return true;
  if(typeof SpeechSDK==='undefined'){vMsg('bot','âš  Azure SDK yuklanmadi. Internet aloqasini tekshiring.');return false}
  try{
    azSpeechCfg=SpeechSDK.SpeechConfig.fromSubscription(AZ_KEY,AZ_REGION);
    /* STT: O'zbek + Rus tilini avtomatik aniqlash */
    azSpeechCfg.speechRecognitionLanguage='uz-UZ';
    /* TTS: O'zbek ovozi */
    azSpeechCfg.speechSynthesisVoiceName=localStorage.getItem('azVoice')||'uz-UZ-MadinaNeural';
    azSpeechCfg.speechSynthesisLanguage='uz-UZ';
    /* Audio output â€” brauzer speaker */
    var audioOut=SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
    azSynthesizer=new SpeechSDK.SpeechSynthesizer(azSpeechCfg,audioOut);
    return true;
  }catch(e){vMsg('bot','âš  Azure xato: '+e.message);return false}
}

function startV(){
  if(!initAzure())return;
  /* Agar _stopRecognizer faol bo'lsa, to'xtatish */
  _stopStopListener();
  vAct=true;
  $('vFab').classList.add('mic-on');
  $('vWave').style.display='flex';
  $('vSt').textContent='Tinglayapman...';

  /* Har safar yangi AudioConfig â€” mikrofon uchun */
  var micCfg=SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();

  /* Avtomatik til aniqlash: uz-UZ va ru-RU */
  var autoLangCfg=SpeechSDK.AutoDetectSourceLanguageConfig.fromLanguages(['uz-UZ','ru-RU']);
  azRecognizer=SpeechSDK.SpeechRecognizer.FromConfig(azSpeechCfg,autoLangCfg,micCfg);

  /* Recognizing â€” interim natijalar (foydalanuvchi ko'radi) */
  azRecognizer.recognizing=function(s,e){
    if(e.result.text)$('vSt').textContent=e.result.text;
  };

  /* Recognized â€” yakuniy natija */
  azRecognizer.recognized=function(s,e){
    if(e.result.reason===SpeechSDK.ResultReason.RecognizedSpeech){
      var txt=e.result.text.toLowerCase().replace(/[.!?,;:]/g,'').trim();
      if(txt){
        vMsg('usr',txt);
        procV(txt);
      }
    }
    /* NoMatch â€” davom etadi, hech narsa qilmaslik */
  };

  /* Xato */
  azRecognizer.canceled=function(s,e){
    if(e.reason===SpeechSDK.CancellationReason.Error){
      console.error('Azure STT xato:',e.errorDetails);
      if(e.errorDetails&&e.errorDetails.includes('401')){
        vMsg('bot','âš  Azure kalit eskirgan yoki noto\'g\'ri.');
      }else{
        vMsg('bot','âš  Xato: '+e.errorDetails);
      }
    }
    stopV();
  };

  /* SessionStopped */
  azRecognizer.sessionStopped=function(){stopV()};

  /* â•â•â• CONTINUOUS RECOGNITION â€” doimiy tinglash â•â•â• */
  azRecognizer.startContinuousRecognitionAsync(
    function(){
      console.log('Continuous recognition started');
      $('vSt').textContent='ğŸ™ Tinglayapman...';
    },
    function(err){
      console.error('Azure STT error:',err);
      vMsg('bot','âš  Mikrofon xatosi. Ruxsat bering.');
      stopV();
    }
  );
}

function stopV(){
  vAct=false;
  var fab=$('vFab');if(fab)fab.classList.remove('mic-on');
  var wave=$('vWave');if(wave)wave.style.display='none';
  var st=$('vSt');if(st)st.textContent='Tayyor';
  if(azRecognizer){
    try{azRecognizer.stopContinuousRecognitionAsync(
      function(){try{azRecognizer.close()}catch(e){}azRecognizer=null},
      function(){try{azRecognizer.close()}catch(e){}azRecognizer=null}
    )}catch(e){azRecognizer=null}
  }
}

function toggleVC(){var p=$('vPanel');if(vSpeaking){vUserStop();return}if(vAct){stopV();p.classList.remove('on')}else{p.classList.add('on');startV()}}

/* TTS â€” O'zbek tilida ovozli javob */
/* â•â•â• TTS MATN PREPROCESSOR v2 â€” fonetik, sonlar, sanalar, tire â•â•â• */
function ttsPreprocess(text){
  var s=text;

  /* â•â•â• 0. MAXSUS QISQARTMALAR â€” avval almashtirish â•â•â• */
  s=s.replace(/\bMB\b/g,'Markaziy bank');
  s=s.replace(/\btrln\b/gi,'trillion');
  s=s.replace(/\bmlrd\b/gi,'milliard');
  s=s.replace(/\bmln\b/gi,'million');
  s=s.replace(/\bkm\/h\b/gi,'kilometr soatiga');
  s=s.replace(/\bkm\/s\b/gi,'kilometr soniyasiga');

  /* â•â•â• 1. QISQARTMALAR â€” harflab o'qish (O'zbek fonetikasi) â•â•â• */
  var abbrPronounce={
    'TBC':'Ti Bi Si','NPL':'En Pi El','IT':'Ay Ti',
    'CEO':'Si I O','CFO':'Si Ef O','CTO':'Si Ti O',
    'BRB':'Bi Ar Bi','GDP':'Ji Di Pi','IMF':'Ay Em Ef',
    'API':'Ey Pi Ay','ISO':'Ay Es O','BYD':'Bi Uay Di',
    'MHXS':'Em Eych Iks Es','ATM':'Ey Ti Em',
    'SMS':'Es Em Es','QR':'Kyu Ar','PIN':'Pin',
    'SWIFT':'Svift','HTML':'Eych Ti Em El',
    'PDF':'Pi Di Ef','USB':'Yu Es Bi','GPS':'Ji Pi Es',
    'AI':'Ey Ay','VPN':'Vi Pi En','URL':'Yu Ar El',
    'MFO':'Em Ef O','UzCard':'Uz kard','JSCB':'Jey Es Si Bi'
  };
  Object.keys(abbrPronounce).forEach(function(k){
    var re=new RegExp('\\b'+k+'\\b','g');
    s=s.replace(re, abbrPronounce[k]);
  });

  /* Qolgan qisqartmalar (2-6 katta harfdan iborat) â€” avtomatik harflab */
  var letterMap={
    'A':'Ey','B':'Bi','C':'Si','D':'Di','E':'I','F':'Ef',
    'G':'Ji','H':'Eych','I':'Ay','J':'Jey','K':'Key','L':'El',
    'M':'Em','N':'En','O':'O','P':'Pi','Q':'Kyu','R':'Ar',
    'S':'Es','T':'Ti','U':'Yu','V':'Vi','W':'Dablyu','X':'Iks',
    'Y':'Uay','Z':'Zet'
  };
  s=s.replace(/\b([A-Z]{2,6})\b/g,function(m){
    return m.split('').map(function(c){return letterMap[c]||c}).join(' ');
  });

  /* â•â•â• 2. INGLIZCHA SO'ZLAR â€” O'zbekcha fonetik transliteratsiya â•â•â• */
  var engToUz={
    'Alliance':'Allayans','Digital':'Dijital','Online':'Onlayn',
    'Mobile':'Mobayl','Fintech':'Fintek','Blockchain':'Blokcheyn',
    'Crypto':'Kripto','Bitcoin':'Bitkoin','Dashboard':'Deshbord',
    'Cloud':'Klaud','Software':'Softver','Hardware':'Xardver',
    'Investment':'Investmant','Payment':'Peymant','Insurance':'Insurans',
    'Compliance':'Komplayans','Management':'Menejment',
    'Director':'Direktor','Manager':'Menejer',
    'WhatsApp':'Votsapp','iPhone':'Ayfon','Apple':'Eppl','Google':'Gugl',
    'Mastercard':'Masterkard','Excel':'Eksel','Scoring':'Skoring',
    'Generation':'Jenereshon','Green':'Grin',
    'Asia':'Osiya','Credit':'Kredit','Deposit':'Depozit',
    'Transfer':'Transfer','Bank':'Bank','Risk':'Risk',
    'Samsung':'Samsung','Telegram':'Telegram','Android':'Android',
    'Visa':'Viza','Humo':'Humo','Basel':'Bazel','Bazel':'Bazel',
    'Audit':'Odit','Report':'Riport','Rating':'Reyting',
    'System':'Sistem','Update':'Apdeyt','Security':'Sekyuriti'
  };
  Object.keys(engToUz).forEach(function(k){
    var re=new RegExp('\\b'+k+'\\b','gi');
    s=s.replace(re, engToUz[k]);
  });

  /* Qolgan inglizcha so'zlarni avtomatik transliteratsiya */
  var uzSkip='dan,lar,ning,dagi,bilan,uchun,haqida,orqali,kabi,ham,esa,yoki,shu,bir,har,barcha,yangi,katta,kichik,yaxshi,yomon,bosh,eng,juda,soat,kun,oy,yil,deb,etib,qilib,oldi,berdi,keldi,butun,foiz,gradus,dollar,yevro,rubl,trillion,milliard,million,ming,kilometr,soniyasiga,soatiga,chi,cha,xabar,tayinlandi,ishga,tushiradi,Allayans,Dijital,Onlayn,Svift,Deshbord,Bitkoin,Kripto,Fintek,Blokcheyn,Investmant,Peymant,Direktor,Menejer,Skoring,Jenereshon,Grin,Osiya,Votsapp,Ayfon,Eppl,Gugl,Masterkard,Eksel,Riport,Reyting,Sistem,Apdeyt,Sekyuriti,birinchi,ikkinchi,uchinchi,tortinchi,beshinchi,oltinchi,yettinchi,sakkizinchi,toqqizinchi,oninchi,yigirmanchi,ottizinchi,yigirma,ottiz';
  s=s.replace(/\b([A-Za-z]{3,})\b/g,function(m){
    if(uzSkip.toLowerCase().indexOf(m.toLowerCase())>=0) return m;
    return m.replace(/tion/gi,'shon').replace(/sion/gi,'shon')
      .replace(/ght/gi,'t').replace(/ous/gi,'as')
      .replace(/ph/gi,'f').replace(/th/gi,'t')
      .replace(/ck/gi,'k').replace(/wh/gi,'v')
      .replace(/ce/gi,'se').replace(/ci/gi,'si');
  });

  /* â•â•â• 3. SONLAR â•â•â• */
  /* Kasrli: 35,2 â†’ "35 butun 2" */
  s=s.replace(/(\d+),(\d+)/g,'$1 butun $2');
  /* Ming ajratuvchi: 1.200.000 â†’ 1200000 */
  s=s.replace(/(\d+)\.(\d{3})\.(\d{3})/g,'$1$2$3');
  s=s.replace(/(\d+)\.(\d{3})/g,'$1$2');

  /* â•â•â• 4. SANALAR â€” tartib sonlari bilan (uchinchi, o'ninchi) â•â•â• */
  /* O'zbek tartib sonlari funksiyasi */
  function dateOrd(n){
    var birlar=['','birinchi','ikkinchi','uchinchi','to\'rtinchi','beshinchi','oltinchi','yettinchi','sakkizinchi','to\'qqizinchi'];
    var onlarAlone={10:'o\'ninchi',20:'yigirmanchi',30:'o\'ttizinchi'};
    var onlar={1:'o\'n',2:'yigirma',3:'o\'ttiz'};
    n=parseInt(n,10);
    if(isNaN(n)||n<1||n>31)return n+'';
    if(onlarAlone[n])return onlarAlone[n];
    if(n<10)return birlar[n];
    var t=Math.floor(n/10), o=n%10;
    return (onlar[t]||'')+(o?' '+birlar[o]:'');
  }

  /* Vaqt formati: 10:00 â†’ soat o'n, 10:30 â†’ soat o'n yarim */
  /* "soat 10:00" â†’ "soat 10" (dublikat oldini olish) */
  s=s.replace(/(soat\s+)?(\d{1,2}):(\d{2})/gi,function(m,pre,h,min){
    var mi=parseInt(min,10);
    var prefix=pre?'soat ':'soat ';
    if(mi===0) return prefix+h;
    if(mi===30) return prefix+h+' yarim';
    return prefix+h+' '+mi;
  });

  /* Kun + oy (tireli): 28-yanvardan â†’ yigirma sakkizinchi yanvardan */
  var oylar='yanvar|fevral|mart|aprel|may|iyun|iyul|avgust|sentyabr|oktyabr|noyabr|dekabr';
  var oyRe=new RegExp('(\\d{1,2})[\\s-]*('+oylar+')([a-z]*)','gi');
  s=s.replace(oyRe, function(m,d,month,suf){
    return dateOrd(d)+' '+month+(suf||'');
  });

  /* Oy nomlari qisqartmalari ham: Yan, Fev, Mar... */
  var oyQisqa='Yan|Fev|Mar|Apr|May|Iyn|Iyl|Avg|Sen|Okt|Noy|Dek';
  var oyQMap={'Yan':'yanvar','Fev':'fevral','Mar':'mart','Apr':'aprel','May':'may','Iyn':'iyun','Iyl':'iyul','Avg':'avgust','Sen':'sentyabr','Okt':'oktyabr','Noy':'noyabr','Dek':'dekabr'};
  var oyQRe=new RegExp('(\\d{1,2})[\\s-]*('+oyQisqa+')\\b','gi');
  s=s.replace(oyQRe, function(m,d,mon){
    var fullMon=oyQMap[mon.charAt(0).toUpperCase()+mon.slice(1).toLowerCase()]||mon;
    return dateOrd(d)+' '+fullMon;
  });

  /* Sana qo'shimchalari: 28-dan â†’ yigirma sakkizinchi dan */
  s=s.replace(/(\d{1,2})-(dan|ga|da|gacha|ning|dagi)/gi,function(m,d,suf){
    return dateOrd(d)+' '+suf;
  });

  /* Yil: 2026-yil â†’ ikki ming yigirma oltinchi yil */
  s=s.replace(/(\d{4})-(yil[a-z]*)/gi,'$1 $2');
  /* Son oraliq: 2025-2026 â†’ 2025 dan 2026 */
  s=s.replace(/(\d{4})-(\d{4})/g,'$1 dan $2');

  /* â•â•â• 5. TIRE VA BELGILAR â€” to'liq tozalash â•â•â• */
  s=s.replace(/\s*â€”\s*/g,', ');
  s=s.replace(/\s*â€“\s*/g,', ');
  s=s.replace(/\s+-\s+/g,', ');
  s=s.replace(/^\s*-\s+/gm,' ');
  s=s.replace(/([a-zA-Z\u0400-\u04FF])-([a-zA-Z\u0400-\u04FF])/g,'$1 $2');

  /* â•â•â• 6. MAXSUS BELGILAR â•â•â• */
  s=s.replace(/Â°C/g,' gradus selsiy ');
  s=s.replace(/Â°/g,' gradus ');
  s=s.replace(/%/g,' foiz');
  s=s.replace(/\$/g,' dollar ');
  s=s.replace(/â‚¬/g,' yevro ');
  s=s.replace(/â‚½/g,' rubl ');
  s=s.replace(/Â·/g,', ');

  /* â•â•â• IKKI NUQTA (:) â€” to'liq olib tashlash â•â•â• */
  /* Vaqt allaqachon yuqorida HH MM ga o'zgartirildi */
  /* Qolgan barcha : belgilarini olib tashlash (oh oh deb o'qimaslik uchun) */
  s=s.replace(/:/g,' ');

  s=s.replace(/[Â«Â»""â€â€Ÿ]/g,'');
  s=s.replace(/[()[\]{}]/g,' ');
  s=s.replace(/\//g,' ');

  /* Emoji va maxsus unicode belgilarni olib tashlash */
  s=s.replace(/[\u{1F300}-\u{1F9FF}]/gu,'');
  s=s.replace(/[âš¡â­âœ…âŒâš ï¸ğŸ“ŠğŸ“ˆğŸ“‰ğŸ”ŠğŸ”‡ğŸ™ï¸â˜ï¸â¬†ï¸ğŸ”ğŸ’¾ğŸ“‹ğŸ“ğŸ“â¹ï¸âœ“âœ•â„¹ï¸ğŸ”“ğŸ“¦â›…ğŸŒ¤ï¸â˜€ï¸ğŸŒ§ï¸â„ï¸ğŸŒ«ï¸â›ˆï¸ğŸŒ¦ï¸ğŸŒğŸ’¨ğŸŒ©ï¸ğŸŒ¨ï¸ğŸŒªï¸â˜”ğŸŒ¬ï¸ğŸ’â­•]/g,'');
  s=s.replace(/[â˜…â˜†â—â—‹â—†â—‡â–¶â–·â–ºâ–»â– â–¡â–ªâ–«â–²â–³â–¼â–½â—€â—â—„â—ƒâ™¦â™ â™£â™¥â™¡]/g,'');

  /* Bo'sh joylarni tozalash */
  s=s.replace(/\s{2,}/g,' ').trim();

  return s;
}

/* â•â•â• SSML yaratish â€” soddalashtirilgan (fonetik matn, <lang> tag shart emas) â•â•â• */
function buildSsml(text,voiceName){
  var processed=ttsPreprocess(text);
  /* XML escape â€” SSML uchun xavfsiz qilish */
  var body=processed.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return '<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="uz-UZ">'
    +'<voice name="'+voiceName+'">'
    +'<prosody rate="0%">'+body+'</prosody>'
    +'</voice></speak>';
}

/* â•â•â• TTS TO'XTATISH TIZIMI â•â•â• */
var vSpeaking=false;  /* Hozir gapiryaptimi? */
var _stopRecognizer=null; /* "To'xta" buyrug'ini tinglash uchun */

/* Joriy nutqni to'xtatish */
function vStopSpeech(){
  vSpeaking=false;
  _stopStopListener();
  var btn=$('vStopBtn');if(btn)btn.style.display='none';
  if(azSynthesizer){
    try{
      azSynthesizer.close();
      /* Yangi synthesizer yaratish */
      var audioOut=SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
      azSynthesizer=new SpeechSDK.SpeechSynthesizer(azSpeechCfg,audioOut);
    }catch(e){}
  }
}

/* Foydalanuvchi to'xtatish â€” visual feedback bilan */
function vUserStop(){
  vStopSpeech();
  var log=$('vLog');
  if(log){var m=document.createElement('div');m.className='vmsg bot';m.textContent='â¹ To\'xtatildi';log.appendChild(m);log.scrollTop=log.scrollHeight}
}

/* TTS davomida "to'xta" buyrug'ini tinglash â€” continuous recognition */
function _startStopListener(){
  /* Agar asosiy recognizer ishlayotgan bo'lsa, u orqali to'xtatish mumkin */
  if(azRecognizer&&vAct)return;
  if(!initAzure())return;
  try{
    var mic=SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
    var lang=SpeechSDK.AutoDetectSourceLanguageConfig.fromLanguages(['uz-UZ','ru-RU']);
    _stopRecognizer=SpeechSDK.SpeechRecognizer.FromConfig(azSpeechCfg,lang,mic);
    /* Interim natijalar â€” tez to'xtatish uchun */
    _stopRecognizer.recognizing=function(s,e){
      if(!vSpeaking)return;
      var t=(e.result.text||'').toLowerCase().replace(/[''Ê»Ê¼\u2019\u0027\u02BB\u02BC]/g,'');
      if(_isStopWord(t)){vUserStop();_stopStopListener()}
    };
    _stopRecognizer.recognized=function(s,e){
      if(!vSpeaking){_stopStopListener();return}
      if(e.result.reason===SpeechSDK.ResultReason.RecognizedSpeech){
        var t=e.result.text.toLowerCase().replace(/[''Ê»Ê¼\u2019\u0027\u02BB\u02BC]/g,'');
        if(_isStopWord(t)){vUserStop();_stopStopListener()}
      }
    };
    _stopRecognizer.canceled=function(){_stopStopListener()};
    _stopRecognizer.sessionStopped=function(){_stopStopListener()};
    _stopRecognizer.startContinuousRecognitionAsync(
      function(){console.log('Stop listener started')},
      function(e){console.warn('Stop listener error:',e)}
    );
  }catch(e){console.warn('Stop listener init error:',e)}
}
function _stopStopListener(){
  if(_stopRecognizer){
    try{_stopRecognizer.stopContinuousRecognitionAsync()}catch(e){}
    try{_stopRecognizer.close()}catch(e){}
    _stopRecognizer=null;
  }
}
function _isStopWord(t){
  return t.includes('toxta')||t.includes('toxtating')||t.includes('bas ')||t==='bas'||
    t.includes('jim')||t.includes('stop')||t.includes('yetarli')||t.includes('enough')||
    t.includes('Ñ‚Ğ¾Ñ…Ñ‚Ğ°')||t.includes('Ğ±Ğ°Ñ')||t.includes('ÑÑ‚Ğ¾Ğ¿');
}

function vSpeak(text){
  if(vMuted)return; /* Ovoz o'chirilgan */
  if(!initAzure()||!azSynthesizer)return;

  /* Gapirayotgan holatni belgilash */
  vSpeaking=true;
  var btn=$('vStopBtn');if(btn)btn.style.display='';

  var voiceName=localStorage.getItem('azVoice')||'uz-UZ-MadinaNeural';
  var ssml=buildSsml(text,voiceName);

  /* TTS davomida ovozli "to'xta" buyrug'ini tinglash */
  _startStopListener();

  azSynthesizer.speakSsmlAsync(ssml,
    function(result){
      vSpeaking=false;
      _stopStopListener();
      if(btn)btn.style.display='none';
      if(result.reason===SpeechSDK.ResultReason.Canceled){
        var detail=SpeechSDK.SpeechSynthesisCancellationDetails.fromResult(result);
        console.warn('TTS canceled:',detail.errorDetails);
      }
    },
    function(err){
      vSpeaking=false;
      _stopStopListener();
      if(btn)btn.style.display='none';
      console.error('TTS error:',err);
    }
  );
}

/* vMsg â€” ovozli javob bilan */
function vMsg(t,txt){
  var log=$('vLog'),m=document.createElement('div');
  m.className='vmsg '+t;m.textContent=txt;
  log.appendChild(m);log.scrollTop=log.scrollHeight;
  /* Bot javoblarini ovozda ham aytish */
  if(t==='bot'&&txt&&!txt.startsWith('âš '))vSpeak(txt);
}
/* â•â•â• OVOZLI MA'LUMOT FUNKSIYALARI â•â•â• */
var _monthMap={'Yan':1,'Fev':2,'Mar':3,'Apr':4,'May':5,'Iyn':6,'Iyl':7,'Avg':8,'Sen':9,'Okt':10,'Noy':11,'Dek':12};
var _monthNames={'Yan':'yanvar','Fev':'fevral','Mar':'mart','Apr':'aprel','May':'may','Iyn':'iyun','Iyl':'iyul','Avg':'avgust','Sen':'sentyabr','Okt':'oktyabr','Noy':'noyabr','Dek':'dekabr'};

function getMeetingsBrief(){
  if(!D.meetings||!D.meetings.length)return 'Uchrashuvlar yo\'q.';
  var now=new Date();
  var today=now.getDate(),todayM=now.getMonth()+1;
  var tmrw=new Date(now);tmrw.setDate(tmrw.getDate()+1);
  var tmrwD=tmrw.getDate(),tmrwM=tmrw.getMonth()+1;

  var todayMeets=[],tmrwMeets=[],upcomingMeets=[];
  D.meetings.forEach(function(m){
    var mMonth=_monthMap[m.month]||0;
    if(m.day===today&&mMonth===todayM)todayMeets.push(m);
    else if(m.day===tmrwD&&mMonth===tmrwM)tmrwMeets.push(m);
    else if(m.urgency!=='done'){
      /* Kelgusi uchrashuvlar */
      if(mMonth>todayM||(mMonth===todayM&&m.day>today))upcomingMeets.push(m);
    }
  });

  var parts=[];
  var tartibM=['Birinchi','Ikkinchi','Uchinchi','To\'rtinchi','Beshinchi','Oltinchi'];
  if(todayMeets.length){
    parts.push('Bugun '+todayMeets.length+' ta uchrashuv bor. ');
    todayMeets.forEach(function(m,i){
      parts.push((tartibM[i]||((i+1)+'-chi'))+': soat '+m.time+'da '+m.title+'. '+(m.urgency==='urgent'?'Bu muhim! ':''));
    });
  }else{
    parts.push('Bugun uchrashuvlar yo\'q. ');
  }

  if(tmrwMeets.length){
    parts.push('Ertaga '+tmrwMeets.length+' ta uchrashuv rejalashtirilgan. ');
    tmrwMeets.forEach(function(m,i){
      parts.push((tartibM[i]||((i+1)+'-chi'))+': soat '+m.time+'da '+m.title+'. ');
    });
  }

  if(upcomingMeets.length>0&&!todayMeets.length&&!tmrwMeets.length){
    var next=upcomingMeets[0];
    parts.push('Keyingi uchrashuv: '+next.day+' '+(_monthNames[next.month]||next.month)+' kuni soat '+next.time+'da, '+next.title+'. ');
  }

  /* Muhim uchrashuvlar ogohlantirish */
  var urgents=D.meetings.filter(function(m){return m.urgency==='urgent'&&m.urgency!=='done'});
  if(urgents.length){
    parts.push(urgents.length+' ta muhim uchrashuv bor.');
  }

  return parts.join('');
}

/* Bitta widget dan yangilik brief olish */
function _newsBrief(listId,srcName){
  var nl=$(listId);
  if(!nl)return '';
  var items=nl.querySelectorAll('.n-item');
  if(!items.length)return srcName+' yangiliklari yuklanmagan. ';
  var tartib=['Birinchi','Ikkinchi','Uchinchi','To\'rtinchi','Beshinchi'];
  var parts=[srcName+' yangiliklari. '];
  var count=Math.min(items.length,4);
  for(var i=0;i<count;i++){
    var txt=items[i].querySelector('.n-txt');
    if(txt)parts.push((tartib[i]||((i+1)+'-chi'))+' xabar: '+txt.textContent+'. ');
  }
  if(items.length>4)parts.push('Jami '+items.length+' ta yangilik.');
  return parts.join('');
}
function getNewsBriefB(){return _newsBrief('nListB','Bankers uz')}
function getNewsBriefK(){return _newsBrief('nListK','Kun uz')}
function getNewsBrief(){return getNewsBriefB()+' '+getNewsBriefK()}

function getWeatherBrief(){
  var temp=$('wTemp');
  var det=$('wDet');
  if(!temp||temp.textContent==='--Â°')return 'Ob-havo ma\'lumoti yuklanmagan.';
  /* Temperatura va tavsifni olish */
  var tempText=temp.textContent;
  /* Det ichidan birinchi div â€” asosiy tavsif */
  var desc='';
  if(det){
    var divs=det.querySelectorAll('div');
    if(divs[0])desc=divs[0].textContent; /* Masalan: "Qisman bulutli" */
    if(divs[1])desc+='. '+divs[1].textContent; /* Namlik va shamol */
  }
  return 'Toshkentda hozir '+tempText+'. '+desc+'.';
}

/* â•â•â• AVTOMATIK OGOHLANTIRISH â€” sahifa yuklanganda bugungi uchrashuvlar â•â•â• */
function checkMeetingAlerts(){
  if(!D.meetings||!D.meetings.length)return;
  var now=new Date();
  var today=now.getDate(),todayM=now.getMonth()+1;
  var tmrw=new Date(now);tmrw.setDate(tmrw.getDate()+1);
  var tmrwD=tmrw.getDate(),tmrwM=tmrw.getMonth()+1;
  var curHour=now.getHours(),curMin=now.getMinutes();

  var alerts=[];
  D.meetings.forEach(function(m){
    if(m.urgency==='done')return;
    var mMonth=_monthMap[m.month]||0;
    /* Bugungi uchrashuvlar */
    if(m.day===today&&mMonth===todayM){
      var tp=m.time.split(':');var mH=+tp[0]||0,mM=+tp[1]||0;
      var diffMin=(mH*60+mM)-(curHour*60+curMin);
      if(diffMin>0&&diffMin<=60){
        alerts.push('â° '+diffMin+' daqiqadan keyin: '+m.title+' (soat '+m.time+')');
      }else if(diffMin>60){
        alerts.push('ğŸ“… Bugun soat '+m.time+': '+m.title);
      }
    }
    /* Ertangi uchrashuvlar */
    if(m.day===tmrwD&&mMonth===tmrwM){
      alerts.push('ğŸ“‹ Ertaga soat '+m.time+': '+m.title);
    }
    /* Muhim uchrashuvlar yaqin kunlarda */
    if(m.urgency==='urgent'&&mMonth===todayM&&m.day>today&&m.day<=today+3&&m.day!==tmrwD){
      alerts.push('ğŸ”´ '+m.day+' '+(_monthNames[m.month]||m.month)+': '+m.title+' (MUHIM)');
    }
  });

  if(alerts.length){
    /* Bildirish toast */
    setTimeout(function(){
      toast('ğŸ“… '+alerts.length+' ta yaqin uchrashuv','nf');
    },2000);
    /* Ovozli ogohlantirish â€” 3 soniyadan keyin */
    setTimeout(function(){
      var msg='Assalomu alaykum! ';
      if(alerts.length===1){
        msg+=alerts[0].replace(/[â°ğŸ“…ğŸ“‹ğŸ”´]/g,'').trim();
      }else{
        msg+=alerts.length+' ta yaqin uchrashuv bor. ';
        alerts.slice(0,3).forEach(function(a){
          msg+=a.replace(/[â°ğŸ“…ğŸ“‹ğŸ”´]/g,'').trim()+'. ';
        });
      }
      vSpeak(msg);
      /* Chatga ham yozish */
      var log=$('vLog');
      if(log){
        alerts.forEach(function(a){
          var m2=document.createElement('div');m2.className='vmsg bot';m2.textContent=a;
          log.appendChild(m2);
        });
      }
    },3500);
  }
}

/* Sahifa yuklanganda uchrashuvlarni tekshirish */
setTimeout(checkMeetingAlerts,4000);
/* Har 15 daqiqada tekshirish */
setInterval(checkMeetingAlerts,900000);

function procV(txt){var t=txt.toLowerCase().replace(/[^\w\s\u0400-\u04FF\u0027\u2019]/g,'').trim();
  /* Apostrof/tutuq belgisini olib tashlash â€” "to'xta" â†’ "toxta" */
  var t2=t.replace(/[''Ê»Ê¼\u2019\u0027\u02BB\u02BC]/g,'');

  /* â•â•â• TTS DAVOMIDA â€” faqat TO'XTATISH buyruqlarini qabul qilish â•â•â• */
  if(vSpeaking){
    if(_isStopWord(t2)||t2.includes('ovozni ochir')||t2.includes('ovoz ochir')){
      vUserStop();
    }
    /* Boshqa buyruqlarni ignore qilish (TTS audio feedback) */
    return;
  }

  /* â•â•â• Fuzzy so'z solishtirish â•â•â• */
  function fuzzyMatch(a,b){
    if(a===b)return true;
    if(a.length<3||b.length<3)return a===b;
    /* Boshi bir xil (kamida 3 harf) â€” mos */
    if(a.length>=4&&b.length>=4&&a.slice(0,4)===b.slice(0,4))return true;
    if(a.length>=3&&b.length>=3&&a.slice(0,3)===b.slice(0,3)&&Math.abs(a.length-b.length)<=2)return true;
    /* Edit distance 2 dan kam */
    if(Math.abs(a.length-b.length)>3)return false;
    var d=0,ml=Math.min(a.length,b.length);
    for(var i=0;i<ml;i++){if(a[i]!==b[i])d++}
    d+=Math.abs(a.length-b.length);
    return d<=2;
  }

  /* Sinonimlar va o'xshash so'zlar jadvali */
  var aliases={
    'ergashev':'irgashev','Ğ¸Ñ€Ğ³Ğ°ÑˆĞµĞ²':'irgashev','irgashev':'irgashev',
    'nurullayev':'nuraliyev','Ğ½ÑƒÑ€Ğ°Ğ»Ğ¸ĞµĞ²':'nuraliyev','nuraliyev':'nuraliyev',
    'fayzullaxojayev':'fayzullaxojayev','fayzulla':'fayzullaxojayev',
    'jurayev':'jurayev','Ğ¶ÑƒÑ€Ğ°ĞµĞ²':'jurayev','jorayev':'jurayev',
    'boshqarma':'bosh boshqarma','boshlig':'bosh boshqarma boshlig',
    'rais':'bosh boshqarma boshlig','raisi':'bosh boshqarma boshlig',
    'boshliq':'bosh boshqarma boshlig'
  };

  /* So'zlarni normallashtirish */
  function norm(s){
    return s.toLowerCase().replace(/[''`\u2019\u0027.]/g,'').replace(/\s+/g,' ').trim();
  }

  /* â•â•â• 1. So'zlarni tayyorlash (BIRINCHI!) â•â•â• */
  var words=norm(t).split(/\s+/);
  var resolved=words.map(function(w){return aliases[w]||w});
  var tNorm=resolved.join(' ');

  /* â•â•â• 2. Oddiy buyruqlar â•â•â• */

  /* OVOZNI O'CHIRISH / YOQISH / TO'XTATISH */
  if(t2.includes('ovozni ochir')||t2.includes('ovoz ochir')||t2.includes('ovozni uchir')||t2.includes('ovoz uchir')||t2.includes('jim bol')||t2.includes('jimbol')||_isStopWord(t2)||t2.includes('mute')||t2.includes('ovozni toxtating')){
    vMuted=true;
    vStopSpeech();
    /* vMsg ga emas, to'g'ridan-to'g'ri chatga yozamiz (vSpeak chaqirilmasligi uchun) */
    var log=$('vLog'),m2=document.createElement('div');m2.className='vmsg bot';m2.textContent='ğŸ”‡ Ovoz o\'chirildi';log.appendChild(m2);log.scrollTop=log.scrollHeight;
    return;
  }
  if(t2.includes('ovozni yoq')||t2.includes('ovoz yoq')||t2.includes('ovozni och')||t2.includes('gapir')||t.includes('unmute')||t2.includes('ovozni qo')){
    vMuted=false;
    vMsg('bot','ğŸ”Š Ovoz yoqildi');
    return;
  }

  if(t.includes('bosh sahifa')||t.includes('home')||t.includes('asosiy')||t==='bosh'||t==='orqaga'){vMsg('bot','Bosh sahifa');go('home');return}

  /* â•â•â• UCHRASHUVLAR â€” bugungi va ertangi yig'ilishlar ovozda â•â•â• */
  if(t.includes('uchrashuv')||t.includes('yigilish')||t.includes('jadval')||t.includes('meeting')||t.includes('majlis')){
    go('meetings');
    var info=getMeetingsBrief();
    vMsg('bot',info);
    return;
  }

  /* â•â•â• YANGILIKLAR â€” manbaga qarab ovozda o'qish â•â•â• */
  if(t.includes('bankers')||t.includes('banker')){
    go('home');
    var newsText=getNewsBriefB();
    vMsg('bot',newsText);
    return;
  }
  if(t.includes('kun uz')||t.includes('kunuz')||t.includes('kun.uz')){
    go('home');
    var newsText=getNewsBriefK();
    vMsg('bot',newsText);
    return;
  }
  if(t.includes('yangilik')||t.includes('novost')||t.includes('news')||t.includes('axborot')){
    go('home');
    var newsText=getNewsBrief();
    vMsg('bot',newsText);
    return;
  }

  /* â•â•â• OB-HAVO â€” ob-havo ma'lumotini aytish â•â•â• */
  if(t.includes('ob havo')||t.includes('havo')||t.includes('pogoda')||t.includes('weather')||t.includes('temperatura')){
    go('home');
    var weatherText=getWeatherBrief();
    vMsg('bot',weatherText);
    return;
  }

  if(t.includes('sozlama')||t.includes('nastroyka')||t.includes('settings')||t.includes('admin')){vMsg('bot','Sozlamalar');go('settings');return}
  if(t.includes('kontakt')||t.includes('telefon')||t.includes('raqam')||t.includes('qongiroq')){
    /* Ism aytilganmi? */
    var contacts=getContacts();var foundC=null;
    for(var ci=0;ci<contacts.length;ci++){
      var cWords=norm(contacts[ci].name).split(/[\s.]+/).filter(function(w){return w.length>2});
      for(var wi=0;wi<words.length;wi++){
        for(var cwi=0;cwi<cWords.length;cwi++){
          if(fuzzyMatch(words[wi],cWords[cwi])){foundC=contacts[ci];break}
        }if(foundC)break;
      }if(foundC)break;
    }
    if(foundC){vMsg('bot','ğŸ“ '+foundC.name+': '+foundC.phone);window.open('tel:'+foundC.phone.replace(/\s/g,''));return}
    vMsg('bot','Kontaktlar');go('contacts');return;
  }

  /* â•â•â• 3. Bo'lim BOSHLIG'I familiyasi bo'yicha izlash (OLDIN!) â•â•â• */
  var bestBDept=null,bestBLead=null,bestBScore=0;
  for(var i=0;i<D.leaders.length;i++){var l=D.leaders[i];for(var j=0;j<l.departments.length;j++){var d=l.departments[j];
    if(!d.boss)continue;
    var bWords=norm(d.boss).split(/[\s.]+/).filter(function(w){return w.length>1});
    var sc=0;
    for(var wi=0;wi<words.length;wi++){
      for(var bi=0;bi<bWords.length;bi++){
        if(fuzzyMatch(words[wi],bWords[bi]))sc+=3;
        /* includes() ham tekshirish â€” qisqa familyalar uchun */
        else if(words[wi].length>=4&&bWords[bi].includes(words[wi]))sc+=2;
      }
    }
    if(sc>bestBScore){bestBScore=sc;bestBDept=d;bestBLead=l}
  }}
  if(bestBDept&&bestBScore>=3){
    vMsg('bot',bestBDept.boss+(bestBDept.bossRole?' â€” '+bestBDept.bossRole:''));
    go('dept',{lid:bestBLead.id,did:bestBDept.id});return;
  }

  /* â•â•â• 4. Rahbar izlash â€” ism bo'yicha â•â•â• */
  var bestLeader=null,bestLScore=0;
  for(var i=0;i<D.leaders.length;i++){
    var l=D.leaders[i];
    var lWords=norm(l.name).split(/[\s.]+/).filter(function(w){return w.length>1});
    var score=0;
    for(var wi=0;wi<words.length;wi++){
      for(var li=0;li<lWords.length;li++){
        if(fuzzyMatch(words[wi],lWords[li]))score+=3;
        else if(aliases[words[wi]]&&norm(l.name).includes(aliases[words[wi]]))score+=3;
      }
    }
    if(score>bestLScore){bestLScore=score;bestLeader=l}
  }

  /* â•â•â• 4. Rahbar izlash â€” lavozim bo'yicha â•â•â• */
  if(!bestLeader||bestLScore<3){
    var roleWords=['boshqarma','boshliq','boshlig','rais','orinbosar','direktor'];
    var hasRoleWord=roleWords.some(function(rw){return tNorm.includes(rw)});
    if(hasRoleWord){
      for(var i=0;i<D.leaders.length;i++){
        var l=D.leaders[i];
        var rNorm=norm(l.role);
        /* "bosh boshqarma boshlig'i" uchun maxsus */
        if((tNorm.includes('bosh boshqarma')||tNorm.includes('boshqarma boshlig'))
          &&rNorm.includes('bosh boshqarma boshlig')){bestLeader=l;bestLScore=10;break}
        /* "orinbosar" uchun */
        if(tNorm.includes('orinbosar')&&rNorm.includes('orinbosar')){
          /* Qaysi orinbosar? */
          var nameMatch=false;
          for(var wi=0;wi<words.length;wi++){
            var lw=norm(l.name).split(/[\s.]+/);
            for(var li=0;li<lw.length;li++){
              if(fuzzyMatch(words[wi],lw[li])){nameMatch=true;break}
            }
          }
          if(nameMatch){bestLeader=l;bestLScore=10;break}
        }
      }
    }
  }

  /* Agar "bo'lim" yoki "och" so'zi bor bo'lsa va rahbar topilgan â€” bo'limlar sahifasiga */
  if(bestLeader&&bestLScore>=3){
    /* "bo'limlarini och" yoki faqat ism aytildi */
    vMsg('bot',bestLeader.name);go('leader',{lid:bestLeader.id});return;
  }

  /* â•â•â• 5. Bo'lim izlash â•â•â• */
  var bestDept=null,bestDLeader=null,bestDScore=0;
  for(var i=0;i<D.leaders.length;i++){var l=D.leaders[i];for(var j=0;j<l.departments.length;j++){var d=l.departments[j];
    var dWords=norm(d.name).split(/[\s,]+/).filter(function(w){return w.length>3});
    var score=0;
    for(var wi=0;wi<words.length;wi++){
      for(var di=0;di<dWords.length;di++){
        if(fuzzyMatch(words[wi],dWords[di]))score+=2;
      }
    }
    if(score>bestDScore){bestDScore=score;bestDept=d;bestDLeader=l}
  }}
  if(bestDept&&bestDScore>=4){vMsg('bot',bestDept.name.slice(0,28));go('dept',{lid:bestDLeader.id,did:bestDept.id});return}

  /* â•â•â• 6. Dashboard izlash â•â•â• */
  /* Dashboard nomlari uchun maxsus aliaslar */
  var dbAliases={
    'scoring':'scoring banking','skoring':'scoring banking',
    'sirli':'sirli mijoz','mijoz':'sirli mijoz',
    'valyuta':'valyuta','eksport':'eksport-import','import':'eksport-import',
    'xpu':'valyuta xpu','hpu':'valyuta xpu',
    'npl':'npl','risk':'npl risk','rating':'npl risk rating',
    'sayt':'npl sayt','parkentsoy':'parkentsoy','parkentso':'parkentsoy',
    'tadbirkorlik':'tadbirkorlik monitoringi','tadbirkor':'tadbirkorlik',
    'banklar':'banklar tahlili','bank':'banklar tahlili',
    'mahalla':'mahallalar','mahallalar':'mahallalar tahlili',
    'kredit':'mahallalar tahlili','dastur':'mahallalar tahlili',
    'ijro':'ijro nazorati','nazorat':'ijro nazorati',
    'murojaat':'murojatlar','murojat':'murojatlar','murojaatlar':'murojatlar'
  };

  var bestDb=null,bestDbL=null,bestDbD=null,bestDbScore=0;
  for(var i=0;i<D.leaders.length;i++){var l=D.leaders[i];for(var j=0;j<l.departments.length;j++){var d=l.departments[j];for(var k=0;k<d.dashboards.length;k++){var db=d.dashboards[k];
    var dbNorm=norm(db.name);
    var dbWords=dbNorm.split(/[\s,\-_]+/).filter(function(w){return w.length>1});
    var score=0;

    for(var wi=0;wi<words.length;wi++){
      var w=words[wi];
      /* To'g'ridan-to'g'ri so'z mos */
      for(var di=0;di<dbWords.length;di++){
        if(fuzzyMatch(w,dbWords[di]))score+=3;
      }
      /* includes() â€” qisqa nomlar uchun (NPL, XPU) */
      if(w.length>=3&&dbNorm.includes(w))score+=2;
      /* Alias orqali */
      if(dbAliases[w]&&dbNorm.includes(dbAliases[w].split(' ')[0]))score+=3;
    }

    /* Butun matn ichida izlash â€” "murojatlar dashboard" â†’ mos */
    if(tNorm.length>=4&&dbNorm.includes(tNorm.split(' ')[0]))score+=1;

    if(score>bestDbScore){bestDbScore=score;bestDb=db;bestDbL=l;bestDbD=d}
  }}}
  if(bestDb&&bestDbScore>=2){vMsg('bot',bestDb.name);go('dashboard',{lid:bestDbL.id,did:bestDbD.id,dbid:bestDb.id});return}

  /* â•â•â• 7. SUNIY INTELLEKT â€” Claude AI orqali tahlil va javob â•â•â• */
  aiAnswer(txt);
}

/* â•â•â• AI YORDAMCHI â€” Claude API orqali aqlli javob â•â•â• */
var AI_KEY=''; /* Admin sozlamalardan o'rnatiladi */
function _getAiKey(){return AI_KEY||localStorage.getItem('aiApiKey')||''}

function _buildAiContext(){
  var ctx=[];
  ctx.push('Bugun: '+new Date().toLocaleDateString('uz-UZ',{weekday:'long',year:'numeric',month:'long',day:'numeric'}));
  /* Rahbarlar */
  ctx.push('Rahbarlar:');
  D.leaders.forEach(function(l){
    ctx.push('- '+l.name+' ('+l.role+'), '+l.departments.length+' ta bo\'lim, '+l.departments.reduce(function(s,d){return s+d.dashboards.length},0)+' ta dashboard');
    l.departments.forEach(function(d){
      ctx.push('  * '+d.name+(d.boss?' â€” '+d.boss:''));
    });
  });
  /* Uchrashuvlar */
  if(D.meetings&&D.meetings.length){
    ctx.push('Uchrashuvlar:');
    D.meetings.forEach(function(m){
      ctx.push('- '+m.day+' '+m.month+', '+m.time+': '+m.title+' ('+m.who+') ['+m.urgency+']');
    });
  }
  /* Yangiliklar (agar mavjud) */
  var nListB=$('nListB'),nListK=$('nListK');
  if(nListB){
    var items=nListB.querySelectorAll('.n-txt');
    if(items.length){
      ctx.push('Bankers.uz yangiliklari:');
      for(var i=0;i<Math.min(items.length,5);i++)ctx.push('- '+items[i].textContent);
    }
  }
  if(nListK){
    var items2=nListK.querySelectorAll('.n-txt');
    if(items2.length){
      ctx.push('Kun.uz iqtisodiy yangiliklari:');
      for(var i=0;i<Math.min(items2.length,5);i++)ctx.push('- '+items2[i].textContent);
    }
  }
  /* Ob-havo */
  var wt=$('wTemp'),wd=$('wDesc');
  if(wt)ctx.push('Ob-havo: '+(wt.textContent||'?')+', '+(wd?wd.textContent:''));
  return ctx.join('\n');
}

async function aiAnswer(userText){
  var key=_getAiKey();
  if(!key){
    vMsg('bot','Suniy intellekt ulangan emas. Admin sozlamalardan API kalitni kiriting.');
    return;
  }
  /* Loading ko'rsatish */
  var st=$('vSt');if(st)st.textContent='ğŸ¤– O\'ylayapman...';
  var loadMsg=document.createElement('div');loadMsg.className='vmsg bot';loadMsg.innerHTML='<span class="ai-dots">ğŸ¤– ...</span>';
  var log=$('vLog');if(log){log.appendChild(loadMsg);log.scrollTop=log.scrollHeight}

  try{
    var resp=await fetch('/api/ai',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        prompt:userText,
        context:_buildAiContext(),
        apiKey:key
      })
    });
    /* Loading olib tashlash */
    if(loadMsg.parentNode)loadMsg.remove();

    if(!resp.ok){
      var err=await resp.json().catch(function(){return {error:'Server xato'}});
      vMsg('bot','âš  AI xato: '+(err.error||resp.status));
      if(st)st.textContent='ğŸ™ Tinglayapman...';
      return;
    }
    var data=await resp.json();
    var aiText=data.text||'Javob olinmadi';
    /* AI javobini ko'rsatish va o'qish */
    vMsg('bot','ğŸ¤– '+aiText);
  }catch(e){
    if(loadMsg.parentNode)loadMsg.remove();
    vMsg('bot','âš  AI ulanish xatosi. Internet yoki API kalitni tekshiring.');
  }
  if(st)st.textContent='ğŸ™ Tinglayapman...';
}

/* â•â• GLOBAL FAYL KESHI â€” ZIP/papkadan yuklangan fayllar â•â• */
var _FC={};/* path â†’ {type:'text'|'binary', data:string|Uint8Array} */
var _FCready=false;

/* file:// protokolda ekanligini aniqlash */
function isFileProto(){return location.protocol==='file:'}

/* Bosh sahifada ZIP bannerini ko'rsatish */
function checkZipBanner(){
  var banner=$('zipBanner'),loaded=$('zipLoaded');
  if(_FCready){
    if(banner)banner.style.display='none';
    if(loaded)loaded.style.display='';
  }else{
    /* file:// yoki fayllar yuklanmagan bo'lsa â€” banner ko'rsatish */
    if(banner)banner.style.display='';
    if(loaded)loaded.style.display='none';
  }
}

/* ZIP fayldan loyihani yuklash */
window.loadProjectZip=function(){
  var inp=document.createElement('input');inp.type='file';inp.accept='.zip';
  inp.onchange=async function(){
    if(!inp.files||!inp.files[0])return;
    var prog=$('zipProgress'),bar=$('zipBar'),st=$('zipStatus');
    prog.style.display='';st.style.display='';
    st.textContent='ZIP ochilmoqda...';bar.style.width='10%';
    try{
      var ab=await inp.files[0].arrayBuffer();
      bar.style.width='30%';
      st.textContent='Fayllar o\'qilmoqda...';
      var entries=await readZipEntries(ab);
      var total=entries.length,done=0;
      _FC={};
      for(var i=0;i<entries.length;i++){
        var e=entries[i];
        var name=e.name;
        /* index.html ni o'tkazib yuborish (biz o'zimiz) */
        if(name==='index.html')continue;
        try{
          var blob=await e.getData();
          var ext=name.split('.').pop().toLowerCase();
          if(ext==='html'||ext==='htm'||ext==='json'||ext==='js'||ext==='css'||ext==='txt'||ext==='csv'){
            /* Matn fayllari */
            var text=await blob.text();
            _FC[name]={type:'text',data:text};
          }else{
            /* Binary fayllar (xlsx, xls, png, jpg, ...) */
            var buf=await blob.arrayBuffer();
            _FC[name]={type:'binary',data:new Uint8Array(buf)};
          }
        }catch(ex){/* Bitta fayl xato bo'lsa davom etish */}
        done++;
        bar.style.width=Math.round(30+done/total*65)+'%';
        st.textContent=done+'/'+total+' fayl o\'qildi';
      }
      bar.style.width='100%';
      _FCready=true;
      /* Natijani ko'rsatish */
      var htmlC=0,xlC=0;
      Object.keys(_FC).forEach(function(k){if(k.match(/\.html?$/i))htmlC++;if(k.match(/\.xlsx?$/i))xlC++});
      $('zipLoadedMsg').textContent='âœ… '+Object.keys(_FC).length+' ta fayl yuklandi';
      $('zipLoadedDet').textContent=htmlC+' HTML, '+xlC+' Excel â€” barcha dashboardlar tayyor';
      checkZipBanner();
      toast(Object.keys(_FC).length+' ta fayl yuklandi!','ok');
      /* Agar hozir dashboard ochiq bo'lsa â€” qayta yuklash */
      if(_curView==='dashboard'&&_curDb.lid){
        renderDash(_curDb.lid,_curDb.did,_curDb.dbid);
      }
    }catch(err){
      st.textContent='Xato: '+err.message;
      bar.style.width='0';
      toast('ZIP xato: '+err.message,'er');
    }
  };
  inp.click();
};

/* Papkadan loyihani yuklash */
window.loadProjectFolder=function(){
  var inp=document.createElement('input');inp.type='file';
  inp.setAttribute('webkitdirectory','');inp.setAttribute('directory','');
  inp.onchange=async function(){
    if(!inp.files||!inp.files.length)return;
    var prog=$('zipProgress'),bar=$('zipBar'),st=$('zipStatus');
    prog.style.display='';st.style.display='';
    st.textContent='Fayllar o\'qilmoqda...';bar.style.width='10%';
    _FC={};
    var files=Array.from(inp.files);
    var total=files.length,done=0;
    for(var i=0;i<files.length;i++){
      var f=files[i];
      var relPath=f.webkitRelativePath;
      /* Birinchi papka nomini olib tashlash (root folder) */
      var parts=relPath.split('/');
      if(parts.length>1)parts.shift();
      var name=parts.join('/');
      if(name==='index.html')continue;
      try{
        var ext=f.name.split('.').pop().toLowerCase();
        if(['html','htm','json','js','css','txt','csv'].indexOf(ext)>=0){
          var text=await f.text();
          _FC[name]={type:'text',data:text};
        }else if(['xlsx','xls','png','jpg','jpeg','gif','svg','pdf'].indexOf(ext)>=0){
          var buf=await f.arrayBuffer();
          _FC[name]={type:'binary',data:new Uint8Array(buf)};
        }
      }catch(ex){}
      done++;
      bar.style.width=Math.round(10+done/total*85)+'%';
      st.textContent=done+'/'+total;
    }
    bar.style.width='100%';
    _FCready=true;
    var htmlC=0,xlC=0;
    Object.keys(_FC).forEach(function(k){if(k.match(/\.html?$/i))htmlC++;if(k.match(/\.xlsx?$/i))xlC++});
    $('zipLoadedMsg').textContent='âœ… '+Object.keys(_FC).length+' ta fayl yuklandi';
    $('zipLoadedDet').textContent=htmlC+' HTML, '+xlC+' Excel';
    checkZipBanner();
    toast(Object.keys(_FC).length+' ta fayl yuklandi!','ok');
    if(_curView==='dashboard'&&_curDb.lid)renderDash(_curDb.lid,_curDb.did,_curDb.dbid);
  };
  inp.click();
};

/* Keshdan fayl olish â€” yo'l bo'yicha qidirish */
function fromCache(path){
  if(!path||!_FCready)return null;
  /* To'g'ridan-to'g'ri topish */
  if(_FC[path])return _FC[path];
  /* Kichik harflarda qidirish */
  var lp=path.toLowerCase();
  var keys=Object.keys(_FC);
  for(var i=0;i<keys.length;i++){
    if(keys[i].toLowerCase()===lp)return _FC[keys[i]];
  }
  /* Oxirgi qismini solishtirish (fayl nomi bo'yicha) */
  var fname=path.split('/').pop().toLowerCase();
  for(var j=0;j<keys.length;j++){
    if(keys[j].split('/').pop().toLowerCase()===fname){
      /* Yo'lning qolgan qismi ham mos kelishini tekshirish */
      if(keys[j].toLowerCase().indexOf(lp.split('/').slice(-2).join('/'))>=0)return _FC[keys[j]];
    }
  }
  /* Eng yaqin moslikni topish â€” fayl nomi + papka */
  var pathParts=path.toLowerCase().split('/');
  var bestMatch=null,bestScore=0;
  for(var k=0;k<keys.length;k++){
    var kParts=keys[k].toLowerCase().split('/');
    var score=0;
    for(var m=0;m<pathParts.length;m++){
      if(kParts.indexOf(pathParts[m])>=0)score++;
    }
    if(score>bestScore){bestScore=score;bestMatch=keys[k]}
  }
  if(bestScore>=2&&bestMatch)return _FC[bestMatch];
  return null;
}

/* â”€â”€ INIT â”€â”€ */
document.addEventListener('DOMContentLoaded',function(){setTheme(localStorage.getItem('cbNT')||'cyber');go('home');makePts();lucide.createIcons();checkZipBanner();
  /* â•â•â• BULUTDAN MA'LUMOT YUKLASH â€” barcha foydalanuvchilar uchun â•â•â• */
  (async function(){
    try{
      /* 1-bosqich: Bulutdan yuklash (npoint.io) */
      var cloud=await cloudPull();
      if(cloud&&cloud.leaders){
        D=cloud;
        try{localStorage.setItem('cbNE',JSON.stringify(D))}catch(e){}
        go('home');
        console.log('â˜ Bulutdan yuklandi');
        return;
      }
      /* 2-bosqich: data.json dan yuklash */
      var r=await fetch('data.json?v='+Date.now());
      if(r.ok){
        var serverData=await r.json();
        if(serverData&&serverData.leaders){
          D=serverData;
          if(!D._contacts)D._contacts=null;
          try{localStorage.setItem('cbNE',JSON.stringify(D))}catch(e){}
          go('home');
          console.log('ğŸ“„ data.json dan yuklandi');
          return;
        }
      }
    }catch(e){console.log('Lokal ma\'lumot ishlatilmoqda')}
  })();
  /* Har 60 soniyada bulutdan yangilash (faqat cloud URL mavjud bo'lsa) */
  setInterval(async function(){
    if(!_getCloudUrl())return;
    try{
      var cloud=await cloudPull();
      if(cloud&&cloud.leaders&&cloud._v&&cloud._v!==(D._v||0)){
        D=cloud;
        try{localStorage.setItem('cbNE',JSON.stringify(D))}catch(e){}
        go('home');
        console.log('â˜ Bulutdan yangilandi (v'+cloud._v+')');
      }
    }catch(e){}
  },60000);
});
</script>
</body>
</html>
