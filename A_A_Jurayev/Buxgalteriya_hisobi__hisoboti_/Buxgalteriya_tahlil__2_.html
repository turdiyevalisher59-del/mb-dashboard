<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markaziy bank â€” Buxgalteriya tahlili</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --font-display: 'Playfair Display', serif;
  --font-body: 'Source Sans 3', sans-serif;
  --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
[data-theme="afternoon"] {
  --bg-primary: #F4F7FE; --bg-secondary: #EDF1FB; --bg-card: #FFFFFF;
  --bg-card-hover: #F8FAFF; --bg-accent: #E6EDFA;
  --text-primary: #111827; --text-secondary: #374151; --text-muted: #6B7280;
  --border: #D1D9E8; --border-light: #E5EAF4;
  --gradient-hero: linear-gradient(135deg, #3B82F6 0%, #6366F1 50%, #8B5CF6 100%);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.05); --shadow-md: 0 4px 16px rgba(0,0,0,0.07);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.10); --glow: 0 0 40px rgba(59,130,246,0.25);
  --warning-bg: #FFFBEB; --warning-border: #F59E0B; --warning-text: #D97706;
  --danger-bg: #FEF2F2; --danger-border: #EF4444; --danger-text: #DC2626;
}
[data-theme="evening"] {
  --bg-primary: #0F1119; --bg-secondary: #161822; --bg-card: #1C1F2E;
  --bg-card-hover: #222640; --bg-accent: #252A3F;
  --text-primary: #E8E4F0; --text-secondary: #A8A2B8; --text-muted: #6E6880;
  --border: #2E3350; --border-light: #252940;
  --gradient-hero: linear-gradient(135deg, #7B68EE 0%, #9F8FFF 40%, #FF6B8A 100%);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.3); --shadow-md: 0 4px 16px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.5); --glow: 0 0 40px rgba(123,104,238,0.2);
  --warning-bg: #2A2215; --warning-border: #FFB74D; --warning-text: #FFB74D;
  --danger-bg: #2A1519; --danger-border: #FF6B8A; --danger-text: #FF6B8A;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font-body);background:var(--bg-primary);color:var(--text-primary);transition:background var(--transition),color var(--transition);line-height:1.6;min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg-secondary)}::-webkit-scrollbar-thumb{background:#3B82F6;border-radius:3px}

.header{background:var(--bg-card);border-bottom:1px solid var(--border);padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-sm);flex-wrap:wrap;gap:.75rem}
.header-left{display:flex;align-items:center;gap:1rem}
.logo{width:44px;height:44px;background:var(--gradient-hero);border-radius:12px;display:flex;align-items:center;justify-content:center;font-family:var(--font-display);font-weight:700;color:#fff;font-size:1.2rem;box-shadow:var(--glow)}
.header-title{font-family:var(--font-display);font-size:1.3rem;font-weight:600}
.header-subtitle{font-size:.8rem;color:var(--text-muted)}
.header-controls{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}

.upload-zone{display:flex;align-items:center;gap:8px;padding:6px 14px;background:var(--bg-accent);border:2px dashed var(--border);border-radius:12px;cursor:pointer;transition:all var(--transition);font-size:.82rem;color:var(--text-secondary)}
.upload-zone:hover{border-color:#2E7CF6;background:var(--bg-card-hover)}
.upload-zone input{display:none}
.upload-status{font-size:.75rem;color:var(--text-muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.upload-status.loaded{color:#0984E3;font-weight:600}

.theme-toggle{display:flex;background:var(--bg-accent);border-radius:30px;padding:3px;border:1px solid var(--border)}
.theme-btn{padding:8px 16px;border:none;border-radius:28px;background:transparent;color:var(--text-muted);font-family:var(--font-body);font-size:.85rem;font-weight:500;cursor:pointer;transition:all var(--transition);display:flex;align-items:center;gap:6px}
.theme-btn.active{background:var(--gradient-hero);color:#fff;box-shadow:var(--shadow-sm)}

.nav-tabs{display:flex;background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:0 2rem;overflow-x:auto;gap:2px}
.nav-tab{padding:14px 20px;border:none;background:transparent;color:var(--text-muted);font-family:var(--font-body);font-size:.9rem;font-weight:500;cursor:pointer;transition:all var(--transition);border-bottom:3px solid transparent;white-space:nowrap}
.nav-tab:hover{color:var(--text-secondary)}
.nav-tab.active{color:#3B82F6;border-bottom-color:#3B82F6;font-weight:600}
[data-theme="evening"] .nav-tab.active{color:#9F8FFF;border-bottom-color:#9F8FFF}

.main{padding:1.5rem 2rem 3rem;max-width:1600px;margin:0 auto}
.tab-content{display:none;animation:fadeIn .5s ease}.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:1.5rem}
.kpi-card{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:1.25rem;transition:all var(--transition);position:relative;overflow:hidden}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--gradient-hero);opacity:0;transition:opacity var(--transition)}
.kpi-card:hover{box-shadow:var(--shadow-md);transform:translateY(-2px)}.kpi-card:hover::before{opacity:1}
.kpi-card[onclick]{cursor:pointer}.kpi-card[onclick]:hover{transform:translateY(-4px) scale(1.02);box-shadow:var(--shadow-lg)}.kpi-card[onclick]:active{transform:translateY(-1px) scale(.99)}
.kpi-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;margin-bottom:.75rem}
.kpi-label{font-size:.78rem;color:var(--text-muted);font-weight:500;text-transform:uppercase;letter-spacing:.5px;margin-bottom:.3rem}
.kpi-value{font-family:var(--font-display);font-size:1.5rem;font-weight:700}
.kpi-change{font-size:.8rem;margin-top:.4rem;font-weight:500}
.kpi-change.up{color:#0984E3}.kpi-change.down{color:#E74C3C}

.chart-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1.25rem;margin-bottom:1.5rem}
.chart-grid.single{grid-template-columns:1fr}
.chart-card{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;transition:all var(--transition)}
.chart-card:hover{box-shadow:var(--shadow-md)}
.chart-card.full{grid-column:1/-1}
.chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
.chart-title{font-family:var(--font-display);font-size:1.1rem;font-weight:600}
.chart-badge{font-size:.72rem;padding:4px 10px;border-radius:20px;font-weight:600;background:var(--bg-accent);color:var(--text-secondary);border:1px solid var(--border)}
.chart-container{position:relative;height:300px}.chart-container.tall{height:400px}

.data-table{width:100%;border-collapse:separate;border-spacing:0;font-size:.85rem}
.data-table thead th{background:var(--bg-accent);color:var(--text-secondary);font-weight:600;padding:10px 12px;text-align:left;border-bottom:2px solid var(--border);font-size:.78rem;text-transform:uppercase;letter-spacing:.5px;position:sticky;top:0}
.data-table thead th:first-child{border-radius:10px 0 0 0}.data-table thead th:last-child{border-radius:0 10px 0 0}
.data-table tbody td{padding:10px 12px;border-bottom:1px solid var(--border-light)}
.data-table tbody tr:hover td{background:var(--bg-card-hover)}
.data-table .num{text-align:right;font-variant-numeric:tabular-nums}
.table-scroll{overflow-x:auto;max-height:500px;overflow-y:auto;border-radius:12px;border:1px solid var(--border)}

.alert{padding:1rem 1.25rem;border-radius:12px;border-left:4px solid;margin-bottom:.75rem;display:flex;align-items:flex-start;gap:.75rem}
.alert-warning{background:var(--warning-bg);border-color:var(--warning-border);color:var(--warning-text)}
.alert-danger{background:var(--danger-bg);border-color:var(--danger-border);color:var(--danger-text)}
.alert-icon{font-size:1.3rem;flex-shrink:0}
.alert-text{font-size:.88rem;line-height:1.5}.alert-text strong{display:block;margin-bottom:2px}

.section-header{margin-bottom:1.25rem;padding-bottom:.75rem;border-bottom:1px solid var(--border-light)}
.section-title{font-family:var(--font-display);font-size:1.4rem;font-weight:700;margin-bottom:.25rem}
.section-desc{font-size:.88rem;color:var(--text-muted)}

.mini-bar{height:6px;border-radius:3px;background:var(--bg-accent);overflow:hidden;min-width:60px}
.mini-bar-fill{height:100%;border-radius:3px;transition:width .6s ease}

.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;z-index:9999;align-items:center;justify-content:center}
.loading-overlay.show{display:flex}
.loading-box{background:var(--bg-card);padding:2rem 3rem;border-radius:16px;text-align:center;box-shadow:var(--shadow-lg)}
.loading-spinner{width:40px;height:40px;border:4px solid var(--border);border-top-color:#3B82F6;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 1rem}
@keyframes spin{to{transform:rotate(360deg)}}

.empty-state{text-align:center;padding:4rem 2rem;color:var(--text-muted)}
.empty-state .empty-icon{font-size:4rem;margin-bottom:1rem;opacity:.5}
.empty-state h3{font-family:var(--font-display);font-size:1.3rem;margin-bottom:.5rem;color:var(--text-secondary)}

/* â•â•â• MODAL â•â•â• */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);display:none;z-index:9000;align-items:center;justify-content:center;padding:1.5rem;animation:fadeIn .3s ease}
.modal-overlay.show{display:flex}
.modal{background:var(--bg-card);border-radius:20px;box-shadow:var(--shadow-lg);width:100%;max-width:820px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;animation:modalSlide .35s cubic-bezier(.4,0,.2,1)}
@keyframes modalSlide{from{opacity:0;transform:translateY(30px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:1.25rem 1.5rem;border-bottom:1px solid var(--border)}
.modal-head-left{display:flex;align-items:center;gap:.75rem}
.modal-head-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.4rem}
.modal-head-title{font-family:var(--font-display);font-size:1.2rem;font-weight:700}
.modal-head-sub{font-size:.82rem;color:var(--text-muted)}
.modal-close{width:36px;height:36px;border:none;border-radius:10px;background:var(--bg-accent);color:var(--text-muted);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition)}
.modal-close:hover{background:var(--danger-bg);color:var(--danger-text)}
.modal-body{padding:1.5rem;overflow-y:auto;flex:1}
.modal-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-bottom:1.25rem}
.modal-stat{background:var(--bg-accent);border-radius:12px;padding:.85rem 1rem;text-align:center}
.modal-stat-label{font-size:.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:.2rem}
.modal-stat-value{font-family:var(--font-display);font-size:1.15rem;font-weight:700}
.modal-chart{height:260px;margin-bottom:1.25rem}
.modal-table-scroll{max-height:220px;overflow-y:auto;border-radius:10px;border:1px solid var(--border)}

/* â•â•â• AI ANALYSIS â•â•â• */
.ai-card{background:var(--bg-card);border-radius:16px;border:1px solid var(--border);padding:1.5rem;margin-bottom:1rem;position:relative;overflow:hidden}
.ai-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#3B82F6,#8B5CF6,#EC4899)}
.ai-card-head{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem}
.ai-card-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3rem}
.ai-card-title{font-family:var(--font-display);font-size:1.1rem;font-weight:700}
.ai-card-sub{font-size:.8rem;color:var(--text-muted)}
.ai-insight{padding:.85rem 1rem;border-radius:10px;margin-bottom:.6rem;font-size:.88rem;line-height:1.55;display:flex;gap:.6rem;align-items:flex-start}
.ai-insight.positive{background:#ECFDF5;border-left:3px solid #10B981;color:#065F46}
.ai-insight.negative{background:#FEF2F2;border-left:3px solid #EF4444;color:#991B1B}
.ai-insight.neutral{background:#EFF6FF;border-left:3px solid #3B82F6;color:#1E40AF}
.ai-insight.warning{background:#FFFBEB;border-left:3px solid #F59E0B;color:#92400E}
[data-theme="evening"] .ai-insight.positive{background:#064E3B33;color:#6EE7B7}
[data-theme="evening"] .ai-insight.negative{background:#7F1D1D33;color:#FCA5A5}
[data-theme="evening"] .ai-insight.neutral{background:#1E3A5F33;color:#93C5FD}
[data-theme="evening"] .ai-insight.warning{background:#78350F33;color:#FCD34D}
.ai-forecast-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin:1rem 0}
.ai-fc{text-align:center;background:var(--bg-accent);border-radius:12px;padding:1rem .75rem}
.ai-fc-month{font-size:.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}
.ai-fc-val{font-family:var(--font-display);font-size:1.25rem;font-weight:700;margin:.25rem 0}
.ai-fc-chg{font-size:.78rem;font-weight:600}
.ai-fc-chg.up{color:#EF4444}.ai-fc-chg.down{color:#10B981}
.ai-confidence{display:inline-flex;align-items:center;gap:.3rem;font-size:.72rem;color:var(--text-muted);background:var(--bg-accent);padding:3px 8px;border-radius:20px}

/* â•â•â• INVENTORY FORM â•â•â• */
.inv-section{background:var(--bg-card);border-radius:16px;border:1px solid var(--border);padding:1.25rem;margin-bottom:1rem}
.inv-section-title{font-family:var(--font-display);font-weight:700;font-size:1rem;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
.inv-form{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:.6rem;align-items:end}
.inv-form label{font-size:.78rem;color:var(--text-muted);display:block;margin-bottom:3px}
.inv-form input,.inv-form select{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--bg-secondary);color:var(--text-primary);font-size:.88rem;outline:none;width:100%}
.inv-form input:focus,.inv-form select:focus{border-color:#3B82F6;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
.inv-btn{padding:8px 18px;border:none;border-radius:10px;font-weight:600;font-size:.88rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:.4rem;white-space:nowrap}
.inv-btn.kirim{background:#10B981;color:#fff}.inv-btn.kirim:hover{background:#059669}
.inv-btn.chiqim{background:#EF4444;color:#fff}.inv-btn.chiqim:hover{background:#DC2626}
/* Contract category filter buttons */
.contract-cat-btn{padding:6px 14px;border:1.5px solid var(--border);border-radius:10px;font-weight:600;font-size:.82rem;cursor:pointer;background:var(--bg-secondary);color:var(--text-secondary);transition:all .2s}
.contract-cat-btn:hover{border-color:var(--primary);color:var(--primary)}
.contract-cat-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
/* Expense accordion panels */
.exp-cat-panel{background:var(--card-bg);border:1.5px solid var(--border);border-radius:14px;margin-bottom:.8rem;overflow:hidden;transition:all .3s}
.exp-cat-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;cursor:pointer;user-select:none;transition:background .2s}
.exp-cat-head:hover{background:color-mix(in srgb,var(--primary) 6%,transparent)}
.exp-cat-head .cat-icon{font-size:1.3rem;margin-right:10px}
.exp-cat-head .cat-name{font-weight:700;font-size:.95rem;flex:1}
.exp-cat-head .cat-total{font-weight:700;font-size:.92rem;margin-right:14px;color:var(--primary)}
.exp-cat-head .cat-count{font-size:.78rem;color:var(--text-secondary);margin-right:14px}
.exp-cat-head .cat-arrow{font-size:1.1rem;transition:transform .3s;color:var(--text-secondary)}
.exp-cat-panel.open .cat-arrow{transform:rotate(180deg)}
.exp-cat-body{max-height:0;overflow:hidden;transition:max-height .4s ease}
.exp-cat-panel.open .exp-cat-body{max-height:3000px}
.exp-col-table{width:100%;border-collapse:collapse;font-size:.82rem}
.exp-col-table th{background:var(--bg-secondary);padding:8px 12px;text-align:left;font-weight:600;color:var(--text-secondary);font-size:.78rem;text-transform:uppercase;letter-spacing:.3px;border-bottom:1.5px solid var(--border);position:sticky;top:0}
.exp-col-table td{padding:7px 12px;border-bottom:1px solid var(--border)}
.exp-col-table tr:hover{background:color-mix(in srgb,var(--primary) 4%,transparent)}
.exp-col-bar{display:inline-block;height:8px;border-radius:4px;vertical-align:middle;margin-left:6px;min-width:2px;transition:width .3s}
.inv-log{max-height:200px;overflow-y:auto;margin-top:.75rem}
.inv-log-item{display:flex;align-items:center;gap:.6rem;padding:.5rem .75rem;border-radius:8px;margin-bottom:.3rem;font-size:.84rem;animation:fadeIn .3s ease}
.inv-log-item.in{background:#ECFDF533;border-left:3px solid #10B981}
.inv-log-item.out{background:#FEF2F233;border-left:3px solid #EF4444}
@keyframes fadeIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}

/* â•â•â• VOICE ALERT â•â•â• */
.voice-btn{padding:6px 14px;border:none;border-radius:10px;background:linear-gradient(135deg,#3B82F6,#8B5CF6);color:#fff;font-size:.82rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:.4rem;transition:all .2s;white-space:nowrap}
.voice-btn:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(59,130,246,.3)}
.voice-btn.speaking{animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(59,130,246,.4)}50%{box-shadow:0 0 0 12px rgba(59,130,246,0)}}
.voice-indicator{width:8px;height:8px;border-radius:50%;background:#10B981;display:none}
.voice-indicator.active{display:inline-block;animation:blink .8s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

@media(max-width:900px){.chart-grid{grid-template-columns:1fr}.header{flex-direction:column;gap:1rem;text-align:center}.kpi-grid{grid-template-columns:repeat(2,1fr)}.main{padding:1rem}.modal-stats{grid-template-columns:1fr}.inv-form{grid-template-columns:1fr}.ai-forecast-grid{grid-template-columns:1fr}}
/* Animated bell badge */
.alert-badge{position:absolute;top:2px;right:2px;background:#EF4444;color:white;font-size:.6rem;font-weight:700;min-width:16px;height:16px;border-radius:99px;display:flex;align-items:center;justify-content:center;padding:0 4px;line-height:1;box-shadow:0 1px 3px rgba(0,0,0,.3)}
@keyframes bellRing{0%,100%{transform:rotate(0)}10%{transform:rotate(14deg)}20%{transform:rotate(-14deg)}30%{transform:rotate(10deg)}40%{transform:rotate(-10deg)}50%{transform:rotate(6deg)}60%{transform:rotate(-4deg)}70%{transform:rotate(2deg)}80%{transform:rotate(0)}}
.bell-ring{animation:bellRing 1.5s ease-in-out infinite}
@keyframes badgePulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.15)}}
.alert-badge{animation:badgePulse 2s ease-in-out infinite}
</style>
</head>
<body data-theme="afternoon">

<div class="loading-overlay" id="loadingOverlay"><div class="loading-box"><div class="loading-spinner"></div><div>Ma'lumotlar yuklanmoqda...</div></div></div>

<!-- KPI Detail Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-head-left">
        <div class="modal-head-icon" id="modalIcon"></div>
        <div><div class="modal-head-title" id="modalTitle"></div><div class="modal-head-sub" id="modalSub"></div></div>
      </div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-stats" id="modalStats"></div>
      <div class="modal-chart"><canvas id="modalChart"></canvas></div>
      <div class="modal-table-scroll" id="modalTable"></div>
    </div>
  </div>
</div>

<header class="header">
  <div class="header-left">
    <div class="logo">MB</div>
    <div><div class="header-title">Buxgalteriya tahlili</div><div class="header-subtitle">Markaziy bank Toshkent viloyati bosh boshqarmasi</div></div>
  </div>
  <div class="header-controls">
    <label class="upload-zone" id="uploadZone"><span>ğŸ“</span><span>Excel yuklash</span><input type="file" id="fileInput" accept=".xlsx,.xls"></label>
    <div class="upload-status" id="uploadStatus">Fayl yuklanmagan</div>
    <button class="voice-btn" onclick="speakAlerts()" id="voiceBtn">ğŸ”Š Ovozli ogohlantirish<span class="voice-indicator" id="voiceInd"></span></button>
    <div class="theme-toggle">
      <button class="theme-btn active" onclick="setTheme('afternoon')" id="btn-afternoon">â˜€ï¸ Kunduzgi</button>
      <button class="theme-btn" onclick="setTheme('evening')" id="btn-evening">ğŸŒ™ Kechki</button>
    </div>
  </div>
</header>

<nav class="nav-tabs">
  <button class="nav-tab active" onclick="switchTab('overview',this)">ğŸ“Š Umumiy</button>
  <button class="nav-tab" onclick="switchTab('expense',this)">ğŸ’¹ Daromad va Xarajatlar</button>
  <button class="nav-tab" onclick="switchTab('monthly',this)">ğŸ“… Oylik</button>
  <button class="nav-tab" onclick="switchTab('quarterly',this)">ğŸ“ˆ Kvartal</button>
  <button class="nav-tab" onclick="switchTab('warehouse',this)">ğŸ“¦ Ombor</button>
  <button class="nav-tab" onclick="switchTab('ai',this)">ğŸ¤– AI Tahlil</button>
  <button class="nav-tab" onclick="switchTab('vacation',this)">ğŸ–ï¸ Ta'til</button>
  <button class="nav-tab" onclick="switchTab('sickleave',this)">ğŸ¥ Tibbiy</button>
  <button class="nav-tab" onclick="switchTab('staff',this)">ğŸ‘¥ Xodimlar</button>
  <button class="nav-tab" onclick="switchTab('contracts',this)">ğŸ“„ Shartnomalar</button>
  <button class="nav-tab" onclick="switchTab('jubilee',this)">ğŸ‚ Yubiley</button>
  <button class="nav-tab" onclick="switchTab('alerts',this)" style="position:relative" id="alertTabBtn"><span id="bellIcon" class="bell-ring" style="display:inline-block">ğŸ””</span> Ogohlantirish <span id="alertBellBadge" class="alert-badge" style="display:none">0</span></button>
</nav>

<main class="main">
  <!-- OVERVIEW -->
  <div class="tab-content active" id="tab-overview">
    <div class="section-header"><h2 class="section-title">Moliyaviy-iqtisodiy faoliyat tahlili</h2><p class="section-desc">Buxgalteriya hisobi va hisoboti bo'yicha umumiy ko'rsatkichlar</p></div>
    <div class="kpi-grid" id="kpi-overview"></div>
    <div class="chart-grid"><div class="chart-card full"><div class="chart-header"><span class="chart-title">Oylik xarajatlar tarkibi</span><span class="chart-badge">12 oy</span></div><div class="chart-container tall"><canvas id="chartOverviewBar"></canvas></div></div></div>
    <div class="chart-grid"><div class="chart-card"><div class="chart-header"><span class="chart-title">Xarajat kategoriyalari ulushi</span><span class="chart-badge">Yillik</span></div><div class="chart-container"><canvas id="chartCategoryPie"></canvas></div></div><div class="chart-card"><div class="chart-header"><span class="chart-title">Daromad manbalari</span><span class="chart-badge">Yillik</span></div><div class="chart-container"><canvas id="chartIncomePie"></canvas></div></div></div>
  </div>
  <!-- EXPENSE DETAIL â€” all 12 categories, 69 columns -->
  <div class="tab-content" id="tab-expense">
    <div class="section-header"><h2 class="section-title">Daromad va xarajatlar batafsil tahlili</h2><p class="section-desc">12 ta kategoriya, 69 ta ustun â€” to'liq moliyaviy tarkib</p></div>
    <div class="kpi-grid" id="kpi-expense"></div>
    <div class="chart-grid"><div class="chart-card full"><div class="chart-header"><span class="chart-title">Kategoriyalar bo'yicha oylik xarajatlar</span><span class="chart-badge">Stacked</span></div><div class="chart-container tall"><canvas id="chartExpStack"></canvas></div></div></div>
    <div class="chart-grid"><div class="chart-card"><div class="chart-header"><span class="chart-title">Kategoriya ulushi</span><span class="chart-badge">Yillik</span></div><div class="chart-container"><canvas id="chartExpCatPie"></canvas></div></div><div class="chart-card"><div class="chart-header"><span class="chart-title">Eng katta 12 ta xarajat ustuni</span><span class="chart-badge">Top 12</span></div><div class="chart-container tall"><canvas id="chartExpTopCols"></canvas></div></div></div>
    <div class="chart-grid"><div class="chart-card"><div class="chart-header"><span class="chart-title">Daromad manbalari tarkibi</span><span class="chart-badge">6 ta ustun</span></div><div class="chart-container"><canvas id="chartExpIncome"></canvas></div></div><div class="chart-card"><div class="chart-header"><span class="chart-title">Xarajat vs Daromad dinamikasi</span><span class="chart-badge">Oylik</span></div><div class="chart-container"><canvas id="chartExpVsInc"></canvas></div></div></div>
    <div id="expCatAccordion" style="margin-top:1.5rem"></div>
  </div>
  <!-- MONTHLY -->
  <div class="tab-content" id="tab-monthly">
    <div class="section-header"><h2 class="section-title">Oylik batafsil tahlil</h2><p class="section-desc">Har bir oy bo'yicha xarajatlar va o'zgarishlar tendensiyasi</p></div>
    <div class="chart-grid single"><div class="chart-card"><div class="chart-header"><span class="chart-title">Ish haqi va qo'shimcha to'lovlar dinamikasi</span><span class="chart-badge">Trend</span></div><div class="chart-container tall"><canvas id="chartMonthlyLine"></canvas></div></div></div>
    <div class="chart-grid"><div class="chart-card"><div class="chart-header"><span class="chart-title">Kommunal xarajatlar</span><span class="chart-badge">Oylik</span></div><div class="chart-container"><canvas id="chartKommunal"></canvas></div></div><div class="chart-card"><div class="chart-header"><span class="chart-title">Ma'muriy va xo'jalik xarajatlari</span><span class="chart-badge">Oylik</span></div><div class="chart-container"><canvas id="chartAdmin"></canvas></div></div></div>
    <div class="chart-card" style="margin-top:1.25rem"><div class="chart-header"><span class="chart-title">Oylik batafsil ma'lumotlar jadvali</span><span class="chart-badge">mln so'm</span></div><div class="table-scroll" id="monthlyTable"></div></div>
  </div>
  <!-- QUARTERLY -->
  <div class="tab-content" id="tab-quarterly">
    <div class="section-header"><h2 class="section-title">Kvartallik tahlil</h2><p class="section-desc">Har bir kvartal bo'yicha jamlangan ma'lumotlar va solishtirma tahlil</p></div>
    <div class="kpi-grid" id="kpi-quarters"></div>
    <div class="chart-grid"><div class="chart-card full"><div class="chart-header"><span class="chart-title">Kvartallar bo'yicha asosiy xarajatlar</span></div><div class="chart-container tall"><canvas id="chartQuarterBar"></canvas></div></div></div>
    <div class="chart-grid"><div class="chart-card"><div class="chart-header"><span class="chart-title">Kvartallararo o'sish/kamayish</span></div><div class="chart-container"><canvas id="chartQuarterChange"></canvas></div></div><div class="chart-card"><div class="chart-header"><span class="chart-title">Davrlar bo'yicha xarajat</span><span class="chart-badge">3 davr</span></div><div class="chart-container"><canvas id="chartDecadeBar"></canvas></div></div></div>
  </div>
  <!-- WAREHOUSE -->
  <div class="tab-content" id="tab-warehouse">
    <div class="section-header"><h2 class="section-title">Ombor kirim-chiqim tahlili</h2><p class="section-desc">Shartnomalar bo'yicha kirim va ombordan chiqim â€” avtomatik kam qolgan mahsulotlar aniqlash</p></div>
    <div class="kpi-grid" id="kpi-warehouse"></div>

    <!-- INVENTORY MANAGEMENT FORMS -->
    <div class="inv-section">
      <div class="inv-section-title">ğŸ“¥ Mahsulot kiritish (Kirim)</div>
      <div class="inv-form" id="formKirim">
        <div><label>Sana</label><input type="date" id="kirimDate"></div>
        <div><label>Mahsulot nomi</label><input type="text" id="kirimName" placeholder="Masalan: A4 qog'oz"></div>
        <div><label>Miqdori</label><input type="number" id="kirimQty" placeholder="100" min="1"></div>
        <div><label>Narxi (so'm)</label><input type="number" id="kirimPrice" placeholder="5000" min="0"></div>
        <div><label>Mahsulotni yetkazib bergan subyekt nomi</label><input type="text" id="kirimDept" placeholder="Subyekt nomini kiriting"></div>
        <button class="inv-btn kirim" onclick="addInventory('kirim')">ğŸ“¥ Kiritish</button>
      </div>
    </div>
    <div class="inv-section">
      <div class="inv-section-title">ğŸ“¤ Mahsulot chiqarish (Chiqim)</div>
      <div class="inv-form" id="formChiqim">
        <div><label>Sana</label><input type="date" id="chiqimDate"></div>
        <div><label>Mahsulot nomi</label><input type="text" id="chiqimName" placeholder="Masalan: Ruchka"></div>
        <div><label>Miqdori</label><input type="number" id="chiqimQty" placeholder="50" min="1"></div>
        <div><label>Sabab</label><select id="chiqimReason"><option>Ish uchun</option><option>Ta'mir</option><option>Yo'qotish</option><option>Boshqa</option></select></div>
        <div><label>Mahsulot olgan bo'lim nomi</label><select id="chiqimDept"></select></div>
        <button class="inv-btn chiqim" onclick="addInventory('chiqim')">ğŸ“¤ Chiqarish</button>
      </div>
    </div>
    <div class="inv-section" id="invLogSection" style="display:none">
      <div class="inv-section-title">ğŸ“‹ Amallar tarixi <span style="font-weight:400;font-size:.8rem;color:var(--text-muted)" id="invLogCount"></span></div>
      <div class="inv-log" id="invLog"></div>
    </div>

    <div class="chart-grid"><div class="chart-card"><div class="chart-header"><span class="chart-title">Ombor chiqimi oylar bo'yicha</span><span class="chart-badge">so'm</span></div><div class="chart-container"><canvas id="chartWarehouseMonth"></canvas></div></div><div class="chart-card"><div class="chart-header"><span class="chart-title">Bo'limlar bo'yicha chiqim</span><span class="chart-badge">Top 8</span></div><div class="chart-container"><canvas id="chartWarehouseDept"></canvas></div></div></div>
    <div class="chart-grid single"><div class="chart-card"><div class="chart-header"><span class="chart-title">Kirim (Shartnomalar) va Chiqim (Ombor) solishtirmasi</span><span class="chart-badge">Oylik</span></div><div class="chart-container tall"><canvas id="chartKirimChiqim"></canvas></div></div></div>
    <div class="chart-card" style="margin-top:1.25rem"><div class="chart-header"><span class="chart-title">âš ï¸ Kam qolgan mahsulotlar â€” xarid qilish lozim</span><span class="chart-badge">Avtomatik tahlil</span></div><div id="lowStockAlerts"></div><div class="table-scroll" style="margin-top:1rem" id="warehouseTable"></div></div>
  </div>
  <!-- AI ANALYSIS -->
  <div class="tab-content" id="tab-ai">
    <div class="section-header" style="display:flex;align-items:flex-start;gap:1rem;flex-wrap:wrap">
      <div style="flex:1">
        <h2 class="section-title">ğŸ¤– Sun'iy intellekt tahlili va prognoz</h2>
        <p class="section-desc">Statistik modellar asosida xarajatlar va ombor kirim-chiqim bo'yicha bashorat. Linear regression va trend-analiz.</p>
      </div>
      <button class="voice-btn" onclick="rerunAI()" style="font-size:.82rem;padding:8px 18px;border-radius:12px;background:linear-gradient(135deg,#3B82F6,#8B5CF6);color:#fff;font-weight:600;letter-spacing:.3px;white-space:nowrap;margin-top:.3rem" id="rerunAIBtn">ğŸ”„ Qayta tahlil qilish</button>
    </div>
    <div class="kpi-grid" id="kpi-ai"></div>

    <!-- Expense Forecast -->
    <div class="ai-card">
      <div class="ai-card-head">
        <div class="ai-card-icon" style="background:#3B82F622;color:#3B82F6">ğŸ“ˆ</div>
        <div><div class="ai-card-title">Xarajatlar prognozi (kelgusi 3 oy)</div><div class="ai-card-sub">Linear regression modeli asosida</div></div>
        <button class="voice-btn" onclick="speakForecast('expense')" style="margin-left:auto;font-size:.76rem;padding:5px 10px">ğŸ”Š Eshitish</button>
      </div>
      <div class="ai-forecast-grid" id="aiForecastExpense"></div>
      <div class="chart-container" style="height:260px"><canvas id="chartAiForecast"></canvas></div>
      <div id="aiExpenseInsights" style="margin-top:1rem"></div>
    </div>

    <!-- Warehouse Forecast -->
    <div class="ai-card">
      <div class="ai-card-head">
        <div class="ai-card-icon" style="background:#10B98122;color:#10B981">ğŸ“¦</div>
        <div><div class="ai-card-title">Ombor kirim-chiqim prognozi</div><div class="ai-card-sub">Ombor sarfiyoti tendensiyasi va bashorat</div></div>
        <button class="voice-btn" onclick="speakForecast('warehouse')" style="margin-left:auto;font-size:.76rem;padding:5px 10px">ğŸ”Š Eshitish</button>
      </div>
      <div class="ai-forecast-grid" id="aiForecastWarehouse"></div>
      <div class="chart-container" style="height:260px"><canvas id="chartAiWarehouse"></canvas></div>
      <div id="aiWarehouseInsights" style="margin-top:1rem"></div>
    </div>

    <!-- AI Recommendations -->
    <div class="ai-card">
      <div class="ai-card-head">
        <div class="ai-card-icon" style="background:#8B5CF622;color:#8B5CF6">ğŸ’¡</div>
        <div><div class="ai-card-title">Avtomatik tavsiyalar</div><div class="ai-card-sub">Anomaliya aniqlash va iqtisodiy tavsiyalar</div></div>
        <button class="voice-btn" onclick="speakForecast('recommendations')" style="margin-left:auto;font-size:.76rem;padding:5px 10px">ğŸ”Š Eshitish</button>
      </div>
      <div id="aiRecommendations"></div>
    </div>

    <!-- METHODOLOGY PANEL -->
    <div class="ai-card" id="aiMethodPanel">
      <div class="ai-card-head">
        <div class="ai-card-icon" style="background:#06B6D422;color:#06B6D4">ğŸ“</div>
        <div><div class="ai-card-title">Metodika va formulalar</div><div class="ai-card-sub">Prognoz modeli qanday ishlashini tushunish uchun</div></div>
      </div>
      <div id="aiMethodContent"></div>
    </div>
  </div>
  <!-- VACATION -->
  <div class="tab-content" id="tab-vacation">
    <div class="section-header"><h2 class="section-title">Ta'til tahlili</h2><p class="section-desc">Mehnat va o'quv ta'tillari bo'yicha oylik statistika</p></div>
    <div class="kpi-grid" id="kpi-vacation"></div>
    <div class="chart-grid"><div class="chart-card"><div class="chart-header"><span class="chart-title">Oylar bo'yicha ta'tilga chiqishlar</span><span class="chart-badge">Soni + Xarajat</span></div><div class="chart-container tall"><canvas id="chartVacationMonth"></canvas></div></div><div class="chart-card"><div class="chart-header"><span class="chart-title">Ta'til turlari</span></div><div class="chart-container"><canvas id="chartVacationType"></canvas></div></div></div>
    <div class="chart-grid single"><div class="chart-card"><div class="chart-header"><span class="chart-title">Mehnat ta'tili xarajatlari va ta'tilga chiqqanlar nisbati</span></div><div class="chart-container tall"><canvas id="chartVacationCost"></canvas></div></div></div>
    <div class="chart-card" style="margin-top:1.25rem">
      <div class="chart-header"><span class="chart-title">Ta'tilga chiqqan xodimlar to'liq ro'yxati</span><span class="chart-badge" id="vacListCount"></span></div>
      <div style="margin-bottom:.75rem"><input type="text" id="vacSearch" placeholder="ğŸ” Xodim ismini qidirish..." oninput="filterVacList()" style="padding:8px 14px;border:1px solid var(--border);border-radius:10px;background:var(--bg-secondary);color:var(--text-primary);font-size:.88rem;width:100%;max-width:400px;outline:none"></div>
      <div class="table-scroll" id="vacListTable"></div>
    </div>
  </div>
  <!-- SICK LEAVE -->
  <div class="tab-content" id="tab-sickleave">
    <div class="section-header"><h2 class="section-title">Tibbiy ta'til (Ğ‘Ğ¾Ğ»ÑŒĞ½Ğ¸Ñ‡Ğ½Ñ‹Ğ¹) tahlili</h2><p class="section-desc">Vaqtincha mehnatga layoqatsizlik â€” qaysi oylarda ko'p kasallanish kuzatiladi?</p></div>
    <div class="kpi-grid" id="kpi-sick"></div>
    <div class="chart-grid"><div class="chart-card"><div class="chart-header"><span class="chart-title">Oylar bo'yicha kasallik varaqlari</span><span class="chart-badge">Soni + Nafaqa</span></div><div class="chart-container tall"><canvas id="chartSickMonth"></canvas></div></div><div class="chart-card"><div class="chart-header"><span class="chart-title">Kasallik nafaqasi xarajati</span><span class="chart-badge">so'm</span></div><div class="chart-container tall"><canvas id="chartSickCost"></canvas></div></div></div>
    <div class="chart-grid single"><div class="chart-card"><div class="chart-header"><span class="chart-title">Ta'til va tibbiy ta'til solishtirmasi</span></div><div class="chart-container"><canvas id="chartVacSickCompare"></canvas></div></div></div>
    <div class="chart-card" style="margin-top:1.25rem">
      <div class="chart-header"><span class="chart-title">Kasallik varaqasi olgan xodimlar to'liq ro'yxati</span><span class="chart-badge" id="sickListCount"></span></div>
      <div style="margin-bottom:.75rem"><input type="text" id="sickSearch" placeholder="ğŸ” Xodim ismini qidirish..." oninput="filterSickList()" style="padding:8px 14px;border:1px solid var(--border);border-radius:10px;background:var(--bg-secondary);color:var(--text-primary);font-size:.88rem;width:100%;max-width:400px;outline:none"></div>
      <div class="table-scroll" id="sickListTable"></div>
    </div>
  </div>
  <!-- STAFF (Xodimlar staji) -->
  <div class="tab-content" id="tab-staff">
    <div class="section-header"><h2 class="section-title">Xodimlar mehnat staji</h2><p class="section-desc">Markaziy bank Toshkent viloyati bosh boshqarmasida faoliyat yuritayotgan xodimlarning mehnat staji bo'yicha ma'lumot</p></div>
    <div class="kpi-grid" id="kpi-staff"></div>
    <div class="chart-grid"><div class="chart-card full"><div class="chart-header"><span class="chart-title">Ish staji taqsimoti</span></div><div class="chart-container"><canvas id="chartStaffTenure"></canvas></div></div></div>
    <div class="chart-card" style="margin-top:1.25rem">
      <div class="chart-header"><span class="chart-title">Xodimlar to'liq ro'yxati</span><span class="chart-badge" id="staffCount"></span></div>
      <div style="margin-bottom:.75rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <input type="text" id="staffSearch" placeholder="ğŸ” Xodim ismini qidirish..." oninput="filterStaff()" style="padding:8px 14px;border:1px solid var(--border);border-radius:10px;background:var(--bg-secondary);color:var(--text-primary);font-size:.88rem;flex:1;min-width:200px;outline:none">
        <select id="staffFilter" onchange="filterStaff()" style="padding:8px 14px;border:1px solid var(--border);border-radius:10px;background:var(--bg-secondary);color:var(--text-primary);font-size:.88rem;outline:none">
          <option value="all">Barchasi</option><option value="0-5">0-5 yil</option><option value="6-10">6-10 yil</option><option value="11-15">11-15 yil</option><option value="16-20">16-20 yil</option><option value="21-25">21-25 yil</option><option value="25+">25+ yil</option>
        </select>
      </div>
      <div class="table-scroll" id="staffTable"></div>
    </div>
  </div>

  <!-- CONTRACTS (Shartnomalar) -->
  <div class="tab-content" id="tab-contracts">
    <div class="section-header"><h2 class="section-title">Xo'jalik shartnomalari</h2><p class="section-desc">Markaziy bank Toshkent viloyati bosh boshqarmasi tomonidan 2025-yil davomida tuzilgan xo'jalik shartnomalari to'g'risida ma'lumot</p></div>
    <div class="kpi-grid" id="kpi-contracts"></div>
    <div class="chart-grid">
      <div class="chart-card"><div class="chart-header"><span class="chart-title">Shartnomalar oylar bo'yicha (kategoriya bo'yicha)</span></div><div class="chart-container"><canvas id="chartContractMonth"></canvas></div></div>
      <div class="chart-card"><div class="chart-header"><span class="chart-title">Shartnoma kategoriyalari</span></div><div class="chart-container"><canvas id="chartContractCat"></canvas></div></div>
    </div>
    <div class="chart-grid">
      <div class="chart-card"><div class="chart-header"><span class="chart-title">Savdo turlari bo'yicha taqsimot</span><span class="chart-badge">Soni + Summasi</span></div><div class="chart-container"><canvas id="chartContractTradeType"></canvas></div></div>
      <div class="chart-card"><div class="chart-header"><span class="chart-title">Savdo turlari â€” batafsil</span></div><div class="table-scroll" id="tradeTypeTable"></div></div>
    </div>

    <!-- Category tabs for contract list -->
    <div class="chart-card" style="margin-top:1.25rem">
      <div class="chart-header">
        <span class="chart-title">Shartnomalar ro'yxati</span><span class="chart-badge" id="contractCount"></span>
      </div>
      <div style="display:flex;gap:.5rem;margin-bottom:.75rem;flex-wrap:wrap">
        <button class="contract-cat-btn active" onclick="filterContractCat('all',this)">ğŸ“‹ Barchasi</button>
        <button class="contract-cat-btn" onclick="filterContractCat('ombor',this)">ğŸ“¦ Mahsulot (Ombor)</button>
        <button class="contract-cat-btn" onclick="filterContractCat('xizmat',this)">ğŸ”§ Xizmat</button>
        <button class="contract-cat-btn" onclick="filterContractCat('asosiy',this)">ğŸ—ï¸ Asosiy vosita</button>
      </div>
      <div style="margin-bottom:.75rem"><input type="text" id="contractSearch" placeholder="ğŸ” Yetkazib beruvchi yoki mahsulot qidirish..." oninput="filterContracts()" style="padding:8px 14px;border:1px solid var(--border);border-radius:10px;background:var(--bg-secondary);color:var(--text-primary);font-size:.88rem;width:100%;max-width:400px;outline:none"></div>
      <div class="table-scroll" id="contractTable"></div>
    </div>
  </div>

  <!-- JUBILEE (50-60 yosh, Dafn) -->
  <div class="tab-content" id="tab-jubilee">
    <div class="section-header"><h2 class="section-title">Yubiley, dafn va boshqa ma'lumotlar</h2><p class="section-desc">50-60 yosh yubiley sanalari va moddiy yordam haqida ma'lumotlar</p></div>
    <div class="kpi-grid" id="kpi-jubilee"></div>
    <div class="chart-card" style="margin-bottom:1.25rem">
      <div class="chart-header"><span class="chart-title">ğŸ‚ Yubiley sanalari (50-60 yosh)</span><span class="chart-badge" id="jubCount"></span></div>
      <div class="table-scroll" id="jubTable"></div>
    </div>
    <div class="chart-card">
      <div class="chart-header"><span class="chart-title">ğŸ•¯ï¸ Dafn marosimi munosabati bilan moddiy yordam</span><span class="chart-badge" id="dafnCount"></span></div>
      <div class="table-scroll" id="dafnTable"></div>
    </div>
  </div>

  <!-- ALERTS -->
  <div class="tab-content" id="tab-alerts">
    <div class="section-header"><h2 class="section-title">Ogohlantirishlar va tavsiyalar</h2><p class="section-desc">Avtomatik tahlil asosida aniqlangan ehtimoliy xarajat oshishi va muhim holatlar</p></div>
    <div id="alertsList"></div>
    <div class="chart-grid single" style="margin-top:1.5rem"><div class="chart-card"><div class="chart-header"><span class="chart-title">Xodimlar ish staji taqsimoti</span></div><div class="chart-container"><canvas id="chartTenure"></canvas></div></div></div>
  </div>
</main>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLOR PALETTES â€” hardcoded hex values, NOT CSS variables
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PALETTES = {
  afternoon: {
    c1:'#3B82F6', c2:'#6366F1', c3:'#EF4444', c4:'#10B981', c5:'#0EA5E9',
    c6:'#F59E0B', c7:'#8B5CF6', c8:'#14B8A6',
    grid:'rgba(0,0,0,0.05)', text:'#374151', cardBg:'#FFFFFF',
  },
  evening: {
    c1:'#7B68EE', c2:'#9F8FFF', c3:'#FF6B8A', c4:'#4FC3F7', c5:'#66BB6A',
    c6:'#FFB74D', c7:'#AB47BC', c8:'#26C6DA',
    grid:'rgba(232,228,240,0.08)', text:'#A8A2B8', cardBg:'#1C1F2E',
  }
};
let currentTheme = 'afternoon';
const P = () => PALETTES[currentTheme];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBAL DATA
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const months = ['Yanvar','Fevral','Mart','Aprel','May','Iyun','Iyul','Avgust','Sentabr','Oktabr','Noyabr','Dekabr'];
const MS = ['Yan','Fev','Mar','Apr','May','Iyn','Iyl','Avg','Sen','Okt','Noy','Dek'];
let D = null;

function emptyData(){
  return {ishHaqi:A(12),ustama:A(12),staj:A(12),mehnatTatil:A(12),oquvTatil:A(12),bayramMukofot:A(12),ijtimoiySoliq:A(12),bolnichny:A(12),banknotalar:A(12),elektr:A(12),gaz:A(12),qoriqlash:A(12),avtomobil:A(12),debetDaromad:A(12),bankomatDaromad:A(12),vacationByMonth:A(12),sickByMonth:A(12),omborChiqim:A(12),shartnomalarKirim:A(12),
    /* Shartnoma kategoriyalari */
    mahsulotKirim:A(12), xizmatKirim:A(12), asosiyVositaKirim:A(12),
    /* â•â•â• TO'LIQ DAROMAD-XARAJAT KATEGORIYALARI â•â•â• */
    xarajatByMonth:A(12), daromadByMonth:A(12),
    expCats:{},  /* {catName: {total:A(12), cols:[{name,data:A(12)}]}} */
    expCols:[],  /* [{name, cat, data:A(12), isDaromad}] â€” all individual columns */
    omborDept:{},tenure:{},vacTypes:{},topOmborItems:[],
    /* Detail records */
    staffList:[],vacList:[],sickList:[],jubList:[],dafnList:[],contractList:[],omborList:[]
  };
}
function A(n){return new Array(n).fill(0)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXCEL PARSER â€” FULLY DYNAMIC (header-based column detection)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MM = {'yanvar':0,'fevral':1,'mart':2,'aprel':3,'may':4,'iyun':5,'iyul':6,'avgust':7,'sentabr':8,'oktabr':9,'noyabr':10,'dekabr':11,'ÑĞ½Ğ²Ğ°Ñ€ÑŒ':0,'Ñ„ĞµĞ²Ñ€Ğ°Ğ»ÑŒ':1,'Ğ¼Ğ°Ñ€Ñ‚':2,'Ğ°Ğ¿Ñ€ĞµĞ»ÑŒ':3,'Ğ¼Ğ°Ğ¹':4,'Ğ¸ÑĞ½ÑŒ':5,'Ğ¸ÑĞ»ÑŒ':6,'Ğ°Ğ²Ğ³ÑƒÑÑ‚':7,'ÑĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ':8,'Ğ¾ĞºÑ‚ÑĞ±Ñ€ÑŒ':9,'Ğ½Ğ¾ÑĞ±Ñ€ÑŒ':10,'Ğ´ĞµĞºĞ°Ğ±Ñ€ÑŒ':11};
function mIdx(v){if(!v)return -1;const s=String(v).trim().toLowerCase().replace(/[\u200B\uFEFF\u00A0\u200C\u200D]/g,'');if(MM[s]!==undefined)return MM[s];for(const[k,vi]of Object.entries(MM)){if(s.startsWith(k.substring(0,3)))return vi}return -1}
/* Robust N(): handles numbers, string numbers, formatted strings like "1,200,500" */
function N(v){if(typeof v==='number'&&isFinite(v))return v;if(v==null||v==='')return 0;if(typeof v==='string'){const n=parseFloat(v.replace(/[\s,\u00A0]/g,''));return isFinite(n)?n:0}return 0}

/* â”€â”€ Universal helper: normalize text for matching â”€â”€ */
function norm(v){return String(v||'').toLowerCase().replace(/[Ê»Ê¼''`']/g,"'").replace(/[\s\-_]+/g,' ').trim()}

/* â”€â”€ Universal helper: find header row and map columns by keyword patterns â”€â”€
   mappings = { fieldName: [keyword1, keyword2, ...], ... }
   Returns { headerRow: number, cols: { fieldName: colIndex, ... } }
   Scans first maxScan rows, picks row with most keyword matches */
function autoMap(rows, mappings, maxScan){
  maxScan=maxScan||10;
  let bestRow=-1, bestScore=0, bestCols={};
  /* Scan each candidate row */
  for(let r=0;r<Math.min(maxScan,rows.length);r++){
    const row=rows[r]; if(!row)continue;
    let score=0, cols={};
    /* Also check row+1 for merged/split headers */
    const nextRow=rows[r+1]||[];
    for(const[field,keywords]of Object.entries(mappings)){
      for(let c=0;c<row.length;c++){
        const t=norm(row[c]);
        /* Also merge with cell below for split headers */
        const t2=t+' '+norm(nextRow[c]);
        for(const kw of keywords){
          if(t.includes(kw)||t2.includes(kw)){
            if(!cols[field]){cols[field]=c;score++;break}
          }
        }
        if(cols[field]!==undefined)break;
      }
    }
    if(score>=bestScore){bestScore=score;bestRow=r;bestCols=cols}
  }
  return {headerRow:bestRow, cols:bestCols, score:bestScore};
}

/* â”€â”€ Universal helper: find first data row (skip headers, sub-headers, totals) â”€â”€ */
function findDataStart(rows, headerRow, idCol){
  /* Start after header row, skip sub-header rows and summary rows */
  for(let r=headerRow+1;r<Math.min(headerRow+6,rows.length);r++){
    const row=rows[r];if(!row)continue;
    const v0=String(row[idCol!==undefined?idCol:0]||'').trim().toLowerCase();
    /* Skip rows like "A,B,C..." or "1,2,3..." column numbering or "Jami" totals */
    if(/^[a-e]$/i.test(v0))continue;
    if(v0==='jami'||v0.includes('jami'))continue;
    /* First row with a numeric ID or actual data */
    const firstVal=row[idCol!==undefined?idCol:0];
    if(typeof firstVal==='number'||(firstVal&&/^\d+$/.test(String(firstVal).trim())))return r;
  }
  return headerRow+1; /* fallback */
}

/* â”€â”€ Universal helper: parse date from any format â”€â”€ */
function parseDate(dv){
  if(!dv)return null;
  if(dv instanceof Date)return dv;
  if(typeof dv==='number')return new Date((dv-25569)*864e5);
  const s=String(dv).trim();
  /* DD.MM.YYYY format */
  const dmy=s.match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{4})/);
  if(dmy)return new Date(Date.UTC(+dmy[3],+dmy[2]-1,+dmy[1]));
  const p=Date.parse(s);
  return isNaN(p)?null:new Date(p);
}
/* Safe month extraction â€” always UTC to avoid timezone shifts */
function dateMonth(dv){const dt=parseDate(dv);return dt?dt.getUTCMonth():-1}
function dateStr(dv){const dt=parseDate(dv);return dt?dt.toISOString().slice(0,10):String(dv||'').slice(0,10)}

/* â”€â”€ Universal helper: find sheet by flexible keyword matching â”€â”€ */
function findSheet(sheets, keywords){
  /* Try exact substring match first, then fuzzy */
  for(const kw of keywords){
    const found=sheets.find(s=>s.toLowerCase().includes(kw));
    if(found)return found;
  }
  return null;
}

function parseExcel(wb){
  const d=emptyData(), sheets=wb.SheetNames;

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     1) Ğ”ĞĞ ĞĞœĞĞ” Ğ¥ĞĞ ĞĞ–ĞĞ¢ â€” ALL columns, auto-categorized
     Row 1: account codes (45xxx=daromad, 56xxx=xarajat)
     Row 2: category groups (Ish haqi, Kommunal, etc.)
     Row 3: individual column headers
     Row 4: totals
     Row 5+: month data (Yanvar, Fevral, ...)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const expN=findSheet(sheets,['Ğ´Ğ°Ñ€Ğ¾Ğ¼Ğ°Ğ´','Ñ…Ğ°Ñ€Ğ°Ğ¶Ğ°Ñ‚','xarajat','daromad','Ñ€Ğ°ÑÑ…Ğ¾Ğ´','Ğ´Ğ¾Ñ…Ğ¾Ğ´']);
  if(expN){ try{
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[expN],{header:1,defval:null});

    /* â”€â”€ Step 1: Find the category row and header row â”€â”€ */
    let catRow=-1, hdrRow=-1;
    for(let r=0;r<Math.min(8,rows.length);r++){
      const row=rows[r];if(!row)continue;
      let descCells=0, numCells=0, codeCells=0;
      for(let c=0;c<row.length;c++){
        const v=row[c]; if(v==null)continue;
        if(typeof v==='number'){numCells++;continue}
        if(typeof v==='string'&&v.length>3){
          /* Distinguish: account codes (all digits) vs descriptive text (has letters) */
          if(/[a-zA-ZĞ°-ÑĞ-Ğ¯Ñ‘Ğ]/.test(v))descCells++;  /* has letters = real text */
          else if(/^\d+$/.test(v.trim()))codeCells++;     /* all digits = account code */
          else descCells++; /* mixed = treat as text */
        }
      }
      /* Category row: few descriptive cells, no numbers (e.g. "Ish haqi", "Kommunal") */
      if(descCells>=2&&descCells<=20&&numCells===0&&catRow<0){
        const first=row.findIndex(v=>v&&typeof v==='string'&&/[a-zA-ZĞ°-ÑĞ-Ğ¯]/.test(v)&&String(v).length>3);
        if(first>=2)catRow=r;
      }
      /* Header row: many descriptive text cells (not account codes) */
      if(descCells>15&&hdrRow<0)hdrRow=r;
    }
    if(hdrRow<0)hdrRow=2; /* fallback: row 3 (index 2) */

    /* â”€â”€ Step 2: Build category map from catRow â”€â”€ */
    const catMap={}; /* colIndex â†’ categoryName */
    if(catRow>=0){
      const cRow=rows[catRow];
      let lastCat='Banknotalarni tashish xarajatlari';
      /* Category cells mark the START of a group */
      const catStarts=[];
      for(let c=0;c<(cRow||[]).length;c++){
        if(cRow[c]&&typeof cRow[c]==='string'&&String(cRow[c]).trim().length>2){
          catStarts.push({c,name:String(cRow[c]).trim()});
        }
      }
      /* Assign each column to its category (from catStart to next catStart-1) */
      for(let i=0;i<catStarts.length;i++){
        const start=catStarts[i].c;
        const end=i+1<catStarts.length?catStarts[i+1].c:999;
        for(let c=start;c<end;c++)catMap[c]=catStarts[i].name;
      }
    }

    /* â”€â”€ Step 3: Map ALL columns with auto-detection â”€â”€ */
    const hRow=rows[hdrRow]||[];
    const acctRow=rows[0]||[]; /* row 1: account codes */
    const allCols=[];
    const cm={}; /* backward-compatible field mapping */

    /* kwMap for backward-compatible fields */
    const kwMap={
      ishHaqi:['hisoblangan ish haqi','ish haqi fond'],
      ustama:['ustama ish haqi'],
      staj:[['staj','xarajat']],
      mehnatTatil:[['mehnat ta','til']],
      oquvTatil:["o'quv ta","oquv ta"],
      bayramMukofot:['bayram mukofot','bayram mukofoti'],
      ijtimoiySoliq:['ijtimoiy soliq'],
      bolnichny:['mehnatga layoqatsizlik','kasallik nafaqa'],
      banknotalar:['banknotalar','banknot'],
      elektr:['elektr energiya'],
      gaz:['tabiiy gaz'],
      qoriqlash:["qo'riqlash","qoriqlash",'bank binosini'],
      avtomobil:['avtomobil xizmat','avtomobil'],
      debetDaromad:['debet aylanma','debet'],
      bankomatDaromad:['bankomat daromad','bankomat'],
    };

    for(let c=2;c<hRow.length;c++){
      const name=String(hRow[c]||'').trim();
      if(!name||name.length<3)continue;
      const t=norm(name);
      /* Determine if this is daromad (income) based on account code */
      const acctCode=String(acctRow[c]||'');
      const isDaromad=acctCode.startsWith('45')||t.includes('daromad')||t.includes('bankomat daromad');
      /* Get category from catMap or infer */
      const cat=catMap[c]||(isDaromad?'Daromad':'Banknotalarni tashish xarajatlari');
      /* Create column tracking object */
      const colObj={name, cat, col:c, data:A(12), isDaromad};
      allCols.push(colObj);
      /* Also try to match backward-compatible kwMap fields */
      for(const[field,patterns]of Object.entries(kwMap)){
        if(cm[field]!==undefined)continue;
        for(const kws of patterns){
          if(Array.isArray(kws)?kws.every(k=>t.includes(k)):t.includes(kws)){cm[field]=c;break}
        }
      }
    }

    /* â”€â”€ Step 4: Parse month data rows â”€â”€ */
    for(let r=0;r<rows.length;r++){
      const row=rows[r];if(!row)continue;
      let mi=mIdx(row[0]);
      if(mi<0&&row[1])mi=mIdx(row[1]);
      if(mi<0)continue;
      /* Populate all columns */
      for(const col of allCols){
        if(col.col<row.length){
          const v=N(row[col.col]);
          col.data[mi]+=v;
          if(col.isDaromad)d.daromadByMonth[mi]+=v;
          else d.xarajatByMonth[mi]+=v;
        }
      }
      /* Populate backward-compatible fields */
      for(const[key,ci]of Object.entries(cm)){if(d[key]&&ci<row.length)d[key][mi]+=N(row[ci])}
    }

    /* â”€â”€ Step 5: Build category summaries â”€â”€ */
    const cats={};
    for(const col of allCols){
      const cn=col.isDaromad?'ğŸ’° Daromad':col.cat;
      if(!cats[cn])cats[cn]={total:A(12),cols:[],isDaromad:col.isDaromad};
      cats[cn].cols.push({name:col.name,data:[...col.data]});
      for(let m=0;m<12;m++)cats[cn].total[m]+=col.data[m];
    }
    d.expCats=cats;
    d.expCols=allCols;

    console.log('[Parser] Daromad-Xarajat: '+allCols.length+' cols, '+Object.keys(cats).length+' cats, ishHaqi='+d.ishHaqi.reduce((a,b)=>a+b,0).toLocaleString()+', xarajat='+d.xarajatByMonth.reduce((a,b)=>a+b,0).toLocaleString()+', daromad='+d.daromadByMonth.reduce((a,b)=>a+b,0).toLocaleString());
  }catch(e){console.error('[Parser] Daromad error:',e)} }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     2) Ğ¢ĞĞªĞ¢Ğ˜Ğ› â€” vacation records
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const tN=findSheet(sheets,['Ñ‚Ğ°ÑŠÑ‚Ğ¸Ğ»',"ta'til",'tatil','Ğ¾Ñ‚Ğ¿ÑƒÑĞº']);
  if(tN){ try{
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[tN],{header:1,defval:null,cellDates:true});
    const map=autoMap(rows,{
      no:['â„–'],
      name:['f.i.o','f.i.sh'],
      dept:["bo'linma",'tarkibiy'],
      date:["chiqish haqidagi",'buyruq sana'],
      num:['raqami'],
      type:["ta'til turi",'turi'],
      dur:["ta'til muddat",'muddati'],
      period:["ta'til davr",'davriyligi'],
    });
    const c=map.cols;
    const startR=findDataStart(rows,map.headerRow,c.no);
    /* Monthly counts + vacation types */
    const tc={};
    for(let r=startR;r<rows.length;r++){
      const row=rows[r];if(!row)continue;
      /* Need at least a name */
      const nameVal=c.name!==undefined?row[c.name]:row[1];
      if(!nameVal)continue;
      /* Find date â€” try mapped column, then scan for Date objects */
      let dv=c.date!==undefined?row[c.date]:null;
      if(!dv){for(let cc=0;cc<row.length;cc++){if(row[cc] instanceof Date){dv=row[cc];break}}}
      const dt=parseDate(dv);
      if(dt){const mi=dt.getUTCMonth();if(mi>=0&&mi<12)d.vacationByMonth[mi]++}
      /* Vacation type */
      const tv=c.type!==undefined?row[c.type]:null;
      if(tv){const t=String(tv).trim();tc[t]=(tc[t]||0)+1}
      /* Detail record */
      d.vacList.push({
        name:String(nameVal),
        dept:String(c.dept!==undefined?row[c.dept]||'':''),
        date:dateStr(dv),
        num:String(c.num!==undefined?row[c.num]||'':''),
        type:String(tv||''),
        dur:String(c.dur!==undefined?row[c.dur]||'':''),
        period:String(c.period!==undefined?row[c.period]||'':''),
      });
    }
    for(const[k,v]of Object.entries(tc)){
      const key=k.toLowerCase().includes('mehnat')?"Mehnat ta'tili":k.toLowerCase().includes('quv')?"O'quv ta'tili":k;
      d.vacTypes[key]=(d.vacTypes[key]||0)+v;
    }
    console.log('[Parser] Tatil:',d.vacList.length,'records, months:',d.vacationByMonth.reduce((a,b)=>a+b,0));
  }catch(e){console.error('[Parser] Tatil error:',e)} }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     3) Ğ‘ĞĞ›Ğ¬ĞĞ˜Ğ§ĞĞ«Ğ™ â€” sick leave records
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const sN=findSheet(sheets,['Ğ±Ğ¾Ğ»ÑŒĞ½Ğ¸Ñ‡','kasallik','bolnichny']);
  if(sN){ try{
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[sN],{header:1,defval:null});
    const map=autoMap(rows,{
      no:['â„–'],
      name:['f.i.o','f.i.sh','familiya'],
      dept:["bo'linma",'tarkibiy'],
      month:["to'lov qilingan",'kasallik varaqasi'],
      period:['davriyligi','davriy'],
      cnt:['soni'],
    });
    const c=map.cols;
    const startR=findDataStart(rows,map.headerRow,c.no);
    /* Fallback: if autoMap didn't find month column, scan data for it */
    if(c.month===undefined){
      for(let r=startR;r<Math.min(startR+10,rows.length);r++){
        const row=rows[r];if(!row)continue;
        for(let cc=0;cc<row.length;cc++){
          if(mIdx(row[cc])>=0){c.month=cc;break}
        }
        if(c.month!==undefined)break;
      }
    }
    if(c.name===undefined){/* fallback: column after 'â„–' */
      if(c.no!==undefined)c.name=c.no+1;else c.name=1;
    }
    for(let r=startR;r<rows.length;r++){
      const row=rows[r];if(!row)continue;
      const nameVal=c.name!==undefined?row[c.name]:row[1];
      if(!nameVal)continue;
      /* Month â€” try mapped column */
      const mv=c.month!==undefined?row[c.month]:null;
      if(mv){const mi=mIdx(mv);if(mi>=0)d.sickByMonth[mi]++}
      /* Detail record */
      d.sickList.push({
        name:String(nameVal),
        dept:String(c.dept!==undefined?row[c.dept]||'':''),
        month:String(mv||''),
        period:String(c.period!==undefined?row[c.period]||'':''),
        cnt:String(c.cnt!==undefined?row[c.cnt]||'':''),
      });
    }
    console.log('[Parser] Bolnichny: headerRow=',map.headerRow,', cols=',JSON.stringify(c),', startR=',startR,', records=',d.sickList.length,', sickSum=',d.sickByMonth.reduce((a,b)=>a+b,0));
  }catch(e){console.error('[Parser] Bolnichny error:',e)} }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     4) ĞĞœĞ‘ĞĞ  Ğ§Ğ˜ĞšĞ˜Ğœ â€” warehouse outgoing
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const oN=findSheet(sheets,['Ğ¾Ğ¼Ğ±Ğ¾Ñ€','ombor','ÑĞºĞ»Ğ°Ğ´']);
  if(oN){ try{
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[oN],{header:1,defval:null,cellDates:true});
    const map=autoMap(rows,{
      no:['â„–'],
      dept:["bo'lim",'talabnoma'],
      date:['sana'],
      item:['mahsulot nomi','tovar nomi'],
      unit:["o'lchov",'birligi'],
      qty:['soni','miqdor'],
      price:['narx','narxi'],
      summa:['summasi','summa'],
    });
    const c=map.cols;
    const startR=findDataStart(rows,map.headerRow,c.no);
    const dT={},iQ={};
    for(let r=startR;r<rows.length;r++){
      const row=rows[r];if(!row)continue;
      /* Skip summary/total rows */
      const v0=norm(c.dept!==undefined?row[c.dept]:'');
      if(v0==='jami')continue;
      /* Get date */
      const dv=c.date!==undefined?row[c.date]:null;
      const dt=parseDate(dv);
      /* Get summa â€” try summa column, fallback to price*qty */
      let sm=c.summa!==undefined?N(row[c.summa]):0;
      if(!sm && c.price!==undefined && c.qty!==undefined) sm=N(row[c.price])*N(row[c.qty]);
      if(dt){const mi=dt.getUTCMonth();if(mi>=0&&mi<12)d.omborChiqim[mi]+=sm}
      /* Department totals */
      const dept=c.dept!==undefined?row[c.dept]:null;
      if(dept){const dk=String(dept).trim();if(dk)dT[dk]=(dT[dk]||0)+sm}
      /* Item quantities */
      const item=c.item!==undefined?row[c.item]:null;
      const qty=c.qty!==undefined?N(row[c.qty]):0;
      if(item){const ik=String(item).trim();if(ik)iQ[ik]=(iQ[ik]||0)+qty}
      /* Store raw record for drill-down */
      const mi2=dt?dt.getUTCMonth():-1;
      d.omborList.push({item:item?String(item).trim():'',dept:dept?String(dept).trim():'',month:mi2,qty:qty,summa:sm,date:dateStr(dv)})
    }
    d.omborDept=Object.fromEntries(Object.entries(dT).sort((a,b)=>b[1]-a[1]).slice(0,8));
    d.topOmborItems=Object.entries(iQ).sort((a,b)=>b[1]-a[1]).slice(0,12).map(([name,qty])=>({name,qty}));
    console.log('[Parser] Ombor:',Object.keys(d.omborDept).length,'depts,',d.topOmborItems.length,'items, chiqim sum=',d.omborChiqim.reduce((a,b)=>a+b,0));
  }catch(e){console.error('[Parser] Ombor error:',e)} }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     5) Ğ¨ĞĞ Ğ¢ĞĞĞœĞĞ›ĞĞ  â€” contracts (categorized)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const shN=findSheet(sheets,['ÑˆĞ°Ñ€Ñ‚Ğ½Ğ¾Ğ¼Ğ°','shartnoma','ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚','Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€']);
  if(shN){ try{
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[shN],{header:1,defval:null,cellDates:true});
    const map=autoMap(rows,{
      no:['â„–'],
      type:['savdo turi'],
      date:['shartnoma sana'],
      provider:['yetkazib beruvchi','beruvchi nomi'],
      cat:['ombor/xizmat','ombor xizmat'],
      stir:['stir','inn'],
      snum:['shartnoma raqam'],
      product:['mahsulot (ish','xizmat) nomi','mahsulot nomi'],
      qty:['soni','miqdor'],
      unit:["o'lchov",'birligi'],
      summa:['shartnoma summa','summasi'],
      note:['izoh','eslatma'],
    });
    const c=map.cols;
    const startR=findDataStart(rows,map.headerRow,c.no);
    /* Disambiguate: if 'provider' and 'product' mapped to same column, find product separately */
    if(c.provider===c.product){
      /* provider usually comes before product â€” re-scan */
      for(let cc=0;cc<(rows[map.headerRow]||[]).length;cc++){
        const t=norm(rows[map.headerRow][cc]);
        if(cc!==c.provider && (t.includes('nomi')&&!t.includes('beruvchi'))){c.product=cc;break}
      }
    }

    for(let r=startR;r<rows.length;r++){
      const row=rows[r];if(!row)continue;
      /* Skip total rows */
      const provVal=c.provider!==undefined?row[c.provider]:null;
      if(!provVal)continue;
      if(norm(provVal)==='jami')continue;

      /* Date */
      const dv=c.date!==undefined?row[c.date]:null;
      const dt=parseDate(dv);
      /* Summa */
      const sm=c.summa!==undefined?N(row[c.summa]):0;
      /* Category: ombor / xizmat / asosiy vosita */
      const catRaw=norm(c.cat!==undefined?row[c.cat]:'');
      const cat=catRaw.includes('ombor')?'ombor':catRaw.includes('asosiy')?'asosiy':'xizmat';

      /* Monthly kirim by category */
      if(dt){const mi=dt.getUTCMonth();if(mi>=0&&mi<12){
        d.shartnomalarKirim[mi]+=sm;
        if(cat==='ombor')d.mahsulotKirim[mi]+=sm;
        else if(cat==='asosiy')d.asosiyVositaKirim[mi]+=sm;
        else d.xizmatKirim[mi]+=sm;
      }}

      /* Detail record */
      d.contractList.push({
        no:String(c.no!==undefined?row[c.no]||'':''),
        type:String(c.type!==undefined?row[c.type]||'':''),
        date:dateStr(dv),
        provider:String(provVal),
        cat:cat,
        stir:String(c.stir!==undefined?row[c.stir]||'':''),
        snum:String(c.snum!==undefined?row[c.snum]||'':''),
        product:String(c.product!==undefined?row[c.product]||'':''),
        qty:String(c.qty!==undefined?row[c.qty]||'':''),
        unit:String(c.unit!==undefined?row[c.unit]||'':''),
        summa:sm,
        note:String(c.note!==undefined?row[c.note]||'':''),
      });
    }
    console.log('[Parser] Shartnomalar:',d.contractList.length,'records, mahsulotKirim sum=',d.mahsulotKirim.reduce((a,b)=>a+b,0));
  }catch(e){console.error('[Parser] Shartnomalar error:',e)} }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     6) Ğ’Ğ«Ğ¡Ğ›Ğ£Ğ“Ğ â€” staff tenure
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const vN=findSheet(sheets,['Ğ²Ñ‹ÑĞ»ÑƒĞ³Ğ°','ÑÑ‚Ğ°Ğ¶','staj']);
  if(vN){ try{
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[vN],{header:1,defval:null,cellDates:true});
    const map=autoMap(rows,{
      no:['â„–'],
      name:['f.i.o','f.i.sh'],
      start:['ish boshlagan'],
      stajText:['bank tizimidagi ish staj'],
      stajYil:['staji yili','staj yil'],
      pct:["to'lov miqdor","qo'shimcha to'lov"],
    });
    const c=map.cols;
    const startR=findDataStart(rows,map.headerRow,c.no);
    const bk={};
    for(let r=startR;r<rows.length;r++){
      const row=rows[r];if(!row)continue;
      const nameVal=c.name!==undefined?row[c.name]:row[1];
      if(!nameVal)continue;
      /* Find staj yil â€” try mapped column, then scan for small integer */
      let y=c.stajYil!==undefined?parseInt(row[c.stajYil]):NaN;
      if(isNaN(y)){/* fallback: scan for column with small number (1-50) */
        for(let cc=0;cc<row.length;cc++){const v=parseInt(row[cc]);if(v>=1&&v<=50&&cc!==(c.no||0)){y=v;break}}
      }
      if(isNaN(y))continue;

      let b;if(y<=5)b='0-5 yil';else if(y<=10)b='6-10 yil';else if(y<=15)b='11-15 yil';else if(y<=20)b='16-20 yil';else if(y<=25)b='21-25 yil';else b='25+ yil';
      bk[b]=(bk[b]||0)+1;

      const st=c.start!==undefined?row[c.start]:null;
      d.staffList.push({
        name:String(nameVal),
        start:dateStr(st),
        stajText:String(c.stajText!==undefined?row[c.stajText]||'':''),
        stajYil:y,
        pct:String(c.pct!==undefined?row[c.pct]||'':''),
        bucket:b,
      });
    }
    d.tenure=bk;
    console.log('[Parser] Vysluga:',d.staffList.length,'staff');
  }catch(e){console.error('[Parser] Vysluga error:',e)} }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     7) Ğ¢ĞĞªĞ¢Ğ˜Ğ› detail â€” (already parsed above, skip if tN)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /* Vacation detail records are now parsed inline in section 2 */

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     8) Ğ‘ĞĞ›Ğ¬ĞĞ˜Ğ§ĞĞ«Ğ™ detail â€” (already parsed above in section 3)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     9) 50-60 ĞĞ¨ â€” jubilee records
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const jN=findSheet(sheets,['50-60','Ñ‘Ñˆ','yubiley','ÑĞ±Ğ¸Ğ»ĞµĞ¹']);
  if(jN){ try{
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[jN],{header:1,defval:null,cellDates:true});
    const map=autoMap(rows,{
      no:['â„–'],
      name:['f.i.o','f.i.sh'],
      dept:["bo'linma",'tarkibiy'],
      date:["chiqish haqidagi",'buyruq sana'],
      num:['raqami'],
      age:['yubiley yosh','yoshi'],
    });
    const c=map.cols;
    const startR=findDataStart(rows,map.headerRow,c.no);
    for(let r=startR;r<rows.length;r++){
      const row=rows[r];if(!row)continue;
      const nameVal=c.name!==undefined?row[c.name]:row[1];
      if(!nameVal)continue;
      const dv=c.date!==undefined?row[c.date]:null;
      d.jubList.push({
        name:String(nameVal),
        dept:String(c.dept!==undefined?row[c.dept]||'':''),
        date:dateStr(dv),
        num:String(c.num!==undefined?row[c.num]||'':''),
        age:String(c.age!==undefined?row[c.age]||'':''),
      });
    }
    console.log('[Parser] Jubilee:',d.jubList.length,'records');
  }catch(e){console.error('[Parser] Jubilee error:',e)} }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     10) Ğ”ĞĞ¤Ğ â€” funeral aid records
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const dN=findSheet(sheets,['Ğ´Ğ°Ñ„Ğ½','dafn','Ğ¿Ğ¾Ñ…Ğ¾Ñ€Ğ¾Ğ½']);
  if(dN){ try{
    const rows=XLSX.utils.sheet_to_json(wb.Sheets[dN],{header:1,defval:null});
    const map=autoMap(rows,{
      no:['â„–'],
      name:['f.i.o','f.i.sh'],
      dept:["bo'linma",'tarkibiy'],
      month:['moddiy yordam','berilgan'],
    });
    const c=map.cols;
    const startR=findDataStart(rows,map.headerRow,c.no);
    for(let r=startR;r<rows.length;r++){
      const row=rows[r];if(!row)continue;
      const nameVal=c.name!==undefined?row[c.name]:row[1];
      if(!nameVal)continue;
      d.dafnList.push({
        name:String(nameVal),
        dept:String(c.dept!==undefined?row[c.dept]||'':''),
        month:String(c.month!==undefined?row[c.month]||'':''),
      });
    }
    console.log('[Parser] Dafn:',d.dafnList.length,'records');
  }catch(e){console.error('[Parser] Dafn error:',e)} }

  return d;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE UPLOAD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('fileInput').addEventListener('change',function(e){
  const file=e.target.files[0];if(!file)return;
  document.getElementById('loadingOverlay').classList.add('show');
  document.getElementById('uploadStatus').textContent=file.name;
  document.getElementById('uploadStatus').className='upload-status loaded';
  const reader=new FileReader();
  reader.onload=function(e){
    try{const data=new Uint8Array(e.target.result);const workbook=XLSX.read(data,{type:'array',cellDates:true});D=parseExcel(workbook);rebuildCharts();document.getElementById('loadingOverlay').classList.remove('show');
      /* Auto voice alert for low stock items after data load */
      setTimeout(autoWarehouseAlert, 1500);
    }
    catch(err){console.error(err);document.getElementById('loadingOverlay').classList.remove('show');alert("Xatolik: "+err.message)}
  };reader.readAsArrayBuffer(file);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITIES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const fmt=v=>{if(v===null||v===undefined||isNaN(v))return 'â€”';const a=Math.abs(v);if(a>=1e9)return(v/1e9).toFixed(1)+' mlrd';if(a>=1e6)return(v/1e6).toFixed(1)+' mln';if(a>=1e3)return(v/1e3).toFixed(0)+' ming';if(a>0&&a<1)return v.toFixed(2);return v.toFixed(0)};
const fmtF=v=>new Intl.NumberFormat('uz-UZ').format(Math.round(v));
/* Voice-specific format â€” reads full Uzbek words, NO decimals, NO zeros as "oh" */
/* â•â•â• TTS: Barcha raqamlarni O'ZBEK SO'ZLARIGA aylantirish â•â•â• */

/* fmtV: Pul summasini to'liq O'zbek so'zlari bilan ifodalash â€” RAQAM BO'LMASLIGI KERAK */
const fmtV=v=>{
  if(v===null||v===undefined||v===0||isNaN(v)) return 'nol';
  const neg=v<0; const a=Math.abs(v);
  let parts=[];
  if(a>=1e9){
    const mlrd=Math.floor(a/1e9);
    const qoldiq=a-mlrd*1e9;
    parts.push(numToUzWords(mlrd)+' milliard');
    if(qoldiq>=1e6){parts.push(numToUzWords(Math.round(qoldiq/1e6))+' million')}
    else if(qoldiq>=1e3){parts.push(numToUzWords(Math.round(qoldiq/1e3))+' ming')}
  } else if(a>=1e6){
    const mln=Math.floor(a/1e6);
    const qoldiq=a-mln*1e6;
    parts.push(numToUzWords(mln)+' million');
    if(qoldiq>=1e3){parts.push(numToUzWords(Math.round(qoldiq/1e3))+' ming')}
  } else if(a>=1e3){
    parts.push(numToUzWords(Math.round(a/1e3))+' ming');
  } else {
    parts.push(numToUzWords(Math.round(a)));
  }
  return (neg?'minus ':'')+parts.join(' ');
};

/* numToUzWords: Butun sonni to'liq O'zbek so'zlariga aylantirish (0-999999999999) */
function numToUzWords(n){
  if(n===null||n===undefined||isNaN(n)) return 'nol';
  n=Math.round(Math.abs(n));
  if(n===0) return 'nol';
  const ones=['','bir','ikki','uch','to\'rt','besh','olti','yetti','sakkiz','to\'qqiz'];
  const teens=['o\'n','o\'n bir','o\'n ikki','o\'n uch','o\'n to\'rt','o\'n besh','o\'n olti','o\'n yetti','o\'n sakkiz','o\'n to\'qqiz'];
  const tens=['','o\'n','yigirma','o\'ttiz','qirq','ellik','oltmish','yetmish','sakson','to\'qson'];

  function chunk(num){
    if(num===0)return '';
    let w=[];
    if(num>=100){
      const h=Math.floor(num/100);
      w.push((h===1?'':ones[h]+' ')+'yuz');
      num%=100;
    }
    if(num>=20){w.push(tens[Math.floor(num/10)]);num%=10}
    else if(num>=10){w.push(teens[num-10]);return w.join(' ')}
    if(num>0)w.push(ones[num]);
    return w.join(' ');
  }

  let result=[];
  if(n>=1e12){result.push(chunk(Math.floor(n/1e12))+' trillion');n%=1e12}
  if(n>=1e9){result.push(chunk(Math.floor(n/1e9))+' milliard');n%=1e9}
  if(n>=1e6){result.push(chunk(Math.floor(n/1e6))+' million');n%=1e6}
  if(n>=1e3){result.push(chunk(Math.floor(n/1e3))+' ming');n%=1e3}
  if(n>0)result.push(chunk(n));
  return result.join(' ').replace(/\s+/g,' ').trim();
}

/* cleanForTTS: Matnni TTS uchun tozalash â€” HECH QANDAY RAQAM QOLMASLIGI KERAK */
function cleanForTTS(text){
  let t = text;

  /* â”€â”€ 1) Qisqartmalarni to'liq so'zga aylantirish â”€â”€ */
  t = t.replace(/\bmlrd\b/gi,'milliard');
  t = t.replace(/\bmln\b/gi,'million');
  t = t.replace(/\bso'm\b/gi,"so'm");
  t = t.replace(/\bmln\.\b/gi,'million');
  t = t.replace(/\bmlrd\.\b/gi,'milliard');

  /* â”€â”€ 2) "5 ta" â†’ "besh ta", "3-chi" â†’ "uchinchi" â”€â”€ */
  t = t.replace(/\b(\d+)\s*ta\b/gi, function(m,n){return numToUzWords(parseInt(n))+' ta'});
  const ordinals={'1':'birinchi','2':'ikkinchi','3':'uchinchi','4':"to'rtinchi",'5':'beshinchi',
    '6':'oltinchi','7':'yettinchi','8':'sakkizinchi','9':"to'qqizinchi",'10':"o'ninchi"};
  t = t.replace(/\b(\d+)[\s\-]*chi\b/gi, function(m,n){return ordinals[n]||(numToUzWords(parseInt(n))+'inchi')});

  /* â”€â”€ 3) Bo'shliqli raqamlarni birlashtirish: "100 000" â†’ "100000" â”€â”€ */
  let prev='';
  while(prev!==t){prev=t;t=t.replace(/(\d)\s+(\d{3})(?=\s|[^0-9]|$)/g,'$1$2')}
  /* Vergul bilan: "100,000" â†’ "100000" */
  t = t.replace(/(\d),(\d{3})/g,'$1$2');

  /* â”€â”€ 4) Mahsulot o'lchovlarini olib tashlash â”€â”€ */
  t = t.replace(/\d+[\.,]\d+\s*(mm|sm|kg|gr|ml|lt|m|cm)\b/gi,' ');

  /* â”€â”€ 5) Foizlar: "15.6%" â†’ "o'n besh butun olti foiz" â”€â”€ */
  t = t.replace(/(\d+)\.(\d+)\s*%/g, function(m,a,b){return numToUzWords(parseInt(a))+' butun '+numToUzWords(parseInt(b))+' foiz'});
  t = t.replace(/(\d+)\s*%/g, function(m,a){return numToUzWords(parseInt(a))+' foiz'});

  /* â”€â”€ 6) Kasr sonlar: "4.1" â†’ "to'rt butun bir" â”€â”€ */
  t = t.replace(/(\d+)\.(\d+)/g, function(m,a,b){
    const ai=parseInt(a),bi=parseInt(b);
    if(bi===0) return numToUzWords(ai);
    return numToUzWords(ai)+' butun '+numToUzWords(bi);
  });

  /* â”€â”€ 7) BARCHA qolgan raqamlarni so'zga aylantirish (1 xonali HAM) â”€â”€ */
  t = t.replace(/\d+/g, function(m){return numToUzWords(parseInt(m))});

  /* â”€â”€ 8) Yakuniy XAVFSIZLIK â€” agar biron raqam qolgan bo'lsa, o'chirish â”€â”€ */
  /* Bu hech qachon ishlamasligi kerak, lekin xavfsizlik uchun */
  t = t.replace(/[0-9]/g,'');

  /* â”€â”€ 9) Tozalash â”€â”€ */
  t = t.replace(/\s{2,}/g,' ').trim();

  return t;
}
const sum=a=>a.reduce((s,v)=>s+v,0);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setTheme(t){currentTheme=t;document.body.setAttribute('data-theme',t);document.getElementById('btn-afternoon').classList.toggle('active',t==='afternoon');document.getElementById('btn-evening').classList.toggle('active',t==='evening');if(D)setTimeout(rebuildCharts,100)}

function switchTab(id,btn){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));document.getElementById('tab-'+id).classList.add('active');btn.classList.add('active');if(D)setTimeout(rebuildCharts,50)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let charts={};
/* Global AI model results â€” speakForecast va modal configs uchun */
let aiModelE=null; /* xarajat masterForecast natijasi */
let aiModelW=null; /* ombor masterForecast natijasi */
function destroyCharts(){Object.values(charts).forEach(c=>{if(c&&c.destroy)c.destroy()});charts={}}

function bOpts(ov={}){
  const p=P();
  return{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{labels:{color:p.text,font:{family:"'Source Sans 3'",size:12},usePointStyle:true,pointStyle:'rectRounded',padding:16}},
      tooltip:{backgroundColor:p.cardBg,titleColor:p.text,bodyColor:p.text,borderColor:p.grid,borderWidth:1,padding:12,cornerRadius:10,
        titleFont:{family:"'Source Sans 3'",weight:'600',size:13},bodyFont:{family:"'Source Sans 3'",size:12},
        callbacks:{label:ctx=>{const v=ctx.parsed.y!==undefined&&ctx.parsed.x!==undefined?(ctx.chart.options.indexAxis==='y'?ctx.parsed.x:ctx.parsed.y):(ctx.parsed.y!==undefined?ctx.parsed.y:ctx.parsed);return ' '+ctx.dataset.label+': '+fmtF(v)+" so'm"}}},
      ...(ov.plugins||{})},
    scales:ov.noScales?undefined:{
      x:{ticks:{color:p.text,font:{size:11}},grid:{color:p.grid,lineWidth:.5},...(ov.xAxis||{})},
      y:{ticks:{color:p.text,font:{size:11},callback:v=>fmt(v)},grid:{color:p.grid,lineWidth:.5},...(ov.yAxis||{})},
      ...(ov.extraScales||{})},
    interaction:{mode:'index',intersect:false},...(ov.extra||{})};
}

function rebuildCharts(){
  if(!D)return;destroyCharts();const p=P();
  buildOverview(p);buildExpenseDetail(p);buildMonthly(p);buildQuarterly(p);buildWarehouse(p);buildAI(p);buildVacation(p);buildSickLeave(p);buildStaff(p);buildContracts(p);buildJubilee(p);buildAlerts(p);
}

/* â”€â”€â”€ OVERVIEW â”€â”€â”€ */
function buildOverview(p){
  const ti=sum(D.debetDaromad)+sum(D.bankomatDaromad);
  document.getElementById('kpi-overview').innerHTML=
    kpi(p.c1,'ğŸ’°','Jami ish haqi',fmt(sum(D.ishHaqi)),'Yillik jami','up','ishHaqi')+
    kpi(p.c3,'ğŸ‰','Bayram mukofoti',fmt(sum(D.bayramMukofot)),D.bayramMukofot.filter(v=>v>0).length+" marta to'langan",'','bayram')+
    kpi(p.c5,'âš¡','Kommunal xizmatlar',fmt(sum(D.elektr)+sum(D.gaz)),'Oyiga ~'+fmt((sum(D.elektr)+sum(D.gaz))/12),'up','elektr')+
    kpi(p.c4,'ğŸ¦','Jami daromad',fmt(ti),'Debet + Bankomat','up','daromad')+
    kpi(p.c7,'ğŸ–ï¸',"Ta'tilga chiqqanlar",sum(D.vacationByMonth),sum(D.vacationByMonth)+' marta','','tatil')+
    kpi(p.c8,'ğŸ¥',"Tibbiy ta'til",sum(D.sickByMonth),sum(D.sickByMonth)+' kasallik varaqi','down','kasallik');

  charts.ob=new Chart(document.getElementById('chartOverviewBar'),{type:'bar',data:{labels:MS,datasets:[
    {label:'Ish haqi',data:D.ishHaqi,backgroundColor:p.c1,borderRadius:4},
    {label:"Staj to'lovi",data:D.staj,backgroundColor:p.c4,borderRadius:4},
    {label:"Mehnat ta'tili",data:D.mehnatTatil,backgroundColor:p.c5,borderRadius:4},
    {label:'Bayram mukofoti',data:D.bayramMukofot,backgroundColor:p.c3,borderRadius:4},
    {label:'Ijtimoiy soliq',data:D.ijtimoiySoliq,backgroundColor:p.c6,borderRadius:4},
  ]},options:bOpts({plugins:{legend:{position:'top'}}})});

  const cats=[{l:'Ish haqi',v:sum(D.ishHaqi)},{l:'Bayram mukofot',v:sum(D.bayramMukofot)},{l:"Staj to'lov",v:sum(D.staj)},{l:'Ijtimoiy soliq',v:sum(D.ijtimoiySoliq)},{l:"Mehnat ta'til",v:sum(D.mehnatTatil)},{l:'Ustama ish haqi',v:sum(D.ustama)},{l:"Qo'riqlash",v:sum(D.qoriqlash)},{l:'Elektr energiya',v:sum(D.elektr)}];
  charts.cp=new Chart(document.getElementById('chartCategoryPie'),{type:'doughnut',data:{labels:cats.map(c=>c.l),datasets:[{data:cats.map(c=>c.v),backgroundColor:[p.c1,p.c3,p.c4,p.c6,p.c5,p.c2,p.c7,p.c8],borderWidth:2,borderColor:p.cardBg,borderRadius:6}]},options:{...bOpts({noScales:true,plugins:{legend:{position:'right',labels:{color:p.text,padding:12,font:{size:11}}},tooltip:{callbacks:{label:ctx=>' '+ctx.label+': '+fmt(ctx.parsed)}}}}),cutout:'55%'}});

  charts.ip=new Chart(document.getElementById('chartIncomePie'),{type:'doughnut',data:{labels:['Debet aylanma daromadi','Bankomat daromadi'],datasets:[{data:[sum(D.debetDaromad),sum(D.bankomatDaromad)],backgroundColor:[p.c5,p.c4],borderWidth:2,borderColor:p.cardBg,borderRadius:6}]},options:{...bOpts({noScales:true,plugins:{legend:{position:'right',labels:{color:p.text,padding:14,font:{size:12}}},tooltip:{callbacks:{label:ctx=>' '+ctx.label+': '+fmt(ctx.parsed)}}}}),cutout:'55%'}});
}

/* â”€â”€â”€ EXPENSE DETAIL â€” 12 categories, 69 columns, full breakdown â”€â”€â”€ */
function buildExpenseDetail(p){
  if(!D.expCats||!Object.keys(D.expCats).length)return;
  const cats=D.expCats, cols=D.expCols||[];
  const catColors=[p.c1,p.c3,p.c5,p.c4,p.c7,p.c6,p.c8,p.c2,'#e67e22','#1abc9c','#9b59b6','#34495e','#f39c12','#2c3e50'];
  /* Separate xarajat vs daromad categories */
  const xCats=Object.entries(cats).filter(([,v])=>!v.isDaromad).sort((a,b)=>sum(b[1].total)-sum(a[1].total));
  const dCats=Object.entries(cats).filter(([,v])=>v.isDaromad);
  const totalX=sum(D.xarajatByMonth), totalD=sum(D.daromadByMonth);
  const xCols=cols.filter(c=>!c.isDaromad), dCols=cols.filter(c=>c.isDaromad);

  /* â”€â”€ KPIs â”€â”€ */
  document.getElementById('kpi-expense').innerHTML=
    kpi(p.c3,'ğŸ“Š','Jami xarajat',fmt(totalX),'63 ta ustun','up','expTotal')+
    kpi(p.c5,'ğŸ’°','Jami daromad',fmt(totalD),'6 ta ustun','up','expDaromad')+
    kpi(p.c1,'ğŸ“','Kategoriyalar',xCats.length+' ta xarajat',dCats.length?' + '+dCats.length+' ta daromad':'','','expCats')+
    kpi(p.c4,'ğŸ“‹','Ustunlar soni',cols.length+' ta','Xarajat: '+xCols.length+', Daromad: '+dCols.length,'','expColCount')+
    kpi(p.c7,'ğŸ“‰','Sof xarajat',fmt(totalX-totalD),'Xarajat âˆ’ Daromad','down','expNet')+
    kpi(p.c8,'ğŸ†','Eng katta kategoriya',xCats[0]?xCats[0][0]:'â€”',xCats[0]?fmt(sum(xCats[0][1].total)):'','','expTopCat');

  /* â”€â”€ Stacked bar: categories by month â”€â”€ */
  const stackDS=xCats.slice(0,12).map(([name,cat],i)=>({
    label:name.length>25?name.slice(0,22)+'â€¦':name,
    data:cat.total,
    backgroundColor:catColors[i%catColors.length],
    borderRadius:2,stack:'s'
  }));
  charts.exSt=new Chart(document.getElementById('chartExpStack'),{type:'bar',data:{labels:MS,datasets:stackDS},
    options:bOpts({plugins:{legend:{position:'top',labels:{font:{size:10},padding:8}}},scales:{x:{stacked:true},y:{stacked:true}}})});

  /* â”€â”€ Category doughnut â”€â”€ */
  const dLabels=xCats.map(([n])=>n.length>30?n.slice(0,27)+'â€¦':n);
  const dData=xCats.map(([,c])=>sum(c.total));
  charts.exCP=new Chart(document.getElementById('chartExpCatPie'),{type:'doughnut',data:{
    labels:dLabels,datasets:[{data:dData,backgroundColor:catColors.slice(0,xCats.length),borderWidth:2,borderColor:p.cardBg,borderRadius:5}]
  },options:{...bOpts({noScales:true,plugins:{legend:{position:'right',labels:{font:{size:10},padding:6}},tooltip:{callbacks:{label:ctx=>{const pct=(ctx.parsed*100/totalX).toFixed(1);return ' '+ctx.label+': '+fmt(ctx.parsed)+' ('+pct+'%)'}}}}}),cutout:'50%'}});

  /* â”€â”€ Top 12 individual expense columns (horizontal bar) â”€â”€ */
  const topCols=[...xCols].sort((a,b)=>sum(b.data)-sum(a.data)).slice(0,12);
  charts.exTC=new Chart(document.getElementById('chartExpTopCols'),{type:'bar',data:{
    labels:topCols.map(c=>c.name.length>35?c.name.slice(0,32)+'â€¦':c.name),
    datasets:[{label:'Yillik summa',data:topCols.map(c=>sum(c.data)),backgroundColor:topCols.map((_,i)=>catColors[i%catColors.length]),borderRadius:6}]
  },options:bOpts({plugins:{legend:{display:false}},indexAxis:'y',yAxis:{ticks:{font:{size:10}}}})});

  /* â”€â”€ Income doughnut â”€â”€ */
  if(dCols.length){
    charts.exIn=new Chart(document.getElementById('chartExpIncome'),{type:'doughnut',data:{
      labels:dCols.map(c=>c.name.length>35?c.name.slice(0,32)+'â€¦':c.name),
      datasets:[{data:dCols.map(c=>sum(c.data)),backgroundColor:[p.c5,p.c4,p.c1,p.c3,p.c7,p.c6],borderWidth:2,borderColor:p.cardBg,borderRadius:5}]
    },options:{...bOpts({noScales:true,plugins:{legend:{position:'right',labels:{font:{size:10},padding:6}},tooltip:{callbacks:{label:ctx=>' '+ctx.label+': '+fmt(ctx.parsed)}}}}),cutout:'50%'}});
  }

  /* â”€â”€ Expense vs Income line â”€â”€ */
  charts.exVI=new Chart(document.getElementById('chartExpVsInc'),{type:'line',data:{labels:MS,datasets:[
    {label:'Xarajat',data:D.xarajatByMonth,borderColor:p.c3,backgroundColor:p.c3+'20',fill:true,tension:.4,pointRadius:4,borderWidth:2.5},
    {label:'Daromad',data:D.daromadByMonth,borderColor:p.c5,backgroundColor:p.c5+'20',fill:true,tension:.4,pointRadius:4,borderWidth:2.5},
  ]},options:bOpts({})});

  /* â”€â”€ Accordion panels: one for each category â”€â”€ */
  const catIcons={'Ish haqi':'ğŸ’¼','Kommunal':'ğŸ ','Eskirish':'ğŸ“‰','Boshqa xarajatlar':'ğŸ“','QoÊ»riqlash':'ğŸ”’','Xizmat safari':'âœˆï¸','Avtomobil xizmati':'ğŸš—','KMTEB':'ğŸ›’','Aloqa':'ğŸ“','Marka':'ğŸ“','Obuna':'ğŸ“š','MaÊ¼muriy xarajatlar':'ğŸ¢','Banknotalarni tashish xarajatlari':'ğŸ’µ','ğŸ’° Daromad':'ğŸ’°'};
  let accHTML='';
  /* Xarajat categories */
  const allCatEntries=[...xCats,...dCats];
  allCatEntries.forEach(([catName,catObj],idx)=>{
    const icon=Object.entries(catIcons).find(([k])=>catName.includes(k))?.[1]||'ğŸ“';
    const total=sum(catObj.total);
    const colsSorted=[...catObj.cols].sort((a,b)=>sum(b.data)-sum(a.data));
    const maxCol=colsSorted.length?sum(colsSorted[0].data):1;
    accHTML+=`<div class="exp-cat-panel${idx===0?' open':''}" onclick="this.classList.toggle('open')">
      <div class="exp-cat-head">
        <span class="cat-icon">${icon}</span>
        <span class="cat-name">${catName}</span>
        <span class="cat-count">${colsSorted.length} ta ustun</span>
        <span class="cat-total">${fmt(total)} so'm</span>
        <span class="cat-arrow">â–¼</span>
      </div>
      <div class="exp-cat-body" onclick="event.stopPropagation()"><div style="padding:0 4px 12px;max-height:400px;overflow-y:auto">
        <table class="exp-col-table"><thead><tr><th>Ustun nomi</th><th style="text-align:right">Yillik jami</th><th style="text-align:right">Ulushi</th><th style="width:120px">Grafik</th></tr></thead><tbody>`;
    colsSorted.forEach(col=>{
      const s=sum(col.data), pct=total?(s*100/total).toFixed(1):'0';
      const barW=maxCol?Math.max(2,Math.round(s*100/maxCol)):2;
      const color=catObj.isDaromad?p.c5:catColors[idx%catColors.length];
      const safeColName=col.name.replace(/'/g,"\\'").replace(/"/g,'&quot;');
      const et=colEmpType(col.name);
      if(et){
        accHTML+=`<tr style="cursor:pointer" onclick="openColumnDrill('${safeColName}')" title="ğŸ“‹ Oylik taqsimot va xodimlar"><td style="color:var(--primary);font-weight:600">${col.name} â†’</td><td style="text-align:right;font-weight:600">${fmt(s)}</td><td style="text-align:right;color:var(--text-secondary)">${pct}%</td><td><span class="exp-col-bar" style="width:${barW}%;background:${color}"></span></td></tr>`;
      } else {
        accHTML+=`<tr><td style="font-weight:600">${col.name}</td><td style="text-align:right;font-weight:600">${fmt(s)}</td><td style="text-align:right;color:var(--text-secondary)">${pct}%</td><td><span class="exp-col-bar" style="width:${barW}%;background:${color}"></span></td></tr>`;
      }
    });
    accHTML+=`</tbody></table></div></div></div>`;
  });
  document.getElementById('expCatAccordion').innerHTML=accHTML;
}

/* â”€â”€â”€ MONTHLY â”€â”€â”€ */
function buildMonthly(p){
  /* Jami ish haqi xarajatlari â€” qalin qizil chiziq */
  const totalIshHaqiMonthly=D.ishHaqi.map((v,i)=>v+D.staj[i]+D.mehnatTatil[i]+D.bayramMukofot[i]+D.ijtimoiySoliq[i]+D.ustama[i]);
  charts.ml=new Chart(document.getElementById('chartMonthlyLine'),{type:'line',data:{labels:MS,datasets:[
    {label:'ğŸ“ JAMI xarajat',data:totalIshHaqiMonthly,borderColor:'#EF4444',backgroundColor:'#EF444412',fill:false,tension:.4,pointRadius:6,pointBackgroundColor:'#EF4444',borderWidth:4,pointStyle:'circle',order:0},
    {label:'Ish haqi',data:D.ishHaqi,borderColor:p.c1,backgroundColor:p.c1+'25',fill:true,tension:.4,pointRadius:5,pointBackgroundColor:p.c1,borderWidth:2.5},
    {label:"Staj to'lovi",data:D.staj,borderColor:p.c4,tension:.4,pointRadius:4,pointBackgroundColor:p.c4,borderWidth:2},
    {label:"Mehnat ta'tili",data:D.mehnatTatil,borderColor:p.c5,tension:.4,pointRadius:4,pointBackgroundColor:p.c5,borderWidth:2},
    {label:'Bayram mukofoti',data:D.bayramMukofot,borderColor:'#F59E0B',backgroundColor:'#F59E0B15',tension:.4,pointRadius:5,pointBackgroundColor:'#F59E0B',borderWidth:2.5,borderDash:[6,3]},
    {label:'Ustama ish haqi',data:D.ustama,borderColor:p.c6,tension:.4,pointRadius:4,pointBackgroundColor:p.c6,borderWidth:2},
  ]},options:bOpts({plugins:{legend:{position:'top',labels:{font:{size:11},padding:12}}}})});

  charts.km=new Chart(document.getElementById('chartKommunal'),{type:'bar',data:{labels:MS,datasets:[
    {label:'Elektr energiya',data:D.elektr,backgroundColor:p.c4,borderRadius:5},
    {label:'Tabiiy gaz',data:D.gaz,backgroundColor:p.c3,borderRadius:5},
  ]},options:bOpts()});

  charts.ad=new Chart(document.getElementById('chartAdmin'),{type:'bar',data:{labels:MS,datasets:[
    {label:'Avtomobil xizmati',data:D.avtomobil,backgroundColor:p.c7,borderRadius:5},
    {label:'Banknotalar tashish',data:D.banknotalar,backgroundColor:p.c6,borderRadius:5},
  ]},options:bOpts()});

  const cats=[{n:'Ish haqi',d:D.ishHaqi},{n:'Ustama ish haqi',d:D.ustama},{n:"Staj to'lovi",d:D.staj},{n:"Mehnat ta'tili",d:D.mehnatTatil},{n:"O'quv ta'tili",d:D.oquvTatil},{n:'Bayram mukofoti',d:D.bayramMukofot},{n:'Ijtimoiy soliq',d:D.ijtimoiySoliq},{n:'Kasallik nafaqasi',d:D.bolnichny},{n:'Elektr energiya',d:D.elektr},{n:'Tabiiy gaz',d:D.gaz}];
  let h='<table class="data-table"><thead><tr><th>Kategoriya</th>';MS.forEach(m=>h+='<th class="num">'+m+'</th>');h+='<th class="num" style="background:'+p.c1+';color:white">Jami</th></tr></thead><tbody>';
  cats.forEach(c=>{const t=sum(c.d),mx=Math.max(...c.d.filter(v=>v>0));h+='<tr><td style="font-weight:600">'+c.n+'</td>';c.d.forEach(v=>{const im=v===mx&&v>0;h+='<td class="num" style="'+(im?'color:'+p.c3+';font-weight:700':'')+'">'+(v>0?fmt(v):'â€”')+'</td>'});h+='<td class="num" style="font-weight:700">'+fmt(t)+'</td></tr>'});
  h+='</tbody></table>';document.getElementById('monthlyTable').innerHTML=h;
}

/* â”€â”€â”€ QUARTERLY â”€â”€â”€ */
function buildQuarterly(p){
  const qR=[[0,1,2],[3,4,5],[6,7,8],[9,10,11]],qN=['I-Kvartal','II-Kvartal','III-Kvartal','IV-Kvartal'],qC=[p.c1,p.c5,p.c4,p.c3];
  const qD=qR.map((ms,i)=>{const t=a=>ms.reduce((s,m)=>s+a[m],0);return{name:qN[i],color:qC[i],ih:t(D.ishHaqi),st:t(D.staj),tt:t(D.mehnatTatil),bm:t(D.bayramMukofot),so:t(D.ijtimoiySoliq),total:t(D.ishHaqi)+t(D.staj)+t(D.mehnatTatil)+t(D.bayramMukofot)+t(D.ijtimoiySoliq)}});
  const mxQ=qD.reduce((a,b)=>a.total>b.total?a:b),mnQ=qD.reduce((a,b)=>a.total<b.total?a:b);
  document.getElementById('kpi-quarters').innerHTML=qD.map((q,i)=>kpi(q.color,'ğŸ“Š',q.name,fmt(q.total),q===mxQ?'â¬† Eng yuqori':q===mnQ?'â¬‡ Eng past':'',q===mxQ?'down':q===mnQ?'up':'','kvartal'+i)).join('');

  charts.qb=new Chart(document.getElementById('chartQuarterBar'),{type:'bar',data:{labels:qN,datasets:[
    {label:'Ish haqi',data:qD.map(q=>q.ih),backgroundColor:p.c1,borderRadius:6},
    {label:'Staj',data:qD.map(q=>q.st),backgroundColor:p.c4,borderRadius:6},
    {label:"Mehnat ta'tili",data:qD.map(q=>q.tt),backgroundColor:p.c5,borderRadius:6},
    {label:'Bayram mukofot',data:qD.map(q=>q.bm),backgroundColor:p.c3,borderRadius:6},
    {label:'Ijtimoiy soliq',data:qD.map(q=>q.so),backgroundColor:p.c6,borderRadius:6},
  ]},options:bOpts()});

  const ch=qD.map((q,i)=>i===0?0:((q.total-qD[i-1].total)/qD[i-1].total*100));
  charts.qc=new Chart(document.getElementById('chartQuarterChange'),{type:'bar',data:{labels:qN,datasets:[{label:"O'zgarish %",data:ch,backgroundColor:ch.map(v=>v>=0?p.c3:p.c5),borderRadius:6}]},options:bOpts({yAxis:{ticks:{callback:v=>v.toFixed(0)+'%'}},plugins:{tooltip:{callbacks:{label:ctx=>' '+ctx.parsed.y.toFixed(1)+'%'}}}})});

  const d1=D.ishHaqi.slice(0,4).reduce((s,v)=>s+v,0)/4,d2=D.ishHaqi.slice(4,8).reduce((s,v)=>s+v,0)/4,d3=D.ishHaqi.slice(8,12).reduce((s,v)=>s+v,0)/4;
  charts.db=new Chart(document.getElementById('chartDecadeBar'),{type:'bar',data:{labels:['1-davr (Yan-Apr)','2-davr (May-Avg)','3-davr (Sen-Dek)'],datasets:[{label:"O'rtacha oylik ish haqi",data:[d1,d2,d3],backgroundColor:[p.c1,p.c5,p.c3],borderRadius:8,barThickness:60}]},options:bOpts({plugins:{legend:{display:false}}})});
}

/* â”€â”€â”€ WAREHOUSE â”€â”€â”€ */
function buildWarehouse(p){
  /* Ombor kirim = faqat MAHSULOT shartnomalar (xizmat va asosiy vosita hisobga olinmaydi) */
  const tc=sum(D.omborChiqim),tk=sum(D.mahsulotKirim),mi=D.omborChiqim.indexOf(Math.max(...D.omborChiqim));
  document.getElementById('kpi-warehouse').innerHTML=
    kpi(p.c5,'ğŸ“¥','Omborga jami kirim qilingan mahsulotlar summasi',fmt(tk),'','','omborKirim')+
    kpi(p.c3,'ğŸ“¤','Ombordan jami chiqim bo\'lgan mahsulotlar summasi',fmt(tc),'','','omborChiqim')+
    kpi(p.c4,'ğŸ“Š','Eng katta chiqim oyi',months[mi]||'â€”',fmt(D.omborChiqim[mi]||0),'down','omborMaxOy')+
    kpi(p.c1,'ğŸ“‹',"Bo'limlar soni",Object.keys(D.omborDept).length,'','','omborBolim');

  charts.wm=new Chart(document.getElementById('chartWarehouseMonth'),{type:'bar',data:{labels:MS,datasets:[{label:'Ombor chiqimi',data:D.omborChiqim,backgroundColor:D.omborChiqim.map(v=>v>50000000?p.c3:p.c1),borderRadius:6}]},options:bOpts({plugins:{legend:{display:false}}})});

  const dl=Object.keys(D.omborDept),dv=Object.values(D.omborDept),dc=[p.c1,p.c3,p.c4,p.c5,p.c6,p.c7,p.c2,p.c8];
  charts.wd=new Chart(document.getElementById('chartWarehouseDept'),{type:'bar',data:{labels:dl,datasets:[{label:'Chiqim summasi',data:dv,backgroundColor:dc,borderRadius:6}]},options:{...bOpts({plugins:{legend:{display:false}}}),indexAxis:'y'}});

  charts.kc=new Chart(document.getElementById('chartKirimChiqim'),{type:'bar',data:{labels:MS,datasets:[
    {label:'Kirim (faqat mahsulot)',data:D.mahsulotKirim,backgroundColor:p.c5,borderRadius:4},
    {label:'Chiqim (Ombor)',data:D.omborChiqim,backgroundColor:p.c3,borderRadius:4},
  ]},options:bOpts()});

  let ah='';const ti=D.topOmborItems;
  if(ti.length>0){const avg=ti.reduce((s,i)=>s+i.qty,0)/ti.length;
    ti.slice(0,8).forEach(item=>{const cr=item.qty>avg*2;ah+='<div class="alert '+(cr?'alert-danger':'alert-warning')+'"><span class="alert-icon">'+(cr?'ğŸ”´':'ğŸŸ¡')+'</span><div class="alert-text"><strong>'+item.name+' â€” '+(cr?'XARID QILISH LOZIM':'KAM QOLISHI MUMKIN')+'</strong>Yil davomida '+fmtF(item.qty)+' dona sarflangan. '+(cr?'Zaxirani tekshirish va yangi shartnoma tuzish lozim.':'Sarfiyot darajasini kuzatish tavsiya etiladi.')+'</div></div>'});
  }else{ah='<div class="empty-state"><div class="empty-icon">ğŸ“¦</div><h3>Ma\'lumot yo\'q</h3><p>Excel faylni yuklang</p></div>'}
  document.getElementById('lowStockAlerts').innerHTML=ah;

  let th='<table class="data-table"><thead><tr><th>#</th><th>Mahsulot nomi</th><th class="num">Miqdor</th><th>Holat</th></tr></thead><tbody>';
  const mq=ti.length>0?ti[0].qty:1;
  ti.forEach((item,i)=>{const pct=item.qty/mq*100;th+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+item.name+'</td><td class="num">'+fmtF(item.qty)+'</td><td><div class="mini-bar"><div class="mini-bar-fill" style="width:'+pct+'%;background:'+p.c1+'"></div></div></td></tr>'});
  th+='</tbody></table>';document.getElementById('warehouseTable').innerHTML=th;

  /* Populate chiqim department select dynamically from parsed data */
  const deptNames=Object.keys(D.omborDept);
  const staffDepts=new Set();
  (D.staffList||[]).forEach(s=>{if(s.dept)staffDepts.add(s.dept)});
  (D.vacList||[]).forEach(v=>{if(v.dept)staffDepts.add(v.dept)});
  const allDepts=[...new Set([...deptNames,...staffDepts])].filter(d=>d&&d.length>1&&!d.toLowerCase().includes('hisob-kitob kassa')).sort();
  const chiqSel=document.getElementById('chiqimDept');
  if(chiqSel) chiqSel.innerHTML=allDepts.map(d=>'<option>'+d+'</option>').join('');
}

/* â”€â”€â”€ VACATION â”€â”€â”€ */
function buildVacation(p){
  const mxi=D.vacationByMonth.indexOf(Math.max(...D.vacationByMonth)),mni=D.vacationByMonth.indexOf(Math.min(...D.vacationByMonth));
  document.getElementById('kpi-vacation').innerHTML=
    kpi(p.c5,'ğŸ–ï¸',"Jami ta'tilga chiqishlar soni",sum(D.vacationByMonth),'','','vacJami')+
    kpi(p.c3,'ğŸ“ˆ',"Eng ko'p ta'til oyi",months[mxi],D.vacationByMonth[mxi]+' ta','down','vacMax')+
    kpi(p.c4,'ğŸ“‰',"Eng kam ta'til oyi",months[mni],D.vacationByMonth[mni]+' ta','up','vacMin')+
    kpi(p.c1,'ğŸ’°',"Ta'til xarajati (jami)",fmt(sum(D.mehnatTatil)),'','','vacCost');

  charts.vm=new Chart(document.getElementById('chartVacationMonth'),{type:'line',data:{labels:MS,datasets:[
    {label:"Ta'tilga chiqishlar soni",data:D.vacationByMonth,borderColor:p.c5,backgroundColor:p.c5+'20',fill:true,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c5,yAxisID:'y'},
    {label:"Mehnat ta'tili xarajati",data:D.mehnatTatil,borderColor:p.c1,backgroundColor:p.c1+'20',fill:false,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c1,yAxisID:'y1'},
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:p.text,usePointStyle:true,padding:12}},tooltip:{callbacks:{label:ctx=>ctx.datasetIndex===0?' '+ctx.parsed.y+' ta':' '+fmtF(ctx.parsed.y)+" so'm"}}},
    scales:{y:{position:'left',ticks:{color:p.text,callback:v=>v+' ta'},grid:{color:p.grid}},y1:{position:'right',ticks:{color:p.c1,callback:v=>fmt(v)},grid:{display:false}},x:{ticks:{color:p.text},grid:{color:p.grid,lineWidth:.5}}}}});

  const vl=Object.keys(D.vacTypes),vv=Object.values(D.vacTypes);
  charts.vt=new Chart(document.getElementById('chartVacationType'),{type:'doughnut',data:{labels:vl.length?vl:["Ma'lumot yo'q"],datasets:[{data:vv.length?vv:[1],backgroundColor:[p.c1,p.c4,p.c5,p.c3],borderWidth:2,borderColor:p.cardBg,borderRadius:6}]},options:{...bOpts({noScales:true,plugins:{legend:{position:'bottom',labels:{color:p.text,padding:16,font:{size:13}}},tooltip:{callbacks:{label:ctx=>' '+ctx.label+': '+ctx.parsed+' ta'}}}}),cutout:'60%'}});

  charts.vc=new Chart(document.getElementById('chartVacationCost'),{type:'bar',data:{labels:MS,datasets:[
    {label:"Mehnat ta'tili xarajati",data:D.mehnatTatil,backgroundColor:p.c1+'BB',borderRadius:4,yAxisID:'y',order:2},
    {label:"Ta'tilga chiqqanlar soni",data:D.vacationByMonth,type:'line',borderColor:p.c3,pointRadius:6,pointBackgroundColor:p.c3,borderWidth:2.5,yAxisID:'y1',order:1},
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:p.text,usePointStyle:true,padding:16}},tooltip:{backgroundColor:p.cardBg,titleColor:p.text,bodyColor:p.text,borderColor:p.grid,borderWidth:1,padding:12,cornerRadius:10}},scales:{y:{position:'left',ticks:{color:p.text,callback:v=>fmt(v)},grid:{color:p.grid,lineWidth:.5}},y1:{position:'right',ticks:{color:p.c3,callback:v=>v+' ta'},grid:{display:false}},x:{ticks:{color:p.text},grid:{color:p.grid,lineWidth:.5}}}}});

  /* Vacation employee names list */
  renderVacList(D.vacList, p);
}

/* â”€â”€â”€ SICK LEAVE â”€â”€â”€ */
function buildSickLeave(p){
  const mxi=D.sickByMonth.indexOf(Math.max(...D.sickByMonth)),tc=sum(D.bolnichny);
  document.getElementById('kpi-sick').innerHTML=
    kpi(p.c3,'ğŸ¥','Jami kasallik varaqlari',sum(D.sickByMonth),'','','sickJami')+
    kpi(p.c4,'ğŸ“ˆ',"Eng ko'p kasallanish oyi",months[mxi],D.sickByMonth[mxi]+' ta','down','sickMax')+
    kpi(p.c1,'ğŸ’Š','Nafaqa xarajati (jami)',fmt(tc),'','','sickCost')+
    kpi(p.c6,'ğŸ“Š',"O'rtacha oylik nafaqa",fmt(tc/12),'','','sickAvg');

  charts.sm=new Chart(document.getElementById('chartSickMonth'),{type:'line',data:{labels:MS,datasets:[
    {label:'Kasallik varaqasi soni',data:D.sickByMonth,borderColor:p.c3,backgroundColor:p.c3+'20',fill:true,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c3,yAxisID:'y'},
    {label:'Kasallik nafaqasi',data:D.bolnichny,borderColor:p.c1,backgroundColor:p.c1+'20',fill:false,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c1,yAxisID:'y1'},
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:p.text,usePointStyle:true,padding:12}},tooltip:{callbacks:{label:ctx=>ctx.datasetIndex===0?' '+ctx.parsed.y+' ta':' '+fmtF(ctx.parsed.y)+" so'm"}}},
    scales:{y:{position:'left',ticks:{color:p.text,callback:v=>v+' ta'},grid:{color:p.grid}},y1:{position:'right',ticks:{color:p.c1,callback:v=>fmt(v)},grid:{display:false}},x:{ticks:{color:p.text},grid:{color:p.grid,lineWidth:.5}}}}});

  charts.sc=new Chart(document.getElementById('chartSickCost'),{type:'line',data:{labels:MS,datasets:[{label:'Kasallik nafaqasi',data:D.bolnichny,borderColor:p.c3,backgroundColor:p.c3+'20',fill:true,tension:.4,pointRadius:6,pointBackgroundColor:p.c3,borderWidth:2.5}]},options:bOpts()});

  charts.vs=new Chart(document.getElementById('chartVacSickCompare'),{type:'bar',data:{labels:MS,datasets:[
    {label:"Ta'tilga chiqqanlar",data:D.vacationByMonth,backgroundColor:p.c1,borderRadius:4},
    {label:'Kasallanganlar',data:D.sickByMonth,backgroundColor:p.c3,borderRadius:4},
  ]},options:bOpts({plugins:{tooltip:{callbacks:{label:ctx=>' '+ctx.dataset.label+': '+ctx.parsed.y+' ta'}}},yAxis:{beginAtZero:true}})});

  /* Sick leave employee names list */
  renderSickList(D.sickList, p);
}

/* â”€â”€â”€ STAFF (Xodimlar staji) â”€â”€â”€ */
function buildStaff(p){
  const sl=D.staffList, total=sl.length;
  const s25=sl.filter(x=>x.stajYil>=25).length, s15=sl.filter(x=>x.stajYil>=15).length;
  const avgY=total>0?(sl.reduce((s,x)=>s+x.stajYil,0)/total).toFixed(1):0;
  document.getElementById('kpi-staff').innerHTML=
    kpi(p.c1,'ğŸ‘¥','Jami xodimlar',total,'','','staffAll')+ kpi(p.c4,'ğŸ“Š',"O'rtacha staj",avgY+' yil','','','staffAvg')+ kpi(p.c3,'ğŸ…','25+ yil staj',s25+' xodim','','','staff25')+ kpi(p.c5,'â­','15+ yil staj',s15+' xodim','','','staff15');
  document.getElementById('staffCount').textContent=total+' xodim';

  /* Tenure chart */
  const tl=Object.keys(D.tenure),tv=Object.values(D.tenure);
  if(tl.length)charts.stTn=new Chart(document.getElementById('chartStaffTenure'),{type:'bar',data:{labels:tl,datasets:[{label:'Xodimlar soni',data:tv,backgroundColor:[p.c5,p.c4,p.c6,p.c1,p.c7,p.c3],borderRadius:8,barThickness:50}]},options:bOpts({plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>' '+ctx.parsed.y+' xodim'}}},yAxis:{beginAtZero:true,ticks:{stepSize:5}}})});

  renderStaffTable(sl, p);
}

function renderStaffTable(list, p){
  if(!p) p=P();
  let h='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.O</th><th>Ish boshlagan yili</th><th>Bank tizimidagi staji</th><th class="num">Staj (yil)</th><th class="num">Staj uchun to\'lov %</th></tr></thead><tbody>';
  list.forEach((s,i)=>{
    const clr=s.stajYil>=25?p.c3:s.stajYil>=15?p.c1:'';
    h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600;'+(clr?'color:'+clr:'')+'">'+s.name+'</td><td>'+s.start+'</td><td>'+s.stajText+'</td><td class="num" style="font-weight:700;'+(clr?'color:'+clr:'')+'">'+s.stajYil+'</td><td class="num">'+s.pct+'%</td></tr>';
  });
  h+='</tbody></table>';
  document.getElementById('staffTable').innerHTML=h;
}

function filterStaff(){
  const q=document.getElementById('staffSearch').value.toLowerCase();
  const f=document.getElementById('staffFilter').value;
  let list=D.staffList;
  if(q)list=list.filter(s=>s.name.toLowerCase().includes(q));
  if(f!=='all'){
    if(f==='25+')list=list.filter(s=>s.stajYil>25);
    else{const[a,b]=f.split('-').map(Number);list=list.filter(s=>s.stajYil>=a&&s.stajYil<=b)}
  }
  renderStaffTable(list);
  document.getElementById('staffCount').textContent=list.length+' xodim';
}

/* â”€â”€â”€ CONTRACTS (Shartnomalar) â€” with ombor/xizmat/asosiy vosita split â”€â”€â”€ */
let currentContractCat='all'; /* active category filter */

function buildContracts(p){
  const cl=D.contractList, total=cl.length;
  const totalSum=cl.reduce((s,c)=>s+c.summa,0);
  /* Category splits */
  const ombor=cl.filter(c=>c.cat==='ombor'), omborSum=ombor.reduce((s,c)=>s+c.summa,0);
  const xizmat=cl.filter(c=>c.cat==='xizmat'), xizmatSum=xizmat.reduce((s,c)=>s+c.summa,0);
  const asosiy=cl.filter(c=>c.cat==='asosiy'), asosiySum=asosiy.reduce((s,c)=>s+c.summa,0);

  document.getElementById('kpi-contracts').innerHTML=
    kpi(p.c1,'ğŸ“„','Jami shartnomalar',total,fmt(totalSum)+" so'm",'','contractAll')+
    kpi(p.c5,'ğŸ“¦','Omborga kirim qilingan mahsulotlar',ombor.length+' ta',fmt(omborSum),'','contractOmbor')+
    kpi(p.c4,'ğŸ”§','Xizmatlar',xizmat.length+' ta',fmt(xizmatSum),'','contractXizmat')+
    kpi(p.c3,'ğŸ—ï¸','Asosiy vositalar',asosiy.length+' ta',fmt(asosiySum),'','contractAsosiy');
  document.getElementById('contractCount').textContent=total+' ta shartnoma';

  /* Monthly stacked chart â€” ombor vs xizmat vs asosiy */
  const omborByM=A(12),xizmatByM=A(12),asosiyByM=A(12);
  cl.forEach(c=>{const m=new Date(c.date).getUTCMonth();if(m>=0&&m<12){
    if(c.cat==='ombor')omborByM[m]+=c.summa;
    else if(c.cat==='asosiy')asosiyByM[m]+=c.summa;
    else xizmatByM[m]+=c.summa;
  }});
  charts.ctM=new Chart(document.getElementById('chartContractMonth'),{type:'bar',data:{labels:MS,datasets:[
    {label:'ğŸ“¦ Mahsulot',data:omborByM,backgroundColor:p.c5,borderRadius:3,stack:'s'},
    {label:'ğŸ”§ Xizmat',data:xizmatByM,backgroundColor:p.c4,borderRadius:3,stack:'s'},
    {label:'ğŸ—ï¸ Asosiy vosita',data:asosiyByM,backgroundColor:p.c3,borderRadius:3,stack:'s'},
  ]},options:bOpts({plugins:{legend:{position:'top'}},scales:{x:{stacked:true},y:{stacked:true}}})});

  /* Category doughnut */
  charts.ctT=new Chart(document.getElementById('chartContractCat'),{type:'doughnut',data:{
    labels:['ğŸ“¦ Mahsulot ('+ombor.length+')','ğŸ”§ Xizmat ('+xizmat.length+')','ğŸ—ï¸ Asosiy vosita ('+asosiy.length+')'],
    datasets:[{data:[omborSum,xizmatSum,asosiySum],backgroundColor:[p.c5,p.c4,p.c3],borderWidth:3,borderColor:p.cardBg,borderRadius:6}]
  },options:{...bOpts({noScales:true,plugins:{legend:{position:'bottom',labels:{color:p.text,padding:14,font:{size:11}}},tooltip:{callbacks:{label:ctx=>' '+ctx.label+': '+fmt(ctx.parsed)+" so'm"}}}}),cutout:'55%'}});

  /* === Savdo turlari (trade types) breakdown === */
  const tradeTypes={};
  cl.forEach(c=>{
    let t=(c.type||'').trim();
    if(!t||t==='1'||/^\d+$/.test(t)) t='Boshqa';
    if(!tradeTypes[t]) tradeTypes[t]={count:0,summa:0};
    tradeTypes[t].count++; tradeTypes[t].summa+=c.summa;
  });
  const ttSorted=Object.entries(tradeTypes).sort((a,b)=>b[1].summa-a[1].summa);
  const ttColors=[p.c1,p.c5,p.c4,p.c3,p.c6,p.c7];
  const ttIcons={"elektron":"ğŸ–¥ï¸","milliy":"ğŸª","to'g'ri":"ğŸ“","auksion":"ğŸ”¨"};
  function ttIcon(name){const n=name.toLowerCase();for(const[k,v]of Object.entries(ttIcons)){if(n.includes(k))return v}return 'ğŸ“‹'}

  if(ttSorted.length>0){
    charts.ctTT=new Chart(document.getElementById('chartContractTradeType'),{type:'doughnut',data:{
      labels:ttSorted.map(([t,d])=>t+' ('+d.count+' ta)'),
      datasets:[{data:ttSorted.map(([,d])=>d.summa),backgroundColor:ttColors.slice(0,ttSorted.length),borderWidth:3,borderColor:p.cardBg,borderRadius:6}]
    },options:{...bOpts({noScales:true,plugins:{legend:{position:'bottom',labels:{color:p.text,padding:12,font:{size:11}}},tooltip:{callbacks:{label:ctx=>' '+fmt(ctx.parsed)+" so'm ("+((ctx.parsed/totalSum)*100).toFixed(1)+'%)'}}}}),cutout:'55%'}});
  }

  /* Trade type table */
  let ttH='<table class="data-table"><thead><tr><th>Savdo turi</th><th class="num">Soni</th><th class="num">Summasi</th><th class="num">Ulushi</th></tr></thead><tbody>';
  ttSorted.forEach(([name,info],i)=>{
    const pct=totalSum>0?((info.summa/totalSum)*100).toFixed(1):'0';
    const clr=ttColors[i]||p.c1;
    ttH+='<tr><td style="font-weight:600"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:'+clr+';margin-right:6px"></span>'+ttIcon(name)+' '+name+'</td><td class="num" style="font-weight:700">'+info.count+' ta</td><td class="num" style="font-weight:700;color:'+clr+'">'+fmtF(info.summa)+" so'm</td><td class=\"num\">"+pct+'%</td></tr>';
  });
  ttH+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td><td class="num">'+total+' ta</td><td class="num">'+fmtF(totalSum)+" so'm</td><td class=\"num\">100%</td></tr></tbody></table>";
  document.getElementById('tradeTypeTable').innerHTML=ttH;

  currentContractCat='all';
  renderContractTable(cl, p);
}

function renderContractTable(list, p){
  if(!p) p=P();
  const catLabels={ombor:'ğŸ“¦ Mahsulot',xizmat:'ğŸ”§ Xizmat',asosiy:'ğŸ—ï¸ Asosiy vosita'};
  const catColors={ombor:p.c5,xizmat:p.c4,asosiy:p.c3};
  let h='<table class="data-table"><thead><tr><th>â„–</th><th>Sana</th><th>Savdo turi</th><th>Kategoriya</th><th>Yetkazib beruvchi</th><th>Mahsulot/xizmat</th><th class="num">Soni</th><th class="num">Summa</th></tr></thead><tbody>';
  list.forEach((c,i)=>{
    const catClr=catColors[c.cat]||p.c1;
    const tt=(c.type||'').trim();
    h+='<tr><td>'+(i+1)+'</td><td>'+c.date+'</td><td style="font-size:.8rem">'+tt+'</td><td><span style="display:inline-block;padding:2px 8px;border-radius:6px;font-size:.78rem;font-weight:600;background:'+catClr+'18;color:'+catClr+'">'+(catLabels[c.cat]||c.cat)+'</span></td><td style="font-weight:600">'+c.provider+'</td><td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+c.product.replace(/"/g,'&quot;')+'">'+c.product+'</td><td class="num">'+c.qty+' '+c.unit+'</td><td class="num" style="font-weight:700;color:'+catClr+'">'+fmtF(c.summa)+'</td></tr>';
  });
  const totalS=list.reduce((s,c)=>s+c.summa,0);
  h+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td colspan="6">JAMI</td><td class="num">'+fmtF(totalS)+" so'm</td></tr></tbody></table>";
  document.getElementById('contractTable').innerHTML=h;
}

/* Category filter buttons */
function filterContractCat(cat, btn){
  currentContractCat=cat;
  document.querySelectorAll('.contract-cat-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  filterContracts();
}

function filterContracts(){
  const q=document.getElementById('contractSearch').value.toLowerCase();
  let list=D.contractList;
  if(currentContractCat!=='all') list=list.filter(c=>c.cat===currentContractCat);
  if(q)list=list.filter(c=>c.provider.toLowerCase().includes(q)||c.product.toLowerCase().includes(q));
  renderContractTable(list);
  document.getElementById('contractCount').textContent=list.length+' ta shartnoma';
}

/* â”€â”€â”€ JUBILEE & DAFN â”€â”€â”€ */
function buildJubilee(p){
  const jl=D.jubList, dl=D.dafnList;
  document.getElementById('kpi-jubilee').innerHTML=
    kpi(p.c1,'ğŸ‚','Yubiley xodimlari',jl.length,'','','jubAll')+
    kpi(p.c3,'ğŸ•¯ï¸','Dafn moddiy yordami',dl.length,'','','jubDafn')+
    kpi(p.c4,'ğŸ‘¤','50 yosh',jl.filter(j=>j.age==='50').length+' xodim','','','jub50')+
    kpi(p.c5,'ğŸ‘¤','60 yosh',jl.filter(j=>j.age==='60').length+' xodim','','','jub60');
  document.getElementById('jubCount').textContent=jl.length+' xodim';
  document.getElementById('dafnCount').textContent=dl.length+' xodim';

  /* Jubilee table */
  let h='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.O</th><th>Bo\'lim</th><th>Buyruq sanasi</th><th>Buyruq â„–</th><th class="num">Yubiley yoshi</th></tr></thead><tbody>';
  jl.forEach((j,i)=>{h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+j.name+'</td><td>'+j.dept+'</td><td>'+j.date+'</td><td>'+j.num+'</td><td class="num" style="font-weight:700;color:'+p.c1+'">'+j.age+' yosh</td></tr>'});
  if(!jl.length) h+='<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">Ma\'lumot yo\'q</td></tr>';
  h+='</tbody></table>';
  document.getElementById('jubTable').innerHTML=h;

  /* Dafn table */
  let d='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.O</th><th>Bo\'lim</th><th>Yordam berilgan oy</th></tr></thead><tbody>';
  dl.forEach((x,i)=>{d+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+x.name+'</td><td>'+x.dept+'</td><td>'+x.month+'</td></tr>'});
  if(!dl.length) d+='<tr><td colspan="4" style="text-align:center;color:var(--text-muted)">Ma\'lumot yo\'q</td></tr>';
  d+='</tbody></table>';
  document.getElementById('dafnTable').innerHTML=d;
}

/* â”€â”€â”€ VACATION LIST â”€â”€â”€ */
function renderVacList(list, p){
  if(!p) p=P();
  let h='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.O</th><th>Bo\'lim</th><th>Sana</th><th>Buyruq â„–</th><th>Turi</th><th>Muddati</th><th>Davr</th></tr></thead><tbody>';
  list.forEach((v,i)=>{
    const tc=v.type.toLowerCase().includes('mehnat')?p.c1:p.c4;
    h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+v.name+'</td><td>'+v.dept+'</td><td>'+v.date+'</td><td>'+v.num+'</td><td style="color:'+tc+';font-weight:600">'+v.type+'</td><td>'+v.dur+'</td><td style="font-size:.8rem">'+v.period+'</td></tr>';
  });
  h+='</tbody></table>';
  document.getElementById('vacListTable').innerHTML=h;
  document.getElementById('vacListCount').textContent=list.length+' ta yozuv';
}
function filterVacList(){
  const q=document.getElementById('vacSearch').value.toLowerCase();
  let list=D.vacList;if(q)list=list.filter(v=>v.name.toLowerCase().includes(q));
  renderVacList(list);
}

/* â”€â”€â”€ SICK LIST â”€â”€â”€ */
function renderSickList(list, p){
  if(!p) p=P();
  let h='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.O</th><th>Bo\'lim</th><th>To\'lov oyi</th><th>Kasallik davri</th></tr></thead><tbody>';
  list.forEach((s,i)=>{h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+s.name+'</td><td>'+s.dept+'</td><td>'+s.month+'</td><td>'+s.period+'</td></tr>'});
  h+='</tbody></table>';
  document.getElementById('sickListTable').innerHTML=h;
  document.getElementById('sickListCount').textContent=list.length+' ta yozuv';
}
function filterSickList(){
  const q=document.getElementById('sickSearch').value.toLowerCase();
  let list=D.sickList;if(q)list=list.filter(s=>s.name.toLowerCase().includes(q));
  renderSickList(list);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI FORECASTING â€” Multi-Model Engine (5 ta model)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   1) Seasonal Decomposition + Trend (STL-lite)
   2) Holt-Winters Triple Exponential Smoothing
   3) Weighted Moving Average (WMA)
   4) Linear Regression (oddiy bazaviy model)
   5) Ensemble â€” barcha modellar og'irlikli o'rtachasi
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ 1) Linear Regression (bazaviy) â”€â”€ */
function linearRegression(data){
  const pts=data.map((y,x)=>({x,y})).filter(p=>p.y>0);
  if(pts.length<3) return {slope:0,intercept:0,predict:()=>0,r2:0,name:'Linear Regression'};
  const n=pts.length, sx=pts.reduce((s,p)=>s+p.x,0), sy=pts.reduce((s,p)=>s+p.y,0);
  const sxy=pts.reduce((s,p)=>s+p.x*p.y,0), sx2=pts.reduce((s,p)=>s+p.x*p.x,0);
  const slope=(n*sxy-sx*sy)/(n*sx2-sx*sx)||0;
  const intercept=(sy-slope*sx)/n;
  const yMean=sy/n;
  const ssTot=pts.reduce((s,p)=>s+(p.y-yMean)**2,0);
  const ssRes=pts.reduce((s,p)=>s+(p.y-(slope*p.x+intercept))**2,0);
  const r2=ssTot>0?Math.max(0,1-ssRes/ssTot):0;
  return {slope,intercept,predict:x=>Math.max(0,slope*x+intercept),r2,name:'Chiziqli Regressiya',fitted:data.map((_,i)=>Math.max(0,slope*i+intercept))};
}

/* â”€â”€ 2) Seasonal Decomposition + Trend (STL-lite) â”€â”€
   Ma'lumotni 3 qismga ajratadi:
   - Trend: harakatlanuvchi o'rtacha (moving average)
   - Seasonal: har bir oy uchun mavsumiy pattern
   - Residual: qoldiq (tasodifiy tebranish)
   Prognoz: Trend(kelgusi oy) + Seasonal(shu oyning patterni) */
function seasonalDecomposition(data){
  const n=data.length;
  if(n<6) return null;

  /* Trend â€” 3 oylik harakatlanuvchi o'rtacha */
  const trend=data.map((_,i)=>{
    const w=Math.min(i,n-1-i,1);/* windowning yarmi */
    if(w<1) return data[i];
    const slice=data.slice(Math.max(0,i-1),Math.min(n,i+2));
    return slice.reduce((s,v)=>s+v,0)/slice.length;
  });

  /* Seasonal â€” har bir oy uchun trend-dan og'ish nisbati */
  const seasonal=new Array(12).fill(0);
  const counts=new Array(12).fill(0);
  data.forEach((v,i)=>{
    if(trend[i]>0 && v>0){
      seasonal[i%12]+=v/trend[i]; /* nisbiy mavsumiy koeffitsient */
      counts[i%12]++;
    }
  });
  /* O'rtacha mavsumiy koeffitsientlar (1.0 = o'rtacha, 1.5 = 50% yuqori) */
  for(let m=0;m<12;m++){
    seasonal[m]=counts[m]>0?seasonal[m]/counts[m]:1.0;
  }
  /* Normalizatsiya â€” jami 12 ga teng bo'lsin */
  const sSum=seasonal.reduce((s,v)=>s+v,0);
  for(let m=0;m<12;m++) seasonal[m]=seasonal[m]*(12/sSum);

  /* Trend extrapolation â€” oxirgi 3 oyning trendi */
  const tLast=trend.slice(-3);
  const tSlope=(tLast[tLast.length-1]-tLast[0])/(tLast.length-1||1);

  /* Fitted values â€” trend * seasonal */
  const fitted=data.map((_,i)=>Math.max(0,trend[i]*seasonal[i%12]));

  /* RÂ² hisoblash */
  const yMean=data.reduce((s,v)=>s+v,0)/n;
  const ssTot=data.reduce((s,v)=>s+(v-yMean)**2,0);
  const ssRes=data.reduce((s,v,i)=>s+(v-fitted[i])**2,0);
  const r2=ssTot>0?Math.max(0,1-ssRes/ssTot):0;

  /* Prognoz funksiyasi */
  const predict=(x)=>{
    const stepsAhead=x-n+1;
    const futTrend=trend[n-1]+tSlope*stepsAhead;
    return Math.max(0,futTrend*seasonal[x%12]);
  };

  return {predict,r2,name:'Mavsumiy dekompozitsiya (STL)',seasonal,trend,fitted,tSlope};
}

/* â”€â”€ 3) Holt-Winters Triple Exponential Smoothing â”€â”€
   3 ta komponent: level, trend, seasonality
   Î± (alpha) â€” level silliqlashtirish
   Î² (beta) â€” trend silliqlashtirish
   Î³ (gamma) â€” mavsumiy silliqlashtirish */
function holtWinters(data,predict_n=3){
  const n=data.length;
  if(n<6) return null;
  const period=12;/* oylik mavsumiylik */

  /* Optimal parametrlarni grid search bilan topish */
  let bestR2=-Infinity, bestResult=null;

  /* Parametr kombinatsiyalarini sinash */
  const alphas=[0.1,0.2,0.3,0.5,0.7];
  const betas=[0.01,0.05,0.1,0.2];
  const gammas=[0.1,0.3,0.5,0.7,0.9];

  for(const alpha of alphas){
    for(const beta of betas){
      for(const gamma of gammas){
        const res=_hwRun(data,alpha,beta,gamma,period,predict_n);
        if(res && res.r2>bestR2){bestR2=res.r2;bestResult=res;bestResult.alpha=alpha;bestResult.beta=beta;bestResult.gamma=gamma}
      }
    }
  }

  return bestResult;
}

/* Holt-Winters ichki hisoblash */
function _hwRun(data,alpha,beta,gamma,period,predict_n){
  const n=data.length;
  if(n<period) return null;

  /* Boshlang'ich qiymatlar */
  let level=data.slice(0,period).reduce((s,v)=>s+v,0)/period;
  let trend=0;
  /* Dastlabki mavsumiy indekslar */
  const seasonals=new Array(period);
  for(let i=0;i<period;i++){
    seasonals[i]=data[i]>0&&level>0?(data[i]/level):1;
  }

  const fitted=[data[0]];/* birinchi qiymat */

  /* Silliqlashtirish iteratsiyasi */
  for(let t=1;t<n;t++){
    const si=t%period;
    const prevSeason=seasonals[si];
    const y=data[t];

    /* Forecast for this step */
    const fcast=Math.max(0,(level+trend)*prevSeason);
    fitted.push(fcast);

    if(y>0 && prevSeason>0){
      /* Level yangilanishi */
      const newLevel=alpha*(y/prevSeason)+(1-alpha)*(level+trend);
      /* Trend yangilanishi */
      const newTrend=beta*(newLevel-level)+(1-beta)*trend;
      /* Seasonal yangilanishi */
      seasonals[si]=gamma*(y/newLevel)+(1-gamma)*prevSeason;

      level=newLevel;
      trend=newTrend;
    }
  }

  /* RÂ² hisoblash */
  const yMean=data.reduce((s,v)=>s+v,0)/n;
  const ssTot=data.reduce((s,v)=>s+(v-yMean)**2,0);
  const ssRes=data.reduce((s,v,i)=>s+(v-fitted[i])**2,0);
  const r2=ssTot>0?Math.max(0,1-ssRes/ssTot):0;

  /* Prognoz */
  const forecasts=[];
  for(let h=1;h<=predict_n;h++){
    const si=(n-1+h)%period;
    forecasts.push(Math.max(0,(level+trend*h)*seasonals[si]));
  }

  const predict=(x)=>{
    const h=x-n+1;
    if(h<=0) return fitted[x]||0;
    const si=(n-1+h)%period;
    return Math.max(0,(level+trend*h)*seasonals[si]);
  };

  return {predict,r2,name:'Holt-Winters (Uchlamchi silliqlashtirish)',fitted,forecasts,level,trend,seasonals:seasonals.slice()};
}

/* â”€â”€ 4) Weighted Moving Average (WMA) â”€â”€
   Oxirgi oylarga ko'proq vazn beradi + mavsumiy tuzatish */
function weightedMA(data,predict_n=3){
  const n=data.length;
  if(n<6) return null;

  /* Mavsumiy koeffitsientlar */
  const mean=data.reduce((s,v)=>s+v,0)/n;
  const seasonal=data.map((v,i)=>mean>0?v/mean:1);

  /* Trend: oxirgi 6 oyning og'irlikli o'rtachasi */
  const weights=[1,1.5,2,2.5,3,4];/* oxirgisiga eng katta vazn */
  const wSum=weights.reduce((s,v)=>s+v,0);
  const last6=data.slice(-6);
  const wAvg=last6.reduce((s,v,i)=>s+v*weights[i],0)/wSum;

  /* Trend (oxirgi 6 oy) */
  const trendSlope=(last6[5]-last6[0])/5||0;

  /* Fitted */
  const fitted=data.map((_,i)=>{
    if(i<3) return data[i];
    const w3=[1,2,3];const wS=6;
    const wma=(data[i-3]*w3[0]+data[i-2]*w3[1]+data[i-1]*w3[2])/wS;
    return Math.max(0,wma);
  });

  /* RÂ² */
  const yMean=data.reduce((s,v)=>s+v,0)/n;
  const ssTot=data.reduce((s,v)=>s+(v-yMean)**2,0);
  const ssRes=data.reduce((s,v,i)=>s+(v-fitted[i])**2,0);
  const r2=ssTot>0?Math.max(0,1-ssRes/ssTot):0;

  /* Prognoz: bazaviy trend + mavsumiy tuzatish */
  const predict=(x)=>{
    const h=x-n+1;
    const base=wAvg+trendSlope*h;
    const si=x%12;
    return Math.max(0,base*seasonal[si%n]/mean*mean);
  };

  /* Tuzatilgan prognoz â€” seasonal koeff bilan */
  const predictSeasonal=(x)=>{
    const h=x-n+1;
    const base=wAvg+trendSlope*h;
    const si=x%12;
    /* Shu oyning tarixiy nisbati */
    const monthRatio=mean>0?data[si]/mean:1;
    return Math.max(0,base*monthRatio);
  };

  return {predict:predictSeasonal,r2,name:'Og\'irlikli harakatlanuvchi o\'rtacha (WMA)',fitted,wAvg,trendSlope};
}

/* â”€â”€ 5) Ensemble Model â€” barcha modellarning og'irlikli kombinatsiyasi â”€â”€
   Har bir modelning prognozi uning RÂ² ga proportional vazn oladi */
function ensemblePredict(models,x){
  let totalWeight=0, totalVal=0;
  models.forEach(m=>{
    if(m && m.r2>0){
      const w=m.r2*m.r2; /* RÂ²-ni kvadratlab â€” yaxshi modellarga ko'proq vazn */
      totalVal+=m.predict(x)*w;
      totalWeight+=w;
    }
  });
  return totalWeight>0?totalVal/totalWeight:0;
}

/* â”€â”€ MASTER FORECASTER â€” eng yaxshi modelni avtomatik tanlaydi â”€â”€ */
function masterForecast(data,predictMonths=3){
  const models=[];

  /* 1. Linear Regression */
  const lr=linearRegression(data);
  if(lr) models.push(lr);

  /* 2. Seasonal Decomposition */
  const sd=seasonalDecomposition(data);
  if(sd) models.push(sd);

  /* 3. Holt-Winters */
  const hw=holtWinters(data,predictMonths);
  if(hw) models.push(hw);

  /* 4. Weighted Moving Average */
  const wma=weightedMA(data,predictMonths);
  if(wma) models.push(wma);

  /* Eng yaxshi modelni tanlash (RÂ² bo'yicha) */
  models.sort((a,b)=>b.r2-a.r2);
  const best=models[0]||lr;

  /* Ensemble prognozlari */
  const n=data.length;
  const forecasts=[];
  const ensembleFitted=data.map((_,i)=>ensemblePredict(models,i));
  for(let h=0;h<predictMonths;h++){
    forecasts.push(ensemblePredict(models,n+h));
  }

  /* Ensemble RÂ² */
  const yMean=data.reduce((s,v)=>s+v,0)/n;
  const ssTot=data.reduce((s,v)=>s+(v-yMean)**2,0);
  const ssRes=data.reduce((s,v,i)=>s+(v-ensembleFitted[i])**2,0);
  const ensembleR2=ssTot>0?Math.max(0,1-ssRes/ssTot):0;

  /* Ensemble modeli */
  const ensemble={
    predict:(x)=>ensemblePredict(models,x),
    r2:ensembleR2,
    name:'Ensemble ('+models.length+' model kombinatsiyasi)',
    fitted:ensembleFitted
  };

  /* Eng yaxshisi: ensemble yoki individual? */
  const winner=ensemble.r2>=best.r2?ensemble:best;

  return {
    best:winner,           /* Eng yaxshi model */
    all:models,            /* Barcha modellar ro'yxati */
    ensemble,              /* Ensemble natijalari */
    forecasts:winner===ensemble?forecasts:Array.from({length:predictMonths},(_,h)=>winner.predict(n+h)),
    lr,sd,hw,wma           /* Individual modellar */
  };
}

/* â”€â”€ Qayta tahlil qilish â€” AI bo'limini yangilash â”€â”€ */
function rerunAI(){
  if(!D) return;
  const btn=document.getElementById('rerunAIBtn');
  /* Animatsiya: tugma "yuklanmoqda" holatiga o'tadi */
  btn.textContent='â³ Tahlil qilinmoqda...';
  btn.style.opacity='0.7';
  btn.disabled=true;
  /* AI grafiklarini tozalash */
  ['aiF','aiW'].forEach(id=>{
    if(charts[id]){charts[id].destroy();delete charts[id]}
  });
  /* Biroz kechikish â€” foydalanuvchiga jarayon ko'rinishi uchun */
  setTimeout(()=>{
    buildAI(P());
    btn.textContent='âœ… Tahlil yangilandi!';
    btn.style.opacity='1';
    /* 1.5 sekunddan so'ng asl holatiga qaytarish */
    setTimeout(()=>{
      btn.textContent='ğŸ”„ Qayta tahlil qilish';
      btn.disabled=false;
    },1500);
  },600);
}

function buildAI(p){
  if(!D)return;
  const FM=['Yanvar','Fevral','Mart'];/* Kelgusi 3 oy prognozi */

  /* â”€â”€ Xarajatlar prognozi â€” MULTI-MODEL â”€â”€ */
  const totalMonthly=D.ishHaqi.map((v,i)=>v+D.staj[i]+D.mehnatTatil[i]+D.bayramMukofot[i]+D.ijtimoiySoliq[i]+D.ustama[i]);
  const mfE=masterForecast(totalMonthly,3);
  aiModelE=mfE; /* global â€” speakForecast va modallar uchun */
  const bestE=mfE.best;
  const forecastE=mfE.forecasts;
  const lastAvg=(totalMonthly[9]+totalMonthly[10]+totalMonthly[11])/3;
  const trendPct=lastAvg>0?((forecastE[2]-lastAvg)/lastAvg*100):0;

  /* â”€â”€ Ombor prognozi â€” MULTI-MODEL â”€â”€ */
  const mfW=masterForecast(D.omborChiqim,3);
  aiModelW=mfW; /* global â€” speakForecast va modallar uchun */
  const bestW=mfW.best;
  const forecastW=mfW.forecasts;
  const lastW=(D.omborChiqim[9]+D.omborChiqim[10]+D.omborChiqim[11])/3;

  /* KPI cards â€” yangilangan model aniqligi bilan */
  const bestR2E=Math.max(bestE.r2,mfE.ensemble.r2);
  const bestR2W=Math.max(bestW.r2,mfW.ensemble.r2);
  document.getElementById('kpi-ai').innerHTML=
    kpi(p.c1,'ğŸ¤–','AI Prognoz trend',trendPct>0?'â†‘ O\'sish':'â†“ Kamayish',Math.abs(trendPct).toFixed(1)+'%',trendPct>0?'down':'up','aiTrend')+
    kpi(p.c4,'ğŸ“Š','Xarajat model aniqligi',(bestR2E*100).toFixed(0)+'%',bestE.name.split('(')[0].trim(),bestR2E>.7?'up':bestR2E>.4?'':'down','aiModel')+
    kpi(p.c3,'âš¡','Ombor model aniqligi',(bestR2W*100).toFixed(0)+'%',bestW.name.split('(')[0].trim(),bestR2W>.7?'up':bestR2W>.4?'':'down','aiOmbor')+
    kpi(p.c5,'ğŸ¯','Modellar soni',mfE.all.length+' ta','Eng yaxshisi avtomatik tanlangan','up','aiData');

  /* Expense forecast cards */
  document.getElementById('aiForecastExpense').innerHTML=forecastE.map((v,i)=>{
    const chg=lastAvg>0?((v-lastAvg)/lastAvg*100):0;
    return '<div class="ai-fc"><div class="ai-fc-month">'+FM[i]+' 2026</div><div class="ai-fc-val">'+fmt(v)+'</div><div class="ai-fc-chg '+(chg>0?'up':'down')+'">'+(chg>0?'â†‘':'â†“')+Math.abs(chg).toFixed(1)+'%</div><div class="ai-confidence">ğŸ¯ '+(bestR2E*100).toFixed(0)+'% ishonch</div></div>';
  }).join('');

  /* Forecast chart â€” actual + best model fitted + prognoz */
  const allLabels=[...MS,...FM.map(m=>m+' (prognoz)')];
  const actualData=[...totalMonthly,...Array(3).fill(null)];
  const predData=[...Array(12).fill(null),...forecastE];
  const fittedLine=bestE.fitted?[...bestE.fitted,...Array(3).fill(null)]:null;

  const datasets=[
    {label:'Haqiqiy xarajat',data:actualData,borderColor:p.c1,backgroundColor:p.c1+'20',fill:true,tension:.3,pointRadius:5,pointBackgroundColor:p.c1,borderWidth:2.5},
    {label:'AI Prognoz ('+bestE.name.split('(')[0].trim()+')',data:predData,borderColor:p.c3,backgroundColor:p.c3+'20',fill:true,tension:.3,pointRadius:7,pointBackgroundColor:p.c3,borderWidth:3,pointStyle:'star'},
  ];
  if(fittedLine) datasets.push({label:'Model (fitted)',data:fittedLine,borderColor:p.c7,borderWidth:1.5,borderDash:[6,4],pointRadius:0,fill:false});

  /* Barcha modellarning individual prognozlarini ham chiziqda ko'rsatish */
  const modelColors=['#EC4899','#8B5CF6','#F59E0B','#06B6D4'];
  mfE.all.forEach((m,mi)=>{
    if(m!==bestE && m.r2>0.05){/* faqat yetarlicha yaxshi modellar */
      const mPred=[...Array(12).fill(null),m.predict(12),m.predict(13),m.predict(14)];
      datasets.push({label:m.name.split('(')[0].trim()+' ('+(m.r2*100).toFixed(0)+'%)',data:mPred,
        borderColor:modelColors[mi%modelColors.length],borderWidth:1.5,borderDash:[4,3],pointRadius:4,fill:false,tension:.3});
    }
  });

  charts.aiF=new Chart(document.getElementById('chartAiForecast'),{type:'line',data:{labels:allLabels,datasets},
    options:bOpts({plugins:{legend:{position:'top',labels:{font:{size:10},padding:8}}}})});

  /* Expense insights */
  const insights=[];
  insights.push({t:bestR2E>.7?'positive':bestR2E>.4?'neutral':'warning',i:'ğŸ¤–',
    m:'Eng yaxshi model: <b>'+bestE.name+'</b> â€” aniqligi <b>'+(bestR2E*100).toFixed(1)+'%</b>. '+
    (bestR2E>.7?'Bu yaxshi ishonchlilik â€” prognozlarga tayanish mumkin.':bestR2E>.4?'O\'rtacha ishonchlilik â€” ehtiyotlik bilan foydalaning.':'Past ishonchlilik â€” ma\'lumotlar juda tartibsiz.')});

  if(trendPct>5) insights.push({t:'negative',i:'ğŸ“ˆ',m:'Xarajatlar o\'sish tendensiyasida â€” kelgusi 3 oyda taxminan '+fmt(forecastE.reduce((s,v)=>s+v,0))+" so'm kutilmoqda."});
  else if(trendPct<-5) insights.push({t:'positive',i:'ğŸ“‰',m:'Xarajatlar kamayish tendensiyasida â€” optimallashtirish samarali.'});
  else insights.push({t:'neutral',i:'ğŸ“Š',m:'Xarajatlar barqaror â€” keskin o\'zgarish kuzatilmayapti.'});

  /* Anomaly detection */
  const avg=sum(totalMonthly)/12, std=Math.sqrt(totalMonthly.reduce((s,v)=>s+(v-avg)**2,0)/12);
  totalMonthly.forEach((v,i)=>{if(v>avg+2*std&&v>0)insights.push({t:'warning',i:'âš ï¸',m:months[i]+' oyida anomal yuqori xarajat: '+fmt(v)+" so'm (o'rtachadan "+(((v-avg)/avg)*100).toFixed(0)+'% yuqori).'})});

  /* Mavsumiylik tahlili */
  if(mfE.sd && mfE.sd.seasonal){
    const sMax=Math.max(...mfE.sd.seasonal), sMin=Math.min(...mfE.sd.seasonal);
    const sMaxI=mfE.sd.seasonal.indexOf(sMax), sMinI=mfE.sd.seasonal.indexOf(sMin);
    if(sMax>1.3) insights.push({t:'neutral',i:'ğŸ“…',m:'Mavsumiy tahlil: <b>'+months[sMaxI]+'</b> oyi eng qimmat ('+(sMax*100-100).toFixed(0)+'% yuqori), <b>'+months[sMinI]+'</b> eng arzon ('+(100-sMin*100).toFixed(0)+'% past). Bayram mukofotlari va maxsus to\'lovlar sabab bo\'lmoqda.'});
  }

  /* Model solishtirma */
  const modelCompare=mfE.all.map(m=>m.name.split('(')[0].trim()+': '+(m.r2*100).toFixed(0)+'%').join(', ');
  insights.push({t:'neutral',i:'ğŸ”¬',m:'Modellar solishtirmasi: '+modelCompare});

  document.getElementById('aiExpenseInsights').innerHTML=insights.map(i=>'<div class="ai-insight '+i.t+'"><span>'+i.i+'</span><span>'+i.m+'</span></div>').join('');

  /* â”€â”€ Ombor prognozi â”€â”€ */
  document.getElementById('aiForecastWarehouse').innerHTML=forecastW.map((v,i)=>{
    const chg=lastW>0?((v-lastW)/lastW*100):0;
    return '<div class="ai-fc"><div class="ai-fc-month">'+FM[i]+' 2026</div><div class="ai-fc-val">'+fmt(v)+'</div><div class="ai-fc-chg '+(chg>0?'up':'down')+'">'+(chg>0?'â†‘':'â†“')+Math.abs(chg).toFixed(1)+'%</div><div class="ai-confidence">ğŸ¯ '+(bestR2W*100).toFixed(0)+'% ishonch</div></div>';
  }).join('');

  const wActual=[...D.omborChiqim,...Array(3).fill(null)];
  const wPred=[...Array(12).fill(null),...forecastW];
  const kActual=[...D.mahsulotKirim,...Array(3).fill(null)];
  const wFitted=bestW.fitted?[...bestW.fitted,...Array(3).fill(null)]:null;
  const wDS=[
    {label:'Ombor chiqimi',data:wActual,borderColor:p.c3,backgroundColor:p.c3+'15',fill:true,tension:.3,pointRadius:5,pointBackgroundColor:p.c3,borderWidth:2.5},
    {label:'Kirim (mahsulot)',data:kActual,borderColor:p.c5,tension:.3,pointRadius:4,pointBackgroundColor:p.c5,borderWidth:2},
    {label:'Chiqim prognozi ('+bestW.name.split('(')[0].trim()+')',data:wPred,borderColor:'#EC4899',backgroundColor:'#EC489920',fill:true,tension:.3,pointRadius:7,pointBackgroundColor:'#EC4899',borderWidth:3,pointStyle:'star'},
  ];
  if(wFitted) wDS.push({label:'Model (fitted)',data:wFitted,borderColor:p.c7,borderWidth:1.5,borderDash:[6,4],pointRadius:0,fill:false});
  charts.aiW=new Chart(document.getElementById('chartAiWarehouse'),{type:'line',data:{labels:allLabels,datasets:wDS},
    options:bOpts({plugins:{legend:{position:'top',labels:{font:{size:10}}}}})});

  /* Warehouse insights */
  const wInsights=[];
  wInsights.push({t:bestR2W>.7?'positive':bestR2W>.4?'neutral':'warning',i:'ğŸ¤–',
    m:'Ombor modeli: <b>'+bestW.name+'</b> â€” aniqligi <b>'+(bestR2W*100).toFixed(1)+'%</b>.'});
  const kirimTotal=sum(D.mahsulotKirim),chiqimTotal=sum(D.omborChiqim);
  if(kirimTotal>chiqimTotal*1.5) wInsights.push({t:'positive',i:'âœ…',m:'Kirim chiqimdan '+((kirimTotal/chiqimTotal-1)*100).toFixed(0)+'% yuqori â€” ombor zaxirasi yetarli.'});
  else if(chiqimTotal>kirimTotal) wInsights.push({t:'negative',i:'ğŸ”´',m:'Chiqim kirimdan oshib ketmoqda! Ombor zaxirasi kamayish xavfi.'});

  if(D.topOmborItems.length>0){
    const top3=D.topOmborItems.slice(0,3).map(i=>i.name).join(', ');
    wInsights.push({t:'neutral',i:'ğŸ“‹',m:'Eng ko\'p sarflanadigan: '+top3+'.'});
  }
  document.getElementById('aiWarehouseInsights').innerHTML=wInsights.map(i=>'<div class="ai-insight '+i.t+'"><span>'+i.i+'</span><span>'+i.m+'</span></div>').join('');

  /* â”€â”€ Recommendations â”€â”€ */
  const recs=[];
  const ihGrowth=D.ishHaqi[11]>0&&D.ishHaqi[0]>0?((D.ishHaqi[11]-D.ishHaqi[0])/D.ishHaqi[0]*100):0;
  if(ihGrowth>10) recs.push({t:'warning',i:'ğŸ’°',m:'Ish haqi fondi '+ihGrowth.toFixed(1)+"% o'sgan. Kelgusi yilda ~"+fmt(sum(D.ishHaqi)*(1+ihGrowth/100))+" so'm talab qiladi."});
  const peakSick=Math.max(...D.sickByMonth),peakSickI=D.sickByMonth.indexOf(peakSick);
  if(peakSick>10) recs.push({t:'negative',i:'ğŸ¥',m:months[peakSickI]+' oyida kasallanish keskin oshgan ('+peakSick+" ta). Profilaktik choralar tavsiya etiladi."});
  const peakVac=Math.max(...D.vacationByMonth),peakVacI=D.vacationByMonth.indexOf(peakVac);
  if(peakVac>15) recs.push({t:'warning',i:'ğŸ–ï¸',m:months[peakVacI]+' oyida '+peakVac+" ta ta'tilga chiqqan. Ta'tillarni bir tekis taqsimlash tavsiya etiladi."});
  const ePeak=Math.max(...D.elektr),eAvg=sum(D.elektr)/12;
  if(ePeak>eAvg*2) recs.push({t:'neutral',i:'âš¡',m:'Elektr xarajatlari eng qimmat oyda o\'rtachadan '+((ePeak/eAvg-1)*100).toFixed(0)+'% yuqori. Energiya tejash tavsiya etiladi.'});
  const cTop=D.contractList.reduce((mx,c)=>c.summa>mx.summa?c:mx,{summa:0});
  if(cTop.summa>500000000) recs.push({t:'neutral',i:'ğŸ“„',m:'Eng yirik shartnoma: "'+cTop.provider+'" â€” '+fmt(cTop.summa)+" so'm. Tender o'tkazish tavsiya etiladi."});
  if(!recs.length) recs.push({t:'positive',i:'âœ…',m:'Barcha ko\'rsatkichlar me\'yor doirasida.'});
  document.getElementById('aiRecommendations').innerHTML=recs.map(r=>'<div class="ai-insight '+r.t+'"><span>'+r.i+'</span><span>'+r.m+'</span></div>').join('');

  /* â•â•â• Methodology Panel â€” yangilangan 5-model tizimi â•â•â• */
  const avgVal=sum(totalMonthly)/12;
  const stdVal=Math.sqrt(totalMonthly.reduce((s,v)=>s+(v-avgVal)**2,0)/12);

  let mh='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1rem">';

  /* M1: Holt-Winters */
  mh+='<div style="background:var(--bg-accent);border-radius:14px;padding:1.15rem;border:1px solid var(--border)">';
  mh+='<div style="font-weight:700;margin-bottom:.6rem;display:flex;align-items:center;gap:.4rem;color:#EC4899">ğŸŒŠ Holt-Winters (Uchlamchi silliqlashtirish)</div>';
  mh+='<div style="font-family:\'Courier New\',monospace;font-size:.92rem;text-align:center;padding:.65rem;background:var(--bg-card);border-radius:10px;margin-bottom:.6rem;font-weight:600;line-height:1.6">';
  mh+='Lâ‚œ = Î±Â·(Yâ‚œ/Sâ‚œâ‚‹â‚˜) + (1âˆ’Î±)Â·(Lâ‚œâ‚‹â‚ + Tâ‚œâ‚‹â‚)<br>Tâ‚œ = Î²Â·(Lâ‚œ âˆ’ Lâ‚œâ‚‹â‚) + (1âˆ’Î²)Â·Tâ‚œâ‚‹â‚<br>Sâ‚œ = Î³Â·(Yâ‚œ/Lâ‚œ) + (1âˆ’Î³)Â·Sâ‚œâ‚‹â‚˜</div>';
  mh+='<div style="font-size:.84rem;line-height:1.65;color:var(--text-secondary)">';
  mh+='<b>L</b> â€” level (daraja), <b>T</b> â€” trend, <b>S</b> â€” seasonal (mavsumiylik)<br>';
  if(mfE.hw){mh+='Optimal: Î±='+mfE.hw.alpha+', Î²='+mfE.hw.beta+', Î³='+mfE.hw.gamma+'<br>'}
  mh+='RÂ² = <b style="color:#EC4899">'+(mfE.hw?(mfE.hw.r2*100).toFixed(1):'â€”')+'%</b></div></div>';

  /* M2: Seasonal Decomposition */
  mh+='<div style="background:var(--bg-accent);border-radius:14px;padding:1.15rem;border:1px solid var(--border)">';
  mh+='<div style="font-weight:700;margin-bottom:.6rem;display:flex;align-items:center;gap:.4rem;color:#8B5CF6">ğŸ“… Mavsumiy dekompozitsiya (STL)</div>';
  mh+='<div style="font-family:\'Courier New\',monospace;font-size:1rem;text-align:center;padding:.65rem;background:var(--bg-card);border-radius:10px;margin-bottom:.6rem;font-weight:700">Y = Trend Ã— Seasonal Ã— Residual</div>';
  mh+='<div style="font-size:.84rem;line-height:1.65;color:var(--text-secondary)">';
  mh+='<b>Trend</b> â€” uzoq muddatli yo\'nalish<br>';
  mh+='<b>Seasonal</b> â€” har bir oy uchun takrorlanuvchi pattern<br>';
  if(mfE.sd){
    const sMax=Math.max(...mfE.sd.seasonal), sMin=Math.min(...mfE.sd.seasonal);
    mh+='Eng yuqori mavsumiy koeff: <b>'+sMax.toFixed(2)+'</b> ('+months[mfE.sd.seasonal.indexOf(sMax)]+')<br>';
    mh+='Eng past: <b>'+sMin.toFixed(2)+'</b> ('+months[mfE.sd.seasonal.indexOf(sMin)]+')<br>';
  }
  mh+='RÂ² = <b style="color:#8B5CF6">'+(mfE.sd?(mfE.sd.r2*100).toFixed(1):'â€”')+'%</b></div></div>';

  /* M3: Ensemble */
  mh+='<div style="background:var(--bg-accent);border-radius:14px;padding:1.15rem;border:1px solid var(--border)">';
  mh+='<div style="font-weight:700;margin-bottom:.6rem;display:flex;align-items:center;gap:.4rem;color:#10B981">ğŸ¯ Ensemble (Kombinatsiya)</div>';
  mh+='<div style="font-family:\'Courier New\',monospace;font-size:.95rem;text-align:center;padding:.65rem;background:var(--bg-card);border-radius:10px;margin-bottom:.6rem;font-weight:600">Å· = Î£(wáµ¢ Ã— Å·áµ¢) / Î£wáµ¢,  wáµ¢ = RÂ²áµ¢Â²</div>';
  mh+='<div style="font-size:.84rem;line-height:1.65;color:var(--text-secondary)">';
  mh+='Barcha modellar RÂ² kvadratiga proportional vazn bilan birlashtiradi<br>';
  mh+='Yaxshi model â†’ ko\'p vazn, yomon model â†’ kam vazn<br>';
  mh+='RÂ² = <b style="color:#10B981">'+(mfE.ensemble.r2*100).toFixed(1)+'%</b></div></div>';

  /* M4: Anomaly Detection */
  mh+='<div style="background:var(--bg-accent);border-radius:14px;padding:1.15rem;border:1px solid var(--border)">';
  mh+='<div style="font-weight:700;margin-bottom:.6rem;display:flex;align-items:center;gap:.4rem;color:#F59E0B">ğŸ” Anomaliya aniqlash (2Ïƒ)</div>';
  mh+='<div style="font-family:\'Courier New\',monospace;font-size:1.05rem;text-align:center;padding:.65rem;background:var(--bg-card);border-radius:10px;margin-bottom:.6rem;font-weight:700">|xáµ¢ âˆ’ Î¼| > 2Ïƒ â†’ Anomal</div>';
  mh+='<div style="font-size:.84rem;line-height:1.65;color:var(--text-secondary)">';
  mh+='<b>Î¼</b> = '+fmt(avgVal)+' so\'m, <b>Ïƒ</b> = '+fmt(stdVal)+' so\'m<br>';
  mh+='<b>Chegara:</b> '+fmt(avgVal+2*stdVal)+' so\'m</div></div>';

  mh+='</div>';

  /* â•â•â• MODEL SOLISHTIRMA JADVALI â•â•â• */
  mh+='<div style="margin-top:1rem;background:var(--bg-accent);border-radius:14px;padding:1.15rem;border:1px solid var(--border)">';
  mh+='<div style="font-weight:700;margin-bottom:.75rem;display:flex;align-items:center;gap:.4rem;color:'+p.c1+'">ğŸ† Modellar reyting jadvali (avtomatik tanlangan: '+bestE.name.split('(')[0].trim()+')</div>';
  mh+='<table class="data-table"><thead><tr><th>â„–</th><th>Model nomi</th><th class="num">RÂ² (%)</th><th class="num">Yanvar prognozi</th><th class="num">Fevral</th><th class="num">Mart</th><th>Holat</th></tr></thead><tbody>';
  mfE.all.sort((a,b)=>b.r2-a.r2).forEach((m,i)=>{
    const isBest=m===bestE;
    const r2Pct=(m.r2*100).toFixed(1);
    const statusColor=m.r2>.7?'#10B981':m.r2>.4?'#F59E0B':'#EF4444';
    const statusText=m.r2>.7?'âœ… Yaxshi':m.r2>.4?'âš ï¸ O\'rtacha':'âŒ Past';
    mh+='<tr style="'+(isBest?'background:'+p.c1+'12;font-weight:700':'')+'">';
    mh+='<td>'+(i+1)+'</td>';
    mh+='<td style="'+(isBest?'color:'+p.c1:'')+'">'+m.name+(isBest?' â­':'')+'</td>';
    mh+='<td class="num" style="font-weight:700;color:'+statusColor+'">'+r2Pct+'%</td>';
    mh+='<td class="num">'+fmt(m.predict(12))+'</td>';
    mh+='<td class="num">'+fmt(m.predict(13))+'</td>';
    mh+='<td class="num">'+fmt(m.predict(14))+'</td>';
    mh+='<td style="color:'+statusColor+'">'+statusText+'</td></tr>';
  });
  /* Ensemble qatori */
  mh+='<tr style="background:var(--bg-card);font-weight:700;border-top:2px solid var(--border)"><td></td><td style="color:#10B981">ğŸ¯ Ensemble</td><td class="num" style="color:#10B981">'+(mfE.ensemble.r2*100).toFixed(1)+'%</td>';
  mh+='<td class="num">'+fmt(mfE.ensemble.predict(12))+'</td><td class="num">'+fmt(mfE.ensemble.predict(13))+'</td><td class="num">'+fmt(mfE.ensemble.predict(14))+'</td><td style="color:#10B981">ğŸ† Kombinatsiya</td></tr>';
  mh+='</tbody></table></div>';

  /* â•â•â• Mavsumiy koeffitsientlar diagrammasi â•â•â• */
  if(mfE.sd && mfE.sd.seasonal){
    mh+='<div style="margin-top:1rem;background:var(--bg-accent);border-radius:14px;padding:1.15rem;border:1px solid var(--border)">';
    mh+='<div style="font-weight:700;margin-bottom:.75rem;display:flex;align-items:center;gap:.4rem;color:#8B5CF6">ğŸ“Š Mavsumiy koeffitsientlar (1.0 = o\'rtacha)</div>';
    mh+='<div style="display:grid;grid-template-columns:repeat(12,1fr);gap:4px;margin-bottom:.5rem">';
    mfE.sd.seasonal.forEach((s,i)=>{
      const pct=Math.min(100,Math.max(20,s*50));
      const clr=s>1.15?'#EF4444':s<0.85?'#10B981':'#3B82F6';
      mh+='<div style="text-align:center"><div style="background:'+clr+'25;border-radius:6px;padding:2px;margin-bottom:2px"><div style="background:'+clr+';border-radius:4px;height:'+pct+'px;margin:2px auto;width:80%"></div></div>';
      mh+='<div style="font-size:.65rem;font-weight:600">'+MS[i]+'</div>';
      mh+='<div style="font-size:.7rem;font-weight:700;color:'+clr+'">'+s.toFixed(2)+'</div></div>';
    });
    mh+='</div>';
    mh+='<div style="font-size:.8rem;color:var(--text-muted)">ğŸ”´ >1.15 = xarajat yuqori oy, ğŸŸ¢ <0.85 = xarajat past oy, ğŸ”µ me\'yor doirasida</div></div>';
  }

  /* RÂ² ko'rsatkich tushuntirish */
  mh+='<div style="margin-top:1rem;background:var(--bg-accent);border-radius:14px;padding:1.15rem;border:1px solid var(--border)">';
  mh+='<div style="font-weight:700;margin-bottom:.75rem;display:flex;align-items:center;gap:.4rem;color:'+p.c6+'">ğŸ“ˆ RÂ² ko\'rsatkichni qanday tushunish kerak?</div>';
  mh+='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.5rem;margin-bottom:.75rem">';
  [{v:'90-100%',c:'#10B981',l:'Ajoyib',d:'Prognoz juda aniq'},{v:'70-90%',c:'#3B82F6',l:'Yaxshi',d:'Ishonchli prognoz'},{v:'40-70%',c:'#F59E0B',l:'O\'rtacha',d:'Ehtiyot bo\'lish kerak'},{v:'0-40%',c:'#EF4444',l:'Past',d:'Model ishlamayapti'}].forEach(r=>{
    mh+='<div style="text-align:center;padding:.6rem;border-radius:10px;background:'+r.c+'12;border:1px solid '+r.c+'30"><div style="font-weight:700;color:'+r.c+'">'+r.v+'</div><div style="font-size:.82rem;font-weight:600">'+r.l+'</div><div style="font-size:.75rem;color:var(--text-muted)">'+r.d+'</div></div>'});
  mh+='</div>';
  mh+='<div style="font-size:.84rem;color:var(--text-secondary);line-height:1.6">';
  mh+='Xarajat uchun eng yaxshi model: <b style="color:'+(bestR2E>.7?'#10B981':bestR2E>.4?'#F59E0B':'#EF4444')+'">'+bestE.name+' â€” '+(bestR2E*100).toFixed(1)+'%</b><br>';
  mh+='Ombor uchun eng yaxshi model: <b style="color:'+(bestR2W>.7?'#10B981':bestR2W>.4?'#F59E0B':'#EF4444')+'">'+bestW.name+' â€” '+(bestR2W*100).toFixed(1)+'%</b>';
  mh+='</div></div>';

  document.getElementById('aiMethodContent').innerHTML=mh;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVENTORY MANAGEMENT â€” Kirim / Chiqim
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let invLog=[];

function addInventory(type){
  const isKirim = type==='kirim';
  const nameEl=document.getElementById(isKirim?'kirimName':'chiqimName');
  const qtyEl=document.getElementById(isKirim?'kirimQty':'chiqimQty');
  const dateEl=document.getElementById(isKirim?'kirimDate':'chiqimDate');
  const name=nameEl.value.trim(), qty=parseInt(qtyEl.value);

  if(!name){nameEl.style.borderColor='#EF4444';setTimeout(()=>nameEl.style.borderColor='',1500);return}
  if(!qty||qty<=0){qtyEl.style.borderColor='#EF4444';setTimeout(()=>qtyEl.style.borderColor='',1500);return}

  const dept=document.getElementById(isKirim?'kirimDept':'chiqimDept').value;
  const price=isKirim?parseFloat(document.getElementById('kirimPrice').value)||0:0;
  const reason=isKirim?'':document.getElementById('chiqimReason').value;
  const now=new Date();
  const timeStr=now.toLocaleTimeString('uz',{hour:'2-digit',minute:'2-digit'});

  /* Sana â€” foydalanuvchi tanlagan yoki bugungi */
  const selectedDate=dateEl.value; /* "2025-03-15" format */
  let dateDisplay='';
  if(selectedDate){
    const [y,m,d]=selectedDate.split('-');
    dateDisplay=d+'.'+m+'.'+y; /* "15.03.2025" */
  } else {
    dateDisplay=now.toLocaleDateString('uz-UZ',{day:'2-digit',month:'2-digit',year:'numeric'});
  }

  const entry={type,name,qty,dept,price,reason,time:timeStr,date:dateDisplay,total:price*qty};
  invLog.unshift(entry);

  /* Clear form */
  nameEl.value='';qtyEl.value='';
  if(isKirim)document.getElementById('kirimPrice').value='';

  /* Show log */
  document.getElementById('invLogSection').style.display='block';
  renderInvLog();

  /* Voice announcement */
  const msg=isKirim
    ? name+' â€” '+numToUzWords(Math.round(qty))+' dona omborga kiritildi. Jami summa: '+fmtV(entry.total)+' so\'m'
    : name+' â€” '+numToUzWords(Math.round(qty))+' dona ombordan chiqarildi. Bo\'lim: '+dept+'. Sabab: '+reason;
  speakText(msg);
}

function renderInvLog(){
  document.getElementById('invLogCount').textContent='('+invLog.length+' ta amal)';
  document.getElementById('invLog').innerHTML=invLog.map(e=>{
    const isIn=e.type==='kirim';
    return '<div class="inv-log-item '+(isIn?'in':'out')+'">'
      +'<span style="font-size:1.1rem">'+(isIn?'ğŸ“¥':'ğŸ“¤')+'</span>'
      +'<span style="font-weight:600;flex:1">'+e.name+'</span>'
      +'<span style="color:'+(isIn?'#10B981':'#EF4444')+';font-weight:700">'+(isIn?'+':'-')+e.qty+' dona</span>'
      +'<span style="color:var(--text-muted);font-size:.8rem">'+e.dept+'</span>'
      +(e.total?'<span style="font-weight:600">'+fmtF(e.total)+" so'm</span>":'')
      +'<span style="color:var(--text-muted);font-size:.78rem">ğŸ“… '+e.date+' Â· '+e.time+'</span>'
      +'</div>';
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOICE ALERTS â€” Azure TTS + Browser Fallback
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const AZURE_KEY='1XBh7tnZOwcd7uI1kGu8at1gkys1aBIIRiYwQ5Dn7dxszAMShYVqJQQJ99CAACYeBjFXJ3w3AAAYACOGcO7v';
const AZURE_REGIONS=['eastus','westeurope','southeastasia','centralus'];
let azureRegion=null;
let isSpeaking=false;
let currentAudio=null; /* Global reference to stop Azure TTS audio */

/* â”€â”€ To'xtatish funksiyasi â€” har qanday ovozni darhol to'xtatadi â”€â”€ */
function stopSpeaking(){
  /* Azure TTS audio to'xtatish */
  if(currentAudio){
    currentAudio.pause();
    currentAudio.currentTime=0;
    if(currentAudio.src && currentAudio.src.startsWith('blob:')) URL.revokeObjectURL(currentAudio.src);
    currentAudio=null;
  }
  /* Browser SpeechSynthesis to'xtatish */
  if('speechSynthesis' in window) speechSynthesis.cancel();
  /* UI tozalash */
  isSpeaking=false;
  const btn=document.getElementById('voiceBtn');
  const ind=document.getElementById('voiceInd');
  if(btn) btn.classList.remove('speaking');
  if(ind) ind.classList.remove('active');
}

/* Avval Azure TTS ni sinab ko'ramiz, ishlamasa browser SpeechSynthesis */
async function speakText(rawText){
  if(isSpeaking){stopSpeaking();return}
  /* Sanitize text for TTS â€” ALL numbers to Uzbek words, ALL abbreviations expanded */
  const text=cleanForTTS(rawText);

  /* Debug: show exactly what TTS will receive */
  console.log('[TTS] Raw input:', rawText.slice(0,200));
  console.log('[TTS] Cleaned output:', text.slice(0,200));
  const hasDigits=/[0-9]/.test(text);
  if(hasDigits) console.warn('[TTS] âš ï¸ DIGITS STILL FOUND IN TEXT!', text.match(/\d+/g));

  isSpeaking=true;
  const btn=document.getElementById('voiceBtn');
  const ind=document.getElementById('voiceInd');
  btn.classList.add('speaking');
  ind.classList.add('active');

  /* Try Azure TTS first */
  let azureOk=false;
  if(AZURE_KEY){
    try{
      /* Find working region */
      if(!azureRegion){
        for(const r of AZURE_REGIONS){
          try{
            const res=await fetch('https://'+r+'.tts.speech.microsoft.com/cognitiveservices/v1',{method:'POST',
              headers:{'Ocp-Apim-Subscription-Key':AZURE_KEY,'Content-Type':'application/ssml+xml','X-Microsoft-OutputFormat':'audio-24khz-48kbitrate-mono-mp3'},
              body:'<speak version="1.0" xml:lang="uz-UZ"><voice name="uz-UZ-SardorNeural"><prosody rate="0%">Test</prosody></voice></speak>'});
            if(res.ok){azureRegion=r;break}
          }catch(e){}
        }
      }
      if(azureRegion){
        /* cleanForTTS already converted all numbers to words â€” just sanitize for XML */
        const ssmlText=text.replace(/[<>&"]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c]));
        const ssml='<speak version="1.0" xml:lang="uz-UZ"><voice name="uz-UZ-SardorNeural"><prosody rate="-5%">'+ssmlText+'</prosody></voice></speak>';
        const res=await fetch('https://'+azureRegion+'.tts.speech.microsoft.com/cognitiveservices/v1',{method:'POST',
          headers:{'Ocp-Apim-Subscription-Key':AZURE_KEY,'Content-Type':'application/ssml+xml','X-Microsoft-OutputFormat':'audio-24khz-48kbitrate-mono-mp3'},
          body:ssml});
        if(res.ok){
          const blob=await res.blob();
          const url=URL.createObjectURL(blob);
          const audio=new Audio(url);
          currentAudio=audio; /* â† Global reference â€” stopSpeaking() buni to'xtatadi */
          audio.onended=()=>{currentAudio=null;stopSpeaking()};
          audio.onerror=()=>{currentAudio=null;stopSpeaking()};
          await audio.play();
          azureOk=true;
        }
      }
    }catch(e){console.log('Azure TTS error:',e)}
  }

  /* Fallback: Browser SpeechSynthesis */
  if(!azureOk && 'speechSynthesis' in window){
    const utter=new SpeechSynthesisUtterance(text);
    utter.lang='uz-UZ';utter.rate=0.9;utter.pitch=1;
    /* Try to find an Uzbek or Russian voice as fallback */
    const voices=speechSynthesis.getVoices();
    const uzVoice=voices.find(v=>v.lang.startsWith('uz'))||voices.find(v=>v.lang.startsWith('ru'))||voices.find(v=>v.lang.startsWith('en'));
    if(uzVoice) utter.voice=uzVoice;
    utter.onend=()=>{stopSpeaking()};
    utter.onerror=()=>{stopSpeaking()};
    speechSynthesis.speak(utter);
    if(!azureOk) azureOk=true;
  }

  if(!azureOk){stopSpeaking()}
}

/* Main voice alert - reads all critical warnings */
function speakAlerts(){
  /* Toggle: agar ovoz o'ynamoqda bo'lsa â€” to'xtatish */
  if(isSpeaking){stopSpeaking();return}
  if(!D) return;
  let text='Diqqat! Markaziy Bank buxgalteriya ogohlantirishlari. ';

  /* Expense trend */
  const totalMonthly=D.ishHaqi.map((v,i)=>v+D.staj[i]+D.mehnatTatil[i]+D.bayramMukofot[i]+D.ijtimoiySoliq[i]);
  const avg=sum(totalMonthly)/12;
  const last3Avg=(totalMonthly[9]+totalMonthly[10]+totalMonthly[11])/3;
  if(last3Avg>avg*1.1){
    const pct=Math.round((last3Avg/avg-1)*100);
    text+='Ogohlantirish: Oxirgi uch oy xarajatlari o\'rtachadan '+numToUzWords(pct)+' foiz yuqori. ';
  }

  /* Sick leave peak */
  const peakSick=Math.max(...D.sickByMonth),psi=D.sickByMonth.indexOf(peakSick);
  if(peakSick>10) text+=months[psi]+' oyida kasallanish yuqori, '+numToUzWords(peakSick)+' ta kasallik varaqasi olgan. ';

  /* Vacation peak */
  const peakVac=Math.max(...D.vacationByMonth),pvi=D.vacationByMonth.indexOf(peakVac);
  if(peakVac>15) text+=months[pvi]+' oyida '+numToUzWords(peakVac)+' ta ta\'tilga chiqqan. ';

  /* Warehouse */
  const omborAvg=sum(D.omborChiqim)/12;
  D.omborChiqim.forEach((v,i)=>{if(v>omborAvg*3) text+=months[i]+' oyida ombor chiqimi keskin oshgan, '+fmtV(v)+' so\'m. '});

  /* Low stock items */
  if(D.topOmborItems.length>0){
    const topAvg=D.topOmborItems.reduce((s,i)=>s+i.qty,0)/D.topOmborItems.length;
    const critical=D.topOmborItems.filter(i=>i.qty>topAvg*2);
    if(critical.length>0){
      text+='Diqqat! Omborda kam qolgan mahsulotlar aniqlandi. ';
      critical.slice(0,5).forEach(item=>{
        text+=item.name+' mahsuloti ko\'p sarflangan, yil davomida '+numToUzWords(Math.round(item.qty))+' dona ishlatilgan. Xarid qilish lozim. ';
      });
    }
  }

  text+='Ogohlantirish yakunlandi.';
  speakText(text);
}

/* AI section voice reading */
function speakForecast(section){
  if(!D) return;
  let text='';
  if(section==='expense'){
    /* aiModelE â€” buildAI da global saqlangan */
    if(aiModelE && aiModelE.best){
      const b=aiModelE.best;
      const f1=aiModelE.forecasts[0]||0,f2=aiModelE.forecasts[1]||0,f3=aiModelE.forecasts[2]||0;
      const accuracy=Math.round(b.r2*100);
      text='Xarajatlar prognozi. '+b.name.split('(')[0].trim()+' modeli ishlatildi. Yanvar: taxminan '+fmtV(f1)+' so\'m. Fevral: '+fmtV(f2)+' so\'m. Mart: '+fmtV(f3)+' so\'m. Model aniqligi '+numToUzWords(accuracy)+' foiz.';
    } else {
      text='Xarajatlar prognozi hali hisoblanmagan. Iltimos, avval Excel faylni yuklang.';
    }
  } else if(section==='warehouse'){
    if(aiModelW && aiModelW.best){
      const b=aiModelW.best;
      const total=aiModelW.forecasts.reduce((s,v)=>s+v,0);
      text='Ombor prognozi. '+b.name.split('(')[0].trim()+' modeli ishlatildi. Kelgusi uch oyda ombor chiqimi '+fmtV(total)+' so\'m atrofida kutilmoqda. Model aniqligi '+numToUzWords(Math.round(b.r2*100))+' foiz. Jami mahsulot kirimi '+fmtV(sum(D.mahsulotKirim))+' so\'m, chiqim esa '+fmtV(sum(D.omborChiqim))+' so\'m.';
    } else {
      text='Ombor prognozi hali hisoblanmagan.';
    }
  } else if(section==='recommendations'){
    text='Tavsiyalar bo\'limi. ';
    const ihG=D.ishHaqi[11]>0&&D.ishHaqi[0]>0?((D.ishHaqi[11]-D.ishHaqi[0])/D.ishHaqi[0]*100):0;
    if(ihG>10) text+='Ish haqi fondi '+numToUzWords(Math.round(ihG))+' foiz o\'sgan. ';
    text+='Batafsil ma\'lumot dashboardda ko\'rsatilgan.';
  }
  speakText(text);
}

/* Auto warehouse low stock voice alert â€” runs after data load */
function autoWarehouseAlert(){
  if(!D || D.topOmborItems.length===0) return;
  const topAvg=D.topOmborItems.reduce((s,i)=>s+i.qty,0)/D.topOmborItems.length;
  const critical=D.topOmborItems.filter(i=>i.qty>topAvg*2);
  if(critical.length===0) return;

  let text='Diqqat! Ombor tahlili yakunlandi. ';
  text+=numToUzWords(critical.length)+' ta mahsulot bo\'yicha kam qolish xavfi aniqlandi. ';
  critical.slice(0,5).forEach((item,i)=>{
    const ordinal=['birinchi','ikkinchi','uchinchi','to\'rtinchi','beshinchi'];
    text+=ordinal[i]+': '+item.name+', yil davomida '+numToUzWords(Math.round(item.qty))+' dona sarflangan. Yangi xarid kerak. ';
  });

  /* Kirim va chiqim balansi â€” faqat mahsulot shartnomalar */
  const kirimJ=sum(D.mahsulotKirim), chiqimJ=sum(D.omborChiqim);
  if(chiqimJ>kirimJ){
    text+='Ogohlantirish! Ombor chiqimi mahsulot kirimidan oshib ketgan. Jami mahsulot kirimi '+fmtV(kirimJ)+' so\'m, jami chiqim esa '+fmtV(chiqimJ)+' so\'m. Yangi shartnomalar tuzish zarur. ';
  } else {
    text+='Ombor balansi ijobiy. Jami mahsulot kirimi '+fmtV(kirimJ)+' so\'m, chiqim '+fmtV(chiqimJ)+' so\'m. ';
  }
  text+='Batafsil ma\'lumot ombor sahifasida.';
  speakText(text);
}

/* â”€â”€â”€ ALERTS â”€â”€â”€ */
function buildAlerts(p){
  const al=[];
  const bm=D.bayramMukofot.map((v,i)=>({v,m:months[i]})).filter(x=>x.v>0).sort((a,b)=>b.v-a.v);
  if(bm.length)al.push({t:'danger',i:'ğŸ”´',h:'Bayram mukofoti â€” yirik xarajat oylari',b:bm.map(x=>x.m+': '+fmt(x.v)).join(', ')+'. Bu oylar jami xarajatni keskin oshiradi.'});

  const mvi=D.vacationByMonth.indexOf(Math.max(...D.vacationByMonth)),mv=D.vacationByMonth[mvi];
  if(mv>0)al.push({t:'warning',i:'ğŸŸ¡',h:months[mvi]+" â€” Ta'tilga eng ko'p chiqqan oy ("+mv+' ta)',b:"Mehnat ta'tili xarajati: "+fmt(D.mehnatTatil[mvi])+". Bu davrda ish jarayonini to'g'ri tashkil qilish zarur."});

  const msi=D.sickByMonth.indexOf(Math.max(...D.sickByMonth)),ms=D.sickByMonth[msi];
  if(ms>0)al.push({t:'warning',i:'ğŸŸ¡',h:months[msi]+' â€” Kasallanish avj oladi ('+ms+' ta)',b:'Kasallik nafaqasi: '+fmt(D.bolnichny[msi])+'. Profilaktik tadbirlar kuchaytirilishi lozim.'});

  const ao=sum(D.omborChiqim)/12;D.omborChiqim.forEach((v,i)=>{if(v>ao*3)al.push({t:'warning',i:'ğŸŸ¡',h:months[i]+' â€” Ombor chiqimi keskin oshgan',b:fmt(v)+" so'm â€” bu o'rtacha ko'rsatkichdan "+(v/ao).toFixed(0)+'x yuqori.'})});

  D.shartnomalarKirim.forEach((v,i)=>{if(v>500000000)al.push({t:'warning',i:'ğŸŸ¡',h:months[i]+' â€” Yirik shartnomalar tuzilgan',b:fmt(v)+" so'mlik shartnomalar. Byudjet nazoratini kuchaytirish zarur."})});

  const gz=D.gaz.map((v,i)=>({v,m:months[i]})).filter(x=>x.v>0);
  if(gz.length)al.push({t:'warning',i:'ğŸŸ¡',h:'Qish oylari â€” gaz xarajatlari',b:gz.map(x=>x.m+': '+fmt(x.v)).join(', ')+'. Qozonxonani tekshirish lozim.'});

  const sn=D.tenure['25+ yil']||0;if(sn>0)al.push({t:'warning',i:'ğŸŸ¡',h:sn+' xodim 25+ yil stajga ega',b:'Pensiyaga chiqish ehtimoli yuqori. Kadr tayyorlash rejasini ishlab chiqish lozim.'});

  if(!al.length)al.push({t:'warning',i:'â„¹ï¸',h:"Ma'lumot yo'q",b:"Excel faylni yuklang â€” ogohlantirishlar avtomatik tahlil asosida chiqadi."});

  document.getElementById('alertsList').innerHTML=al.map(a=>'<div class="alert alert-'+a.t+'"><span class="alert-icon">'+a.i+'</span><div class="alert-text"><strong>'+a.h+'</strong>'+a.b+'</div></div>').join('');

  /* Update bell badge */
  const badge=document.getElementById('alertBellBadge');
  const bellIcon=document.getElementById('bellIcon');
  if(badge){
    const cnt=al.filter(a=>a.t!=='info').length;
    if(cnt>0){badge.textContent=cnt;badge.style.display='flex';if(bellIcon)bellIcon.classList.add('bell-ring')}
    else{badge.style.display='none';if(bellIcon)bellIcon.classList.remove('bell-ring')}
  }

  const tl=Object.keys(D.tenure),tv=Object.values(D.tenure);
  if(tl.length)charts.tn=new Chart(document.getElementById('chartTenure'),{type:'bar',data:{labels:tl,datasets:[{label:'Xodimlar soni',data:tv,backgroundColor:[p.c5,p.c4,p.c6,p.c1,p.c7,p.c3],borderRadius:8,barThickness:50}]},options:bOpts({plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>' '+ctx.parsed.y+' xodim'}}},yAxis:{beginAtZero:true,ticks:{stepSize:5}}})});
}

/* KPI helper â€” now clickable */
function kpi(color,icon,label,value,change,dir,kpiType){
  const onclick = kpiType ? ' onclick="showKpiDetail(\''+kpiType+'\')" style="cursor:pointer"' : '';
  return '<div class="kpi-card"'+onclick+'><div class="kpi-icon" style="background:'+color+'22;color:'+color+'">'+icon+'</div><div class="kpi-label">'+label+'</div><div class="kpi-value">'+value+'</div>'+(change?'<div class="kpi-change'+(dir?' '+dir:'')+'">'+change+'</div>':'')+'</div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL DETAIL SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let modalChart = null;

function closeModal(){
  document.getElementById('modalOverlay').classList.remove('show');
  if(modalChart){modalChart.destroy();modalChart=null}
}

/* â•â•â• DRILL-DOWN NAVIGATION â€” modal ichida chuqurlashish â•â•â•
   Kategoriya â†’ Ustunlar â†’ Xodimlar (agar ma'lumot bo'lsa)
   Oy â†’ Kategoriyalar â†’ Ustunlar
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let drillHistory=[]; /* breadcrumb uchun tarix */
let drillOriginalType=null; /* boshlang'ich modal turi */

function drillModalTo(level, key){
  if(!D) return;
  const p=P();
  const tableEl=document.getElementById('modalTable');
  const statsEl=document.getElementById('modalStats');
  const canvas=document.getElementById('modalChart');
  if(modalChart){modalChart.destroy();modalChart=null}

  /* â”€â”€ BREADCRUMB â”€â”€ */
  drillHistory.push({level,key});
  const bcHtml='<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap">'+
    '<button onclick="drillBack()" style="background:'+p.c1+';color:white;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:.85rem;font-weight:600;display:flex;align-items:center;gap:4px">â† Orqaga</button>'+
    '<div style="font-size:.8rem;color:var(--text-muted)">'+drillHistory.map(h=>h.level==='category'?'ğŸ“ '+h.key:h.level==='column'?'ğŸ“‹ '+h.key:h.level==='month'?'ğŸ“… '+h.key:h.level==='monthCat'?'ğŸ“ '+h.key.split('|')[0]:'').filter(Boolean).join(' â†’ ')+'</div></div>';

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LEVEL: category â€” kategoriya ustunlarini ko'rsatish
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  if(level==='category'){
    const cats=D.expCats||{};
    const cat=cats[key];
    if(!cat){tableEl.innerHTML='<p>Kategoriya topilmadi</p>';return}
    const catCols=cat.cols||[];
    const totalCat=sum(cat.total);
    const sortedCols=[...catCols].sort((a,b)=>sum(b.data)-sum(a.data));

    /* Stats */
    statsEl.innerHTML=[
      {l:'Kategoriya',v:key},
      {l:'Ustunlar soni',v:sortedCols.length+' ta'},
      {l:'Jami summa',v:fmt(totalCat)},
    ].map(s=>'<div class="modal-stat"><div class="modal-stat-label">'+s.l+'</div><div class="modal-stat-value">'+s.v+'</div></div>').join('');

    /* Chart â€” horizontal bar of columns */
    const top10=sortedCols.slice(0,10);
    const cc=[p.c1,p.c3,p.c5,p.c4,p.c7,p.c6,p.c8,p.c2,'#e67e22','#1abc9c'];
    modalChart=new Chart(canvas,{type:'bar',data:{
      labels:top10.map(c=>c.name.length>30?c.name.slice(0,28)+'â€¦':c.name),
      datasets:[{label:'Yillik summa',data:top10.map(c=>sum(c.data)),backgroundColor:cc.slice(0,top10.length),borderRadius:6}]
    },options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>fmt(ctx.parsed.x||0)+" so'm"}}},
      scales:{x:{ticks:{color:p.text,callback:v=>fmt(v)},grid:{color:p.grid}},y:{ticks:{color:p.text,font:{size:10}},grid:{display:false}}},
      interaction:{mode:'index',intersect:false}}});

    /* Table â€” columns with monthly data, clickable for relevant staff */
    let h=bcHtml;
    h+='<div style="font-weight:700;font-size:1.05rem;margin-bottom:.75rem;display:flex;align-items:center;gap:.4rem">ğŸ“ '+key+' <span style="font-size:.82rem;color:var(--text-muted);font-weight:400">â€” '+sortedCols.length+' ta ustun, '+fmt(totalCat)+" so'm</span></div>";
    h+='<table class="data-table"><thead><tr><th>Ustun nomi</th><th class="num">Yillik jami</th><th class="num">Ulushi</th><th class="num">Grafik</th></tr></thead><tbody>';
    let hasClickable=false;
    sortedCols.forEach(c=>{
      const s=sum(c.data), pct=totalCat>0?(s/totalCat*100):0;
      const barW=Math.min(100,Math.max(3,pct));
      const et=colEmpType(c.name);
      if(et) hasClickable=true;
      h+='<tr style="cursor:'+(et?'pointer':'default')+'" '+(et?'onclick="drillModalTo(\'column\',\''+c.name.replace(/'/g,"\\'")+'\')" title="Ustiga bosing â€” xodimlar ro\'yxati"':'')+'>'+
        '<td style="font-weight:600;'+(et?'color:'+p.c1:'')+'">'+c.name+(et?' â†’':'')+'</td>'+
        '<td class="num" style="font-weight:700">'+fmt(s)+'</td>'+
        '<td class="num">'+pct.toFixed(1)+'%</td>'+
        '<td class="num"><div style="background:'+p.c1+'20;border-radius:4px;height:14px;width:100%;max-width:120px"><div style="background:'+p.c1+';border-radius:4px;height:100%;width:'+barW+'%"></div></div></td></tr>';
    });
    h+='</tbody></table>';
    if(hasClickable)
      h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ â†’ belgisi bo\'lgan ustunlarni bosing â€” tegishli xodimlar ko\'rsatiladi</div>';
    tableEl.innerHTML=h;
    return;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LEVEL: column â€” ustun tafsilotlari + xodimlar
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  if(level==='column'){
    const col=(D.expCols||[]).find(c=>c.name===key);
    const yearTotal=col?sum(col.data):0;
    /* Ustun turiga qarab xodimlar ko'rsatiladi yoki yo'q */
    const empType=colEmpType(key);

    /* Stats */
    statsEl.innerHTML=[
      {l:'Ustun nomi',v:key.length>25?key.slice(0,22)+'â€¦':key},
      {l:'Kategoriya',v:col?col.cat:'â€”'},
      {l:'Yillik jami',v:fmt(yearTotal)},
    ].map(s=>'<div class="modal-stat"><div class="modal-stat-label">'+s.l+'</div><div class="modal-stat-value">'+s.v+'</div></div>').join('');

    /* Chart â€” monthly breakdown of this column */
    if(col){
      modalChart=new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[{
        label:key,data:col.data,backgroundColor:col.data.map((v,i)=>{const mx=Math.max(...col.data);return v===mx?p.c1:p.c1+'77'}),
        borderRadius:6}]},options:bOpts({plugins:{legend:{display:false}}})});
    }

    /* Table â€” monthly data */
    let h=bcHtml;
    h+='<div style="font-weight:700;font-size:1.05rem;margin-bottom:.75rem">ğŸ“‹ '+key+'</div>';

    if(col){
      h+='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Summa</th><th class="num">Ulush</th></tr></thead><tbody>';
      months.forEach((m,i)=>{
        const pct=yearTotal>0?(col.data[i]/yearTotal*100):0;
        if(empType){
          h+='<tr style="cursor:pointer" onclick="drillColumnMonth(\''+key.replace(/'/g,"\\'")+'\','+i+')" title="'+m+' â€” xodimlar ro\'yxati"><td style="font-weight:600;color:'+p.c1+'">'+m+' â†’</td><td class="num" style="font-weight:600">'+fmt(col.data[i])+'</td><td class="num">'+pct.toFixed(1)+'%</td></tr>';
        } else {
          h+='<tr><td>'+m+'</td><td class="num" style="font-weight:600">'+fmt(col.data[i])+'</td><td class="num">'+pct.toFixed(1)+'%</td></tr>';
        }
      });
      h+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td><td class="num">'+fmt(yearTotal)+'</td><td class="num">100%</td></tr></tbody></table>';
    }

    if(empType){
      const hint=empType==='staj'?'staj bo\'yicha xodimlar':empType==='tatil'?'ta\'tilga chiqqan xodimlar':'kasallangan xodimlar';
      h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” '+hint+' ko\'rsatiladi</div>';
    }

    tableEl.innerHTML=h;
    return;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LEVEL: month â€” shu oyning kategoriyalar bo'yicha taqsimoti
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  if(level==='month'){
    const mi=parseInt(key);
    const cats=D.expCats||{};
    const xCats=Object.entries(cats).filter(([,v])=>!v.isDaromad).sort((a,b)=>b[1].total[mi]-a[1].total[mi]);
    const dCats=Object.entries(cats).filter(([,v])=>v.isDaromad);
    const monthTotal=xCats.reduce((s,[,c])=>s+c.total[mi],0);
    const monthIncome=dCats.reduce((s,[,c])=>s+c.total[mi],0);

    /* Stats */
    statsEl.innerHTML=[
      {l:'Oy',v:months[mi]},
      {l:'Xarajat',v:fmt(monthTotal)},
      {l:'Daromad',v:fmt(monthIncome)},
    ].map(s=>'<div class="modal-stat"><div class="modal-stat-label">'+s.l+'</div><div class="modal-stat-value">'+s.v+'</div></div>').join('');

    /* Chart â€” category breakdown for this month */
    const cc=[p.c1,p.c3,p.c5,p.c4,p.c7,p.c6,p.c8,p.c2,'#e67e22','#1abc9c','#9b59b6','#34495e'];
    const catData=xCats.filter(([,c])=>c.total[mi]>0);
    modalChart=new Chart(canvas,{type:'doughnut',data:{
      labels:catData.map(([n])=>n.length>25?n.slice(0,22)+'â€¦':n),
      datasets:[{data:catData.map(([,c])=>c.total[mi]),backgroundColor:cc.slice(0,catData.length),borderWidth:2,borderColor:p.cardBg,borderRadius:5}]
    },options:{...bOpts({noScales:true,plugins:{legend:{position:'right',labels:{font:{size:10},padding:6}},tooltip:{callbacks:{label:ctx=>{const pct=(ctx.parsed*100/monthTotal).toFixed(1);return ' '+ctx.label+': '+fmt(ctx.parsed)+' ('+pct+'%)'}}}}}),cutout:'50%'}});

    /* Table â€” categories clickable */
    let h=bcHtml;
    h+='<div style="font-weight:700;font-size:1.05rem;margin-bottom:.75rem">ğŸ“… '+months[mi]+' â€” kategoriyalar bo\'yicha taqsimot</div>';
    h+='<table class="data-table"><thead><tr><th>â„–</th><th>Kategoriya</th><th class="num">Summa</th><th class="num">Ulush</th></tr></thead><tbody>';
    xCats.forEach(([name,cat],i)=>{
      const v=cat.total[mi], pct=monthTotal>0?(v/monthTotal*100):0;
      if(v<=0) return;
      h+='<tr style="cursor:pointer" onclick="drillModalTo(\'category\',\''+name.replace(/'/g,"\\'")+'\')" title="Ustunlarni ko\'rish">'+
        '<td>'+(i+1)+'</td><td style="font-weight:600;color:'+p.c1+'">'+name+'</td>'+
        '<td class="num" style="font-weight:700">'+fmt(v)+'</td><td class="num">'+pct.toFixed(1)+'%</td></tr>';
    });
    /* Daromad */
    if(monthIncome>0){
      h+='<tr style="background:#10B98110"><td></td><td style="font-weight:600;color:#10B981">ğŸ’° Daromad</td><td class="num" style="font-weight:700;color:#10B981">'+fmt(monthIncome)+'</td><td class="num">â€”</td></tr>';
    }
    h+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td>SOF XARAJAT</td><td class="num">'+fmt(monthTotal-monthIncome)+'</td><td class="num">â€”</td></tr>';
    h+='</tbody></table>';
    h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Kategoriya nomini bosing â€” ustunlar ko\'rsatiladi</div>';
    tableEl.innerHTML=h;
    return;
  }
}

/* Drill-down orqaga qaytish */
function drillBack(){
  drillHistory.pop();/* joriy levelni o'chirish */
  if(drillHistory.length>0){
    const prev=drillHistory.pop();/* oldingi levelga qaytish */
    drillModalTo(prev.level,prev.key);
  } else if(drillOriginalType){
    /* Modal boshiga qaytish â€” original KPI ni qayta ochish */
    showKpiDetail(drillOriginalType);
  }
}

/* Accordion ustunini bosish â€” to'g'ridan-to'g'ri modal ochib column drill-ga o'tish */
function openColumnDrill(colName){
  const p=P(), ov=document.getElementById('modalOverlay');
  drillHistory=[];
  drillOriginalType='expTopCat';
  document.getElementById('modalIcon').style.background=p.c1+'22';
  document.getElementById('modalIcon').style.color=p.c1;
  document.getElementById('modalIcon').innerHTML='ğŸ“‹';
  document.getElementById('modalTitle').textContent='Ustun tafsiloti';
  document.getElementById('modalSub').textContent='Oylik taqsimot va xodimlar ro\'yxati';
  document.getElementById('modalStats').innerHTML='';
  document.getElementById('modalTable').innerHTML='';
  if(modalChart){modalChart.destroy();modalChart=null}
  ov.classList.add('show');
  drillModalTo('column',colName);
}

/* Ustun + oy bo'yicha xodimlar drill-down */
/* Ustun turiga qarab qaysi xodimlar ko'rsatilishini aniqlash */
function colEmpType(colName){
  const t=(colName||'').toLowerCase();
  if(t.includes('staj')&&!t.includes('eskirish')) return 'staj';
  if((t.includes('mehnat')&&t.includes('ta'))|| (t.includes("ta'til")&&!t.includes("o'quv")&&!t.includes('oquv'))) return 'tatil';
  if(t.includes('kasallik')||t.includes('layoqatsizlik')||t.includes('nafaqa')||t.includes('bolnich')) return 'kasallik';
  return null;
}

function drillColumnMonth(colName, mi){
  const p=P();
  const col=(D.expCols||[]).find(c=>c.name===colName);
  const monthTotal=col?col.data[mi]:0;
  const empType=colEmpType(colName);

  const tableEl=document.getElementById('modalTable');
  const statsEl=document.getElementById('modalStats');
  const canvas=document.getElementById('modalChart');
  if(modalChart){modalChart.destroy();modalChart=null}

  statsEl.innerHTML=[
    {l:'Ustun',v:colName.length>20?colName.slice(0,18)+'\u2026':colName},
    {l:'Oy',v:months[mi]},
    {l:'Jami summa',v:fmt(monthTotal)},
  ].map(s=>'<div class="modal-stat"><div class="modal-stat-label">'+s.l+'</div><div class="modal-stat-value">'+s.v+'</div></div>').join('');

  const backFn='drillModalTo(\'column\',\''+colName.replace(/'/g,"\\'")+'\')';
  let h='<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap">'+
    '<button onclick="'+backFn+'" style="background:'+p.c1+';color:white;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:.85rem;font-weight:600;display:flex;align-items:center;gap:4px">\u2190 Orqaga</button>'+
    '<div style="font-size:.8rem;color:var(--text-muted)">\uD83D\uDCCB '+colName+' \u2192 \uD83D\uDCC5 '+months[mi]+'</div></div>';

  h+='<div style="font-weight:700;font-size:1.05rem;margin-bottom:.75rem">\uD83D\uDCC5 '+months[mi]+' \u2014 '+colName+'</div>';
  h+='<div style="background:var(--bg-accent);padding:12px 16px;border-radius:10px;margin-bottom:1rem;font-size:.9rem">'+
    '<strong>Jami: </strong>'+fmtF(monthTotal)+' so\'m</div>';

  /* === STAJ: barcha xodimlar staj bilan === */
  if(empType==='staj'){
    const sl=D.staffList||[];
    const sorted=[...sl].sort((a,b)=>b.stajYil-a.stajYil);
    h+='<table class="data-table"><thead><tr><th>\u2116</th><th>F.I.Sh.</th><th>Ish boshlagan</th><th class="num">Staj</th><th>Staj uchun to\'lov %</th></tr></thead><tbody>';
    sorted.forEach((s,i)=>{
      h+='<tr><td style="font-size:.75rem">'+(i+1)+'</td><td style="font-weight:600">'+s.name+'</td><td style="font-size:.82rem">'+s.start+'</td><td class="num" style="font-weight:700;color:'+p.c3+'">'+s.stajYil+' yil</td><td class="num">'+s.pct+'</td></tr>';
    });
    h+='</tbody></table>';

  /* === TA'TIL: faqat shu oyda ta'tilga chiqqan xodimlar === */
  } else if(empType==='tatil'){
    const vl=(D.vacList||[]).filter(v=>{
      if(!v.date) return false;
      /* ISO format: YYYY-MM-DD */
      const iso=v.date.match(/(\d{4})[.\/-](\d{1,2})[.\/-](\d{1,2})/);
      if(iso) return parseInt(iso[2])-1===mi;
      /* DD.MM.YYYY format */
      const dmy=v.date.match(/(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})/);
      if(dmy) return parseInt(dmy[2])-1===mi;
      const mn=["yan","fev","mar","apr","may","iyn","iyul","avg","sen","okt","noy","dek"];
      return v.date.toLowerCase().includes(mn[mi]);
    });
    const freq={};
    vl.forEach(v=>{const n=v.name.trim();if(!freq[n])freq[n]={cnt:0,dept:v.dept,type:v.type,dur:v.dur};freq[n].cnt++});
    const sorted=Object.entries(freq).sort((a,b)=>b[1].cnt-a[1].cnt);
    h+='<div style="font-size:.9rem;margin-bottom:.5rem;color:'+p.c4+'"><strong>'+sorted.length+'</strong> xodim ta\'tilga chiqqan</div>';
    h+='<table class="data-table"><thead><tr><th>\u2116</th><th>F.I.Sh.</th><th>Bo\'lim</th><th>Turi</th><th>Muddati</th><th class="num">Marta</th></tr></thead><tbody>';
    sorted.forEach(([name,info],i)=>{
      h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+name+'</td><td style="font-size:.82rem">'+info.dept+'</td><td style="font-size:.82rem">'+info.type+'</td><td style="font-size:.82rem">'+info.dur+'</td><td class="num" style="font-weight:700;color:'+(info.cnt>1?p.c3:p.text)+'">'+info.cnt+'</td></tr>';
    });
    if(!sorted.length) h+='<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">Bu oyda ta\'tilga chiqqan xodim yo\'q</td></tr>';
    h+='</tbody></table>';

  /* === KASALLIK: faqat shu oyda kasallangan xodimlar === */
  } else if(empType==='kasallik'){
    const sl2=(D.sickList||[]).filter(v=>{
      if(!v.month) return false;
      return mIdx(v.month)===mi;
    });
    const freq={};
    sl2.forEach(v=>{const n=v.name.trim();if(!freq[n])freq[n]={cnt:0,dept:v.dept,period:v.period};freq[n].cnt++});
    const sorted=Object.entries(freq).sort((a,b)=>b[1].cnt-a[1].cnt);
    h+='<div style="font-size:.9rem;margin-bottom:.5rem;color:'+p.c3+'"><strong>'+sorted.length+'</strong> xodim kasallangan</div>';
    h+='<table class="data-table"><thead><tr><th>\u2116</th><th>F.I.Sh.</th><th>Bo\'lim</th><th>Davriyligi</th><th class="num">Marta</th></tr></thead><tbody>';
    sorted.forEach(([name,info],i)=>{
      h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+name+'</td><td style="font-size:.82rem">'+info.dept+'</td><td style="font-size:.82rem">'+info.period+'</td><td class="num" style="font-weight:700;color:'+(info.cnt>1?p.c3:p.text)+'">'+info.cnt+'</td></tr>';
    });
    if(!sorted.length) h+='<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">Bu oyda kasallik varaqasi yo\'q</td></tr>';
    h+='</tbody></table>';
  }

  tableEl.innerHTML=h;
}


/* Escape key closes modal */
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal()});

/* â•â•â• TA'TIL / KASALLIK OY BO'YICHA DRILL â•â•â• */
function drillVacMonth(mi){
  const p=P();
  const vl=(D.vacList||[]).filter(v=>{
    if(!v.date) return false;
    /* ISO format: YYYY-MM-DD */
    const iso=v.date.match(/(\d{4})[.\/-](\d{1,2})[.\/-](\d{1,2})/);
    if(iso) return parseInt(iso[2])-1===mi;
    /* DD.MM.YYYY format */
    const dmy=v.date.match(/(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})/);
    if(dmy) return parseInt(dmy[2])-1===mi;
    /* Fallback: oy nomini tekshirish */
    const mn=['yan','fev','mar','apr','may','iyn','iyul','avg','sen','okt','noy','dek'];
    return v.date.toLowerCase().includes(mn[mi]);
  });

  /* Xodim + necha martaligi */
  const freq={};
  vl.forEach(v=>{const n=v.name.trim();if(!freq[n])freq[n]={cnt:0,dept:v.dept,type:v.type,dur:v.dur};freq[n].cnt++});
  const sorted=Object.entries(freq).sort((a,b)=>b[1].cnt-a[1].cnt);

  const tableEl=document.getElementById('modalTable');
  const statsEl=document.getElementById('modalStats');
  if(modalChart){modalChart.destroy();modalChart=null}

  statsEl.innerHTML=[
    {l:'Oy',v:months[mi]},
    {l:"Ta'tilga chiqilgan",v:D.vacationByMonth[mi]+' ta'},
    {l:'Xodimlar soni',v:sorted.length+' nafar'},
  ].map(s=>'<div class="modal-stat"><div class="modal-stat-label">'+s.l+'</div><div class="modal-stat-value">'+s.v+'</div></div>').join('');

  let h='<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem"><button onclick="showKpiDetail(\'vacJami\')" style="background:'+p.c1+';color:white;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:.85rem;font-weight:600">â† Orqaga</button><span style="font-size:.8rem;color:var(--text-muted)">ğŸ“… '+months[mi]+'</span></div>';
  h+='<div style="font-weight:700;font-size:1.05rem;margin-bottom:.75rem">ğŸ“… '+months[mi]+' â€” ta\'tilga chiqqan xodimlar</div>';
  h+='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.Sh.</th><th>Bo\'lim</th><th>Turi</th><th>Muddati</th><th class="num">Marta</th></tr></thead><tbody>';
  sorted.forEach(([name,info],i)=>{
    h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+name+'</td><td style="font-size:.82rem">'+info.dept+'</td><td style="font-size:.82rem">'+info.type+'</td><td style="font-size:.82rem">'+info.dur+'</td><td class="num" style="font-weight:700;color:'+(info.cnt>1?p.c3:p.text)+'">'+info.cnt+'</td></tr>';
  });
  if(sorted.length===0) h+='<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">Bu oyda ta\'tilga chiqqan xodim yo\'q</td></tr>';
  h+='</tbody></table>';
  tableEl.innerHTML=h;
}

function drillSickMonth(mi){
  const p=P();
  /* Kasallik varaqalari oy bo'yicha filter */
  const sl=(D.sickList||[]).filter(v=>{
    if(!v.month) return false;
    return mIdx(v.month)===mi;
  });

  const freq={};
  sl.forEach(v=>{const n=v.name.trim();if(!freq[n])freq[n]={cnt:0,dept:v.dept,period:v.period};freq[n].cnt++});
  const sorted=Object.entries(freq).sort((a,b)=>b[1].cnt-a[1].cnt);

  const tableEl=document.getElementById('modalTable');
  const statsEl=document.getElementById('modalStats');
  if(modalChart){modalChart.destroy();modalChart=null}

  statsEl.innerHTML=[
    {l:'Oy',v:months[mi]},
    {l:'Kasallik varaqlari',v:D.sickByMonth[mi]+' ta'},
    {l:'Xodimlar soni',v:sorted.length+' nafar'},
  ].map(s=>'<div class="modal-stat"><div class="modal-stat-label">'+s.l+'</div><div class="modal-stat-value">'+s.v+'</div></div>').join('');

  let h='<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem"><button onclick="showKpiDetail(\'sickJami\')" style="background:'+p.c1+';color:white;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:.85rem;font-weight:600">â† Orqaga</button><span style="font-size:.8rem;color:var(--text-muted)">ğŸ“… '+months[mi]+'</span></div>';
  h+='<div style="font-weight:700;font-size:1.05rem;margin-bottom:.75rem">ğŸ“… '+months[mi]+' â€” kasallangan xodimlar</div>';
  h+='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.Sh.</th><th>Bo\'lim</th><th>Davriyligi</th><th class="num">Marta</th></tr></thead><tbody>';
  sorted.forEach(([name,info],i)=>{
    h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+name+'</td><td style="font-size:.82rem">'+info.dept+'</td><td style="font-size:.82rem">'+info.period+'</td><td class="num" style="font-weight:700;color:'+(info.cnt>1?p.c3:p.text)+'">'+info.cnt+'</td></tr>';
  });
  if(sorted.length===0) h+='<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">Bu oyda kasallik varaqasi yo\'q</td></tr>';
  h+='</tbody></table>';
  tableEl.innerHTML=h;
}

/* â•â•â• KVARTAL JADVAL â•â•â• */
function buildQuarterTable(qMonths, qMonthNames, qIdx){
  const p=P();
  const cats=Object.entries(D.expCats||{}).filter(([,v])=>!v.isDaromad).sort((a,b)=>{
    const sa=qMonths.reduce((s,m)=>s+a[1].total[m],0), sb=qMonths.reduce((s,m)=>s+b[1].total[m],0);
    return sb-sa;
  });
  const grandTotal=cats.reduce((s,[,v])=>qMonths.reduce((ss,m)=>ss+v.total[m],s),0);
  let h='<table class="data-table"><thead><tr><th>Kategoriya</th>';
  qMonthNames.forEach(m=>h+='<th class="num">'+m+'</th>');
  h+='<th class="num" style="background:'+p.c1+';color:white">Jami</th></tr></thead><tbody>';
  cats.forEach(([catName,catObj])=>{
    const catTotal=qMonths.reduce((s,m)=>s+catObj.total[m],0);
    if(catTotal===0) return;
    const safeCat=catName.replace(/'/g,"\\'").replace(/"/g,'&quot;');
    h+='<tr style="cursor:pointer" onclick="showKpiDetail(\'kvartal'+qIdx+'\');setTimeout(()=>drillModalTo(\'category\',\''+safeCat+'\'),100)" title="'+catName+' â€” ustunlar">';
    h+='<td style="font-weight:600;color:'+p.c1+'">'+catName+' â†’</td>';
    qMonths.forEach(m=>h+='<td class="num">'+fmt(catObj.total[m])+'</td>');
    h+='<td class="num" style="font-weight:700">'+fmt(catTotal)+'</td></tr>';
  });
  h+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td>';
  qMonths.forEach(m=>{let mt=0;cats.forEach(([,v])=>mt+=v.total[m]);h+='<td class="num">'+fmt(mt)+'</td>'});
  h+='<td class="num">'+fmt(grandTotal)+'</td></tr></tbody></table>';
  h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Kategoriya nomini bosing â€” ustunlar va xodimlar ko\'rsatiladi</div>';
  return h;
}

/* â•â•â• OMBOR OY BO'YICHA DRILL â•â•â• */
function drillOmborMonth(mi, type){
  const p=P();
  const isKirim=(type==='kirim');
  const canvas=document.getElementById('modalChart');
  canvas.parentElement.style.display='';

  let sorted=[], deptTotals={};
  if(isKirim){
    const cl=(D.contractList||[]).filter(c=>c.cat==='ombor'&&new Date(c.date).getUTCMonth()===mi);
    const freq={};
    cl.forEach(c=>{
      const n=c.product||c.type||'Nomalum';
      if(!freq[n]) freq[n]={qty:0,summa:0,provider:c.provider||''};
      freq[n].qty++; freq[n].summa+=c.summa;
      const d=c.provider||'Nomalum';
      deptTotals[d]=(deptTotals[d]||0)+c.summa;
    });
    sorted=Object.entries(freq).sort((a,b)=>b[1].summa-a[1].summa);
  } else {
    const items=(D.omborList||[]).filter(v=>v.month===mi);
    const freq={};
    items.forEach(v=>{
      const n=v.item||'Nomalum';
      if(!freq[n]) freq[n]={qty:0,summa:0,dept:v.dept,items:[]};
      freq[n].qty+=v.qty; freq[n].summa+=v.summa;
      freq[n].items.push(v);
      const d=v.dept||'Nomalum';
      deptTotals[d]=(deptTotals[d]||0)+v.qty;
    });
    sorted=Object.entries(freq).sort((a,b)=>b[1].summa-a[1].summa);
  }

  const tableEl=document.getElementById('modalTable');
  const statsEl=document.getElementById('modalStats');
  if(modalChart){modalChart.destroy();modalChart=null}

  const totalSum=sorted.reduce((s,[,v])=>s+v.summa,0);
  statsEl.innerHTML=[
    {l:'Oy',v:months[mi]},
    {l:isKirim?'Jami kirim':'Jami chiqim',v:fmt(isKirim?D.mahsulotKirim[mi]:D.omborChiqim[mi])},
    {l:isKirim?'Shartnomalar soni':'Mahsulotlar soni',v:sorted.length},
  ].map(s=>'<div class="modal-stat"><div class="modal-stat-label">'+s.l+'</div><div class="modal-stat-value">'+s.v+'</div></div>').join('');

  /* Horizontal bar chart â€” bo'limlar bo'yicha */
  const deptSorted=Object.entries(deptTotals).sort((a,b)=>b[1]-a[1]).slice(0,10);
  if(deptSorted.length>0){
    const dc=[p.c1,p.c3,p.c4,p.c5,p.c6,p.c7,p.c2,p.c8,p.c1+'99',p.c3+'99'];
    modalChart=new Chart(canvas,{type:'bar',data:{labels:deptSorted.map(d=>d[0].length>25?d[0].slice(0,23)+'\u2026':d[0]),datasets:[{
      label:isKirim?'Kirim summasi':'Olingan miqdor',data:deptSorted.map(d=>d[1]),backgroundColor:dc.slice(0,deptSorted.length),borderRadius:6
    }]},options:{...bOpts({plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>isKirim?' '+fmtF(ctx.parsed.x)+" so'm":' '+ctx.parsed.x+' dona'}}}}),indexAxis:'y'}});
  }

  const backModal=isKirim?'omborKirim':'omborChiqim';
  let h='<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem"><button onclick="showKpiDetail(\''+backModal+'\')" style="background:'+p.c1+';color:white;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:.85rem;font-weight:600">\u2190 Orqaga</button><span style="font-size:.8rem;color:var(--text-muted)">\uD83D\uDCC5 '+months[mi]+'</span></div>';
  h+='<div style="font-weight:700;font-size:1.05rem;margin-bottom:.75rem">\uD83D\uDCC5 '+months[mi]+' \u2014 '+(isKirim?'ombor kirimi mahsulotlari':'ombor chiqimi mahsulotlari')+'</div>';

  if(isKirim){
    h+='<table class="data-table"><thead><tr><th>\u2116</th><th>Mahsulot nomi</th><th>Yetkazuvchi</th><th class="num">Soni</th><th class="num">Summasi</th></tr></thead><tbody>';
    sorted.forEach(([name,info],i)=>{
      h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+name+'</td><td style="font-size:.82rem">'+info.provider+'</td><td class="num">'+info.qty+'</td><td class="num" style="font-weight:700">'+fmtF(info.summa)+" so'm</td></tr>";
    });
  } else {
    h+='<table class="data-table"><thead><tr><th>\u2116</th><th>Mahsulot nomi</th><th class="num">Miqdori</th><th class="num">Summasi</th></tr></thead><tbody>';
    sorted.forEach(([name,info],i)=>{
      const safeName=name.replace(/'/g,"\\'").replace(/"/g,'&quot;');
      h+='<tr style="cursor:pointer" onclick="drillOmborProduct(\''+safeName+'\','+mi+')" title="Bo\'limlar tafsiloti"><td>'+(i+1)+'</td><td style="font-weight:600;color:'+p.c1+'">'+name+' \u2192</td><td class="num">'+info.qty+'</td><td class="num" style="font-weight:700">'+fmtF(info.summa)+" so'm</td></tr>";
    });
  }
  if(sorted.length===0) h+='<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">Bu oyda '+(isKirim?'kirim':'chiqim')+' yo\'q</td></tr>';
  h+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td>JAMI</td>'+(isKirim?'<td></td>':'')+'<td></td><td class="num">'+fmtF(totalSum)+" so'm</td></tr>";
  h+='</tbody></table>';
  if(!isKirim&&sorted.length>0) h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">\uD83D\uDCA1 Mahsulot nomini bosing \u2014 qaysi bo\'limlar nechtadan olganini ko\'ring</div>';
  tableEl.innerHTML=h;
}

/* â•â•â• MAHSULOT BO'YICHA BO'LIMLAR DRILL â•â•â• */
function drillOmborProduct(productName, mi){
  const p=P();
  const items=(D.omborList||[]).filter(v=>v.month===mi&&(v.item||'Nomalum')===productName);
  /* Bo'limlar bo'yicha guruhlash */
  const deptFreq={};
  items.forEach(v=>{
    const d=v.dept||'Nomalum';
    if(!deptFreq[d]) deptFreq[d]={qty:0,summa:0};
    deptFreq[d].qty+=v.qty; deptFreq[d].summa+=v.summa;
  });
  const sorted=Object.entries(deptFreq).sort((a,b)=>b[1].qty-a[1].qty);
  const totalQty=sorted.reduce((s,[,v])=>s+v.qty,0);
  const totalSum=sorted.reduce((s,[,v])=>s+v.summa,0);

  const tableEl=document.getElementById('modalTable');
  const statsEl=document.getElementById('modalStats');
  const canvas=document.getElementById('modalChart');
  canvas.parentElement.style.display='';
  if(modalChart){modalChart.destroy();modalChart=null}

  statsEl.innerHTML=[
    {l:'Mahsulot',v:productName.length>20?productName.slice(0,18)+'\u2026':productName},
    {l:'Oy',v:months[mi]},
    {l:'Jami miqdor',v:totalQty+' dona'},
  ].map(s=>'<div class="modal-stat"><div class="modal-stat-label">'+s.l+'</div><div class="modal-stat-value">'+s.v+'</div></div>').join('');

  /* Doughnut chart */
  if(sorted.length>0){
    const dc=[p.c1,p.c3,p.c4,p.c5,p.c6,p.c7,p.c2,p.c8];
    modalChart=new Chart(canvas,{type:'doughnut',data:{labels:sorted.map(d=>d[0].length>25?d[0].slice(0,23)+'\u2026':d[0]),datasets:[{
      data:sorted.map(d=>d[1].qty),backgroundColor:dc.slice(0,sorted.length),borderWidth:2,borderColor:'var(--bg-card)'
    }]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:p.text,padding:8,font:{size:11}}},
      tooltip:{callbacks:{label:ctx=>' '+ctx.parsed+' dona ('+((ctx.parsed/totalQty)*100).toFixed(0)+'%)'}}}}});
  }

  let h='<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem"><button onclick="drillOmborMonth('+mi+',\'chiqim\')" style="background:'+p.c1+';color:white;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:.85rem;font-weight:600">\u2190 Orqaga</button><span style="font-size:.8rem;color:var(--text-muted)">\uD83D\uDCE6 '+productName+'</span></div>';
  h+='<div style="font-weight:700;font-size:1.05rem;margin-bottom:.75rem">\uD83D\uDCE6 '+productName+'</div>';
  h+='<div style="background:var(--bg-accent);padding:12px 16px;border-radius:10px;margin-bottom:1rem;font-size:.9rem"><strong>Jami: </strong>'+totalQty+' dona \u2022 '+fmtF(totalSum)+' so\'m</div>';
  h+='<table class="data-table"><thead><tr><th>\u2116</th><th>Bo\'lim nomi</th><th class="num">Miqdori</th><th class="num">Summasi</th><th class="num">Ulushi</th></tr></thead><tbody>';
  sorted.forEach(([dept,info],i)=>{
    const pct=totalQty>0?((info.qty/totalQty)*100).toFixed(1):'0';
    h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+dept+'</td><td class="num" style="font-weight:700">'+info.qty+' dona</td><td class="num">'+fmtF(info.summa)+' so\'m</td><td class="num">'+pct+'%</td></tr>';
  });
  h+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td>JAMI</td><td class="num">'+totalQty+' dona</td><td class="num">'+fmtF(totalSum)+' so\'m</td><td class="num">100%</td></tr>';
  h+='</tbody></table>';
  tableEl.innerHTML=h;
}

/* â•â•â• STAJ GURUHI BO'YICHA DRILL â•â•â• */
function drillStajGroup(groupName){
  const p=P();
  const sl=D.staffList||[];
  /* Parse group range from name like "16-20 yil", "25+ yil", "0-5 yil" */
  const match=groupName.match(/(\d+)\s*[-â€“]\s*(\d+)/);
  const matchPlus=groupName.match(/(\d+)\+/);
  let filtered=[];
  if(matchPlus){
    const min=parseInt(matchPlus[1]);
    filtered=sl.filter(s=>s.stajYil>=min);
  } else if(match){
    const min=parseInt(match[1]), max=parseInt(match[2]);
    filtered=sl.filter(s=>s.stajYil>=min && s.stajYil<=max);
  } else {
    filtered=sl;
  }
  filtered=[...filtered].sort((a,b)=>b.stajYil-a.stajYil);

  const tableEl=document.getElementById('modalTable');
  const statsEl=document.getElementById('modalStats');
  if(modalChart){modalChart.destroy();modalChart=null}

  statsEl.innerHTML=[
    {l:'Staj guruhi',v:groupName},
    {l:'Xodimlar soni',v:filtered.length+' nafar'},
    {l:'O\'rtacha staj',v:filtered.length>0?(filtered.reduce((s,x)=>s+x.stajYil,0)/filtered.length).toFixed(1)+' yil':'â€”'},
  ].map(s=>'<div class="modal-stat"><div class="modal-stat-label">'+s.l+'</div><div class="modal-stat-value">'+s.v+'</div></div>').join('');

  let h='<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:1rem"><button onclick="showKpiDetail(\'staffAvg\')" style="background:'+p.c1+';color:white;border:none;border-radius:8px;padding:6px 14px;cursor:pointer;font-size:.85rem;font-weight:600">â† Orqaga</button><span style="font-size:.8rem;color:var(--text-muted)">'+groupName+'</span></div>';
  h+='<div style="font-weight:700;font-size:1.05rem;margin-bottom:.75rem">ğŸ‘¥ '+groupName+' â€” xodimlar ro\'yxati</div>';
  h+='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.Sh.</th><th>Ish boshlagan</th><th class="num">Staj (yil)</th><th>Staj uchun to\'lov %</th></tr></thead><tbody>';
  filtered.forEach((s,i)=>{
    h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+s.name+'</td><td>'+s.start+'</td><td class="num" style="font-weight:700;color:'+p.c3+'">'+s.stajYil+'</td><td class="num">'+s.pct+'</td></tr>';
  });
  if(filtered.length===0) h+='<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">Bu guruhda xodim yo\'q</td></tr>';
  h+='</tbody></table>';
  tableEl.innerHTML=h;
}

function showKpiDetail(type){
  if(!D) return;
  drillHistory=[]; /* reset drill-down tarix */
  drillOriginalType=type; /* orqaga qaytish uchun saqlash */
  const p=P(), ov=document.getElementById('modalOverlay');

  /* Define detail configs for each KPI type */
  const configs = {
    ishHaqi: {
      icon:'ğŸ’°', color:p.c1, title:'Ish haqi batafsil tahlili',
      sub:'Hisoblangan ish haqi oylar bo\'yicha',
      data: D.ishHaqi,
      chartType:'bar',
      stats:()=>{
        const mx=Math.max(...D.ishHaqi), mi=Math.min(...D.ishHaqi.filter(v=>v>0));
        const mxI=D.ishHaqi.indexOf(mx), miI=D.ishHaqi.indexOf(mi);
        return [
          {l:'Jami yillik',v:fmt(sum(D.ishHaqi))},
          {l:'Eng yuqori oy',v:months[mxI]+' ('+fmt(mx)+')'},
          {l:'Eng past oy',v:months[miI]+' ('+fmt(mi)+')'},
        ];
      },
      extra:()=>[
        {label:'Ustama ish haqi', data:D.ustama, color:p.c2},
        {label:'Staj to\'lovi', data:D.staj, color:p.c4},
      ],
    },
    bayram: {
      icon:'ğŸ‰', color:p.c3, title:'Bayram mukofoti batafsil',
      sub:'Bayram mukofotlari to\'langan oylar va miqdorlar',
      data: D.bayramMukofot,
      chartType:'bar',
      stats:()=>{
        const paid=D.bayramMukofot.filter(v=>v>0);
        const paidMonths=D.bayramMukofot.map((v,i)=>v>0?months[i]:null).filter(Boolean);
        return [
          {l:'Jami mukofot',v:fmt(sum(D.bayramMukofot))},
          {l:'To\'langan oylar',v:paidMonths.join(', ')||'â€”'},
          {l:'O\'rtacha (to\'langan)',v:paid.length?fmt(sum(paid)/paid.length):'â€”'},
        ];
      },
      extra:()=>[],
    },
    elektr: {
      icon:'âš¡', color:p.c5, title:'Elektr energiya va kommunal xarajatlar',
      sub:'Elektr va tabiiy gaz xarajatlari oyma-oy',
      data: D.elektr,
      chartType:'line',
      stats:()=>{
        const mx=Math.max(...D.elektr), mi=Math.min(...D.elektr.filter(v=>v>0));
        return [
          {l:'Jami elektr',v:fmt(sum(D.elektr))},
          {l:'Jami gaz',v:fmt(sum(D.gaz))},
          {l:'Eng qimmat oy',v:months[D.elektr.indexOf(mx)]},
        ];
      },
      extra:()=>[
        {label:'Tabiiy gaz', data:D.gaz, color:p.c3},
      ],
    },
    daromad: {
      icon:'ğŸ¦', color:p.c4, title:'Daromadlar batafsil tahlili',
      sub:'Debet aylanma va bankomat daromadlari',
      data: D.debetDaromad,
      chartType:'line',
      stats:()=>{
        const td=sum(D.debetDaromad), tb=sum(D.bankomatDaromad);
        return [
          {l:'Debet daromad',v:fmt(td)},
          {l:'Bankomat daromad',v:fmt(tb)},
          {l:'Jami',v:fmt(td+tb)},
        ];
      },
      extra:()=>[
        {label:'Bankomat daromadi', data:D.bankomatDaromad, color:p.c5},
      ],
    },
    tatil: {
      icon:'ğŸ–ï¸', color:p.c7, title:'Ta\'til batafsil tahlili',
      sub:'Oylar bo\'yicha ta\'tilga chiqqanlar va xarajatlar',
      customList:true,
      stats:()=>{
        const mx=Math.max(...D.vacationByMonth), mi=Math.min(...D.vacationByMonth);
        const mxI=D.vacationByMonth.indexOf(mx), miI=D.vacationByMonth.indexOf(mi);
        /* Nechta unique xodim */
        const uniqueNames=new Set((D.vacList||[]).map(v=>v.name.trim().toLowerCase()));
        return [
          {l:'Jami ta\'tilga chiqilgan',v:sum(D.vacationByMonth)+' ta'},
          {l:'Ta\'tilga chiqqan xodimlar',v:uniqueNames.size+' nafar'},
          {l:'Eng ko\'p oy',v:months[mxI]+' ('+mx+' ta)'},
        ];
      },
      buildTable:()=>{
        const vl=D.vacList||[];
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Ta\'til</th><th class="num">Mehnat ta\'tili xarajati</th></tr></thead><tbody>';
        months.forEach((m,i)=>{
          const cnt=D.vacationByMonth[i];
          h+='<tr style="cursor:pointer" onclick="drillVacMonth('+i+')" title="'+m+' â€” xodimlar ro\'yxati"><td style="font-weight:600;color:'+p.c1+'">'+m+' â†’</td><td class="num" style="font-weight:700">'+cnt+' ta</td><td class="num">'+fmtF(D.mehnatTatil[i])+" so'm</td></tr>";
        });
        const tv=sum(D.vacationByMonth);
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td><td class="num">'+tv+' ta</td><td class="num">'+fmtF(sum(D.mehnatTatil))+" so'm</td></tr>";
        h+='</tbody></table>';
        /* Ko'p marta chiqqanlar */
        const freq={};
        vl.forEach(v=>{const n=v.name.trim();freq[n]=(freq[n]||0)+1});
        const multi=Object.entries(freq).filter(([,c])=>c>1).sort((a,b)=>b[1]-a[1]);
        if(multi.length>0){
          h+='<div style="font-weight:700;font-size:1rem;margin:1.25rem 0 .75rem">ğŸ”„ Ko\'p marta ta\'tilga chiqqanlar</div>';
          h+='<table class="data-table"><thead><tr><th>F.I.Sh.</th><th class="num">Necha marta</th></tr></thead><tbody>';
          multi.forEach(([n,c])=>{h+='<tr><td style="font-weight:600">'+n+'</td><td class="num" style="font-weight:700;color:'+p.c3+'">'+c+' marta</td></tr>'});
          h+='</tbody></table>';
        }
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” shu oydagi xodimlar ro\'yxati ko\'rsatiladi</div>';
        return h;
      },
      buildChart:(canvas)=>{
        return new Chart(canvas,{type:'line',data:{labels:MS,datasets:[
          {label:"Ta'tilga chiqishlar soni",data:D.vacationByMonth,borderColor:p.c5,backgroundColor:p.c5+'20',fill:true,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c5,yAxisID:'y'},
          {label:"Mehnat ta'tili xarajati",data:D.mehnatTatil,borderColor:p.c1,backgroundColor:p.c1+'20',fill:false,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c1,yAxisID:'y1'},
        ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:p.text,usePointStyle:true,padding:12}},tooltip:{callbacks:{label:ctx=>ctx.datasetIndex===0?' '+ctx.parsed.y+' ta':' '+fmtF(ctx.parsed.y)+" so'm"}}},
          scales:{y:{position:'left',ticks:{color:p.text,callback:v=>v+' ta'},grid:{color:p.grid}},y1:{position:'right',ticks:{color:p.c1,callback:v=>fmt(v)},grid:{display:false}},x:{ticks:{color:p.text},grid:{color:p.grid,lineWidth:.5}}}}});
      },
    },
    kasallik: {
      icon:'ğŸ¥', color:p.c8, title:'Tibbiy ta\'til batafsil tahlili',
      sub:'Kasallik varaqlari va nafaqa xarajatlari',
      customList:true,
      stats:()=>{
        const mx=Math.max(...D.sickByMonth);
        const mxI=D.sickByMonth.indexOf(mx);
        const uniqueNames=new Set((D.sickList||[]).map(v=>v.name.trim().toLowerCase()));
        return [
          {l:'Jami kasallik varaqlari',v:sum(D.sickByMonth)+' ta'},
          {l:'Kasallangan xodimlar',v:uniqueNames.size+' nafar'},
          {l:'Jami nafaqa xarajati',v:fmt(sum(D.bolnichny))},
        ];
      },
      buildTable:()=>{
        const sl=D.sickList||[];
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Kasallik varaqlari</th><th class="num">Nafaqa xarajati</th></tr></thead><tbody>';
        months.forEach((m,i)=>{
          const cnt=D.sickByMonth[i];
          h+='<tr style="cursor:pointer" onclick="drillSickMonth('+i+')" title="'+m+' â€” xodimlar ro\'yxati"><td style="font-weight:600;color:'+p.c1+'">'+m+' â†’</td><td class="num" style="font-weight:700">'+cnt+' ta</td><td class="num">'+fmtF(D.bolnichny[i])+" so'm</td></tr>";
        });
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td><td class="num">'+sum(D.sickByMonth)+' ta</td><td class="num">'+fmtF(sum(D.bolnichny))+" so'm</td></tr>";
        h+='</tbody></table>';
        /* Ko'p marta kasallangan */
        const freq={};
        sl.forEach(v=>{const n=v.name.trim();freq[n]=(freq[n]||0)+1});
        const multi=Object.entries(freq).filter(([,c])=>c>1).sort((a,b)=>b[1]-a[1]);
        if(multi.length>0){
          h+='<div style="font-weight:700;font-size:1rem;margin:1.25rem 0 .75rem">ğŸ”„ Ko\'p marta kasallangan xodimlar</div>';
          h+='<table class="data-table"><thead><tr><th>F.I.Sh.</th><th class="num">Necha marta</th></tr></thead><tbody>';
          multi.forEach(([n,c])=>{h+='<tr><td style="font-weight:600">'+n+'</td><td class="num" style="font-weight:700;color:'+p.c3+'">'+c+' marta</td></tr>'});
          h+='</tbody></table>';
        }
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” shu oydagi xodimlar ro\'yxati ko\'rsatiladi</div>';
        return h;
      },
      buildChart:(canvas)=>{
        return new Chart(canvas,{type:'line',data:{labels:MS,datasets:[
          {label:'Kasallik varaqasi soni',data:D.sickByMonth,borderColor:p.c3,backgroundColor:p.c3+'20',fill:true,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c3,yAxisID:'y'},
          {label:'Kasallik nafaqasi',data:D.bolnichny,borderColor:p.c1,backgroundColor:p.c1+'20',fill:false,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c1,yAxisID:'y1'},
        ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:p.text,usePointStyle:true,padding:12}},tooltip:{callbacks:{label:ctx=>ctx.datasetIndex===0?' '+ctx.parsed.y+' ta':' '+fmtF(ctx.parsed.y)+" so'm"}}},
          scales:{y:{position:'left',ticks:{color:p.text,callback:v=>v+' ta'},grid:{color:p.grid}},y1:{position:'right',ticks:{color:p.c1,callback:v=>fmt(v)},grid:{display:false}},x:{ticks:{color:p.text},grid:{color:p.grid,lineWidth:.5}}}}});
      },
    },
    /* â•â•â• WAREHOUSE KPIs â•â•â• */
    /* â•â•â• QUARTERLY KPIs â•â•â• */
    kvartal0: { icon:'ğŸ“Š', color:p.c1, title:'I-Kvartal batafsil', sub:'Yanvar â€” Mart: kategoriyalar, ustunlar va xodimlar', customList:true,
      stats:()=>{ const qm=[0,1,2]; const t=qm.reduce((s,m)=>{ let mt=0;(D.expCols||[]).forEach(c=>{if(!c.isDaromad)mt+=c.data[m]});return s+mt},0);
        return [{l:'Jami xarajat',v:fmt(t)},{l:'Oylar',v:'Yanvar, Fevral, Mart'},{l:'Kategoriyalar',v:Object.keys(D.expCats||{}).length}]; },
      buildChart:(canvas)=>{ const cats=Object.entries(D.expCats||{}).filter(([,v])=>!v.isDaromad); const ds=cats.slice(0,6).map(([k,v],i)=>({label:k,data:[0,1,2].map(m=>v.total[m]),backgroundColor:[p.c1,p.c4,p.c5,p.c3,p.c6,p.c7][i],borderRadius:4}));
        return new Chart(canvas,{type:'bar',data:{labels:['Yan','Fev','Mar'],datasets:ds},options:bOpts({plugins:{legend:{labels:{font:{size:9}}}}})}); },
      buildTable:()=>buildQuarterTable([0,1,2],['Yanvar','Fevral','Mart'],0), },
    kvartal1: { icon:'ğŸ“Š', color:p.c5, title:'II-Kvartal batafsil', sub:'Aprel â€” Iyun: kategoriyalar, ustunlar va xodimlar', customList:true,
      stats:()=>{ const qm=[3,4,5]; const t=qm.reduce((s,m)=>{ let mt=0;(D.expCols||[]).forEach(c=>{if(!c.isDaromad)mt+=c.data[m]});return s+mt},0);
        return [{l:'Jami xarajat',v:fmt(t)},{l:'Oylar',v:'Aprel, May, Iyun'},{l:'Kategoriyalar',v:Object.keys(D.expCats||{}).length}]; },
      buildChart:(canvas)=>{ const cats=Object.entries(D.expCats||{}).filter(([,v])=>!v.isDaromad); const ds=cats.slice(0,6).map(([k,v],i)=>({label:k,data:[3,4,5].map(m=>v.total[m]),backgroundColor:[p.c1,p.c4,p.c5,p.c3,p.c6,p.c7][i],borderRadius:4}));
        return new Chart(canvas,{type:'bar',data:{labels:['Apr','May','Iyn'],datasets:ds},options:bOpts({plugins:{legend:{labels:{font:{size:9}}}}})}); },
      buildTable:()=>buildQuarterTable([3,4,5],['Aprel','May','Iyun'],1), },
    kvartal2: { icon:'ğŸ“Š', color:p.c4, title:'III-Kvartal batafsil', sub:'Iyul â€” Sentyabr: kategoriyalar, ustunlar va xodimlar', customList:true,
      stats:()=>{ const qm=[6,7,8]; const t=qm.reduce((s,m)=>{ let mt=0;(D.expCols||[]).forEach(c=>{if(!c.isDaromad)mt+=c.data[m]});return s+mt},0);
        return [{l:'Jami xarajat',v:fmt(t)},{l:'Oylar',v:'Iyul, Avgust, Sentyabr'},{l:'Kategoriyalar',v:Object.keys(D.expCats||{}).length}]; },
      buildChart:(canvas)=>{ const cats=Object.entries(D.expCats||{}).filter(([,v])=>!v.isDaromad); const ds=cats.slice(0,6).map(([k,v],i)=>({label:k,data:[6,7,8].map(m=>v.total[m]),backgroundColor:[p.c1,p.c4,p.c5,p.c3,p.c6,p.c7][i],borderRadius:4}));
        return new Chart(canvas,{type:'bar',data:{labels:['Iyl','Avg','Sen'],datasets:ds},options:bOpts({plugins:{legend:{labels:{font:{size:9}}}}})}); },
      buildTable:()=>buildQuarterTable([6,7,8],['Iyul','Avgust','Sentyabr'],2), },
    kvartal3: { icon:'ğŸ“Š', color:p.c3, title:'IV-Kvartal batafsil', sub:'Oktyabr â€” Dekabr: kategoriyalar, ustunlar va xodimlar', customList:true,
      stats:()=>{ const qm=[9,10,11]; const t=qm.reduce((s,m)=>{ let mt=0;(D.expCols||[]).forEach(c=>{if(!c.isDaromad)mt+=c.data[m]});return s+mt},0);
        return [{l:'Jami xarajat',v:fmt(t)},{l:'Oylar',v:'Oktyabr, Noyabr, Dekabr'},{l:'Kategoriyalar',v:Object.keys(D.expCats||{}).length}]; },
      buildChart:(canvas)=>{ const cats=Object.entries(D.expCats||{}).filter(([,v])=>!v.isDaromad); const ds=cats.slice(0,6).map(([k,v],i)=>({label:k,data:[9,10,11].map(m=>v.total[m]),backgroundColor:[p.c1,p.c4,p.c5,p.c3,p.c6,p.c7][i],borderRadius:4}));
        return new Chart(canvas,{type:'bar',data:{labels:['Okt','Noy','Dek'],datasets:ds},options:bOpts({plugins:{legend:{labels:{font:{size:9}}}}})}); },
      buildTable:()=>buildQuarterTable([9,10,11],['Oktyabr','Noyabr','Dekabr'],3), },
    /* â•â•â• WAREHOUSE KPIs â•â•â• */
    omborKirim: {
      icon:'ğŸ“¥', color:p.c5, title:'Mahsulot kirimi (faqat ombor shartnomalar)',
      sub:'Oylar bo\'yicha xarid qilingan tovarlar kirim summasi â€” oyni bosing',
      customList:true,
      stats:()=>{
        const mx=Math.max(...D.mahsulotKirim), mxI=D.mahsulotKirim.indexOf(mx);
        return [
          {l:'Jami mahsulot kirimi',v:fmt(sum(D.mahsulotKirim))},
          {l:'Eng katta kirim oyi',v:months[mxI]+' ('+fmt(mx)+')'},
          {l:'Faol oylar',v:D.mahsulotKirim.filter(v=>v>0).length+' oy'},
        ];
      },
      buildChart:(canvas)=>{
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[
          {label:'Mahsulot kirimi',data:D.mahsulotKirim,backgroundColor:p.c5,borderRadius:6},
          {label:'Ombor chiqimi',data:D.omborChiqim,backgroundColor:p.c3+'88',borderRadius:6},
        ]},options:bOpts()});
      },
      buildTable:()=>{
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Kirim</th><th class="num">Chiqim</th></tr></thead><tbody>';
        months.forEach((m,i)=>{h+='<tr style="cursor:pointer" onclick="drillOmborMonth('+i+',\'kirim\')" title="'+m+' â€” kirim mahsulotlari"><td style="font-weight:600;color:'+p.c1+'">'+m+' â†’</td><td class="num">'+fmt(D.mahsulotKirim[i])+'</td><td class="num">'+fmt(D.omborChiqim[i])+'</td></tr>'});
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td><td class="num">'+fmt(sum(D.mahsulotKirim))+'</td><td class="num">'+fmt(sum(D.omborChiqim))+'</td></tr></tbody></table>';
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” mahsulotlar ro\'yxati ko\'rsatiladi</div>';
        return h;
      },
    },
    omborChiqim: {
      icon:'ğŸ“¤', color:p.c3, title:'Ombor chiqimi batafsil',
      sub:'Oylar bo\'yicha ombor chiqimi â€” oyni bosing mahsulotlarni ko\'rish uchun',
      customList:true,
      stats:()=>{
        const mx=Math.max(...D.omborChiqim), mxI=D.omborChiqim.indexOf(mx);
        return [
          {l:'Jami chiqim',v:fmt(sum(D.omborChiqim))},
          {l:'O\'rtacha oylik',v:fmt(sum(D.omborChiqim)/12)},
          {l:'Eng katta oy',v:months[mxI]+' ('+fmt(mx)+')'},
        ];
      },
      buildChart:(canvas)=>{
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[{label:'Ombor chiqimi',data:D.omborChiqim,backgroundColor:D.omborChiqim.map(v=>v>50000000?p.c3:p.c1),borderRadius:6}]},options:bOpts({plugins:{legend:{display:false}}})});
      },
      buildTable:()=>{
        const depts=Object.entries(D.omborDept);
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Chiqim summasi</th><th class="num">Ulush</th></tr></thead><tbody>';
        const total=sum(D.omborChiqim);
        months.forEach((m,i)=>{
          const pct=total>0?(D.omborChiqim[i]/total*100).toFixed(1):'0';
          h+='<tr style="cursor:pointer" onclick="drillOmborMonth('+i+',\'chiqim\')" title="'+m+' â€” mahsulotlar"><td style="font-weight:600;color:'+p.c1+'">'+m+' â†’</td><td class="num" style="font-weight:600">'+fmt(D.omborChiqim[i])+'</td><td class="num">'+pct+'%</td></tr>';
        });
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td><td class="num">'+fmt(total)+'</td><td class="num">100%</td></tr></tbody></table>';
        /* Bo'limlar */
        if(depts.length>0){
          const dt=depts.reduce((s,[,v])=>s+v,0);
          h+='<div style="font-weight:700;font-size:1rem;margin:1.25rem 0 .75rem">ğŸ¢ Bo\'limlar bo\'yicha chiqim</div>';
          h+='<table class="data-table"><thead><tr><th>Bo\'lim</th><th class="num">Summa</th><th class="num">Ulush</th></tr></thead><tbody>';
          depts.forEach(([k,v])=>{h+='<tr><td style="font-weight:600">'+k+'</td><td class="num">'+fmt(v)+'</td><td class="num">'+(v/dt*100).toFixed(1)+'%</td></tr>'});
          h+='</tbody></table>';
        }
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” mahsulotlar ro\'yxati ko\'rsatiladi</div>';
        return h;
      },
    },
    omborMaxOy: {
      icon:'ğŸ“Š', color:p.c4, title:'Eng katta chiqim oyi â€” batafsil',
      sub:'Qaysi oylarda ombor chiqimi kutilganidan yuqori? Oyni bosing â€” mahsulotlar',
      customList:true,
      stats:()=>{
        const mx=Math.max(...D.omborChiqim), mxI=D.omborChiqim.indexOf(mx);
        const avg=sum(D.omborChiqim)/12;
        return [
          {l:'Eng katta oy',v:months[mxI]+' â€” '+fmt(mx)},
          {l:'O\'rtacha oylik',v:fmt(avg)},
          {l:'Jami chiqim',v:fmt(sum(D.omborChiqim))},
        ];
      },
      buildChart:(canvas)=>{
        const avg=sum(D.omborChiqim)/D.omborChiqim.filter(v=>v>0).length||1;
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[
          {label:'Ombor chiqimi',data:D.omborChiqim,backgroundColor:D.omborChiqim.map(v=>v>avg*1.5?p.c3:p.c4),borderRadius:6},
          {label:'O\'rtacha',data:new Array(12).fill(avg),type:'line',borderColor:p.c7,borderWidth:2,borderDash:[8,4],pointRadius:0,fill:false},
        ]},options:bOpts()});
      },
      buildTable:()=>{
        const avg=sum(D.omborChiqim)/12;
        let sorted=months.map((m,i)=>({name:m,val:D.omborChiqim[i],idx:i})).sort((a,b)=>b.val-a.val);
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Chiqim</th><th class="num">O\'rtachaga nisbat</th></tr></thead><tbody>';
        sorted.forEach(r=>{
          const ratio=avg>0?(r.val/avg*100).toFixed(0):'0';
          const isHigh=r.val>avg*1.5;
          h+='<tr style="cursor:pointer'+(isHigh?';background:'+p.c3+'11':'')+'" onclick="drillOmborMonth('+r.idx+',\'chiqim\')" title="'+r.name+' â€” mahsulotlar"><td style="font-weight:600;color:'+p.c1+'">'+r.name+' â†’</td><td class="num" style="font-weight:600'+(isHigh?';color:'+p.c3:'')+'">'+fmt(r.val)+'</td><td class="num">'+ratio+'%</td></tr>';
        });
        h+='</tbody></table>';
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” mahsulotlar ko\'rsatiladi</div>';
        return h;
      },
    },
    omborBolim: {
      icon:'ğŸ“‹', color:p.c1, title:'Bo\'limlar bo\'yicha ombor chiqimi',
      sub:'Har bir bo\'lim qancha resurs sarflagan?',
      data: D.omborChiqim,
      chartType:'bar',
      stats:()=>{
        const depts=Object.entries(D.omborDept);
        const topDept=depts.length?depts[0]:['â€”',0];
        return [
          {l:'Bo\'limlar soni',v:depts.length},
          {l:'Eng ko\'p sarflovchi',v:topDept[0]},
          {l:'Eng ko\'p sarflagan summa',v:fmt(topDept[1])},
        ];
      },
      extra:()=>[],
      deptChart:true,
    },
    /* â•â•â• VACATION KPIs â•â•â• */
    vacJami: {
      icon:'ğŸ–ï¸', color:p.c5, title:'Ta\'tilga chiqqanlar â€” umumiy tahlil',
      sub:'Oyni bosing â†’ xodimlar ro\'yxati ko\'rsatiladi',
      customList:true,
      stats:()=>{
        const vtL=Object.entries(D.vacTypes);
        const uniqueNames=new Set((D.vacList||[]).map(v=>v.name.trim().toLowerCase()));
        return [
          {l:'Jami ta\'tilga chiqishlar soni',v:sum(D.vacationByMonth)+' ta'},
          {l:'Ta\'tilga chiqqan xodimlar',v:uniqueNames.size+' nafar'},
          {l:'Ta\'til turlari',v:vtL.map(([k,v])=>k+' ('+v+')').join(', ')||'â€”'},
        ];
      },
      buildChart:(canvas)=>{
        return new Chart(canvas,{type:'line',data:{labels:MS,datasets:[
          {label:'Ta\'tilga chiqishlar soni',data:D.vacationByMonth,borderColor:p.c5,backgroundColor:p.c5+'20',fill:true,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c5,yAxisID:'y'},
          {label:'Mehnat ta\'tili xarajati',data:D.mehnatTatil,borderColor:p.c1,backgroundColor:p.c1+'20',fill:false,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c1,yAxisID:'y1'},
        ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:p.text,usePointStyle:true,padding:12}},tooltip:{callbacks:{label:ctx=>ctx.datasetIndex===0?' '+ctx.parsed.y+' ta':' '+fmtF(ctx.parsed.y)+" so'm"}}},
          scales:{y:{position:'left',ticks:{color:p.text,callback:v=>v+' ta'},grid:{color:p.grid}},y1:{position:'right',ticks:{color:p.c1,callback:v=>fmt(v)},grid:{display:false}},x:{ticks:{color:p.text},grid:{color:p.grid,lineWidth:.5}}}}});
      },
      buildTable:()=>{
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Ta\'tilga chiqishlar soni</th><th class="num">Mehnat ta\'tili xarajati</th></tr></thead><tbody>';
        months.forEach((m,i)=>{
          h+='<tr style="cursor:pointer" onclick="drillVacMonth('+i+')" title="'+m+' â€” xodimlar"><td style="font-weight:600;color:'+p.c1+'">'+m+' â†’</td><td class="num" style="font-weight:700">'+D.vacationByMonth[i]+' ta</td><td class="num">'+fmtF(D.mehnatTatil[i])+" so'm</td></tr>";
        });
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td><td class="num">'+sum(D.vacationByMonth)+' ta</td><td class="num">'+fmtF(sum(D.mehnatTatil))+" so'm</td></tr></tbody></table>";
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” shu oydagi xodimlar ro\'yxati ko\'rsatiladi</div>';
        return h;
      },
    },
    vacMax: {
      icon:'ğŸ“ˆ', color:p.c3, title:'Eng ko\'p ta\'tilga chiqqan oy',
      sub:'Oyni bosing â†’ xodimlar ro\'yxati',
      customList:true,
      stats:()=>{
        const mx=Math.max(...D.vacationByMonth), mxI=D.vacationByMonth.indexOf(mx);
        return [
          {l:'Eng ko\'p',v:months[mxI]+' â€” '+mx+' ta'},
          {l:'O\'rtacha oylik',v:(sum(D.vacationByMonth)/12).toFixed(1)+' ta'},
          {l:'Shu oy xarajati',v:fmt(D.mehnatTatil[mxI])},
        ];
      },
      buildChart:(canvas)=>{
        const mx=Math.max(...D.vacationByMonth);
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[
          {label:'Ta\'tilga chiqqan',data:D.vacationByMonth,backgroundColor:D.vacationByMonth.map(v=>v===mx?p.c3:p.c5),borderRadius:8},
        ]},options:bOpts({plugins:{legend:{display:false}}})});
      },
      buildTable:()=>{
        const sorted=months.map((m,i)=>({m,i,v:D.vacationByMonth[i]})).sort((a,b)=>b.v-a.v);
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Ta\'til</th><th class="num">Xarajat</th></tr></thead><tbody>';
        sorted.forEach(r=>{
          h+='<tr style="cursor:pointer" onclick="drillVacMonth('+r.i+')" title="'+r.m+' â€” xodimlar"><td style="font-weight:600;color:'+p.c1+'">'+r.m+' â†’</td><td class="num" style="font-weight:700">'+r.v+' ta</td><td class="num">'+fmtF(D.mehnatTatil[r.i])+" so'm</td></tr>";
        });
        h+='</tbody></table>';
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” xodimlar ro\'yxati</div>';
        return h;
      },
    },
    vacMin: {
      icon:'ğŸ“‰', color:p.c4, title:'Eng kam ta\'tilga chiqqan oy',
      sub:'Oyni bosing â†’ xodimlar ro\'yxati',
      customList:true,
      stats:()=>{
        const mi=Math.min(...D.vacationByMonth), miI=D.vacationByMonth.indexOf(mi);
        return [
          {l:'Eng kam',v:months[miI]+' â€” '+mi+' ta'},
          {l:'O\'rtacha oylik',v:(sum(D.vacationByMonth)/12).toFixed(1)+' ta'},
          {l:'Shu oy xarajati',v:fmt(D.mehnatTatil[miI])},
        ];
      },
      buildChart:(canvas)=>{
        const mn=Math.min(...D.vacationByMonth);
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[
          {label:'Ta\'tilga chiqqan',data:D.vacationByMonth,backgroundColor:D.vacationByMonth.map(v=>v===mn?p.c4:p.c5),borderRadius:8},
        ]},options:bOpts({plugins:{legend:{display:false}}})});
      },
      buildTable:()=>{
        const sorted=months.map((m,i)=>({m,i,v:D.vacationByMonth[i]})).sort((a,b)=>a.v-b.v);
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Ta\'til</th><th class="num">Xarajat</th></tr></thead><tbody>';
        sorted.forEach(r=>{
          h+='<tr style="cursor:pointer" onclick="drillVacMonth('+r.i+')" title="'+r.m+' â€” xodimlar"><td style="font-weight:600;color:'+p.c1+'">'+r.m+' â†’</td><td class="num" style="font-weight:700">'+r.v+' ta</td><td class="num">'+fmtF(D.mehnatTatil[r.i])+" so'm</td></tr>";
        });
        h+='</tbody></table>';
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” xodimlar ro\'yxati</div>';
        return h;
      },
    },
    vacCost: {
      icon:'ğŸ’°', color:p.c1, title:'Ta\'til xarajatlari batafsil',
      sub:'Oyni bosing â†’ xodimlar ro\'yxati',
      customList:true,
      stats:()=>{
        const mx=Math.max(...D.mehnatTatil), mxI=D.mehnatTatil.indexOf(mx);
        return [
          {l:'Jami xarajat',v:fmt(sum(D.mehnatTatil))},
          {l:'Eng qimmat oy',v:months[mxI]+' ('+fmt(mx)+')'},
          {l:'O\'rtacha oylik',v:fmt(sum(D.mehnatTatil)/12)},
        ];
      },
      buildChart:(canvas)=>{
        return new Chart(canvas,{type:'line',data:{labels:MS,datasets:[
          {label:'Mehnat ta\'tili',data:D.mehnatTatil,borderColor:p.c1,backgroundColor:p.c1+'20',fill:true,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c1},
          {label:'O\'quv ta\'tili',data:D.oquvTatil,borderColor:p.c4,backgroundColor:p.c4+'20',fill:false,tension:.4,pointRadius:4,borderWidth:2,borderDash:[5,3],pointBackgroundColor:p.c4},
        ]},options:bOpts()});
      },
      buildTable:()=>{
        const sorted=months.map((m,i)=>({m,i,v:D.mehnatTatil[i],cnt:D.vacationByMonth[i]})).sort((a,b)=>b.v-a.v);
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Ta\'til</th><th class="num">Xarajat</th></tr></thead><tbody>';
        sorted.forEach(r=>{
          h+='<tr style="cursor:pointer" onclick="drillVacMonth('+r.i+')" title="'+r.m+' â€” xodimlar"><td style="font-weight:600;color:'+p.c1+'">'+r.m+' â†’</td><td class="num">'+r.cnt+' ta</td><td class="num" style="font-weight:700">'+fmtF(r.v)+" so'm</td></tr>";
        });
        h+='</tbody></table>';
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” xodimlar ro\'yxati</div>';
        return h;
      },
    },
    /* â•â•â• SICK LEAVE KPIs â•â•â• */
    sickJami: {
      icon:'ğŸ¥', color:p.c3, title:'Kasallik varaqlari â€” umumiy tahlil',
      sub:'Oyni bosing â†’ kasallangan xodimlar ro\'yxati',
      customList:true,
      stats:()=>{
        const mx=Math.max(...D.sickByMonth), mxI=D.sickByMonth.indexOf(mx);
        const uniqueNames=new Set((D.sickList||[]).map(v=>v.name.trim().toLowerCase()));
        return [
          {l:'Jami kasallik varaqasi soni',v:sum(D.sickByMonth)+' ta'},
          {l:'Kasallangan xodimlar',v:uniqueNames.size+' nafar'},
          {l:'Jami nafaqa',v:fmt(sum(D.bolnichny))},
        ];
      },
      buildChart:(canvas)=>{
        return new Chart(canvas,{type:'line',data:{labels:MS,datasets:[
          {label:'Kasallik varaqasi soni',data:D.sickByMonth,borderColor:p.c3,backgroundColor:p.c3+'20',fill:true,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c3,yAxisID:'y'},
          {label:'Kasallik nafaqasi',data:D.bolnichny,borderColor:p.c1,backgroundColor:p.c1+'20',fill:false,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c1,yAxisID:'y1'},
        ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:p.text,usePointStyle:true,padding:12}},tooltip:{callbacks:{label:ctx=>ctx.datasetIndex===0?' '+ctx.parsed.y+' ta':' '+fmtF(ctx.parsed.y)+" so'm"}}},
          scales:{y:{position:'left',ticks:{color:p.text,callback:v=>v+' ta'},grid:{color:p.grid}},y1:{position:'right',ticks:{color:p.c1,callback:v=>fmt(v)},grid:{display:false}},x:{ticks:{color:p.text},grid:{color:p.grid,lineWidth:.5}}}}});
      },
      buildTable:()=>{
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Kasallik varaqasi soni</th><th class="num">Kasallik nafaqasi</th></tr></thead><tbody>';
        months.forEach((m,i)=>{
          h+='<tr style="cursor:pointer" onclick="drillSickMonth('+i+')" title="'+m+' â€” xodimlar"><td style="font-weight:600;color:'+p.c1+'">'+m+' â†’</td><td class="num" style="font-weight:700">'+D.sickByMonth[i]+' ta</td><td class="num">'+fmtF(D.bolnichny[i])+" so'm</td></tr>";
        });
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td><td class="num">'+sum(D.sickByMonth)+' ta</td><td class="num">'+fmtF(sum(D.bolnichny))+" so'm</td></tr></tbody></table>";
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” shu oydagi xodimlar ro\'yxati ko\'rsatiladi</div>';
        return h;
      },
    },
    sickMax: {
      icon:'ğŸ“ˆ', color:p.c4, title:'Eng ko\'p kasallanish oyi',
      sub:'Oyni bosing â†’ xodimlar ro\'yxati',
      customList:true,
      stats:()=>{
        const mx=Math.max(...D.sickByMonth), mxI=D.sickByMonth.indexOf(mx);
        return [
          {l:'Eng ko\'p',v:months[mxI]+' â€” '+mx+' ta'},
          {l:'O\'rtacha oylik',v:(sum(D.sickByMonth)/12).toFixed(1)+' ta'},
          {l:'Shu oy nafaqasi',v:fmt(D.bolnichny[mxI])},
        ];
      },
      buildChart:(canvas)=>{
        const mx=Math.max(...D.sickByMonth);
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[
          {label:'Kasallik varaqlari',data:D.sickByMonth,backgroundColor:D.sickByMonth.map(v=>v===mx?p.c3:p.c5),borderRadius:8},
        ]},options:bOpts({plugins:{legend:{display:false}}})});
      },
      buildTable:()=>{
        const sorted=months.map((m,i)=>({m,i,v:D.sickByMonth[i]})).sort((a,b)=>b.v-a.v);
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Varaqalar</th><th class="num">Nafaqa</th></tr></thead><tbody>';
        sorted.forEach(r=>{
          h+='<tr style="cursor:pointer" onclick="drillSickMonth('+r.i+')" title="'+r.m+' â€” xodimlar"><td style="font-weight:600;color:'+p.c1+'">'+r.m+' â†’</td><td class="num" style="font-weight:700">'+r.v+' ta</td><td class="num">'+fmtF(D.bolnichny[r.i])+" so'm</td></tr>";
        });
        h+='</tbody></table>';
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” xodimlar ro\'yxati</div>';
        return h;
      },
    },
    sickCost: {
      icon:'ğŸ’Š', color:p.c1, title:'Kasallik nafaqasi xarajatlari',
      sub:'Oyni bosing â†’ xodimlar ro\'yxati',
      customList:true,
      stats:()=>{
        const mx=Math.max(...D.bolnichny), mxI=D.bolnichny.indexOf(mx);
        return [
          {l:'Jami nafaqa',v:fmt(sum(D.bolnichny))},
          {l:'Eng qimmat oy',v:months[mxI]+' ('+fmt(mx)+')'},
          {l:'O\'rtacha oylik',v:fmt(sum(D.bolnichny)/12)},
        ];
      },
      buildChart:(canvas)=>{
        return new Chart(canvas,{type:'line',data:{labels:MS,datasets:[
          {label:'Kasallik nafaqasi',data:D.bolnichny,borderColor:p.c3,backgroundColor:p.c3+'20',fill:true,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c3},
        ]},options:bOpts()});
      },
      buildTable:()=>{
        const sorted=months.map((m,i)=>({m,i,v:D.bolnichny[i],cnt:D.sickByMonth[i]})).sort((a,b)=>b.v-a.v);
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Varaqalar</th><th class="num">Nafaqa</th></tr></thead><tbody>';
        sorted.forEach(r=>{
          h+='<tr style="cursor:pointer" onclick="drillSickMonth('+r.i+')" title="'+r.m+' â€” xodimlar"><td style="font-weight:600;color:'+p.c1+'">'+r.m+' â†’</td><td class="num">'+r.cnt+' ta</td><td class="num" style="font-weight:700">'+fmtF(r.v)+" so'm</td></tr>";
        });
        h+='</tbody></table>';
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” xodimlar ro\'yxati</div>';
        return h;
      },
    },
    sickAvg: {
      icon:'ğŸ“Š', color:p.c6, title:'O\'rtacha oylik nafaqa tahlili',
      sub:'Oyni bosing â†’ xodimlar ro\'yxati',
      customList:true,
      stats:()=>{
        const avg=sum(D.bolnichny)/12;
        const above=D.bolnichny.filter(v=>v>avg).length;
        return [
          {l:'O\'rtacha oylik',v:fmt(avg)},
          {l:'O\'rtachadan yuqori',v:above+' oy'},
          {l:'Jami nafaqa',v:fmt(sum(D.bolnichny))},
        ];
      },
      buildChart:(canvas)=>{
        const avg=sum(D.bolnichny)/12;
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[
          {label:'Nafaqa',data:D.bolnichny,backgroundColor:D.bolnichny.map(v=>v>avg?p.c3:p.c5),borderRadius:8},
        ]},options:bOpts({plugins:{legend:{display:false},annotation:{annotations:{avgLine:{type:'line',yMin:avg,yMax:avg,borderColor:p.c6,borderWidth:2,borderDash:[6,3],label:{display:true,content:'O\'rtacha: '+fmt(avg),position:'start',backgroundColor:p.c6,color:'white',font:{size:10}}}}}}})});
      },
      buildTable:()=>{
        const avg=sum(D.bolnichny)/12;
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Varaqalar</th><th class="num">Nafaqa</th><th>Holat</th></tr></thead><tbody>';
        months.forEach((m,i)=>{
          const above=D.bolnichny[i]>avg;
          h+='<tr style="cursor:pointer" onclick="drillSickMonth('+i+')" title="'+m+' â€” xodimlar"><td style="font-weight:600;color:'+p.c1+'">'+m+' â†’</td><td class="num">'+D.sickByMonth[i]+' ta</td><td class="num" style="font-weight:700">'+fmtF(D.bolnichny[i])+" so'm</td><td>"+(above?'ğŸ”´ Yuqori':'ğŸŸ¢ Normal')+'</td></tr>';
        });
        h+='</tbody></table>';
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” xodimlar ro\'yxati</div>';
        return h;
      },
    },
    /* â•â•â• STAFF KPIs â•â•â• */
    staffAll: {
      icon:'ğŸ‘¥', color:p.c1, title:'Barcha xodimlar ro\'yxati',
      sub:'Jami '+D.staffList.length+' nafar xodim â€” ism, ish boshlagan yil, staj',
      customList:true,
      stats:()=>{
        const sl=D.staffList,total=sl.length;
        const avgY=total?(sl.reduce((s,x)=>s+x.stajYil,0)/total).toFixed(1):0;
        const oldest=sl.reduce((mx,x)=>x.stajYil>mx.stajYil?x:mx,{stajYil:0});
        return [
          {l:'Jami xodimlar',v:total+' nafar'},
          {l:'O\'rtacha staj',v:avgY+' yil'},
          {l:'Eng katta stajli',v:oldest.name?(oldest.name.split(' ')[0]+' â€” '+oldest.stajYil+' yil'):'â€”'},
        ];
      },
      buildTable:()=>{
        const sl=D.staffList;
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.O</th><th>Ish boshlagan</th><th>Staj</th><th class="num">Yil</th><th class="num">Staj uchun to\'lov %</th></tr></thead><tbody>';
        sl.forEach((s,i)=>{const clr=s.stajYil>=25?p.c3:s.stajYil>=15?p.c1:'';
          h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600;'+(clr?'color:'+clr:'')+'">'+s.name+'</td><td>'+s.start+'</td><td style="font-size:.82rem">'+s.stajText+'</td><td class="num" style="font-weight:700;'+(clr?'color:'+clr:'')+'">'+s.stajYil+'</td><td class="num">'+s.pct+'%</td></tr>'});
        return h+'</tbody></table>';
      },
      buildChart:(canvas)=>{
        const tl=Object.keys(D.tenure),tv=Object.values(D.tenure);
        return new Chart(canvas,{type:'bar',data:{labels:tl,datasets:[{label:'Xodimlar',data:tv,backgroundColor:[p.c5,p.c4,p.c6,p.c1,p.c7,p.c3],borderRadius:8}]},options:bOpts({plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>' '+ctx.parsed.y+' xodim'}}},yAxis:{beginAtZero:true}})});
      },
    },
    staffAvg: {
      icon:'ğŸ“Š', color:p.c4, title:'O\'rtacha staj taqsimoti',
      sub:'Staj guruhlari bo\'yicha xodimlar taqsimoti',
      customList:true,
      stats:()=>{
        const tl=Object.entries(D.tenure);
        const maxB=tl.reduce((mx,e)=>e[1]>mx[1]?e:mx,['',0]);
        return [
          {l:'Eng ko\'p guruh',v:maxB[0]+' ('+maxB[1]+' nafar)'},
          {l:'Guruhlar soni',v:tl.length},
          {l:'Jami xodimlar',v:D.staffList.length+' nafar'},
        ];
      },
      buildTable:()=>{
        const tl=Object.entries(D.tenure),total=tl.reduce((s,e)=>s+e[1],0);
        let h='<table class="data-table"><thead><tr><th>Staj guruhi</th><th class="num">Xodimlar</th><th class="num">Ulush</th></tr></thead><tbody>';
        tl.forEach(([k,v])=>{h+='<tr style="cursor:pointer" onclick="drillStajGroup(\''+k.replace(/'/g,"\\'")+'\')" title="'+k+' â€” xodimlar ro\'yxati"><td style="font-weight:600;color:'+p.c1+'">'+k+' â†’</td><td class="num" style="font-weight:700;color:'+p.c1+'">'+v+' nafar</td><td class="num">'+(v/total*100).toFixed(1)+'%</td></tr>'});
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td><td class="num">'+total+'</td><td class="num">100%</td></tr>';
        h+='</tbody></table>';
        h+='<div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Staj guruhini bosing â€” xodimlar ro\'yxati ko\'rsatiladi</div>';
        return h;
      },
      buildChart:(canvas)=>{
        const tl=Object.keys(D.tenure),tv=Object.values(D.tenure);
        return new Chart(canvas,{type:'doughnut',data:{labels:tl,datasets:[{data:tv,backgroundColor:[p.c5,p.c4,p.c6,p.c1,p.c7,p.c3],borderWidth:2,borderColor:p.cardBg,borderRadius:6}]},options:{...bOpts({noScales:true,plugins:{legend:{position:'right',labels:{color:p.text,padding:12}},tooltip:{callbacks:{label:ctx=>' '+ctx.label+': '+ctx.parsed+' nafar'}}}}),cutout:'55%'}});
      },
    },
    staff25: {
      icon:'ğŸ…', color:p.c3, title:'25+ yil stajli xodimlar',
      sub:'Bank tizimida 25 va undan ortiq yil ishlagan tajribali xodimlar',
      customList:true,
      stats:()=>{
        const sl25=D.staffList.filter(x=>x.stajYil>=25);
        const oldest=sl25.reduce((mx,x)=>x.stajYil>mx.stajYil?x:mx,{stajYil:0});
        return [
          {l:'25+ yil stajlilar',v:sl25.length+' nafar'},
          {l:'Eng katta staj',v:oldest.name?(oldest.stajYil+' yil'):'â€”'},
          {l:'Umumiydagi ulushi',v:D.staffList.length?(sl25.length/D.staffList.length*100).toFixed(1)+'%':'â€”'},
        ];
      },
      buildTable:()=>{
        const sl25=D.staffList.filter(x=>x.stajYil>=25).sort((a,b)=>b.stajYil-a.stajYil);
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.O</th><th>Ish boshlagan</th><th class="num">Staj (yil)</th><th class="num">Staj uchun to\'lov %</th></tr></thead><tbody>';
        sl25.forEach((s,i)=>{h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600;color:'+p.c3+'">'+s.name+'</td><td>'+s.start+'</td><td class="num" style="font-weight:700;color:'+p.c3+'">'+s.stajYil+'</td><td class="num">'+s.pct+'%</td></tr>'});
        if(!sl25.length) h+='<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">Ma\'lumot yo\'q</td></tr>';
        return h+'</tbody></table>';
      },
      buildChart:(canvas)=>{
        const sl25=D.staffList.filter(x=>x.stajYil>=25).sort((a,b)=>b.stajYil-a.stajYil).slice(0,15);
        return new Chart(canvas,{type:'bar',data:{labels:sl25.map(s=>s.name.split(' ').slice(0,2).join(' ')),datasets:[{label:'Staj (yil)',data:sl25.map(s=>s.stajYil),backgroundColor:p.c3,borderRadius:6}]},options:{...bOpts({plugins:{legend:{display:false}}}),indexAxis:'y'}});
      },
    },
    staff15: {
      icon:'â­', color:p.c5, title:'15+ yil stajli xodimlar',
      sub:'Bank tizimida 15 va undan ortiq yil ishlagan xodimlar',
      customList:true,
      stats:()=>{
        const sl15=D.staffList.filter(x=>x.stajYil>=15);
        const avgY=sl15.length?(sl15.reduce((s,x)=>s+x.stajYil,0)/sl15.length).toFixed(1):0;
        return [
          {l:'15+ yil stajlilar',v:sl15.length+' nafar'},
          {l:'O\'rtacha staji',v:avgY+' yil'},
          {l:'Umumiydagi ulushi',v:D.staffList.length?(sl15.length/D.staffList.length*100).toFixed(1)+'%':'â€”'},
        ];
      },
      buildTable:()=>{
        const sl15=D.staffList.filter(x=>x.stajYil>=15).sort((a,b)=>b.stajYil-a.stajYil);
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.O</th><th>Ish boshlagan</th><th class="num">Staj (yil)</th><th class="num">Staj uchun to\'lov %</th></tr></thead><tbody>';
        sl15.forEach((s,i)=>{const clr=s.stajYil>=25?p.c3:p.c5;
          h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600;color:'+clr+'">'+s.name+'</td><td>'+s.start+'</td><td class="num" style="font-weight:700;color:'+clr+'">'+s.stajYil+'</td><td class="num">'+s.pct+'%</td></tr>'});
        return h+'</tbody></table>';
      },
      buildChart:(canvas)=>{
        const buckets={'15-19 yil':0,'20-24 yil':0,'25-29 yil':0,'30+ yil':0};
        D.staffList.filter(x=>x.stajYil>=15).forEach(s=>{if(s.stajYil>=30)buckets['30+ yil']++;else if(s.stajYil>=25)buckets['25-29 yil']++;else if(s.stajYil>=20)buckets['20-24 yil']++;else buckets['15-19 yil']++});
        return new Chart(canvas,{type:'doughnut',data:{labels:Object.keys(buckets),datasets:[{data:Object.values(buckets),backgroundColor:[p.c5,p.c1,p.c3,p.c7],borderWidth:2,borderColor:p.cardBg,borderRadius:6}]},options:{...bOpts({noScales:true,plugins:{legend:{position:'right',labels:{color:p.text,padding:12}},tooltip:{callbacks:{label:ctx=>' '+ctx.label+': '+ctx.parsed+' nafar'}}}}),cutout:'55%'}});
      },
    },
    /* â•â•â• JUBILEE KPIs â•â•â• */
    jubAll: { icon:'ğŸ‚', color:p.c1, title:'Yubiley xodimlari â€” batafsil', sub:'50 va 60 yoshli yubiley nishonlagan xodimlar', customList:true,
      stats:()=>{ const jl=D.jubList||[]; return [{l:'Jami yubileychilar',v:jl.length+' nafar'},{l:'50 yoshlilar',v:jl.filter(j=>j.age==='50').length},{l:'60 yoshlilar',v:jl.filter(j=>j.age==='60').length}]; },
      buildTable:()=>{ const jl=D.jubList||[];
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.Sh.</th><th>Bo\'lim</th><th>Buyruq sanasi</th><th>Buyruq â„–</th><th class="num">Yoshi</th></tr></thead><tbody>';
        jl.forEach((j,i)=>{h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+j.name+'</td><td>'+j.dept+'</td><td>'+j.date+'</td><td>'+j.num+'</td><td class="num" style="font-weight:700;color:'+p.c1+'">'+j.age+' yosh</td></tr>'});
        if(!jl.length) h+='<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">Ma\'lumot yo\'q</td></tr>';
        return h+'</tbody></table>'; },
      buildChart:(canvas)=>{ const a50=(D.jubList||[]).filter(j=>j.age==='50').length, a60=(D.jubList||[]).filter(j=>j.age==='60').length;
        return new Chart(canvas,{type:'doughnut',data:{labels:['50 yosh','60 yosh'],datasets:[{data:[a50,a60],backgroundColor:[p.c4,p.c1],borderWidth:2,borderColor:p.cardBg,borderRadius:6}]},options:{...bOpts({noScales:true,plugins:{legend:{position:'right'},tooltip:{callbacks:{label:ctx=>' '+ctx.label+': '+ctx.parsed+' nafar'}}}}),cutout:'55%'}}); },
    },
    jubDafn: { icon:'ğŸ•¯ï¸', color:p.c3, title:'Dafn moddiy yordami', sub:'Dafn marosimi uchun moddiy yordam olgan xodimlar', customList:true,
      stats:()=>{ const dl=D.dafnList||[]; return [{l:'Jami',v:dl.length+' nafar'}]; },
      buildTable:()=>{ const dl=D.dafnList||[];
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.Sh.</th><th>Bo\'lim</th><th>Oy</th></tr></thead><tbody>';
        dl.forEach((x,i)=>{h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+x.name+'</td><td>'+x.dept+'</td><td>'+x.month+'</td></tr>'});
        if(!dl.length) h+='<tr><td colspan="4" style="text-align:center;color:var(--text-muted)">Ma\'lumot yo\'q</td></tr>';
        return h+'</tbody></table>'; },
    },
    jub50: { icon:'ğŸ‘¤', color:p.c4, title:'50 yoshli yubileychilar', sub:'50 yosh to\'ldirgan xodimlar ro\'yxati', customList:true,
      stats:()=>{ const jl=(D.jubList||[]).filter(j=>j.age==='50'); return [{l:'50 yoshlilar',v:jl.length+' nafar'}]; },
      buildTable:()=>{ const jl=(D.jubList||[]).filter(j=>j.age==='50');
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.Sh.</th><th>Bo\'lim</th><th>Buyruq sanasi</th><th>Buyruq â„–</th></tr></thead><tbody>';
        jl.forEach((j,i)=>{h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+j.name+'</td><td>'+j.dept+'</td><td>'+j.date+'</td><td>'+j.num+'</td></tr>'});
        if(!jl.length) h+='<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">Ma\'lumot yo\'q</td></tr>';
        return h+'</tbody></table>'; },
    },
    jub60: { icon:'ğŸ‘¤', color:p.c5, title:'60 yoshli yubileychilar', sub:'60 yosh to\'ldirgan xodimlar ro\'yxati', customList:true,
      stats:()=>{ const jl=(D.jubList||[]).filter(j=>j.age==='60'); return [{l:'60 yoshlilar',v:jl.length+' nafar'}]; },
      buildTable:()=>{ const jl=(D.jubList||[]).filter(j=>j.age==='60');
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>F.I.Sh.</th><th>Bo\'lim</th><th>Buyruq sanasi</th><th>Buyruq â„–</th></tr></thead><tbody>';
        jl.forEach((j,i)=>{h+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+j.name+'</td><td>'+j.dept+'</td><td>'+j.date+'</td><td>'+j.num+'</td></tr>'});
        if(!jl.length) h+='<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">Ma\'lumot yo\'q</td></tr>';
        return h+'</tbody></table>'; },
    },
    /* â•â•â• CONTRACT KPIs â•â•â• */
    contractAll: {
      icon:'ğŸ“„', color:p.c1, title:'Barcha shartnomalar ro\'yxati',
      sub:'2025-yil: '+D.contractList.length+' ta shartnoma â€” mahsulot, xizmat va asosiy vositalar',
      customList:true,
      stats:()=>{
        const cl=D.contractList,totalSum=cl.reduce((s,c)=>s+c.summa,0);
        const ombor=cl.filter(c=>c.cat==='ombor'),xizmat=cl.filter(c=>c.cat==='xizmat'),asosiy=cl.filter(c=>c.cat==='asosiy');
        return [
          {l:'Jami summa',v:fmt(totalSum)},
          {l:'ğŸ“¦ Mahsulot',v:ombor.length+' ta ('+fmt(ombor.reduce((s,c)=>s+c.summa,0))+')'},
          {l:'ğŸ”§ Xizmat',v:xizmat.length+' ta ('+fmt(xizmat.reduce((s,c)=>s+c.summa,0))+')'},
        ];
      },
      buildTable:()=>{
        const catLabels={ombor:'ğŸ“¦ Mahsulot',xizmat:'ğŸ”§ Xizmat',asosiy:'ğŸ—ï¸ Asosiy vosita'};
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>Sana</th><th>Kategoriya</th><th>Yetkazib beruvchi</th><th>Mahsulot</th><th class="num">Summa</th></tr></thead><tbody>';
        D.contractList.forEach((c,i)=>{h+='<tr><td>'+(i+1)+'</td><td>'+c.date+'</td><td style="font-size:.78rem;font-weight:600">'+(catLabels[c.cat]||c.cat)+'</td><td style="font-weight:600">'+c.provider+'</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+c.product.replace(/"/g,'&quot;')+'">'+c.product+'</td><td class="num" style="font-weight:700;color:'+p.c1+'">'+fmtF(c.summa)+'</td></tr>'});
        const ts=D.contractList.reduce((s,c)=>s+c.summa,0);
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td colspan="4">JAMI</td><td class="num">'+fmtF(ts)+" so'm</td></tr>";
        return h+'</tbody></table>';
      },
      buildChart:(canvas)=>{
        const omborByM=A(12),xizmatByM=A(12),asosiyByM=A(12);
        D.contractList.forEach(c=>{const m=new Date(c.date).getUTCMonth();if(m>=0&&m<12){if(c.cat==='ombor')omborByM[m]+=c.summa;else if(c.cat==='asosiy')asosiyByM[m]+=c.summa;else xizmatByM[m]+=c.summa}});
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[
          {label:'ğŸ“¦ Mahsulot',data:omborByM,backgroundColor:p.c5,borderRadius:3,stack:'s'},
          {label:'ğŸ”§ Xizmat',data:xizmatByM,backgroundColor:p.c4,borderRadius:3,stack:'s'},
          {label:'ğŸ—ï¸ Asosiy vosita',data:asosiyByM,backgroundColor:p.c3,borderRadius:3,stack:'s'},
        ]},options:bOpts({plugins:{legend:{position:'top'}},scales:{x:{stacked:true},y:{stacked:true}}})});
      },
    },
    contractOmbor: {
      icon:'ğŸ“¦', color:p.c5, title:'Mahsulot shartnomalar (Ombor)',
      sub:'Faqat omborga kiritiladigan mahsulotlar â€” xizmatlar hisobga olinmagan',
      customList:true,
      stats:()=>{
        const cl=D.contractList.filter(c=>c.cat==='ombor'),totalSum=cl.reduce((s,c)=>s+c.summa,0);
        const providers=new Set(cl.map(c=>c.provider)).size;
        return [
          {l:'Mahsulot shartnomalar',v:cl.length+' ta'},
          {l:'Jami summa',v:fmt(totalSum)},
          {l:'Yetkazib beruvchilar',v:providers},
        ];
      },
      buildTable:()=>{
        const cl=D.contractList.filter(c=>c.cat==='ombor');
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>Sana</th><th>Yetkazib beruvchi</th><th>Mahsulot</th><th class="num">Soni</th><th class="num">Summa</th></tr></thead><tbody>';
        cl.forEach((c,i)=>{h+='<tr><td>'+(i+1)+'</td><td>'+c.date+'</td><td style="font-weight:600">'+c.provider+'</td><td>'+c.product+'</td><td class="num">'+c.qty+' '+c.unit+'</td><td class="num" style="font-weight:700;color:'+p.c5+'">'+fmtF(c.summa)+'</td></tr>'});
        const ts=cl.reduce((s,c)=>s+c.summa,0);
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td colspan="4">JAMI</td><td class="num">'+fmtF(ts)+" so'm</td></tr></tbody></table>";
        return h;
      },
      buildChart:(canvas)=>{
        const byM=A(12);D.contractList.filter(c=>c.cat==='ombor').forEach(c=>{const m=new Date(c.date).getUTCMonth();if(m>=0&&m<12)byM[m]+=c.summa});
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[{label:'Mahsulot kirimi',data:byM,backgroundColor:p.c5,borderRadius:6}]},options:bOpts({plugins:{legend:{display:false}}})});
      },
    },
    contractXizmat: {
      icon:'ğŸ”§', color:p.c4, title:'Xizmat shartnomalar',
      sub:'Elektr, gaz, ta\'mir, IT, o\'qitish va boshqa xizmatlar â€” omborga kiritilmaydi',
      customList:true,
      stats:()=>{
        const cl=D.contractList.filter(c=>c.cat==='xizmat'),totalSum=cl.reduce((s,c)=>s+c.summa,0);
        const maxC=cl.reduce((mx,c)=>c.summa>mx.summa?c:mx,{summa:0});
        return [
          {l:'Xizmat shartnomalar',v:cl.length+' ta'},
          {l:'Jami summa',v:fmt(totalSum)},
          {l:'Eng yirigi',v:maxC.provider?maxC.provider.slice(0,20):'â€”'},
        ];
      },
      buildTable:()=>{
        const cl=D.contractList.filter(c=>c.cat==='xizmat').sort((a,b)=>b.summa-a.summa);
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>Sana</th><th>Xizmat ko\'rsatuvchi</th><th>Xizmat nomi</th><th class="num">Summa</th></tr></thead><tbody>';
        cl.forEach((c,i)=>{h+='<tr><td>'+(i+1)+'</td><td>'+c.date+'</td><td style="font-weight:600">'+c.provider+'</td><td>'+c.product+'</td><td class="num" style="font-weight:700;color:'+p.c4+'">'+fmtF(c.summa)+'</td></tr>'});
        const ts=cl.reduce((s,c)=>s+c.summa,0);
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td colspan="3">JAMI</td><td class="num">'+fmtF(ts)+" so'm</td></tr></tbody></table>";
        return h;
      },
      buildChart:(canvas)=>{
        const cl=D.contractList.filter(c=>c.cat==='xizmat').sort((a,b)=>b.summa-a.summa).slice(0,10);
        return new Chart(canvas,{type:'bar',data:{labels:cl.map(c=>c.provider.slice(0,20)),datasets:[{label:'Xizmat summasi',data:cl.map(c=>c.summa),backgroundColor:[p.c4,p.c1,p.c3,p.c5,p.c6,p.c7,p.c2,p.c8,p.c4+'99',p.c1+'99'],borderRadius:6}]},options:{...bOpts({plugins:{legend:{display:false}}}),indexAxis:'y'}});
      },
    },
    contractAsosiy: {
      icon:'ğŸ—ï¸', color:p.c3, title:'Asosiy vositalar shartnomalar',
      sub:'Uskunalar, jihozlar va boshqa kapital xaridlar',
      customList:true,
      stats:()=>{
        const cl=D.contractList.filter(c=>c.cat==='asosiy'),totalSum=cl.reduce((s,c)=>s+c.summa,0);
        return [
          {l:'Asosiy vosita shartnomalar',v:cl.length+' ta'},
          {l:'Jami summa',v:fmt(totalSum)},
          {l:'O\'rtacha narx',v:cl.length?fmt(totalSum/cl.length):'â€”'},
        ];
      },
      buildTable:()=>{
        const cl=D.contractList.filter(c=>c.cat==='asosiy').sort((a,b)=>b.summa-a.summa);
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>Sana</th><th>Yetkazib beruvchi</th><th>Uskuna/vosita nomi</th><th class="num">Soni</th><th class="num">Summa</th></tr></thead><tbody>';
        cl.forEach((c,i)=>{h+='<tr><td>'+(i+1)+'</td><td>'+c.date+'</td><td style="font-weight:600">'+c.provider+'</td><td>'+c.product+'</td><td class="num">'+c.qty+' '+c.unit+'</td><td class="num" style="font-weight:700;color:'+p.c3+'">'+fmtF(c.summa)+'</td></tr>'});
        const ts=cl.reduce((s,c)=>s+c.summa,0);
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td colspan="4">JAMI</td><td class="num">'+fmtF(ts)+" so'm</td></tr></tbody></table>";
        return h;
      },
      buildChart:(canvas)=>{
        const cl=D.contractList.filter(c=>c.cat==='asosiy');
        return new Chart(canvas,{type:'bar',data:{labels:cl.map(c=>c.product.slice(0,25)),datasets:[{label:'Summa',data:cl.map(c=>c.summa),backgroundColor:[p.c3,p.c1,p.c4,p.c5],borderRadius:6}]},options:bOpts({plugins:{legend:{display:false}}})});
      },
    },
    /* â•â•â• AI TAHLIL KPIs â•â•â• */
    aiTrend: {
      icon:'ğŸ¤–', color:p.c1, title:'AI Prognoz trend tahlili â€” multi-model',
      sub:'4 ta model asosida xarajatlar tendensiyasi va kelgusi 3 oy bashorati',
      customList:true,
      stats:()=>{
        if(!aiModelE) return [{l:'â€”',v:'Model hisoblanmagan'}];
        const b=aiModelE.best;
        const f=aiModelE.forecasts;
        const tm=D.ishHaqi.map((v,i)=>v+D.staj[i]+D.mehnatTatil[i]+D.bayramMukofot[i]+D.ijtimoiySoliq[i]+D.ustama[i]);
        const la=(tm[9]+tm[10]+tm[11])/3;
        const tp=la>0&&f[2]?((f[2]-la)/la*100):0;
        return [
          {l:'Eng yaxshi model',v:b.name.split('(')[0].trim()},
          {l:'Aniqlik (RÂ²)',v:(b.r2*100).toFixed(1)+'%'},
          {l:'Trend',v:(tp>0?'â†‘ +':'â†“ ')+tp.toFixed(1)+'%'},
        ];
      },
      buildTable:()=>{
        if(!aiModelE) return '<p>Model hisoblanmagan</p>';
        const tm=D.ishHaqi.map((v,i)=>v+D.staj[i]+D.mehnatTatil[i]+D.bayramMukofot[i]+D.ijtimoiySoliq[i]+D.ustama[i]);
        const b=aiModelE.best;
        let h='<div style="font-weight:700;margin-bottom:.5rem;color:'+p.c1+'">ğŸ† '+b.name+' (RÂ²: '+(b.r2*100).toFixed(1)+'%)</div>';
        h+='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Haqiqiy</th><th class="num">Model fitted</th><th class="num">Farq</th></tr></thead><tbody>';
        months.forEach((m,i)=>{const actual=tm[i],fitted=b.fitted?b.fitted[i]:0,diff=actual-fitted;
          h+='<tr><td>'+m+'</td><td class="num">'+fmt(actual)+'</td><td class="num" style="color:'+p.c4+'">'+fmt(fitted)+'</td><td class="num" style="color:'+(Math.abs(diff)>actual*0.2?'#EF4444':'#10B981')+'">'+(diff>0?'+':'')+fmt(diff)+'</td></tr>'});
        h+='<tr style="background:var(--bg-accent)"><td colspan="4" style="font-weight:600;padding:.75rem">Prognoz (kelgusi 3 oy)</td></tr>';
        ['Yanvar 2026','Fevral 2026','Mart 2026'].forEach((m,i)=>{
          h+='<tr style="background:#3B82F608"><td style="font-weight:600;color:'+p.c3+'">â­ '+m+'</td><td class="num">â€”</td><td class="num" style="font-weight:700;color:'+p.c3+'">'+fmt(aiModelE.forecasts[i])+'</td><td class="num">â€”</td></tr>'});
        return h+'</tbody></table>';
      },
      buildChart:(canvas)=>{
        if(!aiModelE) return null;
        const tm=D.ishHaqi.map((v,i)=>v+D.staj[i]+D.mehnatTatil[i]+D.bayramMukofot[i]+D.ijtimoiySoliq[i]+D.ustama[i]);
        const b=aiModelE.best;
        const labels=[...MS,'Yan\'26','Fev\'26','Mar\'26'];
        const ds=[
          {label:'Haqiqiy',data:[...tm,...Array(3).fill(null)],borderColor:p.c1,backgroundColor:p.c1+'15',fill:true,tension:.3,pointRadius:5,pointBackgroundColor:p.c1,borderWidth:2.5},
          {label:'Prognoz',data:[...Array(12).fill(null),...aiModelE.forecasts],borderColor:p.c3,backgroundColor:p.c3+'15',fill:true,tension:.3,pointRadius:7,pointBackgroundColor:p.c3,borderWidth:3,pointStyle:'star'},
        ];
        if(b.fitted) ds.push({label:'Model fitted',data:[...b.fitted,...Array(3).fill(null)],borderColor:p.c7,borderWidth:1.5,borderDash:[6,4],pointRadius:0,fill:false});
        return new Chart(canvas,{type:'line',data:{labels,datasets:ds},options:bOpts({plugins:{legend:{position:'top'}}})});
      },
    },
    aiModel: {
      icon:'ğŸ“Š', color:p.c4, title:'Model aniqligi va solishtirma tahlil',
      sub:'4 ta model: Holt-Winters, Mavsumiy dekompozitsiya, WMA, Linear Regression â€” avtomatik eng yaxshisi tanlangan',
      customList:true,
      stats:()=>{
        if(!aiModelE) return [{l:'â€”',v:'Hisoblanmagan'}];
        const b=aiModelE.best;
        return [
          {l:'Eng yaxshi model',v:b.name.split('(')[0].trim()},
          {l:'RÂ² (xarajat)',v:(b.r2*100).toFixed(1)+'%'},
          {l:'Modellar soni',v:aiModelE.all.length+' ta'},
        ];
      },
      buildTable:()=>{
        if(!aiModelE) return '<p>Model hisoblanmagan</p>';
        let h='<div style="padding:0 .25rem">';

        /* Modellar reyting jadvali */
        h+='<div style="font-weight:700;margin-bottom:.75rem;color:'+p.c1+'">ğŸ† Xarajat modellari reytingi</div>';
        h+='<table class="data-table"><thead><tr><th>â„–</th><th>Model</th><th class="num">RÂ²</th><th class="num">Yanvar</th><th class="num">Fevral</th><th class="num">Mart</th><th>Holat</th></tr></thead><tbody>';
        aiModelE.all.sort((a,b)=>b.r2-a.r2).forEach((m,i)=>{
          const isBest=m===aiModelE.best;
          const clr=m.r2>.7?'#10B981':m.r2>.4?'#F59E0B':'#EF4444';
          h+='<tr style="'+(isBest?'background:'+p.c1+'12;font-weight:700':'')+'">';
          h+='<td>'+(i+1)+'</td><td>'+m.name+(isBest?' â­':'')+'</td>';
          h+='<td class="num" style="font-weight:700;color:'+clr+'">'+(m.r2*100).toFixed(1)+'%</td>';
          h+='<td class="num">'+fmt(m.predict(12))+'</td><td class="num">'+fmt(m.predict(13))+'</td><td class="num">'+fmt(m.predict(14))+'</td>';
          h+='<td style="color:'+clr+'">'+(m.r2>.7?'âœ… Yaxshi':m.r2>.4?'âš ï¸ O\'rtacha':'âŒ Past')+'</td></tr>';
        });
        h+='</tbody></table>';

        /* Ombor modellari */
        if(aiModelW){
          h+='<div style="font-weight:700;margin:1.25rem 0 .75rem;color:'+p.c3+'">ğŸ“¦ Ombor modellari reytingi</div>';
          h+='<table class="data-table"><thead><tr><th>â„–</th><th>Model</th><th class="num">RÂ²</th><th>Holat</th></tr></thead><tbody>';
          aiModelW.all.sort((a,b)=>b.r2-a.r2).forEach((m,i)=>{
            const isBest=m===aiModelW.best;
            const clr=m.r2>.7?'#10B981':m.r2>.4?'#F59E0B':'#EF4444';
            h+='<tr style="'+(isBest?'background:'+p.c3+'12;font-weight:700':'')+'"><td>'+(i+1)+'</td><td>'+m.name+(isBest?' â­':'')+'</td><td class="num" style="font-weight:700;color:'+clr+'">'+(m.r2*100).toFixed(1)+'%</td><td style="color:'+clr+'">'+(m.r2>.7?'âœ…':m.r2>.4?'âš ï¸':'âŒ')+'</td></tr>';
          });
          h+='</tbody></table>';
        }
        h+='</div>';
        return h;
      },
      buildChart:(canvas)=>{
        if(!aiModelE) return null;
        /* Barcha modellarning RÂ² solishtirmasi â€” horizontal bar */
        const models=[...aiModelE.all].sort((a,b)=>b.r2-a.r2);
        if(aiModelE.ensemble) models.push(aiModelE.ensemble);
        const clrs=models.map(m=>m.r2>.7?'#10B98199':m.r2>.4?'#F59E0B99':'#EF444499');
        const p2=P();
        return new Chart(canvas,{type:'bar',data:{
          labels:models.map(m=>{const n=m.name.split('(')[0].trim();return n.length>18?n.slice(0,16)+'â€¦':n}),
          datasets:[{label:'RÂ² (%)',data:models.map(m=>+(m.r2*100).toFixed(1)),backgroundColor:clrs,borderRadius:8,borderWidth:2,borderColor:clrs.map(c=>c.replace('99','ff'))}]
        },options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',
          plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>(ctx.parsed.x||0).toFixed(1)+'% aniqlik'}}},
          scales:{
            x:{min:0,max:105,ticks:{color:p2.text,callback:v=>v+'%'},grid:{color:p2.grid}},
            y:{ticks:{color:p2.text,font:{size:11}},grid:{display:false}}
          },interaction:{mode:'index',intersect:false}}});
      },
    },
    aiOmbor: {
      icon:'âš¡', color:p.c3, title:'Ombor kirim-chiqim trend tahlili',
      sub:'Ombor chiqimi va mahsulot kirimi â€” multi-model prognoz',
      customList:true,
      stats:()=>{
        const kirimJ=sum(D.mahsulotKirim),chiqimJ=sum(D.omborChiqim);
        const bW=aiModelW?aiModelW.best:null;
        return [
          {l:'Kirim/Chiqim balans',v:fmt(kirimJ-chiqimJ)},
          {l:'Ombor RÂ²',v:bW?(bW.r2*100).toFixed(1)+'%':'â€”'},
          {l:'Model',v:bW?bW.name.split('(')[0].trim():'â€”'},
        ];
      },
      buildTable:()=>{
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Kirim</th><th class="num">Chiqim</th><th class="num">Balans</th></tr></thead><tbody>';
        months.forEach((m,i)=>{const k=D.mahsulotKirim[i],ch=D.omborChiqim[i],bal=k-ch;
          h+='<tr><td>'+m+'</td><td class="num" style="color:#10B981;font-weight:600">'+fmt(k)+'</td><td class="num" style="color:#EF4444;font-weight:600">'+fmt(ch)+'</td><td class="num" style="color:'+(bal>=0?'#10B981':'#EF4444')+';font-weight:700">'+(bal>=0?'+':'')+fmt(bal)+'</td></tr>'});
        const tk=sum(D.mahsulotKirim),tc=sum(D.omborChiqim);
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td><td class="num" style="color:#10B981">'+fmt(tk)+'</td><td class="num" style="color:#EF4444">'+fmt(tc)+'</td><td class="num" style="color:'+(tk-tc>=0?'#10B981':'#EF4444')+'">'+(tk-tc>=0?'+':'')+fmt(tk-tc)+'</td></tr>';
        if(aiModelW){
          h+='<tr style="background:#3B82F608"><td colspan="4" style="font-weight:600;padding:.75rem">Prognoz (kelgusi 3 oy) â€” '+aiModelW.best.name.split('(')[0].trim()+'</td></tr>';
          ['Yan\'26','Fev\'26','Mar\'26'].forEach((m,i)=>{
            h+='<tr style="background:#3B82F608"><td style="font-weight:600;color:'+p.c3+'">â­ '+m+'</td><td class="num">â€”</td><td class="num" style="font-weight:700;color:'+p.c3+'">'+fmt(aiModelW.forecasts[i])+'</td><td class="num">â€”</td></tr>'});
        }
        return h+'</tbody></table>';
      },
      buildChart:(canvas)=>{
        const labels=[...MS,'Yan\'26','Fev\'26','Mar\'26'];
        const ds=[
          {label:'Mahsulot kirimi',data:[...D.mahsulotKirim,...Array(3).fill(null)],backgroundColor:'#10B98177',borderRadius:4},
          {label:'Chiqim',data:[...D.omborChiqim,...Array(3).fill(null)],backgroundColor:'#EF444477',borderRadius:4},
        ];
        if(aiModelW) ds.push({label:'Chiqim prognozi',data:[...Array(12).fill(null),...aiModelW.forecasts],backgroundColor:'#EC489988',borderRadius:4,borderWidth:2,borderColor:'#EC4899'});
        return new Chart(canvas,{type:'bar',data:{labels,datasets:ds},options:bOpts({plugins:{legend:{position:'top'}}})});
      },
    },
    aiData: {
      icon:'ğŸ¯', color:p.c5, title:'Ma\'lumot nuqtalari va model sifati',
      sub:'12 oylik ma\'lumotlar, mavsumiy koeffitsientlar va model taqqoslash',
      customList:true,
      stats:()=>{
        const tm=D.ishHaqi.map((v,i)=>v+D.staj[i]+D.mehnatTatil[i]+D.bayramMukofot[i]+D.ijtimoiySoliq[i]+D.ustama[i]);
        const nonZero=tm.filter(v=>v>0).length;
        const avgVal=sum(tm)/12;
        return [
          {l:'Faol oylar',v:nonZero+' / 12'},
          {l:'O\'rtacha xarajat',v:fmt(avgVal)},
          {l:'Ma\'lumot sifati',v:nonZero>=10?'âœ… Yaxshi':nonZero>=6?'âš ï¸ O\'rtacha':'âŒ Past'},
        ];
      },
      buildTable:()=>{
        const tm=D.ishHaqi.map((v,i)=>v+D.staj[i]+D.mehnatTatil[i]+D.bayramMukofot[i]+D.ijtimoiySoliq[i]+D.ustama[i]);
        const avgVal=sum(tm)/12;
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Ish haqi</th><th class="num">Staj</th><th class="num">Bayram</th><th class="num">Ta\'til</th><th class="num">Jami</th><th class="num">O\'rtachadan</th></tr></thead><tbody>';
        months.forEach((m,i)=>{
          const j=tm[i],diff=j-avgVal,pct=avgVal>0?((diff/avgVal)*100):0;
          h+='<tr><td>'+m+'</td><td class="num">'+fmt(D.ishHaqi[i])+'</td><td class="num">'+fmt(D.staj[i])+'</td><td class="num">'+fmt(D.bayramMukofot[i])+'</td><td class="num">'+fmt(D.mehnatTatil[i])+'</td><td class="num" style="font-weight:700">'+fmt(j)+'</td><td class="num" style="color:'+(pct>0?'#EF4444':'#10B981')+'">'+(pct>0?'+':'')+pct.toFixed(1)+'%</td></tr>'});
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td>O\'RTACHA</td><td class="num">'+fmt(sum(D.ishHaqi)/12)+'</td><td class="num">'+fmt(sum(D.staj)/12)+'</td><td class="num">'+fmt(sum(D.bayramMukofot)/12)+'</td><td class="num">'+fmt(sum(D.mehnatTatil)/12)+'</td><td class="num">'+fmt(avgVal)+'</td><td class="num">â€”</td></tr>';
        return h+'</tbody></table>';
      },
      buildChart:(canvas)=>{
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[
          {label:'Ish haqi',data:D.ishHaqi,backgroundColor:p.c1+'99',borderRadius:3,stack:'s'},
          {label:'Staj',data:D.staj,backgroundColor:p.c4+'99',borderRadius:3,stack:'s'},
          {label:'Bayram',data:D.bayramMukofot,backgroundColor:p.c3+'99',borderRadius:3,stack:'s'},
          {label:'Ta\'til',data:D.mehnatTatil,backgroundColor:p.c5+'99',borderRadius:3,stack:'s'},
        ]},options:bOpts({plugins:{legend:{position:'top'}},scales:{x:{stacked:true},y:{stacked:true}}})});
      },
    },

    /* â•â•â• DAROMAD-XARAJAT KPIs â•â•â• */
    expTotal: {
      icon:'ğŸ“Š', color:p.c3, title:'Jami xarajatlar â€” kategoriyalar bo\'yicha tahlil',
      sub:'Barcha xarajat kategoriyalari va ularning oylik dinamikasi',
      customList:true,
      stats:()=>{
        const cats=D.expCats||{};
        const xCats=Object.entries(cats).filter(([,v])=>!v.isDaromad).sort((a,b)=>sum(b[1].total)-sum(a[1].total));
        const totalX=sum(D.xarajatByMonth||[]);
        const avgM=totalX/12;
        const maxM=Math.max(...(D.xarajatByMonth||[])), maxI=(D.xarajatByMonth||[]).indexOf(maxM);
        return [
          {l:'Jami xarajat',v:fmt(totalX)},
          {l:'Kategoriyalar soni',v:xCats.length+' ta'},
          {l:'Eng qimmat oy',v:months[maxI]+' ('+fmt(maxM)+')'},
        ];
      },
      buildTable:()=>{
        const cats=D.expCats||{};
        const xCats=Object.entries(cats).filter(([,v])=>!v.isDaromad).sort((a,b)=>sum(b[1].total)-sum(a[1].total));
        const totalX=sum(D.xarajatByMonth||[]);
        const icons=['ğŸ’°','ğŸ¦','âš¡','ğŸ—ï¸','ğŸ”§','ğŸ“¦','ğŸ“','ğŸ¥','ğŸ“‹','ğŸš—','ğŸ’»','ğŸ“Š','ğŸ“'];
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>Kategoriya</th><th class="num">Ustunlar</th><th class="num">Jami summa</th><th class="num">Ulush</th></tr></thead><tbody>';
        xCats.forEach(([name,cat],i)=>{
          const s=sum(cat.total), pct=(s/totalX*100);
          h+='<tr style="cursor:pointer" onclick="drillModalTo(\'category\',\''+name.replace(/'/g,"\\'")+'\')" title="Ustunlarni ko\'rish"><td>'+(i+1)+'</td><td style="font-weight:600;color:'+p.c1+'">'+(icons[i]||'ğŸ“„')+' '+name+' â†’</td><td class="num">'+cat.cols.length+' ta</td><td class="num" style="font-weight:700;color:'+p.c1+'">'+fmt(s)+'</td><td class="num">'+pct.toFixed(1)+'%</td></tr>';
        });
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td>JAMI</td><td class="num">'+xCats.reduce((s,[,c])=>s+c.cols.length,0)+'</td><td class="num">'+fmt(totalX)+'</td><td class="num">100%</td></tr>';
        h+='</tbody></table><div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Kategoriya nomini bosing â€” ustunlar ko\'rsatiladi</div>';
        return h;
      },
      buildChart:(canvas)=>{
        const cats=D.expCats||{};
        const xCats=Object.entries(cats).filter(([,v])=>!v.isDaromad).sort((a,b)=>sum(b[1].total)-sum(a[1].total));
        const cc=[p.c1,p.c3,p.c5,p.c4,p.c7,p.c6,p.c8,p.c2,'#e67e22','#1abc9c','#9b59b6','#34495e'];
        const ds=xCats.slice(0,10).map(([name,cat],i)=>({
          label:name.length>20?name.slice(0,18)+'â€¦':name,data:cat.total,backgroundColor:cc[i%cc.length]+'99',borderRadius:2,stack:'s'
        }));
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:ds},options:bOpts({plugins:{legend:{position:'top',labels:{font:{size:10},padding:6}}},scales:{x:{stacked:true},y:{stacked:true}}})});
      },
    },
    expDaromad: {
      icon:'ğŸ’°', color:p.c5, title:'Daromadlar batafsil tahlili',
      sub:'Barcha daromad manbalari va ularning oylik dinamikasi',
      customList:true,
      stats:()=>{
        const cats=D.expCats||{};
        const dCats=Object.entries(cats).filter(([,v])=>v.isDaromad);
        const totalD=sum(D.daromadByMonth||[]);
        const dCols=(D.expCols||[]).filter(c=>c.isDaromad);
        const maxCol=dCols.sort((a,b)=>sum(b.data)-sum(a.data))[0];
        return [
          {l:'Jami daromad',v:fmt(totalD)},
          {l:'Ustunlar soni',v:dCols.length+' ta'},
          {l:'Eng katta manba',v:maxCol?maxCol.name.slice(0,25):'â€”'},
        ];
      },
      buildTable:()=>{
        const dCols=(D.expCols||[]).filter(c=>c.isDaromad).sort((a,b)=>sum(b.data)-sum(a.data));
        const totalD=sum(D.daromadByMonth||[]);
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>Daromad nomi</th><th class="num">Jami summa</th><th class="num">Ulush</th><th class="num">O\'rtacha oylik</th></tr></thead><tbody>';
        dCols.forEach((c,i)=>{
          const s=sum(c.data), pct=totalD>0?(s/totalD*100):0;
          h+='<tr style="cursor:pointer" onclick="drillModalTo(\'column\',\''+c.name.replace(/'/g,"\\'")+'\')" title="Oylik taqsimot ko\'rish"><td>'+(i+1)+'</td><td style="font-weight:600;color:'+p.c5+'">'+c.name+' â†’</td><td class="num" style="font-weight:700;color:'+p.c5+'">'+fmt(s)+'</td><td class="num">'+pct.toFixed(1)+'%</td><td class="num">'+fmt(s/12)+'</td></tr>';
        });
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td>JAMI</td><td class="num">'+fmt(totalD)+'</td><td class="num">100%</td><td class="num">'+fmt(totalD/12)+'</td></tr>';
        h+='</tbody></table><div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Ustun nomini bosing â€” oylik taqsimot ko\'rsatiladi</div>';
        return h;
      },
      buildChart:(canvas)=>{
        const dCols=(D.expCols||[]).filter(c=>c.isDaromad).sort((a,b)=>sum(b.data)-sum(a.data));
        const cc=[p.c5,p.c4,p.c1,p.c3,p.c6,p.c7];
        const ds=dCols.map((c,i)=>({label:c.name.length>20?c.name.slice(0,18)+'â€¦':c.name,data:c.data,borderColor:cc[i%cc.length],backgroundColor:cc[i%cc.length]+'20',fill:false,tension:.4,pointRadius:4,borderWidth:2}));
        return new Chart(canvas,{type:'line',data:{labels:MS,datasets:ds},options:bOpts({plugins:{legend:{position:'top',labels:{font:{size:10}}}}})});
      },
    },
    expCats: {
      icon:'ğŸ“', color:p.c1, title:'Kategoriyalar taqsimoti',
      sub:'Xarajat va daromad kategoriyalari â€” soni, summasi va ulushi',
      customList:true,
      stats:()=>{
        const cats=D.expCats||{};
        const xC=Object.entries(cats).filter(([,v])=>!v.isDaromad);
        const dC=Object.entries(cats).filter(([,v])=>v.isDaromad);
        const totalCols=(D.expCols||[]).length;
        return [
          {l:'Xarajat kategoriyalari',v:xC.length+' ta'},
          {l:'Daromad kategoriyalari',v:dC.length+' ta'},
          {l:'Jami ustunlar',v:totalCols+' ta'},
        ];
      },
      buildTable:()=>{
        const cats=D.expCats||{};
        const allCats=Object.entries(cats).sort((a,b)=>sum(b[1].total)-sum(a[1].total));
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>Kategoriya</th><th class="num">Turi</th><th class="num">Ustunlar</th><th class="num">Jami summa</th></tr></thead><tbody>';
        allCats.forEach(([name,cat],i)=>{
          const s=sum(cat.total);
          h+='<tr style="cursor:pointer" onclick="drillModalTo(\'category\',\''+name.replace(/'/g,"\\'")+'\')" title="Ustunlarni ko\'rish"><td>'+(i+1)+'</td><td style="font-weight:600;color:'+p.c1+'">'+name+' â†’</td><td class="num" style="color:'+(cat.isDaromad?'#10B981':'#EF4444')+'">'+
            (cat.isDaromad?'ğŸ’š Daromad':'ğŸ”´ Xarajat')+'</td><td class="num">'+cat.cols.length+'</td><td class="num" style="font-weight:700">'+fmt(s)+'</td></tr>';
        });
        h+='</tbody></table><div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Kategoriya nomini bosing â€” ustunlar ko\'rsatiladi</div>';
        return h;
      },
      buildChart:(canvas)=>{
        const cats=D.expCats||{};
        const xCats=Object.entries(cats).filter(([,v])=>!v.isDaromad).sort((a,b)=>sum(b[1].total)-sum(a[1].total));
        const cc=[p.c1,p.c3,p.c5,p.c4,p.c7,p.c6,p.c8,p.c2,'#e67e22','#1abc9c','#9b59b6','#34495e'];
        return new Chart(canvas,{type:'doughnut',data:{
          labels:xCats.map(([n])=>n.length>25?n.slice(0,22)+'â€¦':n),
          datasets:[{data:xCats.map(([,c])=>sum(c.total)),backgroundColor:cc.slice(0,xCats.length),borderWidth:2,borderColor:p.cardBg,borderRadius:5}]
        },options:{...bOpts({noScales:true,plugins:{legend:{position:'right',labels:{color:p.text,padding:10,font:{size:10}}}}}),cutout:'50%'}});
      },
    },
    expColCount: {
      icon:'ğŸ“‹', color:p.c4, title:'Barcha ustunlar ro\'yxati â€” 69 ta moliyaviy ko\'rsatkich',
      sub:'Har bir ustunning yillik summasi va qaysi kategoriyaga tegishli ekanligi',
      customList:true,
      stats:()=>{
        const cols=D.expCols||[];
        const xCols=cols.filter(c=>!c.isDaromad), dCols=cols.filter(c=>c.isDaromad);
        const topCol=cols.sort((a,b)=>sum(b.data)-sum(a.data))[0];
        return [
          {l:'Xarajat ustunlari',v:xCols.length+' ta'},
          {l:'Daromad ustunlari',v:dCols.length+' ta'},
          {l:'Eng kattasi',v:topCol?(topCol.name.slice(0,22)+'â€¦'):'â€”'},
        ];
      },
      buildTable:()=>{
        const cols=(D.expCols||[]).slice().sort((a,b)=>sum(b.data)-sum(a.data));
        const totalAll=cols.reduce((s,c)=>s+sum(c.data),0);
        let h='<table class="data-table"><thead><tr><th>â„–</th><th>Ustun nomi</th><th style="font-size:.72rem">Kategoriya</th><th class="num">Jami</th><th class="num">Ulush</th></tr></thead><tbody>';
        cols.forEach((c,i)=>{
          const s=sum(c.data), pct=totalAll>0?(s/totalAll*100):0;
          h+='<tr style="cursor:pointer" onclick="drillModalTo(\'column\',\''+c.name.replace(/'/g,"\\'")+'\')" title="Oylik taqsimot va xodimlar"><td style="font-size:.75rem">'+(i+1)+'</td><td style="font-weight:600;font-size:.82rem;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:'+p.c1+'" title="'+c.name.replace(/"/g,'&quot;')+'">'+c.name+' â†’</td><td style="font-size:.72rem;color:var(--text-muted)">'+(c.cat||'â€”')+'</td><td class="num" style="font-weight:700;color:'+(c.isDaromad?'#10B981':p.c1)+'">'+fmt(s)+'</td><td class="num" style="font-size:.78rem">'+pct.toFixed(1)+'%</td></tr>';
        });
        h+='</tbody></table><div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Ustun nomini bosing â€” oylik taqsimot va xodimlar ro\'yxati ko\'rsatiladi</div>';
        return h;
      },
      buildChart:(canvas)=>{
        const cols=(D.expCols||[]).filter(c=>!c.isDaromad).slice().sort((a,b)=>sum(b.data)-sum(a.data)).slice(0,12);
        const cc=[p.c1,p.c3,p.c5,p.c4,p.c7,p.c6,p.c8,p.c2,'#e67e22','#1abc9c','#9b59b6','#34495e'];
        return new Chart(canvas,{type:'bar',data:{
          labels:cols.map(c=>c.name.length>22?c.name.slice(0,20)+'â€¦':c.name),
          datasets:[{label:'Yillik summa',data:cols.map(c=>sum(c.data)),backgroundColor:cc.slice(0,cols.length),borderRadius:6}]
        },options:{...bOpts({plugins:{legend:{display:false}}}),indexAxis:'y'}});
      },
    },
    expNet: {
      icon:'ğŸ“‰', color:p.c7, title:'Sof xarajat â€” xarajat va daromad farqi',
      sub:'Oyma-oy xarajatlar va daromadlar solishtirmasi',
      customList:true,
      stats:()=>{
        const totalX=sum(D.xarajatByMonth||[]), totalD=sum(D.daromadByMonth||[]);
        const net=totalX-totalD;
        const maxNetM=(D.xarajatByMonth||[]).map((v,i)=>v-(D.daromadByMonth||[])[i]);
        const mxi=maxNetM.indexOf(Math.max(...maxNetM));
        return [
          {l:'Jami xarajat',v:fmt(totalX)},
          {l:'Jami daromad',v:fmt(totalD)},
          {l:'Sof xarajat',v:fmt(net)},
        ];
      },
      buildTable:()=>{
        const xM=D.xarajatByMonth||A(12), dM=D.daromadByMonth||A(12);
        let h='<table class="data-table"><thead><tr><th>Oy</th><th class="num">Xarajat</th><th class="num">Daromad</th><th class="num">Sof farq</th></tr></thead><tbody>';
        months.forEach((m,i)=>{
          const net=xM[i]-dM[i];
          h+='<tr style="cursor:pointer" onclick="drillModalTo(\'month\',\''+i+'\')" title="'+m+' oyi kategoriyalarini ko\'rish"><td style="font-weight:600;color:'+p.c1+'">'+m+' â†’</td><td class="num" style="color:#EF4444">'+fmt(xM[i])+'</td><td class="num" style="color:#10B981">'+fmt(dM[i])+'</td><td class="num" style="font-weight:700;color:'+(net>0?'#EF4444':'#10B981')+'">'+fmt(net)+'</td></tr>';
        });
        const tx=sum(xM),td=sum(dM);
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td><td class="num" style="color:#EF4444">'+fmt(tx)+'</td><td class="num" style="color:#10B981">'+fmt(td)+'</td><td class="num">'+fmt(tx-td)+'</td></tr>';
        h+='</tbody></table><div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Oy nomini bosing â€” shu oyning kategoriyalari ko\'rsatiladi</div>';
        return h;
      },
      buildChart:(canvas)=>{
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:[
          {label:'Xarajat',data:D.xarajatByMonth||A(12),backgroundColor:'#EF444488',borderRadius:4,stack:'s1'},
          {label:'Daromad',data:D.daromadByMonth||A(12),backgroundColor:'#10B98188',borderRadius:4,stack:'s2'},
          {label:'Sof farq',data:(D.xarajatByMonth||A(12)).map((v,i)=>v-(D.daromadByMonth||A(12))[i]),type:'line',borderColor:p.c7,backgroundColor:p.c7+'20',fill:false,tension:.4,pointRadius:5,borderWidth:2.5,pointBackgroundColor:p.c7},
        ]},options:bOpts({plugins:{legend:{position:'top'}}})});
      },
    },
    expTopCat: {
      icon:'ğŸ†', color:p.c8, title:'Eng katta xarajat kategoriyasi â€” batafsil',
      sub:'Eng ko\'p xarajat qilingan kategoriya va uning ustunlari â€” ustun nomini bosing',
      customList:true,
      stats:()=>{
        const cats=D.expCats||{};
        const xCats=Object.entries(cats).filter(([,v])=>!v.isDaromad).sort((a,b)=>sum(b[1].total)-sum(a[1].total));
        const top=xCats[0];
        const totalX=sum(D.xarajatByMonth||[]);
        return [
          {l:'Eng kattasi',v:top?top[0]:'â€”'},
          {l:'Summasi',v:top?fmt(sum(top[1].total)):'â€”'},
          {l:'Umumiy ulushi',v:top&&totalX>0?((sum(top[1].total)/totalX*100).toFixed(1)+'%'):'â€”'},
        ];
      },
      buildTable:()=>{
        const cats=D.expCats||{};
        const xCats=Object.entries(cats).filter(([,v])=>!v.isDaromad).sort((a,b)=>sum(b[1].total)-sum(a[1].total));
        const top=xCats[0];
        if(!top) return '<p>Ma\'lumot yo\'q</p>';
        const topCols=(D.expCols||[]).filter(c=>c.cat===top[0]).sort((a,b)=>sum(b.data)-sum(a.data));
        const catTotal=sum(top[1].total);
        let h='<div style="font-weight:700;font-size:1.1rem;margin-bottom:.75rem;color:'+p.c1+'">ğŸ† '+top[0]+' â€” '+top[1].cols.length+' ta ustun</div>';
        h+='<table class="data-table"><thead><tr><th>â„–</th><th>Ustun nomi</th><th class="num">Jami summa</th><th class="num">Ulush</th></tr></thead><tbody>';
        topCols.forEach((c,i)=>{
          const s=sum(c.data), pct=catTotal>0?(s/catTotal*100):0;
          h+='<tr style="cursor:pointer" onclick="drillModalTo(\'column\',\''+c.name.replace(/'/g,"\\'")+'\')" title="Xodimlar ro\'yxatini ko\'rish"><td>'+(i+1)+'</td><td style="font-weight:600;color:'+p.c1+'">'+c.name+' â†’</td><td class="num" style="font-weight:700;color:'+p.c1+'">'+fmt(s)+'</td><td class="num">'+pct.toFixed(1)+'%</td></tr>';
        });
        h+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td>JAMI</td><td class="num">'+fmt(catTotal)+'</td><td class="num">100%</td></tr>';
        h+='</tbody></table><div style="font-size:.78rem;color:var(--text-muted);margin-top:.5rem">ğŸ’¡ Ustun nomini bosing â€” oylik taqsimot va xodimlar ro\'yxati ko\'rsatiladi</div>';
        return h;
      },
      buildChart:(canvas)=>{
        const cats=D.expCats||{};
        const xCats=Object.entries(cats).filter(([,v])=>!v.isDaromad).sort((a,b)=>sum(b[1].total)-sum(a[1].total));
        const top=xCats[0];
        if(!top) return null;
        /* Oylik stacked chart â€” har bir ustunning oylik dinamikasi */
        const topCols=(D.expCols||[]).filter(c=>c.cat===top[0]).sort((a,b)=>sum(b.data)-sum(a.data)).slice(0,8);
        const cc=[p.c1,p.c3,p.c5,p.c4,p.c7,p.c6,p.c8,p.c2];
        const ds=topCols.map((c,i)=>({
          label:c.name.length>22?c.name.slice(0,20)+'â€¦':c.name,
          data:c.data,
          backgroundColor:cc[i%cc.length]+'99',
          borderRadius:2,stack:'s'
        }));
        return new Chart(canvas,{type:'bar',data:{labels:MS,datasets:ds},
          options:bOpts({plugins:{legend:{position:'top',labels:{font:{size:9},padding:6}}},scales:{x:{stacked:true},y:{stacked:true}}})});
      },
    },
  };

  const cfg = configs[type];
  if(!cfg) return;

  /* Fill modal header */
  document.getElementById('modalIcon').style.background=cfg.color+'22';
  document.getElementById('modalIcon').style.color=cfg.color;
  document.getElementById('modalIcon').innerHTML=cfg.icon;
  document.getElementById('modalTitle').textContent=cfg.title;
  document.getElementById('modalSub').textContent=cfg.sub;

  /* Fill stats */
  const stats=cfg.stats();
  document.getElementById('modalStats').innerHTML=stats.map(s=>
    '<div class="modal-stat"><div class="modal-stat-label">'+s.l+'</div><div class="modal-stat-value">'+s.v+'</div></div>'
  ).join('');

  /* Destroy old chart */
  if(modalChart){modalChart.destroy();modalChart=null}

  const canvas=document.getElementById('modalChart');

  /* â”€â”€â”€ CUSTOM LIST MODE (staff, contracts) â”€â”€â”€ */
  if(cfg.customList){
    if(cfg.buildChart){
      canvas.parentElement.style.display='';
      modalChart=cfg.buildChart(canvas);
    } else {
      canvas.parentElement.style.display='none';
    }
    document.getElementById('modalTable').innerHTML=cfg.buildTable?cfg.buildTable():'';
    ov.classList.add('show');
    return;
  }

  /* â”€â”€â”€ SPECIAL: Department horizontal bar chart â”€â”€â”€ */
  canvas.parentElement.style.display='';
  if(cfg.deptChart){
    const dl=Object.keys(D.omborDept), dv=Object.values(D.omborDept);
    const dc=[p.c1,p.c3,p.c4,p.c5,p.c6,p.c7,p.c2,p.c8];
    modalChart=new Chart(canvas,{type:'bar',data:{labels:dl,datasets:[{label:'Chiqim summasi',data:dv,backgroundColor:dc.slice(0,dl.length),borderRadius:6}]},
      options:{...bOpts({plugins:{legend:{display:false}}}),indexAxis:'y'}});

    /* Dept table */
    let tbl='<table class="data-table"><thead><tr><th>#</th><th>Bo\'lim nomi</th><th class="num">Chiqim summasi</th><th>Ulush</th></tr></thead><tbody>';
    const total=dv.reduce((s,v)=>s+v,0);
    dl.forEach((d,i)=>{const pct=(dv[i]/total*100).toFixed(1);tbl+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+d+'</td><td class="num">'+fmtF(dv[i])+" so'm</td><td>"+pct+'%</td></tr>'});
    tbl+='<tr style="background:var(--bg-accent);font-weight:700"><td></td><td>JAMI</td><td class="num">'+fmtF(total)+" so'm</td><td>100%</td></tr></tbody></table>";
    document.getElementById('modalTable').innerHTML=tbl;
    ov.classList.add('show');
    return;
  }

  /* â”€â”€â”€ Build standard chart â”€â”€â”€ */
  const datasets=[{
    label:cfg.title.split(' batafsil')[0].split(' â€” ')[0],
    data:cfg.data,
    backgroundColor:cfg.chartType==='line'?cfg.color+'25':cfg.data.map((v,i)=>{
      const mx=Math.max(...cfg.data);return v===mx&&v>0?cfg.color:cfg.color+'99';
    }),
    borderColor:cfg.color,
    borderWidth:cfg.chartType==='line'?2.5:0,
    fill:cfg.chartType==='line',
    tension:.4,
    pointRadius:cfg.chartType==='line'?5:0,
    pointBackgroundColor:cfg.color,
    borderRadius:cfg.chartType==='bar'?6:0,
    yAxisID:'y',
    order:2,
  }];

  /* Add extra datasets */
  const ex=cfg.extra();
  ex.forEach(e=>{
    datasets.push({
      label:e.label, data:e.data, backgroundColor:e.color+'88',
      borderColor:e.color, borderWidth:cfg.chartType==='line'?2:0,
      fill:false, tension:.4, pointRadius:cfg.chartType==='line'?4:0,
      pointBackgroundColor:e.color, borderRadius:cfg.chartType==='bar'?6:0,
      yAxisID:'y', order:3,
    });
  });

  /* Add extra line for count-based KPIs (shows cost on second axis) */
  let scales;
  let plugins = {
    legend:{labels:{color:p.text,font:{family:"'Source Sans 3'",size:11},usePointStyle:true,padding:12}},
    tooltip:{backgroundColor:p.cardBg,titleColor:p.text,bodyColor:p.text,borderColor:p.grid,borderWidth:1,padding:10,cornerRadius:8,
      titleFont:{family:"'Source Sans 3'",weight:'600'},bodyFont:{family:"'Source Sans 3'"},
      callbacks:{label:ctx=>{const v=ctx.parsed.y!==undefined?ctx.parsed.y:ctx.parsed;return ' '+ctx.dataset.label+': '+(cfg.isCounts&&ctx.datasetIndex===0?v+' ta':fmtF(v)+" so'm")}}},
  };

  /* Average line annotation */
  if(cfg.avgLine){
    const avg=sum(cfg.data)/cfg.data.filter(v=>v>0).length||1;
    datasets.push({
      label:"O'rtacha",data:new Array(12).fill(avg),type:'line',
      borderColor:p.c7,borderWidth:2,borderDash:[8,4],pointRadius:0,
      fill:false,yAxisID:'y',order:1,
    });
  }

  if(cfg.extraLine){
    datasets.push({
      label:cfg.extraLine.label, data:cfg.extraLine.data,
      type:'line', borderColor:cfg.extraLine.color, backgroundColor:cfg.extraLine.color+'20',
      fill:false, tension:.4, pointRadius:4, pointBackgroundColor:cfg.extraLine.color,
      borderWidth:2, yAxisID:'y1', order:1,
    });
    scales={
      y:{position:'left',ticks:{color:p.text,callback:v=>cfg.isCounts?(v+' ta'):fmt(v)},grid:{color:p.grid,lineWidth:.5}},
      y1:{position:'right',ticks:{color:cfg.extraLine.color,callback:v=>fmt(v)},grid:{display:false}},
      x:{ticks:{color:p.text},grid:{color:p.grid,lineWidth:.5}},
    };
  } else {
    scales={
      x:{ticks:{color:p.text,font:{size:11}},grid:{color:p.grid,lineWidth:.5}},
      y:{ticks:{color:p.text,font:{size:11},callback:v=>cfg.isCounts?(v+' ta'):fmt(v)},grid:{color:p.grid,lineWidth:.5},beginAtZero:true},
    };
  }

  modalChart=new Chart(canvas,{
    type:cfg.chartType,
    data:{labels:MS,datasets:datasets},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:plugins,
      scales:scales,
      interaction:{mode:'index',intersect:false},
    },
  });

  /* Build detail table */
  let tbl='<table class="data-table"><thead><tr><th>Oy</th><th class="num">'+cfg.title.split(' batafsil')[0].split(' â€” ')[0]+'</th>';
  const exData=cfg.extra();
  exData.forEach(e=>tbl+='<th class="num">'+e.label+'</th>');
  if(cfg.extraLine)tbl+='<th class="num">'+cfg.extraLine.label+'</th>';
  tbl+='</tr></thead><tbody>';
  const mxVal=Math.max(...cfg.data.filter(v=>v>0));
  months.forEach((m,i)=>{
    const isMax=cfg.data[i]===mxVal&&cfg.data[i]>0;
    tbl+='<tr><td style="font-weight:600">'+m+'</td>';
    tbl+='<td class="num" style="'+(isMax?'color:'+cfg.color+';font-weight:700':'')+'">'+(cfg.isCounts?cfg.data[i]+' ta':(cfg.data[i]>0?fmtF(cfg.data[i])+" so'm":'â€”'))+'</td>';
    exData.forEach(e=>tbl+='<td class="num">'+(e.data[i]>0?fmtF(e.data[i])+" so'm":'â€”')+'</td>');
    if(cfg.extraLine)tbl+='<td class="num">'+(cfg.extraLine.data[i]>0?fmtF(cfg.extraLine.data[i])+" so'm":'â€”')+'</td>';
    tbl+='</tr>';
  });
  tbl+='<tr style="background:var(--bg-accent);font-weight:700"><td>JAMI</td>';
  tbl+='<td class="num">'+(cfg.isCounts?sum(cfg.data)+' ta':fmtF(sum(cfg.data))+" so'm")+'</td>';
  exData.forEach(e=>tbl+='<td class="num">'+fmtF(sum(e.data))+" so'm</td>");
  if(cfg.extraLine)tbl+='<td class="num">'+fmtF(sum(cfg.extraLine.data))+" so'm</td>";
  tbl+='</tr></tbody></table>';

  /* Add department breakdown table for warehouse types */
  if(cfg.deptBreakdown){
    const dl=Object.keys(D.omborDept),dv=Object.values(D.omborDept),total=dv.reduce((s,v)=>s+v,0);
    if(dl.length){
      tbl+='<div style="margin-top:1rem;font-weight:700;font-family:var(--font-display);font-size:.95rem;color:var(--text-primary)">Bo\'limlar bo\'yicha taqsimot:</div>';
      tbl+='<table class="data-table" style="margin-top:.5rem"><thead><tr><th>#</th><th>Bo\'lim</th><th class="num">Summa</th><th class="num">Ulush</th></tr></thead><tbody>';
      dl.forEach((d,i)=>{const pct=(dv[i]/total*100).toFixed(1);tbl+='<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+d+'</td><td class="num">'+fmtF(dv[i])+" so'm</td><td class=\"num\">"+pct+'%</td></tr>'});
      tbl+='</tbody></table>';
    }
  }

  document.getElementById('modalTable').innerHTML=tbl;

  /* Show modal */
  ov.classList.add('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT â€” show empty + prompt to upload
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded',function(){
  D=emptyData();rebuildCharts();
  /* Auto-set today's date in inventory forms */
  const today=new Date().toISOString().split('T')[0];
  const kd=document.getElementById('kirimDate');
  const cd=document.getElementById('chiqimDate');
  if(kd)kd.value=today;
  if(cd)cd.value=today;
});
</script>
</body>
</html>
