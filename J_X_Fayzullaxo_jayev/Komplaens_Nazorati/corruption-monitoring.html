<!DOCTYPE html>
<html lang="uz" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markaziy Bank ‚Äî Korrupsiya Monitoring Tizimi</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&family=Source+Sans+3:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ============================================================
           THEME VARIABLES ‚Äî KUN / TUN
           ============================================================ */
        :root {
            --transition-theme: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-body: #06080f;
            --bg-surface: #0c1020;
            --bg-card: #111730;
            --bg-card-alt: #161d3a;
            --bg-input: #0a0f1f;
            --bg-elevated: #1a2245;
            --border-color: #1e2a52;
            --border-glow: rgba(56, 132, 255, 0.15);
            --text-primary: #eaf0ff;
            --text-secondary: #8b9cc7;
            --text-muted: #4e5f8a;
            --text-inverse: #06080f;
            --accent: #3884ff;
            --accent-soft: rgba(56, 132, 255, 0.12);
            --accent-glow: rgba(56, 132, 255, 0.4);
            --danger: #ff4466;
            --danger-soft: rgba(255, 68, 102, 0.12);
            --warning: #ffaa22;
            --warning-soft: rgba(255, 170, 34, 0.12);
            --success: #22dd88;
            --success-soft: rgba(34, 221, 136, 0.12);
            --purple: #9966ff;
            --purple-soft: rgba(153, 102, 255, 0.12);
            --cyan: #00ccee;
            --cyan-soft: rgba(0, 204, 238, 0.12);
            --gradient-hero: linear-gradient(135deg, #0c1020 0%, #111a3a 50%, #0f1530 100%);
            --glass-bg: rgba(17, 23, 48, 0.7);
            --glass-border: rgba(56, 132, 255, 0.08);
            --shadow-card: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px var(--border-color);
            --shadow-glow: 0 0 40px rgba(56,132,255,0.08);
            --nav-bg: rgba(12, 16, 32, 0.85);
            --particle-color: rgba(56,132,255,0.15);
            --scrollbar-thumb: #1e2a52;
            --table-hover: rgba(56,132,255,0.04);
            --modal-overlay: rgba(0,0,0,0.75);
        }

        [data-theme="light"] {
            --bg-body: #f0f4fa;
            --bg-surface: #ffffff;
            --bg-card: #ffffff;
            --bg-card-alt: #f7f9fd;
            --bg-input: #f0f3fa;
            --bg-elevated: #e8edf8;
            --border-color: #d0d8ea;
            --border-glow: rgba(56, 100, 220, 0.12);
            --text-primary: #1a2340;
            --text-secondary: #5a6888;
            --text-muted: #8a96b0;
            --text-inverse: #ffffff;
            --accent: #2a6adf;
            --accent-soft: rgba(42, 106, 223, 0.08);
            --accent-glow: rgba(42, 106, 223, 0.25);
            --danger: #e03050;
            --danger-soft: rgba(224, 48, 80, 0.08);
            --warning: #d08800;
            --warning-soft: rgba(208, 136, 0, 0.08);
            --success: #18a060;
            --success-soft: rgba(24, 160, 96, 0.08);
            --purple: #7744dd;
            --purple-soft: rgba(119, 68, 221, 0.08);
            --cyan: #0099bb;
            --cyan-soft: rgba(0, 153, 187, 0.08);
            --gradient-hero: linear-gradient(135deg, #f0f4fa 0%, #e4eaf6 50%, #f0f4fa 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(42, 106, 223, 0.1);
            --shadow-card: 0 4px 24px rgba(0,0,0,0.06), 0 0 0 1px var(--border-color);
            --shadow-glow: 0 0 30px rgba(42,106,223,0.05);
            --nav-bg: rgba(255, 255, 255, 0.9);
            --particle-color: rgba(42,106,223,0.08);
            --scrollbar-thumb: #c0c8da;
            --table-hover: rgba(42,106,223,0.03);
            --modal-overlay: rgba(0,0,0,0.4);
        }

        /* ============================================================
           BASE RESET & GLOBAL
           ============================================================ */
        *, *::before, *::after {
            margin: 0; padding: 0; box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Source Sans 3', Georgia, 'Times New Roman', serif;
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background var(--transition-theme), color var(--transition-theme);
        }

        
        /* Serif headings */
        h1, h2, h3, h4, .section-header h2, .card-title {
            font-family: 'Playfair Display', Georgia, 'Times New Roman', serif !important;
        }

        /* ===== ANIMATED BACKGROUND ===== */
        #bgCanvas {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 0;
            pointer-events: none;
        }

        .page-wrapper {
            position: relative;
            z-index: 1;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }

        /* ============================================================
           HEADER
           ============================================================ */
        .header {
            background: var(--nav-bg);
            backdrop-filter: blur(24px) saturate(1.5);
            -webkit-backdrop-filter: blur(24px) saturate(1.5);
            border-bottom: 1px solid var(--border-color);
            padding: 14px 32px;
            position: sticky; top: 0; z-index: 100;
            transition: background var(--transition-theme), border var(--transition-theme);
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .header-inner {
            max-width: 1640px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .logo-area {
            display: flex; align-items: center; gap: 14px;
        }

        .logo-icon {
            width: 46px; height: 46px;
            background: linear-gradient(135deg, var(--accent), var(--purple));
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px var(--accent-glow);
            animation: logoPulse 3s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.15) 50%, transparent 60%);
            animation: logoShine 4s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        @keyframes logoShine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .logo-text h1 {
            font-size: 18px; font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--text-primary), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .logo-text span {
            font-size: 10px; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 2px; font-weight: 500;
        }

        .header-actions {
            display: flex; align-items: center; gap: 16px;
        }

        /* ===== THEME TOGGLE ===== */
        .theme-toggle {
            position: relative;
            width: 64px; height: 32px;
            border-radius: 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.4s ease;
            overflow: hidden;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
            box-shadow: 0 0 12px var(--accent-soft);
        }

        .theme-toggle-knob {
            position: absolute;
            top: 3px;
            width: 24px; height: 24px;
            border-radius: 50%;
            transition: all 0.5s cubic-bezier(0.68, -0.6, 0.32, 1.6);
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
        }

        [data-theme="dark"] .theme-toggle-knob {
            left: 36px;
            background: linear-gradient(135deg, #2a3566, #1a2240);
            box-shadow: 0 0 10px rgba(100,140,255,0.3);
        }

        [data-theme="light"] .theme-toggle-knob {
            left: 3px;
            background: linear-gradient(135deg, #ffd060, #ffaa00);
            box-shadow: 0 0 10px rgba(255,170,0,0.3);
        }

        .theme-toggle-bg {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border-radius: 16px;
            overflow: hidden;
        }

        [data-theme="dark"] .theme-toggle-bg {
            background: linear-gradient(135deg, #0a0f20, #151d40);
        }

        [data-theme="light"] .theme-toggle-bg {
            background: linear-gradient(135deg, #87ceeb, #a8d8ff);
        }

        .toggle-stars {
            position: absolute;
            transition: opacity 0.5s ease;
        }

        [data-theme="dark"] .toggle-stars { opacity: 1; }
        [data-theme="light"] .toggle-stars { opacity: 0; }

        .toggle-star {
            position: absolute;
            width: 2px; height: 2px;
            background: white;
            border-radius: 50%;
        }

        .status-live {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 14px;
            background: var(--success-soft);
            border: 1px solid rgba(34,221,136,0.2);
            border-radius: 20px;
            font-size: 12px; font-weight: 600;
            color: var(--success);
        }

        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: blink 2s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34,221,136,0.5); }
            50% { opacity: 0.6; box-shadow: 0 0 0 6px rgba(34,221,136,0); }
        }

        .clock {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px; font-weight: 500;
            color: var(--text-muted);
        }

        /* ============================================================
           NAVIGATION
           ============================================================ */
        .navbar {
            background: var(--nav-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 0 32px;
            position: sticky; top: 75px; z-index: 99;
            transition: background var(--transition-theme), border var(--transition-theme);
            animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both;
        }

        .nav-inner {
            max-width: 1640px;
            margin: 0 auto;
            display: flex; gap: 2px;
            flex-wrap: wrap;
        }

        .nav-inner::-webkit-scrollbar { display: none; }

        .nav-tab {
            padding: 12px 16px;
            font-size: 13px; font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex; align-items: center; gap: 6px;
            position: relative;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: -1px; left: 50%; right: 50%;
            height: 2px;
            background: var(--accent);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            border-radius: 2px;
        }

        .nav-tab:hover {
            color: var(--text-secondary);
        }

        .nav-tab:hover::after {
            left: 20%; right: 20%;
        }

        .nav-tab.active {
            color: var(--accent);
        }

        .nav-tab.active::after {
            left: 0; right: 0;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .tab-badge {
            background: var(--danger);
            color: white;
            font-size: 9px; font-weight: 700;
            padding: 1px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            animation: badgePop 0.4s cubic-bezier(0.68, -0.6, 0.32, 1.6);
        }

        @keyframes badgePop {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        /* ============================================================
           CONTENT AREA
           ============================================================ */
        .main {
            max-width: 1640px;
            margin: 0 auto;
            padding: 28px 32px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: sectionIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes sectionIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================================
           CARDS ‚Äî GLASSMORPHISM
           ============================================================ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-card);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-glow), transparent);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            border-color: var(--glass-border);
            box-shadow: var(--shadow-card), var(--shadow-glow);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px; padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap; gap: 12px;
        }

        .card-title {
            font-size: 16px; font-weight: 700;
            display: flex; align-items: center; gap: 10px;
            letter-spacing: -0.3px;
        }

        .card-title .icon { font-size: 20px; }

        /* ============================================================
           STATS DASHBOARD
           ============================================================ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 22px;
            display: flex; align-items: flex-start; justify-content: space-between;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            user-select: none;
        }

        .stat-card:active {
            transform: scale(0.97) !important;
            transition-duration: 0.1s;
        }

        .stat-card .click-hint {
            position: absolute;
            bottom: 6px; right: 12px;
            font-size: 9px; font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover .click-hint {
            opacity: 1;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 4px; height: 100%;
            border-radius: 0 4px 4px 0;
            transition: all 0.3s ease;
        }

        .stat-card.blue::before { background: var(--accent); }
        .stat-card.red::before { background: var(--danger); }
        .stat-card.orange::before { background: var(--warning); }
        .stat-card.green::before { background: var(--success); }
        .stat-card.purple::before { background: var(--purple); }

        .stat-card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: var(--shadow-card), var(--shadow-glow);
        }

        .stat-label {
            font-size: 11px; font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px; font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -1px;
            line-height: 1;
        }

        .stat-sub {
            font-size: 11px; font-weight: 500;
            margin-top: 8px;
        }

        .stat-sub.up { color: var(--danger); }
        .stat-sub.ok { color: var(--success); }

        .stat-icon {
            width: 62px; height: 62px;
            border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
            position: relative;
        }

        .stat-icon.i-blue {
            background: linear-gradient(145deg, #60a5fa, #2563eb);
            color: #fff;
            box-shadow: 0 6px 20px rgba(37,99,235,0.35), inset 0 1px 1px rgba(255,255,255,0.2);
        }
        .stat-icon.i-red {
            background: linear-gradient(145deg, #f87171, #dc2626);
            color: #fff;
            box-shadow: 0 6px 20px rgba(220,38,38,0.35), inset 0 1px 1px rgba(255,255,255,0.2);
        }
        .stat-icon.i-orange {
            background: linear-gradient(145deg, #fbbf24, #d97706);
            color: #fff;
            box-shadow: 0 6px 20px rgba(217,119,6,0.35), inset 0 1px 1px rgba(255,255,255,0.2);
        }
        .stat-icon.i-green {
            background: linear-gradient(145deg, #4ade80, #16a34a);
            color: #fff;
            box-shadow: 0 6px 20px rgba(22,163,74,0.35), inset 0 1px 1px rgba(255,255,255,0.2);
        }
        .stat-icon.i-purple {
            background: linear-gradient(145deg, #a78bfa, #7c3aed);
            color: #fff;
            box-shadow: 0 6px 20px rgba(124,58,237,0.35), inset 0 1px 1px rgba(255,255,255,0.2);
        }


        /* Nav tab icon badges */
        .nav-tab .ni {
            width: 26px; height: 26px;
            border-radius: 8px;
            display: inline-flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .nav-tab .ni svg { width: 15px; height: 15px; fill: #fff; }
        .ni.nb { background: linear-gradient(135deg, #60a5fa, #3b82f6); }
        .ni.nr { background: linear-gradient(135deg, #f87171, #ef4444); }
        .ni.no { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .ni.ng { background: linear-gradient(135deg, #4ade80, #22c55e); }
        .ni.np { background: linear-gradient(135deg, #a78bfa, #8b5cf6); }
        .ni.nc { background: linear-gradient(135deg, #67e8f9, #06b6d4); }
        .ni.nk { background: linear-gradient(135deg, #fb923c, #ea580c); }
        .ni.nd { background: linear-gradient(135deg, #818cf8, #6366f1); }
        .ni.nai { background: linear-gradient(135deg, #c084fc, #9333ea); box-shadow: 0 2px 8px rgba(147,51,234,0.3); }

        /* Section header icon badges */
        .sec-badge {
            width: 32px; height: 32px;
            border-radius: 10px;
            display: inline-flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            margin-right: 4px;
            vertical-align: middle;
        }
        .sec-badge svg { width: 18px; height: 18px; fill: #fff; }
        .sec-badge.sb { background: linear-gradient(135deg, #60a5fa, #3b82f6); box-shadow: 0 3px 10px rgba(59,130,246,0.25); }
        .sec-badge.sr { background: linear-gradient(135deg, #f87171, #ef4444); box-shadow: 0 3px 10px rgba(239,68,68,0.25); }
        .sec-badge.so { background: linear-gradient(135deg, #fbbf24, #f59e0b); box-shadow: 0 3px 10px rgba(245,158,11,0.25); }
        .sec-badge.sg { background: linear-gradient(135deg, #4ade80, #22c55e); box-shadow: 0 3px 10px rgba(34,197,94,0.25); }
        .sec-badge.sp { background: linear-gradient(135deg, #a78bfa, #8b5cf6); box-shadow: 0 3px 10px rgba(139,92,246,0.25); }
        .sec-badge.sc { background: linear-gradient(135deg, #67e8f9, #06b6d4); box-shadow: 0 3px 10px rgba(6,182,212,0.25); }
        .sec-badge.sk { background: linear-gradient(135deg, #fb923c, #ea580c); box-shadow: 0 3px 10px rgba(234,88,12,0.25); }

        /* ============================================================
           FORMS
           ============================================================ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
            gap: 16px;
        }

        .fg { margin-bottom: 4px; }

        .fg label {
            display: block;
            font-size: 11px; font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .fg input, .fg select, .fg textarea {
            width: 100%;
            padding: 11px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .fg input:focus, .fg select:focus, .fg textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft), 0 0 20px var(--accent-soft);
        }

        .fg select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b9cc7' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 34px;
        }

        .fg textarea { min-height: 70px; resize: vertical; }

        /* ============================================================
           BUTTONS
           ============================================================ */
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 13px; font-weight: 600;
            font-family: 'Source Sans 3', sans-serif;
            cursor: pointer;
            border: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: inline-flex; align-items: center; gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: width 0.4s ease, height 0.4s ease;
            transform: translate(-50%, -50%);
        }

        .btn:active::after {
            width: 200px; height: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #2a68dd);
            color: white;
            box-shadow: 0 4px 16px var(--accent-glow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px var(--accent-glow);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #cc2244);
            color: white;
            box-shadow: 0 4px 16px rgba(255,68,102,0.25);
        }

        .btn-danger:hover { transform: translateY(-2px); }

        .btn-ghost {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-ghost:hover {
            background: var(--bg-card-alt);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #16a060);
            color: white;
        }

        .btn-sm { padding: 6px 14px; font-size: 12px; border-radius: 8px; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }

        /* ============================================================
           TABLES
           ============================================================ */
        .table-wrap {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%; border-collapse: collapse; font-size: 13px;
        }

        thead { background: var(--bg-input); }

        th {
            padding: 13px 16px;
            text-align: left;
            font-weight: 600; font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(30,42,82,0.3);
            transition: background 0.2s ease;
        }

        tr:hover td { background: var(--table-hover); }
        tr:last-child td { border-bottom: none; }

        .mono {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px; font-weight: 500;
        }

        /* ============================================================
           BADGES & CHIPS
           ============================================================ */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px; font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            display: inline-flex; align-items: center; gap: 4px;
        }

        .badge-critical {
            background: var(--danger-soft);
            color: var(--danger);
            border: 1px solid rgba(255,68,102,0.2);
        }

        .badge-high {
            background: var(--warning-soft);
            color: var(--warning);
            border: 1px solid rgba(255,170,34,0.2);
        }

        .badge-medium {
            background: var(--purple-soft);
            color: var(--purple);
            border: 1px solid rgba(153,102,255,0.2);
        }

        .badge-low {
            background: var(--success-soft);
            color: var(--success);
            border: 1px solid rgba(34,221,136,0.2);
        }

        .chip {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px; font-weight: 500;
            margin: 2px;
        }

        .chip-red { background: var(--danger-soft); color: var(--danger); }
        .chip-green { background: var(--success-soft); color: var(--success); }
        .chip-orange { background: var(--warning-soft); color: var(--warning); }
        .chip-blue { background: var(--accent-soft); color: var(--accent); }
        .chip-purple { background: var(--purple-soft); color: var(--purple); }

        .conflict-yes { background: var(--danger-soft); color: var(--danger); padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .conflict-no { background: var(--success-soft); color: var(--success); padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }

        /* ============================================================
           ALERTS
           ============================================================ */
        .alert {
            padding: 14px 18px;
            border-radius: 12px;
            margin-bottom: 14px;
            display: flex; align-items: flex-start; gap: 12px;
            font-size: 13px; line-height: 1.5;
            animation: alertIn 0.4s ease;
        }

        @keyframes alertIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .alert-icon { font-size: 18px; flex-shrink: 0; }
        .alert-danger { background: var(--danger-soft); border: 1px solid rgba(255,68,102,0.15); color: var(--danger); }
        .alert-warning { background: var(--warning-soft); border: 1px solid rgba(255,170,34,0.15); color: var(--warning); }
        .alert-info { background: var(--accent-soft); border: 1px solid rgba(56,132,255,0.15); color: var(--accent); }
        .alert-success { background: var(--success-soft); border: 1px solid rgba(34,221,136,0.15); color: var(--success); }

        /* ============================================================
           SCORE METER
           ============================================================ */
        .score-meter { text-align: center; padding: 10px; }

        .score-circle-wrap {
            width: 180px; height: 180px;
            margin: 0 auto 16px;
            position: relative;
            display: flex; align-items: center; justify-content: center;
        }

        .score-circle-wrap svg {
            position: absolute; top: 0; left: 0;
            transform: rotate(-90deg);
        }

        .score-number {
            font-size: 48px; font-weight: 900;
            font-family: 'JetBrains Mono', monospace;
            z-index: 1;
            letter-spacing: -2px;
        }

        .score-bar-item { margin: 14px 0; }

        .score-bar-top {
            display: flex; justify-content: space-between;
            font-size: 12px; margin-bottom: 6px;
        }

        .score-bar-top span:first-child { color: var(--text-secondary); }
        .score-bar-top span:last-child { font-family: 'JetBrains Mono'; font-weight: 600; }

        .score-bar-bg {
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%; border-radius: 4px;
            transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* ============================================================
           MONITORING
           ============================================================ */
        .monitor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .monitor-card {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 18px;
            transition: all 0.3s ease;
        }

        .monitor-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .monitor-card-head {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }

        /* ============================================================
           TIMELINE
           ============================================================ */
        .timeline { position: relative; padding-left: 32px; }

        .timeline::before {
            content: '';
            position: absolute; left: 8px; top: 0; bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--accent), var(--border-color));
        }

        .tl-item {
            position: relative;
            margin-bottom: 18px;
            padding: 14px 18px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            animation: alertIn 0.4s ease;
        }

        .tl-item::before {
            content: '';
            position: absolute; left: -28px; top: 18px;
            width: 10px; height: 10px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent-glow);
        }

        .tl-item.flagged::before { background: var(--danger); box-shadow: 0 0 8px rgba(255,68,102,0.4); }

        .tl-date { font-size: 11px; color: var(--text-muted); font-family: 'JetBrains Mono'; margin-bottom: 4px; }
        .tl-text { font-size: 13px; color: var(--text-secondary); line-height: 1.6; }

        /* ============================================================
           LAYOUT
           ============================================================ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }

        @media (max-width: 1024px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .header, .navbar { padding-left: 16px; padding-right: 16px; }
            .main { padding: 16px; }
        }

        @media (max-width: 768px) {
            .stats-row { grid-template-columns: 1fr 1fr; }
            .form-grid { grid-template-columns: 1fr; }
        }

        /* ============================================================
           MODAL
           ============================================================ */
        .modal-overlay {
            display: none;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--modal-overlay);
            z-index: 1000;
            align-items: center; justify-content: center;
            backdrop-filter: blur(6px);
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 28px;
            max-width: 720px; width: 92%;
            max-height: 85vh; overflow-y: auto;
            box-shadow: 0 24px 80px rgba(0,0,0,0.5);
            animation: modalPop 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-head {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: var(--bg-elevated); border: 1px solid var(--border-color);
            color: var(--text-muted); cursor: pointer;
            font-size: 18px; width: 36px; height: 36px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--danger-soft); color: var(--danger);
            border-color: rgba(255,68,102,0.3);
        }

        /* ============================================================
           TOAST NOTIFICATIONS
           ============================================================ */
        .toast-container {
            position: fixed; top: 90px; right: 24px;
            z-index: 9999;
            display: flex; flex-direction: column; gap: 8px;
        }

        .toast {
            padding: 14px 20px;
            border-radius: 14px;
            font-size: 13px; font-weight: 500;
            max-width: 420px;
            display: flex; align-items: center; gap: 10px;
            animation: toastIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(12px);
            cursor: pointer;
        }

        .toast:hover { transform: translateX(-4px); }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100px) scale(0.8); }
            to { opacity: 1; transform: translateX(0) scale(1); }
        }

        @keyframes toastOut {
            to { opacity: 0; transform: translateX(100px) scale(0.8); }
        }

        .toast-success { background: var(--success-soft); border: 1px solid rgba(34,221,136,0.2); color: var(--success); box-shadow: 0 8px 32px rgba(34,221,136,0.15); }
        .toast-danger { background: var(--danger-soft); border: 1px solid rgba(255,68,102,0.2); color: var(--danger); box-shadow: 0 8px 32px rgba(255,68,102,0.15); }
        .toast-warning { background: var(--warning-soft); border: 1px solid rgba(255,170,34,0.2); color: var(--warning); box-shadow: 0 8px 32px rgba(255,170,34,0.15); }
        .toast-info { background: var(--accent-soft); border: 1px solid rgba(56,132,255,0.2); color: var(--accent); box-shadow: 0 8px 32px rgba(56,132,255,0.15); }

        /* ============================================================
           DELETE CONFIRM ‚Äî animated
           ============================================================ */
        .delete-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }

        .delete-overlay.show { display: flex; }

        .delete-dialog {
            background: var(--bg-card);
            border: 1px solid var(--danger);
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            max-width: 400px;
            animation: modalPop 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .delete-dialog .del-icon {
            width: 64px; height: 64px;
            margin: 0 auto 16px;
            background: var(--danger-soft);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px;
            animation: shake 0.5s ease 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(-8deg); }
            75% { transform: rotate(8deg); }
        }

        /* ============================================================
           EMPTY STATE
           ============================================================ */
        .empty {
            text-align: center; padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty .e-icon {
            font-size: 48px; margin-bottom: 12px; opacity: 0.3;
        }

        /* Stagger animation for cards */
        .stagger > * {
            animation: sectionIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        .stagger > *:nth-child(1) { animation-delay: 0s; }
        .stagger > *:nth-child(2) { animation-delay: 0.08s; }
        .stagger > *:nth-child(3) { animation-delay: 0.16s; }
        .stagger > *:nth-child(4) { animation-delay: 0.24s; }
        .stagger > *:nth-child(5) { animation-delay: 0.32s; }

        /* Search input in header */
        .search-box {
            padding: 8px 14px 8px 34px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 13px; font-family: 'Source Sans 3', sans-serif;
            width: 220px;
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%234e5f8a' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent);
            width: 280px;
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        /* ============================================================
           COUNTER ANIMATION
           ============================================================ */
        .counting { transition: none; }
    </style>
</head>
<body>

<!-- ANIMATED BG CANVAS -->
<canvas id="bgCanvas"></canvas>

<div class="page-wrapper">

<!-- ===== HEADER ===== -->
<header class="header">
    <div class="header-inner">
        <div class="logo-area">
            <div class="logo-icon">üõ°</div>
            <div class="logo-text">
                <h1>Markaziy Bank ‚Äî Korrupsiya Monitoring</h1>
                <span>O'zbekiston Respublikasi Markaziy banki ‚Ä¢ Compliance & Conflict of Interest</span>
            </div>
        </div>
        <div class="header-actions">
            <div class="status-live">
                <div class="status-dot"></div>
                Tizim faol
            </div>
            <div class="theme-toggle" onclick="toggleTheme()" title="Kun / Tun rejimi">
                <div class="theme-toggle-bg">
                    <div class="toggle-stars">
                        <div class="toggle-star" style="top:6px;left:8px;"></div>
                        <div class="toggle-star" style="top:18px;left:20px;"></div>
                        <div class="toggle-star" style="top:8px;left:38px;"></div>
                        <div class="toggle-star" style="top:20px;left:48px;width:1px;height:1px;"></div>
                    </div>
                </div>
                <div class="theme-toggle-knob">
                    <span id="themeIcon">üåô</span>
                </div>
            </div>
            <div class="clock" id="clock"></div>
        </div>
    </div>
</header>

<!-- ===== NAV ===== -->
<nav class="navbar">
    <div class="nav-inner" id="navInner">
        <div class="nav-tab active" data-tab="dashboard"><span class="ni nb"><svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg></span> Boshqaruv paneli</div>
        <div class="nav-tab" data-tab="employees"><span class="ni nb"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></span> Xodimlar</div>
        <div class="nav-tab" data-tab="declaration"><span class="ni np"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13zM8 15h8v2H8v-2zm0-4h8v2H8v-2z"/></svg></span> Deklaratsiya</div>
        <div class="nav-tab" data-tab="relatives"><span class="ni nc"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></span> Yaqinlar</div>
        <div class="nav-tab" data-tab="credits"><span class="ni no"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg></span> Kreditlar</div>
        <div class="nav-tab" data-tab="property"><span class="ni ng"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span> Mol-mulk</div>
        <div class="nav-tab" data-tab="travel"><span class="ni nc"><svg viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg></span> Chet el safari</div>
        <div class="nav-tab" data-tab="procurement"><span class="ni nk"><svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1 1 0 0 0 22 5H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg></span> Xaridlar</div>
        <div class="nav-tab" data-tab="accounts"><span class="ni ng"><svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg></span> Hisoblar <span class="tab-badge" id="accBadge" style="display:none">0</span></div>
        <div class="nav-tab" data-tab="scoring"><span class="ni no"><svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></span> Scoring</div>
        <div class="nav-tab" data-tab="monitoring"><span class="ni nb"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></span> Monitoring</div>
        <div class="nav-tab" data-tab="gifts"><span class="ni nr"><svg viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-2 .89-2 2v11c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/></svg></span> Sovg'alar</div>
        <div class="nav-tab" data-tab="contracts"><span class="ni nd"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg></span> Kontraktlar</div>
        <div class="nav-tab" data-tab="whistleblower"><span class="ni nr"><svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/></svg></span> Whistleblower <span class="tab-badge" id="wbBadge" style="display:none">0</span></div>
        <div class="nav-tab" data-tab="ai" style="background:linear-gradient(135deg,rgba(56,132,255,0.08),rgba(153,102,255,0.08));border-radius:8px 8px 0 0;font-weight:700;"><span class="ni nai"><svg viewBox="0 0 24 24"><path d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1s-2.73 7.08 0 9.79 7.15 2.71 9.88 0A6.98 6.98 0 0 0 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.53-9.11-.02-12.58s9.14-3.47 12.65 0L21 3v7.12z"/></svg></span> AI Tahlil <span class="tab-badge" id="aiBadge" style="display:none">0</span></div>
    </div>
</nav>

<!-- ===== TOAST CONTAINER ===== -->
<div class="toast-container" id="toasts"></div>

<!-- ===== DELETE CONFIRM ===== -->
<div class="delete-overlay" id="deleteOverlay">
    <div class="delete-dialog">
        <div class="del-icon">üóëÔ∏è</div>
        <h3 style="margin-bottom:8px;font-size:18px;">O'chirishni tasdiqlang</h3>
        <p id="deleteMsg" style="font-size:13px;color:var(--text-secondary);margin-bottom:24px;"></p>
        <div style="display:flex;gap:10px;justify-content:center;">
            <button class="btn btn-ghost" onclick="closeDelete()">Bekor qilish</button>
            <button class="btn btn-danger" id="deleteConfirmBtn">O'chirish</button>
        </div>
    </div>
</div>

<!-- ===== MODAL ===== -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-head">
            <h3 id="modalTitle" style="font-size:17px;font-weight:700;"></h3>
            <button class="modal-close" onclick="closeModal()">‚úï</button>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<!-- ===== MAIN ===== -->
<main class="main">

    <!-- DASHBOARD -->
    <div class="section active" id="sec-dashboard">
        <!-- IMPORT/EXPORT BAR -->
        <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center;">
            <button class="btn btn-primary" onclick="exportToExcel()" style="font-size:13px;padding:10px 20px;background:linear-gradient(135deg,#22883a,#1a6b2e);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;vertical-align:middle;"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg> Excel Export (barcha ma'lumotlar)
            </button>
            <label class="btn btn-ghost" style="font-size:13px;padding:10px 20px;cursor:pointer;border:1px dashed var(--accent);position:relative;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;vertical-align:middle;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg> Excel Import
                <input type="file" accept=".xlsx,.xls,.csv" onchange="importFromExcel(this)" style="position:absolute;inset:0;opacity:0;cursor:pointer;">
            </label>
            <span style="font-size:11px;color:var(--text-muted);margin-left:8px;"><span class="sec-badge sb"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg></span> Export ‚Äî barcha jadvallar va AI tahlil natijalarini .xlsx faylga saqlaydi. Import ‚Äî Excel fayldan ma'lumotlarni yuklaydi.</span>
        </div>
        <div class="stats-row stagger">
            <div class="stat-card blue" onclick="openStatDetail('employees')">
                <div>
                    <div class="stat-label">Jami xodimlar</div>
                    <div class="stat-value" id="sTotal">0</div>
                    <div class="stat-sub ok">Faol monitoring</div>
                </div>
                <div class="stat-icon i-blue"><svg width="30" height="30" viewBox="0 0 24 24" fill="#fff" stroke="none"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
                <span class="click-hint">Batafsil ‚Üí</span>
            </div>
            <div class="stat-card red" onclick="openStatDetail('conflicts')">
                <div>
                    <div class="stat-label">To'qnashuvlar</div>
                    <div class="stat-value" id="sConflict">0</div>
                    <div class="stat-sub up">Aniqlangan</div>
                </div>
                <div class="stat-icon i-red"><svg width="30" height="30" viewBox="0 0 24 24" fill="#fff" stroke="none"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg></div>
                <span class="click-hint">Batafsil ‚Üí</span>
            </div>
            <div class="stat-card orange" onclick="openStatDetail('suspicious')">
                <div>
                    <div class="stat-label">Shubhali</div>
                    <div class="stat-value" id="sSuspicious">0</div>
                    <div class="stat-sub up">Tekshirish kerak</div>
                </div>
                <div class="stat-icon i-orange"><svg width="30" height="30" viewBox="0 0 24 24" fill="#fff" stroke="none"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></div>
                <span class="click-hint">Batafsil ‚Üí</span>
            </div>
            <div class="stat-card red" onclick="openStatDetail('critical')">
                <div>
                    <div class="stat-label">Kritik xavf</div>
                    <div class="stat-value" id="sCritical">0</div>
                    <div class="stat-sub up">Yuqori risk</div>
                </div>
                <div class="stat-icon i-red"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c1.1 0 2-.9 2-2H10c0 1.1.9 2 2 2z"/><path d="M18 16v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5S10.5 3.17 10.5 4v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg></div>
                <span class="click-hint">Batafsil ‚Üí</span>
            </div>
            <div class="stat-card purple" onclick="openStatDetail('avgScore')">
                <div>
                    <div class="stat-label">O'rtacha Bal</div>
                    <div class="stat-value" id="sAvg">0</div>
                    <div class="stat-sub">100 ballik shkala</div>
                </div>
                <div class="stat-icon i-purple"><svg width="30" height="30" viewBox="0 0 24 24" fill="#fff" stroke="none"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg></div>
                <span class="click-hint">Batafsil ‚Üí</span>
            </div>
        </div>

        <div class="grid-2 stagger">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="sec-badge sr"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg></span> So'nggi ogohlantirishlar</div>
                </div>
                <div id="dashAlerts"><div class="empty"><div class="e-icon">üì≠</div><p>Hozircha ogohlantirishlar yo'q</p></div></div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span class="sec-badge sr"><svg viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg></span> Yuqori riskli xodimlar</div>
                </div>
                <div id="dashHigh"><div class="empty"><div class="e-icon">‚úÖ</div><p>Hamma xavfsiz</p></div></div>
            </div>
        </div>
    </div>

    <!-- EMPLOYEES -->
    <div class="section" id="sec-employees">
        <div class="card">
            <div class="card-header">
                <div class="card-title"><span class="sec-badge sb"><svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></span> Yangi xodim qo'shish</div>
            </div>
            <div class="form-grid">
                <div class="fg"><label>F.I.O</label><input type="text" id="eFio" placeholder="Turdiyev Alisher Rustamovich"></div>
                <div class="fg"><label>Lavozimi</label><input type="text" id="ePos" placeholder="Kredit bo'limi boshlig'i"></div>
                <div class="fg"><label>Bo'lim</label>
                    <select id="eDep">
                        <option value="">Bo'limni tanlang...</option>
                        <option>Ijro apparati</option>
                        <option>Iste'molchilar huquqlarini himoya qilish sho'basi</option>
                        <option>Naqd pul muomalasi boshqarmasi</option>
                        <option>Naqd pul va to'lov monitoring bo'limi</option>
                        <option>Qimmatliklarni tashish bo'limi</option>
                        <option>Buxgalteriya va moliyaviy-iqtisodiy boshqarma</option>
                        <option>To'lov tizimlari va AT bo'limi</option>
                        <option>Narxlar va iqtisodiy kutilmalar bo'limi</option>
                        <option>Hududlarni monitoring qilish bo'limi</option>
                        <option>Tadbirkorlikni qo'llab-quvvatlash bo'limi</option>
                        <option>Moliyaviy monitoring va valyuta nazorati bo'limi</option>
                        <option>Xavfsizlik va axborot muhofazasi sho'basi</option>
                        <option>Kredit tashkilotlarini inspeksiya boshqarmasi</option>
                        <option>Muammoli aktivlar va moliyaviy tahlil bo'limi</option>
                        <option>Ichki audit</option>
                        <option>Compliance</option>
                        <option>Rahbariyat</option>
                    </select>
                </div>
                <div class="fg"><label>Oylik maosh (so'm)</label><input type="number" id="eSal" placeholder="15000000"></div>
                <div class="fg"><label>Ishga kirgan sana</label><input type="date" id="eDate"></div>
                <div class="fg"><label>Telefon</label><input type="text" id="ePhone" placeholder="+998 90 123 45 67"></div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addEmployee()">‚ûï Xodim qo'shish</button>
                <button class="btn btn-ghost" onclick="clearEmpForm()">üóë Tozalash</button>
            </div>
        </div>
        <div style="margin:16px 0;position:relative;">
            <span style="position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:18px;opacity:0.5;">üîç</span>
            <input type="text" id="empSearch" class="input" placeholder="Xodim qidirish..." oninput="renderEmpTable()" style="padding-left:48px;font-size:15px;height:52px;border-radius:16px;background:var(--bg-card);border:1px solid var(--border-color);">
        </div>
        <div id="empCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;"></div>
    </div>

    <!-- DECLARATION -->
    <div class="section" id="sec-declaration">
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="sec-badge sp"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm-1 7V3.5L18.5 9H13zM8 15h8v2H8v-2zm0-4h8v2H8v-2z"/></svg></span> Manfaatlar to'qnashuvi deklaratsiyasi</div></div>
            <div class="form-grid">
                <div class="fg"><label>Xodim</label><select id="dEmp"><option value="">Tanlang...</option></select></div>
                <div class="fg"><label>Sana</label><input type="date" id="dDate"></div>
            </div>
            <h4 style="font-size:13px;margin:18px 0 10px;color:var(--accent);font-weight:700;">1. Yaqinlari bank tizimida ishlaydi?</h4>
            <div class="form-grid">
                <div class="fg"><label>Holat</label><select id="dRelBank"><option value="no">Mavjud emas</option><option value="yes">Mavjud</option></select></div>
                <div class="fg"><label>Tafsilot</label><input type="text" id="dRelDetail" placeholder="Ismi ‚Äî Bank nomi"></div>
                <div class="fg"><label>Darajasi</label><select id="dRelDeg"><option value="">Tanlang...</option><option>Turmush o'rtog'i</option><option>Ota/Ona</option><option>Aka/Uka</option><option>Opa/Singil</option><option>Farzand</option><option>Boshqa</option></select></div>
            </div>
            <h4 style="font-size:13px;margin:18px 0 10px;color:var(--accent);font-weight:700;">2. Korxona ustav fondida ulush</h4>
            <div class="form-grid">
                <div class="fg"><label>Holat</label><select id="dShare"><option value="no">Mavjud emas</option><option value="self">O'zimning</option><option value="rel">Qarindoshning</option><option value="both">Ikkalamizning</option></select></div>
                <div class="fg"><label>Tafsilot</label><input type="text" id="dShareDetail" placeholder="Korxona ‚Äî %"></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="saveDecl()">üíæ Saqlash</button></div>
        </div>
        <div id="declCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px;margin-top:16px;"></div>
    </div>

    <!-- RELATIVES -->
    <div class="section" id="sec-relatives">
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="sec-badge sc"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></span> Yaqin qarindosh qo'shish</div></div>
            <div class="form-grid">
                <div class="fg"><label>Xodim</label><select id="rEmp"><option value="">Tanlang...</option></select></div>
                <div class="fg"><label>Qarindosh F.I.O</label><input type="text" id="rFio" placeholder="Ism"></div>
                <div class="fg"><label>Darajasi</label><select id="rDeg"><option value="">Tanlang...</option><option>Turmush o'rtog'i</option><option>Ota</option><option>Ona</option><option>Aka</option><option>Uka</option><option>Opa</option><option>Singil</option><option>Farzand</option><option>Qaynota</option><option>Qaynona</option></select></div>
                <div class="fg"><label>Ish joyi</label><input type="text" id="rWork" placeholder="Bank yoki tashkilot"></div>
                <div class="fg"><label>Bank tizimida?</label><select id="rInBank"><option value="no">Yo'q</option><option value="yes">Ha</option></select></div>
                <div class="fg"><label>Ustav ulushi</label><input type="text" id="rShare" placeholder="Korxona ‚Äî %"></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="addRelative()">‚ûï Qo'shish</button></div>
        </div>
        <div id="relCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px;margin-top:16px;"></div>
    </div>

    <!-- CREDITS -->
    <div class="section" id="sec-credits">
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="sec-badge so"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg></span> Kredit ma'lumoti</div></div>
            <div class="form-grid">
                <div class="fg"><label>Xodim</label><select id="cEmp"><option value="">Tanlang...</option></select></div>
                <div class="fg"><label>Kredit turi</label><select id="cType"><option value="">Tanlang...</option><option>Iste'mol</option><option>Ipoteka</option><option>Avtokredit</option><option>Biznes</option><option>Kredit karta</option></select></div>
                <div class="fg"><label>Summa (so'm)</label><input type="number" id="cAmt" placeholder="100000000"></div>
                <div class="fg"><label>Kredit olingan sana</label><input type="date" id="cDate"></div>
                <div class="fg"><label>Kredit bergan bank</label><input type="text" id="cBank" placeholder="Xalq banki, Ipoteka bank..."></div>
                <div class="fg"><label>Xodim tekshirgan bank</label><input type="text" id="cInsp" placeholder="Tekshirilgan bank nomi"></div>
                <div class="fg"><label>Tekshiruv tugagan sana</label><input type="date" id="cInspDate"></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="addCredit()">‚ûï Qo'shish</button></div>
        </div>
        <div id="credCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px;margin-top:16px;"></div>
    </div>

    <!-- PROPERTY -->
    <div class="section" id="sec-property">
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="sec-badge sg"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span> Mol-mulk</div></div>
            <div class="form-grid">
                <div class="fg"><label>Xodim</label><select id="pEmp"><option value="">Tanlang...</option></select></div>
                <div class="fg"><label>Egasi</label><select id="pOwner"><option value="self">O'zi</option><option value="rel">Qarindosh</option></select></div>
                <div class="fg"><label>Qarindosh F.I.O</label><input type="text" id="pRelName" placeholder=""></div>
                <div class="fg"><label>Turi</label><select id="pType"><option value="">Tanlang...</option><option>Kvartira</option><option>Uy</option><option>Yer</option><option>Avtomobil</option><option>Tijorat binosi</option></select></div>
                <div class="fg"><label>Qiymati (so'm)</label><input type="number" id="pVal" placeholder="500000000"></div>
                <div class="fg"><label>Sana</label><input type="date" id="pDate"></div>
                <div class="fg"><label>Kredit bilan bog'liq?</label><select id="pCreditLink"><option value="no">Yo'q</option><option value="yes">Ha ‚Äî bir oyda</option></select></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="addProperty()">‚ûï Qo'shish</button></div>
        </div>
        <div id="propCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px;margin-top:16px;"></div>
    </div>

    <!-- TRAVEL -->
    <div class="section" id="sec-travel">
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="sec-badge sc"><svg viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg></span> Chet el safari</div></div>
            <div class="form-grid">
                <div class="fg"><label>Xodim</label><select id="tEmp"><option value="">Tanlang...</option></select></div>
                <div class="fg"><label>Sayohatchi</label><select id="tWho"><option value="self">O'zi</option><option value="rel">Qarindosh</option></select></div>
                <div class="fg"><label>Qarindosh ismi</label><input type="text" id="tRelName" placeholder=""></div>
                <div class="fg"><label>Davlat</label><input type="text" id="tCountry" placeholder="BAA, Turkiya..."></div>
                <div class="fg"><label>Chiqish</label><input type="date" id="tOut"></div>
                <div class="fg"><label>Qaytish</label><input type="date" id="tIn"></div>
                <div class="fg"><label>Maqsad</label><select id="tPurpose"><option value="">Tanlang...</option><option>Xizmat</option><option>Dam olish</option><option>Davolanish</option><option>Ta'lim</option></select></div>
                <div class="fg"><label>Xarajat (so'm)</label><input type="number" id="tCost" placeholder="50000000"></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="addTravel()">‚ûï Qo'shish</button></div>
        </div>
        <div id="travelCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px;margin-top:16px;"></div>
    </div>

    <!-- PROCUREMENT ‚Äî Card-based redesign -->
    <div class="section" id="sec-procurement">
        <div class="section-header" style="display:flex;align-items:center;gap:14px;margin-bottom:0;">
            <span style="font-size:36px;">üì¶</span>
            <div>
                <h2 style="font-size:24px;font-weight:900;">Xaridlar Tekshiruvi</h2>
                <p style="font-size:13px;color:var(--text-secondary);">Tender, kontrakt va yetkazib beruvchilarni nazorat qilish</p>
            </div>
        </div>

        <!-- Search Bar -->
        <div style="margin:16px 0;">
            <div style="position:relative;">
                <span style="position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:18px;opacity:0.5;">üîç</span>
                <input type="text" id="procSearch" class="input" placeholder="Xarid yoki yetkazib beruvchi qidirish..." oninput="renderProcCards()" style="padding-left:48px;font-size:15px;height:52px;border-radius:16px;background:var(--bg-card);border:1px solid var(--border-color);">
            </div>
        </div>

        <!-- Add New Procurement (collapsible) -->
        <details style="margin-bottom:16px;">
            <summary class="btn btn-ghost" style="cursor:pointer;font-size:13px;padding:10px 20px;display:inline-flex;align-items:center;gap:8px;border:1px dashed var(--accent);border-radius:12px;">
                ‚ûï Yangi xarid qo'shish
            </summary>
            <div class="card" style="margin-top:10px;">
                <div class="form-grid">
                    <div class="fg"><label>Mas'ul xodim</label><select id="prEmp"><option value="">Tanlang...</option></select></div>
                    <div class="fg"><label>Xarid nomi</label><input type="text" id="prTitle" placeholder="Server uskunalari xaridi"></div>
                    <div class="fg"><label>Yetkazib beruvchi</label><input type="text" id="prOrg" placeholder="TechSupply LLC"></div>
                    <div class="fg"><label>Summa (so'm)</label><input type="number" id="prAmt" placeholder="450000000"></div>
                    <div class="fg"><label>Sana</label><input type="date" id="prDate"></div>
                    <div class="fg"><label>Kategoriya</label><select id="prType"><option value="IT uskunalari">IT uskunalari</option><option value="Ofis jihozlari">Ofis jihozlari</option><option value="Dasturiy ta'minot">Dasturiy ta'minot</option><option value="Qurilish">Qurilish</option><option value="Xizmatlar">Xizmatlar</option><option value="Transport">Transport</option><option value="Boshqa">Boshqa</option></select></div>
                    <div class="fg"><label>Takliflar soni</label><input type="number" id="prBids" value="3" min="0"></div>
                    <div class="fg"><label>Oldingi xaridlar soni</label><input type="number" id="prPrev" value="0" min="0"></div>
                    <div class="fg"><label>Holat</label><select id="prStatus"><option value="investigating">üîç Tekshirilmoqda</option><option value="approved">‚úÖ Tasdiqlangan</option><option value="pending">‚è≥ Kutilmoqda</option><option value="rejected">‚ùå Rad etilgan</option></select></div>
                </div>
                <button class="btn btn-primary" onclick="addProcurement()" style="margin-top:12px;">üíæ Saqlash</button>
            </div>
        </details>

        <!-- Cards Grid -->
        <div id="procCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:16px;"></div>
        <div id="procEmpty" style="display:none;">
            <div class="empty" style="padding:50px;"><div class="e-icon">üì¶</div><p>Hali xarid mavjud emas</p></div>
        </div>
    </div>

    <!-- ACCOUNTS -->
    <div class="section" id="sec-accounts">
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="sec-badge sg"><svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg></span> Hisob monitoring (5x qoidasi)</div></div>
            <div class="alert alert-info"><span class="alert-icon">‚ÑπÔ∏è</span><div>Balans oylik maoshdan <strong>5 baravar</strong> oshsa, avtomatik ogohlantirish + qayta monitoring ishga tushadi.</div></div>
            <div class="form-grid">
                <div class="fg"><label>Xodim</label><select id="aEmp" onchange="loadSalary()"><option value="">Tanlang...</option></select></div>
                <div class="fg"><label>Hisob/Karta</label><input type="text" id="aNum" placeholder="8600 **** **** 1234"></div>
                <div class="fg"><label>Balans (so'm)</label><input type="number" id="aBal" placeholder="95000000"></div>
                <div class="fg"><label>Oy</label><input type="month" id="aMonth"></div>
                <div class="fg"><label>Maosh</label><input type="number" id="aSal" readonly></div>
                <div class="fg"><label>5x chegara</label><input type="text" id="a5x" readonly style="color:var(--warning);font-weight:600;"></div>
            </div>
            <div class="btn-group"><button class="btn btn-primary" onclick="addAccount()">üîç Tekshirish</button></div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="sec-badge sr"><svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></span> Balans ogohlantirishlari</div></div>
            <div id="accAlerts"></div>
            <div id="accCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px;margin-top:16px;"></div>
        </div>
    </div>

    <!-- SCORING -->
    <div class="section" id="sec-scoring">
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="icon">‚ö°</span> Corruption & Conflict Scoring</div></div>
            <div class="alert alert-info"><span class="alert-icon">üìê</span><div>Faqat <strong>Corruption</strong> va <strong>Conflict of Interest</strong>. AML / Sanction / PEP kirmaydi. 0‚Äì100 ball.</div></div>
            <div class="fg" style="max-width:400px;"><label>Xodim</label><select id="scEmp" onchange="calcScore()"><option value="">Tanlang...</option></select></div>
            <div id="scoreResult" style="display:none;">
                <div class="grid-2" style="margin-top:20px;">
                    <div class="score-meter">
                        <div class="score-circle-wrap">
                            <svg width="180" height="180" viewBox="0 0 180 180">
                                <circle cx="90" cy="90" r="78" fill="none" stroke="var(--border-color)" stroke-width="12" opacity="0.3"/>
                                <circle cx="90" cy="90" r="78" fill="none" id="scArc" stroke="var(--accent)" stroke-width="12" stroke-dasharray="490" stroke-dashoffset="490" stroke-linecap="round" style="transition:stroke-dashoffset 1.2s cubic-bezier(0.16,1,0.3,1),stroke 0.5s ease;"/>
                            </svg>
                            <div class="score-number" id="scVal">0</div>
                        </div>
                        <div id="scLevel"></div>
                    </div>
                    <div id="scBreakdown"></div>
                </div>
                <div id="scRecs"></div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-title"><span class="sec-badge sb"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></span> Barcha xodimlar</div>
                <button class="btn btn-ghost btn-sm" onclick="calcAllScores()">üîÑ Barchasini hisoblash</button>
            </div>
            <div class="table-wrap"><table><thead>
                <tr><th>Xodim</th><th>Lavozim</th><th>To'qnashuv</th><th>Kredit</th><th>Mol-mulk</th><th>Balans</th><th>Xarid</th><th>Umumiy</th><th>Daraja</th></tr>
            </thead><tbody id="scTbody"></tbody></table></div>
        </div>

        <!-- SCORING HISTORY -->
        <div class="card">
            <div class="card-header">
                <div class="card-title"><span class="sec-badge sp"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg></span> Scoring tarixi</div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <select id="scHistFilter" onchange="renderScoreHistory()" style="padding:6px 12px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:12px;font-family:'Source Sans 3',sans-serif;">
                        <option value="all">Barcha xodimlar</option>
                    </select>
                    <button class="btn btn-ghost btn-sm" onclick="clearScoreHistory()">üóë Tarixni tozalash</button>
                </div>
            </div>
            <div id="scHistEmpty" class="empty"><div class="e-icon">üìú</div><p>Hali scoring tarixi yo'q. Xodimni tanlang va scoring hisoblang.</p></div>
            <div class="table-wrap" id="scHistTableWrap" style="display:none;">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Sana va vaqt</th>
                            <th>Xodim</th>
                            <th>Lavozim</th>
                            <th>To'qnashuv</th>
                            <th>Kredit</th>
                            <th>Mol-mulk</th>
                            <th>Balans</th>
                            <th>Xarid</th>
                            <th>Umumiy</th>
                            <th>Daraja</th>
                            <th>O'zgarish</th>
                        </tr>
                    </thead>
                    <tbody id="scHistTbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MONITORING -->
    <div class="section" id="sec-monitoring">
        <div class="card">
            <div class="card-header">
                <div class="card-title"><span class="sec-badge sb"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></span> To'liq monitoring</div>
                <button class="btn btn-danger btn-sm" onclick="runMonitoring()">üöÄ Ishga tushirish</button>
            </div>
            <div class="alert alert-warning"><span class="alert-icon">‚ö†Ô∏è</span><div>Balans 5x oshgan xodimlarning kredit va tekshirish faoliyati avtomatik qayta ko'rib chiqiladi.</div></div>
            <div id="monResults"><div class="empty"><div class="e-icon">üîç</div><p>Monitoring boshlang...</p></div></div>
        </div>
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="sec-badge sp"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg></span> Monitoring tarixi</div></div>
            <div class="timeline" id="monTimeline"><div class="empty"><div class="e-icon">üì≠</div><p>Tarix yo'q</p></div></div>
        </div>
    </div>

    <!-- ===== AI TAHLIL ‚Äî CHUQUR AVTOMATLASHTIRILGAN TAHLIL ===== -->

    <!-- ===== SOVG'ALAR (GIFTS) ===== -->
    <div class="section" id="sec-gifts">
        <div class="section-header"><h2>üéÅ Sovg'a va mehmondo'stlik registri</h2><p>FCPA, UK Bribery Act va ichki siyosat talablari</p></div>
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="sec-badge sr"><svg viewBox="0 0 24 24"><path d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg></span> Yangi sovg'a qayd etish</div></div>
            <div class="form-grid">
                <select id="gEmp" class="input"><option value="">Xodim tanlang</option></select>
                <input id="gDate" class="input" type="date" placeholder="Sana">
                <select id="gDir" class="input"><option value="received">Qabul qildi</option><option value="given">Berdi</option></select>
                <input id="gFrom" class="input" placeholder="Kim/qayerdan (vendor, mijoz...)">
                <input id="gType" class="input" placeholder="Sovg'a turi (oziq-ovqat, qurilma...)">
                <input id="gValue" class="input" type="number" placeholder="Qiymati (so'm)">
                <input id="gReason" class="input" placeholder="Sabab/justifikatsiya">
                <select id="gRelation" class="input"><option value="vendor">Vendor/Yetkazuvchi</option><option value="client">Mijoz</option><option value="gov">Davlat xodimi</option><option value="other">Boshqa</option></select>
            </div>
            <button class="btn btn-primary" onclick="addGift()" style="margin-top:12px;">üíæ Saqlash</button>
        </div>
        <div id="giftCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px;margin-top:16px;"></div>
    </div>

    <!-- ===== KONTRAKTLAR (CONTRACTS) ===== -->
    <div class="section" id="sec-contracts">
        <div class="section-header"><h2>üìù Kontrakt va shartnomalar</h2><p>Approval workflow, split-kontrakt aniqlash, Benford qonuni</p></div>
        <div class="card">
            <div class="card-header"><div class="card-title"><span class="sec-badge sp"><svg viewBox="0 0 24 24"><path d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg></span> Yangi kontrakt</div></div>
            <div class="form-grid">
                <select id="ctEmp" class="input"><option value="">Mas'ul xodim</option></select>
                <input id="ctVendor" class="input" placeholder="Vendor/pudratchi nomi">
                <input id="ctNum" class="input" placeholder="Kontrakt raqami">
                <input id="ctAmount" class="input" type="number" placeholder="Summa (so'm)">
                <input id="ctDate" class="input" type="date" placeholder="Tuzilgan sana">
                <input id="ctStartDate" class="input" type="date" placeholder="Ish boshlangan sana">
                <select id="ctType" class="input"><option value="goods">Tovar</option><option value="services">Xizmat</option><option value="construction">Qurilish</option><option value="consulting">Konsalting</option></select>
                <select id="ctMethod" class="input"><option value="tender">Tender</option><option value="direct">To'g'ridan-to'g'ri</option><option value="emergency">Tezkor</option><option value="framework">Ramka shartnoma</option></select>
                <input id="ctAmendments" class="input" type="number" placeholder="O'zgartirishlar soni" value="0">
                <input id="ctAmendAmount" class="input" type="number" placeholder="O'zgartirish summasi" value="0">
            </div>
            <button class="btn btn-primary" onclick="addContract()" style="margin-top:12px;">üíæ Saqlash</button>
        </div>
        <div id="contractCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:16px;margin-top:16px;"></div>
    </div>

    <!-- ===== WHISTLEBLOWER ===== -->
    <div class="section" id="sec-whistleblower">
        <div class="section-header"><h2>üîê Anonim xabar berish tizimi (Whistleblower)</h2><p>EU Directive 2019/1937 ‚Äî maxfiy va himoyalangan</p></div>
        <div class="card" style="border-image:linear-gradient(135deg,var(--warning),var(--danger)) 1;border-width:1px;border-style:solid;">
            <div class="card-header"><div class="card-title"><span class="icon">üì®</span> Yangi anonim xabar yuborish</div></div>
            <div class="alert alert-warning"><span class="alert-icon">üîí</span><div>Bu xabar <strong>to'liq anonim</strong>. IP manzil, qurilma ma'lumoti va shaxsiy identifikator saqlanmaydi. Xabar faqat compliance bo'limiga ko'rinadi.</div></div>
            <div class="form-grid">
                <select id="wbSeverity" class="input"><option value="P1">üî¥ P1 ‚Äî Jiddiy (faol firibgarlik)</option><option value="P2">üü† P2 ‚Äî Yuqori (korrupsiya shubhasi)</option><option value="P3">üü° P3 ‚Äî O'rta (qoida buzilishi)</option><option value="P4">üü¢ P4 ‚Äî Past (etika masalasi)</option></select>
                <select id="wbCategory" class="input"><option value="corruption">Korrupsiya</option><option value="fraud">Firibgarlik</option><option value="bribery">Pora</option><option value="conflict">Manfaatlar to'qnashuvi</option><option value="theft">O'g'irlik</option><option value="harassment">Ta'qib</option><option value="other">Boshqa</option></select>
                <select id="wbDept" class="input">
                    <option value="">Bo'limni tanlang...</option>
                    <option>Ijro apparati</option>
                    <option>Iste'molchilar huquqlarini himoya qilish sho'basi</option>
                    <option>Naqd pul muomalasi boshqarmasi</option>
                    <option>Naqd pul va to'lov monitoring bo'limi</option>
                    <option>Qimmatliklarni tashish bo'limi</option>
                    <option>Buxgalteriya va moliyaviy-iqtisodiy boshqarma</option>
                    <option>To'lov tizimlari va AT bo'limi</option>
                    <option>Narxlar va iqtisodiy kutilmalar bo'limi</option>
                    <option>Hududlarni monitoring qilish bo'limi</option>
                    <option>Tadbirkorlikni qo'llab-quvvatlash bo'limi</option>
                    <option>Moliyaviy monitoring va valyuta nazorati bo'limi</option>
                    <option>Xavfsizlik va axborot muhofazasi sho'basi</option>
                    <option>Kredit tashkilotlarini inspeksiya boshqarmasi</option>
                    <option>Muammoli aktivlar va moliyaviy tahlil bo'limi</option>
                    <option>Ichki audit</option>
                    <option>Compliance</option>
                </select>
                <input id="wbSuspect" class="input" placeholder="Gumon qilinuvchi (ixtiyoriy)">
            </div>
            <textarea id="wbDetail" class="input" style="height:120px;margin-top:8px;resize:vertical;" placeholder="Hodisa haqida batafsil ma'lumot..."></textarea>
            <button class="btn btn-primary" onclick="addWhistleblower()" style="margin-top:12px;background:linear-gradient(135deg,var(--warning),var(--danger));">üîê Anonim yuborish</button>
        </div>
        <div id="wbCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:16px;margin-top:16px;"></div>
    </div>

    <div class="section" id="sec-ai">
        <!-- AI Header -->
        <div class="card" style="border-image:linear-gradient(135deg,var(--accent),var(--purple),var(--cyan)) 1;border-width:1px;border-style:solid;background:linear-gradient(135deg,var(--bg-card),var(--bg-card-alt));">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;">
                <div>
                    <h2 style="font-size:22px;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--purple),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px;">üß† Chuqur AI Tahlil Tizimi</h2>
                    <p style="font-size:13px;color:var(--text-secondary);">O'zbekiston Markaziy banki uchun 29 modulli chuqur tahlil ‚Äî FATF, Basel, FCPA standartlariga mos. Inspeksiya, moliyaviy monitoring, valyuta nazorati, Benford qonuni, PEP skrining, UEBA va boshqa</p>
                </div>
                <button class="btn btn-primary" onclick="runFullAIAnalysis()" style="font-size:14px;padding:12px 28px;background:linear-gradient(135deg,var(--accent),var(--purple));box-shadow:0 4px 20px var(--accent-glow);">
                    üöÄ To'liq AI tahlilni ishga tushirish (29 modul)
                </button>
            </div>
        </div>

        <!-- AI analysis progress -->
        <div class="card" id="aiProgress" style="display:none;">
            <div style="text-align:center;padding:20px;">
                <div id="aiProgressIcon" style="font-size:48px;margin-bottom:12px;animation:logoPulse 1s ease infinite;">üß†</div>
                <div id="aiProgressText" style="font-size:14px;font-weight:600;margin-bottom:12px;">Tahlil boshlandi...</div>
                <div style="height:6px;background:var(--bg-input);border-radius:3px;overflow:hidden;max-width:400px;margin:0 auto;">
                    <div id="aiProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--purple));border-radius:3px;transition:width 0.5s ease;"></div>
                </div>
                <div id="aiProgressStep" style="font-size:11px;color:var(--text-muted);margin-top:8px;"></div>
            </div>
        </div>

        <!-- Results container -->
        <div id="aiResults" style="display:none;">

            <!-- 1. EXECUTIVE SUMMARY -->
            <div class="card" id="aiSummaryCard">
                <div class="card-header"><div class="card-title"><span class="icon">üìã</span> Umumiy xulosa</div></div>
                <div id="aiSummary"></div>
            </div>

            <!-- 2. CROSS-REFERENCE (Kross-referensiya) -->
            <div class="card" id="aiCrossCard">
                <div class="card-header"><div class="card-title"><span class="icon">üîó</span> Kross-referensiya tahlili</div>
                    <span class="chip chip-blue" id="aiCrossCount">0 ta aloqa</span>
                </div>
                <div class="alert alert-info"><span class="alert-icon">üîó</span><div>Xodimlar, yaqin qarindoshlar, tekshirish tashkilotlari, xarid yetkazuvchilari va ustav fondlari o'rtasidagi yashirin aloqalarni avtomatik aniqlaydi.</div></div>
                <div id="aiCrossResults"></div>
            </div>

            <!-- 3. TEMPORAL PATTERN (Vaqt pattern) -->
            <div class="card" id="aiTemporalCard">
                <div class="card-header"><div class="card-title"><span class="icon">‚è±Ô∏è</span> Vaqt pattern tahlili</div>
                    <span class="chip chip-orange" id="aiTemporalCount">0 ta pattern</span>
                </div>
                <div class="alert alert-warning"><span class="alert-icon">‚è±Ô∏è</span><div>Kredit ajratish ‚Üí mol-mulk xarid qilish, safari ‚Üí qaror qabul qilish kabi vaqt jihatdan shubhali mos kelishlarni aniqlaydi.</div></div>
                <div id="aiTemporalResults"></div>
            </div>

            <!-- 4. LIFESTYLE vs INCOME -->
            <div class="card" id="aiLifestyleCard">
                <div class="card-header"><div class="card-title"><span class="icon">üí∞</span> Turmush tarzi va daromad nomutanosibligi</div>
                    <span class="chip chip-red" id="aiLifestyleCount">0 ta anomaliya</span>
                </div>
                <div class="alert alert-danger"><span class="alert-icon">üí∞</span><div>Xodimning rasmiy maoshi bilan mol-mulk, safari xarajatlari va balans o'rtasidagi nomutanosiblikni aniqlaydi.</div></div>
                <div id="aiLifestyleResults"></div>
            </div>

            <!-- 5. PROCUREMENT FAVORITISM -->
            <div class="card" id="aiFavCard">
                <div class="card-header"><div class="card-title"><span class="icon">ü§ù</span> Xarid favoritizmi tahlili</div>
                    <span class="chip chip-purple" id="aiFavCount">0 ta pattern</span>
                </div>
                <div class="alert alert-info" style="background:var(--purple-soft);border-color:rgba(153,102,255,0.15);color:var(--purple);"><span class="alert-icon">ü§ù</span><div>Bitta yetkazuvchiga qayta-qayta xarid qilish, xarid summalari anomaliyasi va xodim-yetkazuvchi aloqalarini aniqlaydi.</div></div>
                <div id="aiFavResults"></div>
            </div>

            <!-- 6. NETWORK MAP -->
            <div class="card" id="aiNetworkCard">
                <div class="card-header"><div class="card-title"><span class="icon">üï∏Ô∏è</span> Aloqalar tarmog'i</div></div>
                <div style="position:relative;overflow:hidden;border-radius:12px;border:1px solid var(--border-color);background:var(--bg-input);">
                    <canvas id="networkCanvas" width="900" height="500" style="width:100%;height:500px;display:block;"></canvas>
                </div>
                <div style="display:flex;gap:16px;margin-top:12px;flex-wrap:wrap;justify-content:center;font-size:11px;color:var(--text-muted);">
                    <span>üîµ Xodim</span><span>üü¢ Qarindosh</span><span>üü† Tashkilot</span><span>üî¥ Shubhali aloqa</span><span>‚ö™ Boshqa</span>
                </div>
            </div>

            <!-- 7. PREDICTIVE TREND -->
            <div class="card" id="aiTrendCard">
                <div class="card-header"><div class="card-title"><span class="icon">üìà</span> Bashorat va trend tahlili</div></div>
                <div id="aiTrendResults"></div>
            </div>

            <!-- 8. AUTOMATED RECOMMENDATIONS -->
            <div class="card" id="aiRecsCard" style="border-image:linear-gradient(135deg,var(--success),var(--accent)) 1;border-width:1px;border-style:solid;">
                <div class="card-header"><div class="card-title"><span class="icon">üí°</span> Avtomatlashtirilgan tavsiyalar</div></div>
                <div id="aiRecs"></div>
            </div>

            <!-- ======= NEW: 9. CHAIN ANALYSIS ‚Äî Zanjirli aloqa tahlili ======= -->
            <div class="card" id="aiChainCard">
                <div class="card-header"><div class="card-title"><span class="icon">‚õìÔ∏è</span> Zanjirli aloqa tahlili (Multi-Hop)</div>
                    <span class="chip chip-red" id="aiChainCount">0 ta zanjir</span>
                </div>
                <div class="alert alert-danger"><span class="alert-icon">‚õìÔ∏è</span><div>Xodim ‚Üí Qarindosh ‚Üí Tashkilot ‚Üí Boshqa xodim ‚Üí Ularning qarindoshlari... kabi <strong>ko'p bosqichli yashirin aloqalarni</strong> avtomatik aniqlaydi. Eng xavfli korrupsiya sxemalari ko'pincha 2-3 bosqichli vositachilar orqali amalga oshiriladi.</div></div>
                <div id="aiChainResults"></div>
            </div>

            <!-- ======= NEW: 10. ANOMALY Z-SCORE ‚Äî Statistik anomaliya ======= -->
            <div class="card" id="aiAnomalyCard">
                <div class="card-header"><div class="card-title"><span class="icon">üìä</span> Statistik anomaliya indeksi (Z-Score)</div>
                    <span class="chip chip-orange" id="aiAnomalyCount">0 ta anomaliya</span>
                </div>
                <div class="alert alert-warning"><span class="alert-icon">üìä</span><div>Har bir xodimni o'rtacha ko'rsatkichlar bilan <strong>statistik solishtirib</strong>, normal chegaradan chiqganlarni aniqlaydi. Z-score > 2.0 = shubhali, > 3.0 = jiddiy anomaliya.</div></div>
                <div id="aiAnomalyResults"></div>
            </div>

            <!-- ======= NEW: 11. EARLY WARNING ‚Äî Erta ogohlantirish ======= -->
            <div class="card" id="aiEarlyCard" style="border-image:linear-gradient(135deg,var(--warning),var(--danger)) 1;border-width:1px;border-style:solid;">
                <div class="card-header"><div class="card-title"><span class="icon">üîÆ</span> Erta ogohlantirish tizimi (Predictive)</div>
                    <span class="chip chip-orange" id="aiEarlyCount">0 ta signal</span>
                </div>
                <div class="alert alert-warning"><span class="alert-icon">üîÆ</span><div>Hali korrupsiya <strong>sodir bo'lmagan</strong>, lekin <strong>risk ko'rsatkichlari oshib borayotgan</strong> xodimlarni aniqlaydi. Oldindan chora ko'rish imkonini beradi!</div></div>
                <div id="aiEarlyResults"></div>
            </div>

            <!-- ======= NEW: 12. AUTO RULES ENGINE ‚Äî Qoidalar motori ======= -->
            <div class="card" id="aiRulesCard">
                <div class="card-header"><div class="card-title"><span class="icon">‚öôÔ∏è</span> Avtomatik qoidalar motori</div>
                    <span class="chip chip-blue" id="aiRulesCount">0 / 0</span>
                </div>
                <div class="alert alert-info"><span class="alert-icon">‚öôÔ∏è</span><div><strong>15 ta oldindan belgilangan qoida</strong> bo'yicha har bir xodim avtomatik tekshiriladi. Har bir qoida buzilishi alohida qayd etiladi.</div></div>
                <div id="aiRulesResults"></div>
            </div>

            <!-- ======= NEW: 13. WATCH LIST ‚Äî Kuzatuv ro'yxati ======= -->
            <div class="card" id="aiWatchCard" style="border-image:linear-gradient(135deg,var(--danger),var(--warning)) 1;border-width:1px;border-style:solid;">
                <div class="card-header"><div class="card-title"><span class="icon">üëÅÔ∏è</span> Avtomatik kuzatuv ro'yxati</div></div>
                <div id="aiWatchResults"></div>
            </div>

            <!-- ======= NEW: 14. RISK HEAT MAP ======= -->
            <div class="card" id="aiHeatCard">
                <div class="card-header"><div class="card-title"><span class="icon">üó∫Ô∏è</span> Risk xaritasi (Heat Map)</div></div>
                <div id="aiHeatResults"></div>
            </div>

            <!-- ======= NEW: 15. SEGREGATION OF DUTIES ======= -->
            <div class="card" id="aiSodCard">
                <div class="card-header"><div class="card-title"><span class="icon">üîê</span> Vazifalarnini ajratish tahlili (Segregation of Duties)</div>
                    <span class="chip chip-purple" id="aiSodCount">0 ta buzilish</span>
                </div>
                <div class="alert alert-info" style="background:var(--purple-soft);border-color:rgba(153,102,255,0.15);color:var(--purple);"><span class="alert-icon">üîê</span><div>Bir xodim <strong>bir vaqtda kredit ajratuvchi ham, tekshiruvchi ham</strong> bo'lmasligi kerak. Bu eng muhim ichki nazorat tamoyili.</div></div>
                <div id="aiSodResults"></div>
            </div>


            <!-- ======= V3: 17. GIFT ANALYSIS ======= -->
            <div class="card" id="aiGiftCard">
                <div class="card-header"><div class="card-title"><span class="icon">üéÅ</span> Sovg'a-xarid korrelyatsiyasi</div>
                    <span class="chip chip-orange" id="aiGiftCount">0 ta topilma</span>
                </div>
                <div class="alert alert-warning"><span class="alert-icon">üéÅ</span><div>Vendor sovg'alari va xarid qarorlari o'rtasidagi <strong>vaqt va summa korrelyatsiyasini</strong> aniqlaydi. FCPA va UK Bribery Act bo'yicha eng xavfli ko'rsatkich.</div></div>
                <div id="aiGiftResults"></div>
            </div>

            <!-- ======= V3: 18. PEP SCREENING ======= -->
            <div class="card" id="aiPepCard">
                <div class="card-header"><div class="card-title"><span class="icon">üèõÔ∏è</span> PEP va sanksiya skriningi</div>
                    <span class="chip chip-red" id="aiPepCount">0 ta aloqa</span>
                </div>
                <div class="alert alert-danger"><span class="alert-icon">üèõÔ∏è</span><div>Xodimlar va yaqinlarni <strong>Siyosiy ta'sirli shaxslar (PEP)</strong> va <strong>sanksiya ro'yxatlari</strong> bilan solishtiradi. FATF Recommendation 12 talabi.</div></div>
                <div id="aiPepResults"></div>
            </div>

            <!-- ======= V3: 19. BENFORD LAW ======= -->
            <div class="card" id="aiBenfordCard">
                <div class="card-header"><div class="card-title"><span class="icon">üî¢</span> Benford qonuni tahlili</div>
                    <span class="chip chip-purple" id="aiBenfordCount">0 ta anomaliya</span>
                </div>
                <div class="alert alert-info" style="background:var(--purple-soft);border-color:rgba(153,102,255,0.15);color:var(--purple);"><span class="alert-icon">üî¢</span><div>Summalarning birinchi raqami <strong>Benford taqsimotiga</strong> mos kelishini tekshiradi. MAD > 0.015 = manipulyatsiya belgilari.</div></div>
                <div id="aiBenfordResults"></div>
            </div>

            <!-- ======= V3: 20. SPLIT CONTRACT ======= -->
            <div class="card" id="aiSplitCard">
                <div class="card-header"><div class="card-title"><span class="icon">‚úÇÔ∏è</span> Split-kontrakt aniqlash</div>
                    <span class="chip chip-red" id="aiSplitCount">0 ta shubhali</span>
                </div>
                <div class="alert alert-danger"><span class="alert-icon">‚úÇÔ∏è</span><div>Katta xaridlarni <strong>tasdiqlash chegarasidan pastda</strong> bo'laklarga ajratish sxemasini aniqlaydi. Korrupsiyaning eng keng tarqalgan usuli.</div></div>
                <div id="aiSplitResults"></div>
            </div>

            <!-- ======= V3: 21. INSIDER LENDING ======= -->
            <div class="card" id="aiInsiderCard">
                <div class="card-header"><div class="card-title"><span class="icon">üè¶</span> Insider kredit tahlili</div>
                    <span class="chip chip-red" id="aiInsiderCount">0 ta topilma</span>
                </div>
                <div class="alert alert-danger"><span class="alert-icon">üè¶</span><div>Imtiyozli foiz stavkalar, kredit qayta ishlash (evergreening), va <strong>tasdiqlash override</strong> patternlarini aniqlaydi. Basel Core Principle 20.</div></div>
                <div id="aiInsiderResults"></div>
            </div>

            <!-- ======= V3: 22. UEBA ======= -->
            <div class="card" id="aiUebaCard">
                <div class="card-header"><div class="card-title"><span class="icon">üíª</span> UEBA ‚Äî Foydalanuvchi xulq tahlili</div>
                    <span class="chip chip-orange" id="aiUebaCount">0 ta anomaliya</span>
                </div>
                <div class="alert alert-warning"><span class="alert-icon">üíª</span><div>Tizimga kirish vaqti, joylashuv, ma'lumot ko'rish hajmi va <strong>g'ayrioddiy xulq patternlarini</strong> aniqlaydi.</div></div>
                <div id="aiUebaResults"></div>
            </div>

            <!-- ======= V3: 23. HR ANALYTICS ======= -->
            <div class="card" id="aiHrCard">
                <div class="card-header"><div class="card-title"><span class="icon">üëî</span> HR va ta'til tahlili</div>
                    <span class="chip chip-blue" id="aiHrCount">0 ta topilma</span>
                </div>
                <div class="alert alert-info"><span class="alert-icon">üëî</span><div>Majburiy ta'til olmaganlar, tez-tez lavozim almashtirishlar, <strong>ishdan ketish klasterlari</strong> va boshqa HR risk ko'rsatkichlarini tahlil qiladi. FDIC talabi.</div></div>
                <div id="aiHrResults"></div>
            </div>

            <!-- ======= V3: 24. BENEFICIAL OWNERSHIP ======= -->
            <div class="card" id="aiBenefCard">
                <div class="card-header"><div class="card-title"><span class="icon">üè¢</span> Haqiqiy egalar tahlili (Beneficial Ownership)</div>
                    <span class="chip chip-purple" id="aiBenefCount">0 ta shubhali</span>
                </div>
                <div class="alert alert-info" style="background:var(--purple-soft);border-color:rgba(153,102,255,0.15);color:var(--purple);"><span class="alert-icon">üè¢</span><div>Vendor va tashkilotlarning <strong>haqiqiy egalarini</strong> xodimlar bilan solishtiradi. FATF Rec 24/25 ‚Äî nominee direktorlar, ko'p qatlamli egaliklarni aniqlaydi.</div></div>
                <div id="aiBenefResults"></div>
            </div>

            <!-- ======= V3: 25. SIDE BUSINESS ======= -->
            <div class="card" id="aiSideCard">
                <div class="card-header"><div class="card-title"><span class="icon">üíº</span> Qo'shimcha biznes aniqlash</div>
                    <span class="chip chip-orange" id="aiSideCount">0 ta topilma</span>
                </div>
                <div class="alert alert-warning"><span class="alert-icon">üíº</span><div>Xodimlarning <strong>deklaratsiya qilinmagan biznes faoliyati</strong>, direktorlik va aksiyadorlik ulushlari mavjudligini tekshiradi.</div></div>
                <div id="aiSideResults"></div>
            </div>

            <!-- ======= V3: 26. ADVERSE MEDIA ======= -->
            <div class="card" id="aiMediaCard">
                <div class="card-header"><div class="card-title"><span class="icon">üì∞</span> OSINT va ommaviy axborot tahlili</div>
                    <span class="chip chip-blue" id="aiMediaCount">0 ta topilma</span>
                </div>
                <div class="alert alert-info"><span class="alert-icon">üì∞</span><div>Xodimlar haqida <strong>salbiy ommaviy axborot</strong>, sud ishlari, va ochiq manbalar (OSINT) ma'lumotlarini tahlil qiladi.</div></div>
                <div id="aiMediaResults"></div>
            </div>

            <!-- ======= V3: 27. TRAINING COMPLIANCE ======= -->
            <div class="card" id="aiTrainCard">
                <div class="card-header"><div class="card-title"><span class="icon">üìã</span> Trening va sertifikat monitoring</div>
                    <span class="chip chip-blue" id="aiTrainCount">0 ta muammo</span>
                </div>
                <div class="alert alert-info"><span class="alert-icon">üìã</span><div>AML/CFT, antikorrupsiya trening o'tash <strong>muddatlari va sertifikat yaroqlilik</strong> holatini tekshiradi.</div></div>
                <div id="aiTrainResults"></div>
            </div>

            <!-- ======= V3: 28. KPI MANIPULATION ======= -->
            <div class="card" id="aiKpiCard">
                <div class="card-header"><div class="card-title"><span class="icon">üìä</span> KPI manipulyatsiya aniqlash</div>
                    <span class="chip chip-orange" id="aiKpiCount">0 ta anomaliya</span>
                </div>
                <div class="alert alert-warning"><span class="alert-icon">üìä</span><div>Xodimlar <strong>ish ko'rsatkichlarini sun'iy ravishda oshirish</strong> belgilarini ‚Äî approval rate, processing speed, override chastotasi ‚Äî tahlil qiladi.</div></div>
                <div id="aiKpiResults"></div>
            </div>

            <!-- ======= V3: 29. TRANSACTION STRUCTURING ======= -->
            <div class="card" id="aiStructCard">
                <div class="card-header"><div class="card-title"><span class="icon">üí∞</span> Tranzaksiya strukturlash aniqlash</div>
                    <span class="chip chip-red" id="aiStructCount">0 ta shubhali</span>
                </div>
                <div class="alert alert-danger"><span class="alert-icon">üí∞</span><div>Hisobot chegarasidan <strong>ataylab past miqdorlar</strong> (structuring/smurfing), dormant hisob faollashuvi va round-trip tranzaksiyalarni aniqlaydi.</div></div>
                <div id="aiStructResults"></div>
            </div>

            <!-- ======= V3: 30. WHISTLEBLOWER ANALYSIS ======= -->
            <div class="card" id="aiWbCard">
                <div class="card-header"><div class="card-title"><span class="icon">üîê</span> Whistleblower xabarlari tahlili</div>
                    <span class="chip chip-red" id="aiWbCount">0 ta xabar</span>
                </div>
                <div class="alert alert-danger"><span class="alert-icon">üîê</span><div>Anonim xabarlarni <strong>boshqa risk ko'rsatkichlari bilan korrelyatsiya</strong> qiladi va bo'limlar bo'yicha xabar yo'qligini (<strong>suppression</strong> belgisi) aniqlaydi.</div></div>
                <div id="aiWbResults"></div>
            </div>

            <!-- ======= NEW: 16. FULL REPORT GENERATOR ======= -->
            <div class="card" id="aiReportCard">
                <div class="card-header">
                    <div class="card-title"><span class="icon">üìÑ</span> To'liq hisobot</div>
                    <button class="btn btn-ghost btn-sm" onclick="copyReport()">üìã Nusxa olish</button>
                </div>
                <div id="aiReportBody" style="max-height:500px;overflow-y:auto;padding:16px;background:var(--bg-input);border-radius:10px;font-size:13px;line-height:1.8;font-family:'Source Sans 3',sans-serif;white-space:pre-wrap;"></div>
            </div>
        </div>

        <!-- Empty state -->
        <div id="aiEmpty">
            <div class="empty" style="padding:60px 20px;">
                <div class="e-icon" style="font-size:64px;opacity:0.4;">üß†</div>
                <p style="font-size:16px;margin-top:12px;">AI tahlilni ishga tushirish uchun yuqoridagi tugmani bosing</p>
                <p style="font-size:12px;color:var(--text-muted);margin-top:8px;">Tizim barcha ma'lumotlarni chuqur tahlil qilib, yashirin aloqalar va shubhali patternlarni aniqlaydi</p>
            </div>
        </div>
    </div>

</main>
</div>

<script>
// ============================================================
// DATA STORE
// ============================================================
const DB = { employees:[], declarations:[], relatives:[], credits:[], properties:[], travels:[], procurements:[], accounts:[], alerts:[], monLog:[], scoreHistory:[], gifts:[], whistleblower:[], contracts:[], peps:[], training:[], loginLogs:[], sideBusinesses:[], beneficialOwners:[], adverseMedia:[] };
let nid = 1;
const gid = () => nid++;
const fmt = n => n == null || isNaN(n) ? '‚Äî' : Number(n).toLocaleString('uz-UZ');
const fd = d => d ? new Date(d).toLocaleDateString('uz-UZ') : '‚Äî';
const gn = id => { const e = DB.employees.find(x=>x.id==id); return e?e.fio:'‚Äî'; };
const gs = id => { const e = DB.employees.find(x=>x.id==id); return e?e.salary:0; };

// ============================================================
// THEME TOGGLE
// ============================================================
function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.getAttribute('data-theme') === 'dark';
    html.setAttribute('data-theme', isDark ? 'light' : 'dark');
    document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    initParticles(); // re-init particles with new color
}

// ============================================================
// ANIMATED PARTICLE BACKGROUND
// ============================================================
const canvas = document.getElementById('bgCanvas');
const ctx = canvas.getContext('2d');
let particles = [];
let animFrame;

function initParticles() {
    cancelAnimationFrame(animFrame);
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    particles = [];
    const count = Math.min(80, Math.floor(window.innerWidth / 20));
    for (let i = 0; i < count; i++) {
        particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            r: Math.random() * 2 + 0.5,
            vx: (Math.random() - 0.5) * 0.3,
            vy: (Math.random() - 0.5) * 0.3,
            o: Math.random() * 0.3 + 0.1
        });
    }
    animateParticles();
}

function animateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const pc = isDark ? [56,132,255] : [42,106,223];

    particles.forEach(p => {
        p.x += p.vx; p.y += p.vy;
        if (p.x < 0) p.x = canvas.width;
        if (p.x > canvas.width) p.x = 0;
        if (p.y < 0) p.y = canvas.height;
        if (p.y > canvas.height) p.y = 0;

        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(${pc[0]},${pc[1]},${pc[2]},${p.o})`;
        ctx.fill();
    });

    // Connection lines
    for (let i = 0; i < particles.length; i++) {
        for (let j = i + 1; j < particles.length; j++) {
            const dx = particles[i].x - particles[j].x;
            const dy = particles[i].y - particles[j].y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if (dist < 120) {
                ctx.beginPath();
                ctx.moveTo(particles[i].x, particles[i].y);
                ctx.lineTo(particles[j].x, particles[j].y);
                ctx.strokeStyle = `rgba(${pc[0]},${pc[1]},${pc[2]},${0.05 * (1 - dist/120)})`;
                ctx.lineWidth = 0.5;
                ctx.stroke();
            }
        }
    }

    animFrame = requestAnimationFrame(animateParticles);
}

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});

initParticles();

// ============================================================
// CLOCK
// ============================================================
function tick() {
    const n = new Date();
    document.getElementById('clock').textContent = n.toLocaleDateString('uz-UZ') + '  ' + n.toLocaleTimeString('uz-UZ');
}
tick(); setInterval(tick, 1000);

// ============================================================
// NAV TABS
// ============================================================
document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('sec-' + tab.dataset.tab).classList.add('active');
    });
});

// ============================================================
// TOAST SYSTEM
// ============================================================
function toast(msg, type='info') {
    const icons = { success:'‚úÖ', danger:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è' };
    const el = document.createElement('div');
    el.className = `toast toast-${type}`;
    el.innerHTML = `<span>${icons[type]||'‚ÑπÔ∏è'}</span><span>${msg}</span>`;
    el.onclick = () => { el.style.animation = 'toastOut 0.3s ease forwards'; setTimeout(()=>el.remove(), 300); };
    document.getElementById('toasts').appendChild(el);
    setTimeout(() => { if (el.parentNode) { el.style.animation = 'toastOut 0.3s ease forwards'; setTimeout(()=>el.remove(), 300); } }, 4000);
}

// ============================================================
// EMPLOYEE SELECTS
// ============================================================
function popSelects() {
    ['dEmp','rEmp','cEmp','pEmp','tEmp','prEmp','aEmp','scEmp','gEmp','ctEmp'].forEach(sid => {
        const el = document.getElementById(sid);
        if (!el) return;
        const v = el.value;
        el.innerHTML = '<option value="">Tanlang...</option>';
        DB.employees.forEach(e => { el.innerHTML += `<option value="${e.id}">${e.fio} ‚Äî ${e.position}</option>`; });
        if (v) el.value = v;
    });
}

// ============================================================
// EMPLOYEES
// ============================================================
function addEmployee() {
    const fio = document.getElementById('eFio').value.trim();
    const pos = document.getElementById('ePos').value.trim();
    if (!fio || !pos) { toast('F.I.O va Lavozimni kiriting!', 'danger'); return; }
    DB.employees.push({
        id: gid(), fio, position: pos,
        department: document.getElementById('eDep').value,
        salary: parseFloat(document.getElementById('eSal').value)||0,
        startDate: document.getElementById('eDate').value,
        phone: document.getElementById('ePhone').value,
        riskScore: 0, riskLevel: 'low'
    });
    clearEmpForm(); popSelects(); renderEmpTable(); updateDash();
    toast(`${fio} muvaffaqiyatli qo'shildi`, 'success');
}

function clearEmpForm() {
    ['eFio','ePos','eDep','eSal','eDate','ePhone'].forEach(id => document.getElementById(id).value = '');
}


// ============================================================
// CARD BUILDER HELPERS
// ============================================================
function cardWrap(content, opts={}) {
    const {risk=false, border='var(--border-color)', hover=true} = opts;
    const riskBorder = risk ? 'rgba(255,68,102,0.3)' : border;
    const riskShadow = risk ? 'box-shadow:0 0 20px rgba(255,68,102,0.08);' : '';
    return `<div style="background:var(--bg-card);border-radius:16px;padding:22px;border:1px solid ${riskBorder};${riskShadow}box-shadow:var(--shadow-card);transition:all 0.25s ease;display:flex;flex-direction:column;gap:8px;" ${hover ? 'onmouseenter="this.style.transform=\'translateY(-3px)\';this.style.boxShadow=\'0 12px 36px rgba(0,0,0,0.15)\'" onmouseleave="this.style.transform=\'\';this.style.boxShadow=\'\'"' : ''}>${content}</div>`;
}
function cardRow(label, value, opts={}) {
    const {mono=false, bold=false, color=''} = opts;
    return `<div style="display:flex;justify-content:space-between;align-items:center;font-size:13px;">
        <span style="color:var(--text-muted);">${label}</span>
        <span style="${mono?'font-family:JetBrains Mono,monospace;':''}${bold?'font-weight:700;':''}${color?'color:'+color+';':''}">${value}</span>
    </div>`;
}
function cardBadge(text, color, bg) {
    return `<span style="font-size:11px;font-weight:700;padding:4px 12px;border-radius:8px;color:${color};background:${bg};white-space:nowrap;">${text}</span>`;
}
function cardAmount(amount, color) {
    return `<div style="font-size:24px;font-weight:900;color:${color};font-family:'JetBrains Mono',monospace;letter-spacing:-0.5px;margin:2px 0;">${Number(amount).toLocaleString('en-US')} UZS</div>`;
}
function cardTitle(text) {
    return `<div style="font-size:17px;font-weight:800;color:var(--text-primary);line-height:1.3;font-family:'Playfair Display',Georgia,serif;">${text}</div>`;
}
function cardMeta(left, right) {
    return `<div style="display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--text-muted);padding-top:6px;border-top:1px solid var(--border-color);">${left}${right?'<span>'+right+'</span>':''}</div>`;
}
function cardWarning(text) {
    return `<div style="background:rgba(255,170,34,0.08);border:1px solid rgba(255,170,34,0.2);border-radius:10px;padding:10px 14px;font-size:12px;color:var(--warning);font-weight:600;display:flex;align-items:center;gap:6px;">‚ö† ${text}</div>`;
}
function riskBadgeHtml(score) {
    if (score >= 70) return '<span style="background:var(--danger);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">‚ñ∂ KRITIK</span>';
    if (score >= 50) return '<span style="background:var(--warning);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">‚ñ∂ YUQORI</span>';
    if (score >= 25) return '<span style="background:var(--purple);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">O\'RTA</span>';
    return '<span style="background:var(--success);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">PAST</span>';
}

function renderEmpTable() {
    const q = (document.getElementById('empSearch')?.value||'').toLowerCase();
    const list = DB.employees.filter(e => e.fio.toLowerCase().includes(q) || e.position.toLowerCase().includes(q) || (e.department||'').toLowerCase().includes(q));
    const el = document.getElementById('empCards');
    if (!el) return;
    if (!list.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1;padding:40px;"><div class="e-icon">üë§</div><p>Xodim topilmadi</p></div>'; return; }
    el.innerHTML = list.map(e => {
        const sc = e.riskScore || 0;
        const isRisk = sc >= 50;
        return cardWrap(`
            <div style="display:flex;justify-content:space-between;align-items:center;">
                ${cardTitle(e.fio)}
                ${riskBadgeHtml(sc)}
            </div>
            <div style="font-size:14px;color:var(--text-secondary);font-weight:500;">${e.position}</div>
            ${cardRow('Bo\'lim', e.department || '‚Äî')}
            ${cardRow('Maosh', fmt(e.salary) + ' so\'m', {mono:true,bold:true})}
            ${cardRow('Risk ball', sc + ' / 100', {mono:true,bold:true,color:riskColor(sc)})}
            ${cardRow('Ish boshlagan', fd(e.startDate))}
            <div style="display:flex;gap:8px;margin-top:4px;">
                <button class="btn btn-ghost btn-sm" onclick="viewEmp(${e.id})" style="flex:1;">üëÅ Ko\'rish</button>
                <button class="btn btn-sm" style="background:var(--danger-soft);color:var(--danger);border:1px solid rgba(255,68,102,0.2);" onclick="confirmDeleteEmp(${e.id})">‚úï O\'chirish</button>
            </div>
        `, {risk: isRisk});
    }).join('');
}

function riskLabel(l) { return {critical:'KRITIK',high:'YUQORI',medium:"O'RTA",low:'PAST'}[l]||'PAST'; }
function riskColor(s) { if(s>=70) return 'var(--danger)'; if(s>=50) return 'var(--warning)'; if(s>=25) return 'var(--purple)'; return 'var(--success)'; }
function riskLvl(s) { if(s>=70) return 'critical'; if(s>=50) return 'high'; if(s>=25) return 'medium'; return 'low'; }

// Delete with animated confirm
let pendingDeleteId = null;
function confirmDeleteEmp(id) {
    const e = DB.employees.find(x=>x.id===id);
    if (!e) return;
    pendingDeleteId = id;
    document.getElementById('deleteMsg').textContent = `"${e.fio}" xodimini va barcha bog'liq ma'lumotlarini o'chirmoqchimisiz?`;
    document.getElementById('deleteOverlay').classList.add('show');
    document.getElementById('deleteConfirmBtn').onclick = () => doDeleteEmp();
}

function doDeleteEmp() {
    const id = pendingDeleteId;
    DB.employees = DB.employees.filter(e=>e.id!==id);
    DB.declarations = DB.declarations.filter(d=>d.empId!=id);
    DB.relatives = DB.relatives.filter(r=>r.empId!=id);
    DB.credits = DB.credits.filter(c=>c.empId!=id);
    DB.properties = DB.properties.filter(p=>p.empId!=id);
    DB.travels = DB.travels.filter(t=>t.empId!=id);
    DB.procurements = DB.procurements.filter(p=>p.empId!=id);
    DB.accounts = DB.accounts.filter(a=>a.empId!=id);
    closeDelete();
    popSelects(); renderAll(); updateDash();
    toast('Xodim muvaffaqiyatli o\'chirildi', 'warning');
}

function closeDelete() { document.getElementById('deleteOverlay').classList.remove('show'); pendingDeleteId = null; }

function viewEmp(id) {
    const e = DB.employees.find(x=>x.id===id);
    if (!e) return;
    const rels = DB.relatives.filter(r=>r.empId==id);
    const creds = DB.credits.filter(c=>c.empId==id);
    const props = DB.properties.filter(p=>p.empId==id);
    let h = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
        <div><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Lavozim</span><p style="font-weight:600;">${e.position}</p></div>
        <div><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Bo'lim</span><p style="font-weight:600;">${e.department||'‚Äî'}</p></div>
        <div><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Maosh</span><p class="mono" style="font-weight:600;">${fmt(e.salary)} so'm</p></div>
        <div><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;">Risk bali</span><p><span class="badge badge-${e.riskLevel}" style="font-size:12px;">${e.riskScore||0} ‚Äî ${riskLabel(e.riskLevel)}</span></p></div>
    </div>
    <div style="padding:12px;background:var(--bg-input);border-radius:10px;margin-bottom:12px;font-size:13px;">
        <strong>Yaqinlar:</strong> ${rels.length} | <strong>Kreditlar:</strong> ${creds.length} | <strong>Mol-mulk:</strong> ${props.length}
    </div>`;
    if (rels.length) {
        h += `<h4 style="font-size:13px;color:var(--accent);margin:12px 0 8px;">Yaqin qarindoshlar</h4>`;
        rels.forEach(r => { h += `<div style="padding:8px 0;border-bottom:1px solid var(--border-color);font-size:13px;">${r.fio} (${r.degree}) ‚Äî ${r.workplace||'‚Äî'} ${r.inBanking==='yes'?'<span class="chip chip-red">Bankda</span>':''} ${r.companyShare?'<span class="chip chip-orange">'+r.companyShare+'</span>':''}</div>`; });
    }
    openModal(e.fio, h);
}

// ============================================================
// DECLARATION
// ============================================================
function saveDecl() {
    const eid = document.getElementById('dEmp').value;
    if (!eid) { toast('Xodimni tanlang!','danger'); return; }
    DB.declarations.push({ id:gid(), empId:eid, date:document.getElementById('dDate').value, relBank:document.getElementById('dRelBank').value, relDetail:document.getElementById('dRelDetail').value, relDeg:document.getElementById('dRelDeg').value, share:document.getElementById('dShare').value, shareDetail:document.getElementById('dShareDetail').value });
    renderDeclTable(); updateDash(); toast('Deklaratsiya saqlandi','success');
}

function renderDeclTable() {
    const el = document.getElementById('declCards');
    if (!el) return;
    if (!DB.declarations.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1;padding:40px;"><div class="e-icon">üìã</div><p>Deklaratsiya mavjud emas</p></div>'; return; }
    el.innerHTML = DB.declarations.map(d => {
        const hasRel = d.relBank === 'yes';
        const hasShare = d.share !== 'no';
        const isRisk = hasRel || hasShare;
        return cardWrap(`
            <div style="display:flex;justify-content:space-between;align-items:center;">
                ${cardTitle(gn(d.empId))}
                ${isRisk ? '<span style="background:var(--danger);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">‚ñ∂ RISK</span>' : '<span style="background:var(--success);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">‚úì TOZA</span>'}
            </div>
            ${cardRow('Sana', fd(d.date))}
            ${cardRow('Bankda qarindosh', hasRel ? '‚ö† Mavjud' : '‚úì Yo\'q', {bold:true, color: hasRel ? 'var(--danger)' : 'var(--success)'})}
            ${hasRel && d.relDetail ? '<div style="font-size:12px;color:var(--text-muted);padding:4px 8px;background:var(--bg-input);border-radius:8px;">' + d.relDetail + (d.relDeg ? ' (' + d.relDeg + ')' : '') + '</div>' : ''}
            ${cardRow('Ustav ulushi', hasShare ? '‚ö† ' + (d.share==='self'?"O'zi":d.share==='rel'?'Qarindosh':'Ikkalasi') : '‚úì Yo\'q', {bold:true, color: hasShare ? 'var(--danger)' : 'var(--success)'})}
            ${hasShare && d.shareDetail ? '<div style="font-size:12px;color:var(--text-muted);padding:4px 8px;background:var(--bg-input);border-radius:8px;">' + d.shareDetail + '</div>' : ''}
        `, {risk: isRisk});
    }).join('');
}

// ============================================================
// RELATIVES
// ============================================================
function addRelative() {
    const eid = document.getElementById('rEmp').value;
    if (!eid) { toast('Xodimni tanlang!','danger'); return; }
    DB.relatives.push({ id:gid(), empId:eid, fio:document.getElementById('rFio').value, degree:document.getElementById('rDeg').value, workplace:document.getElementById('rWork').value, inBanking:document.getElementById('rInBank').value, companyShare:document.getElementById('rShare').value });
    renderRelTable(); updateDash(); toast('Qarindosh qo\'shildi','success');
}

function renderRelTable() {
    const el = document.getElementById('relCards');
    if (!el) return;
    if (!DB.relatives.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1;padding:40px;"><div class="e-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div><p>Qarindosh mavjud emas</p></div>'; return; }
    el.innerHTML = DB.relatives.map(r => {
        const inBank = r.inBanking === 'yes';
        const hasShare = !!r.companyShare;
        return cardWrap(`
            <div style="display:flex;justify-content:space-between;align-items:center;">
                ${cardTitle(r.fio)}
                ${inBank ? '<span style="background:var(--danger);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">üè¶ BANKDA</span>' : ''}
            </div>
            ${cardRow('Xodim', gn(r.empId), {bold:true})}
            ${cardRow('Qarindoshlik', r.degree)}
            ${cardRow('Ish joyi', r.workplace || '‚Äî')}
            ${hasShare ? cardWarning('Kompaniya ulushi: ' + r.companyShare) : ''}
        `, {risk: inBank || hasShare});
    }).join('');
}

// ============================================================
// CREDITS
// ============================================================
function addCredit() {
    const eid = document.getElementById('cEmp').value;
    if (!eid) { toast('Xodimni tanlang!','danger'); return; }
    DB.credits.push({ id:gid(), empId:eid, type:document.getElementById('cType').value, amount:parseFloat(document.getElementById('cAmt').value)||0, date:document.getElementById('cDate').value, bank:document.getElementById('cBank').value, inspOrg:document.getElementById('cInsp').value, inspDate:document.getElementById('cInspDate').value });
    renderCredTable(); updateDash(); toast('Kredit saqlandi','success');
}

function renderCredTable() {
    const el = document.getElementById('credCards');
    if (!el) return;
    if (!DB.credits.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1;padding:40px;"><div class="e-icon">üí≥</div><p>Kredit mavjud emas</p></div>'; return; }
    el.innerHTML = DB.credits.map(c => {
        const cr = creditRiskCheck(c);
        const amtColor = c.amount >= 500000000 ? 'var(--danger)' : c.amount >= 100000000 ? 'var(--warning)' : 'var(--success)';
        return cardWrap(`
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:12px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;">${c.type} kredit</span>
                ${cr.isRisk ? '<span style="background:var(--danger);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">‚ñ∂ RISK</span>' : ''}
            </div>
            ${cardTitle(gn(c.empId))}
            ${cardAmount(c.amount, amtColor)}
            ${cardRow('Kredit bergan bank', c.bank || '‚Äî')}
            ${cardRow('Kredit olingan sana', fd(c.date))}
            ${c.inspOrg ? cardRow('Tekshirgan bank', c.inspOrg) : ''}
            ${c.inspDate ? cardRow('Tekshiruv tugagan', fd(c.inspDate)) : ''}
            ${cr.isRisk ? cardWarning(cr.reason) : ''}
        `, {risk: cr.isRisk});
    }).join('');
}

// ============================================================
// PROPERTY
// ============================================================
function addProperty() {
    const eid = document.getElementById('pEmp').value;
    if (!eid) { toast('Xodimni tanlang!','danger'); return; }
    DB.properties.push({ id:gid(), empId:eid, owner:document.getElementById('pOwner').value, relName:document.getElementById('pRelName').value, type:document.getElementById('pType').value, value:parseFloat(document.getElementById('pVal').value)||0, date:document.getElementById('pDate').value, creditLink:document.getElementById('pCreditLink').value });
    renderPropTable(); updateDash(); toast('Mol-mulk saqlandi','success');
}

function renderPropTable() {
    const el = document.getElementById('propCards');
    if (!el) return;
    if (!DB.properties.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1;padding:40px;"><div class="e-icon">üè†</div><p>Mol-mulk mavjud emas</p></div>'; return; }
    el.innerHTML = DB.properties.map(p => {
        const bigVal = p.value > 200000000;
        const linked = p.creditLink === 'yes';
        const typeIcons = {'Kvartira':'üè¢','Avtomobil':'üöó','Uy':'üè†','Yer':'üåæ'};
        const icon = typeIcons[p.type] || 'üè†';
        const amtColor = bigVal ? 'var(--danger)' : 'var(--success)';
        return cardWrap(`
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:12px;color:var(--text-muted);">${icon} ${p.type}</span>
                ${linked ? '<span style="background:var(--warning);color:#fff;font-size:11px;font-weight:700;padding:4px 10px;border-radius:8px;">üí≥ Kredit</span>' : ''}
            </div>
            ${cardTitle(gn(p.empId))}
            ${cardAmount(p.value, amtColor)}
            ${cardRow('Egasi', p.owner==='self' ? "O'zi" : 'Qarindosh: ' + (p.relName||'‚Äî'), {bold:true})}
            ${cardRow('Sana', fd(p.date))}
            ${bigVal ? cardWarning('Qiymati maoshdan sezilarli yuqori!') : ''}
        `, {risk: bigVal || linked});
    }).join('');
}

// ============================================================
// TRAVEL
// ============================================================
function addTravel() {
    const eid = document.getElementById('tEmp').value;
    if (!eid) { toast('Xodimni tanlang!','danger'); return; }
    const cost = parseFloat(document.getElementById('tCost').value)||0;
    const sal = gs(eid);
    DB.travels.push({ id:gid(), empId:eid, who:document.getElementById('tWho').value, relName:document.getElementById('tRelName').value, country:document.getElementById('tCountry').value, dateOut:document.getElementById('tOut').value, dateIn:document.getElementById('tIn').value, purpose:document.getElementById('tPurpose').value, cost, ratio: sal>0?(cost/sal).toFixed(1):'‚Äî' });
    renderTravelTable(); updateDash(); toast('Safari saqlandi','success');
}

function renderTravelTable() {
    const el = document.getElementById('travelCards');
    if (!el) return;
    if (!DB.travels.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1;padding:40px;"><div class="e-icon">‚úàÔ∏è</div><p>Safari mavjud emas</p></div>'; return; }
    el.innerHTML = DB.travels.map(t => {
        const highRatio = parseFloat(t.ratio) >= 2;
        const amtColor = highRatio ? 'var(--danger)' : 'var(--success)';
        return cardWrap(`
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:12px;color:var(--text-muted);">‚úàÔ∏è ${t.purpose}</span>
                ${highRatio ? '<span style="background:var(--danger);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">‚ñ∂ RISK</span>' : ''}
            </div>
            ${cardTitle('üåç ' + t.country)}
            ${cardAmount(t.cost, amtColor)}
            ${cardRow('Xodim', gn(t.empId), {bold:true})}
            ${cardRow('Kim', t.who==='self' ? "O'zi" : 'Qarindosh: ' + t.relName)}
            ${cardRow('Davr', fd(t.dateOut) + ' ‚Üí ' + fd(t.dateIn))}
            ${cardRow('Maosh nisbati', t.ratio + 'x', {mono:true, bold:true, color:amtColor})}
            ${highRatio ? cardWarning('Xarajat maoshdan ' + t.ratio + 'x ortiq!') : ''}
        `, {risk: highRatio});
    }).join('');
}

// ============================================================
// PROCUREMENT
// ============================================================
function addProcurement() {
    const eid = document.getElementById('prEmp').value;
    if (!eid) { toast('Xodimni tanlang!','danger'); return; }
    const pNum = 'P' + String(DB.procurements.length + 1).padStart(3, '0');
    DB.procurements.push({
        id:gid(), empId:eid, org:document.getElementById('prOrg').value,
        amount:parseFloat(document.getElementById('prAmt').value)||0,
        date:document.getElementById('prDate').value,
        type:document.getElementById('prType').value,
        prevCount:parseInt(document.getElementById('prPrev').value)||0,
        title: document.getElementById('prTitle')?.value || document.getElementById('prOrg').value,
        status: document.getElementById('prStatus')?.value || 'investigating',
        bidCount: parseInt(document.getElementById('prBids')?.value)||3,
        pNum
    });
    renderProcCards(); updateDash(); toast('Xarid saqlandi','success');
}

function renderProcCards() {
    const container = document.getElementById('procCards');
    const emptyEl = document.getElementById('procEmpty');
    if (!container) return;
    
    const q = (document.getElementById('procSearch')?.value || '').toLowerCase();
    const filtered = DB.procurements.filter(p =>
        !q || (p.org||'').toLowerCase().includes(q) || (p.title||'').toLowerCase().includes(q) ||
        (p.type||'').toLowerCase().includes(q) || gn(p.empId).toLowerCase().includes(q)
    );
    
    if (!filtered.length) {
        container.innerHTML = '';
        if (emptyEl) emptyEl.style.display = 'block';
        return;
    }
    if (emptyEl) emptyEl.style.display = 'none';
    
    container.innerHTML = filtered.map((p, idx) => {
        const num = p.pNum || ('P' + String(idx + 1).padStart(3, '0'));
        const emp = DB.employees.find(e => e.id == p.empId);
        const empName = emp ? emp.fio.split(' ').slice(0, 2).join(' ') : '‚Äî';
        
        // --- Risk detection ---
        const isRepeat = p.prevCount >= 3;
        const rels = DB.relatives.filter(r => r.empId == p.empId);
        const hasConflict = rels.some(r =>
            (r.workplace && p.org && fuzzyMatch((r.workplace||'').toLowerCase(), (p.org||'').toLowerCase())) ||
            (r.companyShare && p.org && fuzzyMatch((r.companyShare||'').toLowerCase(), (p.org||'').toLowerCase()))
        );
        const decls = DB.declarations.filter(d => d.empId == p.empId);
        const hasShareConflict = decls.some(d => d.shareDetail && p.org && fuzzyMatch((d.shareDetail||'').toLowerCase(), (p.org||'').toLowerCase()));
        const isRisk = isRepeat || hasConflict || hasShareConflict;
        
        // --- Risk reasons ---
        const warnings = [];
        if (hasConflict) warnings.push("Mas'ul hodimda manfaatlar to'qnashuvi aniqlangan!");
        if (hasShareConflict) warnings.push("Mas'ul xodimning ustav ulushi aniqlangan!");
        if (isRepeat) warnings.push(`Yetkazuvchi ${p.prevCount}+ marta qayta tanlangan!`);
        
        // --- Status styling ---
        const statusMap = {
            investigating: { icon: 'üîç', label: 'Tekshirilmoqda', color: 'var(--warning)', bg: 'var(--warning-soft)' },
            approved: { icon: '‚úÖ', label: 'Tasdiqlangan', color: 'var(--success)', bg: 'var(--success-soft)' },
            pending: { icon: '‚è≥', label: 'Kutilmoqda', color: 'var(--accent)', bg: 'var(--accent-soft)' },
            rejected: { icon: '‚ùå', label: 'Rad etilgan', color: 'var(--danger)', bg: 'var(--danger-soft)' }
        };
        const st = statusMap[p.status] || statusMap.investigating;
        
        // --- Amount color ---
        const amtColor = p.amount >= 500000000 ? 'var(--danger)' : p.amount >= 100000000 ? 'var(--warning)' : 'var(--success)';
        
        return `<div style="
            background:var(--bg-card);
            border-radius:16px;
            padding:22px;
            border:1px solid ${isRisk ? 'rgba(255,68,102,0.3)' : 'var(--border-color)'};
            ${isRisk ? 'box-shadow:0 0 20px rgba(255,68,102,0.08);' : 'box-shadow:var(--shadow-card);'}
            transition:all 0.25s ease;
            position:relative;
            display:flex;flex-direction:column;gap:10px;
        " onmouseenter="this.style.transform='translateY(-3px)';this.style.boxShadow='0 12px 36px rgba(0,0,0,0.15)'" onmouseleave="this.style.transform='';this.style.boxShadow=''">
        
            <!-- Top row: ID + category / Risk badge -->
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:12px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;font-weight:500;">${num} &nbsp;|&nbsp; ${p.type || 'Boshqa'}</span>
                ${isRisk ? '<span style="background:var(--danger);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;display:flex;align-items:center;gap:4px;">‚ñ∂ RISK</span>' : ''}
            </div>
            
            <!-- Title -->
            <div style="font-size:17px;font-weight:800;color:var(--text-primary);line-height:1.3;">${p.title || p.org || 'Nomsiz xarid'}</div>
            
            <!-- Vendor + Status row -->
            <div style="display:flex;justify-content:space-between;align-items:flex-end;gap:12px;">
                <div>
                    <div style="font-size:11px;color:var(--text-muted);">Yetkazib beruvchi</div>
                    <div style="font-size:14px;font-weight:700;color:var(--text-primary);">${p.org || '‚Äî'}</div>
                </div>
                <span style="font-size:12px;font-weight:600;color:${st.color};background:${st.bg};padding:5px 14px;border-radius:8px;white-space:nowrap;display:flex;align-items:center;gap:4px;">${st.icon} ${st.label}</span>
            </div>
            
            <!-- Amount (large, colored) -->
            <div style="font-size:26px;font-weight:900;color:${amtColor};font-family:'JetBrains Mono',monospace;letter-spacing:-0.5px;margin:4px 0;">
                ${Number(p.amount).toLocaleString('en-US')} UZS
            </div>
            
            <!-- Bottom row: responsible + bids -->
            <div style="display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--text-muted);padding-top:6px;border-top:1px solid var(--border-color);">
                <span>Mas'ul: <strong style="color:var(--text-primary);">${empName}</strong></span>
                <span>Takliflar: <strong>${p.bidCount || p.prevCount || 0}</strong></span>
            </div>
            
            <!-- Warning alerts (if risk detected) -->
            ${warnings.map(w => `<div style="background:rgba(255,170,34,0.08);border:1px solid rgba(255,170,34,0.2);border-radius:10px;padding:10px 14px;font-size:12px;color:var(--warning);font-weight:600;display:flex;align-items:center;gap:6px;">‚ö† ${w}</div>`).join('')}
            
            <!-- Date -->
            <div style="font-size:11px;color:var(--text-muted);text-align:right;">${fd(p.date)}</div>
        </div>`;
    }).join('');
}
// Alias for backward compatibility
function renderProcTable() { renderProcCards(); }

// ============================================================
// ACCOUNTS ‚Äî 5x RULE
// ============================================================
function loadSalary() {
    const eid = document.getElementById('aEmp').value;
    const s = gs(eid);
    document.getElementById('aSal').value = s||'';
    document.getElementById('a5x').value = s ? fmt(s*5) : '';
}

function addAccount() {
    const eid = document.getElementById('aEmp').value;
    if (!eid) { toast('Xodimni tanlang!','danger'); return; }
    const bal = parseFloat(document.getElementById('aBal').value)||0;
    const sal = gs(eid);
    const ratio = sal>0?(bal/sal):0;
    const exceeded = ratio>=5;
    DB.accounts.push({ id:gid(), empId:eid, num:document.getElementById('aNum').value, balance:bal, salary:sal, ratio:ratio.toFixed(1), month:document.getElementById('aMonth').value, exceeded });
    if (exceeded) {
        const e = DB.employees.find(x=>x.id==eid);
        DB.alerts.push({ id:gid(), empId:eid, msg:`üö® ${e.fio}: Balans ${fmt(bal)} so'm ‚Äî maoshdan ${ratio.toFixed(1)}x ortiq!`, date:new Date().toISOString(), severity:'critical' });
        triggerRemon(eid);
    }
    renderAccTable(); updateDash();
    toast(exceeded?'üö® Balans 5x oshdi! Qayta monitoring boshlandi.':'‚úÖ Balans normal.', exceeded?'danger':'success');
}

function triggerRemon(eid) {
    const e = DB.employees.find(x=>x.id==eid);
    let f=[];
    DB.credits.filter(c=>c.empId==eid&&creditRiskCheck(c).isRisk).forEach(c=>{f.push(`Kredit: ${c.type} ‚Äî ${fmt(c.amount)} | Tekshirgan bank: ${c.inspOrg}`);});
    DB.properties.filter(p=>p.empId==eid&&p.creditLink==='yes').forEach(p=>{f.push(`Mol-mulk: ${p.type} ‚Äî ${fmt(p.value)}`);});
    DB.monLog.push({ id:gid(), empId:eid, name:e.fio, date:new Date().toISOString(), reason:'Balans 5x+', findings:f, flagged:f.length>0 });
}

function renderAccTable() {
    const alerts = DB.accounts.filter(a=>a.exceeded);
    const badge = document.getElementById('accBadge');
    if (badge) { badge.style.display = alerts.length?'inline':'none'; badge.textContent = alerts.length; }
    const alertsEl = document.getElementById('accAlerts');
    if (alertsEl) alertsEl.innerHTML = alerts.map(a=>`<div class="alert alert-danger"><span class="alert-icon">üö®</span><div><strong>${gn(a.empId)}</strong>: ${fmt(a.balance)} so'm = <strong>${a.ratio}x</strong> maosh<br><small style="color:var(--text-muted)">${a.num} | ${a.month}</small></div></div>`).join('');

    const el = document.getElementById('accCards');
    if (!el) return;
    if (!DB.accounts.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1;padding:40px;"><div class="e-icon">üè¶</div><p>Hisob mavjud emas</p></div>'; return; }
    el.innerHTML = DB.accounts.map(a => {
        const amtColor = a.exceeded ? 'var(--danger)' : 'var(--success)';
        return cardWrap(`
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:12px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;">${a.num}</span>
                ${a.exceeded ? '<span style="background:var(--danger);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">üö® 5x OSHGAN</span>' : '<span style="background:var(--success);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">‚úÖ Normal</span>'}
            </div>
            ${cardTitle(gn(a.empId))}
            ${cardAmount(a.balance, amtColor)}
            ${cardRow('Maosh', fmt(a.salary) + ' so\'m', {mono:true})}
            ${cardRow('Nisbat', a.ratio + 'x', {mono:true, bold:true, color:amtColor})}
            ${cardRow('Oy', a.month)}
            ${a.exceeded ? cardWarning('Balans maoshdan ' + a.ratio + 'x ortiq ‚Äî 5x qoidasi buzilgan!') : ''}
        `, {risk: a.exceeded});
    }).join('');
}


// ============================================================
// V3: GIFT CRUD
// ============================================================
function addGift() {
    const eid = parseInt(document.getElementById('gEmp').value);
    if (!eid) return toast('Xodim tanlang', 'warning');
    DB.gifts.push({
        id: gid(), empId: eid, date: document.getElementById('gDate').value,
        direction: document.getElementById('gDir').value,
        from: document.getElementById('gFrom').value,
        type: document.getElementById('gType').value,
        value: parseFloat(document.getElementById('gValue').value) || 0,
        reason: document.getElementById('gReason').value,
        relation: document.getElementById('gRelation').value,
        status: 'pending', // pending, approved, rejected, escalated
        approvedBy: null
    });
    renderGifts(); toast('Sovg\'a qayd etildi', 'success');
    // Auto-check thresholds
    const g = DB.gifts[DB.gifts.length - 1];
    if (g.value > 250000000) { g.status = 'escalated'; toast('‚ö†Ô∏è Sovg\'a 250M+ ‚Äî senior compliance tasdiqlashi kerak!', 'danger'); }
    else if (g.relation === 'gov') { g.status = 'escalated'; toast('‚ö†Ô∏è Davlat xodimidan sovg\'a ‚Äî maxsus tasdiqlash!', 'warning'); }
    else if (g.value > 100000000) { g.status = 'pending'; toast('Compliance tasdiqlashi kerak', 'warning'); }
    renderGifts();
}
function renderGifts() {
    const el = document.getElementById('giftCards');
    if (!el) return;
    if (!DB.gifts.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1;padding:40px;"><div class="e-icon">üéÅ</div><p>Sovg\'a mavjud emas</p></div>'; return; }
    const statMap = { pending:{icon:'‚è≥',label:'Kutilmoqda',color:'var(--warning)',bg:'var(--warning-soft)'}, approved:{icon:'‚úÖ',label:'Tasdiqlangan',color:'var(--success)',bg:'var(--success-soft)'}, rejected:{icon:'‚ùå',label:'Rad etilgan',color:'var(--danger)',bg:'var(--danger-soft)'}, escalated:{icon:'üö®',label:'Eskalatsiya',color:'var(--danger)',bg:'var(--danger-soft)'} };
    el.innerHTML = DB.gifts.map(g => {
        const st = statMap[g.status] || statMap.pending;
        const isGov = g.relation === 'gov';
        const amtColor = g.value >= 100000000 ? 'var(--danger)' : g.value >= 25000000 ? 'var(--warning)' : 'var(--success)';
        return cardWrap(`
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:12px;color:var(--text-muted);">${g.direction==='received'?'üì• Qabul qilindi':'üì§ Berildi'} | ${g.type}</span>
                ${isGov ? '<span style="background:var(--danger);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">üèõÔ∏è GOV</span>' : ''}
            </div>
            ${cardTitle(gn(g.empId))}
            <div style="display:flex;justify-content:space-between;align-items:flex-end;">
                <div><div style="font-size:11px;color:var(--text-muted);">${g.direction==='received'?'Kimdan':'Kimga'}</div><div style="font-weight:700;">${g.from}</div></div>
                <span style="font-size:12px;font-weight:600;color:${st.color};background:${st.bg};padding:5px 14px;border-radius:8px;">${st.icon} ${st.label}</span>
            </div>
            ${cardAmount(g.value, amtColor)}
            ${cardRow('Sabab', g.reason)}
            ${cardMeta(fd(g.date), '')}
            ${isGov ? cardWarning('Davlat xodimiga/dan sovg\'a ‚Äî maxsus tasdiqlash talab etiladi!') : ''}
        `, {risk: isGov || g.status === 'escalated'});
    }).join('');
}

// ============================================================
// V3: CONTRACT CRUD
// ============================================================
function addContract() {
    const eid = parseInt(document.getElementById('ctEmp').value);
    if (!eid) return toast('Xodim tanlang', 'warning');
    const ct = {
        id: gid(), empId: eid, vendor: document.getElementById('ctVendor').value,
        number: document.getElementById('ctNum').value,
        amount: parseFloat(document.getElementById('ctAmount').value) || 0,
        date: document.getElementById('ctDate').value,
        startDate: document.getElementById('ctStartDate').value,
        type: document.getElementById('ctType').value,
        method: document.getElementById('ctMethod').value,
        amendments: parseInt(document.getElementById('ctAmendments').value) || 0,
        amendAmount: parseFloat(document.getElementById('ctAmendAmount').value) || 0
    };
    DB.contracts.push(ct);
    renderContracts(); toast('Kontrakt saqlandi', 'success');
    // Auto-checks
    if (ct.startDate && ct.date && ct.startDate < ct.date) {
        toast('üö® RETROAKTIV KONTRAKT ‚Äî ish boshlangan sana kontrakt sanasidan oldin!', 'danger');
        DB.alerts.push({ id:gid(), empId:eid, msg:'üö® Retroaktiv kontrakt: ' + ct.vendor + ' ‚Äî ish ' + ct.startDate + ', kontrakt ' + ct.date, date:new Date().toISOString(), severity:'critical' });
    }
}
function renderContracts() {
    const el = document.getElementById('contractCards');
    if (!el) return;
    if (!DB.contracts.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1;padding:40px;"><div class="e-icon">üìù</div><p>Kontrakt mavjud emas</p></div>'; return; }
    const methods = { tender:'üè∑Ô∏è Tender', direct:'‚û°Ô∏è To\'g\'ridan', emergency:'‚ö° Tezkor', framework:'üìã Ramka' };
    el.innerHTML = DB.contracts.map(c => {
        const isRetro = c.startDate && c.date && c.startDate < c.date;
        const hasAmend = c.amendments > 0;
        const amtColor = c.amount >= 500000000 ? 'var(--danger)' : c.amount >= 100000000 ? 'var(--warning)' : 'var(--success)';
        return cardWrap(`
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:12px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;">${c.number} | ${c.type}</span>
                ${isRetro ? '<span style="background:var(--danger);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">‚ñ∂ RETRO</span>' : ''}
            </div>
            ${cardTitle(c.vendor)}
            ${cardAmount(c.amount, amtColor)}
            ${cardRow('Mas\'ul', gn(c.empId), {bold:true})}
            ${cardRow('Usul', methods[c.method] || c.method)}
            ${cardRow('Sana', fd(c.date))}
            ${hasAmend ? cardWarning(c.amendments + ' ta o\'zgartirish ‚Äî jami ' + fmt(c.amendAmount) + ' so\'m') : ''}
            ${isRetro ? cardWarning('RETROAKTIV ‚Äî ish boshlangan sana kontrakt sanasidan oldin!') : ''}
        `, {risk: isRetro || hasAmend});
    }).join('');
}

// ============================================================
// V3: WHISTLEBLOWER CRUD
// ============================================================
let wbCounter = 1000;
function addWhistleblower() {
    const detail = document.getElementById('wbDetail').value;
    if (!detail || detail.length < 10) return toast('Batafsil ma\'lumot kiriting (kamida 10 belgi)', 'warning');
    wbCounter++;
    DB.whistleblower.push({
        id: gid(), caseId: 'WB-' + wbCounter,
        date: new Date().toISOString().split('T')[0],
        severity: document.getElementById('wbSeverity').value,
        category: document.getElementById('wbCategory').value,
        department: document.getElementById('wbDept').value || 'Noma\'lum',
        suspect: document.getElementById('wbSuspect').value || 'Noma\'lum',
        detail: detail,
        status: 'new', // new, investigating, substantiated, unsubstantiated, closed
        assignedTo: null,
        notes: []
    });
    document.getElementById('wbDetail').value = '';
    renderWhistleblower();
    toast('üîê Xabar muvaffaqiyatli yuborildi ‚Äî Case ID: WB-' + wbCounter, 'success');
    const b = document.getElementById('wbBadge');
    if (b) { b.textContent = DB.whistleblower.filter(w => w.status === 'new').length; b.style.display = 'inline'; }
}
function updateWbStatus(id, status) {
    const wb = DB.whistleblower.find(w => w.id === id);
    if (wb) { wb.status = status; renderWhistleblower(); toast('Holat yangilandi: ' + status, 'info'); }
}
function renderWhistleblower() {
    const el = document.getElementById('wbCards');
    if (!el) return;
    if (!DB.whistleblower.length) { el.innerHTML = '<div class="empty" style="grid-column:1/-1;padding:40px;"><div class="e-icon">üîê</div><p>Xabar mavjud emas</p></div>'; return; }
    const catLabels = { corruption:'Korrupsiya', fraud:'Firibgarlik', bribery:'Pora', conflict:'Manfaat to\'qnashuvi', theft:'O\'g\'irlik', harassment:'Ta\'qib', other:'Boshqa' };
    const statMap = { new:{icon:'üÜï',label:'Yangi',color:'var(--accent)',bg:'var(--accent-soft)'}, investigating:{icon:'üîç',label:'Tekshirilmoqda',color:'var(--warning)',bg:'var(--warning-soft)'}, substantiated:{icon:'‚úÖ',label:'Tasdiqlangan',color:'var(--success)',bg:'var(--success-soft)'}, unsubstantiated:{icon:'‚ùå',label:'Tasdiqlanmagan',color:'var(--danger)',bg:'var(--danger-soft)'}, closed:{icon:'üìÅ',label:'Yopilgan',color:'var(--text-muted)',bg:'var(--bg-input)'} };
    const sevColors = { P1:'var(--danger)', P2:'var(--warning)', P3:'var(--warning)', P4:'var(--success)' };
    el.innerHTML = DB.whistleblower.map(w => {
        const st = statMap[w.status] || statMap.new;
        const isHigh = w.severity === 'P1' || w.severity === 'P2';
        return cardWrap(`
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:13px;font-weight:800;font-family:'JetBrains Mono',monospace;color:${sevColors[w.severity]||'var(--text-muted)'};">${w.caseId} ‚Äî ${w.severity}</span>
                ${isHigh ? '<span style="background:var(--danger);color:#fff;font-size:11px;font-weight:800;padding:4px 12px;border-radius:8px;">‚ñ∂ JIDDIY</span>' : ''}
            </div>
            ${cardTitle(catLabels[w.category] || w.category)}
            <div style="font-size:13px;color:var(--text-secondary);line-height:1.6;max-height:80px;overflow:hidden;">${w.detail}</div>
            ${cardRow('Bo\'lim', w.department)}
            ${cardRow('Gumon', w.suspect || 'Noma\'lum')}
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:12px;font-weight:600;color:${st.color};background:${st.bg};padding:5px 14px;border-radius:8px;">${st.icon} ${st.label}</span>
                <div style="display:flex;gap:6px;">
                    <button class="btn btn-ghost btn-sm" onclick="updateWbStatus(${w.id},'investigating')" title="Tekshirish">üîç</button>
                    <button class="btn btn-ghost btn-sm" onclick="updateWbStatus(${w.id},'substantiated')" title="Tasdiqlash">‚úÖ</button>
                    <button class="btn btn-ghost btn-sm" onclick="updateWbStatus(${w.id},'closed')" title="Yopish">üìÅ</button>
                </div>
            </div>
            ${cardMeta(fd(w.date), '')}
        `, {risk: isHigh});
    }).join('');
}

// ============================================================
// SCORING ENGINE
// ============================================================
// ============================================================
// üîç TEKSHIRUV-KREDIT KORRELYATSIYA ANIQLASH
// Markaziy bank xodimi tekshirgan bankdan 1-3 oy ichida
// o'zi yoki yaqin qarindoshlari kredit olganligi tekshiriladi
// ============================================================

/**
 * Kredit tekshirgan bankdan olinganmi? (xodimning o'zi)
 * Kriteriya: kredit bergan bank = xodim tekshirgan bank + 30-90 kun orasida
 */
function isPostInspCredit(c) {
    if (!c.inspOrg || !c.inspDate || !c.bank || !c.date) return false;
    // Fuzzy bank name matching ‚Äî asosiy so'zni solishtirish
    const bankNorm = (c.bank||'').toLowerCase().replace(/['"]/g,'').trim();
    const inspNorm = (c.inspOrg||'').toLowerCase().replace(/['"]/g,'').trim();
    // Bank nomlari mos kelishini tekshirish ‚Äî partial match
    const bankMatch = bankNorm && inspNorm && (
        bankNorm.includes(inspNorm) || inspNorm.includes(bankNorm) ||
        bankNorm.split(/\s+/).some(w => w.length > 3 && inspNorm.includes(w)) ||
        inspNorm.split(/\s+/).some(w => w.length > 3 && bankNorm.includes(w))
    );
    if (!bankMatch) return false;
    // Vaqt oralig'ini tekshirish: 30-90 kun (1-3 oy)
    const credDate = new Date(c.date);
    const inspEnd = new Date(c.inspDate);
    const diffDays = Math.round((credDate - inspEnd) / 86400000);
    return diffDays >= 30 && diffDays <= 90;
}

/**
 * Xodimning yaqin qarindoshlari tekshirilgan bankdan kredit olganmi?
 * Har bir kreditni xodimning barcha qarindoshlari bilan cross-reference qiladi
 */
function isRelInspCredit(c) {
    if (!c.bank || !c.date) return false;
    const bankNorm = (c.bank||'').toLowerCase().replace(/['"]/g,'').trim();
    
    // Bu xodimning yaqin qarindoshlari
    const rels = DB.relatives.filter(r => r.empId == c.empId);
    if (!rels.length) return false;
    
    // Qarindoshning ish joyi bu bank bilan bog'liqmi?
    const relAtBank = rels.some(r => {
        const wNorm = (r.workplace||'').toLowerCase().replace(/['"]/g,'').trim();
        return wNorm && bankNorm && (
            wNorm.includes(bankNorm) || bankNorm.includes(wNorm) ||
            wNorm.split(/[\s,]+/).some(w => w.length > 3 && bankNorm.includes(w))
        );
    });
    
    if (!relAtBank) return false;
    
    // Bu bank boshqa MB xodimi tomonidan tekshirilganmi?
    // Barcha kreditlardagi inspOrg larni tekshiramiz
    const inspections = DB.credits.filter(ic => ic.inspOrg && ic.inspDate).map(ic => ({
        inspOrg: (ic.inspOrg||'').toLowerCase().replace(/['"]/g,'').trim(),
        inspDate: new Date(ic.inspDate)
    }));
    
    const credDate = new Date(c.date);
    
    return inspections.some(insp => {
        const inspMatch = insp.inspOrg && bankNorm && (
            insp.inspOrg.includes(bankNorm) || bankNorm.includes(insp.inspOrg) ||
            insp.inspOrg.split(/\s+/).some(w => w.length > 3 && bankNorm.includes(w))
        );
        if (!inspMatch) return false;
        const diffDays = Math.round((credDate - insp.inspDate) / 86400000);
        return diffDays >= 30 && diffDays <= 90;
    });
}

/**
 * Kreditning umumiy risk holatini qaytaradi
 * @returns {object} {isRisk, reason, type}
 */
function creditRiskCheck(c) {
    const postInsp = isPostInspCredit(c);
    const relInsp = isRelInspCredit(c);
    if (postInsp) return { isRisk:true, reason:'Tekshirgan bankdan ' + daysBetween(c.inspDate, c.date) + ' kunda kredit olgan!', type:'post_inspection' };
    if (relInsp) return { isRisk:true, reason:'Qarindoshi tekshirilgan bankda ishlaydi ‚Äî ' + daysBetween(c.inspDate, c.date) + ' kunda kredit!', type:'rel_inspection' };
    return { isRisk:false, reason:'', type:'normal' };
}

function daysBetween(d1, d2) {
    return Math.abs(Math.round((new Date(d2) - new Date(d1)) / 86400000));
}

function scoreFor(eid) {
    let s = { conflict:0, credit:0, property:0, balance:0, procurement:0, total:0 };
    DB.declarations.filter(d=>d.empId==eid).forEach(d=>{ if(d.relBank==='yes') s.conflict+=12; if(d.share==='self') s.conflict+=10; else if(d.share==='rel') s.conflict+=8; else if(d.share==='both') s.conflict+=13; });
    DB.relatives.filter(r=>r.empId==eid).forEach(r=>{ if(r.inBanking==='yes') s.conflict+=5; if(r.companyShare) s.conflict+=4; });
    s.conflict = Math.min(s.conflict,25);
    DB.credits.filter(c=>c.empId==eid).forEach(c=>{ const cr=creditRiskCheck(c); if(cr.isRisk) s.credit+=15; if(c.amount>500e6) s.credit+=5; else if(c.amount>100e6) s.credit+=3; });
    s.credit = Math.min(s.credit,25);
    DB.properties.filter(p=>p.empId==eid).forEach(p=>{ if(p.creditLink==='yes') s.property+=12; const sal=gs(eid); if(sal>0&&p.value>sal*24) s.property+=5; });
    DB.travels.filter(t=>t.empId==eid).forEach(t=>{ if(parseFloat(t.ratio)>3) s.property+=3; });
    s.property = Math.min(s.property,20);
    DB.accounts.filter(a=>a.empId==eid).forEach(a=>{ if(a.exceeded){const r=parseFloat(a.ratio); s.balance+= r>=10?15:r>=7?10:7;} });
    s.balance = Math.min(s.balance,15);
    DB.procurements.filter(p=>p.empId==eid).forEach(p=>{ if(p.prevCount>=5) s.procurement+=10; else if(p.prevCount>=3) s.procurement+=6; if(p.amount>500e6) s.procurement+=5; });
    s.procurement = Math.min(s.procurement,15);
    s.total = s.conflict+s.credit+s.property+s.balance+s.procurement;
    return s;
}

function calcScore() {
    const eid = document.getElementById('scEmp').value;
    if (!eid) { document.getElementById('scoreResult').style.display='none'; return; }
    const s = scoreFor(eid);
    const emp = DB.employees.find(e=>e.id==eid);
    
    // Oldingi balini topib, o'zgarishni hisoblash
    const prevEntries = DB.scoreHistory.filter(h => h.empId == eid);
    const prevScore = prevEntries.length > 0 ? prevEntries[prevEntries.length - 1].total : null;
    const change = prevScore !== null ? s.total - prevScore : null;
    
    // Tarixga saqlash
    DB.scoreHistory.push({
        id: gid(),
        empId: eid,
        empName: emp.fio,
        empPosition: emp.position,
        date: new Date().toISOString(),
        conflict: s.conflict,
        credit: s.credit,
        property: s.property,
        balance: s.balance,
        procurement: s.procurement,
        total: s.total,
        level: riskLvl(s.total),
        change: change
    });
    
    emp.riskScore = s.total; emp.riskLevel = riskLvl(s.total);

    document.getElementById('scoreResult').style.display = 'block';
    const col = riskColor(s.total);
    const arc = document.getElementById('scArc');
    arc.style.strokeDashoffset = 490 - (490*s.total/100);
    arc.style.stroke = col;
    document.getElementById('scVal').textContent = s.total;
    document.getElementById('scVal').style.color = col;
    document.getElementById('scLevel').innerHTML = `<span class="badge badge-${emp.riskLevel}" style="font-size:13px;padding:6px 18px;">${riskLabel(emp.riskLevel)} XAVF</span>`;

    const items = [
        {l:"Manfaatlar to'qnashuvi",v:s.conflict,m:25,c:'var(--danger)'},
        {l:"Kredit xavfi",v:s.credit,m:25,c:'var(--warning)'},
        {l:"Mol-mulk xavfi",v:s.property,m:20,c:'var(--purple)'},
        {l:"Balans anomaliyasi",v:s.balance,m:15,c:'var(--cyan)'},
        {l:"Xarid xavfi",v:s.procurement,m:15,c:'var(--accent)'}
    ];
    document.getElementById('scBreakdown').innerHTML = `<h4 style="font-size:14px;margin-bottom:14px;color:var(--accent);font-weight:700;">Tarkib</h4>` +
        items.map(i=>`<div class="score-bar-item"><div class="score-bar-top"><span>${i.l}</span><span style="color:${i.c}">${i.v} / ${i.m}</span></div><div class="score-bar-bg"><div class="score-bar-fill" style="width:${i.v/i.m*100}%;background:${i.c};"></div></div></div>`).join('');

    let recs=[];
    if(s.conflict>=15) recs.push('üî¥ Manfaatlar to\'qnashuvi jiddiy ‚Äî deklaratsiyani qayta ko\'ring.');
    if(s.credit>=15) recs.push('üî¥ O\'zi kredit ajratgan ‚Äî ichki audit tekshirsin.');
    if(s.balance>=7) recs.push('üü† Balans anomal ‚Äî manbani aniqlang.');
    if(s.property>=10) recs.push('üü† Mol-mulk shubhali ‚Äî kredit korrelyatsiyasini tekshiring.');
    if(s.procurement>=6) recs.push('üü° Takroriy xaridlar ‚Äî tashkilot aloqasini tekshiring.');
    if(s.total<25) recs.push('üü¢ Past xavf darajasida.');
    document.getElementById('scRecs').innerHTML = recs.length?`<div class="card" style="margin-top:16px;"><div class="card-header"><div class="card-title"><span class="icon">üí°</span> Tavsiyalar</div></div>${recs.map(r=>`<div style="padding:8px 0;font-size:13px;border-bottom:1px solid var(--border-color);">${r}</div>`).join('')}</div>`:'';
    renderEmpTable();
    renderScoreHistory();
}

function calcAllScores() {
    const batchDate = new Date().toISOString();
    DB.employees.forEach(e=>{
        const s=scoreFor(e.id);
        // Oldingi bal
        const prevEntries = DB.scoreHistory.filter(h => h.empId == e.id);
        const prevScore = prevEntries.length > 0 ? prevEntries[prevEntries.length - 1].total : null;
        const change = prevScore !== null ? s.total - prevScore : null;
        
        // Tarixga saqlash
        DB.scoreHistory.push({
            id: gid(),
            empId: e.id,
            empName: e.fio,
            empPosition: e.position,
            date: batchDate,
            conflict: s.conflict,
            credit: s.credit,
            property: s.property,
            balance: s.balance,
            procurement: s.procurement,
            total: s.total,
            level: riskLvl(s.total),
            change: change
        });
        
        e.riskScore=s.total; e.riskLevel=riskLvl(s.total);
    });
    const sorted = [...DB.employees].sort((a,b)=>b.riskScore-a.riskScore);
    document.getElementById('scTbody').innerHTML = sorted.map(e=>{
        const s=scoreFor(e.id);
        return `<tr><td><strong>${e.fio}</strong></td><td>${e.position}</td>
        <td class="mono">${s.conflict}</td><td class="mono">${s.credit}</td><td class="mono">${s.property}</td><td class="mono">${s.balance}</td><td class="mono">${s.procurement}</td>
        <td class="mono" style="font-weight:800;color:${riskColor(s.total)};">${s.total}</td>
        <td><span class="badge badge-${e.riskLevel}">${riskLabel(e.riskLevel)}</span></td></tr>`;
    }).join('');
    renderEmpTable(); updateDash(); renderScoreHistory(); toast('Barcha ballar hisoblandi','info');
}

// ============================================================
// SCORING HISTORY ‚Äî saqlash va ko'rsatish
// ============================================================
function renderScoreHistory() {
    const filterEmp = document.getElementById('scHistFilter').value;
    let history = [...DB.scoreHistory].reverse(); // Eng yangi birinchi
    
    // Filter bo'yicha saralash
    if (filterEmp !== 'all') {
        history = history.filter(h => h.empId == filterEmp);
    }
    
    // History filter select'ini yangilash
    updateHistoryFilter();
    
    // Empty/table toggle
    if (history.length === 0) {
        document.getElementById('scHistEmpty').style.display = 'block';
        document.getElementById('scHistTableWrap').style.display = 'none';
        return;
    }
    document.getElementById('scHistEmpty').style.display = 'none';
    document.getElementById('scHistTableWrap').style.display = 'block';
    
    const tbody = document.getElementById('scHistTbody');
    tbody.innerHTML = history.map((h, i) => {
        // O'zgarish ko'rsatkichi
        let changeHtml = '‚Äî';
        if (h.change !== null && h.change !== undefined) {
            if (h.change > 0) {
                changeHtml = `<span style="color:var(--danger);font-weight:700;font-family:'JetBrains Mono',monospace;">‚ñ≤ +${h.change}</span>`;
            } else if (h.change < 0) {
                changeHtml = `<span style="color:var(--success);font-weight:700;font-family:'JetBrains Mono',monospace;">‚ñº ${h.change}</span>`;
            } else {
                changeHtml = `<span style="color:var(--text-muted);font-family:'JetBrains Mono',monospace;">‚óè 0</span>`;
            }
        } else {
            changeHtml = `<span class="chip chip-blue">Birinchi</span>`;
        }
        
        // Sana formatlash
        const d = new Date(h.date);
        const dateStr = d.toLocaleDateString('uz-UZ') + ' ' + d.toLocaleTimeString('uz-UZ', {hour:'2-digit',minute:'2-digit'});
        
        return `<tr style="animation:sectionIn 0.3s ease ${Math.min(i*0.04, 0.5)}s both;">
            <td class="mono">${history.length - i}</td>
            <td><span class="mono" style="font-size:11px;">${dateStr}</span></td>
            <td><strong>${h.empName}</strong></td>
            <td style="font-size:12px;color:var(--text-secondary);">${h.empPosition}</td>
            <td class="mono">${h.conflict}</td>
            <td class="mono">${h.credit}</td>
            <td class="mono">${h.property}</td>
            <td class="mono">${h.balance}</td>
            <td class="mono">${h.procurement}</td>
            <td class="mono" style="font-weight:800;color:${riskColor(h.total)};">${h.total}</td>
            <td><span class="badge badge-${h.level}">${riskLabel(h.level)}</span></td>
            <td>${changeHtml}</td>
        </tr>`;
    }).join('');
}

function updateHistoryFilter() {
    const sel = document.getElementById('scHistFilter');
    const currentVal = sel.value;
    
    // Tarixda mavjud xodimlarni aniqlash
    const empIds = [...new Set(DB.scoreHistory.map(h => h.empId))];
    
    sel.innerHTML = '<option value="all">Barcha xodimlar</option>';
    empIds.forEach(eid => {
        const emp = DB.employees.find(e => e.id == eid);
        const name = emp ? emp.fio : (DB.scoreHistory.find(h => h.empId == eid)?.empName || '‚Äî');
        sel.innerHTML += `<option value="${eid}">${name}</option>`;
    });
    
    sel.value = currentVal || 'all';
}

function clearScoreHistory() {
    if (DB.scoreHistory.length === 0) {
        toast('Tarix allaqachon bo\'sh', 'info');
        return;
    }
    // Tasdiqlash
    if (!confirm('Scoring tarixini butunlay o\'chirmoqchimisiz?')) return;
    DB.scoreHistory = [];
    renderScoreHistory();
    toast('Scoring tarixi tozalandi', 'warning');
}

// ============================================================
// MONITORING
// ============================================================
function runMonitoring() {
    let html='<div class="monitor-grid">', tl='', flags=0;
    DB.employees.forEach(e=>{
        const s=scoreFor(e.id); e.riskScore=s.total; e.riskLevel=riskLvl(s.total);
        const ea=DB.accounts.filter(a=>a.empId==e.id&&a.exceeded);
        const sc=DB.credits.filter(c=>c.empId==e.id&&creditRiskCheck(c).isRisk);
        const lp=DB.properties.filter(p=>p.empId==e.id&&p.creditLink==='yes');
        const rp=DB.procurements.filter(p=>p.empId==e.id&&p.prevCount>=3);
        const rb=DB.relatives.filter(r=>r.empId==e.id&&r.inBanking==='yes');
        const f=ea.length+sc.length+lp.length+rp.length+rb.length; flags+=f;
        if(f>0||s.total>=25){
            html+=`<div class="monitor-card" style="border-left:3px solid ${riskColor(s.total)};"><div class="monitor-card-head"><strong>${e.fio}</strong><span class="badge badge-${e.riskLevel}">${s.total}</span></div><p style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">${e.position}</p>
            ${ea.length?`<div class="chip chip-red">Balans 5x+ (${ea.length})</div>`:''}
            ${sc.length?`<div class="chip chip-red">O'zi kredit (${sc.length})</div>`:''}
            ${lp.length?`<div class="chip chip-orange">Mulk-kredit (${lp.length})</div>`:''}
            ${rp.length?`<div class="chip chip-orange">Takroriy xarid (${rp.length})</div>`:''}
            ${rb.length?`<div class="chip chip-purple">Yaqini bankda (${rb.length})</div>`:''}
            </div>`;
            tl+=`<div class="tl-item ${f>2?'flagged':''}"><div class="tl-date">${new Date().toLocaleString('uz-UZ')}</div><div class="tl-text"><strong>${e.fio}</strong> ‚Äî ${f} ta xavf. Bal: <strong style="color:${riskColor(s.total)}">${s.total}</strong></div></div>`;
        }
    });
    html+='</div>';
    if(!flags) html=`<div class="alert alert-success"><span class="alert-icon">‚úÖ</span><div>Jiddiy xavf aniqlanmadi. Monitoring muvaffaqiyatli.</div></div>`;
    document.getElementById('monResults').innerHTML=html;
    if(tl) document.getElementById('monTimeline').innerHTML=tl;
    updateDash(); toast(`Monitoring: ${flags} ta xavf aniqlandi`,flags?'warning':'success');
}

// ============================================================
// DASHBOARD
// ============================================================
function updateDash() {
    animateCount('sTotal', DB.employees.length);
    const conf = DB.declarations.filter(d=>d.relBank==='yes'||d.share!=='no').length;
    animateCount('sConflict', conf);
    const susp = DB.accounts.filter(a=>a.exceeded).length + DB.credits.filter(c=>creditRiskCheck(c).isRisk).length;
    animateCount('sSuspicious', susp);
    const crit = DB.employees.filter(e=>e.riskLevel==='critical'||e.riskLevel==='high').length;
    animateCount('sCritical', crit);
    if(DB.employees.length) animateCount('sAvg', Math.round(DB.employees.reduce((s,e)=>s+(e.riskScore||0),0)/DB.employees.length));

    const da = document.getElementById('dashAlerts');
    const recent = DB.alerts.slice(-5).reverse();
    da.innerHTML = recent.length ? recent.map(a=>`<div class="alert alert-${a.severity==='critical'?'danger':'warning'}" style="margin-bottom:8px;"><span class="alert-icon">${a.severity==='critical'?'üö®':'‚ö†Ô∏è'}</span><div style="font-size:12px;">${a.msg}<br><small style="color:var(--text-muted)">${fd(a.date)}</small></div></div>`).join('') : '<div class="empty"><div class="e-icon">üì≠</div><p>Ogohlantirishlar yo\'q</p></div>';

    const dh = document.getElementById('dashHigh');
    const high = DB.employees.filter(e=>e.riskScore>=40).sort((a,b)=>b.riskScore-a.riskScore).slice(0,5);
    dh.innerHTML = high.length ? high.map(e=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border-color);">
        <div style="display:flex;align-items:center;gap:12px;"><div style="width:38px;height:38px;border-radius:50%;background:${riskColor(e.riskScore)};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:var(--text-inverse);">${e.fio.charAt(0)}</div><div><div style="font-size:14px;font-weight:600;">${e.fio}</div><div style="font-size:11px;color:var(--text-muted);">${e.position}</div></div></div>
        <span class="badge badge-${e.riskLevel}" style="font-family:'JetBrains Mono';">${e.riskScore}</span></div>`).join('') : '<div class="empty"><div class="e-icon">‚úÖ</div><p>Hamma xavfsiz</p></div>';
}

// Animated counter
function animateCount(id, target) {
    const el = document.getElementById(id);
    const start = parseInt(el.textContent)||0;
    const diff = target - start;
    if (diff === 0) return;
    const duration = 600;
    const startTime = performance.now();
    function step(now) {
        const progress = Math.min((now - startTime)/duration, 1);
        const ease = 1 - Math.pow(1 - progress, 3);
        el.textContent = Math.round(start + diff * ease);
        if (progress < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}

// ============================================================
// STAT CARD DETAIL MODALS ‚Äî har bir kartochka uchun batafsil ma'lumot
// ============================================================
function openStatDetail(type) {
    let title = '';
    let html = '';

    switch(type) {

        // ========== 1. JAMI XODIMLAR ==========
        case 'employees': {
            title = 'üë• Jami xodimlar ‚Äî batafsil';
            const emps = DB.employees;
            const byDep = {};
            emps.forEach(e => {
                const dep = e.department || 'Boshqa';
                if (!byDep[dep]) byDep[dep] = [];
                byDep[dep].push(e);
            });

            // Statistika qatori
            html += `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
                <div style="padding:14px;background:var(--accent-soft);border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono';color:var(--accent);">${emps.length}</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Jami xodimlar</div>
                </div>
                <div style="padding:14px;background:var(--success-soft);border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono';color:var(--success);">${emps.filter(e=>e.riskLevel==='low').length}</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Past xavf</div>
                </div>
                <div style="padding:14px;background:var(--danger-soft);border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono';color:var(--danger);">${emps.filter(e=>e.riskLevel==='critical'||e.riskLevel==='high').length}</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Yuqori xavf</div>
                </div>
            </div>`;

            // Bo'limlar bo'yicha
            html += `<h4 style="font-size:13px;color:var(--accent);font-weight:700;margin-bottom:12px;">Bo'limlar bo'yicha taqsimot</h4>`;
            Object.keys(byDep).sort().forEach(dep => {
                const list = byDep[dep];
                html += `<div style="margin-bottom:14px;padding:14px;background:var(--bg-input);border-radius:10px;border:1px solid var(--border-color);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <strong style="font-size:13px;">${dep}</strong>
                        <span class="chip chip-blue">${list.length} xodim</span>
                    </div>`;
                list.forEach(e => {
                    html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-top:1px solid var(--border-color);font-size:13px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div style="width:32px;height:32px;border-radius:50%;background:${riskColor(e.riskScore)};display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--text-inverse);">${e.fio.charAt(0)}</div>
                            <div><div style="font-weight:600;">${e.fio}</div><div style="font-size:11px;color:var(--text-muted);">${e.position}</div></div>
                        </div>
                        <span class="badge badge-${e.riskLevel}" style="font-family:'JetBrains Mono';">${e.riskScore||0}</span>
                    </div>`;
                });
                html += `</div>`;
            });
            break;
        }

        // ========== 2. TO'QNASHUVLAR ==========
        case 'conflicts': {
            title = '‚öîÔ∏è Manfaatlar to\'qnashuvlari ‚Äî batafsil';
            const conflictDecls = DB.declarations.filter(d => d.relBank === 'yes' || d.share !== 'no');
            const relInBank = DB.relatives.filter(r => r.inBanking === 'yes');
            const relWithShare = DB.relatives.filter(r => r.companyShare);

            html += `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
                <div style="padding:14px;background:var(--danger-soft);border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono';color:var(--danger);">${conflictDecls.length}</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Deklaratsiyada to'qnashuv</div>
                </div>
                <div style="padding:14px;background:var(--warning-soft);border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono';color:var(--warning);">${relInBank.length}</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Yaqini bankda</div>
                </div>
                <div style="padding:14px;background:var(--purple-soft);border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono';color:var(--purple);">${relWithShare.length}</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Ustav ulushi bor</div>
                </div>
            </div>`;

            // Deklaratsiya to'qnashuvlari
            if (conflictDecls.length) {
                html += `<h4 style="font-size:13px;color:var(--danger);font-weight:700;margin-bottom:10px;">Deklaratsiya bo'yicha to'qnashuvlar</h4>`;
                conflictDecls.forEach(d => {
                    html += `<div style="padding:12px;background:var(--bg-input);border-radius:10px;border-left:3px solid var(--danger);margin-bottom:10px;">
                        <div style="font-weight:700;font-size:14px;">${gn(d.empId)}</div>
                        <div style="font-size:12px;color:var(--text-secondary);margin-top:6px;">
                            ${d.relBank==='yes' ? `<div style="margin-bottom:4px;">üè¶ <strong>Yaqini bankda:</strong> ${d.relDetail} (${d.relDeg})</div>` : ''}
                            ${d.share!=='no' ? `<div>üìä <strong>Ustav ulushi:</strong> ${d.shareDetail} (${d.share==='self'?"O'zi":d.share==='rel'?'Qarindosh':'Ikkalasi'})</div>` : ''}
                        </div>
                        <div style="font-size:11px;color:var(--text-muted);margin-top:6px;">Sana: ${fd(d.date)}</div>
                    </div>`;
                });
            }

            // Bank tizimidagi yaqinlar
            if (relInBank.length) {
                html += `<h4 style="font-size:13px;color:var(--warning);font-weight:700;margin:16px 0 10px;">Bank tizimidagi yaqin qarindoshlar</h4>`;
                relInBank.forEach(r => {
                    html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg-input);border-radius:8px;margin-bottom:6px;font-size:13px;">
                        <div><strong>${r.fio}</strong> (${r.degree}) ‚Äî ${r.workplace||'‚Äî'}</div>
                        <span class="chip chip-red">Xodim: ${gn(r.empId)}</span>
                    </div>`;
                });
            }

            if (!conflictDecls.length && !relInBank.length) {
                html += `<div class="empty"><div class="e-icon">‚úÖ</div><p>To'qnashuvlar aniqlanmagan</p></div>`;
            }
            break;
        }

        // ========== 3. SHUBHALI OPERATSIYALAR ==========
        case 'suspicious': {
            title = 'üîç Shubhali operatsiyalar ‚Äî batafsil';
            const exceededAccounts = DB.accounts.filter(a => a.exceeded);
            const suspCredits = DB.credits.filter(c => creditRiskCheck(c).isRisk);
            const linkedProps = DB.properties.filter(p => p.creditLink === 'yes');
            const repeatedProcs = DB.procurements.filter(p => p.prevCount >= 3);
            const expensiveTravel = DB.travels.filter(t => parseFloat(t.ratio) > 3);

            const totalSusp = exceededAccounts.length + suspCredits.length + linkedProps.length + repeatedProcs.length + expensiveTravel.length;

            html += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:20px;">
                <div style="padding:12px;background:var(--danger-soft);border-radius:10px;text-align:center;">
                    <div style="font-size:22px;font-weight:800;font-family:'JetBrains Mono';color:var(--danger);">${exceededAccounts.length}</div>
                    <div style="font-size:10px;color:var(--text-muted);margin-top:3px;">Balans 5x+</div>
                </div>
                <div style="padding:12px;background:var(--danger-soft);border-radius:10px;text-align:center;">
                    <div style="font-size:22px;font-weight:800;font-family:'JetBrains Mono';color:var(--danger);">${suspCredits.length}</div>
                    <div style="font-size:10px;color:var(--text-muted);margin-top:3px;">O'zi kredit</div>
                </div>
                <div style="padding:12px;background:var(--warning-soft);border-radius:10px;text-align:center;">
                    <div style="font-size:22px;font-weight:800;font-family:'JetBrains Mono';color:var(--warning);">${linkedProps.length}</div>
                    <div style="font-size:10px;color:var(--text-muted);margin-top:3px;">Mulk-kredit</div>
                </div>
                <div style="padding:12px;background:var(--warning-soft);border-radius:10px;text-align:center;">
                    <div style="font-size:22px;font-weight:800;font-family:'JetBrains Mono';color:var(--warning);">${repeatedProcs.length}</div>
                    <div style="font-size:10px;color:var(--text-muted);margin-top:3px;">Takroriy xarid</div>
                </div>
                <div style="padding:12px;background:var(--purple-soft);border-radius:10px;text-align:center;">
                    <div style="font-size:22px;font-weight:800;font-family:'JetBrains Mono';color:var(--purple);">${expensiveTravel.length}</div>
                    <div style="font-size:10px;color:var(--text-muted);margin-top:3px;">Qimmat safari</div>
                </div>
            </div>`;

            // Balans 5x
            if (exceededAccounts.length) {
                html += `<h4 style="font-size:13px;color:var(--danger);font-weight:700;margin-bottom:8px;">üè¶ Balans 5x dan oshgan</h4>`;
                exceededAccounts.forEach(a => {
                    html += `<div class="alert alert-danger" style="margin-bottom:8px;padding:12px;"><span class="alert-icon">üö®</span><div style="font-size:12px;"><strong>${gn(a.empId)}</strong>: ${fmt(a.balance)} so'm = <strong>${a.ratio}x</strong> maosh | ${a.num} | ${a.month}</div></div>`;
                });
            }

            // O'zi kredit
            if (suspCredits.length) {
                html += `<h4 style="font-size:13px;color:var(--danger);font-weight:700;margin:14px 0 8px;">üí≥ Tekshirgan bankdan olingan shubhali kreditlar</h4>`;
                suspCredits.forEach(c => {
                    html += `<div style="padding:10px 14px;background:var(--bg-input);border-radius:8px;border-left:3px solid var(--danger);margin-bottom:8px;font-size:12px;">
                        <strong>${gn(c.empId)}</strong>: ${c.type} ‚Äî <span class="mono">${fmt(c.amount)}</span> so'm (${c.bank})
                        ${c.inspOrg ? `<br><span style="color:var(--text-muted);">Tekshirish: ${c.inspOrg} | ${fd(c.inspDate)}</span>` : ''}
                    </div>`;
                });
            }

            // Mol-mulk kredit bog'liq
            if (linkedProps.length) {
                html += `<h4 style="font-size:13px;color:var(--warning);font-weight:700;margin:14px 0 8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;vertical-align:middle;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg> Mol-mulk ‚Äî kredit bilan bog'liq</h4>`;
                linkedProps.forEach(p => {
                    html += `<div style="padding:10px 14px;background:var(--bg-input);border-radius:8px;border-left:3px solid var(--warning);margin-bottom:8px;font-size:12px;">
                        <strong>${gn(p.empId)}</strong>: ${p.type} ‚Äî <span class="mono">${fmt(p.value)}</span> so'm (${p.owner==='self'?"O'zi":p.relName||'Qarindosh'}) | ${fd(p.date)}
                    </div>`;
                });
            }

            // Takroriy xaridlar
            if (repeatedProcs.length) {
                html += `<h4 style="font-size:13px;color:var(--warning);font-weight:700;margin:14px 0 8px;">üõí Takroriy xaridlar (3+ marta)</h4>`;
                repeatedProcs.forEach(p => {
                    html += `<div style="padding:10px 14px;background:var(--bg-input);border-radius:8px;border-left:3px solid var(--warning);margin-bottom:8px;font-size:12px;">
                        <strong>${gn(p.empId)}</strong>: ${p.org} ‚Äî <span class="mono">${fmt(p.amount)}</span> so'm | ${p.prevCount} marta | ${fd(p.date)}
                    </div>`;
                });
            }

            if (totalSusp === 0) {
                html += `<div class="empty"><div class="e-icon">‚úÖ</div><p>Shubhali operatsiyalar topilmadi</p></div>`;
            }
            break;
        }

        // ========== 4. KRITIK XAVF ==========
        case 'critical': {
            title = 'üö® Kritik va yuqori xavfli xodimlar';
            const critEmps = DB.employees.filter(e => e.riskLevel === 'critical' || e.riskLevel === 'high').sort((a,b) => b.riskScore - a.riskScore);

            html += `<div style="padding:14px;background:var(--danger-soft);border-radius:12px;text-align:center;margin-bottom:20px;">
                <div style="font-size:36px;font-weight:900;font-family:'JetBrains Mono';color:var(--danger);">${critEmps.length}</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">Kritik / Yuqori xavfdagi xodimlar</div>
            </div>`;

            if (critEmps.length) {
                critEmps.forEach(e => {
                    const s = scoreFor(e.id);
                    const rels = DB.relatives.filter(r => r.empId == e.id && r.inBanking === 'yes');
                    const suspCreds = DB.credits.filter(c => c.empId == e.id && creditRiskCheck(c).isRisk);
                    const excAcc = DB.accounts.filter(a => a.empId == e.id && a.exceeded);

                    html += `<div style="padding:16px;background:var(--bg-input);border-radius:12px;border-left:4px solid ${riskColor(s.total)};margin-bottom:14px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="width:44px;height:44px;border-radius:50%;background:${riskColor(s.total)};display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:var(--text-inverse);">${e.fio.charAt(0)}</div>
                                <div><div style="font-size:16px;font-weight:700;">${e.fio}</div><div style="font-size:12px;color:var(--text-muted);">${e.position} | ${e.department||'‚Äî'}</div></div>
                            </div>
                            <div style="text-align:right;">
                                <div class="mono" style="font-size:28px;font-weight:800;color:${riskColor(s.total)};">${s.total}</div>
                                <span class="badge badge-${e.riskLevel}">${riskLabel(e.riskLevel)}</span>
                            </div>
                        </div>
                        <!-- Score tarkibi -->
                        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:10px;">
                            <div style="text-align:center;padding:6px;background:var(--bg-card);border-radius:8px;">
                                <div class="mono" style="font-size:14px;font-weight:700;color:var(--danger);">${s.conflict}</div>
                                <div style="font-size:9px;color:var(--text-muted);">To'qnashuv</div>
                            </div>
                            <div style="text-align:center;padding:6px;background:var(--bg-card);border-radius:8px;">
                                <div class="mono" style="font-size:14px;font-weight:700;color:var(--warning);">${s.credit}</div>
                                <div style="font-size:9px;color:var(--text-muted);">Kredit</div>
                            </div>
                            <div style="text-align:center;padding:6px;background:var(--bg-card);border-radius:8px;">
                                <div class="mono" style="font-size:14px;font-weight:700;color:var(--purple);">${s.property}</div>
                                <div style="font-size:9px;color:var(--text-muted);">Mol-mulk</div>
                            </div>
                            <div style="text-align:center;padding:6px;background:var(--bg-card);border-radius:8px;">
                                <div class="mono" style="font-size:14px;font-weight:700;color:var(--cyan);">${s.balance}</div>
                                <div style="font-size:9px;color:var(--text-muted);">Balans</div>
                            </div>
                            <div style="text-align:center;padding:6px;background:var(--bg-card);border-radius:8px;">
                                <div class="mono" style="font-size:14px;font-weight:700;color:var(--accent);">${s.procurement}</div>
                                <div style="font-size:9px;color:var(--text-muted);">Xarid</div>
                            </div>
                        </div>
                        <!-- Xavf bayroqlari -->
                        <div style="display:flex;flex-wrap:wrap;gap:4px;">
                            ${rels.length ? `<span class="chip chip-red">Yaqini bankda (${rels.length})</span>` : ''}
                            ${suspCreds.length ? `<span class="chip chip-red">Tekshiruv-kredit (${suspCreds.length})</span>` : ''}
                            ${excAcc.length ? `<span class="chip chip-orange">Balans 5x+ (${excAcc.length})</span>` : ''}
                        </div>
                    </div>`;
                });
            } else {
                html += `<div class="empty"><div class="e-icon">‚úÖ</div><p>Kritik xavfli xodimlar aniqlanmagan</p></div>`;
            }
            break;
        }

        // ========== 5. O'RTACHA BAL ==========
        case 'avgScore': {
            title = 'üìà Scoring ‚Äî umumiy tahlil';
            const emps = DB.employees;
            const scored = emps.filter(e => e.riskScore > 0);
            const avg = emps.length ? Math.round(emps.reduce((s,e) => s + (e.riskScore||0), 0) / emps.length) : 0;
            const max = emps.length ? Math.max(...emps.map(e => e.riskScore||0)) : 0;
            const min = emps.length ? Math.min(...emps.map(e => e.riskScore||0)) : 0;

            const levels = { critical:0, high:0, medium:0, low:0 };
            emps.forEach(e => { levels[e.riskLevel||'low']++; });

            html += `<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
                <div style="padding:14px;background:var(--accent-soft);border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono';color:var(--accent);">${avg}</div>
                    <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">O'rtacha bal</div>
                </div>
                <div style="padding:14px;background:var(--danger-soft);border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono';color:var(--danger);">${max}</div>
                    <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Eng yuqori</div>
                </div>
                <div style="padding:14px;background:var(--success-soft);border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono';color:var(--success);">${min}</div>
                    <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Eng past</div>
                </div>
                <div style="padding:14px;background:var(--purple-soft);border-radius:12px;text-align:center;">
                    <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono';color:var(--purple);">${scored.length}</div>
                    <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Baholangan</div>
                </div>
            </div>`;

            // Daraja taqsimoti ‚Äî vizual bar
            html += `<h4 style="font-size:13px;color:var(--accent);font-weight:700;margin-bottom:12px;">Xavf darajasi taqsimoti</h4>`;
            const totalE = emps.length || 1;
            const bars = [
                { label: 'Kritik (70‚Äì100)', count: levels.critical, color: 'var(--danger)', pct: (levels.critical/totalE*100).toFixed(0) },
                { label: 'Yuqori (50‚Äì69)', count: levels.high, color: 'var(--warning)', pct: (levels.high/totalE*100).toFixed(0) },
                { label: "O'rta (25‚Äì49)", count: levels.medium, color: 'var(--purple)', pct: (levels.medium/totalE*100).toFixed(0) },
                { label: 'Past (0‚Äì24)', count: levels.low, color: 'var(--success)', pct: (levels.low/totalE*100).toFixed(0) },
            ];
            bars.forEach(b => {
                html += `<div style="margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;">
                        <span style="color:var(--text-secondary);">${b.label}</span>
                        <span class="mono" style="color:${b.color};font-weight:700;">${b.count} xodim (${b.pct}%)</span>
                    </div>
                    <div style="height:10px;background:var(--bg-input);border-radius:5px;overflow:hidden;">
                        <div style="height:100%;width:${b.pct}%;background:${b.color};border-radius:5px;transition:width 0.8s ease;"></div>
                    </div>
                </div>`;
            });

            // Xodimlar reytingi
            html += `<h4 style="font-size:13px;color:var(--accent);font-weight:700;margin:18px 0 10px;">Xodimlar reytingi</h4>`;
            const sorted = [...emps].sort((a,b) => b.riskScore - a.riskScore);
            sorted.forEach((e, i) => {
                const barWidth = (e.riskScore||0);
                html += `<div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border-color);font-size:13px;">
                    <div class="mono" style="width:24px;text-align:center;color:var(--text-muted);font-size:11px;">${i+1}</div>
                    <div style="flex:1;min-width:0;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
                            <span style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${e.fio}</span>
                            <span class="mono" style="font-weight:700;color:${riskColor(e.riskScore||0)};flex-shrink:0;margin-left:8px;">${e.riskScore||0}</span>
                        </div>
                        <div style="height:5px;background:var(--bg-input);border-radius:3px;overflow:hidden;">
                            <div style="height:100%;width:${barWidth}%;background:${riskColor(e.riskScore||0)};border-radius:3px;transition:width 0.5s ease;"></div>
                        </div>
                    </div>
                    <span class="badge badge-${e.riskLevel}" style="font-size:9px;flex-shrink:0;">${riskLabel(e.riskLevel)}</span>
                </div>`;
            });

            // Scoring tarixi qisqacha
            if (DB.scoreHistory.length) {
                html += `<h4 style="font-size:13px;color:var(--accent);font-weight:700;margin:18px 0 10px;">So'nggi scoring tarixi</h4>`;
                const lastFive = DB.scoreHistory.slice(-5).reverse();
                lastFive.forEach(h => {
                    const d = new Date(h.date);
                    let changeHtml = '';
                    if (h.change !== null && h.change !== undefined) {
                        if (h.change > 0) changeHtml = `<span style="color:var(--danger);font-weight:700;">‚ñ≤+${h.change}</span>`;
                        else if (h.change < 0) changeHtml = `<span style="color:var(--success);font-weight:700;">‚ñº${h.change}</span>`;
                        else changeHtml = `<span style="color:var(--text-muted);">‚óè0</span>`;
                    }
                    html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-input);border-radius:8px;margin-bottom:6px;font-size:12px;">
                        <div><strong>${h.empName}</strong> <span style="color:var(--text-muted);">${d.toLocaleDateString('uz-UZ')} ${d.toLocaleTimeString('uz-UZ',{hour:'2-digit',minute:'2-digit'})}</span></div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span class="mono" style="font-weight:700;color:${riskColor(h.total)};">${h.total}</span>
                            ${changeHtml}
                        </div>
                    </div>`;
                });
            }
            break;
        }
    }

    openModal(title, html);
}

// ============================================================
// MODAL
// ============================================================
function openModal(title, body) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = body;
    document.getElementById('modalOverlay').classList.add('show');
}
function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); }
document.getElementById('modalOverlay').addEventListener('click', e => { if(e.target===document.getElementById('modalOverlay')) closeModal(); });

// ============================================================
// RENDER ALL
// ============================================================
function renderAll() { renderEmpTable(); renderDeclTable(); renderRelTable(); renderCredTable(); renderPropTable(); renderTravelTable(); renderProcTable(); renderAccTable();     renderGifts(); renderContracts(); renderWhistleblower();
}

// ============================================================
// üß† AI TAHLIL ENGINE ‚Äî Chuqur avtomatlashtirilgan tahlil
// ============================================================

// Tahlil natijalari ‚Äî yangilangan, barcha modullarni o'z ichiga oladi
let aiFindings = { cross:[], temporal:[], lifestyle:[], favoritism:[], network:{ nodes:[], edges:[] }, trends:[], recs:[], chains:[], anomalies:[], earlyWarnings:[], rulesResults:[], watchList:[], sodViolations:[], giftCorr:[], pepFindings:[], benford:[], splitContracts:[], insiderLending:[], ueba:[], hrAnalytics:[], benefOwnership:[], sideBusiness:[], adverseMedia:[], trainingIssues:[], kpiIssues:[], structuring:[], wbAnalysis:[] };

// --- MAIN ANALYSIS RUNNER ‚Äî 15 ta modul ---
async function runFullAIAnalysis() {
    // To'liq reset
    aiFindings = { cross:[], temporal:[], lifestyle:[], favoritism:[], network:{ nodes:[], edges:[] }, trends:[], recs:[], chains:[], anomalies:[], earlyWarnings:[], rulesResults:[], watchList:[], sodViolations:[], giftCorr:[], pepFindings:[], benford:[], splitContracts:[], insiderLending:[], ueba:[], hrAnalytics:[], benefOwnership:[], sideBusiness:[], adverseMedia:[], trainingIssues:[], kpiIssues:[], structuring:[], wbAnalysis:[] };
    
    document.getElementById('aiEmpty').style.display = 'none';
    document.getElementById('aiResults').style.display = 'none';
    document.getElementById('aiProgress').style.display = 'block';
    
    const steps = [
        { text: '1/26 ‚Äî Kross-referensiya tahlili...', pct: 4, fn: analysisCrossReference },
        { text: '2/26 ‚Äî Vaqt pattern tahlili...', pct: 8, fn: analysisTemporalPatterns },
        { text: '3/26 ‚Äî Turmush tarzi vs daromad...', pct: 12, fn: analysisLifestyleIncome },
        { text: '4/26 ‚Äî Xarid favoritizmi...', pct: 15, fn: analysisProcurementFavoritism },
        { text: '5/26 ‚Äî Aloqalar tarmog\'i...', pct: 19, fn: analysisNetworkBuild },
        { text: '6/26 ‚Äî Bashorat va trendlar...', pct: 23, fn: analysisTrends },
        { text: '7/26 ‚Äî Zanjirli aloqa tahlili...', pct: 27, fn: analysisChainConnections },
        { text: '8/26 ‚Äî Statistik anomaliya indeksi...', pct: 31, fn: analysisAnomalyZScore },
        { text: '9/26 ‚Äî Erta ogohlantirish...', pct: 35, fn: analysisEarlyWarning },
        { text: '10/26 ‚Äî Qoidalar motori (15 qoida)...', pct: 38, fn: analysisRulesEngine },
        { text: '11/26 ‚Äî Vazifalarnini ajratish...', pct: 42, fn: analysisSegregationOfDuties },
        { text: '12/26 ‚Äî Sovg\'a-xarid korrelyatsiyasi...', pct: 46, fn: analysisGiftCorrelation },
        { text: '13/26 ‚Äî PEP va sanksiya skriningi...', pct: 50, fn: analysisPepScreening },
        { text: '14/26 ‚Äî Benford qonuni tahlili...', pct: 54, fn: analysisBenfordLaw },
        { text: '15/26 ‚Äî Split-kontrakt aniqlash...', pct: 58, fn: analysisSplitContract },
        { text: '16/26 ‚Äî Insider kredit tahlili...', pct: 62, fn: analysisInsiderLending },
        { text: '17/26 ‚Äî UEBA xulq tahlili...', pct: 65, fn: analysisUEBA },
        { text: '18/26 ‚Äî HR va ta\'til tahlili...', pct: 69, fn: analysisHRAnalytics },
        { text: '19/26 ‚Äî Haqiqiy egalar tahlili...', pct: 73, fn: analysisBeneficialOwnership },
        { text: '20/26 ‚Äî Qo\'shimcha biznes aniqlash...', pct: 77, fn: analysisSideBusiness },
        { text: '21/26 ‚Äî OSINT va ommaviy axborot...', pct: 81, fn: analysisAdverseMedia },
        { text: '22/26 ‚Äî Trening compliance...', pct: 85, fn: analysisTrainingCompliance },
        { text: '23/26 ‚Äî KPI manipulyatsiya...', pct: 88, fn: analysisKPIManipulation },
        { text: '24/26 ‚Äî Tranzaksiya strukturlash...', pct: 90, fn: analysisTransactionStructuring },
        { text: '25/26 ‚Äî Whistleblower tahlili...', pct: 92, fn: analysisWhistleblower },
        { text: '26/26 ‚Äî Tavsiyalar shakllantirilmoqda...', pct: 95, fn: analysisRecommendations },
    ];

    for (const step of steps) {
        document.getElementById('aiProgressText').textContent = step.text;
        document.getElementById('aiProgressBar').style.width = step.pct + '%';
        document.getElementById('aiProgressStep').textContent = `${step.pct}% ‚Äî ${step.text}`;
        await sleep(300);
        step.fn();
    }

    // Watch list va Heat map alohida ‚Äî chunki ular boshqa natijalardan foydalanadi
    buildWatchList();
    
    document.getElementById('aiProgressBar').style.width = '100%';
    document.getElementById('aiProgressText').textContent = '‚úÖ Tahlil yakunlandi!';
    document.getElementById('aiProgressIcon').textContent = '‚úÖ';
    await sleep(500);

    document.getElementById('aiProgress').style.display = 'none';
    document.getElementById('aiResults').style.display = 'block';

    // Render all modules
    renderAISummary();
    renderAICross();
    renderAITemporal();
    renderAILifestyle();
    renderAIFavoritism();
    renderAINetwork();
    renderAITrends();
    renderAIRecs();
    renderAIChains();
    renderAIAnomalies();
    renderAIEarlyWarning();
    renderAIRules();
    renderAIWatchList();
    renderAIHeatMap();
    renderAISoD();
    renderAIGifts();
    renderAIPep();
    renderAIBenford();
    renderAISplit();
    renderAIInsider();
    renderAIUeba();
    renderAIHr();
    renderAIBenef();
    renderAISide();
    renderAIMedia();
    renderAITrain();
    renderAIKpi();
    renderAIStruct();
    renderAIWb();
    generateFullReport();

    // ===== KRITIK QADAM: AI natijalarini boshqaruv paneliga sinxronlash =====
    syncAIToDashboard();

    // Badge
    const totalFindings = aiFindings.cross.length + aiFindings.temporal.length + aiFindings.lifestyle.length + aiFindings.favoritism.length + aiFindings.chains.length + aiFindings.anomalies.length + aiFindings.earlyWarnings.length + aiFindings.sodViolations.length;
    const badge = document.getElementById('aiBadge');
    badge.textContent = totalFindings;
    badge.style.display = totalFindings > 0 ? 'inline' : 'none';

    toast(`AI tahlil yakunlandi: ${totalFindings} ta topilma ‚Äî ${aiFindings.rulesResults.filter(r=>r.violated).length} ta qoida buzildi`, totalFindings > 0 ? 'warning' : 'success');
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ============================================================
// üîÑ AI ‚Üí BOSHQARUV PANELI SINXRONLASH
// AI tahlil natijalarini dashboard statistikasi, alerts va
// xodimlar risk ballariga avtomatik uzatadi
// ============================================================
function syncAIToDashboard() {
    const now = new Date().toISOString();

    // 1Ô∏è‚É£ AI topilmalardan ALERTS generatsiya qilish
    // Har bir modul natijasidan muhim ogohlantirishlarni DB.alerts ga yozamiz

    // Cross-reference topilmalar (manfaatlar to'qnashuvi)
    aiFindings.cross.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üîó Kross-referensiya: ' + f.msg, date:now, severity:f.severity||'warning' });
    });

    // Temporal patterns (vaqt anomaliyalari)
    aiFindings.temporal.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'‚è∞ Vaqt anomaliya: ' + f.msg, date:now, severity:f.severity||'warning' });
    });

    // Lifestyle vs income (turmush tarzi nomutanosibligi)
    aiFindings.lifestyle.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üí∞ Turmush tarzi: ' + f.msg, date:now, severity:'critical' });
    });

    // Procurement favoritism (xarid favoritizmi)
    aiFindings.favoritism.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üõí Xarid favoritizm: ' + f.msg, date:now, severity:'warning' });
    });

    // Chain connections (zanjirli aloqalar)
    aiFindings.chains.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üîó Zanjirli aloqa: ' + f.msg, date:now, severity:f.severity||'warning' });
    });

    // Anomalies (statistik anomaliyalar)
    aiFindings.anomalies.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üìä Anomaliya: ' + f.msg, date:now, severity:f.zScore>=3?'critical':'warning' });
    });

    // Early warnings (erta ogohlantirishlar)
    aiFindings.earlyWarnings.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'‚ö° Erta ogohlantirish: ' + f.msg, date:now, severity:'warning' });
    });

    // Rules engine violations (qoida buzilishlari)
    aiFindings.rulesResults.filter(r => r.violated).forEach(r => {
        DB.alerts.push({ id:gid(), empId:null, msg:'‚öñÔ∏è Qoida buzildi: ' + r.rule + ' ‚Äî ' + r.detail, date:now, severity:r.severity||'critical' });
    });

    // SoD violations (vazifalar ajratish buzilishi)
    aiFindings.sodViolations.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üîÄ SoD buzilish: ' + f.msg, date:now, severity:'critical' });
    });

    // PEP findings
    aiFindings.pepFindings.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üèõÔ∏è PEP topilma: ' + f.msg, date:now, severity:'critical' });
    });

    // Benford anomaliyalari
    aiFindings.benford.forEach(f => {
        if (f.suspicious) DB.alerts.push({ id:gid(), empId:null, msg:'üî¢ Benford anomaliya: ' + f.msg, date:now, severity:'warning' });
    });

    // Split-kontrakt
    aiFindings.splitContracts.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'‚úÇÔ∏è Split-kontrakt: ' + f.msg, date:now, severity:'critical' });
    });

    // Insider lending
    aiFindings.insiderLending.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üè¶ Insider kredit: ' + f.msg, date:now, severity:'critical' });
    });

    // UEBA
    aiFindings.ueba.forEach(f => {
        if (f.riskLevel === 'high' || f.riskLevel === 'critical') {
            DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üß† UEBA: ' + f.msg, date:now, severity:f.riskLevel });
        }
    });

    // Whistleblower analysis
    aiFindings.wbAnalysis.forEach(f => {
        DB.alerts.push({ id:gid(), empId:null, msg:'üîê WB tahlil: ' + f.msg, date:now, severity:f.severity||'warning' });
    });

    // Beneficial ownership
    aiFindings.benefOwnership.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üë§ Haqiqiy egalar: ' + f.msg, date:now, severity:'warning' });
    });

    // Side business
    aiFindings.sideBusiness.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üè¢ Qo\'shimcha biznes: ' + f.msg, date:now, severity:'warning' });
    });

    // Transaction structuring
    aiFindings.structuring.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üí∏ Strukturlash: ' + f.msg, date:now, severity:'critical' });
    });

    // Gift correlation
    aiFindings.giftCorr.forEach(f => {
        DB.alerts.push({ id:gid(), empId:f.empId||null, msg:'üéÅ Sovg\'a korrelyatsiya: ' + f.msg, date:now, severity:'warning' });
    });

    // 2Ô∏è‚É£ BARCHA XODIMLAR RISK BALLARINI QAYTA HISOBLASH
    // scoreFor() yordamida har bir xodimning ballini yangilash
    DB.employees.forEach(e => {
        const s = scoreFor(e.id);
        e.riskScore = s.total;
        e.riskLevel = riskLvl(s.total);
    });

    // 3Ô∏è‚É£ BOSHQARUV PANELI STATISTIKASINI YANGILASH
    updateDash();

    // 4Ô∏è‚É£ XODIMLAR KARTOCHKALARINI QAYTA RENDER QILISH
    renderEmpTable();

    // 5Ô∏è‚É£ SCORING TARIXGA YOZISH
    const batchDate = now;
    DB.employees.forEach(e => {
        const s = scoreFor(e.id);
        const prev = DB.scoreHistory.filter(h => h.empId == e.id);
        const prevScore = prev.length > 0 ? prev[prev.length - 1].total : null;
        DB.scoreHistory.push({
            id: gid(), empId: e.id, empName: e.fio, empPosition: e.position,
            date: batchDate, conflict: s.conflict, credit: s.credit,
            property: s.property, balance: s.balance, procurement: s.procurement,
            total: s.total, level: riskLvl(s.total),
            change: prevScore !== null ? s.total - prevScore : null
        });
    });
    renderScoreHistory();

    console.log('‚úÖ AI ‚Üí Dashboard sinxronlandi: ' + DB.alerts.length + ' ta ogohlantirish, ' + 
        DB.employees.filter(e => e.riskLevel === 'critical' || e.riskLevel === 'high').length + ' ta kritik xodim');
}

// ============================================================
// 1. KROSS-REFERENSIYA ‚Äî Yashirin aloqalarni aniqlash
// ============================================================
function analysisCrossReference() {
    const findings = [];

    DB.employees.forEach(emp => {
        const rels = DB.relatives.filter(r => r.empId == emp.id);
        const creds = DB.credits.filter(c => c.empId == emp.id);
        const procs = DB.procurements.filter(p => p.empId == emp.id);
        const decls = DB.declarations.filter(d => d.empId == emp.id);

        // 1A: Qarindosh ishlayotgan tashkilot = xodim tekshirgan tashkilot?
        rels.forEach(rel => {
            const relWork = (rel.workplace || '').toLowerCase();
            creds.forEach(cred => {
                const inspOrg = (cred.inspOrg || '').toLowerCase();
                if (relWork && inspOrg && (relWork.includes(inspOrg) || inspOrg.includes(relWork) || fuzzyMatch(relWork, inspOrg))) {
                    findings.push({
                        severity: 'critical',
                        type: 'rel_inspection_match',
                        title: `Qarindosh ish joyi = Tekshiruv tashkiloti`,
                        emp: emp.fio,
                        detail: `${rel.fio} (${rel.degree}) ishlayotgan joy "${rel.workplace}" ‚Äî xodim tekshirgan tashkilot "${cred.inspOrg}" bilan mos keladi! Kredit: ${cred.type} ‚Äî ${fmt(cred.amount)} so'm`,
                        risk: 30
                    });
                }
            });

            // 1B: Qarindosh ish joyi = xarid yetkazuvchisi?
            procs.forEach(proc => {
                const procOrg = (proc.org || '').toLowerCase();
                if (relWork && procOrg && (relWork.includes(procOrg) || procOrg.includes(relWork) || fuzzyMatch(relWork, procOrg))) {
                    findings.push({
                        severity: 'critical',
                        type: 'rel_procurement_match',
                        title: `Qarindosh ish joyi = Xarid yetkazuvchisi`,
                        emp: emp.fio,
                        detail: `${rel.fio} (${rel.degree}) ishlayotgan "${rel.workplace}" ‚Äî xarid qilingan "${proc.org}" bilan mos! Summa: ${fmt(proc.amount)} so'm`,
                        risk: 30
                    });
                }
            });
        });

        // 1C: Ustav ulushi bor korxona = tekshirish yoki xarid tashkiloti?
        decls.forEach(decl => {
            const shareOrg = (decl.shareDetail || '').toLowerCase();
            if (shareOrg && decl.share !== 'no') {
                creds.forEach(cred => {
                    const inspOrg = (cred.inspOrg || '').toLowerCase();
                    if (inspOrg && (shareOrg.includes(inspOrg) || inspOrg.includes(shareOrg) || fuzzyMatch(shareOrg, inspOrg))) {
                        findings.push({
                            severity: 'critical',
                            type: 'share_inspection_match',
                            title: `Ustav ulushi bor korxona = Tekshirish tashkiloti`,
                            emp: emp.fio,
                            detail: `Ustav ulushi: "${decl.shareDetail}" ‚Äî Tekshirish: "${cred.inspOrg}". Bu jiddiy manfaatlar to'qnashuvi!`,
                            risk: 35
                        });
                    }
                });
                procs.forEach(proc => {
                    const procOrg = (proc.org || '').toLowerCase();
                    if (procOrg && (shareOrg.includes(procOrg) || procOrg.includes(shareOrg) || fuzzyMatch(shareOrg, procOrg))) {
                        findings.push({
                            severity: 'critical',
                            type: 'share_procurement_match',
                            title: `Ustav ulushi bor korxona = Xarid yetkazuvchisi`,
                            emp: emp.fio,
                            detail: `Ustav ulushi: "${decl.shareDetail}" ‚Äî Xarid: "${proc.org}" ‚Äî ${fmt(proc.amount)} so'm. Ochiq korrupsiya xavfi!`,
                            risk: 35
                        });
                    }
                });
            }
        });

        // 1D: Bir nechta xodimning bir xil tashkilotdan xarid qilishi
        // (bu favoritism bo'limida batafsil)
        
        // 1E: Xodimlarning o'zaro yaqinlik aloqasi (ikki xodimning qarindoshlari bir-birini bilishi)
        DB.employees.forEach(emp2 => {
            if (emp2.id === emp.id) return;
            const rels2 = DB.relatives.filter(r => r.empId == emp2.id);
            rels.forEach(r1 => {
                rels2.forEach(r2 => {
                    const n1 = (r1.fio || '').toLowerCase();
                    const n2 = (r2.fio || '').toLowerCase();
                    // Bir xil familiya + bankda ishlash
                    if (n1 && n2 && r1.inBanking === 'yes' && r2.inBanking === 'yes') {
                        const fam1 = n1.split(' ')[0];
                        const fam2 = n2.split(' ')[0];
                        if (fam1 === fam2 && fam1.length > 2) {
                            findings.push({
                                severity: 'high',
                                type: 'cross_employee_family',
                                title: `Ikki xodimning bankdagi yaqinlari bir oiladan`,
                                emp: `${emp.fio} ‚Üî ${emp2.fio}`,
                                detail: `${emp.fio} ning yaqini "${r1.fio}" va ${emp2.fio} ning yaqini "${r2.fio}" ‚Äî bir oiladan bo'lishi mumkin (${fam1} familiyasi)`,
                                risk: 15
                            });
                        }
                    }
                });
            });
        });
    });

    // Duplikatlarni olib tashlash
    aiFindings.cross = removeDuplicateFindings(findings);
}

// ============================================================
// 2. VAQT PATTERN TAHLILI ‚Äî shubhali mos kelishlar
// ============================================================
function analysisTemporalPatterns() {
    const findings = [];
    const MONTH_MS = 30 * 24 * 60 * 60 * 1000;

    DB.employees.forEach(emp => {
        const creds = DB.credits.filter(c => c.empId == emp.id);
        const props = DB.properties.filter(p => p.empId == emp.id);
        const travels = DB.travels.filter(t => t.empId == emp.id);
        const procs = DB.procurements.filter(p => p.empId == emp.id);

        // 2A: Kredit ajratish + mol-mulk xaridi o'sha oyda
        creds.forEach(cred => {
            if (!cred.date) return;
            const credTime = new Date(cred.date).getTime();
            props.forEach(prop => {
                if (!prop.date) return;
                const propTime = new Date(prop.date).getTime();
                const diff = Math.abs(propTime - credTime);
                if (diff <= MONTH_MS) {
                    findings.push({
                        severity: 'critical',
                        type: 'credit_property_timing',
                        title: `Kredit ‚Üí Mol-mulk: 1 oy ichida`,
                        emp: emp.fio,
                        detail: `Kredit (${cred.type}): ${fmt(cred.amount)} so'm [${fd(cred.date)}] ‚Üí Mol-mulk (${prop.type}): ${fmt(prop.value)} so'm [${fd(prop.date)}]. ${creditRiskCheck(cred).isRisk ? '‚ö†Ô∏è TEKSHIRGAN BANKDAN KREDIT!' : ''} Oraliq: ${Math.round(diff/86400000)} kun`,
                        risk: 25
                    });
                }
            });

            // 2B: Kredit ajratish + chet el safari yaqin vaqtda
            travels.forEach(tr => {
                if (!tr.dateOut) return;
                const trTime = new Date(tr.dateOut).getTime();
                const diff = Math.abs(trTime - credTime);
                if (diff <= MONTH_MS * 2) { // 2 oy ichida
                    const before = trTime < credTime;
                    findings.push({
                        severity: 'high',
                        type: 'credit_travel_timing',
                        title: `Kredit ${before ? 'oldidan' : 'keyin'} chet el safari`,
                        emp: emp.fio,
                        detail: `Kredit: ${fmt(cred.amount)} [${fd(cred.date)}] ‚Äî Safari: ${tr.country} [${fd(tr.dateOut)}]. Xarajat: ${fmt(tr.cost)} so'm (${tr.ratio}x maosh). ${before ? 'Safari kredit qaroridan OLDIN!' : ''}`,
                        risk: 15
                    });
                }
            });
        });

        // 2C: O'zi kredit ajratdi + tekshirishga chiqqan tashkilot xaridi
        creds.filter(c => creditRiskCheck(c).isRisk).forEach(cred => {
            if (!cred.inspOrg || !cred.date) return;
            const credTime = new Date(cred.date).getTime();
            procs.forEach(proc => {
                if (!proc.date) return;
                const procTime = new Date(proc.date).getTime();
                const diff = Math.abs(procTime - credTime);
                if (diff <= MONTH_MS * 3) { // 3 oy ichida
                    findings.push({
                        severity: 'critical',
                        type: 'self_credit_procurement_timing',
                        title: `Tekshirgan bankdan kredit + xarid: shubhali vaqt oralig'i`,
                        emp: emp.fio,
                        detail: `Tekshirgan bankdan kredit [${fd(cred.date)}] ‚Äî Bank: "${cred.inspOrg}" ‚Äî Xarid: "${proc.org}" [${fd(proc.date)}] ‚Äî ${fmt(proc.amount)} so'm. Oraliq: ${Math.round(diff/86400000)} kun`,
                        risk: 20
                    });
                }
            });
        });

        // 2D: Balans 5x oshgan oy = mol-mulk xaridi oyi
        DB.accounts.filter(a => a.empId == emp.id && a.exceeded).forEach(acc => {
            if (!acc.month) return;
            const accMonth = acc.month; // YYYY-MM format
            props.forEach(prop => {
                if (!prop.date) return;
                const propMonth = prop.date.substring(0, 7);
                if (accMonth === propMonth) {
                    findings.push({
                        severity: 'critical',
                        type: 'balance_property_same_month',
                        title: `Balans 5x+ oshgan oy = mol-mulk xaridi oyi`,
                        emp: emp.fio,
                        detail: `Oy: ${accMonth} ‚Äî Balans: ${fmt(acc.balance)} (${acc.ratio}x maosh) ‚Äî Mol-mulk: ${prop.type} ‚Äî ${fmt(prop.value)} so'm. Bu jiddiy signal!`,
                        risk: 25
                    });
                }
            });
        });
    });

    aiFindings.temporal = removeDuplicateFindings(findings);
}

// ============================================================
// 3. TURMUSH TARZI vs DAROMAD NOMUTANOSIBLIGI
// ============================================================
function analysisLifestyleIncome() {
    const findings = [];

    DB.employees.forEach(emp => {
        const yearlySalary = emp.salary * 12;
        if (yearlySalary <= 0) return;

        // Total mol-mulk
        const totalProperty = DB.properties.filter(p => p.empId == emp.id).reduce((s, p) => s + (p.value || 0), 0);
        // Total safari xarajat
        const totalTravel = DB.travels.filter(t => t.empId == emp.id).reduce((s, t) => s + (t.cost || 0), 0);
        // Max balans
        const maxBalance = Math.max(0, ...DB.accounts.filter(a => a.empId == emp.id).map(a => a.balance || 0));
        // Total kredit
        const totalCredit = DB.credits.filter(c => c.empId == emp.id).reduce((s, c) => s + (c.amount || 0), 0);

        const totalWealth = totalProperty + totalTravel + maxBalance;
        const wealthToIncome = yearlySalary > 0 ? totalWealth / yearlySalary : 0;

        // Mol-mulk yillik maoshdan 3x ortiq
        if (totalProperty > yearlySalary * 3) {
            findings.push({
                severity: 'critical',
                type: 'wealth_income_gap',
                title: `Mol-mulk yillik maoshdan ${(totalProperty/yearlySalary).toFixed(1)}x ortiq`,
                emp: emp.fio,
                detail: `Yillik maosh: ${fmt(yearlySalary)} ‚Üí Mol-mulk: ${fmt(totalProperty)} so'm (${(totalProperty/yearlySalary).toFixed(1)}x). Daromad manbasi noma'lum!`,
                risk: 20,
                data: { salary: yearlySalary, property: totalProperty, travel: totalTravel, balance: maxBalance, ratio: wealthToIncome.toFixed(1) }
            });
        }

        // Safari xarajatlari yillik maoshdan 50%+ ortiq
        if (totalTravel > yearlySalary * 0.5) {
            findings.push({
                severity: 'high',
                type: 'travel_income_gap',
                title: `Safari xarajati yillik maoshning ${(totalTravel/yearlySalary*100).toFixed(0)}%`,
                emp: emp.fio,
                detail: `Yillik maosh: ${fmt(yearlySalary)} ‚Üí Safarlar: ${fmt(totalTravel)} so'm. Safari xarajatlari daromadga nomutanosib.`,
                risk: 12,
                data: { salary: yearlySalary, travel: totalTravel }
            });
        }

        // Umumiy boylik yillik maoshdan 5x ortiq
        if (wealthToIncome > 5) {
            findings.push({
                severity: 'critical',
                type: 'total_lifestyle_gap',
                title: `Umumiy boylik/xarajat yillik maoshdan ${wealthToIncome.toFixed(1)}x ortiq`,
                emp: emp.fio,
                detail: `Yillik maosh: ${fmt(yearlySalary)} ‚Üí Mol-mulk: ${fmt(totalProperty)} + Safari: ${fmt(totalTravel)} + Balans: ${fmt(maxBalance)} = Jami: ${fmt(totalWealth)} (${wealthToIncome.toFixed(1)}x). JIDDIY NOMUTANOSIBLIK!`,
                risk: 25,
                data: { salary: yearlySalary, property: totalProperty, travel: totalTravel, balance: maxBalance, total: totalWealth, ratio: wealthToIncome.toFixed(1) }
            });
        }

        // Kredit summasi maoshdan 10x ortiq ‚Äî qaytarish imkoniyati shubhali
        if (totalCredit > yearlySalary * 10) {
            findings.push({
                severity: 'high',
                type: 'credit_income_gap',
                title: `Kredit summasi yillik maoshdan ${(totalCredit/yearlySalary).toFixed(1)}x ortiq`,
                emp: emp.fio,
                detail: `Yillik maosh: ${fmt(yearlySalary)} ‚Üí Kreditlar: ${fmt(totalCredit)} so'm. Qaytarish imkoniyati shubhali!`,
                risk: 15
            });
        }
    });

    aiFindings.lifestyle = findings;
}

// ============================================================
// 4. XARID FAVORITIZMI
// ============================================================
function analysisProcurementFavoritism() {
    const findings = [];

    // Tashkilot bo'yicha guruhlash
    const orgMap = {};
    DB.procurements.forEach(p => {
        const key = (p.org || '').toLowerCase().trim();
        if (!key) return;
        if (!orgMap[key]) orgMap[key] = { org: p.org, items: [], employees: new Set(), total: 0 };
        orgMap[key].items.push(p);
        orgMap[key].employees.add(p.empId);
        orgMap[key].total += (p.amount || 0);
    });

    Object.values(orgMap).forEach(group => {
        // Bitta tashkilotdan 3+ xarid
        if (group.items.length >= 3) {
            findings.push({
                severity: 'high',
                type: 'repeated_vendor',
                title: `"${group.org}" dan ${group.items.length} marta xarid`,
                emp: [...group.employees].map(id => gn(id)).join(', '),
                detail: `Jami: ${fmt(group.total)} so'm | ${group.items.length} marta | Xodimlar: ${[...group.employees].map(id => gn(id)).join(', ')}. Raqobatchilik buzilgan bo'lishi mumkin!`,
                risk: 18
            });
        }

        // Bitta tashkilotga 500M+ so'm
        if (group.total > 500000000) {
            findings.push({
                severity: 'critical',
                type: 'vendor_high_amount',
                title: `"${group.org}" ga ${fmt(group.total)} so'm`,
                emp: [...group.employees].map(id => gn(id)).join(', '),
                detail: `Bitta yetkazuvchiga ${fmt(group.total)} so'm ‚Äî juda katta summa. Tender jarayonini tekshiring!`,
                risk: 20
            });
        }
    });

    // Xodim o'zi xarid komissiyasida + o'sha tashkilotdan xarid + qarindosh shu tashkilotda
    DB.employees.forEach(emp => {
        const procs = DB.procurements.filter(p => p.empId == emp.id);
        const rels = DB.relatives.filter(r => r.empId == emp.id);
        procs.forEach(proc => {
            const procOrg = (proc.org || '').toLowerCase();
            rels.forEach(rel => {
                const relWork = (rel.workplace || '').toLowerCase();
                if (procOrg && relWork && (procOrg.includes(relWork) || relWork.includes(procOrg))) {
                    findings.push({
                        severity: 'critical',
                        type: 'insider_procurement',
                        title: `Ichki xarid: qarindosh ishlayotgan joydan xarid`,
                        emp: emp.fio,
                        detail: `${emp.fio} "${proc.org}" dan ${fmt(proc.amount)} so'm xarid qilgan ‚Äî ${rel.fio} (${rel.degree}) aynan shu yerda ishlaydi!`,
                        risk: 30
                    });
                }
            });
        });
    });

    aiFindings.favoritism = removeDuplicateFindings(findings);
}

// ============================================================
// 5. TARMOQ TAHLILI ‚Äî Aloqalar grafini qurish
// ============================================================
function analysisNetworkBuild() {
    const nodes = [];
    const edges = [];
    const nodeMap = {};

    function addNode(id, label, type, risk) {
        if (!nodeMap[id]) {
            nodeMap[id] = nodes.length;
            nodes.push({ id, label, type, risk: risk || 0 });
        }
        return nodeMap[id];
    }

    // Xodimlar
    DB.employees.forEach(emp => {
        addNode('emp_' + emp.id, emp.fio.split(' ').slice(0,2).join(' '), 'employee', emp.riskScore || 0);
    });

    // Qarindoshlar va aloqalar
    DB.relatives.forEach(rel => {
        const rId = 'rel_' + rel.id;
        addNode(rId, rel.fio ? rel.fio.split(' ').slice(0,2).join(' ') : '?', 'relative', rel.inBanking === 'yes' ? 50 : 10);
        edges.push({ from: 'emp_' + rel.empId, to: rId, label: rel.degree, suspicious: rel.inBanking === 'yes' });

        // Qarindosh ish joyi = tashkilot node
        if (rel.workplace) {
            const wId = 'org_' + rel.workplace.toLowerCase().trim().replace(/[^a-z0-9]/g, '_');
            addNode(wId, rel.workplace.split(',')[0].trim(), 'organization', 0);
            edges.push({ from: rId, to: wId, label: 'ishlaydi', suspicious: false });
        }
    });

    // Tekshirish tashkilotlari
    DB.credits.forEach(cred => {
        if (cred.inspOrg) {
            const oId = 'org_' + cred.inspOrg.toLowerCase().trim().replace(/[^a-z0-9]/g, '_');
            addNode(oId, cred.inspOrg.split(',')[0].trim(), 'organization', 0);
            edges.push({ from: 'emp_' + cred.empId, to: oId, label: 'tekshirdi', suspicious: creditRiskCheck(cred).isRisk });
        }
    });

    // Xarid tashkilotlari
    DB.procurements.forEach(proc => {
        if (proc.org) {
            const oId = 'org_' + proc.org.toLowerCase().trim().replace(/[^a-z0-9]/g, '_');
            addNode(oId, proc.org.split(',')[0].trim(), 'organization', proc.prevCount >= 3 ? 40 : 0);
            edges.push({ from: 'emp_' + proc.empId, to: oId, label: 'xarid', suspicious: proc.prevCount >= 3 });
        }
    });

    aiFindings.network = { nodes, edges };
}

// ============================================================
// 6. BASHORAT VA TREND
// ============================================================
function analysisTrends() {
    const trends = [];

    DB.employees.forEach(emp => {
        const history = DB.scoreHistory.filter(h => h.empId == emp.id).sort((a,b) => new Date(a.date) - new Date(b.date));
        if (history.length >= 2) {
            const first = history[0].total;
            const last = history[history.length - 1].total;
            const diff = last - first;
            const direction = diff > 0 ? 'up' : diff < 0 ? 'down' : 'stable';

            trends.push({
                emp: emp.fio,
                empId: emp.id,
                position: emp.position,
                current: last,
                first,
                diff,
                direction,
                level: riskLvl(last),
                count: history.length,
                predicted: Math.min(100, Math.max(0, last + diff)) // simple linear
            });
        } else {
            // Hali tarixi yo'q ‚Äî hozirgi holatni ko'rsatish
            const s = scoreFor(emp.id);
            trends.push({
                emp: emp.fio,
                empId: emp.id,
                position: emp.position,
                current: s.total,
                first: s.total,
                diff: 0,
                direction: 'new',
                level: riskLvl(s.total),
                count: 0,
                predicted: s.total
            });
        }
    });

    aiFindings.trends = trends.sort((a,b) => b.current - a.current);
}

// ============================================================
// 7. AVTOMATLASHTIRILGAN TAVSIYALAR
// ============================================================
function analysisRecommendations() {
    const recs = [];
    const allFindings = [...aiFindings.cross, ...aiFindings.temporal, ...aiFindings.lifestyle, ...aiFindings.favoritism];
    const critCount = allFindings.filter(f => f.severity === 'critical').length;
    const highCount = allFindings.filter(f => f.severity === 'high').length;

    // Xodim bo'yicha guruhlash
    const empFindings = {};
    allFindings.forEach(f => {
        const name = f.emp.split(' ‚Üî ')[0];
        if (!empFindings[name]) empFindings[name] = { critical: 0, high: 0, total: 0 };
        empFindings[name].total++;
        if (f.severity === 'critical') empFindings[name].critical++;
        if (f.severity === 'high') empFindings[name].high++;
    });

    // Zudlik bilan tekshirish kerak bo'lgan xodimlar
    Object.entries(empFindings).filter(([_, v]) => v.critical >= 2).forEach(([name, v]) => {
        recs.push({ priority: 'urgent', icon: 'üî¥', text: `${name} ‚Äî ${v.critical} ta KRITIK topilma. Zudlik bilan ichki audit tekshiruvi o'tkazilsin!`, action: 'Ichki audit' });
    });

    // Kross-referensiya muammolari
    if (aiFindings.cross.filter(f => f.type === 'rel_inspection_match').length) {
        recs.push({ priority: 'urgent', icon: 'üî¥', text: `Qarindosh ishlayotgan tashkilotni tekshirishga chiqish holati aniqlandi. Tekshiruv vakolatlarini qayta taqsimlang!`, action: 'Vakolat qayta taqsimlash' });
    }
    if (aiFindings.cross.filter(f => f.type.includes('procurement_match')).length) {
        recs.push({ priority: 'urgent', icon: 'üî¥', text: `Qarindosh ishlayotgan/ulush bor korxonadan xarid aniqlandi. Xarid komissiyasi tarkibini o'zgartiring!`, action: 'Komissiya o\'zgartirish' });
    }

    // Vaqt pattern tavsiyalari
    if (aiFindings.temporal.length) {
        recs.push({ priority: 'high', icon: 'üü†', text: `${aiFindings.temporal.length} ta shubhali vaqt mos kelishi. Har bir holatni alohida tekshiring ‚Äî kredit, mol-mulk va safari vaqtlarini solishtiring.`, action: 'Vaqt audit' });
    }

    // Turmush tarzi
    if (aiFindings.lifestyle.length) {
        recs.push({ priority: 'high', icon: 'üü†', text: `${aiFindings.lifestyle.length} ta daromad-xarajat nomutanosibligi. Qo'shimcha daromad manbalari haqida tushuntirish talab qiling.`, action: 'Daromad tekshiruv' });
    }

    // Favoritizm
    if (aiFindings.favoritism.length) {
        recs.push({ priority: 'medium', icon: 'üü°', text: `Xarid favoritizmi belgilari: bir yetkazuvchiga takroriy xaridlar. Tender jarayonini qat'iyroq nazorat qiling.`, action: 'Tender nazorat' });
    }

    // Umumiy tavsiyalar
    if (critCount === 0 && highCount === 0) {
        recs.push({ priority: 'low', icon: 'üü¢', text: `Jiddiy xavflar aniqlanmadi. Profilaktik monitoringni davom ettiring.`, action: 'Davom etish' });
    }

    recs.push({ priority: 'info', icon: 'üìã', text: `Barcha xodimlar uchun har chorakda deklaratsiya yangilash majburiy qilinsin.`, action: 'Siyosat' });
    recs.push({ priority: 'info', icon: 'üìã', text: `Kredit ajratish va tekshiruv funksiyalarini turli xodimlarga ajrating (segregation of duties).`, action: 'Tizim' });

    aiFindings.recs = recs;
}

// ============================================================
// 8. ZANJIRLI ALOQA TAHLILI (Multi-Hop Chain Analysis)
// Xodim ‚Üí Qarindosh ‚Üí Tashkilot ‚Üí Boshqa xodim ‚Üí ... zanjirini
// 3 bosqichgacha kuzatib boradi. Eng yashirin aloqalarni topadi.
// ============================================================
function analysisChainConnections() {
    const chains = [];
    
    // Barcha tashkilot nomlarini normalizatsiya qilish uchun xarita
    function norm(s) { return (s||'').toLowerCase().replace(/[''""]/g,'').replace(/\s+/g,' ').trim(); }
    
    // Tashkilot ‚Üí xodim xaritasi (qaysi xodim qaysi tashkilot bilan bog'liq)
    const orgToEmp = {}; // org_name ‚Üí [{empId, relation}]
    
    DB.relatives.forEach(r => {
        if (r.workplace) {
            const key = norm(r.workplace);
            if (!orgToEmp[key]) orgToEmp[key] = [];
            orgToEmp[key].push({ empId: r.empId, via: 'qarindosh', relName: r.fio, relDeg: r.degree });
        }
    });
    
    DB.credits.forEach(c => {
        if (c.inspOrg) {
            const key = norm(c.inspOrg);
            if (!orgToEmp[key]) orgToEmp[key] = [];
            orgToEmp[key].push({ empId: c.empId, via: 'tekshirish', creditType: c.type, amount: c.amount });
        }
    });
    
    DB.procurements.forEach(p => {
        if (p.org) {
            const key = norm(p.org);
            if (!orgToEmp[key]) orgToEmp[key] = [];
            orgToEmp[key].push({ empId: p.empId, via: 'xarid', amount: p.amount });
        }
    });
    
    // Ustav ulushi
    DB.declarations.forEach(d => {
        if (d.share !== 'no' && d.shareDetail) {
            const key = norm(d.shareDetail.split('‚Äî')[0]);
            if (!orgToEmp[key]) orgToEmp[key] = [];
            orgToEmp[key].push({ empId: d.empId, via: 'ustav_ulushi', detail: d.shareDetail });
        }
    });
    
    // Har bir tashkilot orqali bog'langan xodimlarni topish (2+ xodim = zanjir)
    Object.entries(orgToEmp).forEach(([orgKey, connections]) => {
        // Turli xodimlarni aniqlash
        const uniqueEmps = [...new Set(connections.map(c => c.empId))];
        if (uniqueEmps.length >= 2) {
            // 2 ta turli xodim bitta tashkilot orqali bog'langan!
            const orgName = connections[0].via === 'qarindosh' 
                ? DB.relatives.find(r => norm(r.workplace) === orgKey)?.workplace 
                : connections[0].via === 'tekshirish'
                ? DB.credits.find(c => norm(c.inspOrg) === orgKey)?.inspOrg
                : DB.procurements.find(p => norm(p.org) === orgKey)?.org || orgKey;
            
            // Zanjir tafsiloti
            const details = connections.map(c => {
                const empName = gn(c.empId);
                if (c.via === 'qarindosh') return `${empName} ‚Üí qarindosh ${c.relName} (${c.relDeg}) ‚Üí ${orgName}da ishlaydi`;
                if (c.via === 'tekshirish') return `${empName} ‚Üí kredit tekshiruvi ‚Üí ${orgName}`;
                if (c.via === 'xarid') return `${empName} ‚Üí xarid qildi ‚Üí ${orgName} (${fmt(c.amount)} so'm)`;
                if (c.via === 'ustav_ulushi') return `${empName} ‚Üí ustav ulushi ‚Üí ${c.detail}`;
                return `${empName} ‚Üí ${orgName}`;
            });
            
            chains.push({
                severity: uniqueEmps.length > 2 ? 'critical' : 'high',
                hops: connections.length,
                orgName: orgName || orgKey,
                employees: uniqueEmps.map(id => gn(id)),
                empIds: uniqueEmps,
                details,
                risk: uniqueEmps.length * 15
            });
        }
    });
    
    // Qarindoshlar orqali bog'langan xodimlar (ikki xodimning qarindoshi bir joyda ishlaydi)
    const relsByWork = {};
    DB.relatives.forEach(r => {
        if (r.workplace) {
            const key = norm(r.workplace);
            if (!relsByWork[key]) relsByWork[key] = [];
            relsByWork[key].push(r);
        }
    });
    
    Object.entries(relsByWork).forEach(([wKey, rels]) => {
        const empIds = [...new Set(rels.map(r => r.empId))];
        if (empIds.length >= 2) {
            // Turli xodimlarning qarindoshlari BIR tashkilotda
            const details = rels.map(r => `${gn(r.empId)} ning ${r.degree}si ${r.fio} ‚Üí ${r.workplace}`);
            chains.push({
                severity: 'high',
                hops: rels.length,
                orgName: rels[0].workplace,
                employees: empIds.map(id => gn(id)),
                empIds,
                details,
                risk: 20
            });
        }
    });
    
    aiFindings.chains = removeDuplicateFindings(chains.map(c => ({...c, type:'chain', title: `${c.employees.join(' ‚Üî ')} ‚Üí ${c.orgName}`, emp: c.employees.join(', '), detail: c.details.join(' | ')})));
}

// ============================================================
// 9. STATISTIK ANOMALIYA INDEKSI (Z-Score Analysis)
// O'rtachadan qanchalik chetga chiqganini matematik hisoblaydi.
// Z > 2.0 = ogoh bo'l, Z > 3.0 = jiddiy anomaliya.
// ============================================================
function analysisAnomalyZScore() {
    const anomalies = [];
    if (DB.employees.length < 2) return; // Z-score uchun kamida 2 ta kerak
    
    // Har bir metrika uchun statistika
    function calcStats(values) {
        const n = values.length;
        if (n < 2) return { mean: 0, std: 1 };
        const mean = values.reduce((s,v) => s+v, 0) / n;
        const variance = values.reduce((s,v) => s + (v-mean)**2, 0) / (n-1);
        return { mean, std: Math.sqrt(variance) || 1 };
    }
    
    // Metrikalrni yig'ish
    const empData = DB.employees.map(emp => {
        const yearlySalary = emp.salary * 12;
        const totalProperty = DB.properties.filter(p => p.empId == emp.id).reduce((s,p) => s+(p.value||0), 0);
        const totalTravel = DB.travels.filter(t => t.empId == emp.id).reduce((s,t) => s+(t.cost||0), 0);
        const maxBalance = Math.max(0, ...DB.accounts.filter(a => a.empId == emp.id).map(a => a.balance||0), 0);
        const totalCredit = DB.credits.filter(c => c.empId == emp.id).reduce((s,c) => s+(c.amount||0), 0);
        const relCount = DB.relatives.filter(r => r.empId == emp.id && r.inBanking === 'yes').length;
        const procTotal = DB.procurements.filter(p => p.empId == emp.id).reduce((s,p) => s+(p.amount||0), 0);
        const propToSalary = yearlySalary > 0 ? totalProperty / yearlySalary : 0;
        const balToSalary = emp.salary > 0 ? maxBalance / emp.salary : 0;
        
        return { emp, yearlySalary, totalProperty, totalTravel, maxBalance, totalCredit, relCount, procTotal, propToSalary, balToSalary };
    });
    
    // Z-score hisoblash funksiyalari
    const metrics = [
        { key: 'propToSalary', label: 'Mol-mulk / Maosh nisbati', unit: 'x', threshold: 2.0 },
        { key: 'balToSalary', label: 'Balans / Oylik nisbati', unit: 'x', threshold: 2.0 },
        { key: 'totalTravel', label: 'Safari xarajatlari', unit: "so'm", threshold: 2.0 },
        { key: 'totalCredit', label: 'Kredit summasi', unit: "so'm", threshold: 2.0 },
        { key: 'procTotal', label: 'Xarid summasi', unit: "so'm", threshold: 2.0 },
    ];
    
    metrics.forEach(metric => {
        const values = empData.map(d => d[metric.key] || 0);
        const stats = calcStats(values);
        
        empData.forEach(d => {
            const val = d[metric.key] || 0;
            const z = stats.std > 0 ? (val - stats.mean) / stats.std : 0;
            
            if (z > metric.threshold) {
                anomalies.push({
                    severity: z > 3.0 ? 'critical' : 'high',
                    type: 'z_score_anomaly',
                    title: `${metric.label}: Z-score = ${z.toFixed(2)}`,
                    emp: d.emp.fio,
                    empId: d.emp.id,
                    metric: metric.key,
                    value: val,
                    mean: stats.mean,
                    std: stats.std,
                    zScore: z,
                    detail: `${d.emp.fio}: ${metric.label} = ${metric.key.includes('Salary') || metric.key.includes('ratio') ? val.toFixed(1)+'x' : fmt(Math.round(val))} ${metric.unit}. O'rtacha: ${metric.key.includes('Salary') ? stats.mean.toFixed(1)+'x' : fmt(Math.round(stats.mean))}. Standart og'ish: ${z.toFixed(2)}œÉ ‚Äî ${z>3?'JIDDIY':'SHUBHALI'} anomaliya!`,
                    risk: Math.round(z * 8)
                });
            }
        });
    });
    
    aiFindings.anomalies = anomalies;
}

// ============================================================
// 10. ERTA OGOHLANTIRISH TIZIMI (Early Warning / Predictive)
// Hali to'liq korrupsiya bo'lmagan, lekin xavf signallari 
// oshib borayotgan xodimlarni topadi.
// ============================================================
function analysisEarlyWarning() {
    const warnings = [];
    
    DB.employees.forEach(emp => {
        const signals = [];
        let urgency = 0; // 0-100 shoshilinchlik
        
        const rels = DB.relatives.filter(r => r.empId == emp.id);
        const creds = DB.credits.filter(c => c.empId == emp.id);
        const props = DB.properties.filter(p => p.empId == emp.id);
        const accs = DB.accounts.filter(a => a.empId == emp.id);
        const decls = DB.declarations.filter(d => d.empId == emp.id);
        const travels = DB.travels.filter(t => t.empId == emp.id);
        const procs = DB.procurements.filter(p => p.empId == emp.id);
        
        // Signal 1: Qarindosh bankda + hali kredit ajratmagan, LEKIN kredit bo'limida ishlaydi
        const hasRelInBank = rels.some(r => r.inBanking === 'yes');
        const suspCredit = creds.some(c => creditRiskCheck(c).isRisk);
        const inCreditDept = (emp.department||'').toLowerCase().includes('kredit');
        if (hasRelInBank && inCreditDept && !suspCredit) {
            signals.push('Qarindoshi bankda ishlaydi + kredit bo\'limida ‚Äî hali shubhali kredit yo\'q, LEKIN risk yashirin');
            urgency += 25;
        }
        
        // Signal 2: Ustav ulushi bor + xarid komissiyasida
        const hasShare = decls.some(d => d.share !== 'no');
        const inProcDept = (emp.department||'').toLowerCase().includes('xarid');
        if (hasShare && inProcDept) {
            signals.push('Ustav ulushi bor korxona + xarid bo\'limida ishlaydi ‚Äî potentsial manfaat to\'qnashuvi');
            urgency += 30;
        }
        
        // Signal 3: Balans oshib bormoqda (4x ‚Äî 5x orasida, tezda 5x ga yetadi)
        const latestAcc = accs.sort((a,b) => (b.month||'').localeCompare(a.month||''))[0];
        if (latestAcc && !latestAcc.exceeded) {
            const ratio = parseFloat(latestAcc.ratio);
            if (ratio >= 3.5 && ratio < 5) {
                signals.push(`Balans ${ratio}x ‚Äî 5x chegaraga yaqinlashmoqda! (${fmt(latestAcc.balance)} so'm)`);
                urgency += 20;
            }
        }
        
        // Signal 4: Scoring tarixi ko'tarilmoqda
        const history = DB.scoreHistory.filter(h => h.empId == emp.id).sort((a,b) => new Date(a.date) - new Date(b.date));
        if (history.length >= 2) {
            const recentChange = history[history.length-1].total - history[history.length-2].total;
            if (recentChange > 10) {
                signals.push(`Risk bali tez oshmoqda: +${recentChange} ball oxirgi hisoblashda`);
                urgency += 15;
            }
        }
        
        // Signal 5: Ko'p qarindosh + ba'zilari biznesda
        const relWithShare = rels.filter(r => r.companyShare);
        if (relWithShare.length >= 2) {
            signals.push(`${relWithShare.length} ta qarindoshning korxonada ulushi bor ‚Äî yashirin tarmoq xavfi`);
            urgency += 20;
        }
        
        // Signal 6: Safari xarajatlari oshmoqda + kredit bo'limida
        const highTravel = travels.filter(t => parseFloat(t.ratio) > 2);
        if (highTravel.length && inCreditDept) {
            signals.push('Qimmat chet el safarilari + kredit bo\'limida ishlash = pora xavfi');
            urgency += 25;
        }
        
        // Signal 7: Deklaratsiya topshirmagan (hali deklaratsiya yo'q)
        if (!decls.length && (hasRelInBank || rels.length > 0)) {
            signals.push('Qarindoshlari bor, LEKIN hali deklaratsiya topshirmagan! Yashirish ehtimoli.');
            urgency += 15;
        }
        
        // Faqat signallari bor xodimlarni qo'shish
        if (signals.length > 0 && urgency >= 20) {
            warnings.push({
                severity: urgency >= 50 ? 'critical' : urgency >= 30 ? 'high' : 'medium',
                emp: emp.fio,
                empId: emp.id,
                position: emp.position,
                department: emp.department,
                signals,
                urgency: Math.min(urgency, 100),
                currentScore: emp.riskScore || 0,
                type: 'early_warning',
                title: `${signals.length} ta erta signal`,
                detail: signals.join('; '),
                risk: urgency
            });
        }
    });
    
    aiFindings.earlyWarnings = warnings.sort((a,b) => b.urgency - a.urgency);
}

// ============================================================
// 11. AVTOMATIK QOIDALAR MOTORI (Rules Engine)
// 15 ta oldindan belgilangan compliance qoidasi. Har bir xodim
// har bir qoidaga qarshi tekshiriladi.
// ============================================================
function analysisRulesEngine() {
    // Qoidalar ro'yxati ‚Äî har biri funksiya sifatida
    const RULES = [
        { id: 'R01', name: "O'zi kredit ajratish taqiqlanadi", severity: 'critical', category: 'Kredit',
          check: emp => DB.credits.filter(c => c.empId==emp.id && creditRiskCheck(c).isRisk).length > 0,
          detail: emp => { const c = DB.credits.find(c => c.empId==emp.id && creditRiskCheck(c).isRisk); return c ? `${c.type} ‚Äî ${fmt(c.amount)} so'm (${c.bank}) [${fd(c.date)}]` : ''; }
        },
        { id: 'R02', name: 'Balans 5x maoshdan oshmasligi kerak', severity: 'critical', category: 'Balans',
          check: emp => DB.accounts.some(a => a.empId==emp.id && a.exceeded),
          detail: emp => { const a = DB.accounts.find(a => a.empId==emp.id && a.exceeded); return a ? `${fmt(a.balance)} = ${a.ratio}x maosh` : ''; }
        },
        { id: 'R03', name: 'Qarindosh ishlayotgan bankdan kredit olmasligi kerak', severity: 'high', category: 'Conflict',
          check: emp => {
            const relBanks = DB.relatives.filter(r => r.empId==emp.id && r.inBanking==='yes').map(r => norm(r.workplace||''));
            return DB.credits.filter(c => c.empId==emp.id).some(c => relBanks.some(b => b && norm(c.bank||'').includes(b)));
          },
          detail: emp => 'Qarindosh ishlayotgan bankdan kredit olingan'
        },
        { id: 'R04', name: 'Ustav ulushi bor tashkilotdan xarid qilish taqiqlanadi', severity: 'critical', category: 'Procurement',
          check: emp => {
            const shares = DB.declarations.filter(d => d.empId==emp.id && d.share!=='no').map(d => norm(d.shareDetail||''));
            return DB.procurements.filter(p => p.empId==emp.id).some(p => shares.some(s => s && (norm(p.org||'').includes(s) || s.includes(norm(p.org||'')))));
          },
          detail: emp => 'Ustav ulushi bor korxonadan xarid'
        },
        { id: 'R05', name: 'Bitta yetkazuvchidan 5+ marta xarid ‚Äî tender buzilishi', severity: 'high', category: 'Procurement',
          check: emp => DB.procurements.some(p => p.empId==emp.id && p.prevCount >= 5),
          detail: emp => { const p = DB.procurements.find(p => p.empId==emp.id && p.prevCount>=5); return p ? `${p.org}: ${p.prevCount} marta` : ''; }
        },
        { id: 'R06', name: 'Kredit + mol-mulk xaridi 30 kun ichida bo\'lmasligi kerak', severity: 'high', category: 'Temporal',
          check: emp => {
            const MONTH = 30*86400000;
            return DB.credits.filter(c => c.empId==emp.id).some(c => DB.properties.filter(p => p.empId==emp.id).some(p => Math.abs(new Date(p.date||0)-new Date(c.date||0)) < MONTH));
          },
          detail: emp => 'Kredit va mol-mulk xaridi 1 oy ichida'
        },
        { id: 'R07', name: 'Mol-mulk qiymati yillik maoshdan 5x ortiq ‚Äî tushuntirish talab etiladi', severity: 'high', category: 'Lifestyle',
          check: emp => {
            const ys = emp.salary*12; const tp = DB.properties.filter(p=>p.empId==emp.id).reduce((s,p)=>s+(p.value||0),0);
            return ys > 0 && tp > ys * 5;
          },
          detail: emp => { const tp = DB.properties.filter(p=>p.empId==emp.id).reduce((s,p)=>s+(p.value||0),0); return `Mol-mulk: ${fmt(tp)} / Yillik maosh: ${fmt(emp.salary*12)}`; }
        },
        { id: 'R08', name: 'Har chorakda deklaratsiya topshirish majburiy', severity: 'medium', category: 'Compliance',
          check: emp => DB.declarations.filter(d => d.empId==emp.id).length === 0,
          detail: emp => 'Hali deklaratsiya topshirmagan'
        },
        { id: 'R09', name: 'Safari xarajati maoshning 3x dan ortiq ‚Äî tushuntirish talab etiladi', severity: 'medium', category: 'Travel',
          check: emp => DB.travels.some(t => t.empId==emp.id && parseFloat(t.ratio) > 3),
          detail: emp => { const t = DB.travels.find(t => t.empId==emp.id && parseFloat(t.ratio)>3); return t ? `${t.country}: ${fmt(t.cost)} so'm = ${t.ratio}x maosh` : ''; }
        },
        { id: 'R10', name: 'Qarindosh ishlaydigan tashkilotni tekshirish taqiqlanadi', severity: 'critical', category: 'Conflict',
          check: emp => {
            const relWorks = DB.relatives.filter(r=>r.empId==emp.id).map(r => norm(r.workplace||''));
            return DB.credits.filter(c=>c.empId==emp.id).some(c => relWorks.some(w => w && norm(c.inspOrg||'').includes(w)));
          },
          detail: emp => 'Qarindosh ish joyi = tekshiruv tashkiloti'
        },
        { id: 'R11', name: 'Kredit bo\'limi xodimi o\'z yaqiniga kredit ajrata olmaydi', severity: 'critical', category: 'Kredit',
          check: emp => {
            if (!(emp.department||'').toLowerCase().includes('kredit')) return false;
            const relNames = DB.relatives.filter(r=>r.empId==emp.id).map(r => norm(r.fio||''));
            // Kredit oluvchi nomi ‚Äî inspOrg yoki bank ma'lumotlarida
            return false; // Bu qoida chuqurroq ma'lumot talab qiladi
          },
          detail: emp => ''
        },
        { id: 'R12', name: 'Balans 3x-5x oralig\'ida ‚Äî monitoring kuchaytirilsin', severity: 'medium', category: 'Balans',
          check: emp => DB.accounts.some(a => a.empId==emp.id && !a.exceeded && parseFloat(a.ratio) >= 3),
          detail: emp => { const a = DB.accounts.find(a => a.empId==emp.id && !a.exceeded && parseFloat(a.ratio)>=3); return a ? `${fmt(a.balance)} = ${a.ratio}x` : ''; }
        },
        { id: 'R13', name: 'Ikki va undan ortiq manfaat to\'qnashuvi ‚Äî maxsus nazorat', severity: 'high', category: 'Conflict',
          check: emp => {
            let count = 0;
            if (DB.declarations.some(d => d.empId==emp.id && d.relBank==='yes')) count++;
            if (DB.declarations.some(d => d.empId==emp.id && d.share!=='no')) count++;
            if (DB.relatives.filter(r => r.empId==emp.id && r.inBanking==='yes').length > 1) count++;
            return count >= 2;
          },
          detail: emp => 'Bir nechta manfaat to\'qnashuvi'
        },
        { id: 'R14', name: 'Xarid summa 500M+ so\'m ‚Äî tender komissiyasi majburiy', severity: 'high', category: 'Procurement',
          check: emp => DB.procurements.some(p => p.empId==emp.id && p.amount > 500000000),
          detail: emp => { const p = DB.procurements.find(p => p.empId==emp.id && p.amount>500e6); return p ? `${p.org}: ${fmt(p.amount)} so'm` : ''; }
        },
        { id: 'R15', name: 'Scoring bali 50+ ‚Äî kuchaytirilgan monitoring', severity: 'medium', category: 'Scoring',
          check: emp => (emp.riskScore||0) >= 50,
          detail: emp => `Scoring: ${emp.riskScore||0} ball`
        }
    ];
    
    const results = [];
    RULES.forEach(rule => {
        const violations = [];
        DB.employees.forEach(emp => {
            try {
                if (rule.check(emp)) {
                    violations.push({ empId: emp.id, empName: emp.fio, detail: typeof rule.detail === 'function' ? rule.detail(emp) : '' });
                }
            } catch(e) {}
        });
        results.push({ ...rule, violated: violations.length > 0, violations, check: undefined, detail: undefined });
    });
    
    aiFindings.rulesResults = results;
}

// ============================================================
// 12. VAZIFALARNINI AJRATISH TAHLILI (Segregation of Duties)
// Bir xodimda bir vaqtda bo'lmasligi kerak bo'lgan vakolatlar
// kombinatsiyasini aniqlaydi.
// ============================================================
function analysisSegregationOfDuties() {
    const violations = [];
    
    DB.employees.forEach(emp => {
        // Xodim rollari va faoliyatini aniqlash
        const roles = new Set();
        const dept = (emp.department||'').toLowerCase();
        const pos = (emp.position||'').toLowerCase();
        
        // Kredit ajratuvchi?
        if (dept.includes('kredit') || pos.includes('kredit')) roles.add('credit_issuer');
        if (DB.credits.some(c => c.empId == emp.id && c.inspOrg)) roles.add('inspector');
        
        // Tekshiruvchi?
        if (DB.credits.some(c => c.empId == emp.id && c.inspOrg)) roles.add('inspector');
        if (dept.includes('audit') || pos.includes('audit') || dept.includes('compliance')) roles.add('inspector');
        
        // Xarid qiluvchi?
        if (DB.procurements.some(p => p.empId == emp.id)) roles.add('procurer');
        if (dept.includes('xarid') || pos.includes('xarid')) roles.add('procurer');
        
        // Hisobchi / Moliyachi?
        if (dept.includes('buxgalter') || dept.includes('moliya') || pos.includes('hisobchi')) roles.add('finance');
        
        // Rahbar?
        if (pos.includes('boshlig') || pos.includes('direktor') || pos.includes('boshqaruvchi')) roles.add('manager');
        
        // Taqiqlangan kombinatsiyalar
        const forbidden = [
            { a: 'credit_issuer', b: 'inspector', rule: 'Kredit ajratuvchi + Tekshiruvchi = taqiqlangan', severity: 'critical' },
            { a: 'credit_issuer', b: 'procurer', rule: 'Kredit ajratuvchi + Xarid qiluvchi = xavfli', severity: 'high' },
            { a: 'procurer', b: 'finance', rule: 'Xarid qiluvchi + Moliyachi = nazorat buzilishi', severity: 'high' },
        ];
        
        forbidden.forEach(f => {
            if (roles.has(f.a) && roles.has(f.b)) {
                violations.push({
                    severity: f.severity,
                    type: 'sod_violation',
                    title: f.rule,
                    emp: emp.fio,
                    empId: emp.id,
                    position: emp.position,
                    department: emp.department,
                    roles: [...roles],
                    detail: `${emp.fio} (${emp.position}) bir vaqtda "${f.a}" va "${f.b}" vazifalarini bajarmoqda. Bu ichki nazorat tamoyilini buzadi.`,
                    risk: f.severity === 'critical' ? 25 : 15
                });
            }
        });
    });
    
    aiFindings.sodViolations = violations;
}

// ============================================================
// 13. WATCH LIST ‚Äî Avtomatik kuzatuv ro'yxati
// Barcha topilmalarni birlashtirb, har bir xodim uchun
// prioritetlashtirilgan kuzatuv ro'yxatini yaratadi.
// ============================================================
function buildWatchList() {
    const empScoreMap = {};
    
    // Barcha topilmalardan xodimlarni yig'ish
    function addToWatch(empName, score, reason, severity) {
        if (!empScoreMap[empName]) empScoreMap[empName] = { name: empName, totalScore: 0, reasons: [], severities: [] };
        empScoreMap[empName].totalScore += score;
        empScoreMap[empName].reasons.push(reason);
        empScoreMap[empName].severities.push(severity);
    }
    
    aiFindings.cross.forEach(f => addToWatch(f.emp.split(' ‚Üî ')[0], f.risk||10, f.title, f.severity));
    aiFindings.temporal.forEach(f => addToWatch(f.emp, f.risk||10, f.title, f.severity));
    aiFindings.lifestyle.forEach(f => addToWatch(f.emp, f.risk||10, f.title, f.severity));
    aiFindings.favoritism.forEach(f => addToWatch(f.emp.split(',')[0].trim(), f.risk||10, f.title, f.severity));
    aiFindings.chains.forEach(f => { (f.emp||'').split(', ').forEach(e => addToWatch(e.trim(), (f.risk||10)/2, f.title, f.severity)); });
    aiFindings.anomalies.forEach(f => addToWatch(f.emp, f.risk||10, f.title, f.severity));
    aiFindings.earlyWarnings.forEach(f => addToWatch(f.emp, f.risk||10, `Erta signal: ${f.signals.length} ta`, f.severity));
    aiFindings.sodViolations.forEach(f => addToWatch(f.emp, f.risk||10, f.title, f.severity));
    
    // Qoidalar motori natijalarini qo'shish
    aiFindings.rulesResults.filter(r => r.violated).forEach(r => {
        r.violations.forEach(v => addToWatch(v.empName, r.severity==='critical'?20:r.severity==='high'?12:6, `Qoida ${r.id}: ${r.name}`, r.severity));
    });
    
    aiFindings.watchList = Object.values(empScoreMap).sort((a,b) => b.totalScore - a.totalScore).map((w, i) => {
        const maxSev = w.severities.includes('critical') ? 'critical' : w.severities.includes('high') ? 'high' : w.severities.includes('medium') ? 'medium' : 'low';
        return { ...w, rank: i+1, maxSeverity: maxSev, priority: w.totalScore >= 50 ? 'ZUDLIK' : w.totalScore >= 25 ? 'YUQORI' : w.totalScore >= 10 ? "O'RTA" : 'PAST' };
    });
}

// ============================================================
// NEW RENDER FUNCTIONS
// ============================================================
function renderAIChains() {
    const el = document.getElementById('aiChainResults');
    document.getElementById('aiChainCount').textContent = aiFindings.chains.length + ' ta zanjir';
    if (!aiFindings.chains.length) { el.innerHTML = '<div class="empty"><div class="e-icon">‚úÖ</div><p>Ko\'p bosqichli yashirin zanjirlar topilmadi</p></div>'; return; }
    
    el.innerHTML = aiFindings.chains.map(f => {
        const empAvatars = (f.emp||'').split(', ').map(n => `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:var(--accent-soft);border-radius:12px;font-size:11px;font-weight:600;margin:2px;">${n}</span>`).join(' ‚õìÔ∏è ');
        return `<div style="padding:14px;background:var(--bg-input);border-radius:10px;border-left:4px solid ${f.severity==='critical'?'var(--danger)':'var(--warning)'};margin-bottom:10px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                <div style="font-size:14px;font-weight:700;">‚õìÔ∏è ${f.hops}-bosqichli zanjir</div>
                <span class="badge badge-${f.severity}">${f.severity.toUpperCase()}</span>
            </div>
            <div style="margin-bottom:8px;">${empAvatars}</div>
            <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">${f.detail}</div>
        </div>`;
    }).join('');
}

function renderAIAnomalies() {
    const el = document.getElementById('aiAnomalyResults');
    document.getElementById('aiAnomalyCount').textContent = aiFindings.anomalies.length + ' ta anomaliya';
    if (!aiFindings.anomalies.length) { el.innerHTML = '<div class="empty"><div class="e-icon">‚úÖ</div><p>Statistik anomaliyalar topilmadi</p></div>'; return; }
    
    el.innerHTML = aiFindings.anomalies.map(f => {
        // Z-score vizual ko'rsatkichi
        const zPct = Math.min(100, (f.zScore / 5) * 100);
        const zCol = f.zScore > 3 ? 'var(--danger)' : 'var(--warning)';
        return `<div style="padding:14px;background:var(--bg-input);border-radius:10px;border-left:4px solid ${zCol};margin-bottom:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:14px;font-weight:700;">üìä ${f.emp}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span class="mono" style="font-size:18px;font-weight:800;color:${zCol};">${f.zScore.toFixed(2)}œÉ</span>
                    <span class="badge badge-${f.severity}">${f.severity.toUpperCase()}</span>
                </div>
            </div>
            <div style="height:6px;background:var(--bg-card);border-radius:3px;overflow:hidden;margin-bottom:8px;">
                <div style="height:100%;width:${zPct}%;background:linear-gradient(90deg,var(--success),var(--warning),var(--danger));border-radius:3px;"></div>
            </div>
            <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">${f.detail}</div>
        </div>`;
    }).join('');
}

function renderAIEarlyWarning() {
    const el = document.getElementById('aiEarlyResults');
    document.getElementById('aiEarlyCount').textContent = aiFindings.earlyWarnings.length + ' ta signal';
    if (!aiFindings.earlyWarnings.length) { el.innerHTML = '<div class="empty"><div class="e-icon">‚úÖ</div><p>Erta ogohlantirish signallari topilmadi</p></div>'; return; }
    
    el.innerHTML = aiFindings.earlyWarnings.map(w => {
        const urgPct = w.urgency;
        const urgCol = urgPct >= 50 ? 'var(--danger)' : urgPct >= 30 ? 'var(--warning)' : 'var(--accent)';
        return `<div style="padding:16px;background:var(--bg-input);border-radius:12px;border-left:4px solid ${urgCol};margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;">
                <div>
                    <div style="font-size:16px;font-weight:700;">üîÆ ${w.emp}</div>
                    <div style="font-size:12px;color:var(--text-muted);">${w.position} | ${w.department||'‚Äî'} | Hozirgi bal: ${w.currentScore}</div>
                </div>
                <div style="text-align:center;padding:8px 14px;background:var(--bg-card);border-radius:10px;">
                    <div style="font-size:9px;color:var(--text-muted);">SHOSHILINCHLIK</div>
                    <div class="mono" style="font-size:22px;font-weight:800;color:${urgCol};">${urgPct}%</div>
                </div>
            </div>
            <div style="height:4px;background:var(--bg-card);border-radius:2px;overflow:hidden;margin-bottom:12px;">
                <div style="height:100%;width:${urgPct}%;background:${urgCol};border-radius:2px;transition:width 1s ease;"></div>
            </div>
            ${w.signals.map(s => `<div style="padding:6px 10px;background:var(--bg-card);border-radius:6px;margin-bottom:4px;font-size:12px;display:flex;align-items:flex-start;gap:6px;">
                <span style="color:${urgCol};flex-shrink:0;">‚ö°</span><span style="color:var(--text-secondary);">${s}</span>
            </div>`).join('')}
        </div>`;
    }).join('');
}

function renderAIRules() {
    const el = document.getElementById('aiRulesResults');
    const violated = aiFindings.rulesResults.filter(r => r.violated);
    const passed = aiFindings.rulesResults.filter(r => !r.violated);
    document.getElementById('aiRulesCount').textContent = `${violated.length} buzildi / ${aiFindings.rulesResults.length} qoida`;
    
    // Buzilgan qoidalar
    let html = violated.length ? `<h4 style="font-size:13px;color:var(--danger);font-weight:700;margin-bottom:10px;">‚ùå Buzilgan qoidalar (${violated.length})</h4>` : '';
    violated.forEach(r => {
        html += `<div style="padding:12px;background:var(--bg-input);border-radius:10px;border-left:4px solid ${r.severity==='critical'?'var(--danger)':r.severity==='high'?'var(--warning)':'var(--purple)'};margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <div style="font-weight:700;font-size:13px;"><span class="mono" style="color:var(--danger);">${r.id}</span> ${r.name}</div>
                <div style="display:flex;gap:6px;"><span class="chip chip-${r.severity==='critical'?'red':'orange'}">${r.category}</span><span class="badge badge-${r.severity}">${r.severity.toUpperCase()}</span></div>
            </div>
            ${r.violations.map(v => `<div style="padding:4px 10px;font-size:12px;color:var(--text-secondary);">üë§ <strong>${v.empName}</strong>${v.detail ? ': '+v.detail : ''}</div>`).join('')}
        </div>`;
    });
    
    // O'tgan qoidalar (collapsed)
    html += `<h4 style="font-size:13px;color:var(--success);font-weight:700;margin:16px 0 10px;">‚úÖ Bajarilgan qoidalar (${passed.length})</h4>`;
    html += `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:6px;">`;
    passed.forEach(r => {
        html += `<div style="padding:8px 12px;background:var(--success-soft);border-radius:8px;font-size:12px;display:flex;align-items:center;gap:8px;">
            <span style="color:var(--success);">‚úì</span><span class="mono" style="color:var(--text-muted);font-size:10px;">${r.id}</span><span>${r.name}</span>
        </div>`;
    });
    html += '</div>';
    el.innerHTML = html;
}

function renderAIWatchList() {
    const el = document.getElementById('aiWatchResults');
    if (!aiFindings.watchList.length) { el.innerHTML = '<div class="empty"><div class="e-icon">‚úÖ</div><p>Kuzatuv ro\'yxati bo\'sh</p></div>'; return; }
    
    el.innerHTML = aiFindings.watchList.map(w => {
        const prCol = w.priority === 'ZUDLIK' ? 'var(--danger)' : w.priority === 'YUQORI' ? 'var(--warning)' : w.priority === "O'RTA" ? 'var(--purple)' : 'var(--success)';
        const topReasons = w.reasons.slice(0,5);
        return `<div style="display:flex;align-items:center;gap:14px;padding:14px;background:var(--bg-input);border-radius:12px;margin-bottom:8px;border-left:4px solid ${prCol};">
            <div style="width:36px;height:36px;border-radius:50%;background:${prCol};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px;color:var(--text-inverse);flex-shrink:0;">${w.rank}</div>
            <div style="flex:1;min-width:0;">
                <div style="font-weight:700;font-size:14px;">${w.name}</div>
                <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">${topReasons.join(' ‚Ä¢ ')}${w.reasons.length > 5 ? ` (+${w.reasons.length-5})` : ''}</div>
            </div>
            <div style="text-align:right;flex-shrink:0;">
                <div class="mono" style="font-size:20px;font-weight:800;color:${prCol};">${w.totalScore}</div>
                <span class="badge badge-${w.maxSeverity}" style="font-size:9px;">${w.priority}</span>
            </div>
        </div>`;
    }).join('');
}

function renderAIHeatMap() {
    const el = document.getElementById('aiHeatResults');
    
    // Bo'limlar bo'yicha risk xaritasi
    const deptMap = {};
    DB.employees.forEach(emp => {
        const dept = emp.department || 'Boshqa';
        if (!deptMap[dept]) deptMap[dept] = { name: dept, employees: [], totalRisk: 0, count: 0, maxRisk: 0 };
        deptMap[dept].employees.push(emp);
        deptMap[dept].totalRisk += (emp.riskScore || 0);
        deptMap[dept].count++;
        deptMap[dept].maxRisk = Math.max(deptMap[dept].maxRisk, emp.riskScore || 0);
    });
    
    const depts = Object.values(deptMap).sort((a,b) => (b.totalRisk/b.count) - (a.totalRisk/a.count));
    const globalMax = Math.max(1, ...depts.map(d => d.totalRisk / d.count));
    
    let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;">';
    depts.forEach(dept => {
        const avgRisk = dept.count > 0 ? Math.round(dept.totalRisk / dept.count) : 0;
        const heatPct = (avgRisk / Math.max(globalMax, 1)) * 100;
        const heatCol = avgRisk >= 50 ? 'var(--danger)' : avgRisk >= 25 ? 'var(--warning)' : avgRisk >= 10 ? 'var(--purple)' : 'var(--success)';
        
        html += `<div style="padding:16px;background:var(--bg-input);border-radius:12px;border-top:4px solid ${heatCol};position:relative;overflow:hidden;">
            <div style="position:absolute;bottom:0;left:0;right:0;height:${Math.max(5,heatPct)}%;background:${heatCol};opacity:0.06;"></div>
            <div style="position:relative;z-index:1;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;">
                    <div style="font-weight:700;font-size:14px;">${dept.name}</div>
                    <div class="mono" style="font-size:24px;font-weight:800;color:${heatCol};">${avgRisk}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">${dept.count} xodim | Max: ${dept.maxRisk}</div>
                ${dept.employees.sort((a,b)=>(b.riskScore||0)-(a.riskScore||0)).map(e => {
                    const w = Math.max(3, (e.riskScore||0));
                    return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;font-size:11px;">
                        <span style="color:var(--text-muted);width:80px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${e.fio.split(' ')[0]}</span>
                        <div style="flex:1;height:6px;background:var(--bg-card);border-radius:3px;overflow:hidden;"><div style="height:100%;width:${w}%;background:${riskColor(e.riskScore||0)};border-radius:3px;"></div></div>
                        <span class="mono" style="font-size:10px;width:24px;text-align:right;color:${riskColor(e.riskScore||0)};font-weight:600;">${e.riskScore||0}</span>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    });
    html += '</div>';
    el.innerHTML = html;
}

function renderAISoD() {
    const el = document.getElementById('aiSodResults');
    document.getElementById('aiSodCount').textContent = aiFindings.sodViolations.length + ' ta buzilish';
    if (!aiFindings.sodViolations.length) { el.innerHTML = '<div class="empty"><div class="e-icon">‚úÖ</div><p>Vazifalarni ajratish buzilishlari topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.sodViolations.map(f => renderFinding(f)).join('');
}

// ============================================================
// 14. TO'LIQ HISOBOT GENERATORI
// ============================================================
function generateFullReport() {
    const now = new Date();
    const all = [...aiFindings.cross, ...aiFindings.temporal, ...aiFindings.lifestyle, ...aiFindings.favoritism, ...aiFindings.chains, ...aiFindings.anomalies, ...aiFindings.sodViolations];
    const crit = all.filter(f => f.severity === 'critical');
    const high = all.filter(f => f.severity === 'high');
    const violated = aiFindings.rulesResults.filter(r => r.violated);
    
    let report = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  KORRUPSIYA VA MANFAATLAR TO'QNASHUVI
  AVTOMATLASHTIRILGAN TAHLIL HISOBOTI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Sana: ${now.toLocaleDateString('uz-UZ')} ${now.toLocaleTimeString('uz-UZ')}
Tizim: Bank Korrupsiya Monitoring AI Tahlil
Versiya: 2.0 ‚Äî 15 modulli chuqur tahlil

‚ïê‚ïê‚ïê UMUMIY STATISTIKA ‚ïê‚ïê‚ïê

Jami xodimlar:          ${DB.employees.length}
Jami topilmalar:        ${all.length}
  ‚Äî Kritik:             ${crit.length}
  ‚Äî Yuqori:             ${high.length}
Buzilgan qoidalar:      ${violated.length} / ${aiFindings.rulesResults.length}
Kuzatuv ro'yxatida:     ${aiFindings.watchList.length}
Erta ogohlantirishlar:  ${aiFindings.earlyWarnings.length}
Zanjirli aloqalar:      ${aiFindings.chains.length}
Statistik anomaliyalar: ${aiFindings.anomalies.length}
SoD buzilishlari:       ${aiFindings.sodViolations.length}
Tarmoq tugunlari:       ${aiFindings.network.nodes.length}

`;

    if (crit.length) {
        report += `‚ïê‚ïê‚ïê üî¥ KRITIK TOPILMALAR ‚ïê‚ïê‚ïê\n\n`;
        crit.forEach((f, i) => {
            report += `${i+1}. ${f.title}\n   Xodim: ${f.emp}\n   Tafsilot: ${f.detail}\n\n`;
        });
    }

    if (aiFindings.watchList.length) {
        report += `‚ïê‚ïê‚ïê üëÅÔ∏è KUZATUV RO'YXATI ‚ïê‚ïê‚ïê\n\n`;
        aiFindings.watchList.slice(0, 10).forEach(w => {
            report += `#${w.rank} ${w.name} ‚Äî Ball: ${w.totalScore} ‚Äî ${w.priority}\n   Sabablar: ${w.reasons.slice(0,3).join('; ')}\n\n`;
        });
    }

    if (violated.length) {
        report += `‚ïê‚ïê‚ïê ‚ùå BUZILGAN QOIDALAR ‚ïê‚ïê‚ïê\n\n`;
        violated.forEach(r => {
            report += `${r.id}: ${r.name} [${r.severity.toUpperCase()}]\n`;
            r.violations.forEach(v => { report += `   ‚Üí ${v.empName}${v.detail ? ': '+v.detail : ''}\n`; });
            report += '\n';
        });
    }

    if (aiFindings.earlyWarnings.length) {
        report += `‚ïê‚ïê‚ïê üîÆ ERTA OGOHLANTIRISHLAR ‚ïê‚ïê‚ïê\n\n`;
        aiFindings.earlyWarnings.forEach(w => {
            report += `${w.emp} (${w.position}) ‚Äî Shoshilinchlik: ${w.urgency}%\n`;
            w.signals.forEach(s => { report += `   ‚ö° ${s}\n`; });
            report += '\n';
        });
    }

    report += `‚ïê‚ïê‚ïê üí° TAVSIYALAR ‚ïê‚ïê‚ïê\n\n`;
    aiFindings.recs.forEach(r => {
        report += `${r.icon} [${r.action}] ${r.text}\n`;
    });

    report += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Hisobot yakunlandi: ${now.toLocaleString('uz-UZ')}
  Ishlab chiqaruvchi: Bank Korrupsiya Monitoring AI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;

    document.getElementById('aiReportBody').textContent = report;
}

function copyReport() {
    const text = document.getElementById('aiReportBody').textContent;
    navigator.clipboard.writeText(text).then(() => toast('Hisobot nusxa olindi!', 'success')).catch(() => toast('Nusxa olishda xato', 'danger'));
}

function norm(s) { return (s||'').toLowerCase().replace(/[''""]/g,'').replace(/\s+/g,' ').trim(); }
function renderAISummary() {
    const all = [...aiFindings.cross, ...aiFindings.temporal, ...aiFindings.lifestyle, ...aiFindings.favoritism, ...aiFindings.chains, ...aiFindings.anomalies, ...aiFindings.earlyWarnings, ...aiFindings.sodViolations];
    const crit = all.filter(f => f.severity === 'critical').length;
    const high = all.filter(f => f.severity === 'high').length;
    const med = all.filter(f => f.severity === 'medium').length;
    const total = all.length;
    const rulesViolated = aiFindings.rulesResults.filter(r => r.violated).length;

    document.getElementById('aiSummary').innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:20px;">
            <div style="padding:14px;background:var(--bg-input);border-radius:12px;text-align:center;border-left:4px solid var(--danger);">
                <div style="font-size:28px;font-weight:900;font-family:'JetBrains Mono';color:var(--danger);">${crit}</div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Kritik</div>
            </div>
            <div style="padding:14px;background:var(--bg-input);border-radius:12px;text-align:center;border-left:4px solid var(--warning);">
                <div style="font-size:28px;font-weight:900;font-family:'JetBrains Mono';color:var(--warning);">${high}</div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Yuqori</div>
            </div>
            <div style="padding:14px;background:var(--bg-input);border-radius:12px;text-align:center;border-left:4px solid var(--accent);">
                <div style="font-size:28px;font-weight:900;font-family:'JetBrains Mono';color:var(--accent);">${total}</div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Jami topilma</div>
            </div>
            <div style="padding:14px;background:var(--bg-input);border-radius:12px;text-align:center;border-left:4px solid var(--danger);">
                <div style="font-size:28px;font-weight:900;font-family:'JetBrains Mono';color:var(--danger);">${rulesViolated}</div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Qoida buzildi</div>
            </div>
            <div style="padding:14px;background:var(--bg-input);border-radius:12px;text-align:center;border-left:4px solid var(--warning);">
                <div style="font-size:28px;font-weight:900;font-family:'JetBrains Mono';color:var(--warning);">${aiFindings.earlyWarnings.length}</div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Erta signal</div>
            </div>
            <div style="padding:14px;background:var(--bg-input);border-radius:12px;text-align:center;border-left:4px solid var(--purple);">
                <div style="font-size:28px;font-weight:900;font-family:'JetBrains Mono';color:var(--purple);">${aiFindings.watchList.length}</div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">Kuzatuvda</div>
            </div>
        </div>
        ${crit > 0 ? `<div class="alert alert-danger"><span class="alert-icon">üö®</span><div><strong>${crit} ta KRITIK topilma</strong> ‚Äî ${rulesViolated} qoida buzildi ‚Äî ${aiFindings.watchList.filter(w=>w.priority==='ZUDLIK').length} ta xodim ZUDLIK kuzatuvda!</div></div>` : ''}
        ${crit === 0 && high === 0 ? `<div class="alert alert-success"><span class="alert-icon">‚úÖ</span><div>Jiddiy xavflar aniqlanmadi. Monitoring davom ettirilsin.</div></div>` : ''}
    `;
}

function renderAICross() {
    const el = document.getElementById('aiCrossResults');
    document.getElementById('aiCrossCount').textContent = aiFindings.cross.length + ' ta aloqa';
    if (!aiFindings.cross.length) { el.innerHTML = '<div class="empty"><div class="e-icon">‚úÖ</div><p>Yashirin kross-aloqalar topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.cross.map(f => renderFinding(f)).join('');
}

function renderAITemporal() {
    const el = document.getElementById('aiTemporalResults');
    document.getElementById('aiTemporalCount').textContent = aiFindings.temporal.length + ' ta pattern';
    if (!aiFindings.temporal.length) { el.innerHTML = '<div class="empty"><div class="e-icon">‚úÖ</div><p>Shubhali vaqt patternlari topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.temporal.map(f => renderFinding(f)).join('');
}

function renderAILifestyle() {
    const el = document.getElementById('aiLifestyleResults');
    document.getElementById('aiLifestyleCount').textContent = aiFindings.lifestyle.length + ' ta anomaliya';
    if (!aiFindings.lifestyle.length) { el.innerHTML = '<div class="empty"><div class="e-icon">‚úÖ</div><p>Daromad nomutanosibligi topilmadi</p></div>'; return; }

    el.innerHTML = aiFindings.lifestyle.map(f => {
        let extra = '';
        if (f.data) {
            const d = f.data;
            extra = `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin-top:10px;">
                ${d.salary ? `<div style="padding:8px;background:var(--bg-card);border-radius:8px;text-align:center;"><div class="mono" style="font-size:14px;font-weight:700;color:var(--success);">${fmt(d.salary)}</div><div style="font-size:9px;color:var(--text-muted);">Yillik maosh</div></div>` : ''}
                ${d.property ? `<div style="padding:8px;background:var(--bg-card);border-radius:8px;text-align:center;"><div class="mono" style="font-size:14px;font-weight:700;color:var(--warning);">${fmt(d.property)}</div><div style="font-size:9px;color:var(--text-muted);">Mol-mulk</div></div>` : ''}
                ${d.travel ? `<div style="padding:8px;background:var(--bg-card);border-radius:8px;text-align:center;"><div class="mono" style="font-size:14px;font-weight:700;color:var(--purple);">${fmt(d.travel)}</div><div style="font-size:9px;color:var(--text-muted);">Safarlar</div></div>` : ''}
                ${d.balance ? `<div style="padding:8px;background:var(--bg-card);border-radius:8px;text-align:center;"><div class="mono" style="font-size:14px;font-weight:700;color:var(--danger);">${fmt(d.balance)}</div><div style="font-size:9px;color:var(--text-muted);">Balans</div></div>` : ''}
            </div>`;
        }
        return renderFinding(f) + extra;
    }).join('');
}

function renderAIFavoritism() {
    const el = document.getElementById('aiFavResults');
    document.getElementById('aiFavCount').textContent = aiFindings.favoritism.length + ' ta pattern';
    if (!aiFindings.favoritism.length) { el.innerHTML = '<div class="empty"><div class="e-icon">‚úÖ</div><p>Xarid favoritizmi topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.favoritism.map(f => renderFinding(f)).join('');
}

function renderFinding(f) {
    const colors = { critical: 'var(--danger)', high: 'var(--warning)', medium: 'var(--purple)' };
    const icons = { critical: 'üî¥', high: 'üü†', medium: 'üü°' };
    const col = colors[f.severity] || 'var(--accent)';
    const ico = icons[f.severity] || 'üîµ';
    return `<div style="padding:14px;background:var(--bg-input);border-radius:10px;border-left:4px solid ${col};margin-bottom:10px;animation:sectionIn 0.3s ease;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;">
            <div style="font-size:14px;font-weight:700;">${ico} ${f.title}</div>
            <span class="badge badge-${f.severity}" style="flex-shrink:0;margin-left:8px;">${f.severity.toUpperCase()}</span>
        </div>
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;">üë§ <strong>${f.emp}</strong></div>
        <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">${f.detail}</div>
    </div>`;
}

// ============================================================
// NETWORK CANVAS ‚Äî Interactive graph
// ============================================================
function renderAINetwork() {
    const canvas = document.getElementById('networkCanvas');
    const ctx = canvas.getContext('2d');
    const W = canvas.width = canvas.offsetWidth * 1.5;
    const H = canvas.height = 750;

    const { nodes, edges } = aiFindings.network;
    if (!nodes.length) return;

    // Force-directed layout (simple)
    const positions = [];
    const cx = W / 2, cy = H / 2;
    nodes.forEach((n, i) => {
        const angle = (i / nodes.length) * Math.PI * 2;
        const radius = n.type === 'employee' ? 120 : n.type === 'relative' ? 250 : 350;
        positions.push({
            x: cx + Math.cos(angle) * radius + (Math.random() - 0.5) * 80,
            y: cy + Math.sin(angle) * radius + (Math.random() - 0.5) * 80
        });
    });

    // Simple force simulation
    for (let iter = 0; iter < 100; iter++) {
        // Repulsion
        for (let i = 0; i < nodes.length; i++) {
            for (let j = i + 1; j < nodes.length; j++) {
                let dx = positions[j].x - positions[i].x;
                let dy = positions[j].y - positions[i].y;
                let dist = Math.sqrt(dx * dx + dy * dy) || 1;
                if (dist < 120) {
                    let force = (120 - dist) * 0.3;
                    positions[i].x -= (dx / dist) * force;
                    positions[i].y -= (dy / dist) * force;
                    positions[j].x += (dx / dist) * force;
                    positions[j].y += (dy / dist) * force;
                }
            }
        }
        // Attraction (edges)
        edges.forEach(e => {
            const fi = nodes.findIndex(n => n.id === e.from);
            const ti = nodes.findIndex(n => n.id === e.to);
            if (fi < 0 || ti < 0) return;
            let dx = positions[ti].x - positions[fi].x;
            let dy = positions[ti].y - positions[fi].y;
            let dist = Math.sqrt(dx * dx + dy * dy) || 1;
            if (dist > 180) {
                let force = (dist - 180) * 0.02;
                positions[fi].x += (dx / dist) * force;
                positions[fi].y += (dy / dist) * force;
                positions[ti].x -= (dx / dist) * force;
                positions[ti].y -= (dy / dist) * force;
            }
        });
        // Center gravity
        positions.forEach(p => {
            p.x += (cx - p.x) * 0.01;
            p.y += (cy - p.y) * 0.01;
            p.x = Math.max(50, Math.min(W - 50, p.x));
            p.y = Math.max(50, Math.min(H - 50, p.y));
        });
    }

    // Draw
    ctx.clearRect(0, 0, W, H);
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

    // Edges
    edges.forEach(e => {
        const fi = nodes.findIndex(n => n.id === e.from);
        const ti = nodes.findIndex(n => n.id === e.to);
        if (fi < 0 || ti < 0) return;
        ctx.beginPath();
        ctx.moveTo(positions[fi].x, positions[fi].y);
        ctx.lineTo(positions[ti].x, positions[ti].y);
        ctx.strokeStyle = e.suspicious
            ? (isDark ? 'rgba(255,68,102,0.6)' : 'rgba(224,48,80,0.5)')
            : (isDark ? 'rgba(56,132,255,0.15)' : 'rgba(42,106,223,0.12)');
        ctx.lineWidth = e.suspicious ? 2.5 : 1;
        if (e.suspicious) ctx.setLineDash([6, 4]);
        else ctx.setLineDash([]);
        ctx.stroke();

        // Edge label
        const mx = (positions[fi].x + positions[ti].x) / 2;
        const my = (positions[fi].y + positions[ti].y) / 2;
        if (e.label) {
            ctx.font = '10px Source Sans 3';
            ctx.fillStyle = isDark ? 'rgba(139,156,199,0.6)' : 'rgba(90,104,136,0.6)';
            ctx.textAlign = 'center';
            ctx.fillText(e.label, mx, my - 4);
        }
    });

    ctx.setLineDash([]);

    // Nodes
    const typeColors = {
        employee: isDark ? '#3884ff' : '#2a6adf',
        relative: isDark ? '#22dd88' : '#18a060',
        organization: isDark ? '#ffaa22' : '#d08800',
    };
    const typeRadius = { employee: 20, relative: 14, organization: 16 };

    nodes.forEach((n, i) => {
        const p = positions[i];
        const r = typeRadius[n.type] || 12;
        const color = typeColors[n.type] || (isDark ? '#666' : '#999');

        // Glow for risky
        if (n.risk >= 50) {
            ctx.beginPath();
            ctx.arc(p.x, p.y, r + 8, 0, Math.PI * 2);
            ctx.fillStyle = isDark ? 'rgba(255,68,102,0.15)' : 'rgba(224,48,80,0.1)';
            ctx.fill();
        }

        ctx.beginPath();
        ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();

        if (n.risk >= 50) {
            ctx.strokeStyle = isDark ? '#ff4466' : '#e03050';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // Label
        ctx.font = `${n.type === 'employee' ? '600 12' : '11'}px 'Source Sans 3'`;
        ctx.fillStyle = isDark ? '#eaf0ff' : '#1a2340';
        ctx.textAlign = 'center';
        ctx.fillText(n.label, p.x, p.y + r + 14);
    });
}

function renderAITrends() {
    const el = document.getElementById('aiTrendResults');
    if (!aiFindings.trends.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üìà</div><p>Trend ma\'lumotlari yo\'q</p></div>'; return; }

    el.innerHTML = aiFindings.trends.map(t => {
        const dirIcon = t.direction === 'up' ? 'üìà' : t.direction === 'down' ? 'üìâ' : t.direction === 'new' ? 'üÜï' : '‚û°Ô∏è';
        const dirColor = t.direction === 'up' ? 'var(--danger)' : t.direction === 'down' ? 'var(--success)' : 'var(--text-muted)';
        const dirText = t.direction === 'up' ? `+${t.diff} ‚ñ≤` : t.direction === 'down' ? `${t.diff} ‚ñº` : t.direction === 'new' ? 'Yangi' : '0';

        return `<div style="display:flex;align-items:center;gap:14px;padding:12px;background:var(--bg-input);border-radius:10px;margin-bottom:8px;border-left:3px solid ${riskColor(t.current)};">
            <div style="width:44px;height:44px;border-radius:50%;background:${riskColor(t.current)};display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:var(--text-inverse);flex-shrink:0;">${t.current}</div>
            <div style="flex:1;min-width:0;">
                <div style="font-weight:700;font-size:14px;">${t.emp}</div>
                <div style="font-size:11px;color:var(--text-muted);">${t.position} | ${t.count} ta hisoblash</div>
            </div>
            <div style="text-align:right;flex-shrink:0;">
                <div style="font-size:16px;">${dirIcon}</div>
                <div class="mono" style="font-size:13px;font-weight:700;color:${dirColor};">${dirText}</div>
            </div>
            <div style="text-align:center;flex-shrink:0;padding:6px 12px;background:var(--bg-card);border-radius:8px;">
                <div style="font-size:9px;color:var(--text-muted);">BASHORAT</div>
                <div class="mono" style="font-size:16px;font-weight:800;color:${riskColor(t.predicted)};">${t.predicted}</div>
            </div>
            <span class="badge badge-${t.level}" style="flex-shrink:0;">${riskLabel(t.level)}</span>
        </div>`;
    }).join('');
}

function renderAIRecs() {
    const el = document.getElementById('aiRecs');
    if (!aiFindings.recs.length) return;

    el.innerHTML = aiFindings.recs.map(r => {
        const bg = r.priority === 'urgent' ? 'var(--danger-soft)' : r.priority === 'high' ? 'var(--warning-soft)' : r.priority === 'medium' ? 'var(--purple-soft)' : r.priority === 'low' ? 'var(--success-soft)' : 'var(--accent-soft)';
        const border = r.priority === 'urgent' ? 'var(--danger)' : r.priority === 'high' ? 'var(--warning)' : r.priority === 'medium' ? 'var(--purple)' : r.priority === 'low' ? 'var(--success)' : 'var(--accent)';
        return `<div style="padding:14px;background:${bg};border-radius:10px;border-left:4px solid ${border};margin-bottom:10px;display:flex;align-items:flex-start;gap:10px;">
            <span style="font-size:18px;flex-shrink:0;">${r.icon}</span>
            <div style="flex:1;font-size:13px;line-height:1.6;">${r.text}</div>
            <span class="chip chip-blue" style="flex-shrink:0;font-size:10px;">${r.action}</span>
        </div>`;
    }).join('');
}


// ============================================================
// V3: AI ANALYSIS ‚Äî 14 NEW MODULES
// ============================================================

// --- V3-1: GIFT-PROCUREMENT CORRELATION ---
function analysisGiftCorrelation() {
    aiFindings.giftCorr = [];
    DB.gifts.forEach(g => {
        // Check if any procurement from same vendor within 60 days
        DB.procurements.forEach(p => {
            if (norm(g.from).length > 2 && fuzzyMatch(norm(g.from), norm(p.org))) {
                const gDate = new Date(g.date), pDate = new Date(p.date);
                const daysDiff = Math.abs((gDate - pDate) / 86400000);
                if (daysDiff <= 60) {
                    aiFindings.giftCorr.push({
                        type: 'gift_procurement', severity: daysDiff <= 7 ? 'critical' : daysDiff <= 30 ? 'high' : 'medium',
                        emp: gn(g.empId), empId: g.empId,
                        detail: `Sovg'a (${fmt(g.value)} so'm) va xarid (${fmt(p.amount)} so'm) ‚Äî ${g.from} ‚Äî orasida ${Math.round(daysDiff)} kun`,
                        giftValue: g.value, procAmount: p.amount, daysDiff: Math.round(daysDiff)
                    });
                }
            }
        });
        // Gov official gifts always flagged
        if (g.relation === 'gov' && g.value > 50000000) {
            aiFindings.giftCorr.push({
                type: 'gov_gift', severity: 'critical', emp: gn(g.empId), empId: g.empId,
                detail: `Davlat xodimiga/dan ${fmt(g.value)} so'm qiymatli sovg'a ‚Äî ${g.from}`, giftValue: g.value
            });
        }
        // Cumulative gifts from single source
        const sameSource = DB.gifts.filter(g2 => g2.empId === g.empId && norm(g2.from) === norm(g.from));
        const totalFromSource = sameSource.reduce((s, g2) => s + g2.value, 0);
        if (sameSource.length >= 3 && totalFromSource > 200000000) {
            aiFindings.giftCorr.push({
                type: 'cumulative_gift', severity: 'high', emp: gn(g.empId), empId: g.empId,
                detail: `${g.from} dan jami ${sameSource.length} ta sovg'a, umumiy ${fmt(totalFromSource)} so'm`
            });
        }
    });
    aiFindings.giftCorr = removeDuplicateFindings(aiFindings.giftCorr);
}

// --- V3-2: PEP SCREENING ---
function analysisPepScreening() {
    aiFindings.pepFindings = [];
    // Simulate PEP database check ‚Äî in real system this would be API call
    const pepKeywords = ['deputat', 'hokim', 'vazir', 'senator', 'prokuror', 'sudya', 'governor', 'minister', 'mayor', 'president', 'director general', 'bosh direktor', 'raisi'];
    const sanctionKeywords = ['sanksiya', 'qora ro\'yxat', 'taqiqlangan'];
    
    DB.employees.forEach(e => {
        // Check employee position for PEP indicators
        const posLow = (e.position || '').toLowerCase();
        const hasPepTitle = pepKeywords.some(k => posLow.includes(k));
        
        // Check relatives for PEP connections
        const rels = DB.relatives.filter(r => r.empId === e.id);
        rels.forEach(r => {
            const wpLow = (r.workplace || '').toLowerCase();
            const hasPepRel = pepKeywords.some(k => wpLow.includes(k));
            if (hasPepRel) {
                const pepScore = wpLow.includes('vazir') || wpLow.includes('minister') ? 47 :
                                 wpLow.includes('hokim') || wpLow.includes('governor') ? 42 :
                                 wpLow.includes('deputat') || wpLow.includes('senator') ? 38 :
                                 wpLow.includes('prokuror') || wpLow.includes('sudya') ? 35 : 25;
                aiFindings.pepFindings.push({
                    type: 'pep_relative', severity: pepScore >= 40 ? 'critical' : 'high',
                    emp: e.fio, empId: e.id, pepScore,
                    detail: `Qarindosh ${r.fio} (${r.degree}) ‚Äî ${r.workplace} ‚Äî PEP ball: ${pepScore}`,
                    pepName: r.fio, pepRole: r.workplace
                });
            }
        });
        
        // Check declarations for PEP-related entities
        const decls = DB.declarations.filter(d => d.empId === e.id);
        decls.forEach(d => {
            if (d.shareDetail && pepKeywords.some(k => d.shareDetail.toLowerCase().includes(k))) {
                aiFindings.pepFindings.push({
                    type: 'pep_share', severity: 'high', emp: e.fio, empId: e.id, pepScore: 30,
                    detail: `PEP bilan bog'liq ustav ulushi: ${d.shareDetail}`
                });
            }
        });
    });
    aiFindings.pepFindings = removeDuplicateFindings(aiFindings.pepFindings);
}

// --- V3-3: BENFORD LAW ---
function analysisBenfordLaw() {
    aiFindings.benford = [];
    const expectedBenford = [0, 0.301, 0.176, 0.125, 0.097, 0.079, 0.067, 0.058, 0.051, 0.046];
    
    function getBenfordDistribution(values) {
        const counts = new Array(10).fill(0);
        let total = 0;
        values.forEach(v => {
            if (v > 0) {
                const firstDigit = parseInt(String(v).replace(/[^0-9]/g, '')[0]);
                if (firstDigit >= 1 && firstDigit <= 9) { counts[firstDigit]++; total++; }
            }
        });
        if (total < 10) return null; // Need at least 10 values
        const observed = counts.map(c => c / total);
        let mad = 0;
        for (let d = 1; d <= 9; d++) mad += Math.abs(observed[d] - expectedBenford[d]);
        mad /= 9;
        return { observed, counts, total, mad };
    }
    
    // Analyze procurement amounts per employee
    DB.employees.forEach(e => {
        const procAmts = DB.procurements.filter(p => p.empId === e.id).map(p => p.amount);
        const contAmts = DB.contracts.filter(c => c.empId === e.id).map(c => c.amount);
        const allAmts = [...procAmts, ...contAmts];
        
        if (allAmts.length >= 5) {
            const result = getBenfordDistribution(allAmts);
            if (result && result.mad > 0.015) {
                aiFindings.benford.push({
                    type: 'benford_violation', severity: result.mad > 0.05 ? 'critical' : result.mad > 0.03 ? 'high' : 'medium',
                    emp: e.fio, empId: e.id,
                    detail: `Benford MAD = ${result.mad.toFixed(4)} (${allAmts.length} ta tranzaksiya) ‚Äî ${result.mad > 0.03 ? 'jiddiy manipulyatsiya belgilari' : 'shubhali taqsimot'}`,
                    mad: result.mad, observed: result.observed, sampleSize: result.total
                });
            }
        }
    });
    
    // Global Benford check on all procurements
    const allProcAmts = DB.procurements.map(p => p.amount);
    if (allProcAmts.length >= 10) {
        const result = getBenfordDistribution(allProcAmts);
        if (result && result.mad > 0.02) {
            aiFindings.benford.push({
                type: 'benford_global', severity: result.mad > 0.04 ? 'critical' : 'high',
                emp: 'TIZIM DARAJASI', empId: 0,
                detail: `Barcha xaridlar bo'yicha Benford MAD = ${result.mad.toFixed(4)} ‚Äî tizim darajasida manipulyatsiya`,
                mad: result.mad, observed: result.observed, sampleSize: result.total
            });
        }
    }
}

// --- V3-4: SPLIT CONTRACT DETECTION ---
function analysisSplitContract() {
    aiFindings.splitContracts = [];
    const thresholds = [100000000, 500000000, 1000000000, 5000000000]; // 100M, 500M, 1B, 5B
    
    // Group contracts by vendor and employee within 90-day windows
    const contractsByVendor = {};
    [...DB.contracts, ...DB.procurements.map(p => ({...p, vendor: p.org, number: '-', method: 'direct', amendments: 0, amendAmount: 0}))].forEach(c => {
        const key = norm(c.vendor || c.org || '') + '|' + c.empId;
        if (!contractsByVendor[key]) contractsByVendor[key] = [];
        contractsByVendor[key].push(c);
    });
    
    Object.entries(contractsByVendor).forEach(([key, contracts]) => {
        if (contracts.length < 2) return;
        const vendorName = key.split('|')[0];
        
        contracts.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        // Check 90-day windows
        for (let i = 0; i < contracts.length; i++) {
            const window = [contracts[i]];
            for (let j = i + 1; j < contracts.length; j++) {
                const daysDiff = (new Date(contracts[j].date) - new Date(contracts[i].date)) / 86400000;
                if (daysDiff <= 90) window.push(contracts[j]);
            }
            
            if (window.length >= 2) {
                const totalAmount = window.reduce((s, c) => s + (c.amount || 0), 0);
                const maxSingle = Math.max(...window.map(c => c.amount || 0));
                
                thresholds.forEach(threshold => {
                    // Each contract is below threshold, but total exceeds it
                    if (totalAmount > threshold && maxSingle < threshold && maxSingle >= threshold * 0.5) {
                        const empId = contracts[0].empId;
                        aiFindings.splitContracts.push({
                            type: 'split_contract', severity: totalAmount > threshold * 2 ? 'critical' : 'high',
                            emp: gn(empId), empId: empId,
                            detail: `${window.length} ta kontrakt (${vendorName}) ‚Äî har biri ${fmt(threshold)} dan past, jami ${fmt(totalAmount)} ‚Äî split shubhasi`,
                            contracts: window.length, totalAmount, threshold,
                            vendor: vendorName
                        });
                    }
                });
            }
        }
    });
    aiFindings.splitContracts = removeDuplicateFindings(aiFindings.splitContracts);
}

// --- V3-5: INSIDER LENDING DETECTION ---
function analysisInsiderLending() {
    aiFindings.insiderLending = [];
    
    DB.employees.forEach(e => {
        const credits = DB.credits.filter(c => c.empId === e.id);
        const rels = DB.relatives.filter(r => r.empId === e.id);
        
        // Self-issued credit ‚Äî already tracked but add deeper analysis
        credits.forEach(c => {
            if (creditRiskCheck(c).isRisk) {
                aiFindings.insiderLending.push({
                    type: 'self_issued', severity: 'critical', emp: e.fio, empId: e.id,
                    detail: `Tekshirgan bankdan kredit: ${fmt(c.amount)} so'm (${c.type}) ‚Äî ${c.bank} ‚Äî Tekshiruv: ${c.inspOrg} [${fd(c.inspDate)}]`,
                    amount: c.amount
                });
            }
            
            // Check if credit bank matches any relative's workplace
            rels.forEach(r => {
                if (r.inBanking === 'yes' && c.bank && r.workplace && fuzzyMatch(norm(c.bank), norm(r.workplace))) {
                    aiFindings.insiderLending.push({
                        type: 'relative_bank_credit', severity: 'high', emp: e.fio, empId: e.id,
                        detail: `Kredit (${fmt(c.amount)}) ${c.bank} dan ‚Äî qarindosh ${r.fio} shu bankda ishlaydi!`,
                        amount: c.amount, relative: r.fio
                    });
                }
            });
            
            // Check for evergreening ‚Äî multiple credits in short period
            const recentCredits = credits.filter(c2 => {
                const d1 = new Date(c.date), d2 = new Date(c2.date);
                return c2.id !== c.id && Math.abs((d1 - d2) / 86400000) < 90;
            });
            if (recentCredits.length >= 2) {
                const totalAmt = credits.reduce((s, c2) => s + c2.amount, 0);
                aiFindings.insiderLending.push({
                    type: 'evergreening', severity: 'high', emp: e.fio, empId: e.id,
                    detail: `90 kun ichida ${recentCredits.length + 1} ta kredit ‚Äî jami ${fmt(totalAmt)} ‚Äî evergreening shubhasi`
                });
            }
        });
        
        // Credit amount vs salary ratio
        const totalCredit = credits.reduce((s, c) => s + c.amount, 0);
        if (totalCredit > e.salary * 60) { // 5 years salary
            aiFindings.insiderLending.push({
                type: 'excessive_credit', severity: 'high', emp: e.fio, empId: e.id,
                detail: `Jami kredit ${fmt(totalCredit)} ‚Äî yillik maoshdan ${(totalCredit / (e.salary * 12)).toFixed(1)}x ortiq`
            });
        }
    });
    aiFindings.insiderLending = removeDuplicateFindings(aiFindings.insiderLending);
}

// --- V3-6: UEBA (User Entity Behavior Analytics) ---
function analysisUEBA() {
    aiFindings.ueba = [];
    
    // Analyze login logs (simulated from demo data)
    DB.loginLogs.forEach(log => {
        const hour = new Date(log.timestamp).getHours();
        let riskPoints = 0;
        const flags = [];
        
        if (hour >= 2 && hour < 6) { riskPoints += 25; flags.push('Tunda kirish (02:00-06:00)'); }
        else if (hour >= 22 || hour < 2) { riskPoints += 15; flags.push('Kechki kirish (22:00-02:00)'); }
        if (log.failedAttempts >= 5) { riskPoints += 20; flags.push(log.failedAttempts + ' ta noto\'g\'ri urinish'); }
        if (log.newLocation) { riskPoints += 12; flags.push('Yangi joylashuv: ' + log.location); }
        if (log.bulkAccess && log.recordsAccessed > 100) { riskPoints += 20; flags.push(log.recordsAccessed + ' ta yozuv ko\'rilgan'); }
        if (log.accessedRelativeAccount) { riskPoints += 30; flags.push('Qarindosh hisobiga kirish!'); }
        
        if (riskPoints >= 15) {
            aiFindings.ueba.push({
                type: 'ueba_anomaly', severity: riskPoints >= 40 ? 'critical' : riskPoints >= 25 ? 'high' : 'medium',
                emp: gn(log.empId), empId: log.empId,
                detail: flags.join(' | ') + ` ‚Äî Risk ball: ${riskPoints}`,
                riskPoints, timestamp: log.timestamp
            });
        }
    });
    
    // Vacation analysis from HR data
    DB.employees.forEach(e => {
        const startDate = new Date(e.startDate);
        const now = new Date();
        const monthsWorked = (now - startDate) / (30.44 * 86400000);
        
        // Check if employee has been working > 12 months without documented vacation
        if (monthsWorked > 12 && !e.lastVacation) {
            aiFindings.ueba.push({
                type: 'no_vacation', severity: 'medium', emp: e.fio, empId: e.id,
                detail: `${Math.round(monthsWorked)} oy ishlamoqda ‚Äî majburiy ta'til olmaganligi qayd etilmagan (FDIC talabi: yiliga 2 hafta)`
            });
        }
    });
}

// --- V3-7: HR ANALYTICS ---
function analysisHRAnalytics() {
    aiFindings.hrAnalytics = [];
    
    // Department concentration analysis
    const deptCounts = {};
    DB.employees.forEach(e => {
        const d = e.department || 'Noma\'lum';
        if (!deptCounts[d]) deptCounts[d] = { count: 0, employees: [], totalTenure: 0 };
        deptCounts[d].count++;
        deptCounts[d].employees.push(e);
        const tenure = (new Date() - new Date(e.startDate)) / (365.25 * 86400000);
        deptCounts[d].totalTenure += tenure;
    });
    
    Object.entries(deptCounts).forEach(([dept, data]) => {
        const avgTenure = data.totalTenure / data.count;
        
        // Long tenure in high-risk role without rotation
        data.employees.forEach(e => {
            const tenure = (new Date() - new Date(e.startDate)) / (365.25 * 86400000);
            const isHighRisk = (e.position || '').toLowerCase().match(/inspeksiya|monitoring|nazorat|naqd pul|buxgalter|audit|kassa|xarid|tender|kredit|valyuta|qimmatlik|xavfsizlik/);
            if (tenure > 3 && isHighRisk) {
                aiFindings.hrAnalytics.push({
                    type: 'long_tenure_risk', severity: tenure > 5 ? 'high' : 'medium',
                    emp: e.fio, empId: e.id,
                    detail: `Yuqori xavfli lavozimda ${tenure.toFixed(1)} yil ‚Äî rotatsiya tavsiya etiladi (>3 yil)`,
                    tenure: tenure.toFixed(1), department: dept
                });
            }
        });
    });
}

// --- V3-8: BENEFICIAL OWNERSHIP ---
function analysisBeneficialOwnership() {
    aiFindings.benefOwnership = [];
    
    // Cross-reference declarations (share ownership) with procurement vendors
    DB.employees.forEach(e => {
        const decls = DB.declarations.filter(d => d.empId === e.id);
        const rels = DB.relatives.filter(r => r.empId === e.id);
        
        decls.forEach(d => {
            if (!d.shareDetail) return;
            const shareOrg = norm(d.shareDetail);
            
            // Check if this org appears in any procurement
            DB.procurements.forEach(p => {
                if (fuzzyMatch(shareOrg, norm(p.org))) {
                    aiFindings.benefOwnership.push({
                        type: 'self_vendor', severity: 'critical', emp: e.fio, empId: e.id,
                        detail: `O'zi ulush egasi (${d.shareDetail}) bo'lgan tashkilotdan xarid: ${p.org} ‚Äî ${fmt(p.amount)} so'm`
                    });
                }
            });
            
            // Check contracts
            DB.contracts.forEach(c => {
                if (fuzzyMatch(shareOrg, norm(c.vendor))) {
                    aiFindings.benefOwnership.push({
                        type: 'self_vendor_contract', severity: 'critical', emp: e.fio, empId: e.id,
                        detail: `Ulush egasi bo'lgan tashkilot bilan kontrakt: ${c.vendor} ‚Äî ${fmt(c.amount)} so'm`
                    });
                }
            });
        });
        
        // Check relatives' company shares
        rels.forEach(r => {
            if (!r.companyShare) return;
            const relOrg = norm(r.companyShare);
            
            DB.procurements.forEach(p => {
                if (fuzzyMatch(relOrg, norm(p.org))) {
                    aiFindings.benefOwnership.push({
                        type: 'relative_vendor', severity: 'high', emp: e.fio, empId: e.id,
                        detail: `Qarindosh (${r.fio}) ulush egasi (${r.companyShare}) ‚Äî xarid: ${p.org} ‚Äî ${fmt(p.amount)}`
                    });
                }
            });
        });
    });
    aiFindings.benefOwnership = removeDuplicateFindings(aiFindings.benefOwnership);
}

// --- V3-9: SIDE BUSINESS DETECTION ---
function analysisSideBusiness() {
    aiFindings.sideBusiness = [];
    
    DB.sideBusinesses.forEach(sb => {
        let score = 0;
        const flags = [];
        
        if (sb.sameIndustry) { score += 30; flags.push('Bank sohasi bilan bir xil soha'); }
        if (sb.isVendor) { score += 40; flags.push('Bankka vendor/yetkazuvchi'); }
        if (sb.undeclared) { score += 25; flags.push('Deklaratsiya qilinmagan!'); }
        if (sb.familyInvolved) { score += 15; flags.push('Oila a\'zolari ishtirokida'); }
        
        aiFindings.sideBusiness.push({
            type: 'side_business', severity: score >= 50 ? 'critical' : score >= 30 ? 'high' : 'medium',
            emp: gn(sb.empId), empId: sb.empId,
            detail: `${sb.companyName} ‚Äî ${sb.role} ‚Äî Ball: ${score}/100 ‚Äî ${flags.join(', ')}`,
            score, flags
        });
    });
    
    // Also check declarations for undeclared shares
    DB.employees.forEach(e => {
        const hasDecl = DB.declarations.some(d => d.empId === e.id && d.share !== 'no');
        const hasShare = DB.relatives.some(r => r.empId === e.id && r.companyShare);
        if (hasShare && !hasDecl) {
            aiFindings.sideBusiness.push({
                type: 'undeclared_share', severity: 'high', emp: e.fio, empId: e.id,
                detail: `Qarindoshning kompaniya ulushi mavjud, lekin xodim deklaratsiyada "Yo'q" deb belgilagan`
            });
        }
    });
}

// --- V3-10: ADVERSE MEDIA / OSINT ---
function analysisAdverseMedia() {
    aiFindings.adverseMedia = [];
    
    DB.adverseMedia.forEach(am => {
        const tierPoints = { tier1: 25, tier2: 15, tier3: 8 };
        const points = tierPoints[am.tier] || 10;
        
        aiFindings.adverseMedia.push({
            type: 'adverse_media', severity: points >= 20 ? 'high' : 'medium',
            emp: gn(am.empId), empId: am.empId,
            detail: `${am.source} (${am.tier}) ‚Äî ${am.headline} ‚Äî ${fd(am.date)}`,
            points, source: am.source, category: am.category
        });
    });
}

// --- V3-11: TRAINING COMPLIANCE ---
function analysisTrainingCompliance() {
    aiFindings.trainingIssues = [];
    
    const requiredTrainings = [
        { name: 'AML/CFT asosiy kurs', frequency: 'annual', daysOverdue: 365, severity: 'high' },
        { name: 'Antikorrupsiya seminari', frequency: 'annual', daysOverdue: 365, severity: 'high' },
        { name: 'Etika kodeksi', frequency: 'annual', daysOverdue: 365, severity: 'medium' },
        { name: 'Ma\'lumotlar xavfsizligi', frequency: 'semi-annual', daysOverdue: 180, severity: 'medium' }
    ];
    
    DB.employees.forEach(e => {
        const empTrainings = DB.training.filter(t => t.empId === e.id);
        
        requiredTrainings.forEach(req => {
            const completed = empTrainings.find(t => norm(t.name).includes(norm(req.name).substring(0, 8)));
            if (!completed) {
                aiFindings.trainingIssues.push({
                    type: 'missing_training', severity: req.severity, emp: e.fio, empId: e.id,
                    detail: `"${req.name}" treningi o'tilmagan ‚Äî ${req.frequency === 'annual' ? 'yillik' : 'yarim yillik'} majburiy`
                });
            } else if (completed.score && completed.score < 80) {
                aiFindings.trainingIssues.push({
                    type: 'low_score', severity: 'medium', emp: e.fio, empId: e.id,
                    detail: `"${req.name}" ‚Äî ball: ${completed.score}/100 (minimum 80 talab etiladi)`
                });
            }
        });
        
        // Check certification expiry
        empTrainings.filter(t => t.certExpiry).forEach(t => {
            const expiry = new Date(t.certExpiry);
            const daysLeft = (expiry - new Date()) / 86400000;
            if (daysLeft < 0) {
                aiFindings.trainingIssues.push({
                    type: 'cert_expired', severity: 'high', emp: e.fio, empId: e.id,
                    detail: `"${t.name}" sertifikati muddati ${Math.abs(Math.round(daysLeft))} kun oldin tugagan`
                });
            } else if (daysLeft < 30) {
                aiFindings.trainingIssues.push({
                    type: 'cert_expiring', severity: 'medium', emp: e.fio, empId: e.id,
                    detail: `"${t.name}" sertifikati ${Math.round(daysLeft)} kun ichida tugaydi`
                });
            }
        });
    });
}

// --- V3-12: KPI MANIPULATION ---
function analysisKPIManipulation() {
    aiFindings.kpiIssues = [];
    
    // Analyze credit approval patterns
    DB.employees.forEach(e => {
        const credits = DB.credits.filter(c => c.empId === e.id);
        const procs = DB.procurements.filter(p => p.empId === e.id);
        
        // High volume of self-approved items
        const suspInspCredits = credits.filter(c => creditRiskCheck(c).isRisk);
        if (suspInspCredits.length >= 2) {
            aiFindings.kpiIssues.push({
                type: 'self_approval_pattern', severity: 'critical', emp: e.fio, empId: e.id,
                detail: `${suspInspCredits.length} ta tekshirgan bankdan olingan kredit ‚Äî umumiy ${fmt(suspInspCredits.reduce((s,c)=>s+c.amount,0))} so'm`
            });
        }
        
        // Procurement concentration ‚Äî too many from same vendor
        const vendorCounts = {};
        procs.forEach(p => {
            const v = norm(p.org);
            if (!vendorCounts[v]) vendorCounts[v] = { count: 0, total: 0, name: p.org };
            vendorCounts[v].count++;
            vendorCounts[v].total += p.amount;
        });
        Object.values(vendorCounts).forEach(vc => {
            if (vc.count >= 4) {
                aiFindings.kpiIssues.push({
                    type: 'vendor_concentration', severity: 'high', emp: e.fio, empId: e.id,
                    detail: `${vc.name} dan ${vc.count} ta xarid ‚Äî jami ${fmt(vc.total)} ‚Äî tender talabi buzilgan bo'lishi mumkin`
                });
            }
        });
    });
}

// --- V3-13: TRANSACTION STRUCTURING ---
function analysisTransactionStructuring() {
    aiFindings.structuring = [];
    const reportingThreshold = 100000000; // 100M so'm (simulated CTR threshold)
    
    DB.accounts.forEach(acc => {
        // Check for balances just below threshold
        if (acc.balance >= reportingThreshold * 0.9 && acc.balance < reportingThreshold) {
            aiFindings.structuring.push({
                type: 'near_threshold', severity: 'medium', emp: gn(acc.empId), empId: acc.empId,
                detail: `Balans ${fmt(acc.balance)} ‚Äî hisobot chegarasining ${((acc.balance/reportingThreshold)*100).toFixed(0)}% i ‚Äî strukturlash shubhasi`
            });
        }
        
        // Dormant account reactivation
        if (acc.dormant && acc.balance > 0) {
            aiFindings.structuring.push({
                type: 'dormant_reactivation', severity: 'high', emp: gn(acc.empId), empId: acc.empId,
                detail: `Faol bo'lmagan hisob qayta faollashdi ‚Äî balans: ${fmt(acc.balance)}`
            });
        }
    });
    
    // Check for round-trip patterns ‚Äî money out then similar amount back
    DB.employees.forEach(e => {
        const travels = DB.travels.filter(t => t.empId === e.id);
        const credits = DB.credits.filter(c => c.empId === e.id);
        
        // High-cost travel followed by credit within 30 days
        travels.forEach(t => {
            credits.forEach(c => {
                const tDate = new Date(t.dateIn || t.dateOut);
                const cDate = new Date(c.date);
                const daysDiff = (cDate - tDate) / 86400000;
                if (daysDiff >= 0 && daysDiff <= 30 && t.cost > e.salary * 2) {
                    aiFindings.structuring.push({
                        type: 'travel_credit_sequence', severity: 'high', emp: e.fio, empId: e.id,
                        detail: `Qimmat safari (${fmt(t.cost)}, ${t.country}) ‚Üí ${Math.round(daysDiff)} kun ichida kredit (${fmt(c.amount)}) ‚Äî round-trip shubhasi`
                    });
                }
            });
        });
    });
    aiFindings.structuring = removeDuplicateFindings(aiFindings.structuring);
}

// --- V3-14: WHISTLEBLOWER CASE ANALYSIS ---
function analysisWhistleblower() {
    aiFindings.wbAnalysis = [];
    
    // Analyze whistleblower reports
    DB.whistleblower.forEach(wb => {
        aiFindings.wbAnalysis.push({
            type: 'wb_report', severity: wb.severity === 'P1' ? 'critical' : wb.severity === 'P2' ? 'high' : 'medium',
            emp: wb.suspect || 'Noma\'lum',
            detail: `${wb.caseId} ‚Äî ${wb.category} ‚Äî ${wb.department} ‚Äî Holat: ${wb.status}`,
            caseId: wb.caseId, status: wb.status
        });
    });
    
    // Department suppression detection ‚Äî departments with no complaints may indicate suppression
    const deptSet = new Set(DB.employees.map(e => e.department || 'Noma\'lum'));
    const deptWithComplaints = new Set(DB.whistleblower.map(w => w.department));
    
    if (DB.whistleblower.length > 0 && deptSet.size > 2) {
        deptSet.forEach(dept => {
            if (!deptWithComplaints.has(dept) && dept !== 'Noma\'lum') {
                const deptSize = DB.employees.filter(e => e.department === dept).length;
                if (deptSize >= 2) {
                    aiFindings.wbAnalysis.push({
                        type: 'dept_suppression', severity: 'medium',
                        emp: dept + ' bo\'limi',
                        detail: `${dept} bo'limidan birorta ham whistleblower xabari yo'q (${deptSize} xodim) ‚Äî suppression yoki haddan tashqari qo'rqish belgisi bo'lishi mumkin`
                    });
                }
            }
        });
    }
}

// ============================================================
// V3: RENDER FUNCTIONS FOR NEW AI MODULES
// ============================================================
function renderAIGifts() {
    const el = document.getElementById('aiGiftResults');
    document.getElementById('aiGiftCount').textContent = aiFindings.giftCorr.length + ' ta topilma';
    if (!aiFindings.giftCorr.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üéÅ</div><p>Sovg\'a-xarid korrelyatsiyasi topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.giftCorr.map(f => renderFinding(f)).join('');
}
function renderAIPep() {
    const el = document.getElementById('aiPepResults');
    document.getElementById('aiPepCount').textContent = aiFindings.pepFindings.length + ' ta aloqa';
    if (!aiFindings.pepFindings.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üèõÔ∏è</div><p>PEP aloqalari topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.pepFindings.map(f => renderFinding(f)).join('');
}
function renderAIBenford() {
    const el = document.getElementById('aiBenfordResults');
    document.getElementById('aiBenfordCount').textContent = aiFindings.benford.length + ' ta anomaliya';
    if (!aiFindings.benford.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üî¢</div><p>Benford anomaliyasi topilmadi ‚Äî summalar taqsimoti normal</p></div>'; return; }
    const expectedBenford = [0, 30.1, 17.6, 12.5, 9.7, 7.9, 6.7, 5.8, 5.1, 4.6];
    el.innerHTML = aiFindings.benford.map(f => {
        let bars = '';
        if (f.observed) {
            for (let d = 1; d <= 9; d++) {
                const obs = (f.observed[d] * 100).toFixed(1);
                const exp = expectedBenford[d];
                const diff = Math.abs(obs - exp);
                const color = diff > 5 ? 'var(--danger)' : diff > 2 ? 'var(--warning)' : 'var(--success)';
                bars += `<div style="display:flex;align-items:center;gap:6px;font-size:11px;margin:2px 0;">
                    <span class="mono" style="width:14px;">${d}</span>
                    <div style="flex:1;height:14px;background:var(--bg-input);border-radius:3px;overflow:hidden;position:relative;">
                        <div style="position:absolute;height:100%;width:${exp}%;background:var(--accent);opacity:0.3;border-radius:3px;"></div>
                        <div style="position:absolute;height:100%;width:${obs}%;background:${color};border-radius:3px;"></div>
                    </div>
                    <span class="mono" style="width:48px;color:${color};">${obs}%</span>
                    <span class="mono" style="width:48px;color:var(--text-muted);">(${exp}%)</span>
                </div>`;
            }
        }
        return `<div style="padding:14px;background:var(--bg-input);border-radius:10px;margin-bottom:10px;border-left:4px solid ${f.severity==='critical'?'var(--danger)':f.severity==='high'?'var(--warning)':'var(--accent)'};">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <strong>${f.emp}</strong>
                <span class="badge badge-${f.severity==='critical'?'danger':f.severity==='high'?'warning':'info'}">${f.severity.toUpperCase()}</span>
            </div>
            <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${f.detail}</div>
            ${bars}
        </div>`;
    }).join('');
}
function renderAISplit() {
    const el = document.getElementById('aiSplitResults');
    document.getElementById('aiSplitCount').textContent = aiFindings.splitContracts.length + ' ta shubhali';
    if (!aiFindings.splitContracts.length) { el.innerHTML = '<div class="empty"><div class="e-icon">‚úÇÔ∏è</div><p>Split-kontrakt topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.splitContracts.map(f => renderFinding(f)).join('');
}
function renderAIInsider() {
    const el = document.getElementById('aiInsiderResults');
    document.getElementById('aiInsiderCount').textContent = aiFindings.insiderLending.length + ' ta topilma';
    if (!aiFindings.insiderLending.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üè¶</div><p>Insider kredit muammolari topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.insiderLending.map(f => renderFinding(f)).join('');
}
function renderAIUeba() {
    const el = document.getElementById('aiUebaResults');
    document.getElementById('aiUebaCount').textContent = aiFindings.ueba.length + ' ta anomaliya';
    if (!aiFindings.ueba.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üíª</div><p>UEBA anomaliyasi topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.ueba.map(f => renderFinding(f)).join('');
}
function renderAIHr() {
    const el = document.getElementById('aiHrResults');
    document.getElementById('aiHrCount').textContent = aiFindings.hrAnalytics.length + ' ta topilma';
    if (!aiFindings.hrAnalytics.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üëî</div><p>HR risk topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.hrAnalytics.map(f => renderFinding(f)).join('');
}
function renderAIBenef() {
    const el = document.getElementById('aiBenefResults');
    document.getElementById('aiBenefCount').textContent = aiFindings.benefOwnership.length + ' ta shubhali';
    if (!aiFindings.benefOwnership.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üè¢</div><p>Haqiqiy egalik muammolari topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.benefOwnership.map(f => renderFinding(f)).join('');
}
function renderAISide() {
    const el = document.getElementById('aiSideResults');
    document.getElementById('aiSideCount').textContent = aiFindings.sideBusiness.length + ' ta topilma';
    if (!aiFindings.sideBusiness.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üíº</div><p>Qo\'shimcha biznes topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.sideBusiness.map(f => renderFinding(f)).join('');
}
function renderAIMedia() {
    const el = document.getElementById('aiMediaResults');
    document.getElementById('aiMediaCount').textContent = aiFindings.adverseMedia.length + ' ta topilma';
    if (!aiFindings.adverseMedia.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üì∞</div><p>Salbiy ommaviy axborot topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.adverseMedia.map(f => renderFinding(f)).join('');
}
function renderAITrain() {
    const el = document.getElementById('aiTrainResults');
    document.getElementById('aiTrainCount').textContent = aiFindings.trainingIssues.length + ' ta muammo';
    if (!aiFindings.trainingIssues.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üìã</div><p>Trening muammolari topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.trainingIssues.map(f => renderFinding(f)).join('');
}
function renderAIKpi() {
    const el = document.getElementById('aiKpiResults');
    document.getElementById('aiKpiCount').textContent = aiFindings.kpiIssues.length + ' ta anomaliya';
    if (!aiFindings.kpiIssues.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üìä</div><p>KPI anomaliyasi topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.kpiIssues.map(f => renderFinding(f)).join('');
}
function renderAIStruct() {
    const el = document.getElementById('aiStructResults');
    document.getElementById('aiStructCount').textContent = aiFindings.structuring.length + ' ta shubhali';
    if (!aiFindings.structuring.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üí∞</div><p>Strukturlash topilmadi</p></div>'; return; }
    el.innerHTML = aiFindings.structuring.map(f => renderFinding(f)).join('');
}
function renderAIWb() {
    const el = document.getElementById('aiWbResults');
    document.getElementById('aiWbCount').textContent = aiFindings.wbAnalysis.length + ' ta xabar';
    if (!aiFindings.wbAnalysis.length) { el.innerHTML = '<div class="empty"><div class="e-icon">üîê</div><p>Whistleblower xabarlari yo\'q</p></div>'; return; }
    el.innerHTML = aiFindings.wbAnalysis.map(f => renderFinding(f)).join('');
}

// ============================================================
// UTILITY FUNCTIONS
// ============================================================
function fuzzyMatch(a, b) {
    // Oddiy so'z mos kelishi ‚Äî 3+ belgi mos bo'lsa
    const wa = a.split(/[\s,.''"()-]+/).filter(w => w.length > 2);
    const wb = b.split(/[\s,.''"()-]+/).filter(w => w.length > 2);
    return wa.some(w1 => wb.some(w2 => w1 === w2 || w1.includes(w2) || w2.includes(w1)));
}

function removeDuplicateFindings(arr) {
    const seen = new Set();
    return arr.filter(f => {
        const key = f.type + '|' + f.emp + '|' + (f.detail || '').substring(0, 80);
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
    });
}

// ============================================================
// DEMO DATA
// ============================================================
function loadDemo() {
    DB.employees.push(
        { id:gid(), fio:'Turdiyev Alisher Rustamovich', position:'Inspeksiya boshqarmasi boshlig\'i', department:'Kredit tashkilotlarini inspeksiya boshqarmasi', salary:18000000, startDate:'2019-03-15', phone:'+998 90 123 45 67', riskScore:0, riskLevel:'low' },
        { id:gid(), fio:'Karimova Nilufar Shavkatovna', position:'Moliyaviy monitoring mutaxassisi', department:'Moliyaviy monitoring va valyuta nazorati bo\'limi', salary:12000000, startDate:'2020-07-01', phone:'+998 91 234 56 78', riskScore:0, riskLevel:'low' },
        { id:gid(), fio:'Ismoilov Jasur Bahodirovich', position:'Naqd pul muomalasi bo\'lim boshlig\'i', department:'Naqd pul va to\'lov monitoring bo\'limi', salary:16000000, startDate:'2018-01-10', phone:'+998 93 345 67 89', riskScore:0, riskLevel:'low' },
        { id:gid(), fio:'Rahimov Sardor Anvarovich', position:'To\'lov tizimlari va AT bo\'limi boshlig\'i', department:'To\'lov tizimlari va AT bo\'limi', salary:22000000, startDate:'2017-06-20', phone:'+998 94 456 78 90', riskScore:0, riskLevel:'low' },
        { id:gid(), fio:'Abdullayeva Mohira Kamolovna', position:'Bosh hisobchi', department:'Buxgalteriya va moliyaviy-iqtisodiy boshqarma', salary:20000000, startDate:'2016-09-01', phone:'+998 95 567 89 01', riskScore:0, riskLevel:'low' }
    );
    const a=DB.employees[0].id, j=DB.employees[2].id, m=DB.employees[4].id;

    DB.declarations.push({ id:gid(), empId:a, date:'2025-01-15', relBank:'yes', relDetail:'Turdiyeva Nilufar ‚Äî Ipoteka bank', relDeg:'Turmush o\'rtog\'i', share:'self', shareDetail:'\'Alfa Trade\' MChJ ‚Äî 25%' });
    DB.relatives.push(
        { id:gid(), empId:a, fio:'Turdiyeva Nilufar Karimovna', degree:'Turmush o\'rtog\'i', workplace:'Ipoteka bank, Kredit mutaxassisi', inBanking:'yes', companyShare:'' },
        { id:gid(), empId:a, fio:'Turdiyev Rustam Aliyevich', degree:'Ota', workplace:'\'Alfa Trade\' MChJ, Direktor', inBanking:'no', companyShare:'\'Alfa Trade\' MChJ ‚Äî 51%' }
    );
    DB.credits.push(
        { id:gid(), empId:a, type:'Biznes', amount:800000000, date:'2025-10-05', bank:'Xalq banki', inspOrg:'Xalq banki', inspDate:'2025-08-01' },
        { id:gid(), empId:a, type:'Ipoteka', amount:350000000, date:'2025-06-10', bank:'Ipoteka bank', inspOrg:'Ipoteka bank', inspDate:'2025-04-15' }
    );
    DB.properties.push(
        { id:gid(), empId:a, owner:'rel', relName:'Turdiyeva Nilufar', type:'Kvartira', value:650000000, date:'2025-10-20', creditLink:'yes' },
        { id:gid(), empId:a, owner:'self', relName:'', type:'Avtomobil', value:280000000, date:'2025-08-15', creditLink:'no' }
    );
    DB.travels.push({ id:gid(), empId:a, who:'self', relName:'', country:'BAA, Dubay', dateOut:'2025-12-01', dateIn:'2025-12-08', purpose:'Dam olish', cost:85000000, ratio:'4.7' });
    DB.accounts.push({ id:gid(), empId:a, num:'8600 **** **** 4523', balance:145000000, salary:18000000, ratio:'8.1', month:'2025-12', exceeded:true });
    DB.alerts.push({ id:gid(), empId:a, msg:'üö® Turdiyev Alisher: Balans 145,000,000 so\'m ‚Äî maoshdan 8.1x ortiq!', date:new Date().toISOString(), severity:'critical' });
    DB.procurements.push(
        { id:gid(), empId:j, org:'\'Delta Supply\' MChJ', amount:340000000, date:'2025-11-05', type:'IT uskunalari', prevCount:5, title:'Server uskunalari xaridi', status:'investigating', bidCount:3, pNum:'P001' },
        { id:gid(), empId:j, org:'\'Delta Supply\' MChJ', amount:180000000, date:'2025-09-12', type:'Xizmatlar', prevCount:5, title:'IT xizmat ko\'rsatish shartnomasi', status:'approved', bidCount:5, pNum:'P002' },
        { id:gid(), empId:a, org:'\'Gamma Stroy\' MChJ', amount:450000000, date:'2025-10-15', type:'Qurilish', prevCount:2, title:'Bino ta\'mirlash ishlari', status:'investigating', bidCount:4, pNum:'P003' },
        { id:gid(), empId:DB.employees[1].id, org:'MebelPro', amount:120000000, date:'2025-08-20', type:'Ofis jihozlari', prevCount:1, title:'Ofis jihozlari', status:'approved', bidCount:5, pNum:'P004' },
        { id:gid(), empId:DB.employees[3].id, org:'SoftBank Solutions', amount:85000000, date:'2025-07-10', type:'Dasturiy ta\'minot', prevCount:0, title:'Dasturiy ta\'minot litsenziyasi', status:'pending', bidCount:2, pNum:'P005' }
    );
    DB.declarations.push({ id:gid(), empId:m, date:'2025-02-01', relBank:'no', relDetail:'', relDeg:'', share:'no', shareDetail:'' });

    // V3 Demo Data
    DB.gifts.push(
        { id:gid(), empId:a, date:'2025-11-01', direction:'received', from:"'Alfa Trade' MChJ", type:'Qurilma (laptop)', value:15000000, reason:'Bayram sovg\'asi', relation:'vendor', status:'escalated', approvedBy:null },
        { id:gid(), empId:a, date:'2025-12-15', direction:'received', from:'Toshkent hokimligi', type:'Sertifikat va sovg\'a', value:8000000, reason:'Hamkorlik mukofoti', relation:'gov', status:'escalated', approvedBy:null },
        { id:gid(), empId:j, date:'2025-10-20', direction:'received', from:"'Delta Supply' MChJ", type:'Oziq-ovqat savati', value:3000000, reason:'Yangi yil', relation:'vendor', status:'pending', approvedBy:null },
        { id:gid(), empId:j, date:'2025-09-05', direction:'received', from:"'Delta Supply' MChJ", type:'Sport jihozlari', value:12000000, reason:'Shaxsiy', relation:'vendor', status:'pending', approvedBy:null }
    );
    
    DB.contracts.push(
        { id:gid(), empId:j, vendor:"'Delta Supply' MChJ", number:'CT-2025-001', amount:340000000, date:'2025-11-05', startDate:'2025-10-20', type:'goods', method:'direct', amendments:2, amendAmount:85000000 },
        { id:gid(), empId:j, vendor:"'Delta Supply' MChJ", number:'CT-2025-002', amount:180000000, date:'2025-09-12', startDate:'2025-09-12', type:'services', method:'direct', amendments:0, amendAmount:0 },
        { id:gid(), empId:j, vendor:"'Beta Logistics' MChJ", number:'CT-2025-003', amount:450000000, date:'2025-08-01', startDate:'2025-07-15', type:'construction', method:'tender', amendments:3, amendAmount:120000000 },
        { id:gid(), empId:a, vendor:"'Gamma Stroy' MChJ", number:'CT-2025-004', amount:95000000, date:'2025-10-10', startDate:'2025-10-15', type:'services', method:'direct', amendments:0, amendAmount:0 },
        { id:gid(), empId:a, vendor:"'Gamma Stroy' MChJ", number:'CT-2025-005', amount:88000000, date:'2025-10-25', startDate:'2025-10-28', type:'goods', method:'direct', amendments:0, amendAmount:0 }
    );
    
    DB.whistleblower.push(
        { id:gid(), caseId:'WB-1001', date:'2025-11-20', severity:'P1', category:'corruption', department:'Kredit tashkilotlarini inspeksiya boshqarmasi', suspect:'Noma\'lum boshlig\'', detail:'Inspeksiya boshqarmasi xodimi tijorat banklari tekshiruvi natijalarini qalbakilashtirayotganligi haqida ma\'lumot bor.', status:'investigating', assignedTo:null, notes:[] },
        { id:gid(), caseId:'WB-1002', date:'2025-12-05', severity:'P2', category:'bribery', department:'Naqd pul va to\'lov monitoring bo\'limi', suspect:'Noma\'lum', detail:'Naqd pul bo\'limida qimmatliklarni tashish tenderi natijalarini oldindan belgilab qo\'yish hollari kuzatilgan.', status:'new', assignedTo:null, notes:[] },
        { id:gid(), caseId:'WB-1003', date:'2026-01-10', severity:'P3', category:'conflict', department:'Noma\'lum', suspect:'Noma\'lum', detail:'Ba\'zi xodimlarning tijorat banklari bilan shaxsiy moliyaviy aloqalari borligi haqida shubha bor.', status:'new', assignedTo:null, notes:[] }
    );
    
    DB.loginLogs.push(
        { id:gid(), empId:a, timestamp:'2026-01-15T03:22:00', location:'Toshkent', newLocation:false, failedAttempts:0, bulkAccess:true, recordsAccessed:156, accessedRelativeAccount:true },
        { id:gid(), empId:a, timestamp:'2026-01-20T23:45:00', location:'Toshkent', newLocation:false, failedAttempts:3, bulkAccess:false, recordsAccessed:12, accessedRelativeAccount:false },
        { id:gid(), empId:j, timestamp:'2026-02-01T02:10:00', location:'Samarqand', newLocation:true, failedAttempts:7, bulkAccess:true, recordsAccessed:234, accessedRelativeAccount:false },
        { id:gid(), empId:DB.employees[3].id, timestamp:'2026-01-28T04:30:00', location:'Moskva', newLocation:true, failedAttempts:0, bulkAccess:true, recordsAccessed:500, accessedRelativeAccount:false }
    );
    
    DB.training.push(
        { id:gid(), empId:a, name:'AML/CFT asosiy kurs', date:'2024-06-15', score:72, certExpiry:null },
        { id:gid(), empId:DB.employees[1].id, name:'AML/CFT asosiy kurs', date:'2025-03-10', score:88, certExpiry:null },
        { id:gid(), empId:DB.employees[3].id, name:'Ma\'lumotlar xavfsizligi', date:'2025-01-20', score:95, certExpiry:'2026-01-20' }
    );
    
    DB.sideBusinesses.push(
        { id:gid(), empId:a, companyName:"'Turdiyev Consulting' MChJ", role:'Ta\'sischi (51%)', sameIndustry:true, isVendor:false, undeclared:true, familyInvolved:true }
    );
    
    DB.adverseMedia.push(
        { id:gid(), empId:a, source:'Kun.uz', tier:'tier2', headline:'Bank xodimining qarindoshlari bilan shubhali operatsiyalari haqida', date:'2025-12-10', category:'corruption' }
    );

    popSelects(); renderAll(); updateDash();
}

loadDemo();

// ============================================================
// EXCEL EXPORT / IMPORT (SheetJS)
// ============================================================
function exportToExcel() {
    if (typeof XLSX === 'undefined') { toast('SheetJS kutubxonasi yuklanmadi ‚Äî internet kerak', 'danger'); return; }
    
    const wb = XLSX.utils.book_new();
    
    // --- SHEET 1: DASHBOARD SUMMARY ---
    const dashData = [
        ['KORRUPSIYA MONITORING TIZIMI ‚Äî TO\'LIQ HISOBOT'],
        ['Sana:', new Date().toLocaleString('uz-UZ')],
        ['Tizim versiyasi:', 'v3.0 ‚Äî 29 modul'],
        [],
        ['üìä UMUMIY STATISTIKA'],
        ['Ko\'rsatkich', 'Qiymat'],
        ['Jami xodimlar', DB.employees.length],
        ['Deklaratsiyalar', DB.declarations.length],
        ['Yaqin qarindoshlar', DB.relatives.length],
        ['Kreditlar', DB.credits.length],
        ['Mol-mulklar', DB.properties.length],
        ['Chet el safarilari', DB.travels.length],
        ['Xaridlar', DB.procurements.length],
        ['Hisoblar', DB.accounts.length],
        ['Sovg\'alar', DB.gifts.length],
        ['Kontraktlar', DB.contracts.length],
        ['Whistleblower xabarlari', DB.whistleblower.length],
        ['Ogohlantirishlar', DB.alerts.length],
        [],
        ['‚ö° SCORING'],
        ['Kritik risk xodimlar (70-100)', DB.employees.filter(e=>e.riskScore>=70).length],
        ['Yuqori risk xodimlar (50-69)', DB.employees.filter(e=>e.riskScore>=50&&e.riskScore<70).length],
        ['O\'rta risk xodimlar (25-49)', DB.employees.filter(e=>e.riskScore>=25&&e.riskScore<50).length],
        ['Past risk xodimlar (0-24)', DB.employees.filter(e=>e.riskScore<25).length],
    ];
    const wsDash = XLSX.utils.aoa_to_sheet(dashData);
    wsDash['!cols'] = [{wch:35},{wch:30}];
    XLSX.utils.book_append_sheet(wb, wsDash, 'Dashboard');
    
    // --- SHEET 2: EMPLOYEES ---
    const empRows = DB.employees.map(e => ({
        'ID': e.id, 'F.I.Sh.': e.fio, 'Lavozim': e.position, 'Bo\'lim': e.department,
        'Maosh': e.salary, 'Ish boshlangan': e.startDate, 'Telefon': e.phone,
        'Risk ball': e.riskScore, 'Risk daraja': e.riskLevel
    }));
    if (empRows.length) {
        const wsEmp = XLSX.utils.json_to_sheet(empRows);
        wsEmp['!cols'] = [{wch:6},{wch:32},{wch:28},{wch:20},{wch:15},{wch:14},{wch:18},{wch:10},{wch:12}];
        XLSX.utils.book_append_sheet(wb, wsEmp, 'Xodimlar');
    }
    
    // --- SHEET 3: DECLARATIONS ---
    const declRows = DB.declarations.map(d => ({
        'Xodim': gn(d.empId), 'Sana': d.date, 'Bankda qarindosh': d.relBank,
        'Tafsilot': d.relDetail, 'Qarindoshlik': d.relDeg,
        'Ulush': d.share, 'Ulush tafsilot': d.shareDetail
    }));
    if (declRows.length) { const ws = XLSX.utils.json_to_sheet(declRows); ws['!cols'] = [{wch:30},{wch:12},{wch:16},{wch:35},{wch:18},{wch:10},{wch:35}]; XLSX.utils.book_append_sheet(wb, ws, 'Deklaratsiyalar'); }
    
    // --- SHEET 4: RELATIVES ---
    const relRows = DB.relatives.map(r => ({
        'Xodim': gn(r.empId), 'Qarindosh F.I.Sh.': r.fio, 'Qarindoshlik': r.degree,
        'Ish joyi': r.workplace, 'Bankda ishlaydi': r.inBanking, 'Kompaniya ulushi': r.companyShare
    }));
    if (relRows.length) { const ws = XLSX.utils.json_to_sheet(relRows); ws['!cols'] = [{wch:30},{wch:30},{wch:18},{wch:35},{wch:16},{wch:30}]; XLSX.utils.book_append_sheet(wb, ws, 'Yaqinlar'); }
    
    // --- SHEET 5: CREDITS ---
    const credRows = DB.credits.map(c => ({
        'Xodim': gn(c.empId), 'Turi': c.type, 'Summa': c.amount, 'Sana': c.date,
        'Bank': c.bank, 'Tekshirgan bank': c.inspOrg || '', 'Tekshiruv sana': c.inspDate || '',
        'Tekshirish tashkiloti': c.inspOrg, 'Tekshirish sanasi': c.inspDate
    }));
    if (credRows.length) { const ws = XLSX.utils.json_to_sheet(credRows); ws['!cols'] = [{wch:30},{wch:12},{wch:18},{wch:12},{wch:20},{wch:14},{wch:25},{wch:14}]; XLSX.utils.book_append_sheet(wb, ws, 'Kreditlar'); }
    
    // --- SHEET 6: PROPERTIES ---
    const propRows = DB.properties.map(p => ({
        'Xodim': gn(p.empId), 'Egasi': p.owner==='self'?'O\'zi':'Qarindosh', 'Qarindosh': p.relName,
        'Turi': p.type, 'Qiymati': p.value, 'Sana': p.date, 'Kredit bog\'liq': p.creditLink
    }));
    if (propRows.length) { const ws = XLSX.utils.json_to_sheet(propRows); ws['!cols'] = [{wch:30},{wch:10},{wch:25},{wch:14},{wch:18},{wch:12},{wch:14}]; XLSX.utils.book_append_sheet(wb, ws, 'Mol-mulk'); }
    
    // --- SHEET 7: TRAVELS ---
    const travelRows = DB.travels.map(t => ({
        'Xodim': gn(t.empId), 'Kim': t.who==='self'?'O\'zi':'Qarindosh', 'Qarindosh': t.relName,
        'Mamlakat': t.country, 'Chiqish': t.dateOut, 'Qaytish': t.dateIn,
        'Maqsad': t.purpose, 'Xarajat': t.cost, 'Maosh nisbati': t.ratio
    }));
    if (travelRows.length) { const ws = XLSX.utils.json_to_sheet(travelRows); ws['!cols'] = [{wch:30},{wch:10},{wch:20},{wch:18},{wch:12},{wch:12},{wch:18},{wch:15},{wch:12}]; XLSX.utils.book_append_sheet(wb, ws, 'Safarlar'); }
    
    // --- SHEET 8: PROCUREMENTS ---
    const procRows = DB.procurements.map(p => ({
        'Xodim': gn(p.empId), 'Tashkilot': p.org, 'Summa': p.amount,
        'Sana': p.date, 'Turi': p.type, 'Avvalgi xaridlar soni': p.prevCount
    }));
    if (procRows.length) { const ws = XLSX.utils.json_to_sheet(procRows); ws['!cols'] = [{wch:30},{wch:28},{wch:18},{wch:12},{wch:14},{wch:22}]; XLSX.utils.book_append_sheet(wb, ws, 'Xaridlar'); }
    
    // --- SHEET 9: ACCOUNTS ---
    const accRows = DB.accounts.map(a => ({
        'Xodim': gn(a.empId), 'Hisob raqami': a.num, 'Balans': a.balance,
        'Maosh': a.salary, 'Nisbat': a.ratio, 'Oy': a.month, '5x oshgan': a.exceeded?'HA':'YO\'Q'
    }));
    if (accRows.length) { const ws = XLSX.utils.json_to_sheet(accRows); ws['!cols'] = [{wch:30},{wch:22},{wch:18},{wch:15},{wch:10},{wch:10},{wch:12}]; XLSX.utils.book_append_sheet(wb, ws, 'Hisoblar'); }
    
    // --- SHEET 10: GIFTS ---
    const giftRows = DB.gifts.map(g => ({
        'Xodim': gn(g.empId), 'Sana': g.date, 'Yo\'nalish': g.direction==='received'?'Qabul qildi':'Berdi',
        'Kimdan/Kimga': g.from, 'Turi': g.type, 'Qiymat': g.value,
        'Sabab': g.reason, 'Munosabat': g.relation, 'Holat': g.status
    }));
    if (giftRows.length) { const ws = XLSX.utils.json_to_sheet(giftRows); ws['!cols'] = [{wch:30},{wch:12},{wch:14},{wch:25},{wch:18},{wch:15},{wch:20},{wch:12},{wch:14}]; XLSX.utils.book_append_sheet(wb, ws, 'Sovg\'alar'); }
    
    // --- SHEET 11: CONTRACTS ---
    const ctRows = DB.contracts.map(c => ({
        'Xodim': gn(c.empId), 'Vendor': c.vendor, 'Raqam': c.number, 'Summa': c.amount,
        'Sana': c.date, 'Ish boshlangan': c.startDate, 'Turi': c.type,
        'Usul': c.method, 'O\'zgarishlar': c.amendments, 'O\'zgartirish summasi': c.amendAmount
    }));
    if (ctRows.length) { const ws = XLSX.utils.json_to_sheet(ctRows); ws['!cols'] = [{wch:30},{wch:25},{wch:16},{wch:18},{wch:12},{wch:14},{wch:12},{wch:12},{wch:14},{wch:18}]; XLSX.utils.book_append_sheet(wb, ws, 'Kontraktlar'); }
    
    // --- SHEET 12: WHISTLEBLOWER ---
    const wbRows = DB.whistleblower.map(w => ({
        'Case ID': w.caseId, 'Sana': w.date, 'Daraja': w.severity,
        'Kategoriya': w.category, 'Bo\'lim': w.department,
        'Gumon qilinuvchi': w.suspect, 'Holat': w.status, 'Tafsilot': w.detail
    }));
    if (wbRows.length) { const ws = XLSX.utils.json_to_sheet(wbRows); ws['!cols'] = [{wch:12},{wch:12},{wch:8},{wch:16},{wch:20},{wch:20},{wch:16},{wch:50}]; XLSX.utils.book_append_sheet(wb, ws, 'Whistleblower'); }
    
    // --- SHEET 13: ALERTS ---
    const alertRows = DB.alerts.map(a => ({
        'Xodim': gn(a.empId), 'Xabar': a.msg, 'Sana': a.date, 'Darajasi': a.severity
    }));
    if (alertRows.length) { const ws = XLSX.utils.json_to_sheet(alertRows); ws['!cols'] = [{wch:30},{wch:60},{wch:22},{wch:12}]; XLSX.utils.book_append_sheet(wb, ws, 'Ogohlantirishlar'); }
    
    // --- SHEET 14: SCORING HISTORY ---
    const scoreRows = DB.scoreHistory.map(s => ({
        'Xodim': gn(s.empId), 'Sana': s.date, 'Ball': s.score, 'Daraja': s.level,
        'Conflict': s.details?.conflict, 'Credit': s.details?.credit,
        'Property': s.details?.property, 'Balance': s.details?.balance, 'Procurement': s.details?.procurement
    }));
    if (scoreRows.length) { const ws = XLSX.utils.json_to_sheet(scoreRows); ws['!cols'] = [{wch:30},{wch:22},{wch:8},{wch:10},{wch:10},{wch:10},{wch:10},{wch:10},{wch:12}]; XLSX.utils.book_append_sheet(wb, ws, 'Scoring tarixi'); }
    
    // --- SHEET 15: AI ANALYSIS RESULTS ---
    const aiRows = [];
    aiRows.push(['üß† AI TAHLIL NATIJALARI ‚Äî ' + new Date().toLocaleString('uz-UZ')]);
    aiRows.push([]);
    
    const addAISection = (title, arr) => {
        if (!arr || !arr.length) return;
        aiRows.push([title, 'Jami: ' + arr.length]);
        aiRows.push(['Xodim', 'Daraja', 'Turi', 'Tafsilot']);
        arr.forEach(f => aiRows.push([f.emp || '‚Äî', f.severity || '‚Äî', f.type || '‚Äî', f.detail || '‚Äî']));
        aiRows.push([]);
    };
    
    addAISection('üîó Kross-referensiya', aiFindings.cross);
    addAISection('‚è±Ô∏è Vaqt pattern', aiFindings.temporal);
    addAISection('üí∞ Turmush tarzi anomaliya', aiFindings.lifestyle);
    addAISection('ü§ù Xarid favoritizmi', aiFindings.favoritism);
    addAISection('‚õìÔ∏è Zanjirli aloqa', aiFindings.chains);
    addAISection('üìä Statistik anomaliya (Z-Score)', aiFindings.anomalies);
    addAISection('üîÆ Erta ogohlantirish', aiFindings.earlyWarnings);
    addAISection('üîê Vazifalarni ajratish (SoD)', aiFindings.sodViolations);
    addAISection('üéÅ Sovg\'a-xarid korrelyatsiya', aiFindings.giftCorr);
    addAISection('üèõÔ∏è PEP aloqalari', aiFindings.pepFindings);
    addAISection('üî¢ Benford qonuni', aiFindings.benford);
    addAISection('‚úÇÔ∏è Split-kontrakt', aiFindings.splitContracts);
    addAISection('üè¶ Insider kredit', aiFindings.insiderLending);
    addAISection('üíª UEBA anomaliya', aiFindings.ueba);
    addAISection('üëî HR tahlil', aiFindings.hrAnalytics);
    addAISection('üè¢ Haqiqiy egalik', aiFindings.benefOwnership);
    addAISection('üíº Qo\'shimcha biznes', aiFindings.sideBusiness);
    addAISection('üì∞ OSINT / Ommaviy axborot', aiFindings.adverseMedia);
    addAISection('üìã Trening compliance', aiFindings.trainingIssues);
    addAISection('üìä KPI manipulyatsiya', aiFindings.kpiIssues);
    addAISection('üí∞ Tranzaksiya strukturlash', aiFindings.structuring);
    addAISection('<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;vertical-align:middle;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Whistleblower tahlil', aiFindings.wbAnalysis);
    
    // Rules engine results
    if (aiFindings.rulesResults && aiFindings.rulesResults.length) {
        aiRows.push(['‚öôÔ∏è QOIDALAR MOTORI NATIJALARI']);
        aiRows.push(['Qoida ID', 'Nomi', 'Daraja', 'Holat', 'Buzgan xodimlar']);
        aiFindings.rulesResults.forEach(r => {
            aiRows.push([r.id, r.name, r.severity, r.violated ? 'BUZILGAN' : 'O\'tildi', 
                r.violated ? (r.violators || []).map(v => v.emp).join(', ') : '‚Äî']);
        });
        aiRows.push([]);
    }
    
    // Watch list
    if (aiFindings.watchList && aiFindings.watchList.length) {
        aiRows.push(['üëÅÔ∏è KUZATUV RO\'YXATI']);
        aiRows.push(['#', 'Xodim', 'Ball', 'Daraja', 'Asosiy sabablar']);
        aiFindings.watchList.forEach((w, i) => {
            aiRows.push([i + 1, w.emp, w.totalScore, w.priority, (w.reasons || []).slice(0, 3).join('; ')]);
        });
    }
    
    if (aiRows.length > 2) {
        const wsAI = XLSX.utils.aoa_to_sheet(aiRows);
        wsAI['!cols'] = [{wch:32},{wch:18},{wch:22},{wch:65}];
        XLSX.utils.book_append_sheet(wb, wsAI, 'AI Tahlil');
    }
    
    // --- SAVE ---
    const fileName = 'Korrupsiya_Monitoring_' + new Date().toISOString().split('T')[0] + '.xlsx';
    XLSX.writeFile(wb, fileName);
    toast('‚úÖ Excel fayl saqlandi: ' + fileName + ' (' + wb.SheetNames.length + ' ta varaq)', 'success');
}

// ============================================================
// EXCEL IMPORT
// ============================================================
function importFromExcel(input) {
    if (typeof XLSX === 'undefined') { toast('SheetJS kutubxonasi yuklanmadi ‚Äî internet kerak', 'danger'); return; }
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            let imported = { emp: 0, decl: 0, rel: 0, cred: 0, prop: 0, travel: 0, proc: 0, acc: 0, gift: 0, ct: 0, wb: 0 };
            
            // Helper: find sheet by partial name match
            const findSheet = (...names) => {
                for (const n of names) {
                    const found = workbook.SheetNames.find(s => s.toLowerCase().includes(n.toLowerCase()));
                    if (found) return XLSX.utils.sheet_to_json(workbook.Sheets[found]);
                }
                return null;
            };
            
            // Helper: find employee by name, create if not exists
            const findOrCreateEmp = (name) => {
                if (!name || name === '‚Äî') return null;
                let emp = DB.employees.find(e => e.fio === name);
                if (!emp) {
                    emp = { id: gid(), fio: name, position: 'Import', department: 'Import', salary: 0, startDate: '', phone: '', riskScore: 0, riskLevel: 'low' };
                    DB.employees.push(emp);
                    imported.emp++;
                }
                return emp.id;
            };
            
            // --- IMPORT EMPLOYEES ---
            const empSheet = findSheet('Xodim', 'Employee', 'Hodim');
            if (empSheet) {
                empSheet.forEach(row => {
                    const name = row['F.I.Sh.'] || row['FIO'] || row['Ism'] || row['Name'] || '';
                    if (!name) return;
                    if (DB.employees.some(e => e.fio === name)) return; // skip duplicates
                    DB.employees.push({
                        id: gid(), fio: name,
                        position: row['Lavozim'] || row['Position'] || '',
                        department: row['Bo\'lim'] || row['Department'] || '',
                        salary: parseFloat(row['Maosh'] || row['Salary'] || 0) || 0,
                        startDate: row['Ish boshlangan'] || row['Start Date'] || '',
                        phone: row['Telefon'] || row['Phone'] || '',
                        riskScore: parseFloat(row['Risk ball'] || 0) || 0,
                        riskLevel: row['Risk daraja'] || 'low'
                    });
                    imported.emp++;
                });
            }
            
            // --- IMPORT DECLARATIONS ---
            const declSheet = findSheet('Deklarat', 'Declaration');
            if (declSheet) {
                declSheet.forEach(row => {
                    const empId = findOrCreateEmp(row['Xodim'] || row['Employee']);
                    if (!empId) return;
                    DB.declarations.push({
                        id: gid(), empId, date: row['Sana'] || row['Date'] || '',
                        relBank: row['Bankda qarindosh'] || 'no', relDetail: row['Tafsilot'] || row['Detail'] || '',
                        relDeg: row['Qarindoshlik'] || '', share: row['Ulush'] || 'no', shareDetail: row['Ulush tafsilot'] || ''
                    });
                    imported.decl++;
                });
            }
            
            // --- IMPORT RELATIVES ---
            const relSheet = findSheet('Yaqin', 'Qarindosh', 'Relative');
            if (relSheet) {
                relSheet.forEach(row => {
                    const empId = findOrCreateEmp(row['Xodim'] || row['Employee']);
                    if (!empId) return;
                    DB.relatives.push({
                        id: gid(), empId, fio: row['Qarindosh F.I.Sh.'] || row['Relative'] || '',
                        degree: row['Qarindoshlik'] || row['Relation'] || '',
                        workplace: row['Ish joyi'] || row['Workplace'] || '',
                        inBanking: row['Bankda ishlaydi'] || 'no',
                        companyShare: row['Kompaniya ulushi'] || ''
                    });
                    imported.rel++;
                });
            }
            
            // --- IMPORT CREDITS ---
            const credSheet = findSheet('Kredit', 'Credit', 'Loan');
            if (credSheet) {
                credSheet.forEach(row => {
                    const empId = findOrCreateEmp(row['Xodim'] || row['Employee']);
                    if (!empId) return;
                    DB.credits.push({
                        id: gid(), empId, type: row['Turi'] || row['Type'] || '',
                        amount: parseFloat(row['Summa'] || row['Amount'] || 0) || 0,
                        date: row['Sana'] || row['Date'] || '', bank: row['Bank'] || '',
                        inspOrg: row['Tekshirgan bank'] || row['Inspected Bank'] || '',
                        inspOrg: row['Tekshirish tashkiloti'] || '', inspDate: row['Tekshirish sanasi'] || ''
                    });
                    imported.cred++;
                });
            }
            
            // --- IMPORT PROPERTIES ---
            const propSheet = findSheet('Mol-mulk', 'Mulk', 'Property');
            if (propSheet) {
                propSheet.forEach(row => {
                    const empId = findOrCreateEmp(row['Xodim'] || row['Employee']);
                    if (!empId) return;
                    const ownerVal = (row['Egasi'] || '').toLowerCase();
                    DB.properties.push({
                        id: gid(), empId, owner: ownerVal.includes('qarindosh') ? 'rel' : 'self',
                        relName: row['Qarindosh'] || '', type: row['Turi'] || row['Type'] || '',
                        value: parseFloat(row['Qiymati'] || row['Value'] || 0) || 0,
                        date: row['Sana'] || row['Date'] || '',
                        creditLink: row['Kredit bog\'liq'] || 'no'
                    });
                    imported.prop++;
                });
            }
            
            // --- IMPORT TRAVELS ---
            const travelSheet = findSheet('Safari', 'Travel', 'Safar');
            if (travelSheet) {
                travelSheet.forEach(row => {
                    const empId = findOrCreateEmp(row['Xodim'] || row['Employee']);
                    if (!empId) return;
                    const sal = gs(empId);
                    const cost = parseFloat(row['Xarajat'] || row['Cost'] || 0) || 0;
                    DB.travels.push({
                        id: gid(), empId, who: (row['Kim'] || '').includes('Qarindosh') ? 'rel' : 'self',
                        relName: row['Qarindosh'] || '', country: row['Mamlakat'] || row['Country'] || '',
                        dateOut: row['Chiqish'] || '', dateIn: row['Qaytish'] || '',
                        purpose: row['Maqsad'] || row['Purpose'] || '',
                        cost, ratio: sal > 0 ? (cost / sal).toFixed(1) : '‚Äî'
                    });
                    imported.travel++;
                });
            }
            
            // --- IMPORT PROCUREMENTS ---
            const procSheet = findSheet('Xarid', 'Procurement', 'Purchase');
            if (procSheet) {
                procSheet.forEach(row => {
                    const empId = findOrCreateEmp(row['Xodim'] || row['Employee']);
                    if (!empId) return;
                    DB.procurements.push({
                        id: gid(), empId, org: row['Tashkilot'] || row['Vendor'] || row['Organization'] || '',
                        amount: parseFloat(row['Summa'] || row['Amount'] || 0) || 0,
                        date: row['Sana'] || row['Date'] || '', type: row['Turi'] || row['Type'] || '',
                        prevCount: parseInt(row['Avvalgi xaridlar soni'] || 0) || 0
                    });
                    imported.proc++;
                });
            }
            
            // --- IMPORT ACCOUNTS ---
            const accSheet = findSheet('Hisob', 'Account', 'Balance');
            if (accSheet) {
                accSheet.forEach(row => {
                    const empId = findOrCreateEmp(row['Xodim'] || row['Employee']);
                    if (!empId) return;
                    const balance = parseFloat(row['Balans'] || row['Balance'] || 0) || 0;
                    const salary = parseFloat(row['Maosh'] || row['Salary'] || gs(empId)) || 0;
                    DB.accounts.push({
                        id: gid(), empId, num: row['Hisob raqami'] || row['Account'] || '',
                        balance, salary, ratio: salary > 0 ? (balance / salary).toFixed(1) : '‚Äî',
                        month: row['Oy'] || row['Month'] || '', exceeded: balance > salary * 5
                    });
                    imported.acc++;
                });
            }
            
            // --- IMPORT GIFTS ---
            const giftSheet = findSheet('Sovg\'a', 'Gift');
            if (giftSheet) {
                giftSheet.forEach(row => {
                    const empId = findOrCreateEmp(row['Xodim'] || row['Employee']);
                    if (!empId) return;
                    DB.gifts.push({
                        id: gid(), empId, date: row['Sana'] || row['Date'] || '',
                        direction: (row['Yo\'nalish'] || '').includes('Berdi') ? 'given' : 'received',
                        from: row['Kimdan/Kimga'] || row['From'] || '', type: row['Turi'] || row['Type'] || '',
                        value: parseFloat(row['Qiymat'] || row['Value'] || 0) || 0,
                        reason: row['Sabab'] || row['Reason'] || '',
                        relation: row['Munosabat'] || row['Relation'] || 'other',
                        status: row['Holat'] || row['Status'] || 'pending', approvedBy: null
                    });
                    imported.gift++;
                });
            }
            
            // --- IMPORT CONTRACTS ---
            const ctSheet = findSheet('Kontrakt', 'Contract');
            if (ctSheet) {
                ctSheet.forEach(row => {
                    const empId = findOrCreateEmp(row['Xodim'] || row['Employee']);
                    if (!empId) return;
                    DB.contracts.push({
                        id: gid(), empId, vendor: row['Vendor'] || row['Pudratchi'] || '',
                        number: row['Raqam'] || row['Number'] || '',
                        amount: parseFloat(row['Summa'] || row['Amount'] || 0) || 0,
                        date: row['Sana'] || row['Date'] || '', startDate: row['Ish boshlangan'] || '',
                        type: row['Turi'] || row['Type'] || 'goods',
                        method: row['Usul'] || row['Method'] || 'direct',
                        amendments: parseInt(row['O\'zgarishlar'] || 0) || 0,
                        amendAmount: parseFloat(row['O\'zgartirish summasi'] || 0) || 0
                    });
                    imported.ct++;
                });
            }
            
            // --- IMPORT WHISTLEBLOWER ---
            const wbSheet = findSheet('Whistleblower', 'Anonim');
            if (wbSheet) {
                wbSheet.forEach(row => {
                    DB.whistleblower.push({
                        id: gid(), caseId: row['Case ID'] || 'WB-' + (++wbCounter),
                        date: row['Sana'] || row['Date'] || '', severity: row['Daraja'] || row['Severity'] || 'P3',
                        category: row['Kategoriya'] || row['Category'] || 'other',
                        department: row['Bo\'lim'] || row['Department'] || '',
                        suspect: row['Gumon qilinuvchi'] || row['Suspect'] || '',
                        detail: row['Tafsilot'] || row['Detail'] || '',
                        status: row['Holat'] || row['Status'] || 'new', assignedTo: null, notes: []
                    });
                    imported.wb++;
                });
            }
            
            // --- FINALIZE ---
            popSelects(); renderAll(); updateDash();
            
            const total = Object.values(imported).reduce((s, v) => s + v, 0);
            const details = [];
            if (imported.emp) details.push(imported.emp + ' xodim');
            if (imported.decl) details.push(imported.decl + ' deklaratsiya');
            if (imported.rel) details.push(imported.rel + ' qarindosh');
            if (imported.cred) details.push(imported.cred + ' kredit');
            if (imported.prop) details.push(imported.prop + ' mol-mulk');
            if (imported.travel) details.push(imported.travel + ' safari');
            if (imported.proc) details.push(imported.proc + ' xarid');
            if (imported.acc) details.push(imported.acc + ' hisob');
            if (imported.gift) details.push(imported.gift + ' sovg\'a');
            if (imported.ct) details.push(imported.ct + ' kontrakt');
            if (imported.wb) details.push(imported.wb + ' whistleblower');
            
            if (total > 0) {
                toast('‚úÖ Import muvaffaqiyatli: ' + total + ' ta yozuv ‚Äî ' + details.join(', '), 'success');
            } else {
                toast('‚ö†Ô∏è Import: mos varaq topilmadi. Ustun nomlari to\'g\'ri ekanini tekshiring.', 'warning');
            }
        } catch(err) {
            console.error('Import error:', err);
            toast('‚ùå Import xatosi: ' + err.message, 'danger');
        }
        input.value = '';
    };
    reader.readAsArrayBuffer(file);
}


(function selfTest() {
    const requiredFns = ['runFullAIAnalysis','analysisCrossReference','analysisTemporalPatterns','analysisLifestyleIncome','analysisProcurementFavoritism','analysisNetworkBuild','analysisTrends','analysisChainConnections','analysisAnomalyZScore','analysisEarlyWarning','analysisRulesEngine','analysisSegregationOfDuties','buildWatchList','renderAIChains','renderAIAnomalies','renderAIEarlyWarning','renderAIRules','renderAIWatchList','renderAIHeatMap','renderAISoD','generateFullReport','analysisGiftCorrelation','analysisPepScreening','analysisBenfordLaw','analysisSplitContract','analysisInsiderLending','analysisUEBA','analysisHRAnalytics','analysisBeneficialOwnership','analysisSideBusiness','analysisAdverseMedia','analysisTrainingCompliance','analysisKPIManipulation','analysisTransactionStructuring','analysisWhistleblower','addGift','addContract','addWhistleblower','exportToExcel','importFromExcel'];
    const missing = requiredFns.filter(fn => typeof window[fn] !== 'function');
    const requiredIds = ['sec-ai','sec-gifts','sec-contracts','sec-whistleblower','aiProgress','aiResults','aiChainCard','aiAnomalyCard','aiEarlyCard','aiRulesCard','aiWatchCard','aiHeatCard','aiSodCard','aiReportCard','aiGiftCard','aiPepCard','aiBenfordCard','aiSplitCard','aiInsiderCard','aiUebaCard','aiHrCard','aiBenefCard','aiSideCard','aiMediaCard','aiTrainCard','aiKpiCard','aiStructCard','aiWbCard'];
    const missingEls = requiredIds.filter(id => !document.getElementById(id));
    
    if (missing.length || missingEls.length) {
        console.error('‚ùå SELF-TEST FAILED!', {missingFunctions: missing, missingElements: missingEls});
        document.title = '‚ùå XATO: ' + (missing.length + missingEls.length) + ' ta modul yuklanmadi';
    } else {
        console.log('‚úÖ SELF-TEST PASSED: Barcha ' + requiredFns.length + ' ta funksiya va ' + requiredIds.length + ' ta element mavjud.');
        document.title = '‚úÖ MB Korrupsiya Monitoring v3.0 ‚Äî 29 modul';
        // AI badge ko'rsatish ‚Äî foydalanuvchiga modullar mavjudligini bildirish
        const b = document.getElementById('aiBadge');
        if (b) { b.textContent = 'üÜï'; b.style.display = 'inline'; b.style.background = 'var(--success)'; }
    }
})();
</script>
</body>
</html>
