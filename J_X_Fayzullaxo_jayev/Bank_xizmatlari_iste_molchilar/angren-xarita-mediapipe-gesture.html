<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Angren shahri - Moliyaviy xarita</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Legacy MediaPipe Hands ‚Äî brauzerda qo'l aniqlash (file:// dan ishlaydi!) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466862/camera_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1675466124/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js"
        crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #f0f4f8;
            --bg2: #fff;
            --text: #1e293b;
            --text2: #475569;
            --muted: #94a3b8;
            --border: #e2e8f0;
            --primary: #2563eb;
            --green: #059669;
            --orange: #d97706;
            --purple: #7c3aed;
            --pink: #db2777;
            --cyan: #0891b2;
            --danger: #dc2626
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --bg2: #1e293b;
            --text: #f1f5f9;
            --text2: #cbd5e1;
            --muted: #64748b;
            --border: #334155
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh
        }

        /* HEADER */
        .header {
            height: 56px;
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 .75rem;
            gap: .5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .08)
        }

        .logo {
            display: flex;
            align-items: center;
            gap: .5rem;
            flex-shrink: 0
        }

        .logo-icon {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem
        }

        .logo h1 {
            font-size: 1rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .logo p {
            font-size: .6rem;
            color: var(--muted)
        }

        .hfilters {
            display: none;
            align-items: center;
            gap: .25rem;
            padding: .2rem;
            background: var(--bg);
            border-radius: 20px;
            border: 1px solid var(--border);
            flex: 1;
            min-width: 0;
            overflow-x: auto;
            scrollbar-width: none
        }

        .hfilters::-webkit-scrollbar {
            display: none
        }

        @media(min-width:1200px) {
            .hfilters {
                display: flex
            }
        }

        .chip {
            padding: .35rem .6rem;
            border-radius: 16px;
            border: none;
            background: transparent;
            color: var(--text2);
            font-size: .65rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: .2s
        }

        .chip:hover {
            background: var(--bg);
            color: var(--primary)
        }

        .chip.active {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: #fff
        }

        .hright {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: .35rem;
            flex-shrink: 0
        }

        .ctrl-group {
            display: flex;
            align-items: center;
            background: var(--bg);
            padding: 2px;
            border-radius: 8px;
            border: 1px solid var(--border);
            gap: 2px
        }

        .ctrl-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: .95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text2);
            transition: .2s
        }

        .ctrl-btn:hover {
            background: var(--border)
        }

        .ctrl-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: #fff
        }

        .date-badge {
            text-align: right;
            padding: .25rem .4rem;
            background: var(--bg);
            border-radius: 6px;
            border: 1px solid var(--border)
        }

        .date-badge small {
            font-size: .45rem;
            color: var(--muted);
            text-transform: uppercase;
            display: block
        }

        .date-badge b {
            font-size: .7rem;
            color: var(--green)
        }

        /* SIDEBAR */
        .sidebar {
            width: 320px;
            background: var(--bg2);
            border-right: 1px solid var(--border);
            position: fixed;
            top: 56px;
            left: 0;
            bottom: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform .3s
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: .3rem;
            padding: .5rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, .04), rgba(124, 58, 237, .04));
            border-bottom: 1px solid var(--border)
        }

        .stat-item {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: .35rem .2rem;
            text-align: center
        }

        .stat-val {
            font-size: .9rem;
            font-weight: 800;
            line-height: 1.2
        }

        .stat-val.blue {
            color: var(--primary)
        }

        .stat-val.green {
            color: var(--green)
        }

        .stat-val.orange {
            color: var(--orange)
        }

        .stat-val.purple {
            color: var(--purple)
        }

        .stat-val.cyan {
            color: var(--cyan)
        }

        .stat-val.pink {
            color: var(--pink)
        }

        .stat-lbl {
            font-size: .5rem;
            color: var(--muted)
        }

        .info-btn-wrap {
            padding: .5rem .75rem;
            border-bottom: 1px solid var(--border)
        }

        .info-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: .6rem .8rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, .1), rgba(124, 58, 237, .1));
            border: 1px solid var(--primary);
            border-radius: 10px;
            color: var(--primary);
            font-size: .8rem;
            font-weight: 600;
            cursor: pointer;
            transition: .2s
        }

        .info-btn:hover {
            background: var(--primary);
            color: #fff
        }

        .search-wrap {
            padding: .5rem .75rem;
            border-bottom: 1px solid var(--border)
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: .5rem;
            background: var(--bg);
            padding: .5rem .75rem;
            border-radius: 8px;
            border: 1px solid var(--border)
        }

        .search-box:focus-within {
            border-color: var(--primary)
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: .8rem;
            color: var(--text);
            outline: none
        }

        .search-box input::placeholder {
            color: var(--muted)
        }

        .mfilters {
            display: none;
            flex-wrap: wrap;
            gap: .3rem;
            margin-top: .5rem
        }

        .mfilters .chip {
            padding: .35rem .6rem;
            border: 1px solid var(--border);
            background: var(--bg2);
            border-radius: 18px;
            font-size: .7rem
        }

        .mfilters .chip.active {
            border-color: transparent
        }

        @media(max-width:1199px) {
            .mfilters {
                display: flex
            }
        }

        .loc-list {
            flex: 1;
            overflow-y: auto;
            padding: .5rem
        }

        .grp-title {
            display: flex;
            align-items: center;
            gap: .3rem;
            font-size: .7rem;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: .4rem;
            padding-bottom: .3rem;
            border-bottom: 2px solid var(--border)
        }

        .grp-count {
            margin-left: auto;
            font-size: .6rem;
            padding: .1rem .35rem;
            background: var(--bg);
            border-radius: 6px
        }

        .loc-card {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: .65rem;
            margin-bottom: .35rem;
            cursor: pointer;
            transition: .2s;
            position: relative
        }

        .loc-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, .1);
            transform: translateX(2px)
        }

        .loc-card.active {
            border-color: var(--green);
            background: linear-gradient(135deg, rgba(5, 150, 105, .03), rgba(8, 145, 178, .03))
        }

        .loc-hdr {
            display: flex;
            align-items: center;
            gap: .5rem;
            margin-bottom: .3rem
        }

        .loc-ico {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .95rem;
            flex-shrink: 0
        }

        .loc-hdr h4 {
            font-size: .78rem;
            font-weight: 700
        }

        .loc-type {
            font-size: .55rem;
            padding: .08rem .3rem;
            border-radius: 3px;
            background: var(--bg);
            color: var(--muted);
            font-weight: 600;
            margin-left: .3rem
        }

        .loc-addr {
            font-size: .68rem;
            color: var(--text2)
        }

        .loc-meta {
            display: flex;
            flex-wrap: wrap;
            gap: .4rem;
            font-size: .62rem;
            color: var(--muted);
            margin-top: .3rem
        }

        .loc-meta .hl {
            color: var(--green);
            font-weight: 600
        }

        /* MAP */
        #map {
            position: fixed;
            top: 56px;
            left: 320px;
            right: 0;
            bottom: 0;
            z-index: 1;
            background: #e8e8e8
        }

        /* MAP CONTROLS */
        .map-ctrls {
            position: fixed;
            top: 72px;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: .35rem;
            z-index: 500
        }

        .map-btn {
            width: 38px;
            height: 38px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            transition: .2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .08)
        }

        .map-btn:hover {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary)
        }

        /* LEGEND */
        .map-legend {
            position: fixed;
            top: 72px;
            left: 336px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: .75rem;
            z-index: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
            max-width: 160px
        }

        .legend-head {
            font-size: .6rem;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: .5rem;
            padding-bottom: .3rem;
            border-bottom: 1px solid var(--border)
        }

        .legend-row {
            display: flex;
            align-items: center;
            gap: .35rem;
            margin-bottom: .3rem;
            font-size: .68rem;
            color: var(--text2)
        }

        .legend-dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, .15)
        }

        .legend-div {
            height: 1px;
            background: var(--border);
            margin: .4rem 0
        }

        .legend-info {
            font-size: .6rem;
            color: var(--text2)
        }

        .legend-info div {
            margin-bottom: .15rem
        }

        /* BANK PANEL */
        .bank-panel {
            position: fixed;
            bottom: 1rem;
            left: 336px;
            width: 420px;
            max-height: calc(100vh - 100px);
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .12);
            z-index: 600;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp .3s ease
        }

        .bank-panel.active {
            display: flex
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(15px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .panel-hdr {
            display: flex;
            align-items: center;
            gap: .75rem;
            padding: .85rem;
            background: linear-gradient(135deg, rgba(37, 99, 235, .06), rgba(124, 58, 237, .06));
            border-bottom: 1px solid var(--border)
        }

        .panel-ico {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem
        }

        .panel-hdr h3 {
            font-size: .95rem;
            font-weight: 700
        }

        .panel-hdr p {
            font-size: .72rem;
            color: var(--muted)
        }

        .close-btn {
            width: 30px;
            height: 30px;
            border-radius: 7px;
            border: none;
            background: var(--bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .9rem;
            color: var(--muted);
            margin-left: auto;
            transition: .2s
        }

        .close-btn:hover {
            background: var(--danger);
            color: #fff
        }

        .panel-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg2)
        }

        .panel-tab {
            flex: 1;
            padding: .55rem .4rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: .68rem;
            font-weight: 600;
            color: var(--muted);
            transition: .2s;
            text-align: center
        }

        .panel-tab:hover {
            color: var(--primary);
            background: rgba(37, 99, 235, .05)
        }

        .panel-tab.active {
            color: var(--primary);
            background: rgba(37, 99, 235, .08);
            border-bottom: 2px solid var(--primary)
        }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            max-height: 380px
        }

        .tab-ct {
            display: none;
            padding: .75rem
        }

        .tab-ct.active {
            display: block
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: .4rem;
            margin-bottom: .75rem
        }

        .info-box {
            background: var(--bg);
            border-radius: 8px;
            padding: .5rem;
            text-align: center
        }

        .info-box-icon {
            font-size: 1.2rem;
            margin-bottom: .15rem
        }

        .info-box-val {
            font-size: .95rem;
            font-weight: 700;
            color: var(--primary)
        }

        .info-box-lbl {
            font-size: .55rem;
            color: var(--muted)
        }

        .contact-row {
            display: flex;
            align-items: center;
            gap: .5rem;
            padding: .45rem;
            background: var(--bg);
            border-radius: 7px;
            margin-bottom: .35rem
        }

        .contact-row .ci {
            font-size: .95rem
        }

        .contact-row .cl {
            font-size: .55rem;
            color: var(--muted)
        }

        .contact-row .cv {
            font-size: .78rem;
            font-weight: 600
        }

        .data-title {
            font-size: .72rem;
            font-weight: 700;
            margin-bottom: .4rem;
            padding-bottom: .3rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: .3rem
        }

        .dtable {
            width: 100%;
            border-collapse: collapse;
            font-size: .68rem
        }

        .dtable th {
            background: var(--bg);
            padding: .35rem .4rem;
            text-align: left;
            font-weight: 600;
            color: var(--muted);
            border-bottom: 1px solid var(--border)
        }

        .dtable td {
            padding: .35rem .4rem;
            border-bottom: 1px solid var(--border);
            color: var(--text2)
        }

        .dtable tr:hover td {
            background: rgba(37, 99, 235, .03)
        }

        .rate {
            display: inline-block;
            padding: .12rem .35rem;
            background: linear-gradient(135deg, var(--green), var(--cyan));
            color: #fff;
            border-radius: 4px;
            font-weight: 600;
            font-size: .6rem
        }

        .transfer-grid {
            display: flex;
            flex-wrap: wrap;
            gap: .35rem
        }

        .transfer-badge {
            padding: .3rem .5rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: .62rem;
            font-weight: 600;
            color: var(--text2)
        }

        .card-sys {
            display: flex;
            gap: .3rem;
            margin-top: .4rem
        }

        .cbadge {
            padding: .25rem .45rem;
            border-radius: 5px;
            font-size: .6rem;
            font-weight: 700
        }

        .cbadge.humo {
            background: #00a651;
            color: #fff
        }

        .cbadge.uzcard {
            background: #1e3a8a;
            color: #fff
        }

        .cbadge.visa {
            background: #1a1f71;
            color: #fff
        }

        .cbadge.mastercard {
            background: #eb001b;
            color: #fff
        }

        .cbadge.unionpay {
            background: #002e6e;
            color: #fff
        }

        /* MODAL */
        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            backdrop-filter: blur(3px);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: .3s
        }

        .modal-bg.active {
            opacity: 1;
            visibility: visible
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(.92);
            width: 92%;
            max-width: 580px;
            max-height: 80vh;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, .2);
            z-index: 2001;
            opacity: 0;
            visibility: hidden;
            transition: .3s;
            display: flex;
            flex-direction: column
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1)
        }

        .modal-head {
            display: flex;
            align-items: center;
            gap: .5rem;
            padding: .7rem .9rem;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: #fff;
            border-radius: 14px 14px 0 0;
            flex-shrink: 0
        }

        .modal-head h3 {
            font-size: .9rem;
            font-weight: 700;
            flex: 1
        }

        .modal-date {
            font-size: .55rem;
            background: rgba(255, 255, 255, .2);
            padding: .15rem .4rem;
            border-radius: 12px
        }

        .modal-body {
            padding: .7rem;
            flex: 1;
            overflow-y: auto
        }

        .msect {
            margin-bottom: .5rem;
            padding: .5rem;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border)
        }

        .msect:last-child {
            margin-bottom: 0
        }

        .msect-title {
            font-size: .65rem;
            font-weight: 700;
            margin-bottom: .4rem;
            padding-bottom: .25rem;
            border-bottom: 1px solid var(--border)
        }

        .mgrid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: .3rem
        }

        .mstat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: .3rem .2rem;
            background: var(--bg2);
            border-radius: 5px;
            text-align: center
        }

        .mval {
            font-size: .82rem;
            font-weight: 800;
            line-height: 1.1
        }

        .mval.blue {
            color: var(--primary)
        }

        .mval.green {
            color: var(--green)
        }

        .mval.orange {
            color: var(--orange)
        }

        .mval.purple {
            color: var(--purple)
        }

        .mval.cyan {
            color: var(--cyan)
        }

        .mval.pink {
            color: var(--pink)
        }

        .mlbl {
            font-size: .48rem;
            color: var(--muted);
            margin-top: .1rem
        }

        .compact-rows {
            display: flex;
            flex-direction: column;
            gap: .15rem
        }

        .crow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: .6rem;
            color: var(--text2);
            padding: .12rem 0;
            border-bottom: 1px dashed var(--border)
        }

        .crow:last-child {
            border-bottom: none
        }

        .crow .hl {
            color: var(--green);
            font-weight: 600
        }

        .modal-2col {
            display: flex;
            gap: .5rem
        }

        .modal-2col>.msect {
            flex: 1
        }

        /* VOICE PANEL */
        .voice-panel {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 340px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .15);
            z-index: 700;
            display: none;
            flex-direction: column;
            overflow: hidden
        }

        .voice-panel.active {
            display: flex
        }

        /* GESTURE CONTROL PANEL */
        .gesture-panel {
            position: fixed;
            top: 72px;
            right: 60px;
            width: 320px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, .15);
            z-index: 800;
            display: none;
            flex-direction: column;
            overflow: hidden
        }

        .gesture-panel.active {
            display: flex
        }

        .gesture-head {
            padding: .6rem .8rem;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: #fff;
            display: flex;
            align-items: center;
            gap: .5rem
        }

        .gesture-head h4 {
            font-size: .85rem;
            font-weight: 700;
            flex: 1
        }

        .gesture-status {
            font-size: .6rem;
            padding: .2rem .5rem;
            background: rgba(255, 255, 255, .2);
            border-radius: 10px
        }

        .gesture-status.active {
            background: #22c55e
        }

        .gesture-video-wrap {
            position: relative;
            background: #000;
            aspect-ratio: 4/3
        }

        .gesture-video-wrap video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1)
        }

        .gesture-video-wrap canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1)
        }

        .gesture-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .7);
            color: #fff;
            font-size: .8rem;
            text-align: center;
            padding: 1rem
        }

        .gesture-overlay.hidden {
            display: none
        }

        .gesture-info {
            padding: .6rem;
            background: var(--bg);
            border-top: 1px solid var(--border)
        }

        .gesture-current {
            display: flex;
            align-items: center;
            gap: .5rem;
            margin-bottom: .4rem
        }

        .gesture-icon {
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .gesture-name {
            font-size: .9rem;
            font-weight: 700
        }

        .gesture-action {
            font-size: .7rem;
            color: var(--muted)
        }

        .gesture-hints {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: .35rem;
            margin-top: .5rem
        }

        .gesture-hint {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: .35rem .2rem;
            text-align: center;
            font-size: .5rem;
            color: var(--text2);
            transition: .2s
        }

        .gesture-hint-icon {
            font-size: .9rem;
            margin-bottom: .1rem
        }

        .gesture-hint.active {
            border-color: var(--primary);
            background: rgba(37, 99, 235, .1)
        }

        .gesture-btns {
            display: flex;
            gap: .3rem;
            padding: .6rem;
            border-top: 1px solid var(--border)
        }

        .gesture-btn {
            flex: 1;
            padding: .5rem;
            border: none;
            border-radius: 8px;
            font-size: .7rem;
            font-weight: 600;
            cursor: pointer;
            transition: .2s
        }

        .gesture-btn.primary {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: #fff
        }

        .gesture-btn.secondary {
            background: var(--bg);
            color: var(--text2);
            border: 1px solid var(--border)
        }

        .gesture-btn:hover {
            transform: scale(1.02)
        }

        .voice-head {
            padding: .75rem;
            background: linear-gradient(135deg, #dc2626, #ea580c);
            color: #fff;
            display: flex;
            align-items: center;
            gap: .5rem
        }

        .voice-ico {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, .2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            animation: none
        }

        .voice-ico.listening {
            animation: vpulse 1.5s infinite
        }

        .voice-ico.speaking {
            animation: vpulse 1s infinite
        }

        @keyframes vpulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1
            }

            50% {
                transform: scale(1.15);
                opacity: .8
            }
        }

        .voice-head h4 {
            font-size: .85rem;
            font-weight: 700;
            flex: 1
        }

        .voice-head .vstat {
            font-size: .65rem;
            opacity: .8
        }

        .voice-body {
            padding: .75rem;
            max-height: 200px;
            overflow-y: auto
        }

        .vtranscript {
            font-size: .8rem;
            color: var(--text2);
            margin-bottom: .5rem;
            min-height: 1.2rem
        }

        .vresponse {
            font-size: .78rem;
            color: var(--text);
            background: var(--bg);
            padding: .5rem;
            border-radius: 8px;
            display: none;
            margin-bottom: .5rem
        }

        .vresponse.active {
            display: block
        }

        .vsuggestions {
            display: flex;
            flex-wrap: wrap;
            gap: .3rem;
            margin-bottom: .5rem
        }

        .vsug-btn {
            padding: .3rem .5rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            font-size: .62rem;
            cursor: pointer;
            transition: .2s;
            color: var(--text2)
        }

        .vsug-btn:hover {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary)
        }

        .voice-btns {
            display: flex;
            gap: .4rem;
            padding: .75rem;
            border-top: 1px solid var(--border)
        }

        .vmain-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .4rem;
            padding: .7rem;
            background: linear-gradient(135deg, #dc2626, #ea580c);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: .85rem;
            font-weight: 600;
            cursor: pointer;
            transition: .2s
        }

        .vmain-btn:hover {
            transform: scale(1.02)
        }

        .vmain-btn.listening {
            background: linear-gradient(135deg, #16a34a, #059669)
        }

        .vstop-btn {
            padding: .7rem .8rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text2);
            font-size: .75rem;
            cursor: pointer;
            transition: .2s
        }

        .vstop-btn:hover {
            background: var(--danger);
            color: #fff
        }

        /* MARKER */
        .marker-wrap {
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 3px 10px rgba(0, 0, 0, .3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform .2s
        }

        .marker-wrap:hover {
            transform: scale(1.15)
        }

        /* POPUP */
        .leaflet-popup-content-wrapper {
            background: var(--bg2);
            color: var(--text);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .12);
            border: 1px solid var(--border)
        }

        .leaflet-popup-tip {
            background: var(--bg2)
        }

        .leaflet-popup-content {
            margin: .65rem;
            font-family: 'Inter', sans-serif
        }

        .popup-box h4 {
            font-size: .88rem;
            font-weight: 700;
            margin-bottom: .25rem;
            display: flex;
            align-items: center;
            gap: .25rem
        }

        .popup-box p {
            font-size: .72rem;
            color: var(--text2);
            margin-bottom: .12rem
        }

        .popup-box .hours {
            color: var(--green);
            font-weight: 600
        }

        /* SIDEBAR TOGGLE (mobile) */
        .sidebar-toggle {
            display: none;
            position: fixed;
            left: 1rem;
            bottom: 1rem;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 500;
            box-shadow: 0 4px 12px rgba(37, 99, 235, .35);
            align-items: center;
            justify-content: center
        }

        /* RESPONSIVE */
        @media(max-width:900px) {
            .sidebar {
                transform: translateX(-100%)
            }

            .sidebar.open {
                transform: translateX(0)
            }

            #map {
                left: 0
            }

            .map-legend {
                left: 1rem
            }

            .bank-panel {
                left: .5rem;
                right: .5rem;
                width: auto
            }

            .sidebar-toggle {
                display: flex
            }
        }

        @media(max-width:600px) {
            .logo p {
                display: none
            }

            .stat-grid {
                gap: .2rem;
                padding: .35rem
            }

            .stat-val {
                font-size: .78rem
            }

            .voice-panel {
                left: .5rem;
                right: .5rem;
                width: auto
            }
        }

        ::-webkit-scrollbar {
            width: 4px
        }

        ::-webkit-scrollbar-track {
            background: var(--bg)
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px
        }

        /* ====== SENSORLI EKRAN SIMULYATSIYA ====== */

        /* Touch Ripple Effect */
        .touch-ripple {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            animation: rippleExpand .6s ease-out forwards
        }

        @keyframes rippleExpand {
            0% {
                width: 0;
                height: 0;
                opacity: .7;
                border: 3px solid var(--primary);
                background: rgba(37, 99, 235, .25)
            }

            50% {
                opacity: .4
            }

            100% {
                width: 120px;
                height: 120px;
                opacity: 0;
                border: 2px solid transparent;
                background: transparent
            }
        }

        /* Touch Trail (barmoq izi) */
        .touch-trail {
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(139, 92, 246, .5);
            pointer-events: none;
            z-index: 9998;
            transition: opacity .4s;
            opacity: 0
        }

        .touch-trail.visible {
            opacity: 1
        }

        /* Hover Glow on Interactive Elements */
        .gesture-hover-glow {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, .35), 0 0 20px rgba(37, 99, 235, .15) !important;
            transform: scale(1.02);
            transition: all .15s ease-out !important;
        }

        .loc-card.gesture-hover-glow {
            border-color: var(--primary) !important;
            background: linear-gradient(135deg, rgba(37, 99, 235, .04), rgba(124, 58, 237, .04));
        }

        .chip.gesture-hover-glow,
        .map-btn.gesture-hover-glow,
        .ctrl-btn.gesture-hover-glow {
            background: rgba(37, 99, 235, .15) !important;
            color: var(--primary) !important;
        }

        .marker-wrap.gesture-hover-glow {
            transform: scale(1.25) !important;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, .4), 0 6px 20px rgba(0, 0, 0, .2) !important;
        }

        /* Gesture cursor states */
        .gesture-cursor-tap {
            animation: cursorTap .3s ease-out
        }

        @keyframes cursorTap {
            0% {
                transform: translate(-50%, -50%) scale(1)
            }

            50% {
                transform: translate(-50%, -50%) scale(.5)
            }

            100% {
                transform: translate(-50%, -50%) scale(1)
            }
        }

        /* Long Press pulse ring */
        .long-press-ring {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            border: 3px solid rgba(249, 115, 22, .6);
            width: 0;
            height: 0;
            opacity: 0;
            transform: translate(-50%, -50%);
            transition: width .8s ease-out, height .8s ease-out, opacity .3s;
        }

        .long-press-ring.filling {
            width: 80px;
            height: 80px;
            opacity: 1;
            border-color: rgba(249, 115, 22, .8);
            background: rgba(249, 115, 22, .08);
        }

        .long-press-ring.done {
            width: 90px;
            height: 90px;
            opacity: 0;
            border-color: #22c55e;
            background: rgba(34, 197, 94, .15);
        }

        /* Rotate indicator */
        .rotate-indicator {
            position: fixed;
            pointer-events: none;
            z-index: 9998;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px dashed rgba(168, 85, 247, .5);
            transform: translate(-50%, -50%);
            display: none;
            transition: transform .1s linear
        }

        .rotate-indicator.active {
            display: block
        }

        .rotate-indicator::after {
            content: 'üîÑ';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: .8rem
        }

        /* Scroll indicator arrows */
        .scroll-arrows {
            position: fixed;
            z-index: 9998;
            pointer-events: none;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: .7rem;
            color: var(--primary);
            opacity: .7
        }

        .scroll-arrows.active {
            display: flex
        }

        /* Swipe indicator */
        .swipe-indicator {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            font-size: 2rem;
            opacity: 0;
            transition: opacity .2s
        }

        .swipe-indicator.show {
            opacity: .8
        }

        #swipeLeft {
            left: 10px;
            top: 50%;
            transform: translateY(-50%)
        }

        #swipeRight {
            right: 10px;
            top: 50%;
            transform: translateY(-50%)
        }

        #swipeUp {
            left: 50%;
            top: 10px;
            transform: translateX(-50%)
        }

        #swipeDown {
            left: 50%;
            bottom: 10px;
            transform: translateX(-50%)
        }

        /* Touch mode badge */
        .touch-mode-badge {
            position: fixed;
            bottom: 12px;
            right: 12px;
            z-index: 9000;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: .7rem;
            font-weight: 600;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: #fff;
            box-shadow: 0 4px 15px rgba(139, 92, 246, .4);
            display: none;
            align-items: center;
            gap: 6px;
            animation: badgePulse 2s infinite
        }

        .touch-mode-badge.active {
            display: flex
        }

        @keyframes badgePulse {

            0%,
            100% {
                box-shadow: 0 4px 15px rgba(139, 92, 246, .4)
            }

            50% {
                box-shadow: 0 4px 25px rgba(139, 92, 246, .6)
            }
        }

        /* Proximity indicator for nearby elements */
        .proximity-ring {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9997;
            border: 2px dashed rgba(139, 92, 246, .2);
            width: 120px;
            height: 120px;
            transform: translate(-50%, -50%);
            display: none;
            transition: all .2s
        }

        /* Scroll indicator for list */
        .scroll-indicator {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            border-radius: 2px;
            background: var(--primary);
            opacity: 0;
            transition: opacity .3s;
            z-index: 100
        }

        .scroll-indicator.top {
            top: 0
        }

        .scroll-indicator.bottom {
            bottom: 0
        }

        .scroll-indicator.active {
            opacity: .6
        }
    </style>
</head>

<body data-theme="light">

    <!-- HEADER -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üè¶</div>
            <div>
                <h1>Angren shahri</h1>
                <p>Moliyaviy xarita</p>
            </div>
        </div>
        <div class="hfilters" id="hFilters">
            <button class="chip active" onclick="filterCat('all',this)">üìç Barchasi</button>
            <button class="chip" onclick="filterCat('bank',this)">üèõÔ∏è Banklar</button>
            <button class="chip" onclick="filterCat('atm',this)">üí≥ Bankomatlar</button>
            <button class="chip" onclick="filterCat('exchange',this)">üí± AvtoVASH</button>
            <button class="chip" onclick="filterCat('market',this)">üõí Bozorlar</button>
            <button class="chip" onclick="filterCat('employer',this)">üè≠ Korxonalar</button>
            <button class="chip" onclick="filterCat('infra',this)">üèóÔ∏è Infra</button>
        </div>
        <div class="hright">
            <div class="ctrl-group"><button class="ctrl-btn" id="btnGesture"
                    onclick="toggleGesture()">üñêÔ∏è</button><button class="ctrl-btn" id="btnVoice"
                    onclick="toggleVoice()">üé§</button></div>
            <div class="ctrl-group">
                <button class="ctrl-btn active" id="btnLight" onclick="setTheme('light')">‚òÄÔ∏è</button>
                <button class="ctrl-btn" id="btnDark" onclick="setTheme('dark')">üåô</button>
                <button class="ctrl-btn" id="btnSat" onclick="setTheme('satellite')">üõ∞Ô∏è</button>
            </div>
            <div class="date-badge"><small>Ma'lumotlar</small><b>01.11.2025</b></div>
        </div>
    </header>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-val blue">182.4K</div>
                <div class="stat-lbl">Aholi</div>
            </div>
            <div class="stat-item">
                <div class="stat-val green">41</div>
                <div class="stat-lbl">MFY</div>
            </div>
            <div class="stat-item">
                <div class="stat-val orange">13</div>
                <div class="stat-lbl">Bank</div>
            </div>
            <div class="stat-item">
                <div class="stat-val purple">66</div>
                <div class="stat-lbl">Bankomat</div>
            </div>
            <div class="stat-item">
                <div class="stat-val cyan">3 024</div>
                <div class="stat-lbl">Terminal</div>
            </div>
            <div class="stat-item">
                <div class="stat-val pink">273K</div>
                <div class="stat-lbl">Karta</div>
            </div>
        </div>
        <div class="info-btn-wrap"><button class="info-btn" onclick="openModal()">üìä Umumiy ma'lumotlar
                <span>‚ñº</span></button></div>
        <div class="search-wrap">
            <div class="search-box"><span>üîç</span><input type="text" id="searchBox" placeholder="Qidirish..."
                    oninput="searchLocs()"></div>
            <div class="mfilters">
                <button class="chip active" onclick="filterCat('all',this)">üìç Barchasi</button>
                <button class="chip" onclick="filterCat('bank',this)">üèõÔ∏è Banklar</button>
                <button class="chip" onclick="filterCat('atm',this)">üí≥ ATM</button>
                <button class="chip" onclick="filterCat('exchange',this)">üí± AvtoVASH</button>
                <button class="chip" onclick="filterCat('market',this)">üõí Bozor</button>
                <button class="chip" onclick="filterCat('employer',this)">üè≠ Korxona</button>
                <button class="chip" onclick="filterCat('infra',this)">üèóÔ∏è Infra</button>
            </div>
        </div>
        <div class="loc-list" id="locList"></div>
    </aside>

    <button class="sidebar-toggle" onclick="toggleSidebar()">üìã</button>

    <!-- MAP -->
    <div id="map"></div>

    <!-- MAP CONTROLS -->
    <div class="map-ctrls">
        <button class="map-btn" onclick="map.zoomIn()">‚ûï</button>
        <button class="map-btn" onclick="map.zoomOut()">‚ûñ</button>
        <button class="map-btn" onclick="map.setView([41.0177,70.0821],14)">üè†</button>
    </div>

    <!-- LEGEND -->
    <div class="map-legend">
        <div class="legend-head">Belgilar</div>
        <div class="legend-row">
            <div class="legend-dot" style="background:#2563eb"></div> Banklar (13)
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background:#00a651"></div> ATM Humo (30)
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background:#1e3a8a"></div> ATM Uzcard (33)
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background:#7c3aed"></div> ATM ADM (3)
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background:#0891b2"></div> AvtoVASH (8)
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background:#d97706"></div> Bozorlar (4)
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background:#7c3aed"></div> Korxonalar (5)
        </div>
        <div class="legend-row">
            <div class="legend-dot" style="background:#db2777"></div> Infra (95+)
        </div>
        <div class="legend-div"></div>
        <div class="legend-info">
            <div>üë• 182 429 aholi</div>
            <div>üèòÔ∏è 41 mahalla</div>
            <div>üí≥ 66 bankomat</div>
            <div>üí± 8 AvtoVASH</div>
        </div>
    </div>

    <!-- BANK PANEL -->
    <div class="bank-panel" id="bankPanel">
        <div class="panel-hdr">
            <div class="panel-ico" id="pIcon">üèõÔ∏è</div>
            <div>
                <h3 id="pName">‚Äî</h3>
                <p id="pSub">‚Äî</p>
            </div>
            <button class="close-btn" onclick="closePanel()">‚úï</button>
        </div>
        <div class="panel-tabs" id="pTabs">
            <button class="panel-tab active" onclick="switchTab('info',this)">‚ÑπÔ∏è Umumiy</button>
            <button class="panel-tab" onclick="switchTab('credits',this)">üí≥ Kreditlar</button>
            <button class="panel-tab" onclick="switchTab('deposits',this)">üí∞ Omonatlar</button>
            <button class="panel-tab" onclick="switchTab('transfers',this)">üí∏ O'tkazmalar</button>
        </div>
        <div class="panel-body">
            <div class="tab-ct active" id="tab-info"></div>
            <div class="tab-ct" id="tab-credits"></div>
            <div class="tab-ct" id="tab-deposits"></div>
            <div class="tab-ct" id="tab-transfers"></div>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-bg" id="modalBg" onclick="closeModal()"></div>
    <div class="modal" id="modal" onclick="event.stopPropagation()">
        <div class="modal-head">
            <h3>üìä Angren shahri ‚Äî Umumiy ma'lumotlar</h3>
            <span class="modal-date">01.11.2025</span>
            <button class="close-btn" style="background:rgba(255,255,255,.2);color:#fff"
                onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="msect">
                <div class="msect-title">üèôÔ∏è Asosiy ko'rsatkichlar</div>
                <div class="mgrid">
                    <div class="mstat">
                        <div class="mval blue">182 429</div>
                        <div class="mlbl">Aholi</div>
                    </div>
                    <div class="mstat">
                        <div class="mval green">41</div>
                        <div class="mlbl">MFY</div>
                    </div>
                    <div class="mstat">
                        <div class="mval orange">160.7</div>
                        <div class="mlbl">km¬≤</div>
                    </div>
                    <div class="mstat">
                        <div class="mval purple">54 945</div>
                        <div class="mlbl">Oilalar</div>
                    </div>
                    <div class="mstat">
                        <div class="mval cyan">46 862</div>
                        <div class="mlbl">Xonadon</div>
                    </div>
                    <div class="mstat">
                        <div class="mval pink">6.7%</div>
                        <div class="mlbl">Ishsizlik</div>
                    </div>
                </div>
            </div>
            <div class="msect">
                <div class="msect-title">üè¶ Moliyaviy infratuzilma</div>
                <div class="mgrid">
                    <div class="mstat">
                        <div class="mval blue">10</div>
                        <div class="mlbl">Bank turi</div>
                    </div>
                    <div class="mstat">
                        <div class="mval green">13</div>
                        <div class="mlbl">Filial</div>
                    </div>
                    <div class="mstat">
                        <div class="mval orange">66</div>
                        <div class="mlbl">Bankomat</div>
                    </div>
                    <div class="mstat">
                        <div class="mval purple">3 024</div>
                        <div class="mlbl">Terminal</div>
                    </div>
                    <div class="mstat">
                        <div class="mval cyan">273 320</div>
                        <div class="mlbl">Karta</div>
                    </div>
                    <div class="mstat">
                        <div class="mval pink">191 112</div>
                        <div class="mlbl">Mijozlar</div>
                    </div>
                </div>
            </div>
            <div class="msect">
                <div class="msect-title">üèóÔ∏è Infratuzilma</div>
                <div class="mgrid">
                    <div class="mstat">
                        <div class="mval blue">43</div>
                        <div class="mlbl">Maktab</div>
                    </div>
                    <div class="mstat">
                        <div class="mval green">1</div>
                        <div class="mlbl">OTM</div>
                    </div>
                    <div class="mstat">
                        <div class="mval orange">15</div>
                        <div class="mlbl">Shifoxona</div>
                    </div>
                    <div class="mstat">
                        <div class="mval purple">6</div>
                        <div class="mlbl">Supermarket</div>
                    </div>
                    <div class="mstat">
                        <div class="mval cyan">12</div>
                        <div class="mlbl">Metan GNS</div>
                    </div>
                    <div class="mstat">
                        <div class="mval pink">3</div>
                        <div class="mlbl">Bozor</div>
                    </div>
                </div>
            </div>
            <div class="msect">
                <div class="msect-title">üí∞ Moliyaviy oqim</div>
                <div class="compact-rows">
                    <div class="crow"><span>Kartaga kirim</span><span class="hl">356.2 mlrd so'm</span></div>
                    <div class="crow"><span>Naqdlashtirilgan</span><span class="hl">77.7 mlrd so'm</span></div>
                    <div class="crow"><span>Terminal tushumi</span><span class="hl">102.8 mlrd so'm</span></div>
                    <div class="crow"><span>Kreditlar</span><span class="hl">8 139 ta / 367.2 mlrd</span></div>
                    <div class="crow"><span>Omonatlar</span><span class="hl">1 607 ta / 157.5 mlrd</span></div>
                </div>
            </div>
            <div class="modal-2col">
                <div class="msect">
                    <div class="msect-title">üí∏ Xalqaro o'tkazmalar</div>
                    <div class="compact-rows">
                        <div class="crow"><span>Kirim</span><span class="hl">3.34 mln $</span></div>
                        <div class="crow"><span>Chiqim</span><span class="hl">460 ming $</span></div>
                    </div>
                </div>
                <div class="msect">
                    <div class="msect-title">üí± Valyuta ayirboshlash</div>
                    <div class="compact-rows">
                        <div class="crow"><span>Sotib olingan</span><span class="hl">6.17 mln $</span></div>
                        <div class="crow"><span>Sotilgan</span><span class="hl">5.29 mln $</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VOICE PANEL -->
    <div class="voice-panel" id="voicePanel">
        <div class="voice-head">
            <div class="voice-ico" id="voiceIco">üé§</div>
            <div>
                <h4>Ovozli yordamchi</h4>
                <div class="vstat" id="voiceStat">Gapiring...</div>
            </div>
            <button class="close-btn" style="background:rgba(255,255,255,.2);color:#fff"
                onclick="closeVoice()">‚úï</button>
        </div>
        <div class="voice-body">
            <div class="vtranscript" id="vTranscript"></div>
            <div class="vresponse" id="vResponse"></div>
            <div class="vsuggestions">
                <button class="vsug-btn" onclick="askVoice('Xalq banki')">üèõÔ∏è Xalq banki</button>
                <button class="vsug-btn" onclick="askVoice('Ipoteka bank')">üèõÔ∏è Ipoteka bank</button>
                <button class="vsug-btn" onclick="askVoice('Hamkorbank')">üèõÔ∏è Hamkorbank</button>
                <button class="vsug-btn" onclick="askVoice('Xalq banki bankomatlar')">üí≥ Xalq ATM</button>
                <button class="vsug-btn" onclick="askVoice('barcha bankomatlar')">üí≥ Bankomatlar</button>
                <button class="vsug-btn" onclick="askVoice('mehmonxonalar')">üè® Mehmonxonalar</button>
                <button class="vsug-btn" onclick="askVoice('yoqilgi stansiyalari')">‚õΩ Yoqilg'i</button>
                <button class="vsug-btn" onclick="askVoice('savdo markazlari')">üõí Savdo</button>
                <button class="vsug-btn" onclick="askVoice('bozorlar')">üõçÔ∏è Bozorlar</button>
                <button class="vsug-btn" onclick="askVoice('korxonalar')">üè≠ Korxonalar</button>
                <button class="vsug-btn" onclick="askVoice('shifoxonalar')">üè• Shifoxona</button>
                <button class="vsug-btn" onclick="askVoice('barchasini korsat')">üìç Barchasi</button>
            </div>
        </div>
        <div class="voice-btns">
            <button class="vmain-btn" id="vMainBtn" onclick="toggleListening()">üé§ <span
                    id="vBtnText">Gapiring</span></button>
            <button class="vstop-btn" onclick="stopSpeaking()">‚èπÔ∏è To'xtat</button>
        </div>
    </div>

    <!-- GESTURE CONTROL PANEL -->
    <div class="gesture-panel" id="gesturePanel">
        <div class="gesture-head">
            <span>üñêÔ∏è</span>
            <h4>Qo'l jestlari</h4>
            <span class="gesture-status" id="gestureStatus">O'chiq</span>
            <button class="close-btn" style="background:rgba(255,255,255,.2);color:#fff;margin-left:auto"
                onclick="closeGesture()">‚úï</button>
        </div>
        <div class="gesture-video-wrap">
            <video id="gestureVideo" autoplay playsinline></video>
            <canvas id="gestureCanvas"></canvas>
            <div class="gesture-overlay" id="gestureOverlay">
                <div>üì∑ Kamerani yoqish uchun<br><b>"Boshlash"</b> tugmasini bosing</div>
            </div>
        </div>
        <div class="gesture-info">
            <div class="gesture-current">
                <div class="gesture-icon" id="currentGestureIcon">‚úã</div>
                <div>
                    <div class="gesture-name" id="currentGestureName">Kutilmoqda...</div>
                    <div class="gesture-action" id="currentGestureAction">Qo'lingizni ko'rsating</div>
                </div>
            </div>
            <div class="gesture-hints">
                <div class="gesture-hint" id="hint-tap">
                    <div class="gesture-hint-icon">ü§è</div>Chimchilash = Bosish
                </div>
                <div class="gesture-hint" id="hint-swipe">
                    <div class="gesture-hint-icon">‚úä‚Üí</div>Musht = Surish
                </div>
                <div class="gesture-hint" id="hint-twohands">
                    <div class="gesture-hint-icon">ü§≤</div>2 qo'l = Zoom
                </div>
                <div class="gesture-hint" id="hint-longpress">
                    <div class="gesture-hint-icon">ü§è‚è≥</div>Ushlab turish
                </div>
                <div class="gesture-hint" id="hint-pinch">
                    <div class="gesture-hint-icon">üëç</div>Bosh barmoq = Bosish
                </div>
            </div>
        </div>
        <div class="gesture-btns">
            <button class="gesture-btn primary" id="gestureStartBtn" onclick="toggleGestureCamera()">‚ñ∂Ô∏è
                Boshlash</button>
            <button class="gesture-btn secondary" onclick="closeGesture()">Yopish</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- SENSORLI EKRAN ELEMENTLARI -->
    <div class="swipe-indicator" id="swipeLeft">üëà</div>
    <div class="swipe-indicator" id="swipeRight">üëâ</div>
    <div class="swipe-indicator" id="swipeUp">üëÜ</div>
    <div class="swipe-indicator" id="swipeDown">üëá</div>
    <div class="proximity-ring" id="proximityRing"></div>
    <div class="long-press-ring" id="longPressRing"></div>
    <div class="rotate-indicator" id="rotateIndicator"></div>
    <div class="touch-mode-badge" id="touchBadge">ü§ö Jest boshqaruv rejimi</div>
    <script>
        // ===== BANK DATA =====
        var bankData = {
            "Hayot bank": {
                shortCode: "1195", totalATMs: 0, angrenATMs: 0, angrenBranches: 1, branches: 1, website: "hayotbank.uz",
                credits: [
                    { name: "Ipoteka krediti", rate: "17-22%", term: "20 yil", amount: "1 mlrd" },
                    { name: "Avtokredit", rate: "25-27%", term: "5 yil", amount: "500 mln" },
                    { name: "Iste'mol krediti", rate: "28-32%", term: "3 yil", amount: "100 mln" },
                    { name: "Mikroqarz", rate: "30%", term: "36 oy", amount: "50 mln" },
                    { name: "Biznes kredit", rate: "Individual", term: "60 oy", amount: "Individual" }
                ],
                deposits: [{ name: "Foydali omonat", rate: "20-22%", term: "12-24 oy", min: "100,000" }, { name: "Jamg'arma", rate: "18%", term: "Cheksiz", min: "100,000" }, { name: "Dollar omonat", rate: "4-6%", term: "12-24 oy", min: "$100" }],
                transfers: ["Zolotaya Korona", "MoneyGram", "Western Union", "CONTACT"],
                cards: ["Humo", "Uzcard", "Visa"]
            },
            "Sanoatqurilishbank": {
                shortCode: "1180", totalATMs: 384, angrenATMs: 10, angrenBranches: 1, branches: 46, website: "sqb.uz",
                credits: [
                    { name: "Ipoteka \"Premium\"", rate: "22%", term: "20 yil", amount: "1.5 mlrd" },
                    { name: "Ipoteka \"Imkon\"", rate: "17%", term: "20 yil", amount: "420 mln" },
                    { name: "Avtokredit", rate: "25%", term: "3 yil", amount: "600 mln" },
                    { name: "Kredit karta", rate: "26.9%", term: "48 oy", amount: "100 mln" },
                    { name: "Biznes kredit", rate: "Individual", term: "‚Äî", amount: "Individual" },
                    { name: "Qishloq xo'jaligi", rate: "14%", term: "7 yil", amount: "Individual" }
                ],
                deposits: [{ name: "Green Deposit", rate: "21%", term: "13 oy", min: "100,000" }, { name: "Sarmoya ($)", rate: "7%", term: "18 oy", min: "$100" }, { name: "Ideal ($)", rate: "5%", term: "24 oy", min: "$100" }, { name: "Yevro", rate: "6%", term: "24 oy", min: "‚Ç¨100" }, { name: "Barqaror", rate: "20%", term: "24 oy", min: "500,000" }],
                transfers: ["Western Union", "MoneyGram", "Zolotaya Korona", "RIA", "CONTACT", "Unistream", "Asia Express", "UPT", "Sberbank"],
                cards: ["Humo", "Uzcard", "Visa", "MasterCard"]
            },
            "Xalq banki": {
                shortCode: "1106", totalATMs: 1330, angrenATMs: 17, angrenBranches: 2, branches: 231, website: "xb.uz",
                credits: [
                    { name: "Ipoteka \"Ayollarga ko'mak\"", rate: "18%", term: "20 yil", amount: "416.5 mln" },
                    { name: "Ipoteka \"Farovon Plyus\"", rate: "25%", term: "10 yil", amount: "600 mln" },
                    { name: "Mikroqarz", rate: "25-30%", term: "1-4 yil", amount: "100 mln" },
                    { name: "Avtokredit (UzAuto)", rate: "Individual", term: "5 yil", amount: "Hamkorlik" },
                    { name: "Oilaviy tadbirkorlik", rate: "Individual", term: "‚Äî", amount: "50 mln" }
                ],
                deposits: [{ name: "Standart", rate: "19%", term: "24 oy", min: "100,000" }, { name: "Foizlar oldindan", rate: "20%", term: "12 oy", min: "10 mln" }],
                transfers: ["Western Union", "MoneyGram", "Unistream", "Contact", "Zolotaya Korona", "Asia Express", "UPT"],
                cards: ["Humo", "Visa", "MasterCard", "UnionPay"]
            },
            "Ipoteka bank": {
                shortCode: "1233", totalATMs: 350, angrenATMs: 18, angrenBranches: 2, branches: 40, website: "ipotekabank.uz",
                credits: [
                    { name: "Ipoteka \"Tijorat\"", rate: "22-26%", term: "20 yil", amount: "1 mlrd" },
                    { name: "Ipoteka \"Oson\"", rate: "17%", term: "20 yil", amount: "420 mln" },
                    { name: "Avtokredit R-1", rate: "Individual", term: "5 yil", amount: "824 mln" },
                    { name: "Avtokredit BYD", rate: "0%", term: "5 yil", amount: "Aksiya" },
                    { name: "Iste'mol krediti", rate: "28%", term: "3 yil", amount: "50 mln" }
                ],
                deposits: [{ name: "DaroMax", rate: "21-22%", term: "24 oy", min: "500,000" }, { name: "Jamg'arma", rate: "16%", term: "Cheksiz", min: "15 mln" }, { name: "Talab qilinadigan", rate: "0%", term: "Cheksiz", min: "100,000" }],
                transfers: ["Western Union", "MoneyGram", "Asia Express", "Paysend"],
                cards: ["Humo", "Uzcard", "Visa"]
            },
            "Milliy bank": {
                shortCode: "1344", totalATMs: 257, angrenATMs: 9, angrenBranches: 1, branches: 75, website: "nbu.uz",
                credits: [
                    { name: "Ipoteka", rate: "17%", term: "20 yil", amount: "5 mlrd" },
                    { name: "Avtokredit", rate: "Individual", term: "60 oy", amount: "500 mln" },
                    { name: "Mikroqarz", rate: "Individual", term: "60 oy", amount: "100 mln" },
                    { name: "Ta'lim krediti", rate: "14%", term: "162 oy", amount: "Individual" },
                    { name: "National Green", rate: "Individual", term: "60 oy", amount: "70 mln" }
                ],
                deposits: [{ name: "Jozibali", rate: "20-21%", term: "6 oy", min: "100,000" }, { name: "Dlya vseh", rate: "13-21%", term: "1-18 oy", min: "100,000" }, { name: "Dollar omonat", rate: "3.25-5%", term: "3-18 oy", min: "$100" }, { name: "Oltin omonat", rate: "Oltin narxi", term: "‚Äî", min: "‚Äî" }],
                transfers: ["Western Union", "MoneyGram", "Zolotaya Korona", "Asia Express", "Contact", "Unistream", "Visa Direct", "Mastercard Send"],
                cards: ["Humo", "Uzcard", "Visa", "MasterCard"]
            },
            "Hamkorbank": {
                shortCode: "1256", totalATMs: 290, angrenATMs: 11, angrenBranches: 3, branches: 44, website: "hamkorbank.uz",
                credits: [
                    { name: "Iste'mol krediti", rate: "Individual", term: "‚Äî", amount: "200 mln" },
                    { name: "Ipoteka", rate: "16.5-21.5%", term: "20 yil", amount: "800 mln" },
                    { name: "Auto DAMAS", rate: "0%", term: "3 yil", amount: "Aksiya" },
                    { name: "Auto CHANGAN", rate: "0%", term: "3 yil", amount: "Aksiya" },
                    { name: "Kredit karta", rate: "‚Äî", term: "‚Äî", amount: "50 kun 0%" }
                ],
                deposits: [{ name: "Kafolat", rate: "19-20%", term: "24 oy", min: "100,000" }, { name: "Maqsadli", rate: "18-19%", term: "18 oy", min: "100,000" }, { name: "Foydali ($)", rate: "6.5%", term: "18 oy", min: "$100" }, { name: "Komfort ($)", rate: "6%", term: "15 oy", min: "$100" }],
                transfers: ["Zolotaya Korona", "Sberbank Onlayn", "Visa Direct"],
                cards: ["Humo", "Uzcard", "Visa", "UnionPay"]
            },
            "Uzpromstroybank": {
                shortCode: "1180", totalATMs: 384, angrenATMs: 3, angrenBranches: 1, branches: 46, website: "sqb.uz",
                credits: [
                    { name: "Ipoteka \"Premium\"", rate: "22%", term: "20 yil", amount: "1.5 mlrd" },
                    { name: "Ipoteka \"Imkon\"", rate: "17%", term: "20 yil", amount: "420 mln" },
                    { name: "Avtokredit", rate: "25%", term: "3 yil", amount: "600 mln" },
                    { name: "Kredit karta", rate: "26.9%", term: "48 oy", amount: "100 mln" },
                    { name: "Biznes kredit", rate: "Individual", term: "‚Äî", amount: "Individual" }
                ],
                deposits: [{ name: "Green Deposit", rate: "21%", term: "13 oy", min: "100,000" }, { name: "Sarmoya ($)", rate: "7%", term: "18 oy", min: "$100" }, { name: "Ideal ($)", rate: "5%", term: "24 oy", min: "$100" }, { name: "Yevro", rate: "6%", term: "24 oy", min: "‚Ç¨100" }],
                transfers: ["Western Union", "MoneyGram", "Zolotaya Korona", "RIA", "CONTACT", "Unistream", "Asia Express", "UPT"],
                cards: ["Humo", "Uzcard", "Visa", "MasterCard"]
            },
            "Anorbank": {
                shortCode: "1290", totalATMs: 0, angrenATMs: 0, angrenBranches: 1, branches: 17, website: "anorbank.uz",
                credits: [
                    { name: "Qulay mikroqarz", rate: "27-41%", term: "36 oy", amount: "100 mln" },
                    { name: "BIZNES START 3.0", rate: "Individual", term: "‚Äî", amount: "300 mln" },
                    { name: "Avtokredit 3.0", rate: "Individual", term: "‚Äî", amount: "Individual" },
                    { name: "ANOR Nasiya", rate: "0%", term: "24 oy", amount: "Hamkor do'kon" }
                ],
                deposits: [{ name: "Barqaror", rate: "22%", term: "24 oy", min: "100,000" }, { name: "Milliy har kunlik", rate: "21%", term: "24 oy", min: "100,000" }, { name: "Mustahkam ($)", rate: "6%", term: "24 oy", min: "$100" }, { name: "Qadam ($)", rate: "5%", term: "24 oy", min: "$100" }],
                transfers: ["SWIFT", "UPT", "Astrasend", "MoneySend"],
                cards: ["Humo", "Uzcard", "Visa", "MasterCard"]
            },
            "Kapitalbank": {
                shortCode: "1340", totalATMs: 2118, angrenATMs: 0, angrenBranches: 2, branches: 109, website: "kapitalbank.uz",
                credits: [
                    { name: "Ipoteka (davlat)", rate: "16.5-17.5%", term: "20 yil", amount: "1 mlrd" },
                    { name: "Kapital Avto Plyus", rate: "27.9%", term: "3-5 yil", amount: "600 mln" },
                    { name: "Iste'mol krediti", rate: "Individual", term: "‚Äî", amount: "50 mln" },
                    { name: "Mikroqarz", rate: "28%", term: "3 yil", amount: "100 mln" }
                ],
                deposits: [{ name: "Asosiy omonat", rate: "20.5%", term: "12 oy", min: "100,000" }, { name: "Jamg'arma", rate: "18%", term: "Cheksiz", min: "100,000" }],
                transfers: ["Western Union", "MoneyGram", "Contact", "Unistream", "Zolotaya Korona", "AsiaExpress"],
                cards: ["Humo", "Uzcard", "Visa", "MasterCard", "UnionPay"]
            },
            "Agrobank": {
                shortCode: "1216", totalATMs: 665, angrenATMs: 1, angrenBranches: 1, branches: 171, website: "agrobank.uz",
                credits: [
                    { name: "Ipoteka (yangi bino)", rate: "17-17.5%", term: "20 yil", amount: "420 mln" },
                    { name: "Kichik biznes", rate: "26%", term: "‚Äî", amount: "Individual" },
                    { name: "Mikroqarz", rate: "30%", term: "4 yil", amount: "100 mln" },
                    { name: "Kredit karta", rate: "‚Äî", term: "‚Äî", amount: "100 mln" },
                    { name: "Fermer krediti", rate: "Individual", term: "‚Äî", amount: "Individual" }
                ],
                deposits: [{ name: "Progress", rate: "23%", term: "13 oy", min: "500,000" }, { name: "Komfort", rate: "21-23%", term: "13 oy", min: "500,000" }, { name: "Sandiq", rate: "21%", term: "18 oy", min: "100,000" }, { name: "Baxtli bolalik", rate: "14%", term: "10 yil", min: "100,000" }],
                transfers: ["Agro Express", "Zolotaya Korona", "MoneyGram", "Sberbank"],
                cards: ["Humo", "Uzcard"]
            },
            "Asaka Bank": {
                shortCode: "1152", totalATMs: 163, angrenATMs: 0, angrenBranches: 0, branches: 68, website: "asakabank.uz",
                credits: [
                    { name: "Bizning ipoteka", rate: "17-22%", term: "20 yil", amount: "1 mlrd" },
                    { name: "Avtokredit", rate: "25%", term: "5 yil", amount: "500 mln" },
                    { name: "Iste'mol krediti", rate: "28%", term: "3 yil", amount: "100 mln" },
                    { name: "Mikroqarz (ilova)", rate: "30%", term: "2 yil", amount: "50 mln" },
                    { name: "Ta'lim krediti", rate: "14%", term: "10 yil", amount: "Individual" }
                ],
                deposits: [{ name: "Maksimal foyda", rate: "14-21%", term: "1-24 oy", min: "100,000" }, { name: "Onlayn", rate: "20-21%", term: "13 oy", min: "100,000" }, { name: "Maksimal ($)", rate: "1-5%", term: "1-24 oy", min: "$50" }],
                transfers: ["Kartadan kartaga", "QR to'lov", "Valyuta konvertatsiya"],
                cards: ["Humo", "Uzcard", "Visa"]
            },
            "Mikrokreditbank": {
                shortCode: "1199", totalATMs: 826, angrenATMs: 0, angrenBranches: 0, branches: 73, website: "mkbank.uz",
                credits: [
                    { name: "Avtokredit (birlamchi)", rate: "27%", term: "60 oy", amount: "824 mln" },
                    { name: "Avtokredit Kia/Chery", rate: "0%", term: "60 oy", amount: "Aksiya" },
                    { name: "Ipoteka (Moliya vazir.)", rate: "18%", term: "20 yil", amount: "420 mln" },
                    { name: "Universal ipoteka", rate: "24-26%", term: "20 yil", amount: "1.6 mlrd" },
                    { name: "Mikroqarz", rate: "25-29%", term: "60 oy", amount: "100 mln" },
                    { name: "Mahalla-Biznes", rate: "27-29%", term: "48 oy", amount: "30 mln" },
                    { name: "Birinchi qadam", rate: "27-28%", term: "36 oy", amount: "14.4 mln" },
                    { name: "Ta'lim (ayollar)", rate: "0%", term: "15 yil", amount: "Individual" }
                ],
                deposits: [{ name: "Barakali", rate: "19-20%", term: "24 oy", min: "3 mln" }, { name: "Universal", rate: "20%", term: "24 oy", min: "100,000" }, { name: "FIFA-2026", rate: "19-20%", term: "36 oy", min: "1 mln" }, { name: "FIFA-2026 ($)", rate: "5.5%", term: "36 oy", min: "$1,000" }, { name: "Baxtli bolalik", rate: "14-15%", term: "1-16 yil", min: "100,000" }],
                transfers: ["Western Union", "Zolotaya Korona", "Ria", "MoneyGram", "Asia Express", "Astrasend", "Payporter", "UPT", "KWIKPAY", "Unistream", "CONTACT"],
                cards: ["Humo", "Uzcard"]
            }
        };

        // ===== LOCATIONS (Excel + Yandex Maps: 190 ta) =====
        var data = [
            // ========== BANKLAR (13) ==========
            { id: 1, name: "Hayot bank", nameUz: "Hayot bank", cat: "bank", type: "BXO", addr: "Istiqlol ko'chasi", mfy: "Markaz", lat: 41.011348, lng: 70.085857, hours: "Dsh-Jm 9:00-18:00", bankKey: "Hayot bank", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 2, name: "Anorbank", nameUz: "Anorbank", cat: "bank", type: "Sotuv ofisi", addr: "Amir Temur ko'chasi", mfy: "Markaz", lat: 41.008369, lng: 70.059046, hours: "Dsh-Jm 9:00-18:00", bankKey: "Anorbank", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 3, name: "Kapitalbank", nameUz: "Kapitalbank", cat: "bank", type: "BXO", addr: "Navoiy ko'chasi", mfy: "Markaz", lat: 41.016018, lng: 70.082322, hours: "Dsh-Jm 9:00-18:00", bankKey: "Kapitalbank", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 4, name: "Kapitalbank", nameUz: "Kapitalbank", cat: "bank", type: "BXO", addr: "Navoiy ko'chasi", mfy: "Markaz", lat: 41.014644, lng: 70.083176, hours: "Dsh-Jm 9:00-18:00", bankKey: "Kapitalbank", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 5, name: "Xalq banki", nameUz: "Xalq banki", cat: "bank", type: "BXM", addr: "Navoiy ko'chasi, 7", mfy: "Markaz", lat: 40.995694, lng: 70.065365, hours: "Dsh-Jm 9:00-18:00", bankKey: "Xalq banki", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 6, name: "Milliy bank", nameUz: "Milliy bank", cat: "bank", type: "BXM", addr: "Ohangaron ko'chasi, 1", mfy: "Markaz", lat: 40.997488, lng: 70.070689, hours: "Dsh-Jm 9:00-18:00", bankKey: "Milliy bank", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 7, name: "Hamkorbank", nameUz: "Hamkorbank", cat: "bank", type: "Universal BXO", addr: "Ohangaron ko'chasi, 82", mfy: "Markaz", lat: 41.015655, lng: 70.082913, hours: "Dsh-Jm 9:00-18:00", bankKey: "Hamkorbank", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 8, name: "Ipoteka bank", nameUz: "Ipoteka bank", cat: "bank", type: "Filial", addr: "A. Navoiy ko'chasi, 1", mfy: "Markaz", lat: 40.994492, lng: 70.055262, hours: "Dsh-Jm 9:00-18:00", bankKey: "Ipoteka bank", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 9, name: "Ipoteka bank", nameUz: "Ipoteka bank", cat: "bank", type: "BXM", addr: "A. Navoiy ko'chasi, 1", mfy: "Markaz", lat: 41.005803, lng: 70.076710, hours: "Dsh-Jm 9:00-18:00", bankKey: "Ipoteka bank", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 10, name: "Sanoatqurilishbank", nameUz: "Sanoatqurilishbank", cat: "bank", type: "BXM", addr: "Istiqlol ko'chasi, 3", mfy: "Markaz", lat: 40.908947, lng: 69.808218, hours: "Dsh-Jm 9:00-18:00", bankKey: "Sanoatqurilishbank", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 11, name: "Agrobank", nameUz: "Agrobank", cat: "bank", type: "BXM", addr: "Mustaqillik ko'chasi, 15", mfy: "Markaz", lat: 41.008417, lng: 70.088302, hours: "Dsh-Jm 9:00-18:00", bankKey: "Agrobank", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 12, name: "Hamkorbank", nameUz: "Hamkorbank", cat: "bank", type: "Omad BXM", addr: "Ohangaron ko'chasi, 82", mfy: "Markaz", lat: 41.016672, lng: 70.081882, hours: "Dsh-Jm 9:00-18:00", bankKey: "Hamkorbank", color: "#2563eb", icon: "üèõÔ∏è" },
            { id: 13, name: "Hamkorbank", nameUz: "Hamkorbank", cat: "bank", type: "Markaz BXO", addr: "Ohangaron ko'chasi, 82", mfy: "Markaz", lat: 41.009659, lng: 70.087208, hours: "Dsh-Jm 9:00-18:00", bankKey: "Hamkorbank", color: "#2563eb", icon: "üèõÔ∏è" },
            // ========== BANKOMATLAR (66) ==========
            { id: 27, name: "Sanoatqurilishbank ATM", cat: "atm", type: "Uzcard", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.021490, lng: 70.176070, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 28, name: "Sanoatqurilishbank ATM", cat: "atm", type: "Uzcard", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.022150, lng: 70.184510, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 29, name: "Sanoatqurilishbank ATM", cat: "atm", type: "Uzcard", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 40.996361, lng: 70.062251, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 30, name: "Sanoatqurilishbank ATM", cat: "atm", type: "Uzcard", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.006025, lng: 70.076754, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 31, name: "Sanoatqurilishbank ATM", cat: "atm", type: "Uzcard", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.008630, lng: 70.074620, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 32, name: "Sanoatqurilishbank ATM", cat: "atm", type: "Humo", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.006025, lng: 70.076754, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 33, name: "Sanoatqurilishbank ATM", cat: "atm", type: "Uzcard", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.018210, lng: 70.081310, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 34, name: "Sanoatqurilishbank ATM", cat: "atm", type: "Uzcard", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.012100, lng: 70.084127, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 35, name: "Sanoatqurilishbank ATM", cat: "atm", type: "Uzcard", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.006025, lng: 70.076754, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 36, name: "Sanoatqurilishbank ATM", cat: "atm", type: "Uzcard", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.012650, lng: 70.102780, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 37, name: "Agrobank ATM", cat: "atm", type: "Humo", addr: "Mustaqillik ko'chasi, 15", mfy: "", lat: 40.903740, lng: 69.639432, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 38, name: "Hamkorbank ATM", cat: "atm", type: "Humo", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 41.018278, lng: 70.082359, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 39, name: "Hamkorbank ATM", cat: "atm", type: "Uzcard", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 40.997526, lng: 70.070052, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 40, name: "Hamkorbank ATM", cat: "atm", type: "Uzcard", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 40.997526, lng: 70.070052, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 41, name: "Hamkorbank ATM", cat: "atm", type: "Humo", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 40.990130, lng: 70.053860, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 42, name: "Hamkorbank ATM", cat: "atm", type: "Humo", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 41.018160, lng: 70.082790, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 43, name: "Hamkorbank ATM", cat: "atm", type: "Humo", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 41.017071, lng: 70.082136, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 44, name: "Hamkorbank ATM", cat: "atm", type: "Uzcard", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 41.008339, lng: 70.088187, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 45, name: "Hamkorbank ATM", cat: "atm", type: "ADM", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 40.997526, lng: 70.070052, hours: "24/7", color: "#7c3aed", icon: "üèß" },
            { id: 46, name: "Hamkorbank ATM", cat: "atm", type: "Uzcard", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 41.018278, lng: 70.082359, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 47, name: "Hamkorbank ATM", cat: "atm", type: "Uzcard", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 41.016546, lng: 70.080048, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 48, name: "Hamkorbank ATM", cat: "atm", type: "Uzcard", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 41.007801, lng: 70.089642, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 49, name: "Ipoteka bank ATM", cat: "atm", type: "Uzcard", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 40.972489, lng: 70.040652, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 50, name: "Ipoteka bank ATM", cat: "atm", type: "Humo", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.034185, lng: 70.068324, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 51, name: "Ipoteka bank ATM", cat: "atm", type: "Humo", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.015739, lng: 70.082447, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 52, name: "Ipoteka bank ATM", cat: "atm", type: "Humo", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 40.996353, lng: 70.062203, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 53, name: "Ipoteka bank ATM", cat: "atm", type: "Humo", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.007603, lng: 70.088851, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 54, name: "Ipoteka bank ATM", cat: "atm", type: "Humo", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.018591, lng: 70.082709, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 55, name: "Ipoteka bank ATM", cat: "atm", type: "Humo", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.015227, lng: 70.091149, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 56, name: "Ipoteka bank ATM", cat: "atm", type: "Humo", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 40.990410, lng: 70.102850, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 57, name: "Ipoteka bank ATM", cat: "atm", type: "Humo", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.026810, lng: 70.080310, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 58, name: "Ipoteka bank ATM", cat: "atm", type: "Humo", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.015739, lng: 70.082447, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 59, name: "Ipoteka bank ATM", cat: "atm", type: "Uzcard", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.011748, lng: 70.085508, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 60, name: "Ipoteka bank ATM", cat: "atm", type: "Uzcard", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.015739, lng: 70.082447, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 61, name: "Ipoteka bank ATM", cat: "atm", type: "Uzcard", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 40.989730, lng: 70.074860, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 62, name: "Ipoteka bank ATM", cat: "atm", type: "Uzcard", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.033540, lng: 70.079940, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 63, name: "Ipoteka bank ATM", cat: "atm", type: "Uzcard", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.015739, lng: 70.082447, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 64, name: "Ipoteka bank ATM", cat: "atm", type: "Uzcard", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 40.994544, lng: 70.055235, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 65, name: "Ipoteka bank ATM", cat: "atm", type: "Uzcard", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.001960, lng: 70.121505, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 66, name: "Ipoteka bank ATM", cat: "atm", type: "Uzcard", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.010840, lng: 70.076670, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 67, name: "Milliy bank ATM", cat: "atm", type: "Humo", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 41.040865, lng: 70.092424, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 68, name: "Milliy bank ATM", cat: "atm", type: "Humo", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 41.018603, lng: 70.082619, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 69, name: "Milliy bank ATM", cat: "atm", type: "Uzcard", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 41.018603, lng: 70.082645, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 70, name: "Milliy bank ATM", cat: "atm", type: "Humo", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 41.018551, lng: 70.082930, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 71, name: "Milliy bank ATM", cat: "atm", type: "Humo", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 41.018551, lng: 70.082930, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 72, name: "Milliy bank ATM", cat: "atm", type: "Uzcard", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 40.994338, lng: 70.058417, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 73, name: "Milliy bank ATM", cat: "atm", type: "Uzcard", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 40.995517, lng: 70.065361, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 74, name: "Milliy bank ATM", cat: "atm", type: "Uzcard", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 40.979093, lng: 70.007804, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 75, name: "Milliy bank ATM", cat: "atm", type: "ADM", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 40.995517, lng: 70.065361, hours: "24/7", color: "#7c3aed", icon: "üèß" },
            { id: 76, name: "Xalq banki ATM", cat: "atm", type: "Humo", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.023374, lng: 70.067323, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 77, name: "Xalq banki ATM", cat: "atm", type: "Humo", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.017593, lng: 70.081219, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 78, name: "Xalq banki ATM", cat: "atm", type: "Humo", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.017546, lng: 70.060150, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 79, name: "Xalq banki ATM", cat: "atm", type: "Humo", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.011215, lng: 70.065331, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 80, name: "Xalq banki ATM", cat: "atm", type: "Humo", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.014662, lng: 70.083636, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 81, name: "Xalq banki ATM", cat: "atm", type: "Humo", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.019586, lng: 70.095723, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 82, name: "Xalq banki ATM", cat: "atm", type: "Humo", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.026018, lng: 70.074506, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 83, name: "Xalq banki ATM", cat: "atm", type: "Humo", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.009491, lng: 70.059108, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 84, name: "Xalq banki ATM", cat: "atm", type: "Humo", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.028042, lng: 70.063557, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 85, name: "Xalq banki ATM", cat: "atm", type: "Uzcard", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.028408, lng: 70.137647, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 86, name: "Xalq banki ATM", cat: "atm", type: "Uzcard", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.025846, lng: 70.085980, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 87, name: "Xalq banki ATM", cat: "atm", type: "Uzcard", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.032759, lng: 70.059396, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 88, name: "Xalq banki ATM", cat: "atm", type: "Uzcard", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.014662, lng: 70.083636, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 89, name: "Xalq banki ATM", cat: "atm", type: "Humo", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.010520, lng: 70.064814, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 90, name: "Xalq banki ATM", cat: "atm", type: "Uzcard", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.022852, lng: 70.076614, hours: "24/7", color: "#1e3a8a", icon: "üí≥" },
            { id: 91, name: "Xalq banki ATM", cat: "atm", type: "Humo", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.009491, lng: 70.059108, hours: "24/7", color: "#00a651", icon: "üí≥" },
            { id: 92, name: "Xalq banki ATM", cat: "atm", type: "ADM", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.014662, lng: 70.083636, hours: "24/7", color: "#7c3aed", icon: "üèß" },
            // ========== VALYUTA AYIRBOSHLASH ATM - AvtoVASH (8) ==========
            { id: 112, name: "Ipoteka bank AvtoVASH", cat: "exchange", type: "AvtoVASH", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.015763, lng: 70.082606, hours: "24/7", color: "#0891b2", icon: "üí±" },
            { id: 113, name: "Ipoteka bank AvtoVASH", cat: "exchange", type: "AvtoVASH", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.015763, lng: 70.082606, hours: "24/7", color: "#0891b2", icon: "üí±" },
            { id: 114, name: "Ipoteka bank AvtoVASH", cat: "exchange", type: "AvtoVASH", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 40.972489, lng: 70.040652, hours: "24/7", color: "#0891b2", icon: "üí±" },
            { id: 120, name: "Milliy bank AvtoVASH", cat: "exchange", type: "AvtoVASH", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 40.996177, lng: 70.065197, hours: "24/7", color: "#0891b2", icon: "üí±" },
            { id: 121, name: "Milliy bank AvtoVASH", cat: "exchange", type: "AvtoVASH", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 40.976880, lng: 70.004217, hours: "24/7", color: "#0891b2", icon: "üí±" },
            { id: 122, name: "Xalq banki AvtoVASH", cat: "exchange", type: "AvtoVASH", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.015763, lng: 70.026060, hours: "24/7", color: "#0891b2", icon: "üí±" },
            { id: 123, name: "Hamkorbank AvtoVASH", cat: "exchange", type: "AvtoVASH", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 40.997443, lng: 70.070614, hours: "24/7", color: "#0891b2", icon: "üí±" },
            { id: 124, name: "Hamkorbank AvtoVASH", cat: "exchange", type: "AvtoVASH", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 41.016672, lng: 70.081882, hours: "24/7", color: "#0891b2", icon: "üí±" },
            // ========== BOZORLAR (4) ==========
            { id: 125, name: "Shahar hokimiyati", nameUz: "Shahar hokimiyati", cat: "market", type: "Bozor", addr: "Navoiy ko'chasi, 2", mfy: "", lat: 41.007869, lng: 70.076195, color: "#d97706", icon: "üõí" },
            { id: 126, name: "Angren dexqon bozori", nameUz: "Angren dexqon bozori", cat: "market", type: "Bozor", addr: "Yangi Angren", mfy: "", lat: 41.046622, lng: 70.097493, color: "#d97706", icon: "üõí" },
            { id: 127, name: "Angren buyum bozori", nameUz: "Angren buyum bozori", cat: "market", type: "Bozor", addr: "Yangi Angren", mfy: "", lat: 41.046622, lng: 70.097493, color: "#d97706", icon: "üõí" },
            { id: 128, name: "Angren shahar mol bozori", nameUz: "Angren shahar mol bozori", cat: "market", type: "Bozor", addr: "Bekobod yo'li", mfy: "", lat: 40.994710, lng: 70.113780, color: "#d97706", icon: "üõí" },
            // ========== KORXONALAR (5) ==========
            { id: 129, name: "Yangi Angren IES", nameUz: "Yangi Angren IES", cat: "employer", type: "Korxona", addr: "Toshkent yo'li", mfy: "", lat: 40.926006, lng: 69.821243, emp: 1958, color: "#7c3aed", icon: "üè≠" },
            { id: 130, name: "Eski Angren IES", nameUz: "Eski Angren IES", cat: "employer", type: "Korxona", addr: "Bekobod yo'li", mfy: "", lat: 41.001297, lng: 70.122130, emp: 1211, color: "#7c3aed", icon: "üè≠" },
            { id: 131, name: "‚ÄúO ªzbek ko ªmir‚Äù AJ", nameUz: "‚ÄúO ªzbek ko ªmir‚Äù AJ", cat: "employer", type: "Korxona", addr: "Markaz", mfy: "", lat: 41.007658, lng: 70.075502, emp: 4996, color: "#7c3aed", icon: "üè≠" },
            { id: 132, name: "‚ÄúBirinchi rezina texnika zavodi‚Äù MCHJ", nameUz: "‚ÄúBirinchi rezina texnika zavodi‚Äù MCHJ", cat: "employer", type: "Korxona", addr: "Toshkent yo'li", mfy: "", lat: 40.970977, lng: 70.043324, emp: 1029, color: "#7c3aed", icon: "üè≠" },
            { id: 133, name: "‚ÄúAngren neftbaza‚Äù AJ", nameUz: "‚ÄúAngren neftbaza‚Äù AJ", cat: "employer", type: "Korxona", addr: "Bekobod yo'li", mfy: "", lat: 41.018115, lng: 70.118790, emp: 5000, color: "#7c3aed", icon: "üè≠" },
            // ========== INFRATUZILMA ==========
            // --- Moliya tashkilotlari (13) ---
            { id: 14, name: "Zamin", cat: "infra", type: "Mikromoliya tashkiloti", addr: "Amir Temur ko'chasi", mfy: "", lat: 41.009802, lng: 70.087657, color: "#db2777", icon: "üí∞" },
            { id: 15, name: "Delta", cat: "infra", type: "Mikromoliya tashkiloti", addr: "Ohangaron ko'chasi", mfy: "", lat: 41.000057, lng: 70.061993, color: "#db2777", icon: "üí∞" },
            { id: 16, name: "Delta", cat: "infra", type: "Mikromoliya tashkiloti", addr: "Markaz", mfy: "", lat: 41.008151, lng: 70.076779, color: "#db2777", icon: "üí∞" },
            { id: 17, name: "Agat", cat: "infra", type: "Mikromoliya tashkiloti", addr: "Ohangaron ko'chasi", mfy: "", lat: 41.008418, lng: 70.053167, color: "#db2777", icon: "üí∞" },
            { id: 18, name: "Hurma", cat: "infra", type: "Lombard", addr: "Navoiy ko'chasi", mfy: "", lat: 41.017417, lng: 70.081364, color: "#db2777", icon: "üí∞" },
            { id: 19, name: "Tip-top", cat: "infra", type: "Lombard", addr: "Amir Temur ko'chasi", mfy: "", lat: 41.009556, lng: 70.087993, color: "#db2777", icon: "üí∞" },
            { id: 20, name: "Kafolat", cat: "infra", type: "Sug'urta", addr: "Markaz", mfy: "", lat: 41.009641, lng: 70.079745, color: "#db2777", icon: "üí∞" },
            { id: 21, name: "Kapitalbank", cat: "infra", type: "Sug'urta", addr: "Navoiy ko'chasi", mfy: "", lat: 41.006507, lng: 70.076082, color: "#db2777", icon: "üí∞" },
            { id: 22, name: "Trust", cat: "infra", type: "Sug'urta", addr: "Amir Temur ko'chasi", mfy: "", lat: 41.011017, lng: 70.088042, color: "#db2777", icon: "üí∞" },
            { id: 23, name: "Ishonch", cat: "infra", type: "Nasiya savdo", addr: "Markaz", mfy: "", lat: 41.010005, lng: 70.080706, color: "#db2777", icon: "üí∞" },
            { id: 24, name: "Imkon", cat: "infra", type: "Nasiya savdo", addr: "Navoiy ko'chasi", mfy: "", lat: 41.014841, lng: 70.082478, color: "#db2777", icon: "üí∞" },
            { id: 25, name: "Garant", cat: "infra", type: "Nasiya savdo", addr: "Markaz", mfy: "", lat: 41.011481, lng: 70.076275, color: "#db2777", icon: "üí∞" },
            { id: 26, name: "Idea", cat: "infra", type: "Nasiya savdo", addr: "Navoiy ko'chasi", mfy: "", lat: 41.017480, lng: 70.082084, color: "#db2777", icon: "üí∞" },
            // --- Valyuta ayirboshlash punktlari (17) ---
            { id: 94, name: "Anorbank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Amir Temur ko'chasi", mfy: "", lat: 41.008388, lng: 70.059168, color: "#db2777", icon: "üí±" },
            { id: 95, name: "Ipoteka bank", cat: "infra", type: "Valyuta ayirboshlash", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.015763, lng: 70.082606, color: "#db2777", icon: "üí±" },
            { id: 96, name: "Ipoteka bank", cat: "infra", type: "Valyuta ayirboshlash", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 40.994507, lng: 70.055319, color: "#db2777", icon: "üí±" },
            { id: 97, name: "Ipoteka bank", cat: "infra", type: "Valyuta ayirboshlash", addr: "A. Navoiy ko'chasi, 1", mfy: "", lat: 41.015763, lng: 70.082606, color: "#db2777", icon: "üí±" },
            { id: 99, name: "Milliy bank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 40.996177, lng: 70.065197, color: "#db2777", icon: "üí±" },
            { id: 100, name: "Milliy bank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 40.996177, lng: 70.065197, color: "#db2777", icon: "üí±" },
            { id: 101, name: "Milliy bank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 40.996177, lng: 70.065197, color: "#db2777", icon: "üí±" },
            { id: 102, name: "Milliy bank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Ohangaron ko'chasi, 1", mfy: "", lat: 40.996177, lng: 70.065197, color: "#db2777", icon: "üí±" },
            { id: 103, name: "Sanoatqurilishbank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.006322, lng: 70.076329, color: "#db2777", icon: "üí±" },
            { id: 104, name: "Sanoatqurilishbank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.006322, lng: 70.076329, color: "#db2777", icon: "üí±" },
            { id: 105, name: "Sanoatqurilishbank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.006322, lng: 70.076329, color: "#db2777", icon: "üí±" },
            { id: 106, name: "Sanoatqurilishbank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Istiqlol ko'chasi, 3", mfy: "", lat: 41.006322, lng: 70.076329, color: "#db2777", icon: "üí±" },
            { id: 107, name: "Hayot bank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Istiqlol ko'chasi", mfy: "", lat: 41.011328, lng: 70.086119, color: "#db2777", icon: "üí±" },
            { id: 108, name: "Xalq banki", cat: "infra", type: "Valyuta ayirboshlash", addr: "Navoiy ko'chasi, 7", mfy: "", lat: 41.015763, lng: 70.082606, color: "#db2777", icon: "üí±" },
            { id: 109, name: "Hamkorbank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 40.997443, lng: 70.070614, color: "#db2777", icon: "üí±" },
            { id: 110, name: "Hamkorbank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 41.008260, lng: 70.088345, color: "#db2777", icon: "üí±" },
            { id: 111, name: "Hamkorbank", cat: "infra", type: "Valyuta ayirboshlash", addr: "Ohangaron ko'chasi, 82", mfy: "", lat: 41.016672, lng: 70.081882, color: "#db2777", icon: "üí±" },
            // --- Yoqilg'i stansiyalari (16) ---
            { id: 137, name: "AYOQSH Lukoil", nameUz: "AYOQSH Lukoil", cat: "infra", type: "Yoqilg'i", addr: "Toshkent yo'li", mfy: "", lat: 40.985525, lng: 70.027877, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 138, name: "AYOQSH 1", nameUz: "AYOQSH 1", cat: "infra", type: "Yoqilg'i", addr: "Toshkent yo'li", mfy: "", lat: 40.987373, lng: 70.027868, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 139, name: "AYOQSH Kosko oil", nameUz: "AYOQSH Kosko oil", cat: "infra", type: "Yoqilg'i", addr: "Toshkent yo'li", mfy: "", lat: 40.987073, lng: 70.035964, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 140, name: "AYOQSH 2", nameUz: "AYOQSH 2", cat: "infra", type: "Yoqilg'i", addr: "Toshkent yo'li", mfy: "", lat: 40.989506, lng: 70.040756, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 141, name: "AYOQSH Carvon", nameUz: "AYOQSH Carvon", cat: "infra", type: "Yoqilg'i", addr: "Toshkent yo'li", mfy: "", lat: 40.993114, lng: 70.052384, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 142, name: "AYOQSH 3", nameUz: "AYOQSH 3", cat: "infra", type: "Yoqilg'i", addr: "Toshkent yo'li", mfy: "", lat: 40.999836, lng: 70.050084, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 143, name: "AYOQSH 4", nameUz: "AYOQSH 4", cat: "infra", type: "Yoqilg'i", addr: "Toshkent yo'li", mfy: "", lat: 40.996932, lng: 70.069064, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 144, name: "AYOQSH 5", nameUz: "AYOQSH 5", cat: "infra", type: "Yoqilg'i", addr: "Ohangaron ko'chasi", mfy: "", lat: 41.026584, lng: 70.074362, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 145, name: "AYOQSH 6", nameUz: "AYOQSH 6", cat: "infra", type: "Yoqilg'i", addr: "Yangi Angren", mfy: "", lat: 41.039787, lng: 70.092975, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 146, name: "AYOQSH Angren Neft Biznes", nameUz: "AYOQSH Angren Neft Biznes", cat: "infra", type: "Yoqilg'i", addr: "Bekobod yo'li", mfy: "", lat: 40.996887, lng: 70.096598, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 147, name: "AYOQSH 7", nameUz: "AYOQSH 7", cat: "infra", type: "Yoqilg'i", addr: "Bekobod yo'li", mfy: "", lat: 40.995495, lng: 70.098096, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 148, name: "AYOQSH 8", nameUz: "AYOQSH 8", cat: "infra", type: "Yoqilg'i", addr: "Markaz", mfy: "", lat: 41.006978, lng: 70.091670, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 149, name: "AYOQSH 9", nameUz: "AYOQSH 9", cat: "infra", type: "Yoqilg'i", addr: "Bekobod yo'li", mfy: "", lat: 41.009968, lng: 70.098282, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 150, name: "AYOQSH Yangiyo ªl Metan Gaz", nameUz: "AYOQSH Yangiyo ªl Metan Gaz", cat: "infra", type: "Yoqilg'i", addr: "Bekobod yo'li", mfy: "", lat: 41.026152, lng: 70.136171, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 151, name: "AYOQSH 10", nameUz: "AYOQSH 10", cat: "infra", type: "Yoqilg'i", addr: "Bekobod yo'li", mfy: "", lat: 41.031132, lng: 70.139895, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            { id: 152, name: "AYOQSH 11", nameUz: "AYOQSH 11", cat: "infra", type: "Yoqilg'i", addr: "Bekobod yo'li", mfy: "", lat: 41.021056, lng: 70.185106, hours: "24/7", color: "#db2777", icon: "‚õΩ" },
            // --- Savdo markazlari (16) ---
            { id: 153, name: "Fresh market Angren MCHJ", nameUz: "Fresh market Angren MCHJ", cat: "infra", type: "Savdo", addr: "Navoiy ko'chasi", mfy: "", lat: 41.014323, lng: 70.072993, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 154, name: "Korzinka", nameUz: "Korzinka", cat: "infra", type: "Savdo", addr: "Navoiy ko'chasi, 1", mfy: "", lat: 41.017665, lng: 70.082139, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 155, name: "Fresh", nameUz: "Fresh", cat: "infra", type: "Savdo", addr: "Navoiy ko'chasi", mfy: "", lat: 41.014639, lng: 70.073810, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 156, name: "Fresh", nameUz: "Fresh", cat: "infra", type: "Savdo", addr: "Navoiy ko'chasi", mfy: "", lat: 41.004117, lng: 70.074975, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 157, name: "Afruz", nameUz: "Afruz", cat: "infra", type: "Savdo", addr: "Yangi Angren", mfy: "", lat: 41.040824, lng: 70.092493, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 158, name: "Kosko", nameUz: "Kosko", cat: "infra", type: "Savdo", addr: "Istiqlol ko'chasi", mfy: "", lat: 41.012334, lng: 70.085946, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 159, name: "Afruz", nameUz: "Afruz", cat: "infra", type: "Savdo", addr: "Navoiy ko'chasi", mfy: "", lat: 41.018554, lng: 70.082836, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 160, name: "Havas", nameUz: "Havas", cat: "infra", type: "Savdo", addr: "Ohangaron ko'chasi", mfy: "", lat: 41.015606, lng: 70.093122, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 161, name: "Havas", nameUz: "Havas", cat: "infra", type: "Savdo", addr: "Ohangaron ko'chasi", mfy: "", lat: 41.015608, lng: 70.093130, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 162, name: "Kosko", nameUz: "Kosko", cat: "infra", type: "Savdo", addr: "Istiqlol ko'chasi", mfy: "", lat: 41.002985, lng: 70.081118, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 163, name: "Grand", nameUz: "Grand", cat: "infra", type: "Savdo", addr: "Ohangaron ko'chasi", mfy: "", lat: 41.011308, lng: 70.065275, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 164, name: "Nihol", nameUz: "Nihol", cat: "infra", type: "Savdo", addr: "Ohangaron ko'chasi", mfy: "", lat: 41.024022, lng: 70.056411, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 165, name: "Humoyun Market", nameUz: "Humoyun Market", cat: "infra", type: "Savdo", addr: "Toshkent yo'li", mfy: "", lat: 40.989469, lng: 70.074896, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 166, name: "Fresh", nameUz: "Fresh", cat: "infra", type: "Savdo", addr: "Navoiy ko'chasi", mfy: "", lat: 41.046376, lng: 70.089525, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 167, name: "Fresh", nameUz: "Fresh", cat: "infra", type: "Savdo", addr: "Navoiy ko'chasi", mfy: "", lat: 41.007836, lng: 70.089572, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            { id: 168, name: "Ravon", nameUz: "Ravon", cat: "infra", type: "Savdo", addr: "Ohangaron ko'chasi", mfy: "", lat: 41.009738, lng: 70.060148, hours: "8:00-22:00", color: "#db2777", icon: "üõí" },
            // --- Shifoxonalar (5) ---
            { id: 169, name: "Markaziy shifoxona", nameUz: "Markaziy shifoxona", cat: "infra", type: "Tibbiyot", addr: "Navoiy ko'chasi, 20", mfy: "", lat: 41.015967, lng: 70.080584, hours: "24/7", color: "#db2777", icon: "üè•" },
            { id: 170, name: "Oilaviy poliklinika 4", nameUz: "Oilaviy poliklinika 4", cat: "infra", type: "Tibbiyot", addr: "Mustaqillik ko'chasi", mfy: "", lat: 41.004055, lng: 70.073797, hours: "24/7", color: "#db2777", icon: "üè•" },
            { id: 171, name: "Oilaviy poliklinika 3", nameUz: "Oilaviy poliklinika 3", cat: "infra", type: "Tibbiyot", addr: "Mustaqillik ko'chasi", mfy: "", lat: 41.023232, lng: 70.088971, hours: "24/7", color: "#db2777", icon: "üè•" },
            { id: 172, name: "Oilaviy poliklinika 3", nameUz: "Oilaviy poliklinika 3", cat: "infra", type: "Tibbiyot", addr: "Mustaqillik ko'chasi", mfy: "", lat: 41.055128, lng: 70.083914, hours: "24/7", color: "#db2777", icon: "üè•" },
            { id: 173, name: "Shifoxona psixonevrologicheskiy", nameUz: "Shifoxona psixonevrologicheskiy", cat: "infra", type: "Tibbiyot", addr: "Mustaqillik ko'chasi", mfy: "", lat: 41.004620, lng: 70.084470, hours: "24/7", color: "#db2777", icon: "üè•" },
            // --- Mehmonxonalar (16) ---
            { id: 174, name: "Angren", nameUz: "Angren", cat: "infra", type: "Mehmonxona", addr: "Markaz", mfy: "", lat: 41.009812, lng: 70.076657, color: "#db2777", icon: "üè®" },
            { id: 175, name: "Angren Plaza Hotel", nameUz: "Angren Plaza Hotel", cat: "infra", type: "Mehmonxona", addr: "Mustaqillik ko'chasi", mfy: "", lat: 41.000649, lng: 70.082020, color: "#db2777", icon: "üè®" },
            { id: 176, name: "Shoxdiyor", nameUz: "Shoxdiyor", cat: "infra", type: "Mehmonxona", addr: "Toshkent yo'li", mfy: "", lat: 40.994735, lng: 70.055666, color: "#db2777", icon: "üè®" },
            { id: 177, name: "Art Angren Hotel", nameUz: "Art Angren Hotel", cat: "infra", type: "Mehmonxona", addr: "Ohangaron ko'chasi", mfy: "", lat: 41.017389, lng: 70.074017, color: "#db2777", icon: "üè®" },
            { id: 178, name: "Elba", nameUz: "Elba", cat: "infra", type: "Mehmonxona", addr: "Bekobod yo'li", mfy: "", lat: 41.019122, lng: 70.095559, color: "#db2777", icon: "üè®" },
            { id: 179, name: "Mohir", nameUz: "Mohir", cat: "infra", type: "Mehmonxona", addr: "Markaz", mfy: "", lat: 41.007691, lng: 70.093923, color: "#db2777", icon: "üè®" },
            { id: 180, name: "Angren Camping Service", nameUz: "Angren Camping Service", cat: "infra", type: "Mehmonxona", addr: "Bekobod yo'li", mfy: "", lat: 41.010126, lng: 70.096977, color: "#db2777", icon: "üè®" },
            { id: 181, name: "Makon Hotel", nameUz: "Makon Hotel", cat: "infra", type: "Mehmonxona", addr: "Bekobod yo'li", mfy: "", lat: 41.009646, lng: 70.095631, color: "#db2777", icon: "üè®" },
            { id: 182, name: "Fayz", nameUz: "Fayz", cat: "infra", type: "Mehmonxona", addr: "Toshkent yo'li", mfy: "", lat: 40.979132, lng: 70.044556, color: "#db2777", icon: "üè®" },
            { id: 183, name: "Gloria", nameUz: "Gloria", cat: "infra", type: "Mehmonxona", addr: "Markaz", mfy: "", lat: 41.010744, lng: 70.082339, color: "#db2777", icon: "üè®" },
            { id: 184, name: "Fayz", nameUz: "Fayz", cat: "infra", type: "Mehmonxona", addr: "Amir Temur ko'chasi", mfy: "", lat: 41.008677, lng: 70.093022, color: "#db2777", icon: "üè®" },
            { id: 185, name: "Chaykovskiy", nameUz: "Chaykovskiy", cat: "infra", type: "Mehmonxona", addr: "Yangi Angren", mfy: "", lat: 41.120507, lng: 70.097404, color: "#db2777", icon: "üè®" },
            { id: 186, name: "Shamshod Mountain Resort", nameUz: "Shamshod Mountain Resort", cat: "infra", type: "Mehmonxona", addr: "Yangi Angren", mfy: "", lat: 41.118041, lng: 70.094453, color: "#db2777", icon: "üè®" },
            { id: 187, name: "Uzbegim Yangiobod", nameUz: "Uzbegim Yangiobod", cat: "infra", type: "Mehmonxona", addr: "Yangi Angren", mfy: "", lat: 41.119604, lng: 70.093388, color: "#db2777", icon: "üè®" },
            { id: 188, name: "Yangiobod Mountain Resort", nameUz: "Yangiobod Mountain Resort", cat: "infra", type: "Mehmonxona", addr: "Yangi Angren", mfy: "", lat: 41.119891, lng: 70.093582, color: "#db2777", icon: "üè®" },
            { id: 189, name: "Yangiobod Hotel", nameUz: "Yangiobod Hotel", cat: "infra", type: "Mehmonxona", addr: "Yangi Angren", mfy: "", lat: 41.118888, lng: 70.091965, color: "#db2777", icon: "üè®" },
            // --- Parklar (3) ---
            { id: 190, name: "Istirohat bog ªi Oxunboboyev", nameUz: "Istirohat bog ªi Oxunboboyev", cat: "infra", type: "Dam olish", addr: "Ohunboboyev ko'chasi", mfy: "", lat: 41.013787, lng: 70.074085, hours: "6:00-22:00", color: "#db2777", icon: "üå≥" },
            { id: 191, name: "Istirohat bog ªi A.Navoiy", nameUz: "Istirohat bog ªi A.Navoiy", cat: "infra", type: "Dam olish", addr: "Navoiy ko'chasi", mfy: "", lat: 41.004383, lng: 70.064666, hours: "6:00-22:00", color: "#db2777", icon: "üå≥" },
            { id: 192, name: "Istirohat bog ªi Markaziy park", nameUz: "Istirohat bog ªi Markaziy park", cat: "infra", type: "Dam olish", addr: "Navoiy ko'chasi", mfy: "", lat: 41.016046, lng: 70.088201, hours: "6:00-22:00", color: "#db2777", icon: "üå≥" },
            // --- Transport (2) ---
            { id: 193, name: "Temir yo ªl vokzali", nameUz: "Temir yo ªl vokzali", cat: "infra", type: "Transport", addr: "Mustaqillik ko'chasi", mfy: "", lat: 40.999288, lng: 70.082447, color: "#db2777", icon: "üöâ" },
            { id: 194, name: "Avto shoh bekati", nameUz: "Avto shoh bekati", cat: "infra", type: "Transport", addr: "Toshkent yo'li", mfy: "", lat: 41.017407, lng: 70.080416, color: "#db2777", icon: "üöâ" },
            // --- Avtosalonlar (3) ---
            { id: 134, name: "Lion Motors", nameUz: "Lion Motors", cat: "infra", type: "Avtosalon", addr: "Markaz", mfy: "", lat: 41.007444, lng: 70.093649, hours: "9:00-18:00", color: "#db2777", icon: "üöó" },
            { id: 135, name: "Auto makon", nameUz: "Auto makon", cat: "infra", type: "Avtosalon", addr: "Markaz", mfy: "", lat: 41.013560, lng: 70.083403, hours: "9:00-18:00", color: "#db2777", icon: "üöó" },
            { id: 136, name: "Car showroom", nameUz: "Car showroom", cat: "infra", type: "Avtosalon", addr: "Ohangaron ko'chasi", mfy: "", lat: 41.002810, lng: 70.061504, hours: "9:00-18:00", color: "#db2777", icon: "üöó" },
            // --- Ta'lim (1) ---
            { id: 197, name: "Toshkent viloyati Davlat Pedagogika universiteti", nameUz: "Toshkent viloyati Davlat Pedagogika universiteti", cat: "infra", type: "Ta'lim", addr: "Lahutiy ko'chasi, 2", mfy: "", lat: 41.023170, lng: 70.078986, emp: 4932, color: "#db2777", icon: "üéì" },
            // --- MFY (2) ---
            { id: 195, name: "Taraqqiyot MFY", nameUz: "Taraqqiyot MFY", cat: "infra", type: "MFY", addr: "Istiqlol ko'chasi", mfy: "", lat: 41.019692, lng: 70.087415, hours: "24/7", color: "#db2777", icon: "üèòÔ∏è" },
            { id: 196, name: "Istiqlol MFY", nameUz: "Istiqlol MFY", cat: "infra", type: "MFY", addr: "Ohangaron ko'chasi", mfy: "", lat: 41.005726, lng: 70.060256, hours: "24/7", color: "#db2777", icon: "üèòÔ∏è" }
        ];

        // ===== GLOBALS =====// ===== GLOBALS =====// ===== GLOBALS =====// ===== GLOBALS =====
        var map, tileLayer, markers = [], currentCat = 'all', currentTheme = 'light';
        var tiles = {
            light: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            dark: 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png',
            satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
        };

        // ===== MAP INIT =====
        map = L.map('map', { center: [41.0177, 70.0821], zoom: 14, zoomControl: false });
        tileLayer = L.tileLayer(tiles.light, { attribution: '¬© OpenStreetMap', maxZoom: 19 }).addTo(map);

        function createIcon(loc) {
            var s = loc.cat === 'bank' ? 40 : loc.cat === 'employer' ? 38 : 32;
            return L.divIcon({
                className: '',
                html: '<div class="marker-wrap" style="width:' + s + 'px;height:' + s + 'px;background:' + loc.color + ';font-size:' + (s * 0.45) + 'px">' + loc.icon + '</div>',
                iconSize: [s, s], iconAnchor: [s / 2, s / 2]
            });
        }

        function addMarkers(locs) {
            clearMarkers();
            locs.forEach(function (loc) {
                var m = L.marker([loc.lat, loc.lng], { icon: createIcon(loc) }).addTo(map);
                m.bindPopup('<div class="popup-box"><h4>' + loc.icon + ' ' + (loc.nameUz || loc.name) + '</h4><p>üìç ' + loc.addr + '</p><p>üèòÔ∏è ' + loc.mfy + '</p>' + (loc.hours ? '<p class="hours">üïê ' + loc.hours + '</p>' : '') + (loc.emp ? '<p>üë∑ ' + loc.emp.toLocaleString() + ' ishchi</p>' : '') + '</div>');
                m.on('click', function () { showPanel(loc); highlightCard(loc.id) });
                markers.push({ m: m, loc: loc });
            });
        }
        function clearMarkers() { markers.forEach(function (x) { map.removeLayer(x.m) }); markers = [] }

        addMarkers(data);

        // ===== LIST =====
        function renderList(locs) {
            var groups = { bank: { t: 'üèõÔ∏è Banklar', i: [] }, atm: { t: 'üí≥ Bankomatlar', i: [] }, market: { t: 'üõí Bozorlar', i: [] }, employer: { t: 'üè≠ Korxonalar', i: [] }, infra: { t: 'üèóÔ∏è Infratuzilma', i: [] } };
            locs.forEach(function (l) { if (groups[l.cat]) groups[l.cat].i.push(l) });
            var html = '';
            Object.keys(groups).forEach(function (k) {
                var g = groups[k];
                if (g.i.length) {
                    html += '<div style="margin-bottom:.75rem"><div class="grp-title">' + g.t + ' <span class="grp-count">' + g.i.length + '</span></div>';
                    g.i.forEach(function (l) {
                        html += '<div class="loc-card" id="card-' + l.id + '" onclick="selectLoc(' + l.id + ')">';
                        html += '<div class="loc-hdr"><div class="loc-ico" style="background:' + l.color + '18;color:' + l.color + '">' + l.icon + '</div><div><h4>' + l.name + '<span class="loc-type">' + l.type + '</span></h4><div class="loc-addr">üìç ' + l.addr + '</div></div></div>';
                        html += '<div class="loc-meta"><span>üèòÔ∏è ' + l.mfy + '</span>' + (l.hours ? '<span class="hl">üïê ' + l.hours.split(' ')[0] + '</span>' : '') + (l.emp ? '<span>üë∑ ' + l.emp.toLocaleString() + '</span>' : '') + '</div></div>';
                    });
                    html += '</div>';
                }
            });
            document.getElementById('locList').innerHTML = html || '<p style="text-align:center;color:var(--muted);padding:2rem">Topilmadi</p>';
        }
        renderList(data);

        function selectLoc(id) {
            var l = data.find(function (x) { return x.id === id });
            if (!l) return;
            map.setView([l.lat, l.lng], 17, { animate: true });
            var mk = markers.find(function (x) { return x.loc.id === id });
            if (mk) mk.m.openPopup();
            showPanel(l); highlightCard(id);
        }

        function highlightCard(id) {
            document.querySelectorAll('.loc-card').forEach(function (c) { c.classList.remove('active') });
            var card = document.getElementById('card-' + id);
            if (card) { card.classList.add('active'); card.scrollIntoView({ behavior: 'smooth', block: 'nearest' }) }
        }

        // ===== FILTER =====
        function filterCat(cat, btn) {
            currentCat = cat;
            document.querySelectorAll('.chip').forEach(function (b) { b.classList.remove('active') });
            if (btn) btn.classList.add('active');
            // Sync all filter buttons
            document.querySelectorAll('.chip').forEach(function (b) {
                var txt = b.textContent;
                if (cat === 'all' && txt.indexOf('Barchasi') >= 0) b.classList.add('active');
                else if (cat === 'bank' && txt.indexOf('Bank') >= 0 && txt.indexOf('ATM') < 0) b.classList.add('active');
                else if (cat === 'atm' && (txt.indexOf('ATM') >= 0 || txt.indexOf('Bankomat') >= 0)) b.classList.add('active');
                else if (cat === 'market' && (txt.indexOf('Bozor') >= 0)) b.classList.add('active');
                else if (cat === 'employer' && (txt.indexOf('Korxona') >= 0)) b.classList.add('active');
                else if (cat === 'infra' && txt.indexOf('Infra') >= 0) b.classList.add('active');
            });
            var filtered = cat === 'all' ? data : data.filter(function (l) { return l.cat === cat });
            addMarkers(filtered); renderList(filtered); closePanel();
            if (filtered.length) { var bounds = L.latLngBounds(filtered.map(function (l) { return [l.lat, l.lng] })); map.fitBounds(bounds, { padding: [50, 50] }) }
        }

        function searchLocs() {
            var q = document.getElementById('searchBox').value.toLowerCase();
            var filtered = currentCat === 'all' ? data : data.filter(function (l) { return l.cat === currentCat });
            if (q) filtered = filtered.filter(function (l) { return l.name.toLowerCase().indexOf(q) >= 0 || (l.nameUz && l.nameUz.toLowerCase().indexOf(q) >= 0) || l.addr.toLowerCase().indexOf(q) >= 0 || l.mfy.toLowerCase().indexOf(q) >= 0 });
            addMarkers(filtered); renderList(filtered);
        }

        // ===== THEME =====
        function setTheme(t) {
            currentTheme = t;
            document.body.setAttribute('data-theme', t === 'satellite' ? 'dark' : t);
            document.getElementById('btnLight').classList.toggle('active', t === 'light');
            document.getElementById('btnDark').classList.toggle('active', t === 'dark');
            document.getElementById('btnSat').classList.toggle('active', t === 'satellite');
            map.removeLayer(tileLayer);
            tileLayer = L.tileLayer(tiles[t], { attribution: t === 'satellite' ? '¬© Esri' : '¬© OpenStreetMap', maxZoom: 19 }).addTo(map);
        }

        // ===== PANEL =====
        function showPanel(loc) {
            document.getElementById('pIcon').textContent = loc.icon;
            document.getElementById('pIcon').style.background = loc.color + '18';
            document.getElementById('pIcon').style.color = loc.color;
            document.getElementById('pName').textContent = loc.nameUz || loc.name;
            document.getElementById('pSub').textContent = loc.type + ' ‚Ä¢ ' + loc.mfy;
            if (loc.cat === 'bank' && loc.bankKey && bankData[loc.bankKey]) {
                document.getElementById('pTabs').style.display = 'flex';
                renderBankPanel(loc, bankData[loc.bankKey]);
            } else {
                document.getElementById('pTabs').style.display = 'none';
                renderSimplePanel(loc);
            }
            document.getElementById('bankPanel').classList.add('active');
            switchTab('info', document.querySelector('.panel-tab'));
        }

        function renderBankPanel(loc, bank) {
            document.getElementById('tab-info').innerHTML =
                '<div class="info-grid">' +
                '<div class="info-box"><div class="info-box-icon">üèß</div><div class="info-box-val">' + bank.angrenATMs + '</div><div class="info-box-lbl">Angrenda bankomat</div></div>' +
                '<div class="info-box"><div class="info-box-icon">üåê</div><div class="info-box-val">' + bank.totalATMs.toLocaleString() + '</div><div class="info-box-lbl">Jami bankomat</div></div>' +
                '<div class="info-box"><div class="info-box-icon">üèõÔ∏è</div><div class="info-box-val">' + (bank.angrenBranches || 1) + '</div><div class="info-box-lbl">Angrenda filial</div></div>' +
                '<div class="info-box"><div class="info-box-icon">üó∫Ô∏è</div><div class="info-box-val">' + bank.branches + '</div><div class="info-box-lbl">Jami filiallar</div></div>' +
                '<div class="info-box"><div class="info-box-icon">üìû</div><div class="info-box-val">' + bank.shortCode + '</div><div class="info-box-lbl">Qisqa raqam</div></div>' +
                '<div class="info-box"><div class="info-box-icon">üîó</div><div class="info-box-val" style="font-size:.7rem">' + bank.website + '</div><div class="info-box-lbl">Veb-sayt</div></div>' +
                '</div>' +
                '<div class="contact-row"><span class="ci">üìç</span><div><div class="cl">Manzil</div><div class="cv">' + loc.addr + '</div></div></div>' +
                '<div class="contact-row"><span class="ci">üïê</span><div><div class="cl">Ish vaqti</div><div class="cv">' + (loc.hours || '‚Äî') + '</div></div></div>' +
                (loc.phone ? '<div class="contact-row"><span class="ci">üìû</span><div><div class="cl">Telefon</div><div class="cv">' + loc.phone + '</div></div></div>' : '') +
                '<div class="data-title" style="margin-top:.75rem">üí≥ Kartalar</div>' +
                '<div class="card-sys">' + bank.cards.map(function (c) { return '<span class="cbadge ' + c.toLowerCase().replace(/\s/g, '') + '">' + c + '</span>' }).join('') + '</div>';

            var credH = '<div class="data-title">üí≥ Kreditlar (' + bank.credits.length + ' ta)</div><table class="dtable"><thead><tr><th>Nomi</th><th>Foiz</th><th>Muddat</th><th>Summa</th></tr></thead><tbody>';
            bank.credits.forEach(function (c) { credH += '<tr><td><b>' + c.name + '</b></td><td><span class="rate">' + c.rate + '</span></td><td>' + c.term + '</td><td>' + c.amount + '</td></tr>' });
            credH += '</tbody></table>';
            document.getElementById('tab-credits').innerHTML = credH;

            var depH = '<div class="data-title">üí∞ Omonatlar (' + bank.deposits.length + ' ta)</div><table class="dtable"><thead><tr><th>Nomi</th><th>Foiz</th><th>Muddat</th><th>Minimal</th></tr></thead><tbody>';
            bank.deposits.forEach(function (d) { depH += '<tr><td><b>' + d.name + '</b></td><td><span class="rate">' + d.rate + '</span></td><td>' + d.term + '</td><td>' + d.min + '</td></tr>' });
            depH += '</tbody></table>';
            document.getElementById('tab-deposits').innerHTML = depH;

            var trH = '<div class="data-title">üí∏ O\'tkazmalar (' + bank.transfers.length + ' ta)</div><div class="transfer-grid">';
            bank.transfers.forEach(function (t) { trH += '<span class="transfer-badge">' + t + '</span>' });
            trH += '</div>';
            document.getElementById('tab-transfers').innerHTML = trH;
        }

        function renderSimplePanel(loc) {
            var h = '<div class="contact-row"><span class="ci">üìç</span><div><div class="cl">Manzil</div><div class="cv">' + loc.addr + '</div></div></div>';
            h += '<div class="contact-row"><span class="ci">üèòÔ∏è</span><div><div class="cl">MFY</div><div class="cv">' + loc.mfy + '</div></div></div>';
            if (loc.hours) h += '<div class="contact-row"><span class="ci">üïê</span><div><div class="cl">Ish vaqti</div><div class="cv">' + loc.hours + '</div></div></div>';
            if (loc.phone) h += '<div class="contact-row"><span class="ci">üìû</span><div><div class="cl">Telefon</div><div class="cv">' + loc.phone + '</div></div></div>';
            if (loc.emp) h += '<div class="contact-row"><span class="ci">üë∑</span><div><div class="cl">Ishchilar</div><div class="cv">' + loc.emp.toLocaleString() + ' nafar</div></div></div>';
            if (loc.payDay) h += '<div class="contact-row"><span class="ci">üí∞</span><div><div class="cl">Maosh kunlari</div><div class="cv">' + loc.payDay + '</div></div></div>';
            document.getElementById('tab-info').innerHTML = h;
            document.getElementById('tab-credits').innerHTML = '<p style="text-align:center;color:var(--muted);padding:1.5rem">Ma\'lumot mavjud emas</p>';
            document.getElementById('tab-deposits').innerHTML = '<p style="text-align:center;color:var(--muted);padding:1.5rem">Ma\'lumot mavjud emas</p>';
            document.getElementById('tab-transfers').innerHTML = '<p style="text-align:center;color:var(--muted);padding:1.5rem">Ma\'lumot mavjud emas</p>';
        }

        function switchTab(name, btn) {
            document.querySelectorAll('.panel-tab').forEach(function (t) { t.classList.remove('active') });
            document.querySelectorAll('.tab-ct').forEach(function (c) { c.classList.remove('active') });
            if (btn) btn.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
        }

        function closePanel() { document.getElementById('bankPanel').classList.remove('active') }

        // ===== MODAL =====
        function openModal() { document.getElementById('modalBg').classList.add('active'); document.getElementById('modal').classList.add('active') }
        function closeModal() { document.getElementById('modalBg').classList.remove('active'); document.getElementById('modal').classList.remove('active') }

        // ===== SIDEBAR =====
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open') }

        // ===== VOICE ASSISTANT =====
        var AZURE_KEY = '1XBh7tnZOwcd7uI1kGu8at1gkys1aBIIRiYwQ5Dn7dxszAMShYVqJQQJ99CAACYeBjFXJ3w3AAAYACOGcO7v';
        var AZURE_REGION = 'eastus';
        var isListening = false, isSpeaking = false, recognition = null, currentAudio = null;

        // Bank nomlari va sinonimlar
        var bankNames = {
            'xalq': { name: 'Xalq banki', key: 'Xalq banki' },
            'xalqbank': { name: 'Xalq banki', key: 'Xalq banki' },
            'ipoteka': { name: 'Ipoteka bank', key: 'Ipoteka bank' },
            'ipotekabank': { name: 'Ipoteka bank', key: 'Ipoteka bank' },
            'hamkor': { name: 'Hamkorbank', key: 'Hamkorbank' },
            'hamkorbank': { name: 'Hamkorbank', key: 'Hamkorbank' },
            'kapital': { name: 'Kapitalbank', key: 'Kapitalbank' },
            'kapitalbank': { name: 'Kapitalbank', key: 'Kapitalbank' },
            'milliy': { name: 'Milliy bank', key: 'Milliy bank' },
            'milliybank': { name: 'Milliy bank', key: 'Milliy bank' },
            'agro': { name: 'Agrobank', key: 'Agrobank' },
            'agrobank': { name: 'Agrobank', key: 'Agrobank' },
            'sanoat': { name: 'Sanoatqurilishbank', key: 'Sanoatqurilishbank' },
            'sanoatqurilish': { name: 'Sanoatqurilishbank', key: 'Sanoatqurilishbank' },
            'qurilish': { name: 'Sanoatqurilishbank', key: 'Sanoatqurilishbank' },
            'anor': { name: 'Anorbank', key: 'Anorbank' },
            'anorbank': { name: 'Anorbank', key: 'Anorbank' },
            'hayot': { name: 'Hayot bank', key: 'Hayot bank' },
            'hayotbank': { name: 'Hayot bank', key: 'Hayot bank' }
        };

        var angrenInfo = {
            umumiy: "Angren shahri Toshkent viloyatida joylashgan. Yer maydoni 160.74 kvadrat kilometr. Aholisi 182 ming 429 nafar. 41 ta mahalla. Ishsizlik 6.7 foiz.",
            banklar: "Angrenda 10 xil bank, 13 ta filial va xizmat nuqtasi mavjud. 6 ta bankning o'z bankomatlar tarmog'i bor. Jami 191 ming mijoz.",
            bankomatlar: "66 ta bankomat: Ipoteka bank (18), Xalq banki (17), Hamkorbank (11), SQB (10), Milliy bank (9), Agrobank (1). Terminal soni 3024 ta.",
            bozorlar: "4 ta bozor: Dehqon bozori, Buyum bozori, Mol bozori va Shahar hokimiyati.",
            korxonalar: "5 ta yirik korxona, jami 14 194 ishchi.",
            mehmonxonalar: "16 ta mehmonxona. Angren Plaza, Art Angren, Shoxdiyor va boshqalar.",
            yoqilgi: "16 ta yoqilg'i stansiyasi. AYOQSH tarmog'i.",
            savdo: "16 ta savdo markazi. Korzinka, Fresh, Havas, Kosko va boshqalar.",
            shifoxona: "5 ta shifoxona. Markaziy shifoxona, 3 ta oilaviy poliklinika.",
            salom: "Assalomu alaykum! Men Angren shahri ovozli yordamchisiman. Bank nomini ayting yoki kategoriya so'rang.",
            yordam: "Bank nomi ayting: Xalq banki, Ipoteka bank, Hamkorbank. Yoki: bankomatlar, bozorlar, mehmonxonalar, yoqilg'i, savdo."
        };

        function toggleVoice() {
            var p = document.getElementById('voicePanel');
            var b = document.getElementById('btnVoice');
            p.classList.toggle('active'); b.classList.toggle('active');
            if (p.classList.contains('active')) initRecognition();
            else { stopListening(); stopSpeaking() }
        }
        function closeVoice() { document.getElementById('voicePanel').classList.remove('active'); document.getElementById('btnVoice').classList.remove('active'); stopListening(); stopSpeaking() }

        function initRecognition() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) { document.getElementById('vTranscript').innerHTML = '<span style="color:var(--muted)">Brauzer ovozni tanimaydi. Chrome ishlating.</span>'; return }
            var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR(); recognition.continuous = false; recognition.interimResults = true; recognition.lang = 'uz-UZ';
            recognition.onresult = function (e) {
                var t = ''; for (var i = e.resultIndex; i < e.results.length; i++) t += e.results[i][0].transcript;
                document.getElementById('vTranscript').innerHTML = '<b>Siz:</b> ' + t;
                if (e.results[e.results.length - 1].isFinal) processVoice(t);
            };
            recognition.onstart = function () { isListening = true; updateVUI('listening') };
            recognition.onend = function () { isListening = false; updateVUI('idle') };
            recognition.onerror = function () { isListening = false; updateVUI('idle') };
        }

        function toggleListening() { if (isListening) { if (recognition) recognition.stop() } else { stopSpeaking(); if (recognition) recognition.start() } }
        function stopListening() { if (recognition && isListening) recognition.stop() }

        function updateVUI(state) {
            var ico = document.getElementById('voiceIco'), stat = document.getElementById('voiceStat'), btn = document.getElementById('vMainBtn'), btxt = document.getElementById('vBtnText');
            ico.className = 'voice-ico'; btn.className = 'vmain-btn';
            if (state === 'listening') { ico.classList.add('listening'); btn.classList.add('listening'); stat.textContent = 'Tinglamoqdaman...'; btxt.textContent = "To'xtatish" }
            else if (state === 'speaking') { ico.classList.add('speaking'); stat.textContent = 'Gapirayapman...'; btxt.textContent = 'Gapiring' }
            else { stat.textContent = 'Gapiring...'; btxt.textContent = 'Gapiring' }
        }

        // Faqat belgilangan obyektlarni ko'rsatish
        function showOnlyMatching(filterFn, zoomToAll) {
            clearMarkers();
            var filtered = data.filter(filterFn);
            filtered.forEach(function (loc) {
                var m = L.marker([loc.lat, loc.lng], { icon: createIcon(loc) }).addTo(map);
                m.bindPopup('<div class="popup-box"><h4>' + loc.icon + ' ' + (loc.nameUz || loc.name) + '</h4><p>üìç ' + loc.addr + '</p><p>üèòÔ∏è ' + loc.mfy + '</p>' + (loc.hours ? '<p class="hours">üïê ' + loc.hours + '</p>' : '') + (loc.emp ? '<p>üë∑ ' + loc.emp.toLocaleString() + ' ishchi</p>' : '') + '</div>');
                m.on('click', function () { showPanel(loc); highlightCard(loc.id) });
                markers.push({ m: m, loc: loc });
            });
            renderList(filtered);
            if (zoomToAll && filtered.length > 0) {
                var bounds = L.latLngBounds(filtered.map(function (l) { return [l.lat, l.lng] }));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function processVoice(text) {
            var t = text.toLowerCase().replace(/[.,!?;:'"]/g, '').replace(/\s+/g, ' ').trim();
            var response = '';
            var handled = false;

            // 1. Salomlashish
            if (t.match(/(salom|assalom|hay|hi|hello)/)) {
                response = angrenInfo.salom;
                handled = true;
            }
            // 2. Rahmat
            else if (t.match(/(rahmat|tashakkur)/)) {
                response = "Marhamat! Yana so'rang.";
                handled = true;
            }
            // 3. Yordam
            else if (t.match(/(yordam|help|nima qil)/)) {
                response = angrenInfo.yordam;
                handled = true;
            }
            // 4. Angren haqida
            else if (t.match(/(angren).*(haqida|malumot)/) || t.match(/(shahar).*(haqida)/)) {
                response = angrenInfo.umumiy;
                handled = true;
            }

            // 5. ANIQ BANK NOMI + BANKOMAT
            if (!handled) {
                for (var key in bankNames) {
                    if (t.indexOf(key) >= 0) {
                        var bankInfo = bankNames[key];
                        var isATM = t.match(/(bankomat|atm|terminal)/);

                        if (isATM) {
                            // Faqat shu bankning bankomatlarini ko'rsat
                            var atmCount = data.filter(function (loc) {
                                return loc.cat === 'atm' && loc.name.toLowerCase().indexOf(key) >= 0;
                            }).length;

                            showOnlyMatching(function (loc) {
                                return loc.cat === 'atm' && loc.name.toLowerCase().indexOf(bankInfo.name.toLowerCase().split(' ')[0]) >= 0;
                            }, true);

                            response = bankInfo.name + " bankomatlari: " + atmCount + " ta. Xaritada ko'rsatildi.";
                        } else {
                            // Faqat shu bankni ko'rsat
                            var bankCount = data.filter(function (loc) {
                                return loc.cat === 'bank' && loc.name.toLowerCase().indexOf(bankInfo.name.toLowerCase().split(' ')[0]) >= 0;
                            }).length;

                            showOnlyMatching(function (loc) {
                                return loc.cat === 'bank' && loc.name.toLowerCase().indexOf(bankInfo.name.toLowerCase().split(' ')[0]) >= 0;
                            }, true);

                            response = bankInfo.name + ": " + bankCount + " ta filial. Xaritada ko'rsatildi.";
                        }
                        handled = true;
                        break;
                    }
                }
            }

            // 6. Umumiy kategoriyalar
            if (!handled) {
                // Barcha banklar
                if (t.match(/barcha.*bank|hammas.*bank|bank.*hammas/) && !t.match(/(bankomat|atm)/)) {
                    showOnlyMatching(function (loc) { return loc.cat === 'bank'; }, true);
                    response = "Barcha banklar: 13 ta filial. Xaritada ko'rsatildi.";
                    handled = true;
                }
                // Barcha bankomatlar
                else if (t.match(/barcha.*bankomat|hammas.*bankomat|bankomat.*hammas|barcha.*atm/)) {
                    showOnlyMatching(function (loc) { return loc.cat === 'atm'; }, true);
                    response = "Barcha bankomatlar: 66 ta. Xaritada ko'rsatildi.";
                    handled = true;
                }
                // Bankomatlar (umumiy)
                else if (t.match(/(bankomat|atm|terminal)/) && !handled) {
                    showOnlyMatching(function (loc) { return loc.cat === 'atm'; }, true);
                    response = angrenInfo.bankomatlar + " Xaritada ko'rsatildi.";
                    handled = true;
                }
                // Banklar (umumiy)
                else if (t.match(/(bank)/) && !t.match(/(bankomat|atm)/) && !handled) {
                    showOnlyMatching(function (loc) { return loc.cat === 'bank'; }, true);
                    response = angrenInfo.banklar + " Xaritada ko'rsatildi.";
                    handled = true;
                }
            }

            // 7. Bozorlar
            if (!handled && t.match(/(bozor|market|dehqon|buyum|mol bozor)/)) {
                if (t.match(/dehqon/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('dehqon') >= 0; }, true);
                    response = "Angren dehqon bozori. Yangi Angrenda joylashgan.";
                } else if (t.match(/buyum/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('buyum') >= 0; }, true);
                    response = "Angren buyum bozori. Yangi Angrenda joylashgan.";
                } else if (t.match(/mol/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('mol') >= 0; }, true);
                    response = "Angren mol bozori. Bekobod yo'lida joylashgan.";
                } else {
                    showOnlyMatching(function (loc) { return loc.cat === 'market'; }, true);
                    response = angrenInfo.bozorlar + " Xaritada ko'rsatildi.";
                }
                handled = true;
            }

            // 8. Korxonalar
            if (!handled && t.match(/(korxona|zavod|fabrika|ies|elektr stansiya|komir|neftbaza|rezina)/)) {
                if (t.match(/yangi.*ies|yangi.*elektr/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('yangi') >= 0 && loc.name.toLowerCase().indexOf('ies') >= 0; }, true);
                    response = "Yangi Angren issiqlik elektr stansiyasi. 1958 ishchi.";
                } else if (t.match(/eski.*ies|eski.*elektr/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('eski') >= 0 && loc.name.toLowerCase().indexOf('ies') >= 0; }, true);
                    response = "Eski Angren issiqlik elektr stansiyasi. 1211 ishchi.";
                } else if (t.match(/komir|ko'mir/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('ko\'mir') >= 0 || loc.name.toLowerCase().indexOf('komir') >= 0; }, true);
                    response = "O'zbekko'mir aksiyadorlik jamiyati. 4996 ishchi.";
                } else if (t.match(/neft|neftbaza/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('neft') >= 0; }, true);
                    response = "Angren neftbaza. 5000 ishchi.";
                } else if (t.match(/rezina/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('rezina') >= 0; }, true);
                    response = "Rezina zavodi. 1029 ishchi.";
                } else {
                    showOnlyMatching(function (loc) { return loc.cat === 'employer'; }, true);
                    response = angrenInfo.korxonalar + " Xaritada ko'rsatildi.";
                }
                handled = true;
            }

            // 9. Mehmonxonalar
            if (!handled && t.match(/(mehmonxona|hotel|otel|turar|yotoq)/)) {
                if (t.match(/plaza/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('plaza') >= 0; }, true);
                    response = "Angren Plaza Hotel. Mustaqillik ko'chasida.";
                } else if (t.match(/art/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('art') >= 0; }, true);
                    response = "Art Angren Hotel. Navoiy ko'chasida.";
                } else if (t.match(/shoxdiyor/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('shoxdiyor') >= 0; }, true);
                    response = "Shoxdiyor mehmonxonasi.";
                } else {
                    showOnlyMatching(function (loc) { return loc.type === 'Mehmonxona'; }, true);
                    response = angrenInfo.mehmonxonalar + " Xaritada ko'rsatildi.";
                }
                handled = true;
            }

            // 10. Yoqilg'i stansiyalari
            if (!handled && t.match(/(yoqilgi|benzin|gaz|metan|ayoqsh|stansiya|zapravka)/)) {
                showOnlyMatching(function (loc) { return loc.type === "Yoqilg'i"; }, true);
                response = angrenInfo.yoqilgi + " Xaritada ko'rsatildi.";
                handled = true;
            }

            // 11. Savdo markazlari / Supermarketlar
            if (!handled && t.match(/(savdo|supermarket|dokon|magazin|korzinka|fresh|havas|kosko)/)) {
                if (t.match(/korzinka/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('korzinka') >= 0; }, true);
                    response = "Korzinka supermarket. Navoiy ko'chasi, 1. 8:00-23:00.";
                } else if (t.match(/fresh/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('fresh') >= 0; }, true);
                    response = "Fresh supermarketlari. Xaritada ko'rsatildi.";
                } else if (t.match(/havas/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('havas') >= 0; }, true);
                    response = "Havas supermarket. Xaritada ko'rsatildi.";
                } else {
                    showOnlyMatching(function (loc) { return loc.type === 'Savdo'; }, true);
                    response = angrenInfo.savdo + " Xaritada ko'rsatildi.";
                }
                handled = true;
            }

            // 12. Shifoxonalar
            if (!handled && t.match(/(shifoxona|kasalxona|doxtir|tibbiyot|poliklinika|vrach)/)) {
                if (t.match(/markaziy/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('markaziy') >= 0 && loc.type === 'Tibbiyot'; }, true);
                    response = "Markaziy shifoxona. Navoiy ko'chasi, 20. Tez yordam: 103.";
                } else {
                    showOnlyMatching(function (loc) { return loc.type === 'Tibbiyot'; }, true);
                    response = angrenInfo.shifoxona + " Xaritada ko'rsatildi.";
                }
                handled = true;
            }

            // 13. Valyuta ayirboshlash / AvtoVASH
            if (!handled && t.match(/(valyuta|dollar|avtovash|ayirbosh)/)) {
                showOnlyMatching(function (loc) { return loc.cat === 'exchange' || loc.type === 'Valyuta ayirboshlash' || loc.type === 'AvtoVASH'; }, true);
                response = "Valyuta ayirboshlash punktlari va AvtoVASH. Xaritada ko'rsatildi.";
                handled = true;
            }

            // 14. Parklar
            if (!handled && t.match(/(park|bog|dam olish|istirohat)/)) {
                showOnlyMatching(function (loc) { return loc.type === 'Dam olish'; }, true);
                response = "Parklar: Markaziy park, Navoiy bog'i, Ohunboboyev parki. Xaritada ko'rsatildi.";
                handled = true;
            }

            // 15. Transport
            if (!handled && t.match(/(vokzal|poezd|avtobus|bekati|transport)/)) {
                if (t.match(/temir|poezd|vokzal/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('temir') >= 0 || loc.name.toLowerCase().indexOf('vokzal') >= 0; }, true);
                    response = "Temir yo'l vokzali. Shaharning sharqida. 24/7.";
                } else if (t.match(/avtobus|bekati|avto shoh/)) {
                    showOnlyMatching(function (loc) { return loc.name.toLowerCase().indexOf('avto') >= 0 && loc.type === 'Transport'; }, true);
                    response = "Avto shoh bekati. Toshkent yo'lida.";
                } else {
                    showOnlyMatching(function (loc) { return loc.type === 'Transport'; }, true);
                    response = "Transport: Temir yo'l vokzali va Avtobus bekati. Xaritada ko'rsatildi.";
                }
                handled = true;
            }

            // 16. Avtosalonlar
            if (!handled && t.match(/(avtosalon|mashina|avto.*sotib|car|showroom)/)) {
                showOnlyMatching(function (loc) { return loc.type === 'Avtosalon'; }, true);
                response = "3 ta avtosalon: Lion Motors, Auto makon, Car showroom. Xaritada ko'rsatildi.";
                handled = true;
            }

            // 17. Universitet / Ta'lim
            if (!handled && t.match(/(universitet|talim|institut|dpu)/)) {
                showOnlyMatching(function (loc) { return loc.type === "Ta'lim"; }, true);
                response = "Toshkent viloyati DPU filiali. Lahutiy ko'chasi, 2. 4932 talaba.";
                handled = true;
            }

            // 18. Moliya tashkilotlari
            if (!handled && t.match(/(mikromoliya|mikrokredit|lombard|sugurta|nasiya|moliya.*tashkilot)/)) {
                showOnlyMatching(function (loc) {
                    return loc.type && (loc.type.indexOf('MFT') >= 0 || loc.type.indexOf('Lombard') >= 0 ||
                        loc.type.indexOf("Sug'urta") >= 0 || loc.type.indexOf('Nasiya') >= 0);
                }, true);
                response = "Moliya tashkilotlari: MFT, Lombard, Sug'urta, Nasiya savdo. Xaritada ko'rsatildi.";
                handled = true;
            }

            // 19. Barchasini ko'rsatish
            if (!handled && t.match(/(barcha|hammas|reset|qayta)/)) {
                filterCat('all', null);
                response = "Barcha obyektlar ko'rsatildi. 190 ta joylashuv.";
                handled = true;
            }

            // 20. Noma'lum so'rov - umumiy qidiruv
            if (!handled) {
                var searchWords = t.split(' ').filter(function (w) { return w.length > 2; });
                var found = data.filter(function (loc) {
                    var searchText = (loc.name + ' ' + (loc.nameUz || '') + ' ' + (loc.type || '') + ' ' + (loc.addr || '')).toLowerCase();
                    return searchWords.some(function (w) { return searchText.indexOf(w) >= 0; });
                });

                if (found.length > 0) {
                    showOnlyMatching(function (loc) {
                        var searchText = (loc.name + ' ' + (loc.nameUz || '') + ' ' + (loc.type || '') + ' ' + (loc.addr || '')).toLowerCase();
                        return searchWords.some(function (w) { return searchText.indexOf(w) >= 0; });
                    }, true);
                    response = found.length + " ta natija topildi. Xaritada ko'rsatildi.";
                } else {
                    response = "Kechirasiz, tushunmadim. Bank nomi yoki kategoriya ayting: Xalq banki, bankomatlar, mehmonxonalar.";
                }
            }

            document.getElementById('vResponse').textContent = response;
            document.getElementById('vResponse').classList.add('active');
            speakText(response);
        }

        function askVoice(text) { document.getElementById('vTranscript').innerHTML = '<b>Siz:</b> ' + text; processVoice(text) }

        function speakText(text) {
            isSpeaking = true; updateVUI('speaking');
            fetch('https://' + AZURE_REGION + '.tts.speech.microsoft.com/cognitiveservices/v1', {
                method: 'POST',
                headers: { 'Ocp-Apim-Subscription-Key': AZURE_KEY, 'Content-Type': 'application/ssml+xml', 'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3' },
                body: "<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='uz-UZ'><voice name='uz-UZ-MadinaNeural'><prosody rate='0.95'>" + text + "</prosody></voice></speak>"
            }).then(function (r) {
                if (r.ok) return r.blob();
                throw new Error('TTS error');
            }).then(function (blob) {
                currentAudio = new Audio(URL.createObjectURL(blob));
                currentAudio.onended = function () { isSpeaking = false; updateVUI('idle') };
                currentAudio.onerror = function () { fallbackSpeak(text) };
                currentAudio.play();
            }).catch(function () { fallbackSpeak(text) });
        }

        function fallbackSpeak(text) {
            if ('speechSynthesis' in window) {
                var u = new SpeechSynthesisUtterance(text); u.lang = 'uz-UZ'; u.rate = 0.9;
                u.onend = function () { isSpeaking = false; updateVUI('idle') };
                speechSynthesis.speak(u);
            } else { isSpeaking = false; updateVUI('idle') }
        }

        function stopSpeaking() {
            if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0 }
            if ('speechSynthesis' in window) speechSynthesis.cancel();
            isSpeaking = false; updateVUI('idle');
        }

        // ===== SENSORLI EKRAN SIMULYATSIYA =====
        // TF.js + MediaPipe Hands asosida 21 ta barmoq nuqtasi aniqlash
        // + o'zimiz jest klassifikatsiya (pinch, fist, open palm, thumb up)
        // Server KERAK EMAS ‚Äî file:// dan to'g'ridan-to'g'ri ishlaydi!
        var gestureActive = false;
        var gestureStream = null;
        var gestureVideo = null;
        var gestureCanvas = null;
        var gestureCtx = null;

        // ‚ïê‚ïê‚ïê BARMOQ LANDMARK INDEKSLARI ‚ïê‚ïê‚ïê
        // MediaPipe Hands 21 ta barmoq nuqtasini aniqlaydi:
        //   0  = WRIST (bilak)
        //   1-4 = THUMB (bosh barmoq): CMC, MCP, IP, TIP
        //   5-8 = INDEX (ko'rsatkich): MCP, PIP, DIP, TIP
        //   9-12 = MIDDLE (o'rta): MCP, PIP, DIP, TIP
        //   13-16 = RING (nomsiz): MCP, PIP, DIP, TIP
        //   17-20 = PINKY (jimjiloq): MCP, PIP, DIP, TIP
        //
        // BARMOQ UCHLARI: 4, 8, 12, 16, 20
        var LM = {
            WRIST: 0,
            THUMB_CMC: 1, THUMB_MCP: 2, THUMB_IP: 3, THUMB_TIP: 4,
            INDEX_MCP: 5, INDEX_PIP: 6, INDEX_DIP: 7, INDEX_TIP: 8,
            MIDDLE_MCP: 9, MIDDLE_PIP: 10, MIDDLE_DIP: 11, MIDDLE_TIP: 12,
            RING_MCP: 13, RING_PIP: 14, RING_DIP: 15, RING_TIP: 16,
            PINKY_MCP: 17, PINKY_PIP: 18, PINKY_DIP: 19, PINKY_TIP: 20
        };

        // ‚ïê‚ïê‚ïê JEST KLASSIFIKATSIYA FUNKSIYASI ‚ïê‚ïê‚ïê
        // Barmoq nuqtalaridan jest nomini aniqlash
        // Bu MediaPipe Gesture Recognizer ham huddi shu usulda ishlaydi:
        // barmoq uchlari va bo'g'inlari orasidagi munosabatlarni tahlil qilish
        //
        // ANIQLANUVCHI JESTLAR:
        //   Closed_Fist  ‚Äî ‚úä barcha barmoqlar yumilgan
        //   Open_Palm    ‚Äî üñêÔ∏è barcha barmoqlar ochiq
        //   Thumb_Up     ‚Äî üëç faqat bosh barmoq yuqorida
        //   Pointing_Up  ‚Äî ‚òùÔ∏è faqat ko'rsatkich yuqorida
        //   Victory      ‚Äî ‚úåÔ∏è ko'rsatkich + o'rta yuqorida
        //   Pinch        ‚Äî ü§è bosh barmoq + ko'rsatkich yaqin
        //
        // JEST ‚Üí HARAKAT XARITASI:
        //   Open_Palm / Pointing_Up ‚Üí kursor harakati (hover)
        //   Closed_Fist ‚Üí surish (drag)
        //   Thumb_Up ‚Üí bosish (click/tap)
        //   Pinch ‚Üí bosish + long press
        //   Victory ‚Üí zoom signal

        // Jest aniqlash: Legacy MediaPipe Hands jest nomini BERMAYDI,
        // faqat 21 ta landmark beradi. Shuning uchun qo'lda classifyGesture kerak.
        // Barmoq uchlarini (TIP) ularning PIP bo'g'inlariga nisbatan tekshiramiz:
        //   TIP.y < PIP.y ‚Üí barmoq OCHIQ (yuqoriga cho'zilgan)
        //   TIP.y > PIP.y ‚Üí barmoq YOPIQ (bukchaygan)
        // Bosh barmoq uchun X koordinata ishlatiladi (chapga/o'ngga).
        function classifyGesture(landmarks) {
            // Barmoq ochiq yoki yopiqligini aniqlash
            // landmarks normalized [0,1] formatda ‚Äî y kichik = yuqori
            var dominated_landmarks = landmarks;

            // Bosh barmoq: TIP(4) vs IP(3) ‚Äî X bo'yicha tekshirish
            // Bosh barmoq chapga yoki o'ngga cho'ziladi, Y emas
            var thumbOpen = Math.abs(dominated_landmarks[LM.THUMB_TIP].x - dominated_landmarks[LM.WRIST].x) >
                Math.abs(dominated_landmarks[LM.THUMB_IP].x - dominated_landmarks[LM.WRIST].x);

            // Qolgan barmoqlar: TIP.y < PIP.y ‚Üí ochiq (yuqoriga)
            var indexOpen = dominated_landmarks[LM.INDEX_TIP].y < dominated_landmarks[LM.INDEX_PIP].y;
            var middleOpen = dominated_landmarks[LM.MIDDLE_TIP].y < dominated_landmarks[LM.MIDDLE_PIP].y;
            var ringOpen = dominated_landmarks[LM.RING_TIP].y < dominated_landmarks[LM.RING_PIP].y;
            var pinkyOpen = dominated_landmarks[LM.PINKY_TIP].y < dominated_landmarks[LM.PINKY_PIP].y;

            var openCount = (thumbOpen ? 1 : 0) + (indexOpen ? 1 : 0) +
                (middleOpen ? 1 : 0) + (ringOpen ? 1 : 0) + (pinkyOpen ? 1 : 0);

            // ‚ïê‚ïê‚ïê JEST KLASSIFIKATSIYA ‚ïê‚ïê‚ïê

            // Closed_Fist: barcha barmoqlar yopiq (0-1 ta ochiq)
            if (openCount <= 1 && !indexOpen && !middleOpen && !ringOpen && !pinkyOpen) {
                return 'Closed_Fist';
            }

            // Thumb_Up: faqat bosh barmoq ochiq, qolganlari yopiq
            if (thumbOpen && !indexOpen && !middleOpen && !ringOpen && !pinkyOpen) {
                return 'Thumb_Up';
            }

            // Pointing_Up: faqat ko'rsatkich ochiq
            if (indexOpen && !middleOpen && !ringOpen && !pinkyOpen) {
                return 'Pointing_Up';
            }

            // Victory: ko'rsatkich + o'rta ochiq, qolganlari yopiq
            if (indexOpen && middleOpen && !ringOpen && !pinkyOpen) {
                return 'Victory';
            }

            // ILoveYou: ko'rsatkich + jimjiloq + bosh barmoq ochiq
            if (thumbOpen && indexOpen && !middleOpen && !ringOpen && pinkyOpen) {
                return 'ILoveYou';
            }

            // Open_Palm: barcha barmoqlar ochiq (4-5 ta)
            if (openCount >= 4) {
                return 'Open_Palm';
            }

            return 'None';
        }

        // Virtual touch tracking
        var lastHandPos = null;
        var lastPinchDist = null;
        var isDragging = false;
        var smoothPos = { x: 320, y: 240 };
        var rawPos = { x: 320, y: 240 };
        var cursorEl = null;
        var velocityX = 0, velocityY = 0;
        var lastMoveTime = 0;
        var clickCooldown = 0;

        // Barmoq izi
        var touchTrails = [];
        var maxTrails = 12;

        // Hover tizimi
        var hoveredElement = null;
        var lastHoveredEl = null;

        // === 1. TAP (Bosish) ===
        var pinchTapThreshold = 35;      // bosh barmoq + ko'rsatkich yaqin = tap (optimallashtirilgan)
        var isPinching = false;
        var pinchStartTime = 0;

        // === 2. SWIPE (Surish) ===
        var swipeStartPos = null;
        var swipeStartTime = 0;
        var swipeTrack = [];              // harakat yo'nalishini kuzatish
        var touchStartPos = null;         // tegish boshlangan nuqta (planshet kabi)
        var touchMoveAccum = 0;           // umumiy harakat miqdori
        var gestureDecided = false;       // jest turi aniqlandi
        var activeGesture = 'none';       // hozirgi faol jest: none, drag, scroll, hold

        // === 3. PINCH/ZOOM (Kattalashtirish/Kichiklashtirish) ===
        // Ikki barmoq (ko'rsatkich + o'rta) orasidagi masofani o'lchash
        var twoFingerBaseDist = null;

        // === 4. SCROLL (Varaqlash) ===
        var isScrolling = false;
        var scrollAccumY = 0;             // to'plangan scroll miqdori
        var scrollStartY = 0;

        // === 5. LONG PRESS (Bosib turish) ===
        var longPressTimer = null;
        var longPressStartTime = 0;
        var isLongPressing = false;
        var longPressDuration = 800;     // 0.8 soniya ushlab turish kerak (optimallashtirilgan)
        var longPressTriggered = false;
        var longPressPos = { x: 0, y: 0 };

        // === 6. ROTATE (Aylantirish) ===
        var lastRotateAngle = null;
        var isRotating = false;
        var rotateAccum = 0;

        // Umumiy holatlar
        var lastGesture = 'none';
        var gestureHoldTime = 0;
        var adaptiveSmooth = 0.2;
        var fingerSpeed = 0;
        var prevFingerPositions = [];     // oxirgi 5 ta pozitsiyani saqlash

        // ===== ONE EURO FILTER =====
        // Sensorli ekran kabi silliq kursor harakati uchun ilg'or filtr.
        //
        // Oddiy lerp (smoothPos += (target - smoothPos) * alpha) ning muammosi:
        //   - alpha katta ‚Üí tez javob, lekin titraydi (jitter)
        //   - alpha kichik ‚Üí silliq, lekin kechikish (lag) ko'p
        //
        // One Euro Filter buni hal qiladi:
        //   - Past tezlikda: cutoff chastota PAST ‚Üí juda silliq (jitter yo'q)
        //   - Yuqori tezlikda: cutoff chastota YUQORI ‚Üí kechikish minimal
        //   - O'tish silliq va avtomatik
        //
        // Parametrlar:
        //   minCutoff: minimal filtrlash kuchi (kichik = silliqroq, katta = tezroq)
        //   beta: tezlik sezgirligi (katta = tez harakatda tezroq javob beradi)
        //   dCutoff: tezlik filtri chastotasi (odatda 1.0 Hz)
        //
        // Manba: G√©ry Casiez et al., "1‚Ç¨ Filter", CHI 2012
        // ============================================================

        function OneEuroFilter(freq, minCutoff, beta, dCutoff) {
            // freq: kutilayotgan yangilanish chastotasi (Hz), masalan kamera 30 fps = 30 Hz
            // minCutoff: minimal cutoff chastota (past = silliqroq). 1.0-3.0 oralig'i yaxshi
            // beta: tezlik koeffitsienti (katta = tez harakatda tezroq javob). 0.0-1.0 oralig'i
            // dCutoff: derivativ (tezlik signali) filtri chastotasi. Odatda 1.0
            this.freq = freq || 30;
            this.minCutoff = minCutoff || 1.5;
            this.beta = beta || 0.5;
            this.dCutoff = dCutoff || 1.0;

            this.xPrev = null;      // oldingi filtrlangan qiymat
            this.dxPrev = 0;        // oldingi filtrlangan tezlik (derivativ)
            this.lastTime = null;   // oxirgi yangilanish vaqti (ms)
        }

        // Past chastotali filtr koeffitsientini hisoblash
        // Te = 1/freq (vaqt qadami), tau = 1/(2*pi*cutoff)
        // alpha = 1 / (1 + tau/Te) = Te / (Te + tau)
        // Bu 0 dan 1 gacha bo'ladi: 0 = hech filter yo'q, 1 = to'liq o'tkazish
        OneEuroFilter.prototype.alpha = function (cutoff) {
            var te = 1.0 / this.freq;                        // vaqt qadami (soniyalarda)
            var tau = 1.0 / (2.0 * Math.PI * cutoff);       // filtr vaqt konstantasi
            return 1.0 / (1.0 + tau / te);                  // smoothing koeffitsienti
        };

        // Asosiy filtr: yangi xom qiymatni oladi, filtrlangan qiymatni qaytaradi
        OneEuroFilter.prototype.filter = function (x, timestamp) {
            var now = timestamp || Date.now();

            // Birinchi marta ‚Äî filtrlashsiz qabul qilamiz
            if (this.xPrev === null) {
                this.xPrev = x;
                this.dxPrev = 0;
                this.lastTime = now;
                return x;
            }

            // Vaqt farqi asosida chastotani yangilash (real fps ni hisobga olish)
            var dt = (now - this.lastTime) / 1000.0;  // millisekunddan sekundga
            if (dt <= 0) dt = 1.0 / this.freq;        // himoya: nol yoki manfiy bo'lmasin
            this.freq = 1.0 / dt;                     // haqiqiy fps
            this.lastTime = now;

            // 1-QADAM: Tezlikni (derivativni) filtrlash
            // Xom tezlik = (yangi_qiymat - eski_qiymat) / vaqt
            var dx = (x - this.xPrev) / dt;
            // Tezlikni ham past-chastotali filtr bilan silliqlashtirish
            var edAlpha = this.alpha(this.dCutoff);
            var dxHat = edAlpha * dx + (1.0 - edAlpha) * this.dxPrev;

            // 2-QADAM: Tezlik asosida cutoff chastotani dinamik hisoblash
            // Tezlik katta ‚Üí cutoff yuqori ‚Üí alpha katta ‚Üí kamroq filtrlash ‚Üí tezroq javob
            // Tezlik kichik ‚Üí cutoff past ‚Üí alpha kichik ‚Üí ko'proq filtrlash ‚Üí silliqroq
            var cutoff = this.minCutoff + this.beta * Math.abs(dxHat);

            // 3-QADAM: Pozitsiyani filtrlash (yangi cutoff bilan)
            var xAlpha = this.alpha(cutoff);
            var xHat = xAlpha * x + (1.0 - xAlpha) * this.xPrev;

            // Holatni saqlash
            this.xPrev = xHat;
            this.dxPrev = dxHat;

            return xHat;
        };

        // Filtni qayta boshlash (masalan qo'l yo'qolganida)
        OneEuroFilter.prototype.reset = function () {
            this.xPrev = null;
            this.dxPrev = 0;
            this.lastTime = null;
        };

        // Asosiy qo'l uchun X va Y alohida filtrlar
        // minCutoff=1.5: yetarlicha silliq, lekin juda ko'p kechikish yo'q
        // beta=0.5: tez harakatda yaxshi javob beradi
        var euroFilterX = new OneEuroFilter(30, 1.5, 0.5, 1.0);
        var euroFilterY = new OneEuroFilter(30, 1.5, 0.5, 1.0);

        // ===== IKKI QO'L REJIMI (TWO-HAND ZOOM) =====
        // Planshetdagi ikki barmoq zoom jestini simulyatsiya qiladi,
        // lekin barmoqlar o'rniga IKKITA QO'L ishlatiladi.
        //
        // Ishlash tartibi:
        //   1. Kamera ikkita qo'lni aniqlaydi
        //   2. Har bir qo'lning ko'rsatkich barmoq uchi (index tip, keypoint #8) olinadi
        //   3. Ikki barmoq orasidagi masofa hisoblanadi
        //   4. Masofa OSHSA ‚Üí xarita kattalashadi (zoom in)
        //   5. Masofa KAMAYSA ‚Üí xarita kichiklashadi (zoom out)
        //   6. Zoom tezligi masofa o'zgarish tezligiga proporsional
        //
        // Qo'shimcha: ikki qo'l rejimida xaritani surish ham mumkin ‚Äî
        // ikki qo'l markazi harakatlansa, xarita shu yo'nalishda suriladi (pan)
        // ============================================================

        var twoHandActive = false;          // ikki qo'l rejimi faolmi?
        var twoHandBaseDist = null;         // boshlang'ich masofa (zoom boshlanganida)
        var twoHandLastDist = null;         // oxirgi kadr masofasi
        var twoHandCenter = { x: 0, y: 0 };// ikki qo'l markazi (pan uchun)
        var twoHandLastCenter = null;       // oldingi kadr markazi
        var twoHandZoomAccum = 0;           // to'plangan zoom miqdori (silliq zoom uchun)
        var twoHandFilterDist = new OneEuroFilter(30, 0.8, 0.3, 1.0); // masofa filtri
        var twoHandFilterCX = new OneEuroFilter(30, 1.0, 0.4, 1.0);   // markaz X filtri
        var twoHandFilterCY = new OneEuroFilter(30, 1.0, 0.4, 1.0);   // markaz Y filtri
        var twoHandCursorEl2 = null;        // ikkinchi qo'l kursori

        function toggleGesture() {
            var panel = document.getElementById('gesturePanel');
            var btn = document.getElementById('btnGesture');
            panel.classList.toggle('active');
            btn.classList.toggle('active');
        }

        function closeGesture() {
            document.getElementById('gesturePanel').classList.remove('active');
            document.getElementById('btnGesture').classList.remove('active');
            stopGestureCamera();
        }

        function toggleGestureCamera() {
            gestureActive ? stopGestureCamera() : startGestureCamera();
        }

        async function startGestureCamera() {
            var overlay = document.getElementById('gestureOverlay');
            overlay.innerHTML = '<div>‚è≥ MediaPipe Hands yuklanmoqda...<br><small>Model tayyorlanmoqda (~10 soniya)</small></div>';
            overlay.classList.remove('hidden');

            try {
                // ‚ïê‚ïê‚ïê LEGACY MEDIAPIPE HANDS ‚ïê‚ïê‚ïê
                // Hands, Camera, drawConnectors, HAND_CONNECTIONS ‚Äî
                // barchasi <head> dagi script teglar orqali allaqachon yuklangan.
                //
                // Bu eng ishonchli brauzer qo'l aniqlash kutubxonasi:
                // - file:// dan ishlaydi (server kerak emas!)
                // - WASM va model fayllarini CDN dan avtomatik yuklaydi
                // - 21 ta barmoq nuqtasi (normalized 0-1)
                // - 2 ta qo'lni bir vaqtda aniqlaydi

                var mpHands = new Hands({
                    locateFile: function (file) {
                        return 'https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/' + file;
                    }
                });

                mpHands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: 1,      // 0=lite, 1=full (aniqroq)
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                // ‚ïê‚ïê‚ïê NATIJALAR CALLBACK ‚ïê‚ïê‚ïê
                // Har bir kadr uchun chaqiriladi.
                // results.multiHandLandmarks[i] ‚Äî i-qo'lning 21 ta nuqtasi (x,y: 0-1)
                // results.multiHandedness[i].label ‚Äî "Left" yoki "Right"
                mpHands.onResults(function (results) {
                    if (!gestureActive) return;
                    gestureCtx.clearRect(0, 0, 640, 480);

                    if (results.multiHandLandmarks && results.multiHandLandmarks.length >= 1) {
                        // Landmarklarni normalized [0,1] formatda qoldiramiz!
                        // drawHandLandmarks, handleOneHandMP, handleTwoHandsMP ‚Äî
                        // barchasi o'zlari normalized ‚Üí pikselga aylantiradi.
                        var kp1 = results.multiHandLandmarks[0];
                        var gesture1 = classifyGesture(kp1);
                        drawHandLandmarks(kp1, '#8b5cf6');

                        if (results.multiHandLandmarks.length >= 2) {
                            var kp2 = results.multiHandLandmarks[1];
                            drawHandLandmarks(kp2, '#3b82f6');
                            handleTwoHandsMP(kp1, kp2, gesture1);
                        } else {
                            if (twoHandActive) exitTwoHandMode();
                            handleOneHandMP(kp1, gesture1);
                        }
                    } else {
                        if (twoHandActive) exitTwoHandMode();
                        handleNoHand();
                    }
                });

                overlay.innerHTML = '<div>üì∑ Kamera ulanmoqda...</div>';

                gestureVideo = document.getElementById('gestureVideo');
                gestureCanvas = document.getElementById('gestureCanvas');
                gestureCtx = gestureCanvas.getContext('2d');
                gestureCanvas.width = 640;
                gestureCanvas.height = 480;

                // ‚ïê‚ïê‚ïê CAMERA UTILITY ‚ïê‚ïê‚ïê
                // Camera ‚Äî MediaPipe'ning kamera yordamchi klassi.
                // U kamerani ochadi va har kadrni avtomatik mpHands.send() ga beradi.
                // Bu requestAnimationFrame + estimateHands() dan ancha ishonchli!
                var mpCamera = new Camera(gestureVideo, {
                    onFrame: async function () {
                        await mpHands.send({ image: gestureVideo });
                    },
                    width: 640,
                    height: 480
                });

                await mpCamera.start();

                createCursor();
                createTrails();

                gestureActive = true;
                overlay.classList.add('hidden');
                document.getElementById('gestureStatus').textContent = 'Faol ‚úã';
                document.getElementById('gestureStatus').classList.add('active');
                document.getElementById('gestureStartBtn').innerHTML = '‚èπÔ∏è To\'xtatish';
                document.getElementById('touchBadge').classList.add('active');

                // Reset holatlari
                lastHandPos = null;
                lastPinchDist = null;
                isDragging = false;
                isPinching = false;
                swipeStartPos = null;
                lastGesture = 'none';

            } catch (err) {
                overlay.innerHTML = '<div>‚ùå Xato: ' + err.message + '<br><small>Kamerani tekshiring</small></div>';
                console.error('MediaPipe Hands xato:', err);
            }
        }

        function loadScript(src) {
            return new Promise(function (res, rej) {
                if (document.querySelector('script[src="' + src + '"]')) { res(); return; }
                var s = document.createElement('script');
                s.src = src;
                s.onload = res;
                s.onerror = rej;
                document.head.appendChild(s);
            });
        }

        function createCursor() {
            if (cursorEl) cursorEl.remove();
            cursorEl = document.createElement('div');
            cursorEl.id = 'touchCursor';
            cursorEl.style.cssText = 'position:fixed;width:50px;height:50px;border-radius:50%;background:rgba(139,92,246,0.2);border:3px solid #8b5cf6;pointer-events:none;z-index:9999;display:none;transform:translate(-50%,-50%);transition:width .15s,height .15s,background .15s,border-color .15s;box-shadow:0 0 25px rgba(139,92,246,0.4);backdrop-filter:blur(2px);';

            // Markaziy nuqta
            var inner = document.createElement('div');
            inner.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:10px;height:10px;background:#8b5cf6;border-radius:50%;transition:all .15s;';
            inner.id = 'cursorInner';
            cursorEl.appendChild(inner);

            // Jest nomi ko'rsatgich
            var label = document.createElement('div');
            label.id = 'cursorLabel';
            label.style.cssText = 'position:absolute;bottom:-22px;left:50%;transform:translateX(-50%);font-size:.55rem;font-weight:700;color:#8b5cf6;white-space:nowrap;text-shadow:0 1px 3px rgba(0,0,0,.3);background:rgba(255,255,255,.9);padding:1px 6px;border-radius:8px;opacity:0;transition:opacity .2s;';
            cursorEl.appendChild(label);

            document.body.appendChild(cursorEl);
        }

        // Barmoq izi nuqtalari yaratish
        function createTrails() {
            // Eski izlarni tozalash
            document.querySelectorAll('.touch-trail').forEach(function (t) { t.remove() });
            touchTrails = [];
            for (var i = 0; i < maxTrails; i++) {
                var trail = document.createElement('div');
                trail.className = 'touch-trail';
                trail.style.opacity = 0;
                document.body.appendChild(trail);
                touchTrails.push(trail);
            }
        }

        // Barmoq izini yangilash
        function updateTrails(x, y, active) {
            if (!active) {
                touchTrails.forEach(function (t) { t.style.opacity = 0; });
                return;
            }
            // Har bir iz nuqtasini oldingi pozitsiyaga surish
            for (var i = touchTrails.length - 1; i > 0; i--) {
                touchTrails[i].style.left = touchTrails[i - 1].style.left;
                touchTrails[i].style.top = touchTrails[i - 1].style.top;
                touchTrails[i].style.opacity = ((maxTrails - i) / maxTrails) * 0.4;
                touchTrails[i].style.width = Math.max(3, 8 - i * 0.5) + 'px';
                touchTrails[i].style.height = touchTrails[i].style.width;
            }
            touchTrails[0].style.left = x + 'px';
            touchTrails[0].style.top = y + 'px';
            touchTrails[0].style.opacity = 0.5;
        }

        // Touch Ripple effekti yaratish (sensorli ekrandagi kabi)
        function createRipple(x, y, color) {
            var ripple = document.createElement('div');
            ripple.className = 'touch-ripple';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.style.transform = 'translate(-50%,-50%)';
            if (color) ripple.style.borderColor = color;
            document.body.appendChild(ripple);
            setTimeout(function () { ripple.remove(); }, 600);
        }

        // Hover effektini boshqarish
        function updateHoverEffect(x, y) {
            // Barcha interaktiv elementlarni topish
            var elementsAtPoint = document.elementsFromPoint(x, y);
            var foundHoverable = null;

            for (var i = 0; i < elementsAtPoint.length; i++) {
                var el = elementsAtPoint[i];
                // Interaktiv elementlarni tekshirish
                if (el.classList.contains('loc-card') ||
                    el.classList.contains('chip') ||
                    el.classList.contains('map-btn') ||
                    el.classList.contains('ctrl-btn') ||
                    el.classList.contains('info-btn') ||
                    el.classList.contains('panel-tab') ||
                    el.classList.contains('vsug-btn') ||
                    el.classList.contains('gesture-btn') ||
                    el.tagName === 'BUTTON' ||
                    el.classList.contains('marker-wrap')) {
                    foundHoverable = el;
                    break;
                }
                // Parent elementni ham tekshirish (nested elementlar uchun)
                if (el.closest && el.closest('.loc-card')) {
                    foundHoverable = el.closest('.loc-card');
                    break;
                }
                if (el.closest && el.closest('.marker-wrap')) {
                    foundHoverable = el.closest('.marker-wrap');
                    break;
                }
            }

            // Oldingi hover elementdan olib tashlash
            if (lastHoveredEl && lastHoveredEl !== foundHoverable) {
                lastHoveredEl.classList.remove('gesture-hover-glow');
            }

            // Yangi elementga hover qo'shish
            if (foundHoverable) {
                foundHoverable.classList.add('gesture-hover-glow');
                hoveredElement = foundHoverable;
                // Kursorni yaqin element borligini ko'rsatish
                if (cursorEl) {
                    cursorEl.style.borderColor = '#22c55e';
                    document.getElementById('cursorInner').style.background = '#22c55e';
                }
            } else {
                hoveredElement = null;
                if (cursorEl && lastGesture !== 'drag') {
                    cursorEl.style.borderColor = '#8b5cf6';
                    document.getElementById('cursorInner').style.background = '#8b5cf6';
                }
            }

            lastHoveredEl = foundHoverable;
        }

        // Sidebar yoki ro'yxatni scroll qilish
        function gestureScroll(element, delta) {
            if (element) {
                element.scrollTop += delta;
            }
        }

        function stopGestureCamera() {
            gestureActive = false;
            if (gestureStream) {
                gestureStream.getTracks().forEach(function (t) { t.stop(); });
                gestureStream = null;
            }
            if (gestureCtx) gestureCtx.clearRect(0, 0, 640, 480);
            if (cursorEl) cursorEl.style.display = 'none';

            // Izlarni tozalash
            touchTrails.forEach(function (t) { t.style.opacity = 0; });

            // Hover effektni tozalash
            if (lastHoveredEl) lastHoveredEl.classList.remove('gesture-hover-glow');
            lastHoveredEl = null;
            hoveredElement = null;

            // Ikki qo'l rejimini tozalash
            exitTwoHandMode();

            // One Euro Filtrlarni qayta boshlash
            euroFilterX.reset();
            euroFilterY.reset();

            // Jest holatlarini tozalash
            pinchStartTime = 0;
            longPressTriggered = false;

            document.getElementById('gestureOverlay').classList.remove('hidden');
            document.getElementById('gestureOverlay').innerHTML = '<div>üì∑ "Boshlash" tugmasini bosing</div>';
            document.getElementById('gestureStatus').textContent = "O'chiq";
            document.getElementById('gestureStatus').classList.remove('active');
            document.getElementById('gestureStartBtn').innerHTML = '‚ñ∂Ô∏è Boshlash';
            document.getElementById('touchBadge').classList.remove('active');
            updateGestureUI('none', 'üëÜ', 'Kutilmoqda', "Qo'lingizni ko'rsating");
        }

        // detectLoop endi kerak emas ‚Äî Camera + onResults pattern ishlatiladi
        // Camera har kadrni avtomatik mpHands.send() ga beradi
        // va natijalar mpHands.onResults() callback orqali qaytadi.
        // Bu funksiya faqat eski kodda chaqirilishi uchun saqlanmoqda.
        async function detectLoop() {
            // Camera + onResults ishlatiladi, bu funksiya bo'sh
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // QO'L SKELETI CHIZISH (21 ta barmoq nuqtasi)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MediaPipe landmarks normallashtirilgan [0,1] formatda keladi
        // Biz ularni canvas piksellarga aylantiramiz va chizamiz

        // Barmoq ulanishlari (MediaPipe Hands standarti)
        var HAND_CONNECTIONS = [
            [0, 1], [1, 2], [2, 3], [3, 4],         // Bosh barmoq
            [0, 5], [5, 6], [6, 7], [7, 8],         // Ko'rsatkich
            [0, 9], [9, 10], [10, 11], [11, 12],    // O'rta
            [0, 13], [13, 14], [14, 15], [15, 16],  // Nomsiz
            [0, 17], [17, 18], [18, 19], [19, 20],  // Jimjiloq
            [5, 9], [9, 13], [13, 17]              // Kaft ichki ulanishlar
        ];

        function drawHandLandmarks(kp, color) {
            // MediaPipe Tasks landmarks: normalized [0,1] koordinatlar
            // x * canvasWidth, y * canvasHeight = piksel pozitsiyasi
            var cw = gestureCanvas.width;
            var ch = gestureCanvas.height;

            // Chiziqlar
            gestureCtx.lineWidth = 2;
            gestureCtx.strokeStyle = color;
            gestureCtx.globalAlpha = 0.6;
            HAND_CONNECTIONS.forEach(function (conn) {
                var p1 = kp[conn[0]];
                var p2 = kp[conn[1]];
                gestureCtx.beginPath();
                gestureCtx.moveTo(p1.x * cw, p1.y * ch);
                gestureCtx.lineTo(p2.x * cw, p2.y * ch);
                gestureCtx.stroke();
            });
            gestureCtx.globalAlpha = 1.0;

            // Nuqtalar
            kp.forEach(function (p, idx) {
                var isTip = (idx === 4 || idx === 8 || idx === 12 || idx === 16 || idx === 20);
                var radius = isTip ? 6 : 3;
                gestureCtx.fillStyle = isTip ? color : 'rgba(148,163,184,0.7)';
                gestureCtx.beginPath();
                gestureCtx.arc(p.x * cw, p.y * ch, radius, 0, Math.PI * 2);
                gestureCtx.fill();

                // Barmoq uchlariga glow
                if (isTip) {
                    gestureCtx.fillStyle = 'rgba(139,92,246,0.15)';
                    gestureCtx.beginPath();
                    gestureCtx.arc(p.x * cw, p.y * ch, 14, 0, Math.PI * 2);
                    gestureCtx.fill();
                }
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BIR QO'L JEST ANIQLASH (MediaPipe Gesture Recognizer)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //
        // MediaPipe ikkita narsa beradi:
        //   1. Jest NOMI (Closed_Fist, Open_Palm, Thumb_Up va h.k.)
        //   2. 21 ta barmoq KOORDINATASI (normalized 0-1)
        //
        // Biz IKKISINI ham ishlatamiz:
        //   - Barmoq uchlari ‚Üí kursor pozitsiyasi (index tip = 8)
        //   - Thumb tip (4) + Index tip (8) masofa ‚Üí chimchilash (pinch/tap)
        //   - Jest nomi ‚Üí harakat turi (drag, click, zoom)
        //
        // JEST ‚Üí HARAKAT XARITASI:
        //   Open_Palm / Pointing_Up / None ‚Üí kursor harakati (hover)
        //   Closed_Fist ‚Üí surish (drag) ‚Äî musht = ushlab surish
        //   Thumb_Up ‚Üí bosish (click/tap)
        //   Victory ‚Üí zoom rejimi signal
        //   Pinch (thumb+index < 35px) ‚Üí bosish (tap) ‚Äî jest nomidan mustaqil
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function handleOneHandMP(kp, gestureName) {
            var now = Date.now();

            // Asosiy nuqtalarni olish (TF.js: allaqachon pikselda 0-640/0-480)
            var indexTip = kp[LM.INDEX_TIP];
            var thumbTip = kp[LM.THUMB_TIP];

            // Kursor pozitsiyasi: ko'rsatkich barmoq uchi
            // MediaPipe landmarks normalized [0,1] ‚Äî to'g'ridan-to'g'ri ekranga
            // Mirror effekt: kamera teskari ko'rsatadi, shuning uchun x ni teskari qilamiz
            var rawX = window.innerWidth - (indexTip.x * window.innerWidth);
            var rawY = indexTip.y * window.innerHeight;

            // One Euro Filter bilan silliqlashtirish
            smoothPos.x = euroFilterX.filter(rawX, now);
            smoothPos.y = euroFilterY.filter(rawY, now);
            fingerSpeed = Math.sqrt(
                Math.pow(rawX - rawPos.x, 2) + Math.pow(rawY - rawPos.y, 2)
            );
            rawPos.x = rawX;
            rawPos.y = rawY;

            // Pozitsiya tarixi
            prevFingerPositions.push({ x: smoothPos.x, y: smoothPos.y, t: now });
            if (prevFingerPositions.length > 14) prevFingerPositions.shift();

            // Kursor ko'rsatish
            cursorEl.style.display = 'block';
            cursorEl.style.left = smoothPos.x + 'px';
            cursorEl.style.top = smoothPos.y + 'px';
            updateTrails(smoothPos.x, smoothPos.y, true);
            updateHoverEffect(smoothPos.x, smoothPos.y);

            // Chimchilash (pinch) aniqlash: thumb tip + index tip masofa
            // Normalized koordinatlarni canvas piksellariga aylantiramiz
            var cw = gestureCanvas.width;
            var ch = gestureCanvas.height;
            var pinchDist = Math.sqrt(
                Math.pow((thumbTip.x - indexTip.x) * cw, 2) +
                Math.pow((thumbTip.y - indexTip.y) * ch, 2)
            );
            var isPinched = pinchDist < 35;

            var cursorLabel = document.getElementById('cursorLabel');
            var longPressRing = document.getElementById('longPressRing');

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 1. CLOSED_FIST ‚Üí SURISH (DRAG)
            //    Musht yumish = xaritani ushlab surish
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (gestureName === 'Closed_Fist') {
                if (!isDragging) {
                    isDragging = true;
                    lastHandPos = { x: smoothPos.x, y: smoothPos.y };
                    touchStartPos = { x: smoothPos.x, y: smoothPos.y };
                }

                if (lastHandPos) {
                    var mvx = (lastHandPos.x - smoothPos.x) * 1.6;
                    var mvy = (lastHandPos.y - smoothPos.y) * 1.6;
                    var mapEl = document.getElementById('map');
                    var mr = mapEl.getBoundingClientRect();
                    if (smoothPos.x >= mr.left && smoothPos.x <= mr.right &&
                        smoothPos.y >= mr.top && smoothPos.y <= mr.bottom) {
                        map.panBy([mvx, mvy], { animate: false });
                    } else {
                        var ll = document.getElementById('locList');
                        if (ll) ll.scrollTop += mvy * 2;
                    }
                    var dt = now - lastMoveTime;
                    if (dt > 0) { velocityX = mvx / dt * 16; velocityY = mvy / dt * 16; }
                }

                lastHandPos = { x: smoothPos.x, y: smoothPos.y };
                lastMoveTime = now;

                cursorEl.style.background = 'rgba(234,179,8,0.25)';
                cursorEl.style.borderColor = '#eab308';
                cursorEl.style.width = '45px';
                cursorEl.style.height = '45px';
                if (cursorLabel) { cursorLabel.textContent = '‚úä Surish'; cursorLabel.style.opacity = '1'; }
                updateGestureUI('hint-swipe', '‚úä', 'Surish', fingerSpeed > 50 ? 'Tez!' : 'Suring');
                lastGesture = 'drag';
                return;
            }

            // Drag tugadi ‚Äî inertiya
            if (isDragging) {
                isDragging = false;
                if (Math.abs(velocityX) > 0.3 || Math.abs(velocityY) > 0.3) {
                    applyInertia();
                }
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 2. THUMB_UP ‚Üí BOSISH (CLICK)
            //    Bosh barmoq yuqoriga = tanlash/bosish
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (gestureName === 'Thumb_Up') {
                if (lastGesture !== 'thumbup') {
                    createRipple(smoothPos.x, smoothPos.y, '#22c55e');
                    doClick(smoothPos.x, smoothPos.y);
                    if (cursorLabel) { cursorLabel.textContent = 'üëç Bosildi!'; cursorLabel.style.opacity = '1'; }
                    updateGestureUI('hint-tap', 'üëç', 'Bosildi!', 'Tanlandi');
                }
                cursorEl.style.background = 'rgba(34,197,94,0.3)';
                cursorEl.style.borderColor = '#22c55e';
                lastGesture = 'thumbup';
                return;
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 3. CHIMCHILASH (PINCH) ‚Üí BOSISH (TAP)
            //    Bosh barmoq + ko'rsatkich barmoq yaqinlashsa = bosish
            //    Bu jest nomidan mustaqil ‚Äî barmoq masofasi asosida
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (isPinched) {
                if (!isPinching) {
                    isPinching = true;
                    touchStartPos = { x: smoothPos.x, y: smoothPos.y };
                    touchMoveAccum = 0;
                    pinchStartTime = now;
                    if (longPressRing) {
                        longPressRing.style.left = smoothPos.x + 'px';
                        longPressRing.style.top = smoothPos.y + 'px';
                        longPressRing.className = 'long-press-ring filling';
                    }
                }

                var pinchTime = now - pinchStartTime;
                var pdx = touchStartPos ? smoothPos.x - touchStartPos.x : 0;
                var pdy = touchStartPos ? smoothPos.y - touchStartPos.y : 0;
                var pinchMoveDist = Math.sqrt(pdx * pdx + pdy * pdy);

                // Long press: chimchilash 800ms+ harakatsiz ushlab turish
                if (pinchTime > longPressDuration && !longPressTriggered && pinchMoveDist < 40) {
                    longPressTriggered = true;
                    if (longPressRing) longPressRing.className = 'long-press-ring done';
                    createRipple(smoothPos.x, smoothPos.y, '#f97316');
                    createRipple(smoothPos.x, smoothPos.y, '#22c55e');
                    doLongPress(smoothPos.x, smoothPos.y);
                    cursorEl.style.background = 'rgba(249,115,22,0.5)';
                    cursorEl.style.borderColor = '#f97316';
                    if (cursorLabel) { cursorLabel.textContent = 'üëá Bosib turildi!'; cursorLabel.style.opacity = '1'; }
                    updateGestureUI('hint-longpress', 'üëá', 'Bosib turildi!', 'Batafsil ochildi');
                    lastGesture = 'longpress';
                    return;
                }

                // Kutish: hali tap yoki long press aniqlanmagan
                if (pinchTime > 200 && pinchMoveDist < 40) {
                    var remaining = Math.max(0, Math.ceil((longPressDuration - pinchTime) / 100));
                    if (cursorLabel) { cursorLabel.textContent = 'ü§è ' + remaining; cursorLabel.style.opacity = '1'; }
                    updateGestureUI('hint-longpress', 'ü§è', remaining + '...', 'Ushlab turing');
                }

                cursorEl.style.width = '22px';
                cursorEl.style.height = '22px';
                cursorEl.style.background = 'rgba(37,99,235,0.5)';
                cursorEl.style.borderColor = '#2563eb';
                lastGesture = 'pinch';
                return;
            }

            // Chimchilash tugadi ‚Üí Tap!
            if (isPinching && !isPinched) {
                var releaseTime = now - pinchStartTime;
                var releaseDist = 0;
                if (touchStartPos) {
                    var rdx = smoothPos.x - touchStartPos.x;
                    var rdy = smoothPos.y - touchStartPos.y;
                    releaseDist = Math.sqrt(rdx * rdx + rdy * rdy);
                }

                if (releaseTime < 700 && releaseDist < 45 && !longPressTriggered) {
                    createRipple(smoothPos.x, smoothPos.y, '#8b5cf6');
                    doClick(smoothPos.x, smoothPos.y);
                    if (cursorLabel) { cursorLabel.textContent = 'ü§è Bosildi!'; cursorLabel.style.opacity = '1'; }
                    updateGestureUI('hint-tap', 'ü§è', 'Bosildi!', 'Tanlandi');
                    lastGesture = 'tap';
                }

                isPinching = false;
                longPressTriggered = false;
                pinchStartTime = 0;
                if (longPressRing) longPressRing.className = 'long-press-ring';
            }

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // 4. OPEN_PALM / POINTING_UP / NONE ‚Üí KURSOR (HOVER)
            //    Ochiq kaft yoki ko'rsatish = kursor harakati
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            cursorEl.style.background = hoveredElement ? 'rgba(34,197,94,0.12)' : 'rgba(139,92,246,0.08)';
            cursorEl.style.borderColor = hoveredElement ? '#22c55e' : '#8b5cf6';
            cursorEl.style.width = '38px';
            cursorEl.style.height = '38px';

            var gestureEmoji = '‚òùÔ∏è';
            var gestureLabel = 'Ko\'rsatish';
            if (gestureName === 'Open_Palm') { gestureEmoji = 'üñêÔ∏è'; gestureLabel = 'Ochiq kaft'; }
            else if (gestureName === 'Victory') { gestureEmoji = '‚úåÔ∏è'; gestureLabel = 'Zoom tayyor'; }
            else if (gestureName === 'ILoveYou') { gestureEmoji = 'ü§ü'; gestureLabel = 'Maxsus'; }
            else if (gestureName === 'Pointing_Up') { gestureEmoji = '‚òùÔ∏è'; gestureLabel = 'Ko\'rsatish'; }

            if (cursorLabel) {
                cursorLabel.textContent = gestureEmoji + ' ' + gestureLabel;
                cursorLabel.style.opacity = '1';
            }

            lastHandPos = { x: smoothPos.x, y: smoothPos.y };
            lastGesture = 'pointer';
            updateGestureUI('hint-tap', gestureEmoji, gestureLabel,
                hoveredElement ? 'Chimchilang = bosish' : 'Xaritani ko\'ring');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // IKKI QO'L ZOOM (MediaPipe ‚Äî index fingertip asosida)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // Ikkala qo'lning ko'rsatkich barmoq uchlari (landmark #8) 
        // orasidagi masofani kuzatamiz:
        //   Masofa ortsa ‚Üí zoom in (kattalashtirish)
        //   Masofa kamaysa ‚Üí zoom out (kichiklashtirish)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function handleTwoHandsMP(landmarks1, landmarks2, gesture1) {
            var now = Date.now();
            var cw = gestureCanvas.width;
            var ch = gestureCanvas.height;

            // Ikkala qo'lning ko'rsatkich barmoq uchlarini olish
            var tip1 = landmarks1[LM.INDEX_TIP];
            var tip2 = landmarks2[LM.INDEX_TIP];

            // Kamera koordinatalarida masofa (pikselda)
            var dist = Math.sqrt(
                Math.pow((tip1.x - tip2.x) * cw, 2) +
                Math.pow((tip1.y - tip2.y) * ch, 2)
            );

            // One Euro Filter bilan silliqlashtirish
            var smoothDist = twoHandFilterDist.filter(dist, now);

            // Ekran koordinatalari (normalized ‚Üí ekran piksel)
            var scr1x = window.innerWidth - (tip1.x * window.innerWidth);
            var scr1y = tip1.y * window.innerHeight;
            var scr2x = window.innerWidth - (tip2.x * window.innerWidth);
            var scr2y = tip2.y * window.innerHeight;

            // Birinchi qo'l kursorini yangilash
            smoothPos.x = euroFilterX.filter(scr1x, now);
            smoothPos.y = euroFilterY.filter(scr1y, now);
            cursorEl.style.display = 'block';
            cursorEl.style.left = smoothPos.x + 'px';
            cursorEl.style.top = smoothPos.y + 'px';

            var screenCX = (smoothPos.x + scr2x) / 2;
            var screenCY = (smoothPos.y + scr2y) / 2;

            if (!twoHandActive) {
                enterTwoHandMode(smoothDist, screenCX, screenCY);
                return;
            }

            // Zoom hisoblash
            if (twoHandLastDist !== null) {
                var delta = smoothDist - twoHandLastDist;
                if (Math.abs(delta) > 0.8) {
                    twoHandZoomAccum += delta * 0.012;
                    if (twoHandZoomAccum > 1.0) {
                        map.zoomIn(0.15);
                        twoHandZoomAccum = 0;
                    } else if (twoHandZoomAccum < -1.0) {
                        map.zoomOut(0.15);
                        twoHandZoomAccum = 0;
                    }
                }
            }

            // Pan (markaz siljishi)
            var sCX = twoHandFilterCX.filter(screenCX, now);
            var sCY = twoHandFilterCY.filter(screenCY, now);
            if (twoHandLastCenter) {
                var panDx = twoHandLastCenter.x - sCX;
                var panDy = twoHandLastCenter.y - sCY;
                if (Math.abs(panDx) > 1.5 || Math.abs(panDy) > 1.5) {
                    map.panBy([panDx * 1.2, panDy * 1.2], { animate: false });
                }
            }

            twoHandLastDist = smoothDist;
            twoHandLastCenter = { x: sCX, y: sCY };

            // Vizual elementlarni yangilash
            if (twoHandCursorEl2) {
                twoHandCursorEl2.style.display = 'block';
                twoHandCursorEl2.style.left = scr2x + 'px';
                twoHandCursorEl2.style.top = scr2y + 'px';
            }
            var line = document.getElementById('twoHandLine');
            if (line) {
                line.style.display = 'block';
                var ldx = scr2x - smoothPos.x;
                var ldy = scr2y - smoothPos.y;
                var len = Math.sqrt(ldx * ldx + ldy * ldy);
                var angle = Math.atan2(ldy, ldx) * (180 / Math.PI);
                line.style.left = smoothPos.x + 'px';
                line.style.top = smoothPos.y + 'px';
                line.style.width = len + 'px';
                line.style.transform = 'rotate(' + angle + 'deg)';
            }
            var zLabel = document.getElementById('twoHandZoomLabel');
            if (zLabel) {
                zLabel.style.display = 'block';
                zLabel.style.left = sCX + 'px';
                zLabel.style.top = sCY + 'px';
                var zoomLevel = Math.round(map.getZoom() * 10) / 10;
                var zoomIcon = (smoothDist > twoHandBaseDist + 10) ? 'üîç+' : (smoothDist < twoHandBaseDist - 10) ? 'üîç‚àí' : 'ü§≤';
                zLabel.textContent = zoomIcon + ' Zoom: ' + zoomLevel + 'x';
            }

            cursorEl.style.background = 'rgba(59,130,246,0.15)';
            cursorEl.style.borderColor = '#3b82f6';
            cursorEl.style.width = '40px';
            cursorEl.style.height = '40px';
            var cursorLabel = document.getElementById('cursorLabel');
            if (cursorLabel) { cursorLabel.textContent = 'ü§≤ Zoom'; cursorLabel.style.opacity = '1'; }
            updateGestureUI('hint-twohands', 'ü§≤', 'Zoom', (smoothDist > twoHandBaseDist + 15) ? 'üîç+ Kattalashtirish' : (smoothDist < twoHandBaseDist - 15) ? 'üîç- Kichiklashtirish' : 'ü§≤ Tayyor');
            lastGesture = 'zoom';
        }

        // Chimchilash uchun qo'shimcha o'zgaruvchilar
        var pinchStartTime = 0;
        var longPressTriggered = false;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // IKKI QO'L ZOOM REJIMI ‚Äî KIRISH / CHIQISH
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //
        // YOLOv8-Pose versiyada ikki qo'l zoom:
        //   MediaPipe: ikki barmoq uchi orasidagi masofa
        //   YOLOv8:    ikki BILAK orasidagi masofa
        //
        // Ishlash prinsipi bir xil ‚Äî faqat keypoint manbasi boshqa.
        // Ikkala qo'l ko'tarilganda va bilaklar uzoqlashganda zoom rejimi
        // faollashadi. enterTwoHandMode() boshlang'ich masofani saqlaydi,
        // exitTwoHandMode() barcha holatlarni tozalaydi.
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function enterTwoHandMode(dist, cx, cy) {
            twoHandActive = true;
            twoHandBaseDist = dist;
            twoHandLastDist = dist;
            twoHandZoomAccum = 0;
            twoHandCenter = { x: cx, y: cy };
            twoHandLastCenter = { x: cx, y: cy };

            // Ikkinchi kursor yaratish (chap qo'l uchun)
            if (!twoHandCursorEl2) {
                twoHandCursorEl2 = document.createElement('div');
                twoHandCursorEl2.style.cssText = 'position:fixed;width:40px;height:40px;border-radius:50%;background:rgba(59,130,246,0.15);border:3px solid #3b82f6;pointer-events:none;z-index:9998;display:none;transform:translate(-50%,-50%);transition:width .15s,height .15s,background .15s;box-shadow:0 0 20px rgba(59,130,246,0.4);';
                document.body.appendChild(twoHandCursorEl2);
            }
            twoHandCursorEl2.style.display = 'block';

            // Zoom chiziq (ikki bilak orasida gradient chiziq)
            if (!document.getElementById('twoHandLine')) {
                var line = document.createElement('div');
                line.id = 'twoHandLine';
                line.style.cssText = 'position:fixed;height:3px;background:linear-gradient(90deg,#3b82f6,#8b5cf6,#3b82f6);pointer-events:none;z-index:9997;display:none;transform-origin:0 50%;border-radius:2px;box-shadow:0 0 10px rgba(99,102,241,0.5);';
                document.body.appendChild(line);
            }

            // Zoom darajasi ko'rsatgichi (markazda)
            if (!document.getElementById('twoHandZoomLabel')) {
                var label = document.createElement('div');
                label.id = 'twoHandZoomLabel';
                label.style.cssText = 'position:fixed;pointer-events:none;z-index:9999;display:none;background:rgba(15,23,42,0.85);color:#e2e8f0;font-size:13px;font-weight:700;padding:6px 14px;border-radius:20px;transform:translate(-50%,-50%);border:1px solid rgba(99,102,241,0.4);backdrop-filter:blur(8px);box-shadow:0 4px 15px rgba(0,0,0,0.3);font-family:Inter,sans-serif;';
                document.body.appendChild(label);
            }

            // Asosiy kursorni ham ko'k rangga o'zgartirish (zoom rejimi belgisi)
            if (cursorEl) {
                cursorEl.style.borderColor = '#3b82f6';
                cursorEl.style.background = 'rgba(59,130,246,0.15)';
                cursorEl.style.width = '40px';
                cursorEl.style.height = '40px';
                var inner = document.getElementById('cursorInner');
                if (inner) inner.style.background = '#3b82f6';
            }
        }

        function exitTwoHandMode() {
            twoHandActive = false;
            twoHandBaseDist = null;
            twoHandLastDist = null;
            twoHandLastCenter = null;
            twoHandZoomAccum = 0;

            // One Euro Filtrlarni qayta boshlash (yangi zoom sessiyasi uchun)
            twoHandFilterDist.reset();
            twoHandFilterCX.reset();
            twoHandFilterCY.reset();

            // Vizual elementlarni yashirish
            if (twoHandCursorEl2) twoHandCursorEl2.style.display = 'none';
            var line = document.getElementById('twoHandLine');
            if (line) line.style.display = 'none';
            var label = document.getElementById('twoHandZoomLabel');
            if (label) label.style.display = 'none';

            // Kursor rangini binafsha rangga qaytarish
            if (cursorEl) {
                cursorEl.style.borderColor = '#8b5cf6';
                var inner = document.getElementById('cursorInner');
                if (inner) inner.style.background = '#8b5cf6';
            }
        }

        // Barcha jest holatlarini tozalash
        function resetGestureStates() {
            isDragging = false;
            isScrolling = false;
            isPinching = false;
            isLongPressing = false;
            longPressTriggered = false;
            gestureDecided = false;
            activeGesture = 'none';
            lastPinchDist = null;
            lastHandPos = null;
            lastRotateAngle = null;
            swipeStartPos = null;
            touchStartPos = null;
            touchMoveAccum = 0;
        }

        // Swipe yo'nalishini pozitsiya tarixidan aniqlash
        function detectSwipeFromHistory() {
            if (prevFingerPositions.length < 5) return null;
            var first = prevFingerPositions[0];
            var last = prevFingerPositions[prevFingerPositions.length - 1];
            var dt = last.t - first.t;
            if (dt > 600 || dt < 50) return null;

            var dx = last.x - first.x;
            var dy = last.y - first.y;
            var dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 100) return null;

            var angle = Math.atan2(dy, dx) * (180 / Math.PI);
            if (angle > -45 && angle < 45) return 'right';
            if (angle > 135 || angle < -135) return 'left';
            if (angle > 45 && angle < 135) return 'down';
            if (angle > -135 && angle < -45) return 'up';
            return null;
        }

        function showSwipeIndicator(dir) {
            var el = document.getElementById('swipe' + dir.charAt(0).toUpperCase() + dir.slice(1));
            if (el) {
                el.classList.add('show');
                setTimeout(function () { el.classList.remove('show'); }, 500);
            }
        }

        // BOSIB TURISH (Long Press) harakati
        function doLongPress(x, y) {
            var mapEl = document.getElementById('map');
            var rect = mapEl.getBoundingClientRect();

            // Xarita ustida ‚Äî eng yaqin bankni tanlash va batafsil ma'lumotni ochish
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                var point = map.containerPointToLatLng([x - rect.left, y - rect.top]);
                var nearest = null, minD = Infinity;
                data.forEach(function (l) {
                    var d = Math.sqrt(Math.pow(l.lat - point.lat, 2) + Math.pow(l.lng - point.lng, 2));
                    if (d < minD) { minD = d; nearest = l; }
                });
                if (nearest) {
                    selectLoc(nearest.id);
                    // Agar bank bo'lsa ‚Äî umumiy modalni ham ochish
                    if (nearest.cat === 'bank') {
                        setTimeout(function () { openModal(); }, 300);
                    }
                }
                return;
            }

            // Hovered loc-card ustida ‚Äî batafsil ma'lumot
            if (hoveredElement && hoveredElement.classList.contains('loc-card')) {
                hoveredElement.click();
                return;
            }

            // Boshqa joy ‚Äî umumiy statistika modalni ochish
            openModal();
        }

        function handleNoHand() {
            // Inertia (surish davom etadi)
            if (isDragging && (Math.abs(velocityX) > 0.5 || Math.abs(velocityY) > 0.5)) {
                applyInertia();
            }

            resetGestureStates();
            lastGesture = 'none';
            prevFingerPositions = [];

            // Jest holatlarini tozalash
            pinchStartTime = 0;
            longPressTriggered = false;

            // One Euro Filtrlarni qayta boshlash
            euroFilterX.reset();
            euroFilterY.reset();

            if (cursorEl) {
                cursorEl.style.display = 'none';
                cursorEl.style.borderRadius = '50%';
                var label = document.getElementById('cursorLabel');
                if (label) label.style.opacity = '0';
            }

            // Izlarni yashirish
            updateTrails(0, 0, false);

            // Hover tozalash
            if (lastHoveredEl) {
                lastHoveredEl.classList.remove('gesture-hover-glow');
                lastHoveredEl = null;
            }

            // Long press ring va rotate indikatorni yashirish
            var lpr = document.getElementById('longPressRing');
            if (lpr) lpr.className = 'long-press-ring';
            var ri = document.getElementById('rotateIndicator');
            if (ri) ri.classList.remove('active');

            updateGestureUI('none', 'üëÜ', 'Qo\'l topilmadi', 'Qo\'lingizni kameraga ko\'rsating');
        }

        function applyInertia() {
            if (Math.abs(velocityX) < 0.3 && Math.abs(velocityY) < 0.3) return;
            function step() {
                if (Math.abs(velocityX) < 0.3 && Math.abs(velocityY) < 0.3 || isDragging) return;
                map.panBy([velocityX, velocityY], { animate: false });
                velocityX *= 0.94;  // Optimallashtirilgan ‚Äî sekinroq to'xtash, tabiiyroq harakat
                velocityY *= 0.94;
                requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        // BOSISH (TAP) harakati
        function doClick(x, y) {
            var mapEl = document.getElementById('map');
            var rect = mapEl.getBoundingClientRect();

            // Xarita ustida ‚Äî eng yaqin marker
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                var point = map.containerPointToLatLng([x - rect.left, y - rect.top]);
                var nearest = null, minD = Infinity;
                data.forEach(function (l) {
                    var d = Math.sqrt(Math.pow(l.lat - point.lat, 2) + Math.pow(l.lng - point.lng, 2));
                    if (d < minD) { minD = d; nearest = l; }
                });
                if (nearest) selectLoc(nearest.id);
                return;
            }

            // Hovered elementga bosish
            if (hoveredElement) {
                hoveredElement.click();
                return;
            }

            // Umumiy click
            var el = document.elementFromPoint(x, y);
            if (el && (el.tagName === 'BUTTON' || el.onclick || el.closest('button'))) {
                (el.closest('button') || el).click();
            }
        }

        function updateGestureUI(hint, icon, name, action) {
            document.getElementById('currentGestureIcon').textContent = icon;
            document.getElementById('currentGestureName').textContent = name;
            document.getElementById('currentGestureAction').textContent = action;
            document.querySelectorAll('.gesture-hint').forEach(function (h) { h.classList.remove('active'); });
            if (hint && hint !== 'none') {
                var el = document.getElementById(hint);
                if (el) el.classList.add('active');
            }
        }


        // Xarita hajmini to'g'rilash
        setTimeout(function () { map.invalidateSize(); }, 300);
        window.addEventListener('resize', function () { map.invalidateSize(); });
    </script>
</body>

</html>